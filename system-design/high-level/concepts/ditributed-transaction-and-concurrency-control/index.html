
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://abhishekghoshh.github.io/system-design-helper/system-design/high-level/concepts/ditributed-transaction-and-concurrency-control/">
      
      
        <link rel="prev" href="../distributed-caches-and-caching-strategies/">
      
      
        <link rel="next" href="../event-sourcing/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Distributed Transaction & Concurrency Control - System Design Helper</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="Distributed Transaction & Concurrency Control - System Design Helper" />
<meta property="og:image" content="https://abhishekghoshh.github.io/system-design-helper/assets/images/social/system-design/high-level/concepts/ditributed-transaction-and-concurrency-control.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://abhishekghoshh.github.io/system-design-helper/system-design/high-level/concepts/ditributed-transaction-and-concurrency-control/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="Distributed Transaction & Concurrency Control - System Design Helper" />
<meta property="twitter:image" content="https://abhishekghoshh.github.io/system-design-helper/assets/images/social/system-design/high-level/concepts/ditributed-transaction-and-concurrency-control.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#distributed-concurrency-control" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="System Design Helper" class="md-header__button md-logo" aria-label="System Design Helper" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            System Design Helper
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Distributed Transaction & Concurrency Control
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../ai-tools/" class="md-tabs__link">
        
  
  
    
  
  AI Tools

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../behavioural/" class="md-tabs__link">
        
  
  
    
  
  Behavioural

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../developer-experiences/" class="md-tabs__link">
        
  
  
    
  
  Developer Experiences

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../open-source-tools/" class="md-tabs__link">
        
  
  
    
  
  Open Source Tools

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../software-architect/" class="md-tabs__link">
        
  
  
    
  
  Software Architect

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../wisdom/" class="md-tabs__link">
        
  
  
    
  
  Wisdom

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../ai/ai/" class="md-tabs__link">
          
  
  
  AI

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../devops/" class="md-tabs__link">
          
  
  
  DevOps

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../security/introduction/" class="md-tabs__link">
          
  
  
  Security

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../courses/" class="md-tabs__link">
          
  
  
  System Design

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="System Design Helper" class="md-nav__button md-logo" aria-label="System Design Helper" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    System Design Helper
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Tools
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../behavioural/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Behavioural
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../developer-experiences/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Developer Experiences
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../open-source-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Open Source Tools
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../software-architect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Software Architect
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../wisdom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wisdom
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    AI
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    AI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/ai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/ai-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/gen-ai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gen AI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LangChain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/langgraph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LangGraph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/MCP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ai/RAG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    DevOps
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    DevOps
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Security
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Security
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/authentication-and-authorization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authentication & Authorization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/oauth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OAuth
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/rbac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RBAC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/sso/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SSO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/ssl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SSL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/devsecops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DevSecOps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/firewall/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firewall
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9" >
        
          
          <label class="md-nav__link" for="__nav_10_9" id="__nav_10_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Certificate
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Certificate
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/certificate/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/certificate/certificate-authority/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Certificate Authority
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/certificate/client-certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Client Certificates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/certificate/server-certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Server Certificates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/certificate/self-signed-certificates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Self-Signed Certificates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/certificate/links/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Links
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_10" >
        
          
          <label class="md-nav__link" for="__nav_10_10" id="__nav_10_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reverse Proxy
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reverse Proxy
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/reverse-proxy/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/reverse-proxy/haproxy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HAProxy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../security/reverse-proxy/nginx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nginx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    System Design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    System Design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../courses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Courses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2" checked>
        
          
          <label class="md-nav__link" for="__nav_11_2" id="__nav_11_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    High Level Design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    High Level Design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_11_2_2" id="__nav_11_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_11_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-bitrate-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Adaptive Bitrate Streaming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../asynchronus-communication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Asynchronous Communication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../back-of-envelope-calculation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Back of Envelope Calculation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bloom-filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bloom Filters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cap-theorm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CAP Theorem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cdc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CDC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cdn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CDN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../clean-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clean Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../code-documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../consistent-hashing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Consistent Hashing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CQRS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database-indexing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Database Indexing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../distributed-caches-and-caching-strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Caches & Caching Strategies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Distributed Transaction & Concurrency Control
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Transaction & Concurrency Control
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#youtube" class="md-nav__link">
    <span class="md-ellipsis">
      
        Youtube
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#theory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Theory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Theory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-what-is-a-transaction-and-what-is-isolation-in-a-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. What is a Transaction and What is Isolation in a Transaction?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. What is a Transaction and What is Isolation in a Transaction?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-a-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is a Transaction?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-isolation" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is Isolation?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-what-are-the-isolation-problems" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. What are the Isolation Problems?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. What are the Isolation Problems?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-dirty-read-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Dirty Read Problem
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-non-repeatable-read-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Non-Repeatable Read Problem
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-phantom-read-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 Phantom Read Problem
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-what-are-the-isolation-levels" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. What are the Isolation Levels?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. What are the Isolation Levels?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-read-uncommitted" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Read Uncommitted
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-understanding-locks-shared-vs-exclusive" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 Understanding Locks: Shared vs Exclusive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-isolation-problems-vs-isolation-levels-summary-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5 Isolation Problems vs Isolation Levels - Summary Table
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-read-committed" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Read Committed
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-repeatable-read" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Repeatable Read
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-serializable" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 Serializable
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-choosing-the-right-isolation-level" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary: Choosing the Right Isolation Level
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-optimistic-vs-pessimistic-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Optimistic vs Pessimistic Concurrency Control
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Optimistic vs Pessimistic Concurrency Control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-pessimistic-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Pessimistic Concurrency Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-optimistic-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Optimistic Concurrency Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#421-why-optimistic-concurrency-control-is-not-useful-all-the-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2.1 Why Optimistic Concurrency Control is NOT Useful All the Time
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-comparison-pessimistic-vs-optimistic" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Comparison: Pessimistic vs Optimistic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-detailed-advantages-and-disadvantages-of-both-concurrency-controls" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 Detailed Advantages and Disadvantages of Both Concurrency Controls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.4 Detailed Advantages and Disadvantages of Both Concurrency Controls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441-pessimistic-concurrency-control-detailed-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.1 Pessimistic Concurrency Control - Detailed Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442-optimistic-concurrency-control-detailed-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.2 Optimistic Concurrency Control - Detailed Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#443-side-by-side-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.3 Side-by-Side Summary
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-two-phase-locking-2pl-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 Two-Phase Locking (2PL) Protocol
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.5 Two-Phase Locking (2PL) Protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#451-what-is-two-phase-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.1 What is Two-Phase Locking?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#452-where-is-2pl-used" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.2 Where is 2PL Used?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#453-how-2pl-is-useful-to-pessimistic-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.3 How 2PL is Useful to Pessimistic Concurrency Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#454-different-phases-of-two-phase-locking-detailed" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.4 Different Phases of Two-Phase Locking (Detailed)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#455-different-types-of-two-phase-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5.5 Different Types of Two-Phase Locking
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.5.5 Different Types of Two-Phase Locking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type-1-basic-2pl-standard-two-phase-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type 1: Basic 2PL (Standard Two-Phase Locking)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-2-strict-2pl-most-common" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type 2: Strict 2PL (Most Common)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-3-rigorous-2pl-strongest" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type 3: Rigorous 2PL (Strongest)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-4-conservative-2pl-deadlock-free" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type 4: Conservative 2PL (Deadlock-Free)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comparison-of-all-2pl-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comparison of All 2PL Types
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-deadlock-problem-in-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Deadlock Problem in Concurrency Control
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Deadlock Problem in Concurrency Control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-deadlock-in-pessimistic-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 Deadlock in Pessimistic Concurrency Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-deadlock-in-optimistic-concurrency-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Deadlock in Optimistic Concurrency Control
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-distributed-transactions" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Distributed Transactions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Distributed Transactions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-two-phase-commit-2pc-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Two-Phase Commit (2PC) Protocol
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-how-two-phase-commit-works-step-by-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 How Two-Phase Commit Works (Step-by-Step)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-advantages-of-two-phase-commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 Advantages of Two-Phase Commit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-disadvantages-of-two-phase-commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 Disadvantages of Two-Phase Commit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-problems-in-two-phase-commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 Problems in Two-Phase Commit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66-three-phase-commit-3pc-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.6 Three-Phase Commit (3PC) Protocol
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-how-three-phase-commit-handles-coordinator-failure" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.7 How Three-Phase Commit Handles Coordinator Failure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68-advantages-of-three-phase-commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.8 Advantages of Three-Phase Commit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#69-disadvantages-of-three-phase-commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.9 Disadvantages of Three-Phase Commit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#610-problems-in-three-phase-commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.10 Problems in Three-Phase Commit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-saga-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Saga Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Saga Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-types-of-saga-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Types of Saga Implementation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-saga-pattern-example-e-commerce-order" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Saga Pattern Example: E-Commerce Order
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-advantages-of-saga-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 Advantages of Saga Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74-disadvantages-of-saga-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 Disadvantages of Saga Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75-problems-in-saga-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.5 Problems in Saga Pattern
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-sourcing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Sourcing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hashing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hashing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../load-balancer-and-proxy-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Load Balancer & Proxy Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../microservices-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Microservices Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../passwords/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Passwords
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../process/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../raft-consensus-algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raft Consensus Algorithm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../restfull-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RESTful Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    S3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scaling-to-one-million/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scaling to One Million
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sockets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../webrtc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    WebRTC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2_3" >
        
          
          <label class="md-nav__link" for="__nav_11_2_3" id="__nav_11_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Designing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_11_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Designing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/app-store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    App Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/authentication-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authentication System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/chat-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/chess-game/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chess Game
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/data-warehouse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Warehouse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/distributed-geospatial-data-platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Geospatial Data Platform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/distributed-messaging-queue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Messaging Queue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/dns-server.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DNS Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/e-commerce/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    E-Commerce
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/ecommerce-checkout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    E-Commerce Checkout
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/email-automation-platform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Email Automation Platform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/food-delivery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Food Delivery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/google-drive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Google Drive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/hashtag-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hashtag Service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/how-to-host-your-own-x/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to Host Your Own X
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/Image-Optimisation-on-the-fly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image Optimisation On The Fly
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/key-value-store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Key Value Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/large-language-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Large Language Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/leetcode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LeetCode
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/live-comments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Live Comments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/log-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Log System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/multiplayer-game/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multiplayer Game
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/netflix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Netflix
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/notification-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Notification System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/products/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Products
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/rate-limiter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rate Limiter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/recomendation-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recommendation Engine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/redis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/search-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Search Engine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/social-media/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Social Media
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/spotify/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spotify
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/stock-broker-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stock Broker System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/tiny-url/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tiny URL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/twitter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Twitter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/uber/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Uber
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/upi-payments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UPI Payments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/video-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Video Streaming
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/vpn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VPN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/webhook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Webhook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../desgining/yelp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Yelp
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_2_4" >
        
          
          <label class="md-nav__link" for="__nav_11_2_4" id="__nav_11_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Links
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_11_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Links
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../links/udemy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Udemy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../links/websites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Websites
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../links/youtube/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    YouTube
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3" >
        
          
          <label class="md-nav__link" for="__nav_11_3" id="__nav_11_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Low Level Design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Low Level Design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3_2" >
        
          
          <label class="md-nav__link" for="__nav_11_3_2" id="__nav_11_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_11_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/concepts/hashmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HashMap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/concepts/solid-principles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SOLID Principles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/concepts/technical-debt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Technical Debt
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3_3" >
        
          
          <label class="md-nav__link" for="__nav_11_3_3" id="__nav_11_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Design Patterns
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_11_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Design Patterns
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/design-pattern/design-pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3_3_2" >
        
          
          <label class="md-nav__link" for="__nav_11_3_3_2" id="__nav_11_3_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Others
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_11_3_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Others
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/design-pattern/others/null-object-pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Null Object Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3_4" >
        
          
          <label class="md-nav__link" for="__nav_11_3_4" id="__nav_11_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Designing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_11_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Designing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/access-management-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Access Management System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/account-balance-tracker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Account Balance Tracker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/air-traffic-controller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Air Traffic Controller
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/atm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ATM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/cache-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cache System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/car-rental-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Car Rental Service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/chess-game/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chess Game
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/elevator-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elevator System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/locker-allocation-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Locker Allocation System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/parking-lot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parking Lot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/snake-and-ladder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Snake and Ladder
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/stock-exchange-book/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stock Exchange Book
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/tic-tac-toe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tic Tac Toe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../low-level/designing/vending-machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vending Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="distributed-concurrency-control">Distributed Concurrency Control</h1>
<h2 id="youtube">Youtube</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=ET_DnJgfplY">20. Handle Distributed Transactions | Two-Phase Commit (2PC), Three-Phase Commit (3PC), SAGA Pattern</a></li>
<li><a href="https://www.youtube.com/watch?v=D3XhDu--uoI">System Design: Concurrency Control in Distributed System | Optimistic &amp; Pessimistic Concurrency Lock</a></li>
<li><a href="https://www.youtube.com/watch?v=lceenm34m-w">23. Two Phase Locking (2PL) | System Design</a></li>
<li><a href="https://www.youtube.com/watch?v=QaH7r4V4RmE">Dual Write Problem | Designing Event-Driven Microservices</a></li>
</ul>
<h2 id="theory">Theory</h2>
<h3 id="1-what-is-a-transaction-and-what-is-isolation-in-a-transaction">1. What is a Transaction and What is Isolation in a Transaction?</h3>
<h4 id="what-is-a-transaction">What is a Transaction?</h4>
<p>A <strong>transaction</strong> is a logical unit of work that consists of one or more database operations (INSERT, UPDATE, DELETE, SELECT) that are executed as a single atomic unit. The transaction either completes entirely or has no effect at all.</p>
<p><strong>ACID Properties of Transactions:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>                    ACID PROPERTIES                          
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                                                             
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  A - Atomicity                                              
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>              
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>   All operations succeed OR all fail                     
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>   No partial completion                                  
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>   Example: Bank transfer - debit + credit                
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>              
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                                                             
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  C - Consistency                                            
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>              
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>   Database moves from one valid state                    
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>   to another valid state                                 
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>   Constraints maintained (foreign keys, etc)             
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>              
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                                             
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>  I - Isolation                                              
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>              
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>   Concurrent transactions don&#39;t interfere                
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>   Each transaction appears to run alone                  
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>   Multiple isolation levels available                    
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>              
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                                                             
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>  D - Durability                                             
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>              
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>   Once committed, changes are permanent                  
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>   Survives system crashes                                
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>   Written to persistent storage (disk)                   
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>              
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                                                             
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
</code></pre></div>
<p><strong>Transaction Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Bank Transfer Transaction:
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a> BEGIN TRANSACTION;                         
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>                                            
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a> 1. Read balance of Account A              
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>     $1000                                 
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>                                            
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a> 2. Deduct $100 from Account A              
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    UPDATE accounts                         
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    SET balance = balance - 100             
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    WHERE account_id = &#39;A&#39;                  
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>     A now has $900                        
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>                                            
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a> 3. Add $100 to Account B                   
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    UPDATE accounts                         
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    SET balance = balance + 100             
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    WHERE account_id = &#39;B&#39;                  
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>     B now has $600                        
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>                                            
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a> COMMIT;                                    
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>                                            
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a> If ANY step fails  ROLLBACK (undo all)   
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
</code></pre></div>
<h4 id="what-is-isolation">What is Isolation?</h4>
<p><strong>Isolation</strong> is the "I" in ACID. It determines how and when changes made by one transaction become visible to other concurrent transactions.</p>
<p><strong>Why Isolation is Critical:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Without Isolation:
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>Transaction 1: Transfer $100 from A to B
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>Transaction 2: Calculate total balance (A + B)
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>Timeline without proper isolation:
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>T1: Read A ($1000)
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>T1: Deduct $100 from A (A = $900)
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>                        T2: Read A ($900)  Wrong!
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>                        T2: Read B ($500)  B not updated yet
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>                        T2: Total = $1400  INCORRECT! (should be $1500)
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>T1: Add $100 to B (B = $600)
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>T1: Commit
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>Problem: T2 sees inconsistent state (money disappeared!)
</code></pre></div>
<p><strong>Isolation Levels Trade-off:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>         Isolation Level Spectrum                           
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>                                                            
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>  Weak Isolation                    Strong Isolation     
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>  (High Performance)                  (High Correctness)   
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>                                                            
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>  Read Uncommitted                                          
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>                                                           
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>  Read Committed                                            
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>                                                           
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>  Repeatable Read                                           
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>                                                           
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>  Serializable                                              
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>                                                            
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>   More Concurrency    vs    More Consistency            
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>   Less Consistent          Less Concurrent              
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>                                                            
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
</code></pre></div>
<p><strong>Pseudo Code - Transaction Structure:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_transaction</span><span class="p">():</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic transaction structure&quot;&quot;&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="n">connection</span> <span class="o">=</span> <span class="n">get_database_connection</span><span class="p">()</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="c1"># Start transaction</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">()</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>        <span class="c1"># Execute operations</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="n">operation1</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="n">operation2</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="n">operation3</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="c1"># Commit if all succeed</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transaction committed successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="c1"># Rollback on any error</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction rolled back: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="k">def</span><span class="w"> </span><span class="nf">bank_transfer</span><span class="p">(</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-world transaction example&quot;&quot;&quot;</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="n">connection</span> <span class="o">=</span> <span class="n">get_database_connection</span><span class="p">()</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">begin_transaction</span><span class="p">()</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="c1"># 1. Check sufficient balance</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="n">balance</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>            <span class="s2">&quot;SELECT balance FROM accounts WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>            <span class="p">[</span><span class="n">from_account</span><span class="p">]</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>        <span class="c1"># 2. Debit from source account</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>            <span class="s2">&quot;UPDATE accounts SET balance = balance - ? WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>            <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">]</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>        <span class="p">)</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>        <span class="c1"># 3. Credit to destination account</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>            <span class="s2">&quot;UPDATE accounts SET balance = balance + ? WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>            <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">]</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>        <span class="p">)</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>        <span class="c1"># 4. Log transaction</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>            <span class="s2">&quot;INSERT INTO transfers (from_acc, to_acc, amount, timestamp) VALUES (?, ?, ?, ?)&quot;</span><span class="p">,</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>            <span class="p">[</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">now</span><span class="p">()]</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>        <span class="p">)</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>        <span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>        <span class="n">log_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<hr />
<h3 id="2-what-are-the-isolation-problems">2. What are the Isolation Problems?</h3>
<p>When multiple transactions run concurrently without proper isolation, several anomalies can occur:</p>
<h4 id="21-dirty-read-problem">2.1 Dirty Read Problem</h4>
<p><strong>Description:</strong></p>
<p>A <strong>dirty read</strong> occurs when a transaction reads data that has been modified by another transaction but <strong>not yet committed</strong>. If the other transaction rolls back, the first transaction has read data that never actually existed in the database.</p>
<p><strong>Context &amp; Problem:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Timeline of Dirty Read:
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Time    Transaction 1                    Transaction 2
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>t1      BEGIN TRANSACTION
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>t2      UPDATE account 
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        SET balance = 900
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        WHERE id = &#39;A&#39;
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        (balance was 1000)
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                                         BEGIN TRANSACTION
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>t3                                       SELECT balance 
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                                         FROM account
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                                         WHERE id = &#39;A&#39;
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>                                          Reads 900 (DIRTY!)
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>t4      ROLLBACK                         
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        (balance returns to 1000)
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>t5                                       Uses balance = 900
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>                                          WRONG! Should be 1000
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>                                         COMMIT
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>Problem: Transaction 2 read uncommitted data that was rolled back!
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>                    DIRTY READ ANOMALY                   
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>                                                         
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  Transaction 1              Database          Transaction 2
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>                                                         
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>  BEGIN                                                  
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>                                                        
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>     UPDATE balance=900  [balance=900]            
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>                                (uncommitted)          
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>                                                      
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>                                      BEGIN      
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>                                            READ  900 (DIRTY!)
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>                                                      
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>  ROLLBACK  [balance=1000]                         
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>               (original restored)                     
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>                                              Uses 900  WRONG!
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>                                               COMMIT   
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>                                                         
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>  Result: Transaction 2 based decision on invalid data  
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>
</code></pre></div>
<p><strong>Pseudo Code Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Dirty Read Scenario</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1"># Transaction 1 (will rollback)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">transaction_1</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="c1"># Update product price</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE products SET price = 50 WHERE id = 1&quot;</span><span class="p">)</span>  <span class="c1"># Was 100</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="c1"># Simulate some processing</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="c1"># Oops, error! Rollback</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># Price returns to 100</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="c1"># Transaction 2 (reads dirty data)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">transaction_2</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Starts after T1&#39;s update</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="c1"># Reads uncommitted price</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="n">price</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT price FROM products WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Price: </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Prints 50 (DIRTY!)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="c1"># Makes decision based on dirty data</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>    <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO orders (product_id, quantity) VALUES (1, 100)&quot;</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span class="c1"># But actual price is 100, not 50! Order should not have been placed!</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="c1"># How to prevent: Use READ COMMITTED or higher isolation</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">transaction_2_safe</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ COMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>    <span class="c1"># Now will wait for T1 to commit/rollback before reading</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>    <span class="n">price</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT price FROM products WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="c1"># Correctly reads 100 (after T1 rollback)</span>
</code></pre></div>
<p><strong>Advantages of Allowing Dirty Reads:</strong>
-  Maximum concurrency (no blocking)
-  Highest performance
-  Useful for approximate queries (e.g., dashboards showing "live" stats)</p>
<p><strong>Disadvantages:</strong>
-  Can read invalid data
-  Business logic errors (decisions based on data that doesn't exist)
-  Violates data integrity</p>
<hr />
<h4 id="22-non-repeatable-read-problem">2.2 Non-Repeatable Read Problem</h4>
<p><strong>Description:</strong></p>
<p>A <strong>non-repeatable read</strong> occurs when a transaction reads the same row twice and gets <strong>different values</strong> because another transaction modified and committed the data between the two reads.</p>
<p><strong>Context &amp; Problem:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Timeline of Non-Repeatable Read:
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Time    Transaction 1                    Transaction 2
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>t1      BEGIN TRANSACTION
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>t2      SELECT balance 
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        FROM account WHERE id = &#39;A&#39;
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>         Reads 1000
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>                                         BEGIN TRANSACTION
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>t3                                       UPDATE account
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>                                         SET balance = 900
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>                                         WHERE id = &#39;A&#39;
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>t4                                       COMMIT
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>t5      SELECT balance 
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        FROM account WHERE id = &#39;A&#39;
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>         Reads 900 (DIFFERENT!)
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>t6      COMMIT
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>Problem: Same query, different results within one transaction!
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>             NON-REPEATABLE READ ANOMALY                 
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>                                                         
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>  Transaction 1              Database          Transaction 2
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>                                                         
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>  BEGIN                                                  
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>                                                        
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>     READ balance  [balance=1000]             
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        (First read: 1000)                            
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>                                                      
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>                                           BEGIN      
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>                                                     
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>                        [balance=900]  UPDATE       
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>                                                     
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>                                           COMMIT     
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>                                                      
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>     READ balance  [balance=900]              
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        (Second read: 900)  DIFFERENT!                
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>                                                        
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>  COMMIT                                                 
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>                                                         
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>  Problem: Transaction 1 sees inconsistent view of data  
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>  Use Case Affected: Financial reports, analytics       
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
</code></pre></div>
<p><strong>Real-World Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>Banking Report Transaction:
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>1. 9:00 AM: Report reads Account A balance: $1000
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>2. 9:00 AM: Report reads Account B balance: $2000
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>3. 9:01 AM: Another transaction transfers $500 from A to B (COMMITS)
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>4. 9:02 AM: Report re-reads Account A balance: $500  CHANGED!
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>5. 9:02 AM: Report re-reads Account B balance: $2500  CHANGED!
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>Report shows: 
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>- First reading: A=$1000, B=$2000, Total=$3000
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>- Second reading: A=$500, B=$2500, Total=$3000
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>But individual account values changed mid-transaction!
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>This could cause errors in complex calculations.
</code></pre></div>
<p><strong>Pseudo Code Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Non-Repeatable Read Scenario</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_financial_report</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates a report that requires consistent data&quot;&quot;&quot;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>  <span class="c1"># Using READ COMMITTED (allows non-repeatable reads)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="c1"># First read</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = &#39;A&#39;&quot;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First read: Account A = $</span><span class="si">{</span><span class="n">balance1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $1000</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="c1"># Some processing...</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="c1"># Second read (another transaction might have modified data)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = &#39;A&#39;&quot;</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second read: Account A = $</span><span class="si">{</span><span class="n">balance2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $500 (DIFFERENT!)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="c1"># Calculate something using both reads</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="n">average</span> <span class="o">=</span> <span class="p">(</span><span class="n">balance1</span> <span class="o">+</span> <span class="n">balance2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Using inconsistent data!</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average: $</span><span class="si">{</span><span class="n">average</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $750 (meaningless!)</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="c1"># Concurrent transaction that causes the problem</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">concurrent_update</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Runs between first and second read</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = 500 WHERE id = &#39;A&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="c1"># Solution: Use REPEATABLE READ isolation</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_financial_report_safe</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Safe version with REPEATABLE READ&quot;&quot;&quot;</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>    <span class="c1"># First read</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = &#39;A&#39;&quot;</span>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First read: $</span><span class="si">{</span><span class="n">balance1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $1000</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>    <span class="c1"># Second read - SAME value even if others modified it!</span>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = &#39;A&#39;&quot;</span>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second read: $</span><span class="si">{</span><span class="n">balance2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $1000 (SAME!)</span>
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>    <span class="c1"># Consistent calculation</span>
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>    <span class="n">average</span> <span class="o">=</span> <span class="p">(</span><span class="n">balance1</span> <span class="o">+</span> <span class="n">balance2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average: $</span><span class="si">{</span><span class="n">average</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $1000</span>
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p><strong>Advantages of Allowing Non-Repeatable Reads:</strong>
-  Better concurrency than REPEATABLE READ
-  Reads always see latest committed data
-  Lower lock overhead</p>
<p><strong>Disadvantages:</strong>
-  Inconsistent view within a transaction
-  Can't rely on data staying the same
-  Problems for reports and analytics</p>
<hr />
<h4 id="23-phantom-read-problem">2.3 Phantom Read Problem</h4>
<p><strong>Description:</strong></p>
<p>A <strong>phantom read</strong> occurs when a transaction re-executes a query with a <strong>range condition</strong> (e.g., WHERE clause) and finds <strong>different rows</strong> because another transaction inserted or deleted rows that match the condition.</p>
<p><strong>Context &amp; Problem:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>Timeline of Phantom Read:
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>Time    Transaction 1                    Transaction 2
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>t1      BEGIN TRANSACTION
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>t2      SELECT COUNT(*) 
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>        FROM orders 
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        WHERE status = &#39;pending&#39;
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>         Returns 10 rows
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>                                         BEGIN TRANSACTION
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>t3                                       INSERT INTO orders
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>                                         (status) VALUES (&#39;pending&#39;)
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>t4                                       COMMIT
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>t5      SELECT COUNT(*) 
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        FROM orders 
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        WHERE status = &#39;pending&#39;
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>         Returns 11 rows (NEW ROW!)
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>t6      COMMIT
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>Problem: New rows appeared (like phantoms!) between reads
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>                  PHANTOM READ ANOMALY                   
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>                                                         
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>  Transaction 1              Database          Transaction 2
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>                                                         
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>  BEGIN                                                  
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>                                                        
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>     SELECT WHERE age &gt; 25                            
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>         Returns [A, B, C]   [Row A]              
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>          (3 rows)               [Row B]              
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>                                  [Row C]              
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>                                                      
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>                                           BEGIN      
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>                                                     
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>                                  [Row D]  INSERT   
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>                               (age=30, NEW!)         
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>                                           COMMIT     
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>                                                      
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>     SELECT WHERE age &gt; 25                            
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>         Returns [A, B, C, D]  [Row A]             
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>          (4 rows - PHANTOM!)      [Row B]             
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>                                  [Row C]              
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>                                  [Row D]  NEW!       
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>                                                        
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>  COMMIT                                                 
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>                                                         
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>  Difference from Non-Repeatable Read:                   
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>   Non-Repeatable: SAME row, DIFFERENT value           
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>   Phantom: DIFFERENT number of rows                    
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>
</code></pre></div>
<p><strong>Concrete Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>E-commerce Inventory Transaction:
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>T1: Admin wants to know total pending orders
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    Query: SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    Result: 100 orders
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    ... Admin calculates shipping capacity needed: 100 orders ...
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>T2: (Meanwhile) Customer places new order
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    INSERT INTO orders (status) VALUES (&#39;pending&#39;)
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    COMMIT
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>T1: Admin re-runs query to verify
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    Query: SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>    Result: 101 orders  PHANTOM!
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    Problem: Capacity calculation is now wrong!
</code></pre></div>
<p><strong>Pseudo Code Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Phantom Read Scenario</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_statistics</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate statistics - affected by phantom reads&quot;&quot;&quot;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>  <span class="c1"># Still allows phantoms!</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="c1"># First query: Count pending orders</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="n">count1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First count: </span><span class="si">{</span><span class="n">count1</span><span class="si">}</span><span class="s2"> orders&quot;</span><span class="p">)</span>  <span class="c1"># 100 orders</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="c1"># Calculate average order value</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="n">avg1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>        <span class="s2">&quot;SELECT AVG(total) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First average: $</span><span class="si">{</span><span class="n">avg1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $50.00</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Another transaction inserts rows</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>    <span class="c1"># Second query: Re-count pending orders</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>    <span class="n">count2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second count: </span><span class="si">{</span><span class="n">count2</span><span class="si">}</span><span class="s2"> orders&quot;</span><span class="p">)</span>  <span class="c1"># 105 orders (PHANTOM!)</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>    <span class="c1"># Recalculate average</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>    <span class="n">avg2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>        <span class="s2">&quot;SELECT AVG(total) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second average: $</span><span class="si">{</span><span class="n">avg2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $52.30 (CHANGED!)</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>    <span class="c1"># Inconsistent!</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>    <span class="k">if</span> <span class="n">count1</span> <span class="o">!=</span> <span class="n">count2</span><span class="p">:</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Phantom reads detected!&quot;</span><span class="p">)</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="c1"># Concurrent transaction inserting phantom rows</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">place_orders</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>    <span class="c1"># Insert 5 new pending orders (phantoms!)</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>            <span class="s2">&quot;INSERT INTO orders (status, total) VALUES (&#39;pending&#39;, 60.00)&quot;</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>        <span class="p">)</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a><span class="c1"># Solution: Use SERIALIZABLE isolation</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_statistics_safe</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Safe version with SERIALIZABLE isolation&quot;&quot;&quot;</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">)</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>    <span class="c1"># First query</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>    <span class="n">count1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>    <span class="n">avg1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>        <span class="s2">&quot;SELECT AVG(total) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>    <span class="c1"># Second query - NO PHANTOMS!</span>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>    <span class="c1"># Either blocks until other transaction commits,</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>    <span class="c1"># or other transaction is aborted</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>    <span class="n">count2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>    <span class="n">avg2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>        <span class="s2">&quot;SELECT AVG(total) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a>    <span class="c1"># Guaranteed consistent</span>
<a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>    <span class="k">assert</span> <span class="n">count1</span> <span class="o">==</span> <span class="n">count2</span>
<a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>    <span class="k">assert</span> <span class="n">avg1</span> <span class="o">==</span> <span class="n">avg2</span>
<a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>
<a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>
<a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a>
<a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a><span class="c1"># Alternative: Use explicit locking</span>
<a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_statistics_with_locks</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Use explicit range locks&quot;&quot;&quot;</span>
<a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>
<a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a>    <span class="c1"># Lock the range to prevent inserts</span>
<a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a>        <span class="s2">&quot;SELECT * FROM orders WHERE status = &#39;pending&#39; FOR UPDATE&quot;</span>
<a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a>    <span class="p">)</span>
<a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>    <span class="c1"># Or use table lock</span>
<a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;LOCK TABLE orders IN EXCLUSIVE MODE&quot;</span><span class="p">)</span>
<a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a>
<a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>    <span class="c1"># Now queries are consistent</span>
<a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a>
<a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p><strong>Comparison: Non-Repeatable vs Phantom Reads:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Non-Repeatable Read: SAME row, DIFFERENT value</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">non_repeatable_example</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="c1"># Read row with id=1</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="n">price1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT price FROM products WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="c1"># price1 = $100</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>    <span class="c1"># ... another transaction updates this row ...</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="c1"># Read SAME row again</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">price2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT price FROM products WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="c1"># price2 = $150 (CHANGED!)</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="c1"># Same row, different value</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="c1"># Phantom Read: DIFFERENT number of rows</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">phantom_read_example</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    <span class="c1"># Query with range condition</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    <span class="n">rows1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE price &gt; 100&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>    <span class="c1"># Returns 10 rows</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>    <span class="c1"># ... another transaction inserts NEW row with price=120 ...</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>    <span class="c1"># Same query again</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>    <span class="n">rows2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE price &gt; 100&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>    <span class="c1"># Returns 11 rows (NEW ROW appeared!)</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>    <span class="c1"># Different number of rows (phantom)</span>
</code></pre></div>
<p><strong>Advantages of Allowing Phantom Reads:</strong>
-  Better performance than SERIALIZABLE
-  Protects individual rows (REPEATABLE READ)
-  Sufficient for many use cases</p>
<p><strong>Disadvantages:</strong>
-  Range queries return inconsistent results
-  COUNT, SUM, AVG can change mid-transaction
-  Problems for analytics and reporting</p>
<hr />
<h3 id="3-what-are-the-isolation-levels">3. What are the Isolation Levels?</h3>
<p>The SQL standard defines four isolation levels that provide different trade-offs between consistency and concurrency:</p>
<h4 id="31-read-uncommitted">3.1 Read Uncommitted</h4>
<p><strong>Description:</strong></p>
<p>The <strong>weakest isolation level</strong>, also known as <strong>"dirty read"</strong> mode. At this level, transactions operate with <strong>minimal isolation</strong> - they can read data that has been modified by other transactions but not yet committed. This means a transaction can see "dirty" (uncommitted) data that might be rolled back later.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li><strong>No isolation guarantees</strong> - transactions can see each other's uncommitted changes</li>
<li><strong>Maximum concurrency</strong> - no locks interfere with reads or writes</li>
<li><strong>Fastest performance</strong> - minimal overhead, no waiting</li>
<li><strong>Data integrity not guaranteed</strong> - can read data that never actually existed in the database</li>
<li><strong>Allows all anomalies</strong> - dirty reads, non-repeatable reads, phantom reads</li>
</ul>
<p><strong>Locking Strategy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>     READ UNCOMMITTED - Locking Strategy                 
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>                                                         
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a> READ Operations:                                        
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>          
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>   NO read locks acquired                            
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>   Reads NEVER wait for write locks                  
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>   Can read rows being modified                      
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>   Ignores all existing locks                        
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>          
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>                                                         
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a> WRITE Operations:                                       
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>          
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>   Acquires exclusive write locks                    
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>   Holds locks until commit/rollback                 
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>   Blocks other WRITES (not reads)                   
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>   Prevents lost updates                             
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>          
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>                                                         
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a> Lock Compatibility Matrix:                              
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>                     
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>               Read     Write                       
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>                     
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>  Read                         (no locks!)        
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>  Write                        (write locks)      
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>                     
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>                                                         
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a> Implementation:                                         
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>  PostgreSQL: SET TRANSACTION ISOLATION LEVEL           
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>               READ UNCOMMITTED (upgrades to READ        
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>               COMMITTED - doesn&#39;t support true dirty)   
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>  MySQL: Uses &quot;dirty read&quot; mode with no read locks      
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>  SQL Server: NOLOCK hint or READ UNCOMMITTED          
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>  Oracle: Not supported (minimum is READ COMMITTED)     
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>                                                         
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>
</code></pre></div>
<p><strong>How Locking Works (or Doesn't):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Scenario: Two transactions accessing same row
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>T1: UPDATE account SET balance = 500 WHERE id = 1
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    Acquires EXCLUSIVE WRITE LOCK on row id=1
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    [Row 1: balance=500, WRITE LOCKED by T1]
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    (not yet committed)
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>T2: SELECT balance FROM account WHERE id = 1
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    NO READ LOCK NEEDED
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    Ignores T1&#39;s write lock
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>    Reads uncommitted value: 500  (DIRTY READ!)
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>    
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>    No waiting, no blocking
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>T1: ROLLBACK
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    [Row 1: balance=1000] (original value restored)
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>Result: T2 read value (500) that never committed!
</code></pre></div>
<p><strong>How it Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>           READ UNCOMMITTED - How it Works               
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>                                                         
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>   NO read locks acquired                               
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>   Reads don&#39;t block writes                             
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>   Writes don&#39;t block reads                             
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>   Can read data being modified by other transactions   
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>                                                         
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>  Transaction 1          Database          Transaction 2 
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>                                                         
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>  UPDATE x = 10          [x = 10]                        
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>  (not committed)        (dirty)                         
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>                                                        
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>                             READ x = 10         
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>                                   (reads dirty data!)   
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>  ROLLBACK               [x = 5]                         
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>  (x back to 5)          (original)                      
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>                                                         
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>  T2 read wrong value (10 instead of 5)!                 
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>                                                         
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>READ UNCOMMITTED - All Problems Allowed:
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a> T1: BEGIN                                            
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a> T1: UPDATE balance = 900                             
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>      (uncommitted)                                  
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>     [balance = 900]  DIRTY DATA                     
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>                                                     
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>          T2: BEGIN                               
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>              T2: READ balance = 900  (DIRTY READ)   
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>              T2: Use 900 in calculations             
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>              T2: COMMIT                              
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>                                                     
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a> T1: ROLLBACK                                         
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>     [balance = 1000]  Back to original              
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>                                                      
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a> Result: T2 used invalid data!                        
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>Problems Allowed:
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a> Dirty Read        - YES
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a> Non-Repeatable    - YES
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a> Phantom Read      - YES
</code></pre></div>
<p><strong>Pseudo Code:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># READ UNCOMMITTED Example</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_uncommitted_transaction</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrates READ UNCOMMITTED behavior&quot;&quot;&quot;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ UNCOMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="c1"># Can read uncommitted data from other transactions</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="c1"># This balance might be:</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="c1"># 1. Uncommitted (dirty)</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>    <span class="c1"># 2. About to be rolled back</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>    <span class="c1"># 3. Different if we read again (non-repeatable)</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>    <span class="c1"># 4. Include phantom rows if using COUNT/SUM</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balance: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Might be wrong!</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="c1"># Use Case: Live dashboards (approximations OK)</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">dashboard_stats</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Acceptable use of READ UNCOMMITTED&quot;&quot;&quot;</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ UNCOMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>    <span class="c1"># Get approximate counts for dashboard</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="c1"># Exactness not critical, performance is</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>    <span class="n">total_users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>    <span class="n">total_orders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a>    <span class="n">revenue</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT SUM(total) FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>    <span class="c1"># These are approximate but fast!</span>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="n">total_users</span><span class="p">,</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a>        <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="n">total_orders</span><span class="p">,</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>        <span class="s2">&quot;revenue&quot;</span><span class="p">:</span> <span class="n">revenue</span>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>    <span class="p">}</span>
</code></pre></div>
<p><strong>Advantages:</strong>
-  <strong>Maximum concurrency</strong> - no blocking
-  <strong>Best performance</strong> - no locks acquired
-  <strong>No deadlocks</strong> - transactions never wait
-  <strong>Good for analytics</strong> - approximate results acceptable</p>
<p><strong>Disadvantages:</strong>
-  <strong>Dirty reads</strong> - can read rollback data
-  <strong>Unreliable data</strong> - values may be invalid
-  <strong>Not suitable for business logic</strong> - can cause serious errors
-  <strong>Data integrity issues</strong> - decisions based on wrong data</p>
<p><strong>When to Use:</strong>
- Read-only reporting with approximate results
- Monitoring dashboards
- Non-critical analytics
- High-volume data warehousing</p>
<hr />
<h4 id="24-understanding-locks-shared-vs-exclusive">2.4 Understanding Locks: Shared vs Exclusive</h4>
<p><strong>Description:</strong></p>
<p>Database locks are the fundamental mechanism used to control concurrent access to data and implement isolation levels. Understanding the two primary types of locks - <strong>Shared Locks</strong> and <strong>Exclusive Locks</strong> - is essential to understanding how databases prevent isolation problems and achieve different isolation levels.</p>
<p><strong>Lock Types:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>              DATABASE LOCK TYPES                        
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>                                                         
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a> 1. SHARED LOCK (S-lock / Read Lock)                    
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>          
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>   Acquired when reading data                        
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>   Multiple transactions can hold                    
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    shared locks on same resource                     
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>   Allows concurrent reads                           
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>   Prevents modifications while held                 
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>   &quot;Many readers, no writers&quot;                        
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>          
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>                                                         
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a> 2. EXCLUSIVE LOCK (X-lock / Write Lock)                
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>          
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>   Acquired when modifying data                      
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>   ONLY ONE transaction can hold                     
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>    exclusive lock on a resource                      
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>   Blocks ALL other locks (read &amp; write)             
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>   Ensures isolated modifications                    
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>   &quot;One writer, no readers&quot;                          
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>          
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>                                                         
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
</code></pre></div>
<p><strong>Lock Compatibility Matrix:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>          LOCK COMPATIBILITY MATRIX                      
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>                                                         
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a> Current Lock      Shared (S)    Exclusive (X)        
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a> on Resource                                          
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>         
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a> Request                                              
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a> Shared (S)                                         
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>                   (Compatible)   (Blocked)           
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>         
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a> Request                                              
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a> Exclusive (X)                                      
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>                   (Blocked)      (Blocked)           
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>         
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>                                                         
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>  Compatible: Lock granted immediately                 
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>  Blocked: Transaction must wait                       
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>                                                         
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a> Key Rules:                                              
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>  Shared + Shared =  (Multiple readers allowed)       
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>  Shared + Exclusive =  (Reader blocks writer)        
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>  Exclusive + Shared =  (Writer blocks reader)        
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>  Exclusive + Exclusive =  (Writer blocks writer)     
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>                                                         
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>
</code></pre></div>
<p><strong>Visual Diagram - Lock Interactions:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>         SHARED LOCKS - Multiple Readers                 
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>                                                         
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>  Transaction 1    Transaction 2    Transaction 3       
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>                                                     
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>        READ row 1                                  
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>         (Shared Lock)                               
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>                                                   
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>                        READ row 1                  
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>                         (Shared Lock)               
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>                                                  
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>                                         READ row 1  
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>                                          (Shared)    
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>                                               
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>                                                     
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>        All can read simultaneously                  
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>                                                         
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>       EXCLUSIVE LOCK - Single Writer Blocks All         
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>                                                         
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>  Transaction 1    Transaction 2    Transaction 3       
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>                                                     
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>        UPDATE row 1                                
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>         (Exclusive)                                 
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>                                                   
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>                        READ row 1                  
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>                          BLOCKED!                 
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>                         [waiting...]                
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>                                       UPDATE row 1
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>                                           BLOCKED! 
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>                                          [waiting...] 
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>                                                   
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>        COMMIT                                     
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>         (Release)                                   
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>                                                   
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>                         Unblocked                
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>                         READ succeeds               
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>                                                     
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>                                                         
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>  Writer blocks ALL (readers and other writers)          
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>                                                         
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>
</code></pre></div>
<p><strong>How Locks Prevent Isolation Problems:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>   LOCKS vs ISOLATION PROBLEMS                           
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>                                                         
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a> 1. Preventing DIRTY READS:                              
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>          
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>  Problem: Reading uncommitted data                   
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>                                                      
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>  Solution: Shared locks wait for exclusive          
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>           locks to be released                       
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>                                                      
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>  T1: UPDATE row (Exclusive lock)                  
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>  T2: READ row                                        
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>       Requests Shared lock                          
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>       BLOCKED by T1&#39;s Exclusive lock             
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>       Waits for T1 to COMMIT/ROLLBACK              
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>  T1: COMMIT (Release lock)                        
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>  T2: Acquires Shared lock                          
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>      Reads COMMITTED data only                       
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>                                                      
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>  Used in: READ COMMITTED and higher                  
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>          
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>                                                         
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a> 2. Preventing NON-REPEATABLE READS:                     
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>          
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>  Problem: Same row, different values                 
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>                                                      
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>  Solution: Hold shared locks until commit            
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>                                                      
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>  T1: READ row (Shared lock)                       
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>       HOLDS lock (not released!)                    
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>  T2: UPDATE same row                                 
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>       Requests Exclusive lock                       
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>       BLOCKED by T1&#39;s Shared lock                
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>  T1: READ row again                               
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>       Same value (no changes allowed)               
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>  T1: COMMIT (Release lock)                        
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>  T2: Acquires Exclusive lock                       
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>      Now can update                                  
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>                                                      
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>  Used in: REPEATABLE READ and higher                 
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>          
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>                                                         
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a> 3. Preventing PHANTOM READS:                            
<a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a>          
<a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>  Problem: New rows appearing in results              
<a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a>                                                      
<a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a>  Solution: Range/Gap locks (not just rows)           
<a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a>                                                      
<a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a>  T1: SELECT WHERE age &gt; 25                           
<a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a>       Shared locks on matching rows                 
<a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a>       Range lock on &quot;age &gt; 25&quot; range                
<a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a>       Gap locks between rows                        
<a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a>  T2: INSERT row with age=30                          
<a id="__codelineno-25-55" name="__codelineno-25-55" href="#__codelineno-25-55"></a>       Requests lock in locked range                 
<a id="__codelineno-25-56" name="__codelineno-25-56" href="#__codelineno-25-56"></a>       BLOCKED by T1&#39;s Range lock                 
<a id="__codelineno-25-57" name="__codelineno-25-57" href="#__codelineno-25-57"></a>  T1: SELECT again                                    
<a id="__codelineno-25-58" name="__codelineno-25-58" href="#__codelineno-25-58"></a>       Same rows (no inserts allowed)                
<a id="__codelineno-25-59" name="__codelineno-25-59" href="#__codelineno-25-59"></a>  T1: COMMIT (Release locks)                          
<a id="__codelineno-25-60" name="__codelineno-25-60" href="#__codelineno-25-60"></a>  T2: Insert succeeds                               
<a id="__codelineno-25-61" name="__codelineno-25-61" href="#__codelineno-25-61"></a>                                                      
<a id="__codelineno-25-62" name="__codelineno-25-62" href="#__codelineno-25-62"></a>  Used in: SERIALIZABLE only                          
<a id="__codelineno-25-63" name="__codelineno-25-63" href="#__codelineno-25-63"></a>          
<a id="__codelineno-25-64" name="__codelineno-25-64" href="#__codelineno-25-64"></a>                                                         
<a id="__codelineno-25-65" name="__codelineno-25-65" href="#__codelineno-25-65"></a>
</code></pre></div>
<p><strong>Lock Usage in Isolation Levels:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>      ISOLATION LEVELS - LOCK STRATEGIES                 
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>                                                         
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a> READ UNCOMMITTED:                                       
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>  READ:  NO locks                                   
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>  WRITE: Exclusive locks (held until commit)          
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>  Result: Dirty reads allowed                         
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>                                                         
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a> READ COMMITTED:                                         
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>  READ:  Shared locks (released immediately)          
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>  WRITE: Exclusive locks (held until commit)          
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>  Result: No dirty reads, but non-repeatable reads OK 
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>                                                         
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a> REPEATABLE READ:                                        
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>  READ:  Shared locks (held until commit)             
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>  WRITE: Exclusive locks (held until commit)          
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>  Result: No dirty/non-repeatable, but phantoms OK    
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>                                                         
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a> SERIALIZABLE:                                           
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>  READ:  Shared locks + Range locks (until commit)    
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>  WRITE: Exclusive locks + Gap locks (until commit)   
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>  Result: No anomalies (strict isolation)             
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>                                                         
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a> Lock Duration Progression:                              
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a> None  Short  Long  Long+Range                       
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>                                                    
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>   RU     RC     RR        S                            
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>                                                         
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>
</code></pre></div>
<p><strong>Pseudo Code Examples:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Example 1: Shared Locks - Multiple Readers</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">reader_transaction_1</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;First reader acquires shared lock&quot;&quot;&quot;</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>    <span class="c1"># Acquire shared lock on row 1</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1 LOCK IN SHARE MODE&quot;</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="p">)</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;T1 reads: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># e.g., $1000</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>    <span class="c1"># Shared lock held...</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Release shared lock</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">reader_transaction_2</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Second reader can also acquire shared lock&quot;&quot;&quot;</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>    <span class="c1"># Can acquire shared lock (compatible with T1&#39;s shared lock!)</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1 LOCK IN SHARE MODE&quot;</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>    <span class="p">)</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;T2 reads: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># e.g., $1000  (no blocking!)</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="c1"># Example 2: Exclusive Lock - Writer Blocks Readers</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="k">def</span><span class="w"> </span><span class="nf">writer_transaction</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Writer acquires exclusive lock&quot;&quot;&quot;</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>    <span class="c1"># Acquire exclusive lock</span>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>        <span class="s2">&quot;UPDATE accounts SET balance = 500 WHERE id = 1&quot;</span>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>    <span class="p">)</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1 acquired exclusive lock&quot;</span><span class="p">)</span>
<a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a>
<a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a>    <span class="c1"># Exclusive lock held...</span>
<a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>
<a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Release exclusive lock</span>
<a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a>
<a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>
<a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">reader_transaction_blocked</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reader blocked by exclusive lock&quot;&quot;&quot;</span>
<a id="__codelineno-27-55" name="__codelineno-27-55" href="#__codelineno-27-55"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-56" name="__codelineno-27-56" href="#__codelineno-27-56"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-57" name="__codelineno-27-57" href="#__codelineno-27-57"></a>
<a id="__codelineno-27-58" name="__codelineno-27-58" href="#__codelineno-27-58"></a>    <span class="c1"># Try to acquire shared lock</span>
<a id="__codelineno-27-59" name="__codelineno-27-59" href="#__codelineno-27-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2 requesting shared lock...&quot;</span><span class="p">)</span>
<a id="__codelineno-27-60" name="__codelineno-27-60" href="#__codelineno-27-60"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-61" name="__codelineno-27-61" href="#__codelineno-27-61"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1 LOCK IN SHARE MODE&quot;</span>
<a id="__codelineno-27-62" name="__codelineno-27-62" href="#__codelineno-27-62"></a>    <span class="p">)</span>
<a id="__codelineno-27-63" name="__codelineno-27-63" href="#__codelineno-27-63"></a>    <span class="c1">#  BLOCKED here until T1 commits!</span>
<a id="__codelineno-27-64" name="__codelineno-27-64" href="#__codelineno-27-64"></a>
<a id="__codelineno-27-65" name="__codelineno-27-65" href="#__codelineno-27-65"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-27-66" name="__codelineno-27-66" href="#__codelineno-27-66"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;T2 reads: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Executes after T1 commits</span>
<a id="__codelineno-27-67" name="__codelineno-27-67" href="#__codelineno-27-67"></a>
<a id="__codelineno-27-68" name="__codelineno-27-68" href="#__codelineno-27-68"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-27-69" name="__codelineno-27-69" href="#__codelineno-27-69"></a>
<a id="__codelineno-27-70" name="__codelineno-27-70" href="#__codelineno-27-70"></a>
<a id="__codelineno-27-71" name="__codelineno-27-71" href="#__codelineno-27-71"></a><span class="c1"># Example 3: Preventing Dirty Read with Locks</span>
<a id="__codelineno-27-72" name="__codelineno-27-72" href="#__codelineno-27-72"></a>
<a id="__codelineno-27-73" name="__codelineno-27-73" href="#__codelineno-27-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">dirty_read_prevented</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-74" name="__codelineno-27-74" href="#__codelineno-27-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;How locks prevent dirty reads&quot;&quot;&quot;</span>
<a id="__codelineno-27-75" name="__codelineno-27-75" href="#__codelineno-27-75"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ COMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-27-76" name="__codelineno-27-76" href="#__codelineno-27-76"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-77" name="__codelineno-27-77" href="#__codelineno-27-77"></a>
<a id="__codelineno-27-78" name="__codelineno-27-78" href="#__codelineno-27-78"></a>    <span class="c1"># READ COMMITTED acquires shared lock for reads</span>
<a id="__codelineno-27-79" name="__codelineno-27-79" href="#__codelineno-27-79"></a>    <span class="c1"># This shared lock is INCOMPATIBLE with uncommitted exclusive locks</span>
<a id="__codelineno-27-80" name="__codelineno-27-80" href="#__codelineno-27-80"></a>
<a id="__codelineno-27-81" name="__codelineno-27-81" href="#__codelineno-27-81"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-82" name="__codelineno-27-82" href="#__codelineno-27-82"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-27-83" name="__codelineno-27-83" href="#__codelineno-27-83"></a>    <span class="p">)</span>
<a id="__codelineno-27-84" name="__codelineno-27-84" href="#__codelineno-27-84"></a>    <span class="c1"># If another transaction has uncommitted UPDATE:</span>
<a id="__codelineno-27-85" name="__codelineno-27-85" href="#__codelineno-27-85"></a>    <span class="c1"># - That transaction holds exclusive lock</span>
<a id="__codelineno-27-86" name="__codelineno-27-86" href="#__codelineno-27-86"></a>    <span class="c1"># - Our shared lock request BLOCKS</span>
<a id="__codelineno-27-87" name="__codelineno-27-87" href="#__codelineno-27-87"></a>    <span class="c1"># - We wait until exclusive lock released (commit/rollback)</span>
<a id="__codelineno-27-88" name="__codelineno-27-88" href="#__codelineno-27-88"></a>    <span class="c1"># - Then we read COMMITTED data only</span>
<a id="__codelineno-27-89" name="__codelineno-27-89" href="#__codelineno-27-89"></a>
<a id="__codelineno-27-90" name="__codelineno-27-90" href="#__codelineno-27-90"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-27-91" name="__codelineno-27-91" href="#__codelineno-27-91"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balance: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Always committed value!</span>
<a id="__codelineno-27-92" name="__codelineno-27-92" href="#__codelineno-27-92"></a>
<a id="__codelineno-27-93" name="__codelineno-27-93" href="#__codelineno-27-93"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-27-94" name="__codelineno-27-94" href="#__codelineno-27-94"></a>
<a id="__codelineno-27-95" name="__codelineno-27-95" href="#__codelineno-27-95"></a>
<a id="__codelineno-27-96" name="__codelineno-27-96" href="#__codelineno-27-96"></a><span class="c1"># Example 4: Preventing Non-Repeatable Read with Locks</span>
<a id="__codelineno-27-97" name="__codelineno-27-97" href="#__codelineno-27-97"></a>
<a id="__codelineno-27-98" name="__codelineno-27-98" href="#__codelineno-27-98"></a><span class="k">def</span><span class="w"> </span><span class="nf">non_repeatable_read_prevented</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-99" name="__codelineno-27-99" href="#__codelineno-27-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;How holding shared locks prevents non-repeatable reads&quot;&quot;&quot;</span>
<a id="__codelineno-27-100" name="__codelineno-27-100" href="#__codelineno-27-100"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-27-101" name="__codelineno-27-101" href="#__codelineno-27-101"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-102" name="__codelineno-27-102" href="#__codelineno-27-102"></a>
<a id="__codelineno-27-103" name="__codelineno-27-103" href="#__codelineno-27-103"></a>    <span class="c1"># First read - acquires shared lock and HOLDS it</span>
<a id="__codelineno-27-104" name="__codelineno-27-104" href="#__codelineno-27-104"></a>    <span class="n">result1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-105" name="__codelineno-27-105" href="#__codelineno-27-105"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-27-106" name="__codelineno-27-106" href="#__codelineno-27-106"></a>    <span class="p">)</span>
<a id="__codelineno-27-107" name="__codelineno-27-107" href="#__codelineno-27-107"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">result1</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-27-108" name="__codelineno-27-108" href="#__codelineno-27-108"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First read: </span><span class="si">{</span><span class="n">balance1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-27-109" name="__codelineno-27-109" href="#__codelineno-27-109"></a>    <span class="c1"># Shared lock STILL HELD (not released!)</span>
<a id="__codelineno-27-110" name="__codelineno-27-110" href="#__codelineno-27-110"></a>
<a id="__codelineno-27-111" name="__codelineno-27-111" href="#__codelineno-27-111"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-27-112" name="__codelineno-27-112" href="#__codelineno-27-112"></a>    <span class="c1"># Any UPDATE attempts blocked by our shared lock</span>
<a id="__codelineno-27-113" name="__codelineno-27-113" href="#__codelineno-27-113"></a>
<a id="__codelineno-27-114" name="__codelineno-27-114" href="#__codelineno-27-114"></a>    <span class="c1"># Second read - uses existing shared lock</span>
<a id="__codelineno-27-115" name="__codelineno-27-115" href="#__codelineno-27-115"></a>    <span class="n">result2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-27-116" name="__codelineno-27-116" href="#__codelineno-27-116"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-27-117" name="__codelineno-27-117" href="#__codelineno-27-117"></a>    <span class="p">)</span>
<a id="__codelineno-27-118" name="__codelineno-27-118" href="#__codelineno-27-118"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">result2</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-27-119" name="__codelineno-27-119" href="#__codelineno-27-119"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second read: </span><span class="si">{</span><span class="n">balance2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-27-120" name="__codelineno-27-120" href="#__codelineno-27-120"></a>
<a id="__codelineno-27-121" name="__codelineno-27-121" href="#__codelineno-27-121"></a>    <span class="k">assert</span> <span class="n">balance1</span> <span class="o">==</span> <span class="n">balance2</span>  <span class="c1"># Guaranteed same!</span>
<a id="__codelineno-27-122" name="__codelineno-27-122" href="#__codelineno-27-122"></a>
<a id="__codelineno-27-123" name="__codelineno-27-123" href="#__codelineno-27-123"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># NOW release shared lock</span>
<a id="__codelineno-27-124" name="__codelineno-27-124" href="#__codelineno-27-124"></a>
<a id="__codelineno-27-125" name="__codelineno-27-125" href="#__codelineno-27-125"></a>
<a id="__codelineno-27-126" name="__codelineno-27-126" href="#__codelineno-27-126"></a><span class="c1"># Example 5: Lock Escalation and Deadlocks</span>
<a id="__codelineno-27-127" name="__codelineno-27-127" href="#__codelineno-27-127"></a>
<a id="__codelineno-27-128" name="__codelineno-27-128" href="#__codelineno-27-128"></a><span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_deadlock</span><span class="p">(</span><span class="n">db1</span><span class="p">,</span> <span class="n">db2</span><span class="p">):</span>
<a id="__codelineno-27-129" name="__codelineno-27-129" href="#__codelineno-27-129"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Deadlock from conflicting lock requests&quot;&quot;&quot;</span>
<a id="__codelineno-27-130" name="__codelineno-27-130" href="#__codelineno-27-130"></a>
<a id="__codelineno-27-131" name="__codelineno-27-131" href="#__codelineno-27-131"></a>    <span class="c1"># Transaction 1</span>
<a id="__codelineno-27-132" name="__codelineno-27-132" href="#__codelineno-27-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t1</span><span class="p">():</span>
<a id="__codelineno-27-133" name="__codelineno-27-133" href="#__codelineno-27-133"></a>        <span class="n">db1</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-134" name="__codelineno-27-134" href="#__codelineno-27-134"></a>        <span class="c1"># Acquire exclusive lock on row A</span>
<a id="__codelineno-27-135" name="__codelineno-27-135" href="#__codelineno-27-135"></a>        <span class="n">db1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = 100 WHERE id = &#39;A&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-27-136" name="__codelineno-27-136" href="#__codelineno-27-136"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1: Locked row A&quot;</span><span class="p">)</span>
<a id="__codelineno-27-137" name="__codelineno-27-137" href="#__codelineno-27-137"></a>
<a id="__codelineno-27-138" name="__codelineno-27-138" href="#__codelineno-27-138"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-139" name="__codelineno-27-139" href="#__codelineno-27-139"></a>
<a id="__codelineno-27-140" name="__codelineno-27-140" href="#__codelineno-27-140"></a>        <span class="c1"># Try to lock row B (but T2 has it!)</span>
<a id="__codelineno-27-141" name="__codelineno-27-141" href="#__codelineno-27-141"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1: Requesting lock on row B...&quot;</span><span class="p">)</span>
<a id="__codelineno-27-142" name="__codelineno-27-142" href="#__codelineno-27-142"></a>        <span class="n">db1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = 200 WHERE id = &#39;B&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-27-143" name="__codelineno-27-143" href="#__codelineno-27-143"></a>        <span class="c1">#  DEADLOCK! T1 waits for T2, T2 waits for T1</span>
<a id="__codelineno-27-144" name="__codelineno-27-144" href="#__codelineno-27-144"></a>
<a id="__codelineno-27-145" name="__codelineno-27-145" href="#__codelineno-27-145"></a>        <span class="n">db1</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-27-146" name="__codelineno-27-146" href="#__codelineno-27-146"></a>
<a id="__codelineno-27-147" name="__codelineno-27-147" href="#__codelineno-27-147"></a>    <span class="c1"># Transaction 2</span>
<a id="__codelineno-27-148" name="__codelineno-27-148" href="#__codelineno-27-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2</span><span class="p">():</span>
<a id="__codelineno-27-149" name="__codelineno-27-149" href="#__codelineno-27-149"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-27-150" name="__codelineno-27-150" href="#__codelineno-27-150"></a>        <span class="n">db2</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-151" name="__codelineno-27-151" href="#__codelineno-27-151"></a>        <span class="c1"># Acquire exclusive lock on row B</span>
<a id="__codelineno-27-152" name="__codelineno-27-152" href="#__codelineno-27-152"></a>        <span class="n">db2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = 300 WHERE id = &#39;B&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-27-153" name="__codelineno-27-153" href="#__codelineno-27-153"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2: Locked row B&quot;</span><span class="p">)</span>
<a id="__codelineno-27-154" name="__codelineno-27-154" href="#__codelineno-27-154"></a>
<a id="__codelineno-27-155" name="__codelineno-27-155" href="#__codelineno-27-155"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-156" name="__codelineno-27-156" href="#__codelineno-27-156"></a>
<a id="__codelineno-27-157" name="__codelineno-27-157" href="#__codelineno-27-157"></a>        <span class="c1"># Try to lock row A (but T1 has it!)</span>
<a id="__codelineno-27-158" name="__codelineno-27-158" href="#__codelineno-27-158"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2: Requesting lock on row A...&quot;</span><span class="p">)</span>
<a id="__codelineno-27-159" name="__codelineno-27-159" href="#__codelineno-27-159"></a>        <span class="n">db2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = 400 WHERE id = &#39;A&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-27-160" name="__codelineno-27-160" href="#__codelineno-27-160"></a>        <span class="c1">#  DEADLOCK! Database detects cycle and aborts one transaction</span>
<a id="__codelineno-27-161" name="__codelineno-27-161" href="#__codelineno-27-161"></a>
<a id="__codelineno-27-162" name="__codelineno-27-162" href="#__codelineno-27-162"></a>        <span class="n">db2</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-27-163" name="__codelineno-27-163" href="#__codelineno-27-163"></a>
<a id="__codelineno-27-164" name="__codelineno-27-164" href="#__codelineno-27-164"></a>    <span class="c1"># Database detects deadlock and aborts one transaction:</span>
<a id="__codelineno-27-165" name="__codelineno-27-165" href="#__codelineno-27-165"></a>    <span class="c1"># &quot;Deadlock detected. Transaction rolled back.&quot;</span>
<a id="__codelineno-27-166" name="__codelineno-27-166" href="#__codelineno-27-166"></a>
<a id="__codelineno-27-167" name="__codelineno-27-167" href="#__codelineno-27-167"></a>
<a id="__codelineno-27-168" name="__codelineno-27-168" href="#__codelineno-27-168"></a><span class="c1"># Example 6: Explicit Locking</span>
<a id="__codelineno-27-169" name="__codelineno-27-169" href="#__codelineno-27-169"></a>
<a id="__codelineno-27-170" name="__codelineno-27-170" href="#__codelineno-27-170"></a><span class="k">def</span><span class="w"> </span><span class="nf">explicit_lock_usage</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-27-171" name="__codelineno-27-171" href="#__codelineno-27-171"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manual lock control&quot;&quot;&quot;</span>
<a id="__codelineno-27-172" name="__codelineno-27-172" href="#__codelineno-27-172"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-27-173" name="__codelineno-27-173" href="#__codelineno-27-173"></a>
<a id="__codelineno-27-174" name="__codelineno-27-174" href="#__codelineno-27-174"></a>    <span class="c1"># Explicitly acquire shared lock</span>
<a id="__codelineno-27-175" name="__codelineno-27-175" href="#__codelineno-27-175"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM accounts WHERE id = 1 LOCK IN SHARE MODE&quot;</span><span class="p">)</span>
<a id="__codelineno-27-176" name="__codelineno-27-176" href="#__codelineno-27-176"></a>    <span class="c1"># or: &quot;SELECT * FROM accounts WHERE id = 1 FOR SHARE&quot;</span>
<a id="__codelineno-27-177" name="__codelineno-27-177" href="#__codelineno-27-177"></a>
<a id="__codelineno-27-178" name="__codelineno-27-178" href="#__codelineno-27-178"></a>    <span class="c1"># Explicitly acquire exclusive lock</span>
<a id="__codelineno-27-179" name="__codelineno-27-179" href="#__codelineno-27-179"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM accounts WHERE id = 2 FOR UPDATE&quot;</span><span class="p">)</span>
<a id="__codelineno-27-180" name="__codelineno-27-180" href="#__codelineno-27-180"></a>    <span class="c1"># Row 2 now exclusively locked</span>
<a id="__codelineno-27-181" name="__codelineno-27-181" href="#__codelineno-27-181"></a>
<a id="__codelineno-27-182" name="__codelineno-27-182" href="#__codelineno-27-182"></a>    <span class="c1"># No one can modify row 2 until we commit</span>
<a id="__codelineno-27-183" name="__codelineno-27-183" href="#__codelineno-27-183"></a>
<a id="__codelineno-27-184" name="__codelineno-27-184" href="#__codelineno-27-184"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p><strong>Real-World Lock Timeline:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Example: Banking Transfer with Locks
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>Time  T1 (Transfer)              Locks           T2 (Balance Check)
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>t1    BEGIN                       -               
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>t2    SELECT balance FROM A       S-lock(A)    
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>       $1000                     
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>t3                                                BEGIN
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>t4                                S-lock(A)    SELECT balance FROM A
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>                                                   $1000  (shared OK)
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>t5    UPDATE A SET bal=900        X-lock(A)    
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>      (releases S-lock,            
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>       acquires X-lock)            
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>t6                                X-lock(A)    SELECT balance FROM A
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>                                                   BLOCKED! 
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>t7    UPDATE B SET bal=600        X-lock(B)    [T2 waiting...]
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>t8    COMMIT                      Release all  
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>t9                                -                Reads $900 
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>                                                  (committed value)
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>t10                                               COMMIT
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>Key Points:
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a> t2: T1 acquires S-lock for read
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a> t4: T2 can also get S-lock (compatible)
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a> t5: T1 upgrades to X-lock for update
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a> t6: T2 blocked by T1&#39;s X-lock (prevents dirty read)
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a> t8: T1 commits, releases all locks
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a> t9: T2 unblocked, reads committed data
</code></pre></div>
<p><strong>Advantages of Lock-Based Concurrency Control:</strong>
-  <strong>Prevents anomalies</strong> - dirty reads, non-repeatable reads, phantoms
-  <strong>Ensures consistency</strong> - data integrity maintained
-  <strong>Predictable behavior</strong> - well-understood semantics
-  <strong>Fine-grained control</strong> - row-level, page-level, table-level locks</p>
<p><strong>Disadvantages:</strong>
-  <strong>Performance overhead</strong> - lock management cost
-  <strong>Blocking</strong> - transactions wait for locks
-  <strong>Deadlocks</strong> - circular wait conditions
-  <strong>Reduced concurrency</strong> - higher isolation = more blocking</p>
<p><strong>Alternative: MVCC (Multi-Version Concurrency Control):</strong></p>
<p>Many modern databases use <strong>MVCC</strong> instead of traditional locking for reads:
- <strong>PostgreSQL</strong>: Uses MVCC for all isolation levels
- <strong>MySQL InnoDB</strong>: Uses MVCC for READ COMMITTED and REPEATABLE READ
- <strong>Oracle</strong>: MVCC-based, minimum isolation is READ COMMITTED</p>
<p><strong>MVCC Benefits:</strong>
- Readers don't block writers
- Writers don't block readers
- No read locks needed
- Better concurrency
- Fewer deadlocks</p>
<p><strong>MVCC Trade-offs:</strong>
- More complex implementation
- Higher storage overhead (multiple versions)
- Garbage collection needed for old versions</p>
<hr />
<h4 id="25-isolation-problems-vs-isolation-levels-summary-table">2.5 Isolation Problems vs Isolation Levels - Summary Table</h4>
<p><strong>Description:</strong></p>
<p>This table provides a <strong>quick reference</strong> showing which isolation problems can occur at each isolation level. Understanding this matrix is crucial for choosing the right isolation level for your application.</p>
<p><strong>Isolation Problems Matrix:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>           ISOLATION PROBLEMS vs ISOLATION LEVELS                            
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>                                                                             
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>                       Read          Read       Repeatable              
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>  Isolation Problem    Uncommitted   Committed  Read        Serializable
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a> 
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>                                                                        
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>  Dirty Read              YES           NO          NO          NO      
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>  (Read uncommitted                                                 
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>   data)                Allowed      Prevented   Prevented   Prevented  
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>                                                                        
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a> 
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>                                                                        
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>  Non-Repeatable          YES          YES          NO          NO      
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>  Read                                                              
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>  (Same row,            Allowed      Allowed     Prevented   Prevented  
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>   different value)                                                     
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>                                                                        
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a> 
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>                                                                        
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>  Phantom Read            YES          YES         YES          NO      
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>  (Different row                                                    
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a>   count)               Allowed      Allowed     Allowed     Prevented  
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a>                                                                        
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a> 
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a>                                                                             
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a>  Legend:                                                                    
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a>   YES /  / Allowed    = Problem CAN occur at this isolation level        
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a>   NO  /  / Prevented  = Problem CANNOT occur (prevented by locks/MVCC)   
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>                                                                             
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a>
</code></pre></div>
<p><strong>Detailed Breakdown:</strong></p>
<table>
<thead>
<tr>
<th>Isolation Level</th>
<th>Dirty Read</th>
<th>Non-Repeatable Read</th>
<th>Phantom Read</th>
<th>Locking Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Read Uncommitted</strong></td>
<td> YES</td>
<td> YES</td>
<td> YES</td>
<td>No read locks</td>
</tr>
<tr>
<td><strong>Read Committed</strong></td>
<td> NO</td>
<td> YES</td>
<td> YES</td>
<td>Short-duration read locks</td>
</tr>
<tr>
<td><strong>Repeatable Read</strong></td>
<td> NO</td>
<td> NO</td>
<td> YES</td>
<td>Long-duration read locks (rows only)</td>
</tr>
<tr>
<td><strong>Serializable</strong></td>
<td> NO</td>
<td> NO</td>
<td> NO</td>
<td>Long-duration locks + range locks</td>
</tr>
</tbody>
</table>
<p><strong>Visual Progression:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>Isolation Level Strength (Weakest  Strongest):
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>READ UNCOMMITTED
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a> Prevents: Nothing
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a> Allows: Dirty Read , Non-Repeatable Read , Phantom Read 
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a> Use: Dashboards, approximate analytics
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>READ COMMITTED
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a> Prevents: Dirty Read 
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a> Allows: Non-Repeatable Read , Phantom Read 
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a> Use: Most OLTP applications (DEFAULT)
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>REPEATABLE READ
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a> Prevents: Dirty Read , Non-Repeatable Read 
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a> Allows: Phantom Read 
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a> Use: Financial reports, complex transactions
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>SERIALIZABLE
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a> Prevents: Dirty Read , Non-Repeatable Read , Phantom Read 
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a> Allows: Nothing (full isolation)
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a> Use: Critical operations requiring complete consistency
</code></pre></div>
<p><strong>Key Takeaways:</strong></p>
<ol>
<li><strong>Each higher level prevents more problems</strong>:</li>
<li>Read Uncommitted  Read Committed: Prevents dirty reads</li>
<li>Read Committed  Repeatable Read: Prevents non-repeatable reads</li>
<li>
<p>Repeatable Read  Serializable: Prevents phantom reads</p>
</li>
<li>
<p><strong>Trade-off: Consistency vs Performance</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>Read Uncommitted:   Performance (12/10)
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>                    Consistency (0/10)
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>Read Committed:     Performance (10/10)
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>                    Consistency (8/10)  Best balance!
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>Repeatable Read:    Performance (6/10)
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>                    Consistency (10/10)
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>Serializable:       Performance (3/10)
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>                    Consistency (12/10)
</code></pre></div></p>
</li>
<li>
<p><strong>Default Isolation Levels by Database</strong>:</p>
</li>
<li><strong>PostgreSQL</strong>: Read Committed (can use Serializable with SSI)</li>
<li><strong>MySQL InnoDB</strong>: Repeatable Read (MVCC-based)</li>
<li><strong>Oracle</strong>: Read Committed (MVCC-based)</li>
<li><strong>SQL Server</strong>: Read Committed (can enable MVCC with snapshot isolation)</li>
<li>
<p><strong>SQLite</strong>: Serializable (by default, due to file-level locking)</p>
</li>
<li>
<p><strong>Choosing the Right Level</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>Use Case                           Recommended Level
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>Monitoring dashboard               Read Uncommitted
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>E-commerce checkout                Read Committed
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>Banking transfer                   Read Committed (with explicit locks)
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>Financial report generation        Repeatable Read
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>Inventory management (critical)    Serializable
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>Analytics (approximate OK)         Read Uncommitted
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>Web application (general)          Read Committed
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>Batch processing with aggregates   Repeatable Read or Serializable
</code></pre></div></p>
</li>
</ol>
<p><strong>Real-World Example Comparison:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># Scenario: Reading account balance twice in a transaction</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="c1"># READ UNCOMMITTED</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_uncommitted_example</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ UNCOMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    <span class="c1">#  Could be uncommitted (dirty read) </span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>    <span class="c1">#  Could be different (non-repeatable read) </span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>    <span class="c1">#  Could include phantom rows in COUNT queries </span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="c1"># READ COMMITTED</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_committed_example</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ COMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>    <span class="c1">#  Always committed  (no dirty read)</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>    <span class="c1">#  Could be different (non-repeatable read) </span>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>    <span class="c1">#  Could include phantom rows in COUNT queries </span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="c1"># REPEATABLE READ</span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">repeatable_read_example</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>    <span class="c1">#  Always committed  (no dirty read)</span>
<a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a>    <span class="c1">#  Guaranteed same value  (no non-repeatable read)</span>
<a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a>    <span class="c1">#  But COUNT queries could change (phantom read) </span>
<a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a>
<a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a>
<a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="c1"># SERIALIZABLE</span>
<a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">serializable_example</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">)</span>
<a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a>    <span class="c1">#  Always committed  (no dirty read)</span>
<a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a>    <span class="c1">#  Guaranteed same value  (no non-repeatable read)</span>
<a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM accounts WHERE balance &gt; 1000&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a>    <span class="c1">#  Guaranteed consistent  (no phantom read)</span>
<a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p><strong>Performance Impact:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>Benchmark: 1000 concurrent transactions reading/writing same data
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>Isolation Level      Throughput    Avg Latency    Deadlocks    Blocked Txns
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>Read Uncommitted     1000 tx/sec   10 ms          0            0%
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>Read Committed       850 tx/sec    15 ms          0-1          5%
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>Repeatable Read      600 tx/sec    25 ms          2-5          15%
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>Serializable         300 tx/sec    50 ms          10-20        40%
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>Note: Actual numbers vary by workload, database, and MVCC implementation
</code></pre></div>
<hr />
<h4 id="32-read-committed">3.2 Read Committed</h4>
<p><strong>Description:</strong></p>
<p>The <strong>most widely used isolation level</strong> and the default in most production databases. At this level, a transaction can only read data that has been <strong>committed</strong> by other transactions. This prevents dirty reads but still allows non-repeatable reads and phantom reads.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li><strong>No dirty reads</strong> - only committed data is visible</li>
<li><strong>Short-duration read locks</strong> - acquired and released immediately after each read</li>
<li><strong>Long-duration write locks</strong> - held until transaction commits</li>
<li><strong>Good balance</strong> - prevents most common errors while maintaining concurrency</li>
<li><strong>Default in PostgreSQL, Oracle, SQL Server</strong> - battle-tested for production workloads</li>
<li><strong>Still allows non-repeatable and phantom reads</strong> - data can change between reads</li>
</ul>
<p><strong>Locking Strategy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>      READ COMMITTED - Locking Strategy                  
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>                                                         
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a> READ Operations:                                        
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>          
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>   Acquires SHARED READ LOCKS                        
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>   Holds lock ONLY during read operation             
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>   Releases lock IMMEDIATELY after read              
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>   Blocks if row has uncommitted changes             
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>   Waits for write locks to be released              
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>          
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>                                                         
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a> WRITE Operations:                                       
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>          
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>   Acquires EXCLUSIVE WRITE LOCKS                    
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>   Holds locks until COMMIT or ROLLBACK              
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>   Blocks conflicting reads and writes               
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a>   Prevents lost updates                             
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>          
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>                                                         
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a> Lock Compatibility Matrix:                              
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a>                    
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>               Read      Write                      
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>                    
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>  Read                          (wait)            
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>  Write                         (wait)            
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>                    
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>                                                         
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a> Lock Duration Timeline:                                 
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>                                                         
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a> READ:                                                   
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>  Acquire shared lock                                 
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>  Read data                                           
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a>  Release lock  SHORT DURATION                       
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a>                                                         
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a> WRITE:                                                  
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>  Acquire exclusive lock                              
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>  Modify data                                         
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>  ... (transaction continues)                         
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a>  Release on COMMIT  LONG DURATION                   
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>                                                         
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a> Implementation Variants:                                
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a>                                                         
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a> PostgreSQL:                                             
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a>  Uses MVCC (Multi-Version Concurrency Control)        
<a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a>  Readers don&#39;t block writers                          
<a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a>  Writers don&#39;t block readers                          
<a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a>  Each transaction sees snapshot of committed data     
<a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a>                                                         
<a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a> Oracle:                                                 
<a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a>  Default isolation level                              
<a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a>  MVCC-based with undo segments                        
<a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a>  Statement-level read consistency                     
<a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a>                                                         
<a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a> SQL Server:                                             
<a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a>  Traditional locking (not MVCC by default)            
<a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a>  Readers acquire and release shared locks             
<a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a>  Can enable MVCC with READ_COMMITTED_SNAPSHOT         
<a id="__codelineno-35-60" name="__codelineno-35-60" href="#__codelineno-35-60"></a>                                                         
<a id="__codelineno-35-61" name="__codelineno-35-61" href="#__codelineno-35-61"></a> MySQL InnoDB:                                           
<a id="__codelineno-35-62" name="__codelineno-35-62" href="#__codelineno-35-62"></a>  Uses MVCC                                            
<a id="__codelineno-35-63" name="__codelineno-35-63" href="#__codelineno-35-63"></a>  Consistent non-locking reads                         
<a id="__codelineno-35-64" name="__codelineno-35-64" href="#__codelineno-35-64"></a>  Each read sees snapshot at query start               
<a id="__codelineno-35-65" name="__codelineno-35-65" href="#__codelineno-35-65"></a>                                                         
<a id="__codelineno-35-66" name="__codelineno-35-66" href="#__codelineno-35-66"></a>
</code></pre></div>
<p><strong>How Locking Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Scenario: Transaction reads data being modified
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>Timeline:
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>T1: BEGIN
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>T1: UPDATE account SET balance = 500 WHERE id = 1
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>    Acquires EXCLUSIVE WRITE LOCK on row id=1
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>    [Row 1: balance=500, WRITE LOCKED by T1, uncommitted]
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>T2: BEGIN
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>T2: SELECT balance FROM account WHERE id = 1
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>    
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>    Tries to acquire SHARED READ LOCK
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>    
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    BLOCKED! (row has uncommitted write lock)
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>    
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>    [T2 WAITS...]
<a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>
<a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a>T1: COMMIT
<a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>    
<a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>    Releases EXCLUSIVE WRITE LOCK
<a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a>    [Row 1: balance=500, COMMITTED, unlocked]
<a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a>
<a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a>T2: [UNBLOCKED]
<a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a>    
<a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a>    Acquires SHARED READ LOCK
<a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a>    Reads committed value: 500 
<a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a>    Immediately releases SHARED READ LOCK
<a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a>    
<a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a>    (lock released after read!)
<a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a>
<a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a>
<a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a>
<a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a>Key Point: T2 WAITED for T1 to commit (prevented dirty read)
<a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a>But: T2 released lock after read (allows non-repeatable read)
</code></pre></div>
<p><strong>Why Non-Repeatable Reads Still Happen:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>T1: BEGIN
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>T1: SELECT balance FROM account WHERE id = 1
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>    
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    Acquires SHARED READ LOCK
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    Reads: balance = 1000
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    Releases SHARED READ LOCK  Lock released!
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>T2: BEGIN
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>T2: UPDATE account SET balance = 500 WHERE id = 1
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>    
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>    Acquires EXCLUSIVE WRITE LOCK (allowed - no locks on row!)
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>    Updates balance to 500
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>T2: COMMIT
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>    Releases EXCLUSIVE WRITE LOCK
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>T1: SELECT balance FROM account WHERE id = 1
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>    
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>    Acquires SHARED READ LOCK (fresh lock)
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>    Reads: balance = 500  DIFFERENT VALUE!
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>    Releases SHARED READ LOCK
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a>
<a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a>Result: Non-repeatable read (same query, different result)
<a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>Cause: T1 didn&#39;t hold lock between reads
</code></pre></div>
<p><strong>How it Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>            READ COMMITTED - How it Works                
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>                                                         
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>   Acquires read locks, releases immediately after read 
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>   Only reads committed data                            
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>   Writes acquire locks until transaction commits       
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>   Multiple reads may see different values              
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>                                                         
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>  Transaction 1          Database          Transaction 2 
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>                                                         
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>  UPDATE x = 10          [x = 10]                        
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>  (not committed)        (uncommitted)                   
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>                                                        
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>                            X  BLOCKS  READ x           
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>                         (must wait)                     
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>  COMMIT                 [x = 10]                        
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>                         (committed)                     
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>                                                        
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>                             READ x = 10     
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>                                       (reads committed) 
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>                                                         
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>READ COMMITTED - Prevents Dirty Reads:
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a> T1: BEGIN                                            
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a> T1: UPDATE balance = 900                             
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>      (uncommitted)                                  
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>     [balance = 900]  UNCOMMITTED                    
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>                                                     
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>         &gt; T2: BEGIN                              
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>              T2: READ balance                       
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>               BLOCKED! (waits for T1)              
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a>              [waiting...]                           
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>                                                    
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a> T1: COMMIT                                           
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>     [balance = 900]  NOW COMMITTED                  
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>                                                     
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>         &gt; T2: READ balance = 900                
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a>               (reads committed value)                
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a>               T2: COMMIT                             
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a>                                                      
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a> No dirty read! T2 waited for commit.                 
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a>But allows Non-Repeatable Reads:
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a> T1: READ balance = 1000 (first read)                 
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a>                                                     
<a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a>     [balance = 1000]                                 
<a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a>                                                     
<a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a>          T2: UPDATE balance = 500                
<a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a>              T2: COMMIT                              
<a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a>     [balance = 500]  CHANGED!                       
<a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a>                                                     
<a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a> T1: READ balance = 500 (second read)                 
<a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a>     DIFFERENT!  NON-REPEATABLE READ                 
<a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a>
<a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a>
<a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a>Problems Allowed:
<a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a> Dirty Read        - NO (Prevented!)
<a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a> Non-Repeatable    - YES
<a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a> Phantom Read      - YES
</code></pre></div>
<p><strong>Pseudo Code:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1"># READ COMMITTED Example</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_committed_transaction</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrates READ COMMITTED behavior&quot;&quot;&quot;</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ COMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>    <span class="c1"># Read 1: Gets committed value</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First read: </span><span class="si">{</span><span class="n">balance1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># e.g., $1000</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>    <span class="c1"># If another transaction is updating this row:</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a>    <span class="c1"># - READ UNCOMMITTED: Would see uncommitted value</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>    <span class="c1"># - READ COMMITTED: Waits until other transaction commits/rollback</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Another transaction commits changes</span>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a>    <span class="c1"># Read 2: Might get different value (non-repeatable read)</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second read: </span><span class="si">{</span><span class="n">balance2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># e.g., $500 (DIFFERENT!)</span>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a>
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a>    <span class="c1"># Can&#39;t rely on consistent reads within transaction</span>
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a>    <span class="k">if</span> <span class="n">balance1</span> <span class="o">!=</span> <span class="n">balance2</span><span class="p">:</span>
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-repeatable read occurred!&quot;</span><span class="p">)</span>
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a>
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a>
<a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a>
<a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a><span class="c1"># Real-world use case: Banking transaction</span>
<a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Typical banking transaction with READ COMMITTED&quot;&quot;&quot;</span>
<a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ COMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a>
<a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a>        <span class="c1"># Read current balance (committed values only)</span>
<a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a>            <span class="s2">&quot;SELECT balance FROM accounts WHERE id = ? FOR UPDATE&quot;</span><span class="p">,</span>
<a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a>            <span class="p">[</span><span class="n">account_id</span><span class="p">]</span>
<a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a>        <span class="p">)</span>
<a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a>        <span class="n">balance</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a>
<a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a>        <span class="c1"># Check sufficient funds</span>
<a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a>        <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a>            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a>
<a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a>        <span class="c1"># Deduct amount</span>
<a id="__codelineno-40-52" name="__codelineno-40-52" href="#__codelineno-40-52"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-40-53" name="__codelineno-40-53" href="#__codelineno-40-53"></a>            <span class="s2">&quot;UPDATE accounts SET balance = balance - ? WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-40-54" name="__codelineno-40-54" href="#__codelineno-40-54"></a>            <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">account_id</span><span class="p">]</span>
<a id="__codelineno-40-55" name="__codelineno-40-55" href="#__codelineno-40-55"></a>        <span class="p">)</span>
<a id="__codelineno-40-56" name="__codelineno-40-56" href="#__codelineno-40-56"></a>
<a id="__codelineno-40-57" name="__codelineno-40-57" href="#__codelineno-40-57"></a>        <span class="c1"># Record transaction</span>
<a id="__codelineno-40-58" name="__codelineno-40-58" href="#__codelineno-40-58"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-40-59" name="__codelineno-40-59" href="#__codelineno-40-59"></a>            <span class="s2">&quot;INSERT INTO transactions (account_id, amount, type) VALUES (?, ?, &#39;debit&#39;)&quot;</span><span class="p">,</span>
<a id="__codelineno-40-60" name="__codelineno-40-60" href="#__codelineno-40-60"></a>            <span class="p">[</span><span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">]</span>
<a id="__codelineno-40-61" name="__codelineno-40-61" href="#__codelineno-40-61"></a>        <span class="p">)</span>
<a id="__codelineno-40-62" name="__codelineno-40-62" href="#__codelineno-40-62"></a>
<a id="__codelineno-40-63" name="__codelineno-40-63" href="#__codelineno-40-63"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-40-64" name="__codelineno-40-64" href="#__codelineno-40-64"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-40-65" name="__codelineno-40-65" href="#__codelineno-40-65"></a>
<a id="__codelineno-40-66" name="__codelineno-40-66" href="#__codelineno-40-66"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-40-67" name="__codelineno-40-67" href="#__codelineno-40-67"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-40-68" name="__codelineno-40-68" href="#__codelineno-40-68"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-40-69" name="__codelineno-40-69" href="#__codelineno-40-69"></a>
<a id="__codelineno-40-70" name="__codelineno-40-70" href="#__codelineno-40-70"></a>
<a id="__codelineno-40-71" name="__codelineno-40-71" href="#__codelineno-40-71"></a><span class="c1"># Handling non-repeatable reads</span>
<a id="__codelineno-40-72" name="__codelineno-40-72" href="#__codelineno-40-72"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_report_with_read_committed</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-40-73" name="__codelineno-40-73" href="#__codelineno-40-73"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Report generation - must handle non-repeatable reads&quot;&quot;&quot;</span>
<a id="__codelineno-40-74" name="__codelineno-40-74" href="#__codelineno-40-74"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;READ COMMITTED&quot;</span><span class="p">)</span>
<a id="__codelineno-40-75" name="__codelineno-40-75" href="#__codelineno-40-75"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-40-76" name="__codelineno-40-76" href="#__codelineno-40-76"></a>
<a id="__codelineno-40-77" name="__codelineno-40-77" href="#__codelineno-40-77"></a>    <span class="c1"># Strategy 1: Use single query to avoid inconsistency</span>
<a id="__codelineno-40-78" name="__codelineno-40-78" href="#__codelineno-40-78"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-79" name="__codelineno-40-79" href="#__codelineno-40-79"></a><span class="s2">        SELECT </span>
<a id="__codelineno-40-80" name="__codelineno-40-80" href="#__codelineno-40-80"></a><span class="s2">            COUNT(*) as total_orders,</span>
<a id="__codelineno-40-81" name="__codelineno-40-81" href="#__codelineno-40-81"></a><span class="s2">            SUM(amount) as total_revenue,</span>
<a id="__codelineno-40-82" name="__codelineno-40-82" href="#__codelineno-40-82"></a><span class="s2">            AVG(amount) as avg_order</span>
<a id="__codelineno-40-83" name="__codelineno-40-83" href="#__codelineno-40-83"></a><span class="s2">        FROM orders</span>
<a id="__codelineno-40-84" name="__codelineno-40-84" href="#__codelineno-40-84"></a><span class="s2">        WHERE created_date = CURRENT_DATE</span>
<a id="__codelineno-40-85" name="__codelineno-40-85" href="#__codelineno-40-85"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-40-86" name="__codelineno-40-86" href="#__codelineno-40-86"></a>
<a id="__codelineno-40-87" name="__codelineno-40-87" href="#__codelineno-40-87"></a>    <span class="c1"># All values from same snapshot (within single query)</span>
<a id="__codelineno-40-88" name="__codelineno-40-88" href="#__codelineno-40-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Orders: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Revenue: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, Avg: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-89" name="__codelineno-40-89" href="#__codelineno-40-89"></a>
<a id="__codelineno-40-90" name="__codelineno-40-90" href="#__codelineno-40-90"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p><strong>Advantages:</strong>
-  <strong>No dirty reads</strong> - only see committed data
-  <strong>Good balance</strong> - performance vs consistency
-  <strong>Default in most databases</strong> - well-tested and reliable
-  <strong>Sufficient for most use cases</strong> - OLTP applications</p>
<p><strong>Disadvantages:</strong>
-  <strong>Non-repeatable reads</strong> - same query, different results
-  <strong>Phantom reads</strong> - row counts can change
-  <strong>Not suitable for complex analytics</strong> - inconsistent aggregations</p>
<p><strong>When to Use:</strong>
- Default choice for most applications
- OLTP workloads (e.g., e-commerce, banking)
- Web applications
- When dirty reads are unacceptable but some inconsistency is OK</p>
<hr />
<h4 id="33-repeatable-read">3.3 Repeatable Read</h4>
<p><strong>Description:</strong></p>
<p>A <strong>stronger isolation level</strong> that guarantees once a transaction reads a row, all subsequent reads of that row within the same transaction will return the <strong>same value</strong>. The transaction gets a consistent view of the data it has read, even if other transactions modify and commit changes to those rows concurrently.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li><strong>Consistent row-level reads</strong> - same row always returns same value within a transaction</li>
<li><strong>Long-duration read locks</strong> - held until transaction commits (not just during read)</li>
<li><strong>Prevents dirty and non-repeatable reads</strong> - data you've read cannot change</li>
<li><strong>Still allows phantom reads</strong> - NEW rows can appear in range queries</li>
<li><strong>Default in MySQL InnoDB</strong> - well-suited for financial applications</li>
<li><strong>Higher lock overhead</strong> - more blocking, potential for deadlocks</li>
</ul>
<p><strong>Locking Strategy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>     REPEATABLE READ - Locking Strategy                  
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>                                                         
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a> READ Operations:                                        
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>          
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>   Acquires SHARED READ LOCKS                        
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>   Holds locks until COMMIT/ROLLBACK                 
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>   Locks ALL rows read                               
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>   Prevents other transactions from                  
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>    modifying locked rows                             
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>   Does NOT lock &quot;gaps&quot; or ranges                    
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>          
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>                                                         
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a> WRITE Operations:                                       
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>          
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a>   Acquires EXCLUSIVE WRITE LOCKS                    
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>   Holds locks until COMMIT/ROLLBACK                 
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>   Blocks ALL conflicting operations                 
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>   Prevents lost updates                             
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>          
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>                                                         
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a> Lock Compatibility Matrix:                              
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a>                    
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a>               Read      Write                      
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a>                    
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a>  Read                          (blocks)          
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>  Write                         (blocks)          
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a>                    
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a>                                                         
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a> Lock Duration Comparison:                               
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a>                                                         
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a> READ COMMITTED:                                         
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a> Transaction  Read row 1 (acquire lock)               
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a>              Release lock                            
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a>              Read row 2 (acquire lock)               
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a>              Release lock                            
<a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a>              COMMIT                                  
<a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a>                                                         
<a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a> REPEATABLE READ:                                        
<a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a> Transaction  Read row 1 (acquire lock)             
<a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a>              Read row 2 (acquire lock)             
<a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a>              ... (locks held)                    
<a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a>              COMMIT (release all)                
<a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a>                                                         
<a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a> Two Implementation Approaches:                          
<a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a>                                                         
<a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a> 1. Lock-Based (Traditional):                           
<a id="__codelineno-41-49" name="__codelineno-41-49" href="#__codelineno-41-49"></a>                
<a id="__codelineno-41-50" name="__codelineno-41-50" href="#__codelineno-41-50"></a>      Shared locks on all rows read                  
<a id="__codelineno-41-51" name="__codelineno-41-51" href="#__codelineno-41-51"></a>      Locks held until commit                        
<a id="__codelineno-41-52" name="__codelineno-41-52" href="#__codelineno-41-52"></a>      Blocks conflicting transactions                
<a id="__codelineno-41-53" name="__codelineno-41-53" href="#__codelineno-41-53"></a>      Can cause deadlocks                            
<a id="__codelineno-41-54" name="__codelineno-41-54" href="#__codelineno-41-54"></a>      Used by: SQL Server, DB2                       
<a id="__codelineno-41-55" name="__codelineno-41-55" href="#__codelineno-41-55"></a>                
<a id="__codelineno-41-56" name="__codelineno-41-56" href="#__codelineno-41-56"></a>                                                         
<a id="__codelineno-41-57" name="__codelineno-41-57" href="#__codelineno-41-57"></a> 2. MVCC-Based (Modern):                                
<a id="__codelineno-41-58" name="__codelineno-41-58" href="#__codelineno-41-58"></a>                
<a id="__codelineno-41-59" name="__codelineno-41-59" href="#__codelineno-41-59"></a>      Snapshot at transaction start                  
<a id="__codelineno-41-60" name="__codelineno-41-60" href="#__codelineno-41-60"></a>      No locks for reads (!)                         
<a id="__codelineno-41-61" name="__codelineno-41-61" href="#__codelineno-41-61"></a>      Reads never block writes                       
<a id="__codelineno-41-62" name="__codelineno-41-62" href="#__codelineno-41-62"></a>      Writes never block reads                       
<a id="__codelineno-41-63" name="__codelineno-41-63" href="#__codelineno-41-63"></a>      Uses version chains                            
<a id="__codelineno-41-64" name="__codelineno-41-64" href="#__codelineno-41-64"></a>      Used by: MySQL InnoDB, PostgreSQL              
<a id="__codelineno-41-65" name="__codelineno-41-65" href="#__codelineno-41-65"></a>                
<a id="__codelineno-41-66" name="__codelineno-41-66" href="#__codelineno-41-66"></a>                                                         
<a id="__codelineno-41-67" name="__codelineno-41-67" href="#__codelineno-41-67"></a> Phantom Reads - Why Still Possible:                    
<a id="__codelineno-41-68" name="__codelineno-41-68" href="#__codelineno-41-68"></a>          
<a id="__codelineno-41-69" name="__codelineno-41-69" href="#__codelineno-41-69"></a>  Locks acquired:  Individual ROWS                    
<a id="__codelineno-41-70" name="__codelineno-41-70" href="#__codelineno-41-70"></a>  Locks NOT on:    RANGES or GAPS                     
<a id="__codelineno-41-71" name="__codelineno-41-71" href="#__codelineno-41-71"></a>                                                      
<a id="__codelineno-41-72" name="__codelineno-41-72" href="#__codelineno-41-72"></a>  T1 reads rows: [A, B, C]  Locked                  
<a id="__codelineno-41-73" name="__codelineno-41-73" href="#__codelineno-41-73"></a>                                                      
<a id="__codelineno-41-74" name="__codelineno-41-74" href="#__codelineno-41-74"></a>  T2 inserts:    [D]  NOT blocked!                  
<a id="__codelineno-41-75" name="__codelineno-41-75" href="#__codelineno-41-75"></a>  (D not locked because didn&#39;t exist)                 
<a id="__codelineno-41-76" name="__codelineno-41-76" href="#__codelineno-41-76"></a>                                                      
<a id="__codelineno-41-77" name="__codelineno-41-77" href="#__codelineno-41-77"></a>  T1 re-reads:   [A, B, C, D]  PHANTOM!             
<a id="__codelineno-41-78" name="__codelineno-41-78" href="#__codelineno-41-78"></a>          
<a id="__codelineno-41-79" name="__codelineno-41-79" href="#__codelineno-41-79"></a>                                                         
<a id="__codelineno-41-80" name="__codelineno-41-80" href="#__codelineno-41-80"></a>
</code></pre></div>
<p><strong>How Locking Works (Lock-Based):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>Scenario: Traditional lock-based REPEATABLE READ
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>T1: BEGIN
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>T1: SELECT * FROM accounts WHERE id IN (1, 2, 3)
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>    
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>    Acquires SHARED LOCKS on rows 1, 2, 3
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>    [Row 1: SHARED LOCKED by T1] 
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>    [Row 2: SHARED LOCKED by T1] 
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>    [Row 3: SHARED LOCKED by T1] 
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>    Reads: [row1, row2, row3]
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>    Locks HELD (not released!)
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>T2: BEGIN
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>T2: UPDATE accounts SET balance = 500 WHERE id = 2
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>    
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>    Tries to acquire EXCLUSIVE WRITE LOCK on row 2
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>    
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>    BLOCKED! (T1 holds shared lock on row 2)
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>    
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a>    [T2 WAITS...]
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a>T1: SELECT * FROM accounts WHERE id IN (1, 2, 3)
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>    
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a>    Uses existing SHARED LOCKS (already held)
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>    Reads: [row1, row2, row3]  SAME VALUES!
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a>    Locks STILL HELD 
<a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a>
<a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a>T1: COMMIT
<a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a>    
<a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a>    Releases all SHARED LOCKS 
<a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a>
<a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a>T2: [UNBLOCKED]
<a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a>    
<a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a>    Acquires EXCLUSIVE WRITE LOCK on row 2
<a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a>    Updates row 2
<a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a>T2: COMMIT
<a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a>
<a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a>
<a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a>Result: T1 saw consistent values (no non-repeatable reads)
<a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a>Cause: Shared locks held for entire transaction duration
</code></pre></div>
<p><strong>How MVCC Works (MySQL InnoDB):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>Scenario: MVCC-based REPEATABLE READ (MySQL InnoDB)
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>Database maintains multiple versions of each row:
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>[Row 1: balance=1000, version=100, txn_id=50]
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>T1: BEGIN (assigned txn_id=100)
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>    
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>    Creates SNAPSHOT at txn_id=100
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>    [Snapshot: sees all data committed before txn_id=100]
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>T1: SELECT balance FROM accounts WHERE id = 1
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>    
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>    Reads using snapshot (txn_id=100)
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>    Finds version: balance=1000 (from txn_id=50)
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>    Returns: 1000
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>    
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>    NO LOCKS ACQUIRED! 
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>T2: BEGIN (assigned txn_id=101)
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>T2: UPDATE accounts SET balance = 500 WHERE id = 1
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>    
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>    Creates NEW version of row 1
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a>    [Row 1: balance=500, version=101, txn_id=101]  NEW
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a>    [Row 1: balance=1000, version=100, txn_id=50]  OLD (kept!)
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>T2: COMMIT
<a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a>
<a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a>T1: SELECT balance FROM accounts WHERE id = 1
<a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a>    
<a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a>    Still uses snapshot (txn_id=100)
<a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a>    Ignores version 101 (created after snapshot)
<a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a>    Reads version 100: balance=1000  SAME VALUE!
<a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a>    
<a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a>    NO LOCKS, NO WAITING! 
<a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a>
<a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a>T1: COMMIT
<a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>    
<a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a>    Snapshot discarded
<a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a>
<a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a>
<a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a>Advantages of MVCC approach:
<a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a> No read locks needed
<a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a> Readers don&#39;t block writers
<a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a> Writers don&#39;t block readers
<a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a> Better concurrency
<a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a> No deadlocks from read locks
</code></pre></div>
<p><strong>Phantom Reads Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>Why phantoms still occur (even with row locks):
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>T1: BEGIN
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>T1: SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    Finds rows: [order_1, order_2, order_3]
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    Locks these 3 rows: 
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>    Returns: COUNT = 3
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>T2: BEGIN
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>T2: INSERT INTO orders (status) VALUES (&#39;pending&#39;)
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>    
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>    Creates new row: [order_4]
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>    
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>    NOT BLOCKED! (order_4 wasn&#39;t locked by T1)
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>    
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>    SUCCESS 
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>T2: COMMIT
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>    [order_4 now exists and committed]
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>T1: SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>    
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>    Finds rows: [order_1, order_2, order_3, order_4]
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>    Still holds locks on first 3: 
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>    But sees new row order_4 (not locked)
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>    Returns: COUNT = 4  PHANTOM!
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>Problem: REPEATABLE READ locks ROWS, not RANGES
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>Solution: Use SERIALIZABLE (locks ranges/gaps)
</code></pre></div>
<p><strong>How it Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>           REPEATABLE READ - How it Works                
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>                                                         
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>   Acquires read locks on rows read                     
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>   Holds read locks until transaction ends              
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>   Same row always returns same value                   
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>   New rows can still appear (phantoms)                 
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>                                                         
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>  Transaction 1          Database          Transaction 2 
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a>                                                         
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a>  READ x = 5             [x = 5]                         
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>  (acquires lock)   LOCKED                       
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>                                                        
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>                                  UPDATE x = 10         
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a>                                      BLOCKED!         
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>                                  [waiting...]          
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a>  READ x = 5            [x = 5]                         
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>  (same value!)           STILL LOCKED                  
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a>                                                        
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>  COMMIT   UNLOCKED                    
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a>  (releases lock)                                       
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>                         [x = 10]  T2 can now update    
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a>                                                         
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a>
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>REPEATABLE READ - Consistent Row Reads:
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a> T1: BEGIN                                            
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a> T1: READ row with id=1 (balance=1000)                
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>                                                     
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>     [id=1, balance=1000]  LOCKED for T1            
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>                                                     
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>         &gt; T2: UPDATE id=1, balance=500            
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>              BLOCKED! (can&#39;t modify locked row)   
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>             [waiting for T1 to commit...]           
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>                                                    
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a> T1: READ row with id=1 (balance=1000)               
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>     SAME VALUE!  REPEATABLE READ                    
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>                                                     
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a> T1: COMMIT                                           
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>      UNLOCKED                                       
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>                                                     
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>         &gt; T2: UPDATE completes                    
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a>              [id=1, balance=500]                     
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>              T2: COMMIT                              
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a>
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a>
<a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a>But allows Phantom Reads (new rows):
<a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a>
<a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a>
<a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a> T1: SELECT COUNT(*) WHERE status=&#39;pending&#39;           
<a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a>      Returns 10 (locks these 10 rows)               
<a id="__codelineno-46-29" name="__codelineno-46-29" href="#__codelineno-46-29"></a>                                                     
<a id="__codelineno-46-30" name="__codelineno-46-30" href="#__codelineno-46-30"></a>          T2: INSERT new row (status=&#39;pending&#39;)   
<a id="__codelineno-46-31" name="__codelineno-46-31" href="#__codelineno-46-31"></a>              T2: COMMIT  (allowed!)                 
<a id="__codelineno-46-32" name="__codelineno-46-32" href="#__codelineno-46-32"></a>                                                     
<a id="__codelineno-46-33" name="__codelineno-46-33" href="#__codelineno-46-33"></a> T1: SELECT COUNT(*) WHERE status=&#39;pending&#39;           
<a id="__codelineno-46-34" name="__codelineno-46-34" href="#__codelineno-46-34"></a>      Returns 11  PHANTOM READ!                     
<a id="__codelineno-46-35" name="__codelineno-46-35" href="#__codelineno-46-35"></a>                                                      
<a id="__codelineno-46-36" name="__codelineno-46-36" href="#__codelineno-46-36"></a> Existing rows: LOCKED (repeatable)                   
<a id="__codelineno-46-37" name="__codelineno-46-37" href="#__codelineno-46-37"></a> New rows: NOT LOCKED (can be inserted)               
<a id="__codelineno-46-38" name="__codelineno-46-38" href="#__codelineno-46-38"></a>
<a id="__codelineno-46-39" name="__codelineno-46-39" href="#__codelineno-46-39"></a>
<a id="__codelineno-46-40" name="__codelineno-46-40" href="#__codelineno-46-40"></a>Problems Allowed:
<a id="__codelineno-46-41" name="__codelineno-46-41" href="#__codelineno-46-41"></a> Dirty Read        - NO
<a id="__codelineno-46-42" name="__codelineno-46-42" href="#__codelineno-46-42"></a> Non-Repeatable    - NO
<a id="__codelineno-46-43" name="__codelineno-46-43" href="#__codelineno-46-43"></a> Phantom Read      - YES
</code></pre></div>
<p><strong>Pseudo Code:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1"># REPEATABLE READ Example</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">repeatable_read_transaction</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrates REPEATABLE READ behavior&quot;&quot;&quot;</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>    <span class="c1"># First read</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>    <span class="n">balance1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First read: </span><span class="si">{</span><span class="n">balance1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $1000</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>    <span class="c1"># This row is now locked for the duration of this transaction</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>    <span class="c1"># Other transactions can&#39;t modify it</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Other transactions try to update but are blocked</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a>    <span class="c1"># Second read - GUARANTEED to return same value</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>    <span class="n">balance2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a>        <span class="s2">&quot;SELECT balance FROM accounts WHERE id = 1&quot;</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second read: </span><span class="si">{</span><span class="n">balance2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># $1000 (SAME!)</span>
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a>    <span class="k">assert</span> <span class="n">balance1</span> <span class="o">==</span> <span class="n">balance2</span>  <span class="c1"># Always true!</span>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a>
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Now other transactions can proceed</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a>
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a><span class="c1"># Real-world use: Multi-step calculation</span>
<a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_account_interest</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">):</span>
<a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate interest - needs consistent balance&quot;&quot;&quot;</span>
<a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a>
<a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a>        <span class="c1"># Read balance (locks the row)</span>
<a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a>        <span class="n">balance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a>            <span class="s2">&quot;SELECT balance FROM accounts WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a>            <span class="p">[</span><span class="n">account_id</span><span class="p">]</span>
<a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a>        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a>
<a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a>        <span class="c1"># Complex calculation (takes time)</span>
<a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a>        <span class="n">monthly_rate</span> <span class="o">=</span> <span class="n">get_interest_rate</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>  <span class="c1"># External call</span>
<a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a>        <span class="n">interest</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">*</span> <span class="n">monthly_rate</span>
<a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a>
<a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate processing</span>
<a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a>
<a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a>        <span class="c1"># Read balance again - GUARANTEED same value</span>
<a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a>        <span class="c1"># Even if we need to re-read for verification</span>
<a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a>        <span class="n">balance_verify</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a>            <span class="s2">&quot;SELECT balance FROM accounts WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a>            <span class="p">[</span><span class="n">account_id</span><span class="p">]</span>
<a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a>        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a>
<a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a>        <span class="k">assert</span> <span class="n">balance</span> <span class="o">==</span> <span class="n">balance_verify</span>  <span class="c1"># Always passes!</span>
<a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a>
<a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a>        <span class="c1"># Apply interest</span>
<a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a>        <span class="n">new_balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">interest</span>
<a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a>            <span class="s2">&quot;UPDATE accounts SET balance = ? WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a>            <span class="p">[</span><span class="n">new_balance</span><span class="p">,</span> <span class="n">account_id</span><span class="p">]</span>
<a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a>        <span class="p">)</span>
<a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a>
<a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a>        <span class="k">return</span> <span class="n">interest</span>
<a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a>
<a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a>        <span class="k">raise</span>
<a id="__codelineno-47-71" name="__codelineno-47-71" href="#__codelineno-47-71"></a>
<a id="__codelineno-47-72" name="__codelineno-47-72" href="#__codelineno-47-72"></a>
<a id="__codelineno-47-73" name="__codelineno-47-73" href="#__codelineno-47-73"></a><span class="c1"># Phantom read example (still possible!)</span>
<a id="__codelineno-47-74" name="__codelineno-47-74" href="#__codelineno-47-74"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_pending_orders</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-47-75" name="__codelineno-47-75" href="#__codelineno-47-75"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrates phantom reads in REPEATABLE READ&quot;&quot;&quot;</span>
<a id="__codelineno-47-76" name="__codelineno-47-76" href="#__codelineno-47-76"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-47-77" name="__codelineno-47-77" href="#__codelineno-47-77"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-47-78" name="__codelineno-47-78" href="#__codelineno-47-78"></a>
<a id="__codelineno-47-79" name="__codelineno-47-79" href="#__codelineno-47-79"></a>    <span class="c1"># First count</span>
<a id="__codelineno-47-80" name="__codelineno-47-80" href="#__codelineno-47-80"></a>    <span class="n">count1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-81" name="__codelineno-47-81" href="#__codelineno-47-81"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-47-82" name="__codelineno-47-82" href="#__codelineno-47-82"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-83" name="__codelineno-47-83" href="#__codelineno-47-83"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First count: </span><span class="si">{</span><span class="n">count1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 100</span>
<a id="__codelineno-47-84" name="__codelineno-47-84" href="#__codelineno-47-84"></a>
<a id="__codelineno-47-85" name="__codelineno-47-85" href="#__codelineno-47-85"></a>    <span class="c1"># Existing rows are locked, but NEW rows can be inserted</span>
<a id="__codelineno-47-86" name="__codelineno-47-86" href="#__codelineno-47-86"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Another transaction inserts new orders</span>
<a id="__codelineno-47-87" name="__codelineno-47-87" href="#__codelineno-47-87"></a>
<a id="__codelineno-47-88" name="__codelineno-47-88" href="#__codelineno-47-88"></a>    <span class="c1"># Second count - MAY BE DIFFERENT (phantom!)</span>
<a id="__codelineno-47-89" name="__codelineno-47-89" href="#__codelineno-47-89"></a>    <span class="n">count2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-90" name="__codelineno-47-90" href="#__codelineno-47-90"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-47-91" name="__codelineno-47-91" href="#__codelineno-47-91"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-92" name="__codelineno-47-92" href="#__codelineno-47-92"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second count: </span><span class="si">{</span><span class="n">count2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 105 (PHANTOMS!)</span>
<a id="__codelineno-47-93" name="__codelineno-47-93" href="#__codelineno-47-93"></a>
<a id="__codelineno-47-94" name="__codelineno-47-94" href="#__codelineno-47-94"></a>    <span class="c1"># Individual existing rows are repeatable,</span>
<a id="__codelineno-47-95" name="__codelineno-47-95" href="#__codelineno-47-95"></a>    <span class="c1"># but count can change due to inserts</span>
<a id="__codelineno-47-96" name="__codelineno-47-96" href="#__codelineno-47-96"></a>
<a id="__codelineno-47-97" name="__codelineno-47-97" href="#__codelineno-47-97"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-47-98" name="__codelineno-47-98" href="#__codelineno-47-98"></a>
<a id="__codelineno-47-99" name="__codelineno-47-99" href="#__codelineno-47-99"></a>
<a id="__codelineno-47-100" name="__codelineno-47-100" href="#__codelineno-47-100"></a><span class="c1"># MySQL/InnoDB specific: Uses snapshot isolation (no phantoms!)</span>
<a id="__codelineno-47-101" name="__codelineno-47-101" href="#__codelineno-47-101"></a><span class="k">def</span><span class="w"> </span><span class="nf">mysql_repeatable_read</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-47-102" name="__codelineno-47-102" href="#__codelineno-47-102"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;MySQL REPEATABLE READ prevents phantoms too!&quot;&quot;&quot;</span>
<a id="__codelineno-47-103" name="__codelineno-47-103" href="#__codelineno-47-103"></a>    <span class="c1"># MySQL InnoDB uses MVCC (snapshot isolation)</span>
<a id="__codelineno-47-104" name="__codelineno-47-104" href="#__codelineno-47-104"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
<a id="__codelineno-47-105" name="__codelineno-47-105" href="#__codelineno-47-105"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-47-106" name="__codelineno-47-106" href="#__codelineno-47-106"></a>
<a id="__codelineno-47-107" name="__codelineno-47-107" href="#__codelineno-47-107"></a>    <span class="c1"># Creates a snapshot of database</span>
<a id="__codelineno-47-108" name="__codelineno-47-108" href="#__codelineno-47-108"></a>    <span class="n">count1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-109" name="__codelineno-47-109" href="#__codelineno-47-109"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-47-110" name="__codelineno-47-110" href="#__codelineno-47-110"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-111" name="__codelineno-47-111" href="#__codelineno-47-111"></a>
<a id="__codelineno-47-112" name="__codelineno-47-112" href="#__codelineno-47-112"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Other transactions insert rows</span>
<a id="__codelineno-47-113" name="__codelineno-47-113" href="#__codelineno-47-113"></a>
<a id="__codelineno-47-114" name="__codelineno-47-114" href="#__codelineno-47-114"></a>    <span class="c1"># In MySQL: Still sees same count (no phantoms!)</span>
<a id="__codelineno-47-115" name="__codelineno-47-115" href="#__codelineno-47-115"></a>    <span class="n">count2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-47-116" name="__codelineno-47-116" href="#__codelineno-47-116"></a>        <span class="s2">&quot;SELECT COUNT(*) FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-47-117" name="__codelineno-47-117" href="#__codelineno-47-117"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-47-118" name="__codelineno-47-118" href="#__codelineno-47-118"></a>
<a id="__codelineno-47-119" name="__codelineno-47-119" href="#__codelineno-47-119"></a>    <span class="k">assert</span> <span class="n">count1</span> <span class="o">==</span> <span class="n">count2</span>  <span class="c1"># True in MySQL!</span>
<a id="__codelineno-47-120" name="__codelineno-47-120" href="#__codelineno-47-120"></a>
<a id="__codelineno-47-121" name="__codelineno-47-121" href="#__codelineno-47-121"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p><strong>Advantages:</strong>
-  <strong>Consistent row reads</strong> - same row, same value
-  <strong>No dirty reads</strong> - only committed data
-  <strong>No non-repeatable reads</strong> - values don't change
-  <strong>Good for complex calculations</strong> - can rely on data
-  <strong>Default in MySQL</strong> - well-supported</p>
<p><strong>Disadvantages:</strong>
-  <strong>Still allows phantom reads</strong> - counts can change
-  <strong>More locking</strong> - reduced concurrency
-  <strong>Potential deadlocks</strong> - transactions hold locks longer
-  <strong>Performance impact</strong> - blocking other transactions</p>
<p><strong>When to Use:</strong>
- Financial calculations requiring consistent values
- Multi-step transactions that re-read data
- Reports that need stable row values
- When non-repeatable reads are unacceptable</p>
<hr />
<h4 id="34-serializable">3.4 Serializable</h4>
<p><strong>Description:</strong></p>
<p>The <strong>strictest and strongest isolation level</strong>, providing <strong>complete isolation</strong> between concurrent transactions. At this level, transactions execute as if they were running <strong>serially</strong> (one after another in sequence), even though they may actually be running concurrently. This guarantees <strong>perfect consistency</strong> and prevents all concurrency anomalies.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li><strong>Complete isolation</strong> - transactions appear to run one at a time</li>
<li><strong>Range/predicate locks</strong> - locks not just rows, but ranges and gaps</li>
<li><strong>No anomalies</strong> - prevents dirty, non-repeatable, and phantom reads</li>
<li><strong>Lowest concurrency</strong> - significant blocking and waiting</li>
<li><strong>Serialization failures</strong> - transactions may abort due to conflicts</li>
<li><strong>Perfect correctness</strong> - simplest consistency model for developers</li>
<li><strong>Performance cost</strong> - highest overhead, slowest throughput</li>
</ul>
<p><strong>Locking Strategy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>       SERIALIZABLE - Locking Strategy                   
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>                                                         
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a> READ Operations:                                        
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>          
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>   Acquires SHARED RANGE/PREDICATE LOCKS             
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>   Locks rows AND gaps between rows                  
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>   Holds locks until COMMIT/ROLLBACK                 
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>   Prevents inserts in locked ranges                 
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>   Blocks conflicting operations                     
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>          
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>                                                         
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a> WRITE Operations:                                       
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>          
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>   Acquires EXCLUSIVE RANGE LOCKS                    
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>   Locks entire affected ranges                      
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>   Holds locks until COMMIT/ROLLBACK                 
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>   Blocks ALL conflicting operations                 
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>   Prevents any concurrent modifications             
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>          
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>                                                         
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a> Lock Types Used:                                        
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>                                                         
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a> 1. Row Locks (X or S):                                 
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>     Lock individual existing rows                     
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>                                                         
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a> 2. Gap Locks:                                          
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>     Lock spaces BETWEEN rows                          
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a>     Prevent inserts in gaps                           
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>                                                         
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a> 3. Next-Key Locks (Row + Gap):                         
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>     Lock row + gap before it                          
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a>     MySQL InnoDB&#39;s approach                           
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a>                                                         
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a> 4. Predicate Locks:                                    
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a>     Lock based on query predicates                    
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a>     PostgreSQL SSI approach                           
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a>                                                         
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a> Lock Compatibility Matrix:                              
<a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a>         
<a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a>               Read      Write     Insert          
<a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a>         
<a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a>  Read                                          
<a id="__codelineno-48-45" name="__codelineno-48-45" href="#__codelineno-48-45"></a>  Write                                         
<a id="__codelineno-48-46" name="__codelineno-48-46" href="#__codelineno-48-46"></a>  Insert                                        
<a id="__codelineno-48-47" name="__codelineno-48-47" href="#__codelineno-48-47"></a>         
<a id="__codelineno-48-48" name="__codelineno-48-48" href="#__codelineno-48-48"></a>                                                         
<a id="__codelineno-48-49" name="__codelineno-48-49" href="#__codelineno-48-49"></a> Three Main Implementation Approaches:                   
<a id="__codelineno-48-50" name="__codelineno-48-50" href="#__codelineno-48-50"></a>                                                         
<a id="__codelineno-48-51" name="__codelineno-48-51" href="#__codelineno-48-51"></a> 1. Two-Phase Locking (2PL) - Traditional:              
<a id="__codelineno-48-52" name="__codelineno-48-52" href="#__codelineno-48-52"></a>            
<a id="__codelineno-48-53" name="__codelineno-48-53" href="#__codelineno-48-53"></a>      Acquire all locks before releasing any         
<a id="__codelineno-48-54" name="__codelineno-48-54" href="#__codelineno-48-54"></a>      Growing phase: acquire locks                   
<a id="__codelineno-48-55" name="__codelineno-48-55" href="#__codelineno-48-55"></a>      Shrinking phase: release locks                 
<a id="__codelineno-48-56" name="__codelineno-48-56" href="#__codelineno-48-56"></a>      Locks rows + ranges + gaps                     
<a id="__codelineno-48-57" name="__codelineno-48-57" href="#__codelineno-48-57"></a>      Heavy blocking, many waits                     
<a id="__codelineno-48-58" name="__codelineno-48-58" href="#__codelineno-48-58"></a>      Risk of deadlocks                              
<a id="__codelineno-48-59" name="__codelineno-48-59" href="#__codelineno-48-59"></a>      Used by: SQL Server, MySQL                     
<a id="__codelineno-48-60" name="__codelineno-48-60" href="#__codelineno-48-60"></a>            
<a id="__codelineno-48-61" name="__codelineno-48-61" href="#__codelineno-48-61"></a>                                                         
<a id="__codelineno-48-62" name="__codelineno-48-62" href="#__codelineno-48-62"></a> 2. Serializable Snapshot Isolation (SSI) - Modern:     
<a id="__codelineno-48-63" name="__codelineno-48-63" href="#__codelineno-48-63"></a>            
<a id="__codelineno-48-64" name="__codelineno-48-64" href="#__codelineno-48-64"></a>      MVCC-based (no read locks!)                    
<a id="__codelineno-48-65" name="__codelineno-48-65" href="#__codelineno-48-65"></a>      Detect conflicts instead of prevent            
<a id="__codelineno-48-66" name="__codelineno-48-66" href="#__codelineno-48-66"></a>      Track read/write dependencies                  
<a id="__codelineno-48-67" name="__codelineno-48-67" href="#__codelineno-48-67"></a>      Abort transactions on conflicts                
<a id="__codelineno-48-68" name="__codelineno-48-68" href="#__codelineno-48-68"></a>      Better concurrency than locking                
<a id="__codelineno-48-69" name="__codelineno-48-69" href="#__codelineno-48-69"></a>      Requires retry logic                           
<a id="__codelineno-48-70" name="__codelineno-48-70" href="#__codelineno-48-70"></a>      Used by: PostgreSQL                            
<a id="__codelineno-48-71" name="__codelineno-48-71" href="#__codelineno-48-71"></a>            
<a id="__codelineno-48-72" name="__codelineno-48-72" href="#__codelineno-48-72"></a>                                                         
<a id="__codelineno-48-73" name="__codelineno-48-73" href="#__codelineno-48-73"></a> 3. Optimistic Concurrency Control (OCC):               
<a id="__codelineno-48-74" name="__codelineno-48-74" href="#__codelineno-48-74"></a>            
<a id="__codelineno-48-75" name="__codelineno-48-75" href="#__codelineno-48-75"></a>      No locks during execution                      
<a id="__codelineno-48-76" name="__codelineno-48-76" href="#__codelineno-48-76"></a>      Validate at commit time                        
<a id="__codelineno-48-77" name="__codelineno-48-77" href="#__codelineno-48-77"></a>      Abort if conflicts detected                    
<a id="__codelineno-48-78" name="__codelineno-48-78" href="#__codelineno-48-78"></a>      Good for low-contention workloads              
<a id="__codelineno-48-79" name="__codelineno-48-79" href="#__codelineno-48-79"></a>      Poor for high-contention                       
<a id="__codelineno-48-80" name="__codelineno-48-80" href="#__codelineno-48-80"></a>      Used by: Some in-memory databases              
<a id="__codelineno-48-81" name="__codelineno-48-81" href="#__codelineno-48-81"></a>            
<a id="__codelineno-48-82" name="__codelineno-48-82" href="#__codelineno-48-82"></a>                                                         
<a id="__codelineno-48-83" name="__codelineno-48-83" href="#__codelineno-48-83"></a>
</code></pre></div>
<p><strong>How Range Locking Works (MySQL InnoDB):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>Scenario: Preventing phantom reads with gap locks
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>Index on &#39;age&#39; column: [20, 25, 30, 35, 40]
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>                                     
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>Gaps:            (-,20] (20,25] (25,30] (30,35] (35,40] (40,+)
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>T1: BEGIN
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>T1: SELECT * FROM users WHERE age &gt; 25
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>    
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>    Locks acquired:
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>     Row lock on age=30: 
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>     Gap lock (25, 30]:   (prevents insert age=26-29)
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>     Row lock on age=35: 
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>     Gap lock (30, 35]:   (prevents insert age=31-34)
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>     Row lock on age=40: 
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a>     Gap lock (35, 40]:   (prevents insert age=36-39)
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>     Gap lock (40, +):   (prevents insert age&gt;40)
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a>    Result: Entire range age&gt;25 is LOCKED!
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>T2: BEGIN
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>T2: INSERT INTO users (age) VALUES (28)
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a>    
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a>    Value 28 falls in gap (25, 30]
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>    
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a>    BLOCKED! (gap is locked by T1)
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a>    
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>    [T2 WAITS...]
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>T2: INSERT INTO users (age) VALUES (50)
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>    
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>    Value 50 falls in gap (40, +)
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>    
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a>    BLOCKED! (gap is locked by T1)
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a>    
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>    [T2 WAITS...]
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a>T1: SELECT * FROM users WHERE age &gt; 25
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a>    
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a>    Returns same rows as before 
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a>    NO PHANTOMS! (inserts were blocked)
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a>T1: COMMIT
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a>    
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a>    Releases all row and gap locks 
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a>T2: [UNBLOCKED]
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a>    
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a>    Inserts complete
<a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a>T2: COMMIT
<a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a>
<a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a>
<a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a>Key: Gap locks prevent inserts in locked ranges
</code></pre></div>
<p><strong>How SSI Works (PostgreSQL):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>Scenario: Serializable Snapshot Isolation
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>PostgreSQL uses conflict detection, not locking!
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>T1: BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    Creates snapshot at time=100
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>    Tracks: read_set = {}, write_set = {}
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>T1: SELECT SUM(balance) FROM accounts WHERE type=&#39;savings&#39;
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>    
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>    Reads using snapshot (time=100)
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>    Tracks: read_set = {accounts WHERE type=&#39;savings&#39;}
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>    NO LOCKS! Just tracking 
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>    Returns: SUM = $10,000
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>T2: BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a>    
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>    Creates snapshot at time=101
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a>T2: INSERT INTO accounts (type, balance) VALUES (&#39;savings&#39;, 1000)
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a>    
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a>    Tracks: write_set = {new account, type=&#39;savings&#39;}
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a>    NO BLOCKING! Insert succeeds 
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a>T2: COMMIT (time=102)
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a>    
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a>    Success - no conflicts detected
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a>T1: SELECT SUM(balance) FROM accounts WHERE type=&#39;savings&#39;
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a>    
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a>    Still uses snapshot (time=100)
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a>    Returns: SUM = $10,000 (same as before)
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a>    
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a>    Conflict detected!
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a>    
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a>    T1&#39;s read_set overlaps with T2&#39;s write_set
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a>    (both involve accounts WHERE type=&#39;savings&#39;)
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a>    
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a>T1: COMMIT
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a>    
<a id="__codelineno-50-41" name="__codelineno-50-41" href="#__codelineno-50-41"></a>    ABORTED! SerializationFailure
<a id="__codelineno-50-42" name="__codelineno-50-42" href="#__codelineno-50-42"></a>    ERROR: could not serialize access due to read/write
<a id="__codelineno-50-43" name="__codelineno-50-43" href="#__codelineno-50-43"></a>           dependencies among transactions
<a id="__codelineno-50-44" name="__codelineno-50-44" href="#__codelineno-50-44"></a>
<a id="__codelineno-50-45" name="__codelineno-50-45" href="#__codelineno-50-45"></a>
<a id="__codelineno-50-46" name="__codelineno-50-46" href="#__codelineno-50-46"></a>Advantages of SSI:
<a id="__codelineno-50-47" name="__codelineno-50-47" href="#__codelineno-50-47"></a> No read locks (better concurrency)
<a id="__codelineno-50-48" name="__codelineno-50-48" href="#__codelineno-50-48"></a> Detects conflicts at commit time
<a id="__codelineno-50-49" name="__codelineno-50-49" href="#__codelineno-50-49"></a> Fewer deadlocks
<a id="__codelineno-50-50" name="__codelineno-50-50" href="#__codelineno-50-50"></a> Must implement retry logic
<a id="__codelineno-50-51" name="__codelineno-50-51" href="#__codelineno-50-51"></a>
<a id="__codelineno-50-52" name="__codelineno-50-52" href="#__codelineno-50-52"></a>Disadvantages:
<a id="__codelineno-50-53" name="__codelineno-50-53" href="#__codelineno-50-53"></a> Transactions can fail at commit
<a id="__codelineno-50-54" name="__codelineno-50-54" href="#__codelineno-50-54"></a> Need application-level retries
<a id="__codelineno-50-55" name="__codelineno-50-55" href="#__codelineno-50-55"></a> More complex for developers
</code></pre></div>
<p><strong>Lock Escalation and Performance:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>Scenario: Full table scan with SERIALIZABLE
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>Query: SELECT * FROM orders WHERE status = &#39;pending&#39;
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>If many rows match (e.g., 10,000 rows):
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a> Row-Level Locking:                          
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>  Acquire 10,000 row locks                  
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>  Acquire gaps between all rows             
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>  High memory overhead                      
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>  Slow lock acquisition                     
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>  May hit lock limit                        
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>          
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>    Lock Escalation
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>          
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a> Table-Level Locking:                        
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>  Acquire single table lock                 
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>  Blocks ALL access to table                
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>  Lower memory overhead                     
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>  Faster lock acquisition                   
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>  But worse concurrency!                    
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a>Databases decide when to escalate:
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a> SQL Server: After ~5000 locks
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a> MySQL: Based on memory pressure
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a> PostgreSQL: Generally avoids escalation
</code></pre></div>
<p><strong>Deadlock Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>Scenario: Classic deadlock with SERIALIZABLE
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>T1: BEGIN SERIALIZABLE
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>T1: SELECT * FROM accounts WHERE id = 1
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>    
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>    Locks row 1 + surrounding gaps: 
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>T2: BEGIN SERIALIZABLE
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>T2: SELECT * FROM accounts WHERE id = 2
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>    
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>    Locks row 2 + surrounding gaps: 
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>T1: UPDATE accounts SET balance = 500 WHERE id = 2
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>    
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>    Needs exclusive lock on row 2
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>    
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>    BLOCKED! (T2 holds lock)
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>    
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>    [T1 WAITS for T2...]
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>T2: UPDATE accounts SET balance = 500 WHERE id = 1
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a>    
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a>    Needs exclusive lock on row 1
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>    
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>    BLOCKED! (T1 holds lock)
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a>    
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a>    [T2 WAITS for T1...]
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a>
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a>     DEADLOCK! 
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a>
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a>Database detects cycle:
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a>T1  waits for  T2  waits for  T1
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a>
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a>Database chooses victim (usually T2):
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a>T2: ABORTED! (Deadlock victim)
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a>    ERROR: deadlock detected
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a>
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a>T1: [UNBLOCKED]
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a>    Update proceeds
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a>T1: COMMIT
<a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a>
<a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>
<a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a>Deadlock prevention strategies:
<a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a>1. Always acquire locks in same order
<a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a>2. Use timeouts
<a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a>3. Implement retry logic
<a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a>4. Keep transactions short
<a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a>5. Use lower isolation if acceptable
</code></pre></div>
<p><strong>How it Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>            SERIALIZABLE - How it Works                  
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>                                                         
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>   Acquires locks on rows AND ranges                    
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>   Holds all locks until transaction ends               
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>   Prevents inserts/deletes in queried ranges           
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>   Equivalent to serial execution                       
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>                                                         
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>  Transaction 1          Database          Transaction 2 
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>                                                         
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>  SELECT WHERE                                           
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>  price &gt; 100        [Range 100- LOCKED]               
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>  (locks range!)                               
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>                                                        
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>                             INSERT price=120           
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>                                 BLOCKED!              
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>                             [waiting...]               
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>  SELECT WHERE                                          
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>  price &gt; 100       [Same results]                     
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>  (no phantoms!)      STILL LOCKED                  
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>                                                        
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>  COMMIT   UNLOCKED                    
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>                                                        
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a>                      [price=120]  T2 can now insert    
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a>                                                         
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>
</code></pre></div>
<p><strong>Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>SERIALIZABLE - Complete Isolation:
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a> T1: BEGIN                                            
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a> T1: SELECT * WHERE age &gt; 25                          
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>      Returns [Alice, Bob, Carol]                    
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>                                                     
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>     [Range age&gt;25 LOCKED]                       
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>                                                     
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>         &gt; T2: INSERT (name=Dave, age=30)          
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>              BLOCKED! (in locked range)            
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>             [waiting for T1...]                     
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>                                                     
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>         &gt; T3: UPDATE age=26 WHERE name=Alice      
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>              BLOCKED! (row in locked range)        
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a>             [waiting for T1...]                     
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a>                                                    
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a> T1: SELECT * WHERE age &gt; 25                          
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>      Returns [Alice, Bob, Carol]                   
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a>     SAME RESULTS! (no phantoms, no changes)          
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>                                                     
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a> T1: COMMIT                                           
<a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>      UNLOCKED                                    
<a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a>                                                     
<a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a>         &gt; T2: INSERT completes                    
<a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a>         &gt; T3: UPDATE completes                    
<a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a>
<a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a>
<a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a>Serial Equivalence:
<a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a>
<a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a>Concurrent execution with SERIALIZABLE:
<a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a>
<a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a> T1  T2  T3                 
<a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a>                               
<a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a>                               
<a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a>                               
<a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a>                               
<a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a>  (interleaved but isolated)      
<a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a>
<a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a>
<a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a>Equivalent to serial execution:
<a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a>
<a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a> T1  T2  T3                     
<a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a> (one at a time)                  
<a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a>
<a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a>
<a id="__codelineno-54-47" name="__codelineno-54-47" href="#__codelineno-54-47"></a>Both produce SAME results!
<a id="__codelineno-54-48" name="__codelineno-54-48" href="#__codelineno-54-48"></a>
<a id="__codelineno-54-49" name="__codelineno-54-49" href="#__codelineno-54-49"></a>Problems Allowed:
<a id="__codelineno-54-50" name="__codelineno-54-50" href="#__codelineno-54-50"></a> Dirty Read        - NO
<a id="__codelineno-54-51" name="__codelineno-54-51" href="#__codelineno-54-51"></a> Non-Repeatable    - NO
<a id="__codelineno-54-52" name="__codelineno-54-52" href="#__codelineno-54-52"></a> Phantom Read      - NO
</code></pre></div>
<p><strong>Pseudo Code:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># SERIALIZABLE Example</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">serializable_transaction</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrates SERIALIZABLE behavior&quot;&quot;&quot;</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">)</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>    <span class="c1"># First query</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>    <span class="n">rows1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>        <span class="s2">&quot;SELECT * FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>    <span class="n">count1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows1</span><span class="p">)</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First query: </span><span class="si">{</span><span class="n">count1</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>    <span class="c1"># Range is now locked!</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>    <span class="c1"># - No inserts with status=&#39;pending&#39; allowed</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>    <span class="c1"># - No updates changing status to &#39;pending&#39; allowed</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>    <span class="c1"># - No deletes of rows with status=&#39;pending&#39; allowed</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Other transactions blocked</span>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a>    <span class="c1"># Second query - GUARANTEED same results</span>
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a>    <span class="n">rows2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a>        <span class="s2">&quot;SELECT * FROM orders WHERE status = &#39;pending&#39;&quot;</span>
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a>    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a>    <span class="n">count2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows2</span><span class="p">)</span>
<a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second query: </span><span class="si">{</span><span class="n">count2</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
<a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a>
<a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a>    <span class="k">assert</span> <span class="n">count1</span> <span class="o">==</span> <span class="n">count2</span>  <span class="c1"># Always true!</span>
<a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a>    <span class="k">assert</span> <span class="n">rows1</span> <span class="o">==</span> <span class="n">rows2</span>    <span class="c1"># Exact same rows!</span>
<a id="__codelineno-55-31" name="__codelineno-55-31" href="#__codelineno-55-31"></a>
<a id="__codelineno-55-32" name="__codelineno-55-32" href="#__codelineno-55-32"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Other transactions can now proceed</span>
<a id="__codelineno-55-33" name="__codelineno-55-33" href="#__codelineno-55-33"></a>
<a id="__codelineno-55-34" name="__codelineno-55-34" href="#__codelineno-55-34"></a>
<a id="__codelineno-55-35" name="__codelineno-55-35" href="#__codelineno-55-35"></a><span class="c1"># Financial report - requires complete accuracy</span>
<a id="__codelineno-55-36" name="__codelineno-55-36" href="#__codelineno-55-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_financial_report</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<a id="__codelineno-55-37" name="__codelineno-55-37" href="#__codelineno-55-37"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Critical financial report with SERIALIZABLE&quot;&quot;&quot;</span>
<a id="__codelineno-55-38" name="__codelineno-55-38" href="#__codelineno-55-38"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">)</span>
<a id="__codelineno-55-39" name="__codelineno-55-39" href="#__codelineno-55-39"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-55-40" name="__codelineno-55-40" href="#__codelineno-55-40"></a>
<a id="__codelineno-55-41" name="__codelineno-55-41" href="#__codelineno-55-41"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-55-42" name="__codelineno-55-42" href="#__codelineno-55-42"></a>        <span class="c1"># Get all transactions in date range</span>
<a id="__codelineno-55-43" name="__codelineno-55-43" href="#__codelineno-55-43"></a>        <span class="n">transactions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-55-44" name="__codelineno-55-44" href="#__codelineno-55-44"></a><span class="s2">            SELECT * FROM transactions</span>
<a id="__codelineno-55-45" name="__codelineno-55-45" href="#__codelineno-55-45"></a><span class="s2">            WHERE date BETWEEN ? AND ?</span>
<a id="__codelineno-55-46" name="__codelineno-55-46" href="#__codelineno-55-46"></a><span class="s2">            ORDER BY date</span>
<a id="__codelineno-55-47" name="__codelineno-55-47" href="#__codelineno-55-47"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-55-48" name="__codelineno-55-48" href="#__codelineno-55-48"></a>
<a id="__codelineno-55-49" name="__codelineno-55-49" href="#__codelineno-55-49"></a>        <span class="c1"># Calculate metrics</span>
<a id="__codelineno-55-50" name="__codelineno-55-50" href="#__codelineno-55-50"></a>        <span class="n">total_revenue</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-55-51" name="__codelineno-55-51" href="#__codelineno-55-51"></a><span class="s2">            SELECT SUM(amount) FROM transactions</span>
<a id="__codelineno-55-52" name="__codelineno-55-52" href="#__codelineno-55-52"></a><span class="s2">            WHERE date BETWEEN ? AND ? AND type = &#39;credit&#39;</span>
<a id="__codelineno-55-53" name="__codelineno-55-53" href="#__codelineno-55-53"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-55-54" name="__codelineno-55-54" href="#__codelineno-55-54"></a>
<a id="__codelineno-55-55" name="__codelineno-55-55" href="#__codelineno-55-55"></a>        <span class="n">total_expenses</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-55-56" name="__codelineno-55-56" href="#__codelineno-55-56"></a><span class="s2">            SELECT SUM(amount) FROM transactions</span>
<a id="__codelineno-55-57" name="__codelineno-55-57" href="#__codelineno-55-57"></a><span class="s2">            WHERE date BETWEEN ? AND ? AND type = &#39;debit&#39;</span>
<a id="__codelineno-55-58" name="__codelineno-55-58" href="#__codelineno-55-58"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-55-59" name="__codelineno-55-59" href="#__codelineno-55-59"></a>
<a id="__codelineno-55-60" name="__codelineno-55-60" href="#__codelineno-55-60"></a>        <span class="c1"># Count transactions</span>
<a id="__codelineno-55-61" name="__codelineno-55-61" href="#__codelineno-55-61"></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-55-62" name="__codelineno-55-62" href="#__codelineno-55-62"></a><span class="s2">            SELECT COUNT(*) FROM transactions</span>
<a id="__codelineno-55-63" name="__codelineno-55-63" href="#__codelineno-55-63"></a><span class="s2">            WHERE date BETWEEN ? AND ?</span>
<a id="__codelineno-55-64" name="__codelineno-55-64" href="#__codelineno-55-64"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-55-65" name="__codelineno-55-65" href="#__codelineno-55-65"></a>
<a id="__codelineno-55-66" name="__codelineno-55-66" href="#__codelineno-55-66"></a>        <span class="c1"># All queries see consistent snapshot</span>
<a id="__codelineno-55-67" name="__codelineno-55-67" href="#__codelineno-55-67"></a>        <span class="c1"># No new transactions can be inserted</span>
<a id="__codelineno-55-68" name="__codelineno-55-68" href="#__codelineno-55-68"></a>        <span class="c1"># No existing transactions can be modified</span>
<a id="__codelineno-55-69" name="__codelineno-55-69" href="#__codelineno-55-69"></a>        <span class="c1"># No transactions can be deleted</span>
<a id="__codelineno-55-70" name="__codelineno-55-70" href="#__codelineno-55-70"></a>
<a id="__codelineno-55-71" name="__codelineno-55-71" href="#__codelineno-55-71"></a>        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-55-72" name="__codelineno-55-72" href="#__codelineno-55-72"></a>            <span class="s1">&#39;transactions&#39;</span><span class="p">:</span> <span class="n">transactions</span><span class="p">,</span>
<a id="__codelineno-55-73" name="__codelineno-55-73" href="#__codelineno-55-73"></a>            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
<a id="__codelineno-55-74" name="__codelineno-55-74" href="#__codelineno-55-74"></a>            <span class="s1">&#39;revenue&#39;</span><span class="p">:</span> <span class="n">total_revenue</span><span class="p">,</span>
<a id="__codelineno-55-75" name="__codelineno-55-75" href="#__codelineno-55-75"></a>            <span class="s1">&#39;expenses&#39;</span><span class="p">:</span> <span class="n">total_expenses</span><span class="p">,</span>
<a id="__codelineno-55-76" name="__codelineno-55-76" href="#__codelineno-55-76"></a>            <span class="s1">&#39;profit&#39;</span><span class="p">:</span> <span class="n">total_revenue</span> <span class="o">-</span> <span class="n">total_expenses</span>
<a id="__codelineno-55-77" name="__codelineno-55-77" href="#__codelineno-55-77"></a>        <span class="p">}</span>
<a id="__codelineno-55-78" name="__codelineno-55-78" href="#__codelineno-55-78"></a>
<a id="__codelineno-55-79" name="__codelineno-55-79" href="#__codelineno-55-79"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-55-80" name="__codelineno-55-80" href="#__codelineno-55-80"></a>        <span class="k">return</span> <span class="n">report</span>
<a id="__codelineno-55-81" name="__codelineno-55-81" href="#__codelineno-55-81"></a>
<a id="__codelineno-55-82" name="__codelineno-55-82" href="#__codelineno-55-82"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-83" name="__codelineno-55-83" href="#__codelineno-55-83"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-55-84" name="__codelineno-55-84" href="#__codelineno-55-84"></a>        <span class="k">raise</span>
<a id="__codelineno-55-85" name="__codelineno-55-85" href="#__codelineno-55-85"></a>
<a id="__codelineno-55-86" name="__codelineno-55-86" href="#__codelineno-55-86"></a>
<a id="__codelineno-55-87" name="__codelineno-55-87" href="#__codelineno-55-87"></a><span class="c1"># Inventory management - prevent overselling</span>
<a id="__codelineno-55-88" name="__codelineno-55-88" href="#__codelineno-55-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">reserve_inventory</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
<a id="__codelineno-55-89" name="__codelineno-55-89" href="#__codelineno-55-89"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reserve inventory with SERIALIZABLE to prevent overselling&quot;&quot;&quot;</span>
<a id="__codelineno-55-90" name="__codelineno-55-90" href="#__codelineno-55-90"></a>    <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">)</span>
<a id="__codelineno-55-91" name="__codelineno-55-91" href="#__codelineno-55-91"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-55-92" name="__codelineno-55-92" href="#__codelineno-55-92"></a>
<a id="__codelineno-55-93" name="__codelineno-55-93" href="#__codelineno-55-93"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-55-94" name="__codelineno-55-94" href="#__codelineno-55-94"></a>        <span class="c1"># Check available stock (locks the row AND range)</span>
<a id="__codelineno-55-95" name="__codelineno-55-95" href="#__codelineno-55-95"></a>        <span class="n">stock</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-55-96" name="__codelineno-55-96" href="#__codelineno-55-96"></a>            <span class="s2">&quot;SELECT quantity FROM inventory WHERE product_id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-55-97" name="__codelineno-55-97" href="#__codelineno-55-97"></a>            <span class="p">[</span><span class="n">product_id</span><span class="p">]</span>
<a id="__codelineno-55-98" name="__codelineno-55-98" href="#__codelineno-55-98"></a>        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-55-99" name="__codelineno-55-99" href="#__codelineno-55-99"></a>
<a id="__codelineno-55-100" name="__codelineno-55-100" href="#__codelineno-55-100"></a>        <span class="k">if</span> <span class="n">stock</span> <span class="o">&lt;</span> <span class="n">quantity</span><span class="p">:</span>
<a id="__codelineno-55-101" name="__codelineno-55-101" href="#__codelineno-55-101"></a>            <span class="k">raise</span> <span class="n">InsufficientStockError</span><span class="p">()</span>
<a id="__codelineno-55-102" name="__codelineno-55-102" href="#__codelineno-55-102"></a>
<a id="__codelineno-55-103" name="__codelineno-55-103" href="#__codelineno-55-103"></a>        <span class="c1"># No other transaction can:</span>
<a id="__codelineno-55-104" name="__codelineno-55-104" href="#__codelineno-55-104"></a>        <span class="c1"># 1. Modify this row</span>
<a id="__codelineno-55-105" name="__codelineno-55-105" href="#__codelineno-55-105"></a>        <span class="c1"># 2. Insert new rows for this product</span>
<a id="__codelineno-55-106" name="__codelineno-55-106" href="#__codelineno-55-106"></a>        <span class="c1"># 3. See inconsistent stock levels</span>
<a id="__codelineno-55-107" name="__codelineno-55-107" href="#__codelineno-55-107"></a>
<a id="__codelineno-55-108" name="__codelineno-55-108" href="#__codelineno-55-108"></a>        <span class="c1"># Deduct inventory</span>
<a id="__codelineno-55-109" name="__codelineno-55-109" href="#__codelineno-55-109"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-55-110" name="__codelineno-55-110" href="#__codelineno-55-110"></a>            <span class="s2">&quot;UPDATE inventory SET quantity = quantity - ? WHERE product_id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-55-111" name="__codelineno-55-111" href="#__codelineno-55-111"></a>            <span class="p">[</span><span class="n">quantity</span><span class="p">,</span> <span class="n">product_id</span><span class="p">]</span>
<a id="__codelineno-55-112" name="__codelineno-55-112" href="#__codelineno-55-112"></a>        <span class="p">)</span>
<a id="__codelineno-55-113" name="__codelineno-55-113" href="#__codelineno-55-113"></a>
<a id="__codelineno-55-114" name="__codelineno-55-114" href="#__codelineno-55-114"></a>        <span class="c1"># Create reservation</span>
<a id="__codelineno-55-115" name="__codelineno-55-115" href="#__codelineno-55-115"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-55-116" name="__codelineno-55-116" href="#__codelineno-55-116"></a>            <span class="s2">&quot;INSERT INTO reservations (product_id, quantity, timestamp) VALUES (?, ?, ?)&quot;</span><span class="p">,</span>
<a id="__codelineno-55-117" name="__codelineno-55-117" href="#__codelineno-55-117"></a>            <span class="p">[</span><span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">now</span><span class="p">()]</span>
<a id="__codelineno-55-118" name="__codelineno-55-118" href="#__codelineno-55-118"></a>        <span class="p">)</span>
<a id="__codelineno-55-119" name="__codelineno-55-119" href="#__codelineno-55-119"></a>
<a id="__codelineno-55-120" name="__codelineno-55-120" href="#__codelineno-55-120"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-55-121" name="__codelineno-55-121" href="#__codelineno-55-121"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-55-122" name="__codelineno-55-122" href="#__codelineno-55-122"></a>
<a id="__codelineno-55-123" name="__codelineno-55-123" href="#__codelineno-55-123"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-124" name="__codelineno-55-124" href="#__codelineno-55-124"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-55-125" name="__codelineno-55-125" href="#__codelineno-55-125"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-55-126" name="__codelineno-55-126" href="#__codelineno-55-126"></a>
<a id="__codelineno-55-127" name="__codelineno-55-127" href="#__codelineno-55-127"></a>
<a id="__codelineno-55-128" name="__codelineno-55-128" href="#__codelineno-55-128"></a><span class="c1"># Handling serialization failures</span>
<a id="__codelineno-55-129" name="__codelineno-55-129" href="#__codelineno-55-129"></a><span class="k">def</span><span class="w"> </span><span class="nf">serializable_with_retry</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-55-130" name="__codelineno-55-130" href="#__codelineno-55-130"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SERIALIZABLE transactions may fail - implement retry logic&quot;&quot;&quot;</span>
<a id="__codelineno-55-131" name="__codelineno-55-131" href="#__codelineno-55-131"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-55-132" name="__codelineno-55-132" href="#__codelineno-55-132"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-55-133" name="__codelineno-55-133" href="#__codelineno-55-133"></a>            <span class="n">db</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">)</span>
<a id="__codelineno-55-134" name="__codelineno-55-134" href="#__codelineno-55-134"></a>            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-55-135" name="__codelineno-55-135" href="#__codelineno-55-135"></a>
<a id="__codelineno-55-136" name="__codelineno-55-136" href="#__codelineno-55-136"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">operation</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-55-137" name="__codelineno-55-137" href="#__codelineno-55-137"></a>
<a id="__codelineno-55-138" name="__codelineno-55-138" href="#__codelineno-55-138"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-55-139" name="__codelineno-55-139" href="#__codelineno-55-139"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-55-140" name="__codelineno-55-140" href="#__codelineno-55-140"></a>
<a id="__codelineno-55-141" name="__codelineno-55-141" href="#__codelineno-55-141"></a>        <span class="k">except</span> <span class="n">SerializationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-142" name="__codelineno-55-142" href="#__codelineno-55-142"></a>            <span class="c1"># Transaction was aborted due to serialization conflict</span>
<a id="__codelineno-55-143" name="__codelineno-55-143" href="#__codelineno-55-143"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-55-144" name="__codelineno-55-144" href="#__codelineno-55-144"></a>
<a id="__codelineno-55-145" name="__codelineno-55-145" href="#__codelineno-55-145"></a>            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-55-146" name="__codelineno-55-146" href="#__codelineno-55-146"></a>                <span class="c1"># Exponential backoff</span>
<a id="__codelineno-55-147" name="__codelineno-55-147" href="#__codelineno-55-147"></a>                <span class="n">sleep_time</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<a id="__codelineno-55-148" name="__codelineno-55-148" href="#__codelineno-55-148"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
<a id="__codelineno-55-149" name="__codelineno-55-149" href="#__codelineno-55-149"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retry attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-55-150" name="__codelineno-55-150" href="#__codelineno-55-150"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-55-151" name="__codelineno-55-151" href="#__codelineno-55-151"></a>                <span class="k">raise</span>
<a id="__codelineno-55-152" name="__codelineno-55-152" href="#__codelineno-55-152"></a>
<a id="__codelineno-55-153" name="__codelineno-55-153" href="#__codelineno-55-153"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-55-154" name="__codelineno-55-154" href="#__codelineno-55-154"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-55-155" name="__codelineno-55-155" href="#__codelineno-55-155"></a>            <span class="k">raise</span>
<a id="__codelineno-55-156" name="__codelineno-55-156" href="#__codelineno-55-156"></a>
<a id="__codelineno-55-157" name="__codelineno-55-157" href="#__codelineno-55-157"></a>
<a id="__codelineno-55-158" name="__codelineno-55-158" href="#__codelineno-55-158"></a><span class="c1"># Implementation methods vary by database</span>
<a id="__codelineno-55-159" name="__codelineno-55-159" href="#__codelineno-55-159"></a><span class="k">def</span><span class="w"> </span><span class="nf">serializable_implementation_comparison</span><span class="p">():</span>
<a id="__codelineno-55-160" name="__codelineno-55-160" href="#__codelineno-55-160"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Different databases implement SERIALIZABLE differently&quot;&quot;&quot;</span>
<a id="__codelineno-55-161" name="__codelineno-55-161" href="#__codelineno-55-161"></a>
<a id="__codelineno-55-162" name="__codelineno-55-162" href="#__codelineno-55-162"></a>    <span class="c1"># PostgreSQL: Serializable Snapshot Isolation (SSI)</span>
<a id="__codelineno-55-163" name="__codelineno-55-163" href="#__codelineno-55-163"></a>    <span class="c1"># - Uses MVCC + conflict detection</span>
<a id="__codelineno-55-164" name="__codelineno-55-164" href="#__codelineno-55-164"></a>    <span class="c1"># - Transactions may be aborted</span>
<a id="__codelineno-55-165" name="__codelineno-55-165" href="#__codelineno-55-165"></a>    <span class="c1"># - Better performance than locking</span>
<a id="__codelineno-55-166" name="__codelineno-55-166" href="#__codelineno-55-166"></a>
<a id="__codelineno-55-167" name="__codelineno-55-167" href="#__codelineno-55-167"></a>    <span class="c1"># MySQL InnoDB: Next-key locking</span>
<a id="__codelineno-55-168" name="__codelineno-55-168" href="#__codelineno-55-168"></a>    <span class="c1"># - Locks rows + gaps between rows</span>
<a id="__codelineno-55-169" name="__codelineno-55-169" href="#__codelineno-55-169"></a>    <span class="c1"># - Prevents phantoms via gap locks</span>
<a id="__codelineno-55-170" name="__codelineno-55-170" href="#__codelineno-55-170"></a>    <span class="c1"># - More blocking, fewer aborts</span>
<a id="__codelineno-55-171" name="__codelineno-55-171" href="#__codelineno-55-171"></a>
<a id="__codelineno-55-172" name="__codelineno-55-172" href="#__codelineno-55-172"></a>    <span class="c1"># SQL Server: Range locks</span>
<a id="__codelineno-55-173" name="__codelineno-55-173" href="#__codelineno-55-173"></a>    <span class="c1"># - Locks key ranges</span>
<a id="__codelineno-55-174" name="__codelineno-55-174" href="#__codelineno-55-174"></a>    <span class="c1"># - Prevents phantoms</span>
<a id="__codelineno-55-175" name="__codelineno-55-175" href="#__codelineno-55-175"></a>    <span class="c1"># - Similar to MySQL</span>
<a id="__codelineno-55-176" name="__codelineno-55-176" href="#__codelineno-55-176"></a>
<a id="__codelineno-55-177" name="__codelineno-55-177" href="#__codelineno-55-177"></a>    <span class="c1"># Oracle: Not true SERIALIZABLE</span>
<a id="__codelineno-55-178" name="__codelineno-55-178" href="#__codelineno-55-178"></a>    <span class="c1"># - &quot;SERIALIZABLE&quot; is actually snapshot isolation</span>
<a id="__codelineno-55-179" name="__codelineno-55-179" href="#__codelineno-55-179"></a>    <span class="c1"># - Still allows write skew anomalies</span>
<a id="__codelineno-55-180" name="__codelineno-55-180" href="#__codelineno-55-180"></a>    <span class="c1"># - Use &quot;FOR UPDATE&quot; for true serializability</span>
<a id="__codelineno-55-181" name="__codelineno-55-181" href="#__codelineno-55-181"></a>
<a id="__codelineno-55-182" name="__codelineno-55-182" href="#__codelineno-55-182"></a>    <span class="k">pass</span>
</code></pre></div>
<p><strong>Comparison Table:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>         Isolation Level Comparison                           
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>                                                              
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a> Level              Dirty  Non-Rep  Phantom  Concurrency      
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>                    Read   Read     Read     Level            
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a> Read Uncommitted   YES    YES      YES      (highest)  
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a> Read Committed     NO     YES      YES                 
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a> Repeatable Read    NO     NO       YES                 
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a> Serializable       NO     NO       NO       (lowest)   
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>                                                              
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a> Performance Impact:                                          
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a> Read Uncommitted:  Fastest (no locks)                        
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a> Read Committed:    Fast (short locks)                        
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a> Repeatable Read:   Moderate (longer locks)                   
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a> Serializable:      Slowest (longest locks/most conflicts)    
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>                                                              
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>
</code></pre></div>
<p><strong>Advantages:</strong>
-  <strong>Complete isolation</strong> - no anomalies possible
-  <strong>Perfect consistency</strong> - as if transactions run serially
-  <strong>No dirty/non-repeatable/phantom reads</strong>
-  <strong>Simplest programming model</strong> - no concurrency issues to handle
-  <strong>Required for critical operations</strong> - financial, inventory</p>
<p><strong>Disadvantages:</strong>
-  <strong>Lowest concurrency</strong> - significant blocking
-  <strong>Worst performance</strong> - many transactions wait
-  <strong>Deadlocks common</strong> - transactions waiting on each other
-  <strong>Serialization failures</strong> - transactions may be aborted
-  <strong>Not scalable</strong> - limits throughput</p>
<p><strong>When to Use:</strong>
- Critical financial transactions (money transfers, payments)
- Inventory management (prevent overselling)
- Compliance and auditing (exact counts required)
- When data accuracy is more important than performance
- Small transactions with low contention</p>
<hr />
<h3 id="summary-choosing-the-right-isolation-level">Summary: Choosing the Right Isolation Level</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">choose_isolation_level</span><span class="p">(</span><span class="n">use_case</span><span class="p">):</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Guide for choosing isolation level&quot;&quot;&quot;</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>    <span class="k">if</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s2">&quot;dashboard_analytics&quot;</span><span class="p">:</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>        <span class="c1"># Approximate data OK, maximum performance</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>        <span class="k">return</span> <span class="s2">&quot;READ UNCOMMITTED&quot;</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>    <span class="k">elif</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s2">&quot;web_application&quot;</span><span class="p">:</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>        <span class="c1"># Standard OLTP, dirty reads not acceptable</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>        <span class="k">return</span> <span class="s2">&quot;READ COMMITTED&quot;</span>  <span class="c1"># Most common choice</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>    <span class="k">elif</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s2">&quot;complex_calculation&quot;</span><span class="p">:</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>        <span class="c1"># Need consistent row values, OK if counts change</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>        <span class="k">return</span> <span class="s2">&quot;REPEATABLE READ&quot;</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>    <span class="k">elif</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s2">&quot;financial_transaction&quot;</span><span class="p">:</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>        <span class="c1"># Perfect accuracy required, performance secondary</span>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a>        <span class="k">return</span> <span class="s2">&quot;SERIALIZABLE&quot;</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a>    <span class="k">elif</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s2">&quot;reporting&quot;</span><span class="p">:</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a>        <span class="c1"># Depends on accuracy requirements</span>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a>        <span class="k">if</span> <span class="n">accuracy</span> <span class="o">==</span> <span class="s2">&quot;approximate&quot;</span><span class="p">:</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a>            <span class="k">return</span> <span class="s2">&quot;READ UNCOMMITTED&quot;</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a>        <span class="k">elif</span> <span class="n">accuracy</span> <span class="o">==</span> <span class="s2">&quot;exact_values&quot;</span><span class="p">:</span>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a>            <span class="k">return</span> <span class="s2">&quot;REPEATABLE READ&quot;</span>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a>        <span class="k">elif</span> <span class="n">accuracy</span> <span class="o">==</span> <span class="s2">&quot;exact_counts&quot;</span><span class="p">:</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a>            <span class="k">return</span> <span class="s2">&quot;SERIALIZABLE&quot;</span>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a>    <span class="c1"># Default safe choice</span>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a>    <span class="k">return</span> <span class="s2">&quot;READ COMMITTED&quot;</span>
</code></pre></div>
<hr />
<h3 id="4-optimistic-vs-pessimistic-concurrency-control">4. Optimistic vs Pessimistic Concurrency Control</h3>
<p><strong>Description:</strong></p>
<p>Concurrency control mechanisms can be broadly categorized into two fundamental approaches: <strong>Pessimistic Concurrency Control</strong> and <strong>Optimistic Concurrency Control</strong>. These represent two different philosophies for handling concurrent access to data.</p>
<h4 id="41-pessimistic-concurrency-control">4.1 Pessimistic Concurrency Control</h4>
<p><strong>Description:</strong></p>
<p><strong>Pessimistic Concurrency Control</strong> assumes that <strong>conflicts are likely</strong> to occur when multiple transactions access the same data concurrently. Therefore, it <strong>prevents conflicts before they happen</strong> by acquiring locks on data before accessing it. This is the "better safe than sorry" approach.</p>
<p><strong>Core Philosophy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>     PESSIMISTIC CONCURRENCY CONTROL - Philosophy        
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>                                                         
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>  Assumption: &quot;Conflicts WILL happen frequently&quot;         
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>                                                         
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>  Strategy: PREVENT conflicts by locking                 
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>                                                         
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>          
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>   1. Lock resources BEFORE accessing                 
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>   2. Hold locks during entire transaction            
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>   3. Block other transactions from accessing         
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>   4. Release locks on commit/rollback                
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>          
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>                                                         
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>  Metaphor: &quot;Lock the door before entering the room&quot;    
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>                                                         
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>
</code></pre></div>
<p><strong>How Pessimistic Control Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>        PESSIMISTIC CONCURRENCY CONTROL - Flow           
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>                                                         
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>  Transaction Lifecycle:                                 
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>                                                         
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>  1. BEGIN TRANSACTION                                   
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>                                                        
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>  2. ACQUIRE LOCKS (Shared or Exclusive)                 
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>      Lock acquired?  Proceed                        
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>      Lock held by others?  WAIT (BLOCKED)           
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>                                                        
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>  3. READ/WRITE DATA                                     
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>     - Guaranteed exclusive or shared access             
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>     - No one can interfere                              
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>                                                        
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>  4. HOLD LOCKS (until transaction ends)                 
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>                                                        
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a>  5. COMMIT or ROLLBACK                                  
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>                                                        
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>  6. RELEASE LOCKS                                       
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>     - Other transactions can now proceed                
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a>                                                         
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>
</code></pre></div>
<p><strong>Visual Timeline Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>Pessimistic Locking Timeline:
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>Time  T1 (Pessimistic)           Locks         T2 (Pessimistic)
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>t1    BEGIN                       -             
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>t2    LOCK row (FOR UPDATE)        Row locked
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>t3    Read row: balance=1000       Locked    
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>t4                                              BEGIN
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>t5                                              LOCK same row
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>t6                                               BLOCKED!
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>t7    Modify: balance=500          Locked     [Waiting...]
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>t8    (business logic...)          Locked     [Waiting...]
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>t9    COMMIT                       Unlocked  
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>t10                                              Lock acquired
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>t11                                             Read: balance=500
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>t12                                             COMMIT
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>Result: T2 WAITED for T1 to finish (prevented conflict)
</code></pre></div>
<p><strong>Implementation Approaches:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    PESSIMISTIC CONTROL - Implementation Types           
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>                                                         
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a> 1. Two-Phase Locking (2PL)                              
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>          
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>   Growing Phase: Acquire locks only                 
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>   Shrinking Phase: Release locks only               
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>   No lock acquisition after first release           
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>   Guarantees serializability                        
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>   Used by: SQL Server, DB2                          
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>          
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>                                                         
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a> 2. Strict Two-Phase Locking (Strict 2PL)               
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>          
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>   Holds ALL locks until COMMIT/ROLLBACK             
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>   No shrinking phase during transaction             
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>   Prevents cascading rollbacks                      
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>   Most common in practice                           
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>   Used by: Most SQL databases                       
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>          
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>                                                         
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a> 3. Explicit Locking                                     
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>          
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>   SELECT ... FOR UPDATE                             
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>   SELECT ... LOCK IN SHARE MODE                     
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>   LOCK TABLE ...                                    
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>   Application controls lock granularity             
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>          
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>                                                         
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>
</code></pre></div>
<p><strong>Pseudo Code Examples:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Example 1: Basic Pessimistic Locking (SELECT FOR UPDATE)</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">pessimistic_transfer</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bank transfer with pessimistic locking&quot;&quot;&quot;</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>        <span class="c1"># LOCK rows immediately with SELECT FOR UPDATE</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>        <span class="c1"># This acquires exclusive locks, blocking other transactions</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>        <span class="n">from_balance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="s2">            SELECT balance FROM accounts </span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">from_account</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>        <span class="c1"># Lock acquired! No one else can read/modify this row</span>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>        <span class="c1"># until we commit/rollback</span>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>        <span class="n">to_balance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a><span class="s2">            SELECT balance FROM accounts </span>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">to_account</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a>        <span class="c1"># Validate sufficient funds</span>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a>        <span class="k">if</span> <span class="n">from_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a>            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a>        <span class="c1"># Perform updates (locks already held)</span>
<a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a><span class="s2">            UPDATE accounts SET balance = balance - ? </span>
<a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a><span class="s2">            WHERE id = ?</span>
<a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a>
<a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a><span class="s2">            UPDATE accounts SET balance = balance + ? </span>
<a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a><span class="s2">            WHERE id = ?</span>
<a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a>
<a id="__codelineno-62-40" name="__codelineno-62-40" href="#__codelineno-62-40"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Release locks</span>
<a id="__codelineno-62-41" name="__codelineno-62-41" href="#__codelineno-62-41"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-62-42" name="__codelineno-62-42" href="#__codelineno-62-42"></a>
<a id="__codelineno-62-43" name="__codelineno-62-43" href="#__codelineno-62-43"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-62-44" name="__codelineno-62-44" href="#__codelineno-62-44"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># Release locks</span>
<a id="__codelineno-62-45" name="__codelineno-62-45" href="#__codelineno-62-45"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-62-46" name="__codelineno-62-46" href="#__codelineno-62-46"></a>
<a id="__codelineno-62-47" name="__codelineno-62-47" href="#__codelineno-62-47"></a>
<a id="__codelineno-62-48" name="__codelineno-62-48" href="#__codelineno-62-48"></a><span class="c1"># Example 2: Pessimistic Read-Modify-Write</span>
<a id="__codelineno-62-49" name="__codelineno-62-49" href="#__codelineno-62-49"></a>
<a id="__codelineno-62-50" name="__codelineno-62-50" href="#__codelineno-62-50"></a><span class="k">def</span><span class="w"> </span><span class="nf">pessimistic_inventory_update</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity_to_reserve</span><span class="p">):</span>
<a id="__codelineno-62-51" name="__codelineno-62-51" href="#__codelineno-62-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reserve inventory with pessimistic locking&quot;&quot;&quot;</span>
<a id="__codelineno-62-52" name="__codelineno-62-52" href="#__codelineno-62-52"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-62-53" name="__codelineno-62-53" href="#__codelineno-62-53"></a>
<a id="__codelineno-62-54" name="__codelineno-62-54" href="#__codelineno-62-54"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-62-55" name="__codelineno-62-55" href="#__codelineno-62-55"></a>        <span class="c1"># Lock inventory row</span>
<a id="__codelineno-62-56" name="__codelineno-62-56" href="#__codelineno-62-56"></a>        <span class="n">current_stock</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-57" name="__codelineno-62-57" href="#__codelineno-62-57"></a><span class="s2">            SELECT quantity FROM inventory </span>
<a id="__codelineno-62-58" name="__codelineno-62-58" href="#__codelineno-62-58"></a><span class="s2">            WHERE product_id = ? </span>
<a id="__codelineno-62-59" name="__codelineno-62-59" href="#__codelineno-62-59"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-62-60" name="__codelineno-62-60" href="#__codelineno-62-60"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-62-61" name="__codelineno-62-61" href="#__codelineno-62-61"></a>
<a id="__codelineno-62-62" name="__codelineno-62-62" href="#__codelineno-62-62"></a>        <span class="c1"># Row is now locked - no concurrent modifications possible</span>
<a id="__codelineno-62-63" name="__codelineno-62-63" href="#__codelineno-62-63"></a>
<a id="__codelineno-62-64" name="__codelineno-62-64" href="#__codelineno-62-64"></a>        <span class="k">if</span> <span class="n">current_stock</span> <span class="o">&lt;</span> <span class="n">quantity_to_reserve</span><span class="p">:</span>
<a id="__codelineno-62-65" name="__codelineno-62-65" href="#__codelineno-62-65"></a>            <span class="k">raise</span> <span class="n">OutOfStockError</span><span class="p">()</span>
<a id="__codelineno-62-66" name="__codelineno-62-66" href="#__codelineno-62-66"></a>
<a id="__codelineno-62-67" name="__codelineno-62-67" href="#__codelineno-62-67"></a>        <span class="c1"># Update inventory</span>
<a id="__codelineno-62-68" name="__codelineno-62-68" href="#__codelineno-62-68"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-69" name="__codelineno-62-69" href="#__codelineno-62-69"></a><span class="s2">            UPDATE inventory </span>
<a id="__codelineno-62-70" name="__codelineno-62-70" href="#__codelineno-62-70"></a><span class="s2">            SET quantity = quantity - ? </span>
<a id="__codelineno-62-71" name="__codelineno-62-71" href="#__codelineno-62-71"></a><span class="s2">            WHERE product_id = ?</span>
<a id="__codelineno-62-72" name="__codelineno-62-72" href="#__codelineno-62-72"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">quantity_to_reserve</span><span class="p">,</span> <span class="n">product_id</span><span class="p">])</span>
<a id="__codelineno-62-73" name="__codelineno-62-73" href="#__codelineno-62-73"></a>
<a id="__codelineno-62-74" name="__codelineno-62-74" href="#__codelineno-62-74"></a>        <span class="c1"># Create reservation record</span>
<a id="__codelineno-62-75" name="__codelineno-62-75" href="#__codelineno-62-75"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-76" name="__codelineno-62-76" href="#__codelineno-62-76"></a><span class="s2">            INSERT INTO reservations (product_id, quantity, timestamp)</span>
<a id="__codelineno-62-77" name="__codelineno-62-77" href="#__codelineno-62-77"></a><span class="s2">            VALUES (?, ?, ?)</span>
<a id="__codelineno-62-78" name="__codelineno-62-78" href="#__codelineno-62-78"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">,</span> <span class="n">quantity_to_reserve</span><span class="p">,</span> <span class="n">now</span><span class="p">()])</span>
<a id="__codelineno-62-79" name="__codelineno-62-79" href="#__codelineno-62-79"></a>
<a id="__codelineno-62-80" name="__codelineno-62-80" href="#__codelineno-62-80"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-62-81" name="__codelineno-62-81" href="#__codelineno-62-81"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-62-82" name="__codelineno-62-82" href="#__codelineno-62-82"></a>
<a id="__codelineno-62-83" name="__codelineno-62-83" href="#__codelineno-62-83"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-62-84" name="__codelineno-62-84" href="#__codelineno-62-84"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-62-85" name="__codelineno-62-85" href="#__codelineno-62-85"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-62-86" name="__codelineno-62-86" href="#__codelineno-62-86"></a>
<a id="__codelineno-62-87" name="__codelineno-62-87" href="#__codelineno-62-87"></a>
<a id="__codelineno-62-88" name="__codelineno-62-88" href="#__codelineno-62-88"></a><span class="c1"># Example 3: Shared Lock (Multiple Readers)</span>
<a id="__codelineno-62-89" name="__codelineno-62-89" href="#__codelineno-62-89"></a>
<a id="__codelineno-62-90" name="__codelineno-62-90" href="#__codelineno-62-90"></a><span class="k">def</span><span class="w"> </span><span class="nf">pessimistic_shared_read</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">):</span>
<a id="__codelineno-62-91" name="__codelineno-62-91" href="#__codelineno-62-91"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read with shared lock - allows concurrent reads&quot;&quot;&quot;</span>
<a id="__codelineno-62-92" name="__codelineno-62-92" href="#__codelineno-62-92"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-62-93" name="__codelineno-62-93" href="#__codelineno-62-93"></a>
<a id="__codelineno-62-94" name="__codelineno-62-94" href="#__codelineno-62-94"></a>    <span class="c1"># Acquire shared lock</span>
<a id="__codelineno-62-95" name="__codelineno-62-95" href="#__codelineno-62-95"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-62-96" name="__codelineno-62-96" href="#__codelineno-62-96"></a><span class="s2">        SELECT balance FROM accounts </span>
<a id="__codelineno-62-97" name="__codelineno-62-97" href="#__codelineno-62-97"></a><span class="s2">        WHERE id = ? </span>
<a id="__codelineno-62-98" name="__codelineno-62-98" href="#__codelineno-62-98"></a><span class="s2">        LOCK IN SHARE MODE</span>
<a id="__codelineno-62-99" name="__codelineno-62-99" href="#__codelineno-62-99"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-62-100" name="__codelineno-62-100" href="#__codelineno-62-100"></a>
<a id="__codelineno-62-101" name="__codelineno-62-101" href="#__codelineno-62-101"></a>    <span class="c1"># Other transactions can:</span>
<a id="__codelineno-62-102" name="__codelineno-62-102" href="#__codelineno-62-102"></a>    <span class="c1"># - Read with LOCK IN SHARE MODE </span>
<a id="__codelineno-62-103" name="__codelineno-62-103" href="#__codelineno-62-103"></a>    <span class="c1"># - Cannot UPDATE (blocked by shared lock) </span>
<a id="__codelineno-62-104" name="__codelineno-62-104" href="#__codelineno-62-104"></a>
<a id="__codelineno-62-105" name="__codelineno-62-105" href="#__codelineno-62-105"></a>    <span class="c1"># Perform read-only operations</span>
<a id="__codelineno-62-106" name="__codelineno-62-106" href="#__codelineno-62-106"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balance: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-62-107" name="__codelineno-62-107" href="#__codelineno-62-107"></a>
<a id="__codelineno-62-108" name="__codelineno-62-108" href="#__codelineno-62-108"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Release shared lock</span>
</code></pre></div>
<p><strong>Advantages:</strong>
-  <strong>Prevents conflicts</strong> - locks guarantee exclusive/shared access
-  <strong>Data consistency</strong> - no dirty reads, lost updates, or write conflicts
-  <strong>Simple reasoning</strong> - if you have the lock, you have exclusive access
-  <strong>Suitable for high-contention</strong> - prevents wasted work from conflicts</p>
<p><strong>Disadvantages:</strong>
-  <strong>Blocking</strong> - transactions wait for locks, reduced throughput
-  <strong>Deadlocks</strong> - circular lock dependencies can occur
-  <strong>Lock overhead</strong> - acquiring, holding, and releasing locks costs CPU/memory
-  <strong>Reduced concurrency</strong> - locks prevent parallel execution
-  <strong>Lock escalation</strong> - too many row locks  table locks (worse performance)</p>
<hr />
<h4 id="42-optimistic-concurrency-control">4.2 Optimistic Concurrency Control</h4>
<p><strong>Description:</strong></p>
<p><strong>Optimistic Concurrency Control</strong> assumes that <strong>conflicts are rare</strong> when multiple transactions access the same data concurrently. Therefore, it <strong>allows transactions to proceed without locks</strong> and only <strong>checks for conflicts at commit time</strong>. This is the "hope for the best, handle problems later" approach.</p>
<p><strong>Core Philosophy:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>     OPTIMISTIC CONCURRENCY CONTROL - Philosophy         
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>                                                         
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>  Assumption: &quot;Conflicts are RARE&quot;                       
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>                                                         
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>  Strategy: DETECT and RESOLVE conflicts at commit       
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>                                                         
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>          
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>   1. Read data WITHOUT locks                         
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>   2. Make changes in isolation (local copy)          
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>   3. Validate no conflicts before commit             
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>   4. Commit if valid, ABORT if conflict              
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>          
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a>                                                         
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>  Metaphor: &quot;Walk into the room, check if someone       
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>             changed things, redo if needed&quot;             
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a>                                                         
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a>
</code></pre></div>
<p><strong>How Optimistic Control Works:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>        OPTIMISTIC CONCURRENCY CONTROL - Flow            
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>                                                         
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>  Transaction Lifecycle:                                 
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>                                                         
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>  1. BEGIN TRANSACTION                                   
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>                                                        
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>  2. READ DATA (no locks!)                               
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>     - Record version number or timestamp                
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a>     - Make local copy                                   
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a>                                                        
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a>  3. MODIFY DATA LOCALLY                                 
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a>     - Changes in memory only                            
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a>     - No locks acquired                                 
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a>     - No blocking of other transactions                 
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a>                                                        
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>  4. VALIDATION PHASE (at commit)                        
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a>     - Check if data changed since read                  
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>     - Compare version numbers or timestamps             
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>      No changes?  Proceed to commit                 
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>      Data changed?  ABORT and RETRY                 
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>                                                        
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>  5. COMMIT (if validation passed)                       
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>     - Apply changes to database                         
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>     - Increment version number                          
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a>                                                         
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a>  OR                                                     
<a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a>                                                         
<a id="__codelineno-64-30" name="__codelineno-64-30" href="#__codelineno-64-30"></a>  5. ABORT (if validation failed)                        
<a id="__codelineno-64-31" name="__codelineno-64-31" href="#__codelineno-64-31"></a>     - Discard local changes                             
<a id="__codelineno-64-32" name="__codelineno-64-32" href="#__codelineno-64-32"></a>     - Retry transaction (read fresh data)               
<a id="__codelineno-64-33" name="__codelineno-64-33" href="#__codelineno-64-33"></a>                                                         
<a id="__codelineno-64-34" name="__codelineno-64-34" href="#__codelineno-64-34"></a>
</code></pre></div>
<p><strong>Visual Timeline Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>Optimistic Concurrency Timeline:
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>Time  T1 (Optimistic)                    T2 (Optimistic)
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>t1    BEGIN                              
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>t2    Read: balance=1000, version=1     
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>t3    (no locks acquired!)               BEGIN
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>t4                                       Read: balance=1000, version=1
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>t5    Modify locally: balance=500       
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>t6                                       Modify locally: balance=700
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>t7    VALIDATE (version still 1?)      
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>t8    COMMIT: balance=500, version=2    
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>t9                                       VALIDATE (version still 1?) 
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>t10                                      ABORT! (version is now 2)
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>t11                                      RETRY: Read balance=500, version=2
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>t12                                      Modify: balance=200
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>t13                                      VALIDATE 
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>t14                                      COMMIT: balance=200, version=3
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>Result: T1 succeeded, T2 detected conflict and RETRIED
</code></pre></div>
<p><strong>Implementation Approaches:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>    OPTIMISTIC CONTROL - Implementation Types            
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>                                                         
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a> 1. Version Number (Most Common)                         
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>          
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>   Each row has version column                       
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>   Incremented on every update                       
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>   Validation: WHERE version = old_version           
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>   If 0 rows updated  conflict detected             
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>          
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>                                                         
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a> 2. Timestamp-Based                                      
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>          
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>   Each row has last_modified timestamp              
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>   Record timestamp when reading                     
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>   Validate: WHERE last_modified = old_time          
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>   Update timestamp on commit                        
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a>          
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>                                                         
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a> 3. Checksum/Hash-Based                                  
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>          
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a>   Calculate hash of row data                        
<a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a>   Compare hash at commit time                       
<a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a>   Any change  different hash                       
<a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a>   Expensive for large rows                          
<a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>          
<a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a>                                                         
<a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a> 4. MVCC (Multi-Version Concurrency Control)             
<a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a>          
<a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a>   Keep multiple versions of each row                
<a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a>   Each transaction sees snapshot                    
<a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a>   Detect write-write conflicts at commit            
<a id="__codelineno-66-34" name="__codelineno-66-34" href="#__codelineno-66-34"></a>   Used by: PostgreSQL, MySQL InnoDB                 
<a id="__codelineno-66-35" name="__codelineno-66-35" href="#__codelineno-66-35"></a>          
<a id="__codelineno-66-36" name="__codelineno-66-36" href="#__codelineno-66-36"></a>                                                         
<a id="__codelineno-66-37" name="__codelineno-66-37" href="#__codelineno-66-37"></a>
</code></pre></div>
<p><strong>Pseudo Code Examples:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c1"># Example 1: Version-Based Optimistic Locking</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimistic_transfer_version</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bank transfer with optimistic locking using version numbers&quot;&quot;&quot;</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a>            <span class="c1"># Read data WITHOUT locks, record version</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a>            <span class="n">from_row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a><span class="s2">                SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">from_account</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a>            <span class="n">from_balance</span> <span class="o">=</span> <span class="n">from_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>            <span class="n">from_version</span> <span class="o">=</span> <span class="n">from_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>            <span class="n">to_row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="s2">                SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">to_account</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>            <span class="n">to_balance</span> <span class="o">=</span> <span class="n">to_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a>            <span class="n">to_version</span> <span class="o">=</span> <span class="n">to_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>
<a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a>            <span class="c1"># Validate business rules</span>
<a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>            <span class="k">if</span> <span class="n">from_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a>                <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a>
<a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>            <span class="c1"># Attempt to update with version check</span>
<a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a>            <span class="c1"># Update only if version hasn&#39;t changed</span>
<a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a>            <span class="n">from_updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a><span class="s2">                UPDATE accounts </span>
<a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a><span class="s2">                SET balance = balance - ?, version = version + 1</span>
<a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a><span class="s2">                WHERE id = ? AND version = ?</span>
<a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">from_version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a>
<a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a>            <span class="n">to_updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a><span class="s2">                UPDATE accounts </span>
<a id="__codelineno-67-38" name="__codelineno-67-38" href="#__codelineno-67-38"></a><span class="s2">                SET balance = balance + ?, version = version + 1</span>
<a id="__codelineno-67-39" name="__codelineno-67-39" href="#__codelineno-67-39"></a><span class="s2">                WHERE id = ? AND version = ?</span>
<a id="__codelineno-67-40" name="__codelineno-67-40" href="#__codelineno-67-40"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">to_version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-67-41" name="__codelineno-67-41" href="#__codelineno-67-41"></a>
<a id="__codelineno-67-42" name="__codelineno-67-42" href="#__codelineno-67-42"></a>            <span class="c1"># Check if updates succeeded (version validation)</span>
<a id="__codelineno-67-43" name="__codelineno-67-43" href="#__codelineno-67-43"></a>            <span class="k">if</span> <span class="n">from_updated</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">to_updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-67-44" name="__codelineno-67-44" href="#__codelineno-67-44"></a>                <span class="c1"># Conflict detected! Someone else modified the row</span>
<a id="__codelineno-67-45" name="__codelineno-67-45" href="#__codelineno-67-45"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-46" name="__codelineno-67-46" href="#__codelineno-67-46"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conflict detected on attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, retrying...&quot;</span><span class="p">)</span>
<a id="__codelineno-67-47" name="__codelineno-67-47" href="#__codelineno-67-47"></a>                <span class="k">continue</span>  <span class="c1"># Retry</span>
<a id="__codelineno-67-48" name="__codelineno-67-48" href="#__codelineno-67-48"></a>
<a id="__codelineno-67-49" name="__codelineno-67-49" href="#__codelineno-67-49"></a>            <span class="c1"># Success! Commit changes</span>
<a id="__codelineno-67-50" name="__codelineno-67-50" href="#__codelineno-67-50"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-67-51" name="__codelineno-67-51" href="#__codelineno-67-51"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-67-52" name="__codelineno-67-52" href="#__codelineno-67-52"></a>
<a id="__codelineno-67-53" name="__codelineno-67-53" href="#__codelineno-67-53"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-67-54" name="__codelineno-67-54" href="#__codelineno-67-54"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-55" name="__codelineno-67-55" href="#__codelineno-67-55"></a>            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-67-56" name="__codelineno-67-56" href="#__codelineno-67-56"></a>                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Max retries exceeded</span>
<a id="__codelineno-67-57" name="__codelineno-67-57" href="#__codelineno-67-57"></a>
<a id="__codelineno-67-58" name="__codelineno-67-58" href="#__codelineno-67-58"></a>    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Failed after retries</span>
<a id="__codelineno-67-59" name="__codelineno-67-59" href="#__codelineno-67-59"></a>
<a id="__codelineno-67-60" name="__codelineno-67-60" href="#__codelineno-67-60"></a>
<a id="__codelineno-67-61" name="__codelineno-67-61" href="#__codelineno-67-61"></a><span class="c1"># Example 2: Timestamp-Based Optimistic Locking</span>
<a id="__codelineno-67-62" name="__codelineno-67-62" href="#__codelineno-67-62"></a>
<a id="__codelineno-67-63" name="__codelineno-67-63" href="#__codelineno-67-63"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimistic_update_timestamp</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">new_price</span><span class="p">):</span>
<a id="__codelineno-67-64" name="__codelineno-67-64" href="#__codelineno-67-64"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Update product price with timestamp-based optimistic locking&quot;&quot;&quot;</span>
<a id="__codelineno-67-65" name="__codelineno-67-65" href="#__codelineno-67-65"></a>
<a id="__codelineno-67-66" name="__codelineno-67-66" href="#__codelineno-67-66"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-67-67" name="__codelineno-67-67" href="#__codelineno-67-67"></a>
<a id="__codelineno-67-68" name="__codelineno-67-68" href="#__codelineno-67-68"></a>    <span class="c1"># Read current data and timestamp</span>
<a id="__codelineno-67-69" name="__codelineno-67-69" href="#__codelineno-67-69"></a>    <span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-70" name="__codelineno-67-70" href="#__codelineno-67-70"></a><span class="s2">        SELECT price, last_modified FROM products WHERE id = ?</span>
<a id="__codelineno-67-71" name="__codelineno-67-71" href="#__codelineno-67-71"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-67-72" name="__codelineno-67-72" href="#__codelineno-67-72"></a>
<a id="__codelineno-67-73" name="__codelineno-67-73" href="#__codelineno-67-73"></a>    <span class="n">current_price</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-67-74" name="__codelineno-67-74" href="#__codelineno-67-74"></a>    <span class="n">last_modified</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-67-75" name="__codelineno-67-75" href="#__codelineno-67-75"></a>
<a id="__codelineno-67-76" name="__codelineno-67-76" href="#__codelineno-67-76"></a>    <span class="c1"># Perform business logic with current data</span>
<a id="__codelineno-67-77" name="__codelineno-67-77" href="#__codelineno-67-77"></a>    <span class="c1"># (no locks held, other transactions can read/modify freely)</span>
<a id="__codelineno-67-78" name="__codelineno-67-78" href="#__codelineno-67-78"></a>
<a id="__codelineno-67-79" name="__codelineno-67-79" href="#__codelineno-67-79"></a>    <span class="c1"># Try to commit with timestamp validation</span>
<a id="__codelineno-67-80" name="__codelineno-67-80" href="#__codelineno-67-80"></a>    <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-81" name="__codelineno-67-81" href="#__codelineno-67-81"></a><span class="s2">        UPDATE products </span>
<a id="__codelineno-67-82" name="__codelineno-67-82" href="#__codelineno-67-82"></a><span class="s2">        SET price = ?, last_modified = CURRENT_TIMESTAMP</span>
<a id="__codelineno-67-83" name="__codelineno-67-83" href="#__codelineno-67-83"></a><span class="s2">        WHERE id = ? AND last_modified = ?</span>
<a id="__codelineno-67-84" name="__codelineno-67-84" href="#__codelineno-67-84"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">new_price</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">last_modified</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-67-85" name="__codelineno-67-85" href="#__codelineno-67-85"></a>
<a id="__codelineno-67-86" name="__codelineno-67-86" href="#__codelineno-67-86"></a>    <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-67-87" name="__codelineno-67-87" href="#__codelineno-67-87"></a>        <span class="c1"># Conflict! Data was modified by another transaction</span>
<a id="__codelineno-67-88" name="__codelineno-67-88" href="#__codelineno-67-88"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-89" name="__codelineno-67-89" href="#__codelineno-67-89"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conflict detected - data was modified by another transaction&quot;</span><span class="p">)</span>
<a id="__codelineno-67-90" name="__codelineno-67-90" href="#__codelineno-67-90"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-67-91" name="__codelineno-67-91" href="#__codelineno-67-91"></a>
<a id="__codelineno-67-92" name="__codelineno-67-92" href="#__codelineno-67-92"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-67-93" name="__codelineno-67-93" href="#__codelineno-67-93"></a>    <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-67-94" name="__codelineno-67-94" href="#__codelineno-67-94"></a>
<a id="__codelineno-67-95" name="__codelineno-67-95" href="#__codelineno-67-95"></a>
<a id="__codelineno-67-96" name="__codelineno-67-96" href="#__codelineno-67-96"></a><span class="c1"># Example 3: Application-Level Optimistic Locking (Web App)</span>
<a id="__codelineno-67-97" name="__codelineno-67-97" href="#__codelineno-67-97"></a>
<a id="__codelineno-67-98" name="__codelineno-67-98" href="#__codelineno-67-98"></a><span class="k">class</span><span class="w"> </span><span class="nc">OptimisticLockingExample</span><span class="p">:</span>
<a id="__codelineno-67-99" name="__codelineno-67-99" href="#__codelineno-67-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;E-commerce cart checkout with optimistic locking&quot;&quot;&quot;</span>
<a id="__codelineno-67-100" name="__codelineno-67-100" href="#__codelineno-67-100"></a>
<a id="__codelineno-67-101" name="__codelineno-67-101" href="#__codelineno-67-101"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">display_product_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">):</span>
<a id="__codelineno-67-102" name="__codelineno-67-102" href="#__codelineno-67-102"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Step 1: User views product - record version&quot;&quot;&quot;</span>
<a id="__codelineno-67-103" name="__codelineno-67-103" href="#__codelineno-67-103"></a>        <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
<a id="__codelineno-67-104" name="__codelineno-67-104" href="#__codelineno-67-104"></a>
<a id="__codelineno-67-105" name="__codelineno-67-105" href="#__codelineno-67-105"></a>        <span class="c1"># Read product data</span>
<a id="__codelineno-67-106" name="__codelineno-67-106" href="#__codelineno-67-106"></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-107" name="__codelineno-67-107" href="#__codelineno-67-107"></a><span class="s2">            SELECT id, name, price, stock, version </span>
<a id="__codelineno-67-108" name="__codelineno-67-108" href="#__codelineno-67-108"></a><span class="s2">            FROM products WHERE id = ?</span>
<a id="__codelineno-67-109" name="__codelineno-67-109" href="#__codelineno-67-109"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-67-110" name="__codelineno-67-110" href="#__codelineno-67-110"></a>
<a id="__codelineno-67-111" name="__codelineno-67-111" href="#__codelineno-67-111"></a>        <span class="c1"># Return to user with hidden version field</span>
<a id="__codelineno-67-112" name="__codelineno-67-112" href="#__codelineno-67-112"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-67-113" name="__codelineno-67-113" href="#__codelineno-67-113"></a>            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
<a id="__codelineno-67-114" name="__codelineno-67-114" href="#__codelineno-67-114"></a>            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-67-115" name="__codelineno-67-115" href="#__codelineno-67-115"></a>            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
<a id="__codelineno-67-116" name="__codelineno-67-116" href="#__codelineno-67-116"></a>            <span class="s1">&#39;stock&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;stock&#39;</span><span class="p">],</span>
<a id="__codelineno-67-117" name="__codelineno-67-117" href="#__codelineno-67-117"></a>            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>  <span class="c1"># Hidden field in form</span>
<a id="__codelineno-67-118" name="__codelineno-67-118" href="#__codelineno-67-118"></a>        <span class="p">}</span>
<a id="__codelineno-67-119" name="__codelineno-67-119" href="#__codelineno-67-119"></a>
<a id="__codelineno-67-120" name="__codelineno-67-120" href="#__codelineno-67-120"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">version_from_form</span><span class="p">):</span>
<a id="__codelineno-67-121" name="__codelineno-67-121" href="#__codelineno-67-121"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Step 2: User submits order - validate version&quot;&quot;&quot;</span>
<a id="__codelineno-67-122" name="__codelineno-67-122" href="#__codelineno-67-122"></a>        <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
<a id="__codelineno-67-123" name="__codelineno-67-123" href="#__codelineno-67-123"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-67-124" name="__codelineno-67-124" href="#__codelineno-67-124"></a>
<a id="__codelineno-67-125" name="__codelineno-67-125" href="#__codelineno-67-125"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-67-126" name="__codelineno-67-126" href="#__codelineno-67-126"></a>            <span class="c1"># Update with version check</span>
<a id="__codelineno-67-127" name="__codelineno-67-127" href="#__codelineno-67-127"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-128" name="__codelineno-67-128" href="#__codelineno-67-128"></a><span class="s2">                UPDATE products </span>
<a id="__codelineno-67-129" name="__codelineno-67-129" href="#__codelineno-67-129"></a><span class="s2">                SET stock = stock - ?, version = version + 1</span>
<a id="__codelineno-67-130" name="__codelineno-67-130" href="#__codelineno-67-130"></a><span class="s2">                WHERE id = ? AND version = ? AND stock &gt;= ?</span>
<a id="__codelineno-67-131" name="__codelineno-67-131" href="#__codelineno-67-131"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">quantity</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">version_from_form</span><span class="p">,</span> <span class="n">quantity</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-67-132" name="__codelineno-67-132" href="#__codelineno-67-132"></a>
<a id="__codelineno-67-133" name="__codelineno-67-133" href="#__codelineno-67-133"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-67-134" name="__codelineno-67-134" href="#__codelineno-67-134"></a>                <span class="c1"># Conflict! Either:</span>
<a id="__codelineno-67-135" name="__codelineno-67-135" href="#__codelineno-67-135"></a>                <span class="c1"># 1. Version changed (someone else bought)</span>
<a id="__codelineno-67-136" name="__codelineno-67-136" href="#__codelineno-67-136"></a>                <span class="c1"># 2. Insufficient stock</span>
<a id="__codelineno-67-137" name="__codelineno-67-137" href="#__codelineno-67-137"></a>                <span class="n">current</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-138" name="__codelineno-67-138" href="#__codelineno-67-138"></a><span class="s2">                    SELECT stock, version FROM products WHERE id = ?</span>
<a id="__codelineno-67-139" name="__codelineno-67-139" href="#__codelineno-67-139"></a><span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-67-140" name="__codelineno-67-140" href="#__codelineno-67-140"></a>
<a id="__codelineno-67-141" name="__codelineno-67-141" href="#__codelineno-67-141"></a>                <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">version_from_form</span><span class="p">:</span>
<a id="__codelineno-67-142" name="__codelineno-67-142" href="#__codelineno-67-142"></a>                    <span class="k">raise</span> <span class="n">OptimisticLockError</span><span class="p">(</span>
<a id="__codelineno-67-143" name="__codelineno-67-143" href="#__codelineno-67-143"></a>                        <span class="s2">&quot;Product was modified by another user. Please refresh.&quot;</span>
<a id="__codelineno-67-144" name="__codelineno-67-144" href="#__codelineno-67-144"></a>                    <span class="p">)</span>
<a id="__codelineno-67-145" name="__codelineno-67-145" href="#__codelineno-67-145"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-67-146" name="__codelineno-67-146" href="#__codelineno-67-146"></a>                    <span class="k">raise</span> <span class="n">OutOfStockError</span><span class="p">(</span><span class="s2">&quot;Insufficient stock&quot;</span><span class="p">)</span>
<a id="__codelineno-67-147" name="__codelineno-67-147" href="#__codelineno-67-147"></a>
<a id="__codelineno-67-148" name="__codelineno-67-148" href="#__codelineno-67-148"></a>            <span class="c1"># Create order</span>
<a id="__codelineno-67-149" name="__codelineno-67-149" href="#__codelineno-67-149"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-150" name="__codelineno-67-150" href="#__codelineno-67-150"></a><span class="s2">                INSERT INTO orders (product_id, quantity, timestamp)</span>
<a id="__codelineno-67-151" name="__codelineno-67-151" href="#__codelineno-67-151"></a><span class="s2">                VALUES (?, ?, ?)</span>
<a id="__codelineno-67-152" name="__codelineno-67-152" href="#__codelineno-67-152"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">now</span><span class="p">()])</span>
<a id="__codelineno-67-153" name="__codelineno-67-153" href="#__codelineno-67-153"></a>
<a id="__codelineno-67-154" name="__codelineno-67-154" href="#__codelineno-67-154"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-67-155" name="__codelineno-67-155" href="#__codelineno-67-155"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-67-156" name="__codelineno-67-156" href="#__codelineno-67-156"></a>
<a id="__codelineno-67-157" name="__codelineno-67-157" href="#__codelineno-67-157"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-67-158" name="__codelineno-67-158" href="#__codelineno-67-158"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-159" name="__codelineno-67-159" href="#__codelineno-67-159"></a>            <span class="k">raise</span>
<a id="__codelineno-67-160" name="__codelineno-67-160" href="#__codelineno-67-160"></a>
<a id="__codelineno-67-161" name="__codelineno-67-161" href="#__codelineno-67-161"></a>
<a id="__codelineno-67-162" name="__codelineno-67-162" href="#__codelineno-67-162"></a><span class="c1"># Example 4: Optimistic Locking with Retry Logic</span>
<a id="__codelineno-67-163" name="__codelineno-67-163" href="#__codelineno-67-163"></a>
<a id="__codelineno-67-164" name="__codelineno-67-164" href="#__codelineno-67-164"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimistic_with_retry</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-67-165" name="__codelineno-67-165" href="#__codelineno-67-165"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Withdraw with automatic retry on conflict&quot;&quot;&quot;</span>
<a id="__codelineno-67-166" name="__codelineno-67-166" href="#__codelineno-67-166"></a>
<a id="__codelineno-67-167" name="__codelineno-67-167" href="#__codelineno-67-167"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">5</span>
<a id="__codelineno-67-168" name="__codelineno-67-168" href="#__codelineno-67-168"></a>    <span class="n">backoff_ms</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Initial backoff</span>
<a id="__codelineno-67-169" name="__codelineno-67-169" href="#__codelineno-67-169"></a>
<a id="__codelineno-67-170" name="__codelineno-67-170" href="#__codelineno-67-170"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-67-171" name="__codelineno-67-171" href="#__codelineno-67-171"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-67-172" name="__codelineno-67-172" href="#__codelineno-67-172"></a>            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-67-173" name="__codelineno-67-173" href="#__codelineno-67-173"></a>
<a id="__codelineno-67-174" name="__codelineno-67-174" href="#__codelineno-67-174"></a>            <span class="c1"># Read without locks</span>
<a id="__codelineno-67-175" name="__codelineno-67-175" href="#__codelineno-67-175"></a>            <span class="n">balance</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-176" name="__codelineno-67-176" href="#__codelineno-67-176"></a><span class="s2">                SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-67-177" name="__codelineno-67-177" href="#__codelineno-67-177"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-67-178" name="__codelineno-67-178" href="#__codelineno-67-178"></a>
<a id="__codelineno-67-179" name="__codelineno-67-179" href="#__codelineno-67-179"></a>            <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-67-180" name="__codelineno-67-180" href="#__codelineno-67-180"></a>                <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-67-181" name="__codelineno-67-181" href="#__codelineno-67-181"></a>
<a id="__codelineno-67-182" name="__codelineno-67-182" href="#__codelineno-67-182"></a>            <span class="c1"># Attempt update with version check</span>
<a id="__codelineno-67-183" name="__codelineno-67-183" href="#__codelineno-67-183"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-67-184" name="__codelineno-67-184" href="#__codelineno-67-184"></a><span class="s2">                UPDATE accounts </span>
<a id="__codelineno-67-185" name="__codelineno-67-185" href="#__codelineno-67-185"></a><span class="s2">                SET balance = balance - ?, version = version + 1</span>
<a id="__codelineno-67-186" name="__codelineno-67-186" href="#__codelineno-67-186"></a><span class="s2">                WHERE id = ? AND version = ?</span>
<a id="__codelineno-67-187" name="__codelineno-67-187" href="#__codelineno-67-187"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-67-188" name="__codelineno-67-188" href="#__codelineno-67-188"></a>
<a id="__codelineno-67-189" name="__codelineno-67-189" href="#__codelineno-67-189"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-67-190" name="__codelineno-67-190" href="#__codelineno-67-190"></a>                <span class="c1"># Conflict - retry with exponential backoff</span>
<a id="__codelineno-67-191" name="__codelineno-67-191" href="#__codelineno-67-191"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-192" name="__codelineno-67-192" href="#__codelineno-67-192"></a>                <span class="n">sleep</span><span class="p">(</span><span class="n">backoff_ms</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
<a id="__codelineno-67-193" name="__codelineno-67-193" href="#__codelineno-67-193"></a>                <span class="n">backoff_ms</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Exponential backoff</span>
<a id="__codelineno-67-194" name="__codelineno-67-194" href="#__codelineno-67-194"></a>                <span class="k">continue</span>
<a id="__codelineno-67-195" name="__codelineno-67-195" href="#__codelineno-67-195"></a>
<a id="__codelineno-67-196" name="__codelineno-67-196" href="#__codelineno-67-196"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-67-197" name="__codelineno-67-197" href="#__codelineno-67-197"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-67-198" name="__codelineno-67-198" href="#__codelineno-67-198"></a>
<a id="__codelineno-67-199" name="__codelineno-67-199" href="#__codelineno-67-199"></a>        <span class="k">except</span> <span class="n">InsufficientFundsError</span><span class="p">:</span>
<a id="__codelineno-67-200" name="__codelineno-67-200" href="#__codelineno-67-200"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-201" name="__codelineno-67-201" href="#__codelineno-67-201"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-67-202" name="__codelineno-67-202" href="#__codelineno-67-202"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-67-203" name="__codelineno-67-203" href="#__codelineno-67-203"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-67-204" name="__codelineno-67-204" href="#__codelineno-67-204"></a>            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-67-205" name="__codelineno-67-205" href="#__codelineno-67-205"></a>                <span class="k">raise</span>  <span class="c1"># Give up after max retries</span>
<a id="__codelineno-67-206" name="__codelineno-67-206" href="#__codelineno-67-206"></a>
<a id="__codelineno-67-207" name="__codelineno-67-207" href="#__codelineno-67-207"></a>    <span class="k">raise</span> <span class="n">MaxRetriesExceededError</span><span class="p">()</span>
</code></pre></div>
<p><strong>Advantages:</strong>
-  <strong>No blocking</strong> - transactions don't wait for locks
-  <strong>High concurrency</strong> - multiple transactions can read/modify simultaneously
-  <strong>No deadlocks</strong> - no locks means no circular dependencies
-  <strong>Better performance</strong> - in low-contention scenarios
-  <strong>Scalability</strong> - works well in distributed systems</p>
<p><strong>Disadvantages:</strong>
-  <strong>Wasted work</strong> - transactions may be aborted and retried
-  <strong>Retry overhead</strong> - conflict detection and retry logic required
-  <strong>Starvation</strong> - transaction may repeatedly fail in high contention
-  <strong>Complex error handling</strong> - application must handle conflicts gracefully
-  <strong>Not suitable for high contention</strong> - too many retries degrade performance</p>
<hr />
<h4 id="421-why-optimistic-concurrency-control-is-not-useful-all-the-time">4.2.1 Why Optimistic Concurrency Control is NOT Useful All the Time</h4>
<p><strong>Description:</strong></p>
<p>While Optimistic Concurrency Control (OCC) offers significant advantages in low-contention scenarios, it is <strong>not a silver bullet</strong> and can actually be <strong>detrimental</strong> in certain situations. Understanding when OCC fails is crucial for making the right architectural decisions.</p>
<p><strong>Critical Scenarios Where OCC Fails:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>     WHY OPTIMISTIC CONTROL FAILS IN SOME SCENARIOS      
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>                                                         
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a> 1. HIGH CONTENTION ENVIRONMENTS                         
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>          
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>  Problem: Many transactions compete for              
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>           same data simultaneously                   
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>                                                      
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>  What Happens:                                       
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>   Most transactions fail validation                 
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>   Repeated retries waste CPU/memory                 
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>   Retry storm cascades exponentially                
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>   System thrashes, throughput collapses             
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>                                                      
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>  Examples:                                           
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>  - Flash sales (limited inventory)                   
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>  - Ticket booking (popular events)                   
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>  - Banking transfers (same accounts)                 
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>  - Seat reservations (limited capacity)              
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>                                                      
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>  Why Pessimistic is Better:                          
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>   First transaction gets lock and proceeds          
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>   Others wait in orderly queue                      
<a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>   No wasted work from retries                       
<a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a>   Predictable, fair processing                      
<a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>          
<a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a>                                                         
<a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a> 2. LONG-RUNNING TRANSACTIONS                            
<a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a>          
<a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a>  Problem: Longer transactions have higher            
<a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a>           probability of conflicts                   
<a id="__codelineno-68-33" name="__codelineno-68-33" href="#__codelineno-68-33"></a>                                                      
<a id="__codelineno-68-34" name="__codelineno-68-34" href="#__codelineno-68-34"></a>  What Happens:                                       
<a id="__codelineno-68-35" name="__codelineno-68-35" href="#__codelineno-68-35"></a>   Transaction runs for seconds/minutes              
<a id="__codelineno-68-36" name="__codelineno-68-36" href="#__codelineno-68-36"></a>   High chance someone modifies same data            
<a id="__codelineno-68-37" name="__codelineno-68-37" href="#__codelineno-68-37"></a>   Validation fails after long computation           
<a id="__codelineno-68-38" name="__codelineno-68-38" href="#__codelineno-68-38"></a>   All work discarded, must restart                 
<a id="__codelineno-68-39" name="__codelineno-68-39" href="#__codelineno-68-39"></a>                                                      
<a id="__codelineno-68-40" name="__codelineno-68-40" href="#__codelineno-68-40"></a>  Examples:                                           
<a id="__codelineno-68-41" name="__codelineno-68-41" href="#__codelineno-68-41"></a>  - Batch processing jobs                             
<a id="__codelineno-68-42" name="__codelineno-68-42" href="#__codelineno-68-42"></a>  - Complex calculations                              
<a id="__codelineno-68-43" name="__codelineno-68-43" href="#__codelineno-68-43"></a>  - Multi-step workflows                              
<a id="__codelineno-68-44" name="__codelineno-68-44" href="#__codelineno-68-44"></a>  - Report generation with updates                    
<a id="__codelineno-68-45" name="__codelineno-68-45" href="#__codelineno-68-45"></a>                                                      
<a id="__codelineno-68-46" name="__codelineno-68-46" href="#__codelineno-68-46"></a>  Math:                                               
<a id="__codelineno-68-47" name="__codelineno-68-47" href="#__codelineno-68-47"></a>  Conflict Probability  Transaction Duration         
<a id="__codelineno-68-48" name="__codelineno-68-48" href="#__codelineno-68-48"></a>  1 sec transaction: ~5% conflict rate                
<a id="__codelineno-68-49" name="__codelineno-68-49" href="#__codelineno-68-49"></a>  10 sec transaction: ~40% conflict rate              
<a id="__codelineno-68-50" name="__codelineno-68-50" href="#__codelineno-68-50"></a>  60 sec transaction: ~95% conflict rate              
<a id="__codelineno-68-51" name="__codelineno-68-51" href="#__codelineno-68-51"></a>          
<a id="__codelineno-68-52" name="__codelineno-68-52" href="#__codelineno-68-52"></a>                                                         
<a id="__codelineno-68-53" name="__codelineno-68-53" href="#__codelineno-68-53"></a> 3. WRITE-HEAVY WORKLOADS                                
<a id="__codelineno-68-54" name="__codelineno-68-54" href="#__codelineno-68-54"></a>          
<a id="__codelineno-68-55" name="__codelineno-68-55" href="#__codelineno-68-55"></a>  Problem: Most operations are writes, not            
<a id="__codelineno-68-56" name="__codelineno-68-56" href="#__codelineno-68-56"></a>           reads                                      
<a id="__codelineno-68-57" name="__codelineno-68-57" href="#__codelineno-68-57"></a>                                                      
<a id="__codelineno-68-58" name="__codelineno-68-58" href="#__codelineno-68-58"></a>  What Happens:                                       
<a id="__codelineno-68-59" name="__codelineno-68-59" href="#__codelineno-68-59"></a>   Every write conflicts with other writes           
<a id="__codelineno-68-60" name="__codelineno-68-60" href="#__codelineno-68-60"></a>   No benefit from lock-free reads                   
<a id="__codelineno-68-61" name="__codelineno-68-61" href="#__codelineno-68-61"></a>   Constant validation failures                      
<a id="__codelineno-68-62" name="__codelineno-68-62" href="#__codelineno-68-62"></a>   Retry overhead dominates performance              
<a id="__codelineno-68-63" name="__codelineno-68-63" href="#__codelineno-68-63"></a>                                                      
<a id="__codelineno-68-64" name="__codelineno-68-64" href="#__codelineno-68-64"></a>  Examples:                                           
<a id="__codelineno-68-65" name="__codelineno-68-65" href="#__codelineno-68-65"></a>  - Real-time sensor data ingestion                   
<a id="__codelineno-68-66" name="__codelineno-68-66" href="#__codelineno-68-66"></a>  - High-frequency trading systems                    
<a id="__codelineno-68-67" name="__codelineno-68-67" href="#__codelineno-68-67"></a>  - Log aggregation systems                           
<a id="__codelineno-68-68" name="__codelineno-68-68" href="#__codelineno-68-68"></a>  - Counter/metrics updates                           
<a id="__codelineno-68-69" name="__codelineno-68-69" href="#__codelineno-68-69"></a>                                                      
<a id="__codelineno-68-70" name="__codelineno-68-70" href="#__codelineno-68-70"></a>  OCC Sweet Spot: 90% reads, 10% writes               
<a id="__codelineno-68-71" name="__codelineno-68-71" href="#__codelineno-68-71"></a>  OCC Nightmare: 10% reads, 90% writes                
<a id="__codelineno-68-72" name="__codelineno-68-72" href="#__codelineno-68-72"></a>          
<a id="__codelineno-68-73" name="__codelineno-68-73" href="#__codelineno-68-73"></a>                                                         
<a id="__codelineno-68-74" name="__codelineno-68-74" href="#__codelineno-68-74"></a> 4. CRITICAL DATA / HIGH COST OF FAILURE                 
<a id="__codelineno-68-75" name="__codelineno-68-75" href="#__codelineno-68-75"></a>          
<a id="__codelineno-68-76" name="__codelineno-68-76" href="#__codelineno-68-76"></a>  Problem: Failed transactions are expensive          
<a id="__codelineno-68-77" name="__codelineno-68-77" href="#__codelineno-68-77"></a>           or unacceptable                            
<a id="__codelineno-68-78" name="__codelineno-68-78" href="#__codelineno-68-78"></a>                                                      
<a id="__codelineno-68-79" name="__codelineno-68-79" href="#__codelineno-68-79"></a>  What Happens:                                       
<a id="__codelineno-68-80" name="__codelineno-68-80" href="#__codelineno-68-80"></a>   Retry wastes expensive resources                  
<a id="__codelineno-68-81" name="__codelineno-68-81" href="#__codelineno-68-81"></a>   External API calls already made                   
<a id="__codelineno-68-82" name="__codelineno-68-82" href="#__codelineno-68-82"></a>   Payment authorization consumed                    
<a id="__codelineno-68-83" name="__codelineno-68-83" href="#__codelineno-68-83"></a>   Time-sensitive operations missed                  
<a id="__codelineno-68-84" name="__codelineno-68-84" href="#__codelineno-68-84"></a>                                                      
<a id="__codelineno-68-85" name="__codelineno-68-85" href="#__codelineno-68-85"></a>  Examples:                                           
<a id="__codelineno-68-86" name="__codelineno-68-86" href="#__codelineno-68-86"></a>  - Financial transactions (money movement)           
<a id="__codelineno-68-87" name="__codelineno-68-87" href="#__codelineno-68-87"></a>  - Inventory management (prevent oversell)           
<a id="__codelineno-68-88" name="__codelineno-68-88" href="#__codelineno-68-88"></a>  - Medical records (accuracy critical)               
<a id="__codelineno-68-89" name="__codelineno-68-89" href="#__codelineno-68-89"></a>  - Legal documents (audit trail required)            
<a id="__codelineno-68-90" name="__codelineno-68-90" href="#__codelineno-68-90"></a>                                                      
<a id="__codelineno-68-91" name="__codelineno-68-91" href="#__codelineno-68-91"></a>  Why Pessimistic is Better:                          
<a id="__codelineno-68-92" name="__codelineno-68-92" href="#__codelineno-68-92"></a>   Guaranteed success (no retries needed)            
<a id="__codelineno-68-93" name="__codelineno-68-93" href="#__codelineno-68-93"></a>   Predictable behavior                              
<a id="__codelineno-68-94" name="__codelineno-68-94" href="#__codelineno-68-94"></a>   No risk of repeated failures                      
<a id="__codelineno-68-95" name="__codelineno-68-95" href="#__codelineno-68-95"></a>          
<a id="__codelineno-68-96" name="__codelineno-68-96" href="#__codelineno-68-96"></a>                                                         
<a id="__codelineno-68-97" name="__codelineno-68-97" href="#__codelineno-68-97"></a> 5. RETRY STORMS AND CASCADING FAILURES                  
<a id="__codelineno-68-98" name="__codelineno-68-98" href="#__codelineno-68-98"></a>          
<a id="__codelineno-68-99" name="__codelineno-68-99" href="#__codelineno-68-99"></a>  Problem: Failed validations trigger more            
<a id="__codelineno-68-100" name="__codelineno-68-100" href="#__codelineno-68-100"></a>           retries, creating vicious cycle            
<a id="__codelineno-68-101" name="__codelineno-68-101" href="#__codelineno-68-101"></a>                                                      
<a id="__codelineno-68-102" name="__codelineno-68-102" href="#__codelineno-68-102"></a>  What Happens:                                       
<a id="__codelineno-68-103" name="__codelineno-68-103" href="#__codelineno-68-103"></a>   100 transactions attempt same update              
<a id="__codelineno-68-104" name="__codelineno-68-104" href="#__codelineno-68-104"></a>   1 succeeds, 99 retry                              
<a id="__codelineno-68-105" name="__codelineno-68-105" href="#__codelineno-68-105"></a>   99 retry  1 succeeds, 98 retry again             
<a id="__codelineno-68-106" name="__codelineno-68-106" href="#__codelineno-68-106"></a>   Exponential backlog builds up                     
<a id="__codelineno-68-107" name="__codelineno-68-107" href="#__codelineno-68-107"></a>   System overload, response times spike             
<a id="__codelineno-68-108" name="__codelineno-68-108" href="#__codelineno-68-108"></a>   Eventually: complete system failure               
<a id="__codelineno-68-109" name="__codelineno-68-109" href="#__codelineno-68-109"></a>                                                      
<a id="__codelineno-68-110" name="__codelineno-68-110" href="#__codelineno-68-110"></a>  Example Scenario:                                   
<a id="__codelineno-68-111" name="__codelineno-68-111" href="#__codelineno-68-111"></a>  Concert ticket sale: 10,000 users, 100 seats        
<a id="__codelineno-68-112" name="__codelineno-68-112" href="#__codelineno-68-112"></a>   All 10,000 read available=100                     
<a id="__codelineno-68-113" name="__codelineno-68-113" href="#__codelineno-68-113"></a>   All attempt purchase simultaneously               
<a id="__codelineno-68-114" name="__codelineno-68-114" href="#__codelineno-68-114"></a>   100 succeed, 9,900 retry                          
<a id="__codelineno-68-115" name="__codelineno-68-115" href="#__codelineno-68-115"></a>   9,900 retry storm crashes system                  
<a id="__codelineno-68-116" name="__codelineno-68-116" href="#__codelineno-68-116"></a>                                                      
<a id="__codelineno-68-117" name="__codelineno-68-117" href="#__codelineno-68-117"></a>  With Pessimistic:                                   
<a id="__codelineno-68-118" name="__codelineno-68-118" href="#__codelineno-68-118"></a>   100 get locks, proceed                            
<a id="__codelineno-68-119" name="__codelineno-68-119" href="#__codelineno-68-119"></a>   9,900 wait in queue (orderly)                     
<a id="__codelineno-68-120" name="__codelineno-68-120" href="#__codelineno-68-120"></a>   System remains stable                             
<a id="__codelineno-68-121" name="__codelineno-68-121" href="#__codelineno-68-121"></a>          
<a id="__codelineno-68-122" name="__codelineno-68-122" href="#__codelineno-68-122"></a>                                                         
<a id="__codelineno-68-123" name="__codelineno-68-123" href="#__codelineno-68-123"></a> 6. LACK OF RETRY INFRASTRUCTURE                         
<a id="__codelineno-68-124" name="__codelineno-68-124" href="#__codelineno-68-124"></a>          
<a id="__codelineno-68-125" name="__codelineno-68-125" href="#__codelineno-68-125"></a>  Problem: Application not designed for               
<a id="__codelineno-68-126" name="__codelineno-68-126" href="#__codelineno-68-126"></a>           handling failures and retries              
<a id="__codelineno-68-127" name="__codelineno-68-127" href="#__codelineno-68-127"></a>                                                      
<a id="__codelineno-68-128" name="__codelineno-68-128" href="#__codelineno-68-128"></a>  What&#39;s Missing:                                     
<a id="__codelineno-68-129" name="__codelineno-68-129" href="#__codelineno-68-129"></a>   No retry logic implemented                        
<a id="__codelineno-68-130" name="__codelineno-68-130" href="#__codelineno-68-130"></a>   No exponential backoff                            
<a id="__codelineno-68-131" name="__codelineno-68-131" href="#__codelineno-68-131"></a>   No max retry limits                               
<a id="__codelineno-68-132" name="__codelineno-68-132" href="#__codelineno-68-132"></a>   No conflict error handling                        
<a id="__codelineno-68-133" name="__codelineno-68-133" href="#__codelineno-68-133"></a>   No user feedback on conflicts                     
<a id="__codelineno-68-134" name="__codelineno-68-134" href="#__codelineno-68-134"></a>                                                      
<a id="__codelineno-68-135" name="__codelineno-68-135" href="#__codelineno-68-135"></a>  Consequences:                                       
<a id="__codelineno-68-136" name="__codelineno-68-136" href="#__codelineno-68-136"></a>   Transactions fail permanently                     
<a id="__codelineno-68-137" name="__codelineno-68-137" href="#__codelineno-68-137"></a>   Users see cryptic error messages                  
<a id="__codelineno-68-138" name="__codelineno-68-138" href="#__codelineno-68-138"></a>   Data inconsistencies arise                        
<a id="__codelineno-68-139" name="__codelineno-68-139" href="#__codelineno-68-139"></a>   Poor user experience                              
<a id="__codelineno-68-140" name="__codelineno-68-140" href="#__codelineno-68-140"></a>          
<a id="__codelineno-68-141" name="__codelineno-68-141" href="#__codelineno-68-141"></a>                                                         
<a id="__codelineno-68-142" name="__codelineno-68-142" href="#__codelineno-68-142"></a>
</code></pre></div>
<p><strong>Real-World Failure Examples:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># FAILURE EXAMPLE 1: Flash Sale (High Contention)</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="c1"># Scenario: 10,000 users buying 1 limited edition item</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">buy_limited_item_optimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="sd">    PROBLEM: Only 1 item available, 10,000 concurrent buyers</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="sd">    Result: 9,999 retries, system collapse</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>            <span class="c1"># Read inventory with version</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a>            <span class="n">stock</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="s2">                SELECT stock, version FROM products WHERE id = ?</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a>            <span class="k">if</span> <span class="n">stock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;sold_out&quot;</span><span class="p">}</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a>            <span class="c1"># Attempt to reserve</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="s2">                UPDATE products </span>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="s2">                SET stock = stock - 1, version = version + 1</span>
<a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="s2">                WHERE id = ? AND version = ? AND stock &gt; 0</span>
<a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a>
<a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a>                <span class="c1"># CONFLICT! 9,999 out of 10,000 will hit this</span>
<a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a>                <span class="c1"># All 9,999 retry simultaneously</span>
<a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a>                <span class="c1">#  Server CPU spikes to 100%</span>
<a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a>                <span class="c1">#  Response times go from 10ms to 30 seconds</span>
<a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a>                <span class="c1">#  Users frustrated, refresh page</span>
<a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a>                <span class="c1">#  Even more concurrent requests</span>
<a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a>                <span class="c1">#  SYSTEM CRASH</span>
<a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a>                <span class="k">continue</span>
<a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a>
<a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a>            <span class="c1"># Create order (only 1 out of 10,000 gets here first time)</span>
<a id="__codelineno-69-42" name="__codelineno-69-42" href="#__codelineno-69-42"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-43" name="__codelineno-69-43" href="#__codelineno-69-43"></a><span class="s2">                INSERT INTO orders (product_id, user_id)</span>
<a id="__codelineno-69-44" name="__codelineno-69-44" href="#__codelineno-69-44"></a><span class="s2">                VALUES (?, ?)</span>
<a id="__codelineno-69-45" name="__codelineno-69-45" href="#__codelineno-69-45"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">])</span>
<a id="__codelineno-69-46" name="__codelineno-69-46" href="#__codelineno-69-46"></a>
<a id="__codelineno-69-47" name="__codelineno-69-47" href="#__codelineno-69-47"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-48" name="__codelineno-69-48" href="#__codelineno-69-48"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-69-49" name="__codelineno-69-49" href="#__codelineno-69-49"></a>
<a id="__codelineno-69-50" name="__codelineno-69-50" href="#__codelineno-69-50"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-69-51" name="__codelineno-69-51" href="#__codelineno-69-51"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-52" name="__codelineno-69-52" href="#__codelineno-69-52"></a>
<a id="__codelineno-69-53" name="__codelineno-69-53" href="#__codelineno-69-53"></a>    <span class="c1"># 9,999 users exhaust retries and see error</span>
<a id="__codelineno-69-54" name="__codelineno-69-54" href="#__codelineno-69-54"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;too_many_retries&quot;</span><span class="p">}</span>
<a id="__codelineno-69-55" name="__codelineno-69-55" href="#__codelineno-69-55"></a>
<a id="__codelineno-69-56" name="__codelineno-69-56" href="#__codelineno-69-56"></a>
<a id="__codelineno-69-57" name="__codelineno-69-57" href="#__codelineno-69-57"></a><span class="c1"># BETTER SOLUTION: Pessimistic Locking</span>
<a id="__codelineno-69-58" name="__codelineno-69-58" href="#__codelineno-69-58"></a>
<a id="__codelineno-69-59" name="__codelineno-69-59" href="#__codelineno-69-59"></a><span class="k">def</span><span class="w"> </span><span class="nf">buy_limited_item_pessimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-69-60" name="__codelineno-69-60" href="#__codelineno-69-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-61" name="__codelineno-69-61" href="#__codelineno-69-61"></a><span class="sd">    SOLUTION: Lock inventory row immediately</span>
<a id="__codelineno-69-62" name="__codelineno-69-62" href="#__codelineno-69-62"></a><span class="sd">    Result: Orderly queue, predictable behavior</span>
<a id="__codelineno-69-63" name="__codelineno-69-63" href="#__codelineno-69-63"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-64" name="__codelineno-69-64" href="#__codelineno-69-64"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-65" name="__codelineno-69-65" href="#__codelineno-69-65"></a>
<a id="__codelineno-69-66" name="__codelineno-69-66" href="#__codelineno-69-66"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-69-67" name="__codelineno-69-67" href="#__codelineno-69-67"></a>        <span class="c1"># LOCK row immediately (FOR UPDATE)</span>
<a id="__codelineno-69-68" name="__codelineno-69-68" href="#__codelineno-69-68"></a>        <span class="n">stock</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-69" name="__codelineno-69-69" href="#__codelineno-69-69"></a><span class="s2">            SELECT stock FROM products </span>
<a id="__codelineno-69-70" name="__codelineno-69-70" href="#__codelineno-69-70"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-69-71" name="__codelineno-69-71" href="#__codelineno-69-71"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-69-72" name="__codelineno-69-72" href="#__codelineno-69-72"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-69-73" name="__codelineno-69-73" href="#__codelineno-69-73"></a>
<a id="__codelineno-69-74" name="__codelineno-69-74" href="#__codelineno-69-74"></a>        <span class="c1"># First 1 user gets lock and proceeds</span>
<a id="__codelineno-69-75" name="__codelineno-69-75" href="#__codelineno-69-75"></a>        <span class="c1"># Other 9,999 wait in database queue (not all retrying!)</span>
<a id="__codelineno-69-76" name="__codelineno-69-76" href="#__codelineno-69-76"></a>
<a id="__codelineno-69-77" name="__codelineno-69-77" href="#__codelineno-69-77"></a>        <span class="k">if</span> <span class="n">stock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-69-78" name="__codelineno-69-78" href="#__codelineno-69-78"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-79" name="__codelineno-69-79" href="#__codelineno-69-79"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;sold_out&quot;</span><span class="p">}</span>
<a id="__codelineno-69-80" name="__codelineno-69-80" href="#__codelineno-69-80"></a>
<a id="__codelineno-69-81" name="__codelineno-69-81" href="#__codelineno-69-81"></a>        <span class="c1"># Decrement stock</span>
<a id="__codelineno-69-82" name="__codelineno-69-82" href="#__codelineno-69-82"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-83" name="__codelineno-69-83" href="#__codelineno-69-83"></a><span class="s2">            UPDATE products SET stock = stock - 1 WHERE id = ?</span>
<a id="__codelineno-69-84" name="__codelineno-69-84" href="#__codelineno-69-84"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">])</span>
<a id="__codelineno-69-85" name="__codelineno-69-85" href="#__codelineno-69-85"></a>
<a id="__codelineno-69-86" name="__codelineno-69-86" href="#__codelineno-69-86"></a>        <span class="c1"># Create order</span>
<a id="__codelineno-69-87" name="__codelineno-69-87" href="#__codelineno-69-87"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-88" name="__codelineno-69-88" href="#__codelineno-69-88"></a><span class="s2">            INSERT INTO orders (product_id, user_id)</span>
<a id="__codelineno-69-89" name="__codelineno-69-89" href="#__codelineno-69-89"></a><span class="s2">            VALUES (?, ?)</span>
<a id="__codelineno-69-90" name="__codelineno-69-90" href="#__codelineno-69-90"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">product_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">])</span>
<a id="__codelineno-69-91" name="__codelineno-69-91" href="#__codelineno-69-91"></a>
<a id="__codelineno-69-92" name="__codelineno-69-92" href="#__codelineno-69-92"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-93" name="__codelineno-69-93" href="#__codelineno-69-93"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-69-94" name="__codelineno-69-94" href="#__codelineno-69-94"></a>
<a id="__codelineno-69-95" name="__codelineno-69-95" href="#__codelineno-69-95"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-69-96" name="__codelineno-69-96" href="#__codelineno-69-96"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-97" name="__codelineno-69-97" href="#__codelineno-69-97"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-69-98" name="__codelineno-69-98" href="#__codelineno-69-98"></a>
<a id="__codelineno-69-99" name="__codelineno-69-99" href="#__codelineno-69-99"></a>
<a id="__codelineno-69-100" name="__codelineno-69-100" href="#__codelineno-69-100"></a><span class="c1"># PERFORMANCE COMPARISON:</span>
<a id="__codelineno-69-101" name="__codelineno-69-101" href="#__codelineno-69-101"></a>
<a id="__codelineno-69-102" name="__codelineno-69-102" href="#__codelineno-69-102"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-103" name="__codelineno-69-103" href="#__codelineno-69-103"></a><span class="sd">Flash Sale: 10,000 concurrent users, 1 item</span>
<a id="__codelineno-69-104" name="__codelineno-69-104" href="#__codelineno-69-104"></a>
<a id="__codelineno-69-105" name="__codelineno-69-105" href="#__codelineno-69-105"></a><span class="sd">Optimistic Locking:</span>
<a id="__codelineno-69-106" name="__codelineno-69-106" href="#__codelineno-69-106"></a><span class="sd"> Successful transactions: 1</span>
<a id="__codelineno-69-107" name="__codelineno-69-107" href="#__codelineno-69-107"></a><span class="sd"> Failed validations: 9,999 (first attempt)</span>
<a id="__codelineno-69-108" name="__codelineno-69-108" href="#__codelineno-69-108"></a><span class="sd"> Total retries: ~50,000+ (with exponential backoff)</span>
<a id="__codelineno-69-109" name="__codelineno-69-109" href="#__codelineno-69-109"></a><span class="sd"> Database load: EXTREME (constant read-validate-retry)</span>
<a id="__codelineno-69-110" name="__codelineno-69-110" href="#__codelineno-69-110"></a><span class="sd"> Average response time: 15-45 seconds</span>
<a id="__codelineno-69-111" name="__codelineno-69-111" href="#__codelineno-69-111"></a><span class="sd"> Server CPU: 95-100%</span>
<a id="__codelineno-69-112" name="__codelineno-69-112" href="#__codelineno-69-112"></a><span class="sd"> Outcome: System crash or timeout</span>
<a id="__codelineno-69-113" name="__codelineno-69-113" href="#__codelineno-69-113"></a>
<a id="__codelineno-69-114" name="__codelineno-69-114" href="#__codelineno-69-114"></a><span class="sd">Pessimistic Locking:</span>
<a id="__codelineno-69-115" name="__codelineno-69-115" href="#__codelineno-69-115"></a><span class="sd"> Successful transactions: 1</span>
<a id="__codelineno-69-116" name="__codelineno-69-116" href="#__codelineno-69-116"></a><span class="sd"> Failed validations: 0</span>
<a id="__codelineno-69-117" name="__codelineno-69-117" href="#__codelineno-69-117"></a><span class="sd"> Total retries: 0</span>
<a id="__codelineno-69-118" name="__codelineno-69-118" href="#__codelineno-69-118"></a><span class="sd"> Database load: Moderate (sequential processing)</span>
<a id="__codelineno-69-119" name="__codelineno-69-119" href="#__codelineno-69-119"></a><span class="sd"> Average response time: 50-200ms (queue wait time)</span>
<a id="__codelineno-69-120" name="__codelineno-69-120" href="#__codelineno-69-120"></a><span class="sd"> Server CPU: 40-60%</span>
<a id="__codelineno-69-121" name="__codelineno-69-121" href="#__codelineno-69-121"></a><span class="sd"> Outcome: Stable, predictable</span>
<a id="__codelineno-69-122" name="__codelineno-69-122" href="#__codelineno-69-122"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-123" name="__codelineno-69-123" href="#__codelineno-69-123"></a>
<a id="__codelineno-69-124" name="__codelineno-69-124" href="#__codelineno-69-124"></a>
<a id="__codelineno-69-125" name="__codelineno-69-125" href="#__codelineno-69-125"></a><span class="c1"># FAILURE EXAMPLE 2: Long-Running Transaction</span>
<a id="__codelineno-69-126" name="__codelineno-69-126" href="#__codelineno-69-126"></a>
<a id="__codelineno-69-127" name="__codelineno-69-127" href="#__codelineno-69-127"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_complex_report_optimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<a id="__codelineno-69-128" name="__codelineno-69-128" href="#__codelineno-69-128"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-129" name="__codelineno-69-129" href="#__codelineno-69-129"></a><span class="sd">    PROBLEM: 5-minute transaction, high conflict probability</span>
<a id="__codelineno-69-130" name="__codelineno-69-130" href="#__codelineno-69-130"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-131" name="__codelineno-69-131" href="#__codelineno-69-131"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-132" name="__codelineno-69-132" href="#__codelineno-69-132"></a>
<a id="__codelineno-69-133" name="__codelineno-69-133" href="#__codelineno-69-133"></a>    <span class="c1"># Read data at start (record version)</span>
<a id="__codelineno-69-134" name="__codelineno-69-134" href="#__codelineno-69-134"></a>    <span class="n">data</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-135" name="__codelineno-69-135" href="#__codelineno-69-135"></a><span class="s2">        SELECT revenue, expenses, version </span>
<a id="__codelineno-69-136" name="__codelineno-69-136" href="#__codelineno-69-136"></a><span class="s2">        FROM monthly_summary </span>
<a id="__codelineno-69-137" name="__codelineno-69-137" href="#__codelineno-69-137"></a><span class="s2">        WHERE month = ? AND year = ?</span>
<a id="__codelineno-69-138" name="__codelineno-69-138" href="#__codelineno-69-138"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-69-139" name="__codelineno-69-139" href="#__codelineno-69-139"></a>
<a id="__codelineno-69-140" name="__codelineno-69-140" href="#__codelineno-69-140"></a>    <span class="c1"># Complex calculations (5 minutes)</span>
<a id="__codelineno-69-141" name="__codelineno-69-141" href="#__codelineno-69-141"></a>    <span class="c1"># Meanwhile, other transactions likely modified the data!</span>
<a id="__codelineno-69-142" name="__codelineno-69-142" href="#__codelineno-69-142"></a>    <span class="n">complex_analysis</span> <span class="o">=</span> <span class="n">perform_intensive_calculations</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 5 minutes</span>
<a id="__codelineno-69-143" name="__codelineno-69-143" href="#__codelineno-69-143"></a>    <span class="n">statistical_models</span> <span class="o">=</span> <span class="n">run_ml_models</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 3 minutes</span>
<a id="__codelineno-69-144" name="__codelineno-69-144" href="#__codelineno-69-144"></a>    <span class="n">generate_charts</span><span class="p">(</span><span class="n">complex_analysis</span><span class="p">)</span>  <span class="c1"># 2 minutes</span>
<a id="__codelineno-69-145" name="__codelineno-69-145" href="#__codelineno-69-145"></a>
<a id="__codelineno-69-146" name="__codelineno-69-146" href="#__codelineno-69-146"></a>    <span class="c1"># Try to save results (10 minutes of work)</span>
<a id="__codelineno-69-147" name="__codelineno-69-147" href="#__codelineno-69-147"></a>    <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-148" name="__codelineno-69-148" href="#__codelineno-69-148"></a><span class="s2">        UPDATE monthly_summary </span>
<a id="__codelineno-69-149" name="__codelineno-69-149" href="#__codelineno-69-149"></a><span class="s2">        SET analysis = ?, version = version + 1</span>
<a id="__codelineno-69-150" name="__codelineno-69-150" href="#__codelineno-69-150"></a><span class="s2">        WHERE month = ? AND year = ? AND version = ?</span>
<a id="__codelineno-69-151" name="__codelineno-69-151" href="#__codelineno-69-151"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">complex_analysis</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-69-152" name="__codelineno-69-152" href="#__codelineno-69-152"></a>
<a id="__codelineno-69-153" name="__codelineno-69-153" href="#__codelineno-69-153"></a>    <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-69-154" name="__codelineno-69-154" href="#__codelineno-69-154"></a>        <span class="c1"># VALIDATION FAILED!</span>
<a id="__codelineno-69-155" name="__codelineno-69-155" href="#__codelineno-69-155"></a>        <span class="c1"># 10 minutes of computation WASTED</span>
<a id="__codelineno-69-156" name="__codelineno-69-156" href="#__codelineno-69-156"></a>        <span class="c1"># Must start over from beginning</span>
<a id="__codelineno-69-157" name="__codelineno-69-157" href="#__codelineno-69-157"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-158" name="__codelineno-69-158" href="#__codelineno-69-158"></a>        <span class="c1"># User frustration: &quot;Why is this taking so long?&quot;</span>
<a id="__codelineno-69-159" name="__codelineno-69-159" href="#__codelineno-69-159"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;conflict&quot;</span><span class="p">}</span>
<a id="__codelineno-69-160" name="__codelineno-69-160" href="#__codelineno-69-160"></a>
<a id="__codelineno-69-161" name="__codelineno-69-161" href="#__codelineno-69-161"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-162" name="__codelineno-69-162" href="#__codelineno-69-162"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-69-163" name="__codelineno-69-163" href="#__codelineno-69-163"></a>
<a id="__codelineno-69-164" name="__codelineno-69-164" href="#__codelineno-69-164"></a>
<a id="__codelineno-69-165" name="__codelineno-69-165" href="#__codelineno-69-165"></a><span class="c1"># BETTER SOLUTION: Pessimistic Locking for Long Transactions</span>
<a id="__codelineno-69-166" name="__codelineno-69-166" href="#__codelineno-69-166"></a>
<a id="__codelineno-69-167" name="__codelineno-69-167" href="#__codelineno-69-167"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_complex_report_pessimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<a id="__codelineno-69-168" name="__codelineno-69-168" href="#__codelineno-69-168"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-169" name="__codelineno-69-169" href="#__codelineno-69-169"></a><span class="sd">    SOLUTION: Lock data at start of long transaction</span>
<a id="__codelineno-69-170" name="__codelineno-69-170" href="#__codelineno-69-170"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-171" name="__codelineno-69-171" href="#__codelineno-69-171"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-172" name="__codelineno-69-172" href="#__codelineno-69-172"></a>
<a id="__codelineno-69-173" name="__codelineno-69-173" href="#__codelineno-69-173"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-69-174" name="__codelineno-69-174" href="#__codelineno-69-174"></a>        <span class="c1"># LOCK row at start (FOR UPDATE)</span>
<a id="__codelineno-69-175" name="__codelineno-69-175" href="#__codelineno-69-175"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-176" name="__codelineno-69-176" href="#__codelineno-69-176"></a><span class="s2">            SELECT revenue, expenses </span>
<a id="__codelineno-69-177" name="__codelineno-69-177" href="#__codelineno-69-177"></a><span class="s2">            FROM monthly_summary </span>
<a id="__codelineno-69-178" name="__codelineno-69-178" href="#__codelineno-69-178"></a><span class="s2">            WHERE month = ? AND year = ?</span>
<a id="__codelineno-69-179" name="__codelineno-69-179" href="#__codelineno-69-179"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-69-180" name="__codelineno-69-180" href="#__codelineno-69-180"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-69-181" name="__codelineno-69-181" href="#__codelineno-69-181"></a>
<a id="__codelineno-69-182" name="__codelineno-69-182" href="#__codelineno-69-182"></a>        <span class="c1"># Now do calculations knowing data is locked</span>
<a id="__codelineno-69-183" name="__codelineno-69-183" href="#__codelineno-69-183"></a>        <span class="c1"># No one can modify it while we work</span>
<a id="__codelineno-69-184" name="__codelineno-69-184" href="#__codelineno-69-184"></a>        <span class="n">complex_analysis</span> <span class="o">=</span> <span class="n">perform_intensive_calculations</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-69-185" name="__codelineno-69-185" href="#__codelineno-69-185"></a>        <span class="n">statistical_models</span> <span class="o">=</span> <span class="n">run_ml_models</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-69-186" name="__codelineno-69-186" href="#__codelineno-69-186"></a>        <span class="n">generate_charts</span><span class="p">(</span><span class="n">complex_analysis</span><span class="p">)</span>
<a id="__codelineno-69-187" name="__codelineno-69-187" href="#__codelineno-69-187"></a>
<a id="__codelineno-69-188" name="__codelineno-69-188" href="#__codelineno-69-188"></a>        <span class="c1"># Save results (guaranteed to succeed)</span>
<a id="__codelineno-69-189" name="__codelineno-69-189" href="#__codelineno-69-189"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-190" name="__codelineno-69-190" href="#__codelineno-69-190"></a><span class="s2">            UPDATE monthly_summary </span>
<a id="__codelineno-69-191" name="__codelineno-69-191" href="#__codelineno-69-191"></a><span class="s2">            SET analysis = ?</span>
<a id="__codelineno-69-192" name="__codelineno-69-192" href="#__codelineno-69-192"></a><span class="s2">            WHERE month = ? AND year = ?</span>
<a id="__codelineno-69-193" name="__codelineno-69-193" href="#__codelineno-69-193"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">complex_analysis</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">])</span>
<a id="__codelineno-69-194" name="__codelineno-69-194" href="#__codelineno-69-194"></a>
<a id="__codelineno-69-195" name="__codelineno-69-195" href="#__codelineno-69-195"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-196" name="__codelineno-69-196" href="#__codelineno-69-196"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-69-197" name="__codelineno-69-197" href="#__codelineno-69-197"></a>
<a id="__codelineno-69-198" name="__codelineno-69-198" href="#__codelineno-69-198"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-69-199" name="__codelineno-69-199" href="#__codelineno-69-199"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-200" name="__codelineno-69-200" href="#__codelineno-69-200"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-69-201" name="__codelineno-69-201" href="#__codelineno-69-201"></a>
<a id="__codelineno-69-202" name="__codelineno-69-202" href="#__codelineno-69-202"></a>
<a id="__codelineno-69-203" name="__codelineno-69-203" href="#__codelineno-69-203"></a><span class="c1"># FAILURE EXAMPLE 3: Write-Heavy Workload</span>
<a id="__codelineno-69-204" name="__codelineno-69-204" href="#__codelineno-69-204"></a>
<a id="__codelineno-69-205" name="__codelineno-69-205" href="#__codelineno-69-205"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_sensor_data_optimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sensor_id</span><span class="p">,</span> <span class="n">reading</span><span class="p">):</span>
<a id="__codelineno-69-206" name="__codelineno-69-206" href="#__codelineno-69-206"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-207" name="__codelineno-69-207" href="#__codelineno-69-207"></a><span class="sd">    PROBLEM: 1000 sensors sending data every second</span>
<a id="__codelineno-69-208" name="__codelineno-69-208" href="#__codelineno-69-208"></a><span class="sd">    All writing to same aggregate table</span>
<a id="__codelineno-69-209" name="__codelineno-69-209" href="#__codelineno-69-209"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-210" name="__codelineno-69-210" href="#__codelineno-69-210"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-69-211" name="__codelineno-69-211" href="#__codelineno-69-211"></a>
<a id="__codelineno-69-212" name="__codelineno-69-212" href="#__codelineno-69-212"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-69-213" name="__codelineno-69-213" href="#__codelineno-69-213"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-214" name="__codelineno-69-214" href="#__codelineno-69-214"></a>
<a id="__codelineno-69-215" name="__codelineno-69-215" href="#__codelineno-69-215"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-69-216" name="__codelineno-69-216" href="#__codelineno-69-216"></a>            <span class="c1"># Read current aggregate</span>
<a id="__codelineno-69-217" name="__codelineno-69-217" href="#__codelineno-69-217"></a>            <span class="n">total</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-218" name="__codelineno-69-218" href="#__codelineno-69-218"></a><span class="s2">                SELECT total_readings, count, version </span>
<a id="__codelineno-69-219" name="__codelineno-69-219" href="#__codelineno-69-219"></a><span class="s2">                FROM sensor_aggregates </span>
<a id="__codelineno-69-220" name="__codelineno-69-220" href="#__codelineno-69-220"></a><span class="s2">                WHERE sensor_type = ?</span>
<a id="__codelineno-69-221" name="__codelineno-69-221" href="#__codelineno-69-221"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">get_sensor_type</span><span class="p">(</span><span class="n">sensor_id</span><span class="p">)])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-69-222" name="__codelineno-69-222" href="#__codelineno-69-222"></a>
<a id="__codelineno-69-223" name="__codelineno-69-223" href="#__codelineno-69-223"></a>            <span class="c1"># Update aggregate</span>
<a id="__codelineno-69-224" name="__codelineno-69-224" href="#__codelineno-69-224"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-225" name="__codelineno-69-225" href="#__codelineno-69-225"></a><span class="s2">                UPDATE sensor_aggregates </span>
<a id="__codelineno-69-226" name="__codelineno-69-226" href="#__codelineno-69-226"></a><span class="s2">                SET total_readings = ?, count = ?, version = version + 1</span>
<a id="__codelineno-69-227" name="__codelineno-69-227" href="#__codelineno-69-227"></a><span class="s2">                WHERE sensor_type = ? AND version = ?</span>
<a id="__codelineno-69-228" name="__codelineno-69-228" href="#__codelineno-69-228"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">total</span> <span class="o">+</span> <span class="n">reading</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
<a id="__codelineno-69-229" name="__codelineno-69-229" href="#__codelineno-69-229"></a>                  <span class="n">get_sensor_type</span><span class="p">(</span><span class="n">sensor_id</span><span class="p">),</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-69-230" name="__codelineno-69-230" href="#__codelineno-69-230"></a>
<a id="__codelineno-69-231" name="__codelineno-69-231" href="#__codelineno-69-231"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-69-232" name="__codelineno-69-232" href="#__codelineno-69-232"></a>                <span class="c1"># CONSTANT CONFLICTS!</span>
<a id="__codelineno-69-233" name="__codelineno-69-233" href="#__codelineno-69-233"></a>                <span class="c1"># 1000 sensors  1 update/sec = 1000 updates/sec</span>
<a id="__codelineno-69-234" name="__codelineno-69-234" href="#__codelineno-69-234"></a>                <span class="c1"># Success rate: &lt;10% on first try</span>
<a id="__codelineno-69-235" name="__codelineno-69-235" href="#__codelineno-69-235"></a>                <span class="c1"># 900+ retries per second</span>
<a id="__codelineno-69-236" name="__codelineno-69-236" href="#__codelineno-69-236"></a>                <span class="c1"># Database overwhelmed</span>
<a id="__codelineno-69-237" name="__codelineno-69-237" href="#__codelineno-69-237"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-238" name="__codelineno-69-238" href="#__codelineno-69-238"></a>                <span class="k">continue</span>
<a id="__codelineno-69-239" name="__codelineno-69-239" href="#__codelineno-69-239"></a>
<a id="__codelineno-69-240" name="__codelineno-69-240" href="#__codelineno-69-240"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-241" name="__codelineno-69-241" href="#__codelineno-69-241"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-69-242" name="__codelineno-69-242" href="#__codelineno-69-242"></a>
<a id="__codelineno-69-243" name="__codelineno-69-243" href="#__codelineno-69-243"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-69-244" name="__codelineno-69-244" href="#__codelineno-69-244"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-69-245" name="__codelineno-69-245" href="#__codelineno-69-245"></a>
<a id="__codelineno-69-246" name="__codelineno-69-246" href="#__codelineno-69-246"></a>    <span class="c1"># Many sensors fail to record data!</span>
<a id="__codelineno-69-247" name="__codelineno-69-247" href="#__codelineno-69-247"></a>    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-69-248" name="__codelineno-69-248" href="#__codelineno-69-248"></a>
<a id="__codelineno-69-249" name="__codelineno-69-249" href="#__codelineno-69-249"></a>
<a id="__codelineno-69-250" name="__codelineno-69-250" href="#__codelineno-69-250"></a><span class="c1"># BETTER SOLUTION: Use atomic operations or redesign</span>
<a id="__codelineno-69-251" name="__codelineno-69-251" href="#__codelineno-69-251"></a>
<a id="__codelineno-69-252" name="__codelineno-69-252" href="#__codelineno-69-252"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_sensor_data_better</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sensor_id</span><span class="p">,</span> <span class="n">reading</span><span class="p">):</span>
<a id="__codelineno-69-253" name="__codelineno-69-253" href="#__codelineno-69-253"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-254" name="__codelineno-69-254" href="#__codelineno-69-254"></a><span class="sd">    SOLUTION 1: Atomic increment (no version check needed)</span>
<a id="__codelineno-69-255" name="__codelineno-69-255" href="#__codelineno-69-255"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-256" name="__codelineno-69-256" href="#__codelineno-69-256"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-257" name="__codelineno-69-257" href="#__codelineno-69-257"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-258" name="__codelineno-69-258" href="#__codelineno-69-258"></a><span class="s2">        UPDATE sensor_aggregates </span>
<a id="__codelineno-69-259" name="__codelineno-69-259" href="#__codelineno-69-259"></a><span class="s2">        SET total_readings = total_readings + ?,</span>
<a id="__codelineno-69-260" name="__codelineno-69-260" href="#__codelineno-69-260"></a><span class="s2">            count = count + 1</span>
<a id="__codelineno-69-261" name="__codelineno-69-261" href="#__codelineno-69-261"></a><span class="s2">        WHERE sensor_type = ?</span>
<a id="__codelineno-69-262" name="__codelineno-69-262" href="#__codelineno-69-262"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">reading</span><span class="p">,</span> <span class="n">get_sensor_type</span><span class="p">(</span><span class="n">sensor_id</span><span class="p">)])</span>
<a id="__codelineno-69-263" name="__codelineno-69-263" href="#__codelineno-69-263"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-264" name="__codelineno-69-264" href="#__codelineno-69-264"></a>
<a id="__codelineno-69-265" name="__codelineno-69-265" href="#__codelineno-69-265"></a>
<a id="__codelineno-69-266" name="__codelineno-69-266" href="#__codelineno-69-266"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_sensor_data_better_v2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sensor_id</span><span class="p">,</span> <span class="n">reading</span><span class="p">):</span>
<a id="__codelineno-69-267" name="__codelineno-69-267" href="#__codelineno-69-267"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-69-268" name="__codelineno-69-268" href="#__codelineno-69-268"></a><span class="sd">    SOLUTION 2: Partition data (reduce contention)</span>
<a id="__codelineno-69-269" name="__codelineno-69-269" href="#__codelineno-69-269"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-69-270" name="__codelineno-69-270" href="#__codelineno-69-270"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-69-271" name="__codelineno-69-271" href="#__codelineno-69-271"></a>    <span class="c1"># Each sensor has its own row (no conflicts!)</span>
<a id="__codelineno-69-272" name="__codelineno-69-272" href="#__codelineno-69-272"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-69-273" name="__codelineno-69-273" href="#__codelineno-69-273"></a><span class="s2">        INSERT INTO sensor_readings (sensor_id, reading, timestamp)</span>
<a id="__codelineno-69-274" name="__codelineno-69-274" href="#__codelineno-69-274"></a><span class="s2">        VALUES (?, ?, NOW())</span>
<a id="__codelineno-69-275" name="__codelineno-69-275" href="#__codelineno-69-275"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">sensor_id</span><span class="p">,</span> <span class="n">reading</span><span class="p">])</span>
<a id="__codelineno-69-276" name="__codelineno-69-276" href="#__codelineno-69-276"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-69-277" name="__codelineno-69-277" href="#__codelineno-69-277"></a>
<a id="__codelineno-69-278" name="__codelineno-69-278" href="#__codelineno-69-278"></a>    <span class="c1"># Aggregate asynchronously in background job</span>
</code></pre></div>
<p><strong>Mathematical Analysis of Retry Overhead:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>     RETRY OVERHEAD CALCULATION                          
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>                                                         
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a> Scenario: N transactions competing for same resource    
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>                                                         
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a> Optimistic Locking:                                     
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>          
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>  Probability of success on first try: 1/N            
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>  Expected retries per transaction: N-1               
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>  Total work: N  (1 + (N-1)) = N                    
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>                                                      
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>  Example with N=100:                                 
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>   Success rate: 1% first try                        
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>   Average retries: 99 per transaction               
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>   Total operations: 10,000 (100)                   
<a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>   Wasted work: 9,900 operations (99%)               
<a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>          
<a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>                                                         
<a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a> Pessimistic Locking:                                    
<a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>          
<a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a>  Probability of success: 100%                        
<a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>  Expected retries: 0                                 
<a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a>  Total work: N  1 = N                               
<a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a>                                                      
<a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a>  Example with N=100:                                 
<a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a>   Success rate: 100% first try                      
<a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a>   Average retries: 0                                
<a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a>   Total operations: 100                             
<a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a>   Wasted work: 0 operations (0%)                    
<a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a>          
<a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a>                                                         
<a id="__codelineno-70-33" name="__codelineno-70-33" href="#__codelineno-70-33"></a> Efficiency Comparison:                                  
<a id="__codelineno-70-34" name="__codelineno-70-34" href="#__codelineno-70-34"></a>  Optimistic: O(N) work                                
<a id="__codelineno-70-35" name="__codelineno-70-35" href="#__codelineno-70-35"></a>  Pessimistic: O(N) work                                
<a id="__codelineno-70-36" name="__codelineno-70-36" href="#__codelineno-70-36"></a>                                                         
<a id="__codelineno-70-37" name="__codelineno-70-37" href="#__codelineno-70-37"></a> Crossover Point:                                        
<a id="__codelineno-70-38" name="__codelineno-70-38" href="#__codelineno-70-38"></a>  Low contention (N &lt; 10): Optimistic better           
<a id="__codelineno-70-39" name="__codelineno-70-39" href="#__codelineno-70-39"></a>  High contention (N &gt; 50): Pessimistic better         
<a id="__codelineno-70-40" name="__codelineno-70-40" href="#__codelineno-70-40"></a>                                                         
<a id="__codelineno-70-41" name="__codelineno-70-41" href="#__codelineno-70-41"></a>
</code></pre></div>
<p><strong>Decision Matrix: When to AVOID Optimistic Concurrency Control:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>     DON&#39;T USE OPTIMISTIC CONTROL WHEN:                  
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>                                                         
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>  Conflict Rate &gt; 20%                                  
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>     Too many retries waste resources                   
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>                                                         
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>  Transaction Duration &gt; 10 seconds                    
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>     High probability of conflicts during execution     
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>                                                         
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>  Write-Heavy Workload (&gt;50% writes)                   
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>     Constant conflicts, no benefit from lock-free reads
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>                                                         
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>  Limited Inventory / Hot Spots                        
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>     Many transactions compete for same items           
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>                                                         
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>  Critical Financial Data                              
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>     Cost of retry too high, need guaranteed success    
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>                                                         
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>  Real-Time / Time-Sensitive Operations                
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>     Retries cause unpredictable latency                
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>                                                         
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>  External Side Effects                                
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>     Can&#39;t rollback API calls, emails, payments         
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>                                                         
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>  No Retry Infrastructure                              
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a>     Application can&#39;t handle conflicts gracefully      
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>                                                         
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>  User-Facing Critical Path                            
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a>     Retries impact user experience negatively          
<a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a>                                                         
<a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a>
<a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a>
<a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a>
<a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a>     USE PESSIMISTIC CONTROL INSTEAD WHEN:               
<a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a>
<a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a>                                                         
<a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a>  Banking, financial transactions                       
<a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a>  Inventory management                                  
<a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a>  Ticket/seat booking systems                           
<a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a>  Limited resource allocation                           
<a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a>  Critical data updates                                 
<a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a>  Long-running batch jobs                               
<a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a>  High-contention scenarios                             
<a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a>  Predictable performance required                      
<a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a>                                                         
<a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a>
</code></pre></div>
<p><strong>Key Takeaways:</strong></p>
<ol>
<li>
<p><strong>Optimistic Control is NOT a universal solution</strong> - it fails catastrophically under high contention</p>
</li>
<li>
<p><strong>Context matters</strong> - same technique can be optimal or terrible depending on workload characteristics</p>
</li>
<li>
<p><strong>Mathematical reality</strong> - retry overhead grows quadratically (O(N)) with contention level</p>
</li>
<li>
<p><strong>User experience</strong> - retries cause unpredictable latency, frustrating users</p>
</li>
<li>
<p><strong>Choose based on data</strong> - measure actual conflict rates, don't assume they're low</p>
</li>
<li>
<p><strong>Hybrid approaches</strong> - use optimistic for low-contention data, pessimistic for hot spots</p>
</li>
<li>
<p><strong>Infrastructure requirements</strong> - optimistic control needs sophisticated retry logic, monitoring, and error handling</p>
</li>
</ol>
<hr />
<h4 id="43-comparison-pessimistic-vs-optimistic">4.3 Comparison: Pessimistic vs Optimistic</h4>
<p><strong>Side-by-Side Comparison:</strong></p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Pessimistic Locking</th>
<th>Optimistic Locking</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Assumption</strong></td>
<td>Conflicts are likely</td>
<td>Conflicts are rare</td>
</tr>
<tr>
<td><strong>Strategy</strong></td>
<td>Prevent conflicts with locks</td>
<td>Detect conflicts at commit</td>
</tr>
<tr>
<td><strong>Locking</strong></td>
<td>Acquires locks immediately</td>
<td>No locks during read/modify</td>
</tr>
<tr>
<td><strong>Blocking</strong></td>
<td>Transactions wait for locks</td>
<td>No blocking</td>
</tr>
<tr>
<td><strong>Deadlocks</strong></td>
<td>Possible (circular locks)</td>
<td>Not possible (no locks)</td>
</tr>
<tr>
<td><strong>Validation</strong></td>
<td>Not needed (locks guarantee)</td>
<td>Required at commit time</td>
</tr>
<tr>
<td><strong>Retries</strong></td>
<td>No retries needed</td>
<td>May require retries on conflict</td>
</tr>
<tr>
<td><strong>Concurrency</strong></td>
<td>Lower (locks block)</td>
<td>Higher (no locks)</td>
</tr>
<tr>
<td><strong>Performance (Low Contention)</strong></td>
<td>Slower (lock overhead)</td>
<td>Faster (no locks)</td>
</tr>
<tr>
<td><strong>Performance (High Contention)</strong></td>
<td>Better (no wasted work)</td>
<td>Worse (many retries)</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Simpler (locks handle it)</td>
<td>More complex (retry logic)</td>
</tr>
<tr>
<td><strong>Best For</strong></td>
<td>High contention, critical data</td>
<td>Low contention, read-heavy</td>
</tr>
<tr>
<td><strong>Examples</strong></td>
<td>Banking, inventory</td>
<td>Content management, caching</td>
</tr>
</tbody>
</table>
<p><strong>Visual Comparison:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>           PESSIMISTIC vs OPTIMISTIC                     
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>                                                         
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>  PESSIMISTIC (Lock First):                              
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>                
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>   T1: Lock  Read  Modify  Commit                  
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>           (safe)  (safe)                        
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>                                                      
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>   T2:        [WAITING......]  Start                 
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>                                (after                
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>                                 T1)                  
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>                
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>                                                         
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>  Pros: No conflicts, predictable                        
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>  Cons: Blocking, lower concurrency                      
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>                                                         
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>                                                         
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>  OPTIMISTIC (Check Later):                              
<a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>                
<a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a>   T1: Read  Modify  Validate  Commit              
<a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a>       (v1)   (local)           (v2)                 
<a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a>                                                      
<a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a>   T2: Read  Modify  Validate  Abort               
<a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a>       (v1)   (local)          RETRY                
<a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a>              (parallel)         (v1v2)              
<a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a>                
<a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a>                                                         
<a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a>  Pros: No blocking, high concurrency                    
<a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a>  Cons: Wasted work, retries                             
<a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a>                                                         
<a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a>
</code></pre></div>
<p><strong>Decision Tree:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>Choose Concurrency Control Strategy:
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>High Contention (many conflicts)?
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a> YES  Use PESSIMISTIC
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    Prevents wasted work
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>    Predictable performance
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>    Example: Bank transfers, ticket booking
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a> NO  Use OPTIMISTIC
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>     Better performance
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>     Higher concurrency
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>     Example: Document editing, product catalog
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>Critical Data (must be exact)?
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a> YES  Use PESSIMISTIC
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>    Guaranteed consistency
<a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>
<a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a> NO  Use OPTIMISTIC
<a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>     Acceptable to retry
<a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>
<a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a>Read-Heavy Workload?
<a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a> YES  Use OPTIMISTIC
<a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a>    Readers don&#39;t block
<a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a>
<a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a> NO (Write-Heavy)  Use PESSIMISTIC
<a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a>     Avoid retry storms
<a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a>
<a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a>Distributed System?
<a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a> YES  Use OPTIMISTIC
<a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a>    Locks don&#39;t scale across nodes
<a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a>
<a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a> NO (Single DB)  Either works
<a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a>     Choose based on contention
</code></pre></div>
<p><strong>Real-World Scenarios:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># Scenario 1: High Contention  Pessimistic</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="c1"># Use Case: Ticket booking system (limited inventory)</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">book_ticket_pessimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="sd">    Pessimistic is better here because:</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="sd">    - High contention (popular events sell out fast)</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="sd">    - Limited inventory (conflicts very likely)</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="sd">    - Critical to prevent overbooking</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>        <span class="c1"># LOCK the event row immediately</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>        <span class="n">available</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="s2">            SELECT tickets_available FROM events </span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">event_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>        <span class="k">if</span> <span class="n">available</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a>            <span class="k">raise</span> <span class="n">SoldOutError</span><span class="p">()</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>        <span class="c1"># Update inventory (lock held)</span>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="s2">            UPDATE events </span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a><span class="s2">            SET tickets_available = tickets_available - 1</span>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="s2">            WHERE id = ?</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">event_id</span><span class="p">])</span>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a>
<a id="__codelineno-74-31" name="__codelineno-74-31" href="#__codelineno-74-31"></a>        <span class="c1"># Create booking</span>
<a id="__codelineno-74-32" name="__codelineno-74-32" href="#__codelineno-74-32"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-33" name="__codelineno-74-33" href="#__codelineno-74-33"></a><span class="s2">            INSERT INTO bookings (event_id, user_id)</span>
<a id="__codelineno-74-34" name="__codelineno-74-34" href="#__codelineno-74-34"></a><span class="s2">            VALUES (?, ?)</span>
<a id="__codelineno-74-35" name="__codelineno-74-35" href="#__codelineno-74-35"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">event_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">])</span>
<a id="__codelineno-74-36" name="__codelineno-74-36" href="#__codelineno-74-36"></a>
<a id="__codelineno-74-37" name="__codelineno-74-37" href="#__codelineno-74-37"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-74-38" name="__codelineno-74-38" href="#__codelineno-74-38"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-74-39" name="__codelineno-74-39" href="#__codelineno-74-39"></a>
<a id="__codelineno-74-40" name="__codelineno-74-40" href="#__codelineno-74-40"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-74-41" name="__codelineno-74-41" href="#__codelineno-74-41"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-74-42" name="__codelineno-74-42" href="#__codelineno-74-42"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-74-43" name="__codelineno-74-43" href="#__codelineno-74-43"></a>
<a id="__codelineno-74-44" name="__codelineno-74-44" href="#__codelineno-74-44"></a>
<a id="__codelineno-74-45" name="__codelineno-74-45" href="#__codelineno-74-45"></a><span class="c1"># Scenario 2: Low Contention  Optimistic</span>
<a id="__codelineno-74-46" name="__codelineno-74-46" href="#__codelineno-74-46"></a><span class="c1"># Use Case: Blog post editing (infrequent updates)</span>
<a id="__codelineno-74-47" name="__codelineno-74-47" href="#__codelineno-74-47"></a>
<a id="__codelineno-74-48" name="__codelineno-74-48" href="#__codelineno-74-48"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_blog_post_optimistic</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">post_id</span><span class="p">,</span> <span class="n">new_content</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<a id="__codelineno-74-49" name="__codelineno-74-49" href="#__codelineno-74-49"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-74-50" name="__codelineno-74-50" href="#__codelineno-74-50"></a><span class="sd">    Optimistic is better here because:</span>
<a id="__codelineno-74-51" name="__codelineno-74-51" href="#__codelineno-74-51"></a><span class="sd">    - Low contention (rare concurrent edits)</span>
<a id="__codelineno-74-52" name="__codelineno-74-52" href="#__codelineno-74-52"></a><span class="sd">    - Read-heavy workload</span>
<a id="__codelineno-74-53" name="__codelineno-74-53" href="#__codelineno-74-53"></a><span class="sd">    - No need to block readers</span>
<a id="__codelineno-74-54" name="__codelineno-74-54" href="#__codelineno-74-54"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-74-55" name="__codelineno-74-55" href="#__codelineno-74-55"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-74-56" name="__codelineno-74-56" href="#__codelineno-74-56"></a>
<a id="__codelineno-74-57" name="__codelineno-74-57" href="#__codelineno-74-57"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-74-58" name="__codelineno-74-58" href="#__codelineno-74-58"></a>        <span class="c1"># Update with version check (no locks!)</span>
<a id="__codelineno-74-59" name="__codelineno-74-59" href="#__codelineno-74-59"></a>        <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-60" name="__codelineno-74-60" href="#__codelineno-74-60"></a><span class="s2">            UPDATE posts </span>
<a id="__codelineno-74-61" name="__codelineno-74-61" href="#__codelineno-74-61"></a><span class="s2">            SET content = ?, version = version + 1, updated_at = NOW()</span>
<a id="__codelineno-74-62" name="__codelineno-74-62" href="#__codelineno-74-62"></a><span class="s2">            WHERE id = ? AND version = ?</span>
<a id="__codelineno-74-63" name="__codelineno-74-63" href="#__codelineno-74-63"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">new_content</span><span class="p">,</span> <span class="n">post_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-74-64" name="__codelineno-74-64" href="#__codelineno-74-64"></a>
<a id="__codelineno-74-65" name="__codelineno-74-65" href="#__codelineno-74-65"></a>        <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-74-66" name="__codelineno-74-66" href="#__codelineno-74-66"></a>            <span class="c1"># Conflict! Someone else edited</span>
<a id="__codelineno-74-67" name="__codelineno-74-67" href="#__codelineno-74-67"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-74-68" name="__codelineno-74-68" href="#__codelineno-74-68"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-74-69" name="__codelineno-74-69" href="#__codelineno-74-69"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-74-70" name="__codelineno-74-70" href="#__codelineno-74-70"></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Post was modified by another user. Please refresh.&#39;</span>
<a id="__codelineno-74-71" name="__codelineno-74-71" href="#__codelineno-74-71"></a>            <span class="p">}</span>
<a id="__codelineno-74-72" name="__codelineno-74-72" href="#__codelineno-74-72"></a>
<a id="__codelineno-74-73" name="__codelineno-74-73" href="#__codelineno-74-73"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-74-74" name="__codelineno-74-74" href="#__codelineno-74-74"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-74-75" name="__codelineno-74-75" href="#__codelineno-74-75"></a>
<a id="__codelineno-74-76" name="__codelineno-74-76" href="#__codelineno-74-76"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-74-77" name="__codelineno-74-77" href="#__codelineno-74-77"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-74-78" name="__codelineno-74-78" href="#__codelineno-74-78"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-74-79" name="__codelineno-74-79" href="#__codelineno-74-79"></a>
<a id="__codelineno-74-80" name="__codelineno-74-80" href="#__codelineno-74-80"></a>
<a id="__codelineno-74-81" name="__codelineno-74-81" href="#__codelineno-74-81"></a><span class="c1"># Scenario 3: Hybrid Approach</span>
<a id="__codelineno-74-82" name="__codelineno-74-82" href="#__codelineno-74-82"></a><span class="c1"># Use Case: E-commerce shopping cart</span>
<a id="__codelineno-74-83" name="__codelineno-74-83" href="#__codelineno-74-83"></a>
<a id="__codelineno-74-84" name="__codelineno-74-84" href="#__codelineno-74-84"></a><span class="k">def</span><span class="w"> </span><span class="nf">checkout_order_hybrid</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">cart_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-74-85" name="__codelineno-74-85" href="#__codelineno-74-85"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-74-86" name="__codelineno-74-86" href="#__codelineno-74-86"></a><span class="sd">    Hybrid approach:</span>
<a id="__codelineno-74-87" name="__codelineno-74-87" href="#__codelineno-74-87"></a><span class="sd">    - Optimistic for cart items (low contention)</span>
<a id="__codelineno-74-88" name="__codelineno-74-88" href="#__codelineno-74-88"></a><span class="sd">    - Pessimistic for inventory (high contention)</span>
<a id="__codelineno-74-89" name="__codelineno-74-89" href="#__codelineno-74-89"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-74-90" name="__codelineno-74-90" href="#__codelineno-74-90"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-74-91" name="__codelineno-74-91" href="#__codelineno-74-91"></a>
<a id="__codelineno-74-92" name="__codelineno-74-92" href="#__codelineno-74-92"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-74-93" name="__codelineno-74-93" href="#__codelineno-74-93"></a>        <span class="c1"># Step 1: Read cart items (optimistic - no locks)</span>
<a id="__codelineno-74-94" name="__codelineno-74-94" href="#__codelineno-74-94"></a>        <span class="n">cart_items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-95" name="__codelineno-74-95" href="#__codelineno-74-95"></a><span class="s2">            SELECT product_id, quantity, version </span>
<a id="__codelineno-74-96" name="__codelineno-74-96" href="#__codelineno-74-96"></a><span class="s2">            FROM cart_items </span>
<a id="__codelineno-74-97" name="__codelineno-74-97" href="#__codelineno-74-97"></a><span class="s2">            WHERE cart_id = ?</span>
<a id="__codelineno-74-98" name="__codelineno-74-98" href="#__codelineno-74-98"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">cart_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-74-99" name="__codelineno-74-99" href="#__codelineno-74-99"></a>
<a id="__codelineno-74-100" name="__codelineno-74-100" href="#__codelineno-74-100"></a>        <span class="c1"># Step 2: Lock inventory rows (pessimistic - prevent overselling)</span>
<a id="__codelineno-74-101" name="__codelineno-74-101" href="#__codelineno-74-101"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart_items</span><span class="p">:</span>
<a id="__codelineno-74-102" name="__codelineno-74-102" href="#__codelineno-74-102"></a>            <span class="n">stock</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-103" name="__codelineno-74-103" href="#__codelineno-74-103"></a><span class="s2">                SELECT quantity FROM inventory </span>
<a id="__codelineno-74-104" name="__codelineno-74-104" href="#__codelineno-74-104"></a><span class="s2">                WHERE product_id = ? </span>
<a id="__codelineno-74-105" name="__codelineno-74-105" href="#__codelineno-74-105"></a><span class="s2">                FOR UPDATE</span>
<a id="__codelineno-74-106" name="__codelineno-74-106" href="#__codelineno-74-106"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-74-107" name="__codelineno-74-107" href="#__codelineno-74-107"></a>
<a id="__codelineno-74-108" name="__codelineno-74-108" href="#__codelineno-74-108"></a>            <span class="k">if</span> <span class="n">stock</span> <span class="o">&lt;</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]:</span>
<a id="__codelineno-74-109" name="__codelineno-74-109" href="#__codelineno-74-109"></a>                <span class="k">raise</span> <span class="n">OutOfStockError</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">])</span>
<a id="__codelineno-74-110" name="__codelineno-74-110" href="#__codelineno-74-110"></a>
<a id="__codelineno-74-111" name="__codelineno-74-111" href="#__codelineno-74-111"></a>            <span class="c1"># Reserve inventory</span>
<a id="__codelineno-74-112" name="__codelineno-74-112" href="#__codelineno-74-112"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-113" name="__codelineno-74-113" href="#__codelineno-74-113"></a><span class="s2">                UPDATE inventory </span>
<a id="__codelineno-74-114" name="__codelineno-74-114" href="#__codelineno-74-114"></a><span class="s2">                SET quantity = quantity - ?</span>
<a id="__codelineno-74-115" name="__codelineno-74-115" href="#__codelineno-74-115"></a><span class="s2">                WHERE product_id = ?</span>
<a id="__codelineno-74-116" name="__codelineno-74-116" href="#__codelineno-74-116"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]])</span>
<a id="__codelineno-74-117" name="__codelineno-74-117" href="#__codelineno-74-117"></a>
<a id="__codelineno-74-118" name="__codelineno-74-118" href="#__codelineno-74-118"></a>        <span class="c1"># Step 3: Create order (validate cart versions - optimistic)</span>
<a id="__codelineno-74-119" name="__codelineno-74-119" href="#__codelineno-74-119"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart_items</span><span class="p">:</span>
<a id="__codelineno-74-120" name="__codelineno-74-120" href="#__codelineno-74-120"></a>            <span class="c1"># Ensure cart wasn&#39;t modified</span>
<a id="__codelineno-74-121" name="__codelineno-74-121" href="#__codelineno-74-121"></a>            <span class="n">exists</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-122" name="__codelineno-74-122" href="#__codelineno-74-122"></a><span class="s2">                SELECT 1 FROM cart_items </span>
<a id="__codelineno-74-123" name="__codelineno-74-123" href="#__codelineno-74-123"></a><span class="s2">                WHERE cart_id = ? AND product_id = ? AND version = ?</span>
<a id="__codelineno-74-124" name="__codelineno-74-124" href="#__codelineno-74-124"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">cart_id</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-74-125" name="__codelineno-74-125" href="#__codelineno-74-125"></a>
<a id="__codelineno-74-126" name="__codelineno-74-126" href="#__codelineno-74-126"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
<a id="__codelineno-74-127" name="__codelineno-74-127" href="#__codelineno-74-127"></a>                <span class="k">raise</span> <span class="n">CartModifiedError</span><span class="p">()</span>
<a id="__codelineno-74-128" name="__codelineno-74-128" href="#__codelineno-74-128"></a>
<a id="__codelineno-74-129" name="__codelineno-74-129" href="#__codelineno-74-129"></a>        <span class="c1"># Create order</span>
<a id="__codelineno-74-130" name="__codelineno-74-130" href="#__codelineno-74-130"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-131" name="__codelineno-74-131" href="#__codelineno-74-131"></a><span class="s2">            INSERT INTO orders (user_id, total, timestamp)</span>
<a id="__codelineno-74-132" name="__codelineno-74-132" href="#__codelineno-74-132"></a><span class="s2">            VALUES (?, ?, NOW())</span>
<a id="__codelineno-74-133" name="__codelineno-74-133" href="#__codelineno-74-133"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">user_id</span><span class="p">,</span> <span class="n">calculate_total</span><span class="p">(</span><span class="n">cart_items</span><span class="p">)])</span>
<a id="__codelineno-74-134" name="__codelineno-74-134" href="#__codelineno-74-134"></a>
<a id="__codelineno-74-135" name="__codelineno-74-135" href="#__codelineno-74-135"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-74-136" name="__codelineno-74-136" href="#__codelineno-74-136"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-74-137" name="__codelineno-74-137" href="#__codelineno-74-137"></a>
<a id="__codelineno-74-138" name="__codelineno-74-138" href="#__codelineno-74-138"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-74-139" name="__codelineno-74-139" href="#__codelineno-74-139"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-74-140" name="__codelineno-74-140" href="#__codelineno-74-140"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<p><strong>Performance Comparison:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>Performance vs Contention Level:
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>Throughput
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>      Optimistic 
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>                            
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>                             
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>                              
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>                               ___________
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>      Pessimistic _____________/
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>                              /
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>                             /
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>                            /
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>      /
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>    
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>     Contention
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>      Low                                    High
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>Key Insights:
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a> Low Contention: Optimistic wins (no lock overhead)
<a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a> High Contention: Pessimistic wins (no retry overhead)
<a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a> Crossover point: ~20-30% conflict rate (depends on workload)
</code></pre></div>
<p><strong>When to Use Each:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>              USE PESSIMISTIC WHEN:                      
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>  High contention expected                              
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>  Critical data (financial, inventory)                  
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>  Cost of conflict is high                              
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>  Single database (not distributed)                     
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>  Predictable performance required                      
<a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>  Examples:                                             
<a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>   - Banking transactions                                
<a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>   - Ticket booking                                      
<a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>   - Inventory management                                
<a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>   - Seat reservations                                   
<a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>
<a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>
<a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>
<a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>              USE OPTIMISTIC WHEN:                       
<a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>
<a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a>  Low contention expected                               
<a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a>  Read-heavy workload                                   
<a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a>  Cost of retry is low                                  
<a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a>  Distributed systems                                   
<a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a>  Maximum concurrency needed                            
<a id="__codelineno-76-24" name="__codelineno-76-24" href="#__codelineno-76-24"></a>  Examples:                                             
<a id="__codelineno-76-25" name="__codelineno-76-25" href="#__codelineno-76-25"></a>   - Content management systems                          
<a id="__codelineno-76-26" name="__codelineno-76-26" href="#__codelineno-76-26"></a>   - Document editing                                    
<a id="__codelineno-76-27" name="__codelineno-76-27" href="#__codelineno-76-27"></a>   - Product catalogs                                    
<a id="__codelineno-76-28" name="__codelineno-76-28" href="#__codelineno-76-28"></a>   - User profiles                                       
<a id="__codelineno-76-29" name="__codelineno-76-29" href="#__codelineno-76-29"></a>   - Caching layers                                      
<a id="__codelineno-76-30" name="__codelineno-76-30" href="#__codelineno-76-30"></a>
</code></pre></div>
<hr />
<h4 id="44-detailed-advantages-and-disadvantages-of-both-concurrency-controls">4.4 Detailed Advantages and Disadvantages of Both Concurrency Controls</h4>
<p><strong>Description:</strong></p>
<p>Understanding the detailed advantages and disadvantages of each concurrency control approach is crucial for making informed architectural decisions. This section provides a comprehensive analysis of both approaches.</p>
<hr />
<h5 id="441-pessimistic-concurrency-control-detailed-analysis">4.4.1 Pessimistic Concurrency Control - Detailed Analysis</h5>
<p><strong>Advantages:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>    PESSIMISTIC CONTROL - ADVANTAGES                     
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>                                                         
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a> 1.  NO WASTED WORK                                    
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>          
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>   Conflicts prevented upfront with locks            
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>   No transaction aborts or retries                  
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>   Work done is guaranteed to commit                 
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>   CPU/memory utilized efficiently                   
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>                                                      
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>  Example:                                            
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>  100 transactions competing:                         
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>   All 100 succeed (sequentially)                    
<a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>   0 retries, 0 wasted computation                   
<a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>          
<a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a>                                                         
<a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a> 2.  PREDICTABLE PERFORMANCE                           
<a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a>          
<a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a>   Response time is consistent                       
<a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a>   Transaction either gets lock and proceeds         
<a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a>    or waits in orderly queue                         
<a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a>   No sudden performance degradation                 
<a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a>   Easy to estimate latency                          
<a id="__codelineno-77-25" name="__codelineno-77-25" href="#__codelineno-77-25"></a>                                                      
<a id="__codelineno-77-26" name="__codelineno-77-26" href="#__codelineno-77-26"></a>  Latency model:                                      
<a id="__codelineno-77-27" name="__codelineno-77-27" href="#__codelineno-77-27"></a>  Time = Lock_Wait + Processing_Time                  
<a id="__codelineno-77-28" name="__codelineno-77-28" href="#__codelineno-77-28"></a>  (Both predictable values)                           
<a id="__codelineno-77-29" name="__codelineno-77-29" href="#__codelineno-77-29"></a>          
<a id="__codelineno-77-30" name="__codelineno-77-30" href="#__codelineno-77-30"></a>                                                         
<a id="__codelineno-77-31" name="__codelineno-77-31" href="#__codelineno-77-31"></a> 3.  GUARANTEED SUCCESS (NO STARVATION)                
<a id="__codelineno-77-32" name="__codelineno-77-32" href="#__codelineno-77-32"></a>          
<a id="__codelineno-77-33" name="__codelineno-77-33" href="#__codelineno-77-33"></a>   Once lock acquired, commit guaranteed             
<a id="__codelineno-77-34" name="__codelineno-77-34" href="#__codelineno-77-34"></a>   FIFO queue ensures fairness                       
<a id="__codelineno-77-35" name="__codelineno-77-35" href="#__codelineno-77-35"></a>   No transaction starves indefinitely               
<a id="__codelineno-77-36" name="__codelineno-77-36" href="#__codelineno-77-36"></a>   Every transaction eventually completes            
<a id="__codelineno-77-37" name="__codelineno-77-37" href="#__codelineno-77-37"></a>                                                      
<a id="__codelineno-77-38" name="__codelineno-77-38" href="#__codelineno-77-38"></a>  Guarantee:                                          
<a id="__codelineno-77-39" name="__codelineno-77-39" href="#__codelineno-77-39"></a>  If T waits for lock  T will get lock              
<a id="__codelineno-77-40" name="__codelineno-77-40" href="#__codelineno-77-40"></a>  If T has lock  T will commit                     
<a id="__codelineno-77-41" name="__codelineno-77-41" href="#__codelineno-77-41"></a>          
<a id="__codelineno-77-42" name="__codelineno-77-42" href="#__codelineno-77-42"></a>                                                         
<a id="__codelineno-77-43" name="__codelineno-77-43" href="#__codelineno-77-43"></a> 4.  STRONG CONSISTENCY                                
<a id="__codelineno-77-44" name="__codelineno-77-44" href="#__codelineno-77-44"></a>          
<a id="__codelineno-77-45" name="__codelineno-77-45" href="#__codelineno-77-45"></a>   Locks prevent concurrent modifications            
<a id="__codelineno-77-46" name="__codelineno-77-46" href="#__codelineno-77-46"></a>   Data integrity always maintained                  
<a id="__codelineno-77-47" name="__codelineno-77-47" href="#__codelineno-77-47"></a>   No dirty reads, lost updates, or conflicts        
<a id="__codelineno-77-48" name="__codelineno-77-48" href="#__codelineno-77-48"></a>   ACID properties fully enforced                    
<a id="__codelineno-77-49" name="__codelineno-77-49" href="#__codelineno-77-49"></a>                                                      
<a id="__codelineno-77-50" name="__codelineno-77-50" href="#__codelineno-77-50"></a>  Data guarantees:                                    
<a id="__codelineno-77-51" name="__codelineno-77-51" href="#__codelineno-77-51"></a>   Read committed data only                          
<a id="__codelineno-77-52" name="__codelineno-77-52" href="#__codelineno-77-52"></a>   Writes are serializable                           
<a id="__codelineno-77-53" name="__codelineno-77-53" href="#__codelineno-77-53"></a>   Isolation levels strictly enforced                
<a id="__codelineno-77-54" name="__codelineno-77-54" href="#__codelineno-77-54"></a>          
<a id="__codelineno-77-55" name="__codelineno-77-55" href="#__codelineno-77-55"></a>                                                         
<a id="__codelineno-77-56" name="__codelineno-77-56" href="#__codelineno-77-56"></a> 5.  SIMPLE APPLICATION LOGIC                          
<a id="__codelineno-77-57" name="__codelineno-77-57" href="#__codelineno-77-57"></a>          
<a id="__codelineno-77-58" name="__codelineno-77-58" href="#__codelineno-77-58"></a>   No retry logic needed                             
<a id="__codelineno-77-59" name="__codelineno-77-59" href="#__codelineno-77-59"></a>   No conflict detection code                        
<a id="__codelineno-77-60" name="__codelineno-77-60" href="#__codelineno-77-60"></a>   Database handles all complexity                   
<a id="__codelineno-77-61" name="__codelineno-77-61" href="#__codelineno-77-61"></a>   Straightforward error handling                    
<a id="__codelineno-77-62" name="__codelineno-77-62" href="#__codelineno-77-62"></a>                                                      
<a id="__codelineno-77-63" name="__codelineno-77-63" href="#__codelineno-77-63"></a>  Code simplicity:                                    
<a id="__codelineno-77-64" name="__codelineno-77-64" href="#__codelineno-77-64"></a>  BEGIN  Lock  Process  COMMIT                    
<a id="__codelineno-77-65" name="__codelineno-77-65" href="#__codelineno-77-65"></a>  (No complex retry loops)                            
<a id="__codelineno-77-66" name="__codelineno-77-66" href="#__codelineno-77-66"></a>          
<a id="__codelineno-77-67" name="__codelineno-77-67" href="#__codelineno-77-67"></a>                                                         
<a id="__codelineno-77-68" name="__codelineno-77-68" href="#__codelineno-77-68"></a> 6.  IDEAL FOR HIGH CONTENTION                         
<a id="__codelineno-77-69" name="__codelineno-77-69" href="#__codelineno-77-69"></a>          
<a id="__codelineno-77-70" name="__codelineno-77-70" href="#__codelineno-77-70"></a>   Prevents retry storms                             
<a id="__codelineno-77-71" name="__codelineno-77-71" href="#__codelineno-77-71"></a>   Orderly processing under load                     
<a id="__codelineno-77-72" name="__codelineno-77-72" href="#__codelineno-77-72"></a>   System remains stable even when busy              
<a id="__codelineno-77-73" name="__codelineno-77-73" href="#__codelineno-77-73"></a>   Throughput degrades gracefully                    
<a id="__codelineno-77-74" name="__codelineno-77-74" href="#__codelineno-77-74"></a>                                                      
<a id="__codelineno-77-75" name="__codelineno-77-75" href="#__codelineno-77-75"></a>  High contention behavior:                           
<a id="__codelineno-77-76" name="__codelineno-77-76" href="#__codelineno-77-76"></a>  1000 transactions  queue  process                 
<a id="__codelineno-77-77" name="__codelineno-77-77" href="#__codelineno-77-77"></a>  System stable, no thrashing                         
<a id="__codelineno-77-78" name="__codelineno-77-78" href="#__codelineno-77-78"></a>          
<a id="__codelineno-77-79" name="__codelineno-77-79" href="#__codelineno-77-79"></a>                                                         
<a id="__codelineno-77-80" name="__codelineno-77-80" href="#__codelineno-77-80"></a> 7.  EASIER DEBUGGING AND MONITORING                   
<a id="__codelineno-77-81" name="__codelineno-77-81" href="#__codelineno-77-81"></a>          
<a id="__codelineno-77-82" name="__codelineno-77-82" href="#__codelineno-77-82"></a>   Clear lock states (held/waiting)                  
<a id="__codelineno-77-83" name="__codelineno-77-83" href="#__codelineno-77-83"></a>   Easy to identify bottlenecks                      
<a id="__codelineno-77-84" name="__codelineno-77-84" href="#__codelineno-77-84"></a>   Lock wait graphs show dependencies                
<a id="__codelineno-77-85" name="__codelineno-77-85" href="#__codelineno-77-85"></a>   Predictable failure modes                         
<a id="__codelineno-77-86" name="__codelineno-77-86" href="#__codelineno-77-86"></a>                                                      
<a id="__codelineno-77-87" name="__codelineno-77-87" href="#__codelineno-77-87"></a>  Observability:                                      
<a id="__codelineno-77-88" name="__codelineno-77-88" href="#__codelineno-77-88"></a>   See what locks are held                           
<a id="__codelineno-77-89" name="__codelineno-77-89" href="#__codelineno-77-89"></a>   Identify blocking transactions                    
<a id="__codelineno-77-90" name="__codelineno-77-90" href="#__codelineno-77-90"></a>   Detect deadlocks automatically                    
<a id="__codelineno-77-91" name="__codelineno-77-91" href="#__codelineno-77-91"></a>          
<a id="__codelineno-77-92" name="__codelineno-77-92" href="#__codelineno-77-92"></a>                                                         
<a id="__codelineno-77-93" name="__codelineno-77-93" href="#__codelineno-77-93"></a> 8.  DETERMINISTIC BEHAVIOR                            
<a id="__codelineno-77-94" name="__codelineno-77-94" href="#__codelineno-77-94"></a>          
<a id="__codelineno-77-95" name="__codelineno-77-95" href="#__codelineno-77-95"></a>   Same input  same execution order                 
<a id="__codelineno-77-96" name="__codelineno-77-96" href="#__codelineno-77-96"></a>   Reproducible for testing                          
<a id="__codelineno-77-97" name="__codelineno-77-97" href="#__codelineno-77-97"></a>   Easier to reason about correctness                
<a id="__codelineno-77-98" name="__codelineno-77-98" href="#__codelineno-77-98"></a>   Simplified debugging                              
<a id="__codelineno-77-99" name="__codelineno-77-99" href="#__codelineno-77-99"></a>          
<a id="__codelineno-77-100" name="__codelineno-77-100" href="#__codelineno-77-100"></a>                                                         
<a id="__codelineno-77-101" name="__codelineno-77-101" href="#__codelineno-77-101"></a>
</code></pre></div>
<p><strong>Disadvantages:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>    PESSIMISTIC CONTROL - DISADVANTAGES                  
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>                                                         
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a> 1.  BLOCKING AND REDUCED THROUGHPUT                   
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>          
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>   Transactions wait for locks                       
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>   Concurrent execution limited                      
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>   Lower overall throughput                          
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>   CPU underutilized (waiting, not working)          
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>                                                      
<a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a>  Impact:                                             
<a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>  If T1 holds lock for 100ms:                         
<a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a>   T2 must wait 100ms (blocked)                      
<a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>   T3 waits 200ms, T4 waits 300ms...                 
<a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>   Linear degradation with contention                
<a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>          
<a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a>                                                         
<a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a> 2.  DEADLOCK POSSIBILITY                              
<a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>          
<a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a>   Circular lock dependencies can occur              
<a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a>   Requires deadlock detection/prevention            
<a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a>   Victim transaction must be aborted                
<a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a>   Complexity in multi-resource scenarios            
<a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a>                                                      
<a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a>  Example:                                            
<a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a>  T1: Lock(A)  Lock(B)                               
<a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a>  T2: Lock(B)  Lock(A)                               
<a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a>  Result: DEADLOCK! One must abort                    
<a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a>                                                      
<a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a>  Mitigation needed:                                  
<a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a>   Lock ordering protocols                           
<a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a>   Timeout mechanisms                                
<a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a>   Deadlock detection algorithms                     
<a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a>          
<a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a>                                                         
<a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a> 3.  LOCK OVERHEAD AND MEMORY COST                     
<a id="__codelineno-78-38" name="__codelineno-78-38" href="#__codelineno-78-38"></a>          
<a id="__codelineno-78-39" name="__codelineno-78-39" href="#__codelineno-78-39"></a>   Lock structures consume memory                    
<a id="__codelineno-78-40" name="__codelineno-78-40" href="#__codelineno-78-40"></a>   Lock manager overhead (CPU)                       
<a id="__codelineno-78-41" name="__codelineno-78-41" href="#__codelineno-78-41"></a>   Deadlock detection costs resources                
<a id="__codelineno-78-42" name="__codelineno-78-42" href="#__codelineno-78-42"></a>   Lock table maintenance                            
<a id="__codelineno-78-43" name="__codelineno-78-43" href="#__codelineno-78-43"></a>                                                      
<a id="__codelineno-78-44" name="__codelineno-78-44" href="#__codelineno-78-44"></a>  Resource consumption:                               
<a id="__codelineno-78-45" name="__codelineno-78-45" href="#__codelineno-78-45"></a>   Each lock: ~100-500 bytes memory                  
<a id="__codelineno-78-46" name="__codelineno-78-46" href="#__codelineno-78-46"></a>   Lock acquisition: ~10-50 CPU cycles               
<a id="__codelineno-78-47" name="__codelineno-78-47" href="#__codelineno-78-47"></a>   Deadlock detection: periodic scans                
<a id="__codelineno-78-48" name="__codelineno-78-48" href="#__codelineno-78-48"></a>                                                      
<a id="__codelineno-78-49" name="__codelineno-78-49" href="#__codelineno-78-49"></a>  Scale impact:                                       
<a id="__codelineno-78-50" name="__codelineno-78-50" href="#__codelineno-78-50"></a>  10,000 concurrent transactions:                     
<a id="__codelineno-78-51" name="__codelineno-78-51" href="#__codelineno-78-51"></a>   1-5 MB lock memory                                
<a id="__codelineno-78-52" name="__codelineno-78-52" href="#__codelineno-78-52"></a>   Significant CPU for management                    
<a id="__codelineno-78-53" name="__codelineno-78-53" href="#__codelineno-78-53"></a>          
<a id="__codelineno-78-54" name="__codelineno-78-54" href="#__codelineno-78-54"></a>                                                         
<a id="__codelineno-78-55" name="__codelineno-78-55" href="#__codelineno-78-55"></a> 4.  LOCK ESCALATION ISSUES                            
<a id="__codelineno-78-56" name="__codelineno-78-56" href="#__codelineno-78-56"></a>          
<a id="__codelineno-78-57" name="__codelineno-78-57" href="#__codelineno-78-57"></a>   Too many row locks  table lock                   
<a id="__codelineno-78-58" name="__codelineno-78-58" href="#__codelineno-78-58"></a>   Reduces concurrency dramatically                  
<a id="__codelineno-78-59" name="__codelineno-78-59" href="#__codelineno-78-59"></a>   Unexpected blocking of other transactions         
<a id="__codelineno-78-60" name="__codelineno-78-60" href="#__codelineno-78-60"></a>   Difficult to predict/control                      
<a id="__codelineno-78-61" name="__codelineno-78-61" href="#__codelineno-78-61"></a>                                                      
<a id="__codelineno-78-62" name="__codelineno-78-62" href="#__codelineno-78-62"></a>  Scenario:                                           
<a id="__codelineno-78-63" name="__codelineno-78-63" href="#__codelineno-78-63"></a>  T1 updates 5,000 rows:                              
<a id="__codelineno-78-64" name="__codelineno-78-64" href="#__codelineno-78-64"></a>   Acquires 5,000 row locks                          
<a id="__codelineno-78-65" name="__codelineno-78-65" href="#__codelineno-78-65"></a>   Database escalates to table lock!                 
<a id="__codelineno-78-66" name="__codelineno-78-66" href="#__codelineno-78-66"></a>   Now ENTIRE table locked                           
<a id="__codelineno-78-67" name="__codelineno-78-67" href="#__codelineno-78-67"></a>   All other transactions blocked                    
<a id="__codelineno-78-68" name="__codelineno-78-68" href="#__codelineno-78-68"></a>          
<a id="__codelineno-78-69" name="__codelineno-78-69" href="#__codelineno-78-69"></a>                                                         
<a id="__codelineno-78-70" name="__codelineno-78-70" href="#__codelineno-78-70"></a> 5.  POOR SCALABILITY IN DISTRIBUTED SYSTEMS           
<a id="__codelineno-78-71" name="__codelineno-78-71" href="#__codelineno-78-71"></a>          
<a id="__codelineno-78-72" name="__codelineno-78-72" href="#__codelineno-78-72"></a>   Distributed locks expensive                       
<a id="__codelineno-78-73" name="__codelineno-78-73" href="#__codelineno-78-73"></a>   Network latency amplifies wait time               
<a id="__codelineno-78-74" name="__codelineno-78-74" href="#__codelineno-78-74"></a>   Lock coordination overhead                        
<a id="__codelineno-78-75" name="__codelineno-78-75" href="#__codelineno-78-75"></a>   Difficult to maintain across nodes                
<a id="__codelineno-78-76" name="__codelineno-78-76" href="#__codelineno-78-76"></a>                                                      
<a id="__codelineno-78-77" name="__codelineno-78-77" href="#__codelineno-78-77"></a>  Distributed challenges:                             
<a id="__codelineno-78-78" name="__codelineno-78-78" href="#__codelineno-78-78"></a>   Lock acquisition: 50-200ms (network RTT)          
<a id="__codelineno-78-79" name="__codelineno-78-79" href="#__codelineno-78-79"></a>   Deadlock detection across nodes: complex          
<a id="__codelineno-78-80" name="__codelineno-78-80" href="#__codelineno-78-80"></a>   Lock manager becomes bottleneck                   
<a id="__codelineno-78-81" name="__codelineno-78-81" href="#__codelineno-78-81"></a>   Network partitions cause issues                   
<a id="__codelineno-78-82" name="__codelineno-78-82" href="#__codelineno-78-82"></a>          
<a id="__codelineno-78-83" name="__codelineno-78-83" href="#__codelineno-78-83"></a>                                                         
<a id="__codelineno-78-84" name="__codelineno-78-84" href="#__codelineno-78-84"></a> 6.  REDUCED CONCURRENCY FOR READS                     
<a id="__codelineno-78-85" name="__codelineno-78-85" href="#__codelineno-78-85"></a>          
<a id="__codelineno-78-86" name="__codelineno-78-86" href="#__codelineno-78-86"></a>   Read locks block writes                           
<a id="__codelineno-78-87" name="__codelineno-78-87" href="#__codelineno-78-87"></a>   Write locks block reads                           
<a id="__codelineno-78-88" name="__codelineno-78-88" href="#__codelineno-78-88"></a>   Even non-conflicting operations wait              
<a id="__codelineno-78-89" name="__codelineno-78-89" href="#__codelineno-78-89"></a>   Lower read throughput                             
<a id="__codelineno-78-90" name="__codelineno-78-90" href="#__codelineno-78-90"></a>                                                      
<a id="__codelineno-78-91" name="__codelineno-78-91" href="#__codelineno-78-91"></a>  Example:                                            
<a id="__codelineno-78-92" name="__codelineno-78-92" href="#__codelineno-78-92"></a>  T1 writing row X:                                   
<a id="__codelineno-78-93" name="__codelineno-78-93" href="#__codelineno-78-93"></a>   T2 wants to read row X  BLOCKED                  
<a id="__codelineno-78-94" name="__codelineno-78-94" href="#__codelineno-78-94"></a>   T3 wants to read row X  BLOCKED                  
<a id="__codelineno-78-95" name="__codelineno-78-95" href="#__codelineno-78-95"></a>   Even though reads don&#39;t conflict!                 
<a id="__codelineno-78-96" name="__codelineno-78-96" href="#__codelineno-78-96"></a>          
<a id="__codelineno-78-97" name="__codelineno-78-97" href="#__codelineno-78-97"></a>                                                         
<a id="__codelineno-78-98" name="__codelineno-78-98" href="#__codelineno-78-98"></a> 7.  PRIORITY INVERSION RISK                           
<a id="__codelineno-78-99" name="__codelineno-78-99" href="#__codelineno-78-99"></a>          
<a id="__codelineno-78-100" name="__codelineno-78-100" href="#__codelineno-78-100"></a>   Low priority transaction holds lock               
<a id="__codelineno-78-101" name="__codelineno-78-101" href="#__codelineno-78-101"></a>   High priority transaction must wait               
<a id="__codelineno-78-102" name="__codelineno-78-102" href="#__codelineno-78-102"></a>   Inverted execution order                          
<a id="__codelineno-78-103" name="__codelineno-78-103" href="#__codelineno-78-103"></a>   Can cause critical delays                         
<a id="__codelineno-78-104" name="__codelineno-78-104" href="#__codelineno-78-104"></a>                                                      
<a id="__codelineno-78-105" name="__codelineno-78-105" href="#__codelineno-78-105"></a>  Scenario:                                           
<a id="__codelineno-78-106" name="__codelineno-78-106" href="#__codelineno-78-106"></a>  Low-priority batch job: locks data                  
<a id="__codelineno-78-107" name="__codelineno-78-107" href="#__codelineno-78-107"></a>  High-priority user request: must wait!              
<a id="__codelineno-78-108" name="__codelineno-78-108" href="#__codelineno-78-108"></a>  User sees slow response time                        
<a id="__codelineno-78-109" name="__codelineno-78-109" href="#__codelineno-78-109"></a>          
<a id="__codelineno-78-110" name="__codelineno-78-110" href="#__codelineno-78-110"></a>                                                         
<a id="__codelineno-78-111" name="__codelineno-78-111" href="#__codelineno-78-111"></a> 8.  LOCK TIMEOUT COMPLEXITY                           
<a id="__codelineno-78-112" name="__codelineno-78-112" href="#__codelineno-78-112"></a>          
<a id="__codelineno-78-113" name="__codelineno-78-113" href="#__codelineno-78-113"></a>   Need to set appropriate timeout values            
<a id="__codelineno-78-114" name="__codelineno-78-114" href="#__codelineno-78-114"></a>   Too short: unnecessary aborts                     
<a id="__codelineno-78-115" name="__codelineno-78-115" href="#__codelineno-78-115"></a>   Too long: long wait times                         
<a id="__codelineno-78-116" name="__codelineno-78-116" href="#__codelineno-78-116"></a>   Different workloads need different values         
<a id="__codelineno-78-117" name="__codelineno-78-117" href="#__codelineno-78-117"></a>          
<a id="__codelineno-78-118" name="__codelineno-78-118" href="#__codelineno-78-118"></a>                                                         
<a id="__codelineno-78-119" name="__codelineno-78-119" href="#__codelineno-78-119"></a>
</code></pre></div>
<hr />
<h5 id="442-optimistic-concurrency-control-detailed-analysis">4.4.2 Optimistic Concurrency Control - Detailed Analysis</h5>
<p><strong>Advantages:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>    OPTIMISTIC CONTROL - ADVANTAGES                      
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>                                                         
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a> 1.  NO BLOCKING - MAXIMUM CONCURRENCY                 
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>          
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>   Transactions never wait for each other            
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>   All execute in parallel                           
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>   Maximum CPU utilization                           
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>   Highest possible throughput                       
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>                                                      
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>  Example:                                            
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>  1000 transactions:                                  
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>   All read simultaneously (no waiting)              
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>   All process simultaneously                        
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>   Validation happens at commit only                 
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>                                                      
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>  Throughput:                                         
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>  Low contention: 10x faster than pessimistic         
<a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>          
<a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a>                                                         
<a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a> 2.  NO DEADLOCKS                                      
<a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a>          
<a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a>   No locks  No circular dependencies               
<a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a>   Eliminates deadlock complexity                    
<a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a>   No deadlock detection needed                      
<a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a>   No victim selection required                      
<a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a>                                                      
<a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a>  Simplification:                                     
<a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a>   No lock ordering protocols                        
<a id="__codelineno-79-31" name="__codelineno-79-31" href="#__codelineno-79-31"></a>   No deadlock timeouts                              
<a id="__codelineno-79-32" name="__codelineno-79-32" href="#__codelineno-79-32"></a>   No wait-for graphs                                
<a id="__codelineno-79-33" name="__codelineno-79-33" href="#__codelineno-79-33"></a>   One less failure mode to handle                   
<a id="__codelineno-79-34" name="__codelineno-79-34" href="#__codelineno-79-34"></a>          
<a id="__codelineno-79-35" name="__codelineno-79-35" href="#__codelineno-79-35"></a>                                                         
<a id="__codelineno-79-36" name="__codelineno-79-36" href="#__codelineno-79-36"></a> 3.  LOWER OVERHEAD (NO LOCK MANAGEMENT)               
<a id="__codelineno-79-37" name="__codelineno-79-37" href="#__codelineno-79-37"></a>          
<a id="__codelineno-79-38" name="__codelineno-79-38" href="#__codelineno-79-38"></a>   No lock structures in memory                      
<a id="__codelineno-79-39" name="__codelineno-79-39" href="#__codelineno-79-39"></a>   No lock acquisition/release cost                  
<a id="__codelineno-79-40" name="__codelineno-79-40" href="#__codelineno-79-40"></a>   No deadlock detection overhead                    
<a id="__codelineno-79-41" name="__codelineno-79-41" href="#__codelineno-79-41"></a>   Minimal database metadata                         
<a id="__codelineno-79-42" name="__codelineno-79-42" href="#__codelineno-79-42"></a>                                                      
<a id="__codelineno-79-43" name="__codelineno-79-43" href="#__codelineno-79-43"></a>  Resource savings:                                   
<a id="__codelineno-79-44" name="__codelineno-79-44" href="#__codelineno-79-44"></a>   Memory: No lock tables                            
<a id="__codelineno-79-45" name="__codelineno-79-45" href="#__codelineno-79-45"></a>   CPU: No lock manager overhead                     
<a id="__codelineno-79-46" name="__codelineno-79-46" href="#__codelineno-79-46"></a>   Just version number or timestamp                  
<a id="__codelineno-79-47" name="__codelineno-79-47" href="#__codelineno-79-47"></a>    (4-8 bytes per row)                               
<a id="__codelineno-79-48" name="__codelineno-79-48" href="#__codelineno-79-48"></a>          
<a id="__codelineno-79-49" name="__codelineno-79-49" href="#__codelineno-79-49"></a>                                                         
<a id="__codelineno-79-50" name="__codelineno-79-50" href="#__codelineno-79-50"></a> 4.  EXCELLENT FOR READ-HEAVY WORKLOADS                
<a id="__codelineno-79-51" name="__codelineno-79-51" href="#__codelineno-79-51"></a>          
<a id="__codelineno-79-52" name="__codelineno-79-52" href="#__codelineno-79-52"></a>   Readers never block each other                    
<a id="__codelineno-79-53" name="__codelineno-79-53" href="#__codelineno-79-53"></a>   Readers don&#39;t block writers                       
<a id="__codelineno-79-54" name="__codelineno-79-54" href="#__codelineno-79-54"></a>   Writers don&#39;t block readers                       
<a id="__codelineno-79-55" name="__codelineno-79-55" href="#__codelineno-79-55"></a>   Perfect for 90% read, 10% write                   
<a id="__codelineno-79-56" name="__codelineno-79-56" href="#__codelineno-79-56"></a>                                                      
<a id="__codelineno-79-57" name="__codelineno-79-57" href="#__codelineno-79-57"></a>  Use cases:                                          
<a id="__codelineno-79-58" name="__codelineno-79-58" href="#__codelineno-79-58"></a>   Content management systems                        
<a id="__codelineno-79-59" name="__codelineno-79-59" href="#__codelineno-79-59"></a>   Product catalogs                                  
<a id="__codelineno-79-60" name="__codelineno-79-60" href="#__codelineno-79-60"></a>   User profiles                                     
<a id="__codelineno-79-61" name="__codelineno-79-61" href="#__codelineno-79-61"></a>   Reference data                                    
<a id="__codelineno-79-62" name="__codelineno-79-62" href="#__codelineno-79-62"></a>                                                      
<a id="__codelineno-79-63" name="__codelineno-79-63" href="#__codelineno-79-63"></a>  Performance:                                        
<a id="__codelineno-79-64" name="__codelineno-79-64" href="#__codelineno-79-64"></a>  90% reads: 5-10x faster than pessimistic            
<a id="__codelineno-79-65" name="__codelineno-79-65" href="#__codelineno-79-65"></a>          
<a id="__codelineno-79-66" name="__codelineno-79-66" href="#__codelineno-79-66"></a>                                                         
<a id="__codelineno-79-67" name="__codelineno-79-67" href="#__codelineno-79-67"></a> 5.  BETTER FOR DISTRIBUTED SYSTEMS                    
<a id="__codelineno-79-68" name="__codelineno-79-68" href="#__codelineno-79-68"></a>          
<a id="__codelineno-79-69" name="__codelineno-79-69" href="#__codelineno-79-69"></a>   No distributed lock coordination                  
<a id="__codelineno-79-70" name="__codelineno-79-70" href="#__codelineno-79-70"></a>   No network overhead for locks                     
<a id="__codelineno-79-71" name="__codelineno-79-71" href="#__codelineno-79-71"></a>   Scales horizontally easily                        
<a id="__codelineno-79-72" name="__codelineno-79-72" href="#__codelineno-79-72"></a>   Works well with replication                       
<a id="__codelineno-79-73" name="__codelineno-79-73" href="#__codelineno-79-73"></a>                                                      
<a id="__codelineno-79-74" name="__codelineno-79-74" href="#__codelineno-79-74"></a>  Distributed benefits:                               
<a id="__codelineno-79-75" name="__codelineno-79-75" href="#__codelineno-79-75"></a>   Each node operates independently                  
<a id="__codelineno-79-76" name="__codelineno-79-76" href="#__codelineno-79-76"></a>   No cross-node lock messages                       
<a id="__codelineno-79-77" name="__codelineno-79-77" href="#__codelineno-79-77"></a>   Conflict detection at commit (local)              
<a id="__codelineno-79-78" name="__codelineno-79-78" href="#__codelineno-79-78"></a>   Network partitions less problematic               
<a id="__codelineno-79-79" name="__codelineno-79-79" href="#__codelineno-79-79"></a>                                                      
<a id="__codelineno-79-80" name="__codelineno-79-80" href="#__codelineno-79-80"></a>  Examples:                                           
<a id="__codelineno-79-81" name="__codelineno-79-81" href="#__codelineno-79-81"></a>   DynamoDB (optimistic by default)                  
<a id="__codelineno-79-82" name="__codelineno-79-82" href="#__codelineno-79-82"></a>   Cosmos DB (uses ETags)                            
<a id="__codelineno-79-83" name="__codelineno-79-83" href="#__codelineno-79-83"></a>   Cassandra (lightweight transactions)              
<a id="__codelineno-79-84" name="__codelineno-79-84" href="#__codelineno-79-84"></a>          
<a id="__codelineno-79-85" name="__codelineno-79-85" href="#__codelineno-79-85"></a>                                                         
<a id="__codelineno-79-86" name="__codelineno-79-86" href="#__codelineno-79-86"></a> 6.  LOWER LATENCY IN LOW CONTENTION                   
<a id="__codelineno-79-87" name="__codelineno-79-87" href="#__codelineno-79-87"></a>          
<a id="__codelineno-79-88" name="__codelineno-79-88" href="#__codelineno-79-88"></a>   No lock acquisition delay                         
<a id="__codelineno-79-89" name="__codelineno-79-89" href="#__codelineno-79-89"></a>   No waiting in queues                              
<a id="__codelineno-79-90" name="__codelineno-79-90" href="#__codelineno-79-90"></a>   Immediate execution                               
<a id="__codelineno-79-91" name="__codelineno-79-91" href="#__codelineno-79-91"></a>   Faster response times                             
<a id="__codelineno-79-92" name="__codelineno-79-92" href="#__codelineno-79-92"></a>                                                      
<a id="__codelineno-79-93" name="__codelineno-79-93" href="#__codelineno-79-93"></a>  Latency comparison (low contention):                
<a id="__codelineno-79-94" name="__codelineno-79-94" href="#__codelineno-79-94"></a>  Pessimistic: 50-100ms (lock overhead)               
<a id="__codelineno-79-95" name="__codelineno-79-95" href="#__codelineno-79-95"></a>  Optimistic:  5-10ms (no locks)                      
<a id="__codelineno-79-96" name="__codelineno-79-96" href="#__codelineno-79-96"></a>   5-10x faster!                                     
<a id="__codelineno-79-97" name="__codelineno-79-97" href="#__codelineno-79-97"></a>          
<a id="__codelineno-79-98" name="__codelineno-79-98" href="#__codelineno-79-98"></a>                                                         
<a id="__codelineno-79-99" name="__codelineno-79-99" href="#__codelineno-79-99"></a> 7.  SIMPLER LOCK-FREE DESIGN                          
<a id="__codelineno-79-100" name="__codelineno-79-100" href="#__codelineno-79-100"></a>          
<a id="__codelineno-79-101" name="__codelineno-79-101" href="#__codelineno-79-101"></a>   No complex lock hierarchies                       
<a id="__codelineno-79-102" name="__codelineno-79-102" href="#__codelineno-79-102"></a>   No lock ordering concerns                         
<a id="__codelineno-79-103" name="__codelineno-79-103" href="#__codelineno-79-103"></a>   No lock escalation issues                         
<a id="__codelineno-79-104" name="__codelineno-79-104" href="#__codelineno-79-104"></a>   Easier mental model                               
<a id="__codelineno-79-105" name="__codelineno-79-105" href="#__codelineno-79-105"></a>                                                      
<a id="__codelineno-79-106" name="__codelineno-79-106" href="#__codelineno-79-106"></a>  Design simplicity:                                  
<a id="__codelineno-79-107" name="__codelineno-79-107" href="#__codelineno-79-107"></a>   Read  Modify  Validate  Commit                 
<a id="__codelineno-79-108" name="__codelineno-79-108" href="#__codelineno-79-108"></a>   Version check at end                              
<a id="__codelineno-79-109" name="__codelineno-79-109" href="#__codelineno-79-109"></a>   Retry on conflict                                 
<a id="__codelineno-79-110" name="__codelineno-79-110" href="#__codelineno-79-110"></a>          
<a id="__codelineno-79-111" name="__codelineno-79-111" href="#__codelineno-79-111"></a>                                                         
<a id="__codelineno-79-112" name="__codelineno-79-112" href="#__codelineno-79-112"></a> 8.  NO PRIORITY INVERSION                             
<a id="__codelineno-79-113" name="__codelineno-79-113" href="#__codelineno-79-113"></a>          
<a id="__codelineno-79-114" name="__codelineno-79-114" href="#__codelineno-79-114"></a>   No locks means no priority inversion              
<a id="__codelineno-79-115" name="__codelineno-79-115" href="#__codelineno-79-115"></a>   High priority tasks not blocked                   
<a id="__codelineno-79-116" name="__codelineno-79-116" href="#__codelineno-79-116"></a>   Fair scheduling possible                          
<a id="__codelineno-79-117" name="__codelineno-79-117" href="#__codelineno-79-117"></a>   Better for real-time systems                      
<a id="__codelineno-79-118" name="__codelineno-79-118" href="#__codelineno-79-118"></a>          
<a id="__codelineno-79-119" name="__codelineno-79-119" href="#__codelineno-79-119"></a>                                                         
<a id="__codelineno-79-120" name="__codelineno-79-120" href="#__codelineno-79-120"></a> 9.  WORKS WELL WITH CACHING                           
<a id="__codelineno-79-121" name="__codelineno-79-121" href="#__codelineno-79-121"></a>          
<a id="__codelineno-79-122" name="__codelineno-79-122" href="#__codelineno-79-122"></a>   Read from cache without locks                     
<a id="__codelineno-79-123" name="__codelineno-79-123" href="#__codelineno-79-123"></a>   Invalidate cache on version change                
<a id="__codelineno-79-124" name="__codelineno-79-124" href="#__codelineno-79-124"></a>   Version numbers enable cache coherence            
<a id="__codelineno-79-125" name="__codelineno-79-125" href="#__codelineno-79-125"></a>   Easy cache integration                            
<a id="__codelineno-79-126" name="__codelineno-79-126" href="#__codelineno-79-126"></a>                                                      
<a id="__codelineno-79-127" name="__codelineno-79-127" href="#__codelineno-79-127"></a>  Cache pattern:                                      
<a id="__codelineno-79-128" name="__codelineno-79-128" href="#__codelineno-79-128"></a>  1. Read from cache (fast)                           
<a id="__codelineno-79-129" name="__codelineno-79-129" href="#__codelineno-79-129"></a>  2. Modify locally                                   
<a id="__codelineno-79-130" name="__codelineno-79-130" href="#__codelineno-79-130"></a>  3. Validate version before commit                   
<a id="__codelineno-79-131" name="__codelineno-79-131" href="#__codelineno-79-131"></a>  4. Update cache on success                          
<a id="__codelineno-79-132" name="__codelineno-79-132" href="#__codelineno-79-132"></a>          
<a id="__codelineno-79-133" name="__codelineno-79-133" href="#__codelineno-79-133"></a>                                                         
<a id="__codelineno-79-134" name="__codelineno-79-134" href="#__codelineno-79-134"></a>
</code></pre></div>
<p><strong>Disadvantages:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>    OPTIMISTIC CONTROL - DISADVANTAGES                   
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>                                                         
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a> 1.  WASTED WORK ON CONFLICTS                          
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>          
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>   Transaction aborted = all work lost               
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>   CPU cycles wasted                                 
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>   Memory allocations wasted                         
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>   Must redo from beginning                          
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>                                                      
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>  Example:                                            
<a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>  Complex report (10 seconds processing):             
<a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>   10 seconds of CPU work                            
<a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a>   Validation fails at end                           
<a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a>   All 10 seconds WASTED!                            
<a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a>   Must restart from scratch                         
<a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a>                                                      
<a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a>  Impact:                                             
<a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a>  High contention (50% conflict rate):                
<a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a>   50% of all work is wasted                         
<a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a>   Effective throughput halved                       
<a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a>          
<a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a>                                                         
<a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a> 2.  RETRY OVERHEAD AND COMPLEXITY                     
<a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a>          
<a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a>   Need retry logic in application                   
<a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a>   Exponential backoff implementation                
<a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a>   Max retry limit handling                          
<a id="__codelineno-80-30" name="__codelineno-80-30" href="#__codelineno-80-30"></a>   Complex error handling                            
<a id="__codelineno-80-31" name="__codelineno-80-31" href="#__codelineno-80-31"></a>                                                      
<a id="__codelineno-80-32" name="__codelineno-80-32" href="#__codelineno-80-32"></a>  Required code:                                      
<a id="__codelineno-80-33" name="__codelineno-80-33" href="#__codelineno-80-33"></a>   Retry loop with backoff                           
<a id="__codelineno-80-34" name="__codelineno-80-34" href="#__codelineno-80-34"></a>   Conflict detection                                
<a id="__codelineno-80-35" name="__codelineno-80-35" href="#__codelineno-80-35"></a>   Error categorization                              
<a id="__codelineno-80-36" name="__codelineno-80-36" href="#__codelineno-80-36"></a>   User feedback on retries                          
<a id="__codelineno-80-37" name="__codelineno-80-37" href="#__codelineno-80-37"></a>   Monitoring retry rates                            
<a id="__codelineno-80-38" name="__codelineno-80-38" href="#__codelineno-80-38"></a>                                                      
<a id="__codelineno-80-39" name="__codelineno-80-39" href="#__codelineno-80-39"></a>  Complexity added:                                   
<a id="__codelineno-80-40" name="__codelineno-80-40" href="#__codelineno-80-40"></a>   50-100+ lines of retry code                       
<a id="__codelineno-80-41" name="__codelineno-80-41" href="#__codelineno-80-41"></a>   Testing retry scenarios                           
<a id="__codelineno-80-42" name="__codelineno-80-42" href="#__codelineno-80-42"></a>   Debugging intermittent failures                   
<a id="__codelineno-80-43" name="__codelineno-80-43" href="#__codelineno-80-43"></a>          
<a id="__codelineno-80-44" name="__codelineno-80-44" href="#__codelineno-80-44"></a>                                                         
<a id="__codelineno-80-45" name="__codelineno-80-45" href="#__codelineno-80-45"></a> 3.  STARVATION POSSIBLE (LIVELOCK)                    
<a id="__codelineno-80-46" name="__codelineno-80-46" href="#__codelineno-80-46"></a>          
<a id="__codelineno-80-47" name="__codelineno-80-47" href="#__codelineno-80-47"></a>   Transaction may never succeed                     
<a id="__codelineno-80-48" name="__codelineno-80-48" href="#__codelineno-80-48"></a>   Continuously retrying, always failing             
<a id="__codelineno-80-49" name="__codelineno-80-49" href="#__codelineno-80-49"></a>   No guaranteed completion                          
<a id="__codelineno-80-50" name="__codelineno-80-50" href="#__codelineno-80-50"></a>   Fairness not guaranteed                           
<a id="__codelineno-80-51" name="__codelineno-80-51" href="#__codelineno-80-51"></a>                                                      
<a id="__codelineno-80-52" name="__codelineno-80-52" href="#__codelineno-80-52"></a>  Scenario:                                           
<a id="__codelineno-80-53" name="__codelineno-80-53" href="#__codelineno-80-53"></a>  T1 keeps winning, T2 keeps losing:                  
<a id="__codelineno-80-54" name="__codelineno-80-54" href="#__codelineno-80-54"></a>  T2: Try  Fail  Retry  Fail  Retry...           
<a id="__codelineno-80-55" name="__codelineno-80-55" href="#__codelineno-80-55"></a>   May never complete!                               
<a id="__codelineno-80-56" name="__codelineno-80-56" href="#__codelineno-80-56"></a>                                                      
<a id="__codelineno-80-57" name="__codelineno-80-57" href="#__codelineno-80-57"></a>  Mitigation needed:                                  
<a id="__codelineno-80-58" name="__codelineno-80-58" href="#__codelineno-80-58"></a>   Priority-based backoff                            
<a id="__codelineno-80-59" name="__codelineno-80-59" href="#__codelineno-80-59"></a>   Max retry then switch to pessimistic              
<a id="__codelineno-80-60" name="__codelineno-80-60" href="#__codelineno-80-60"></a>   Jittered delays                                   
<a id="__codelineno-80-61" name="__codelineno-80-61" href="#__codelineno-80-61"></a>          
<a id="__codelineno-80-62" name="__codelineno-80-62" href="#__codelineno-80-62"></a>                                                         
<a id="__codelineno-80-63" name="__codelineno-80-63" href="#__codelineno-80-63"></a> 4.  UNPREDICTABLE PERFORMANCE                         
<a id="__codelineno-80-64" name="__codelineno-80-64" href="#__codelineno-80-64"></a>          
<a id="__codelineno-80-65" name="__codelineno-80-65" href="#__codelineno-80-65"></a>   Response time varies widely                       
<a id="__codelineno-80-66" name="__codelineno-80-66" href="#__codelineno-80-66"></a>   Depends on contention level                       
<a id="__codelineno-80-67" name="__codelineno-80-67" href="#__codelineno-80-67"></a>   Can suddenly degrade                              
<a id="__codelineno-80-68" name="__codelineno-80-68" href="#__codelineno-80-68"></a>   Difficult to give SLA guarantees                  
<a id="__codelineno-80-69" name="__codelineno-80-69" href="#__codelineno-80-69"></a>                                                      
<a id="__codelineno-80-70" name="__codelineno-80-70" href="#__codelineno-80-70"></a>  Latency variance:                                   
<a id="__codelineno-80-71" name="__codelineno-80-71" href="#__codelineno-80-71"></a>  Attempt 1: 10ms                                     
<a id="__codelineno-80-72" name="__codelineno-80-72" href="#__codelineno-80-72"></a>  Attempt 2: 30ms (1 retry)                           
<a id="__codelineno-80-73" name="__codelineno-80-73" href="#__codelineno-80-73"></a>  Attempt 3: 70ms (2 retries)                         
<a id="__codelineno-80-74" name="__codelineno-80-74" href="#__codelineno-80-74"></a>  Attempt 4: 150ms (3 retries)                        
<a id="__codelineno-80-75" name="__codelineno-80-75" href="#__codelineno-80-75"></a>   Highly variable!                                  
<a id="__codelineno-80-76" name="__codelineno-80-76" href="#__codelineno-80-76"></a>                                                      
<a id="__codelineno-80-77" name="__codelineno-80-77" href="#__codelineno-80-77"></a>  P50: 10ms, P95: 150ms, P99: 500ms                   
<a id="__codelineno-80-78" name="__codelineno-80-78" href="#__codelineno-80-78"></a>  (vs pessimistic: P50/P95/P99 all ~50ms)             
<a id="__codelineno-80-79" name="__codelineno-80-79" href="#__codelineno-80-79"></a>          
<a id="__codelineno-80-80" name="__codelineno-80-80" href="#__codelineno-80-80"></a>                                                         
<a id="__codelineno-80-81" name="__codelineno-80-81" href="#__codelineno-80-81"></a> 5.  UNSUITABLE FOR HIGH CONTENTION                    
<a id="__codelineno-80-82" name="__codelineno-80-82" href="#__codelineno-80-82"></a>          
<a id="__codelineno-80-83" name="__codelineno-80-83" href="#__codelineno-80-83"></a>   Conflict rate increases exponentially             
<a id="__codelineno-80-84" name="__codelineno-80-84" href="#__codelineno-80-84"></a>   Retry storm cascades                              
<a id="__codelineno-80-85" name="__codelineno-80-85" href="#__codelineno-80-85"></a>   System thrashing                                  
<a id="__codelineno-80-86" name="__codelineno-80-86" href="#__codelineno-80-86"></a>   Throughput collapses                              
<a id="__codelineno-80-87" name="__codelineno-80-87" href="#__codelineno-80-87"></a>                                                      
<a id="__codelineno-80-88" name="__codelineno-80-88" href="#__codelineno-80-88"></a>  Math:                                               
<a id="__codelineno-80-89" name="__codelineno-80-89" href="#__codelineno-80-89"></a>  N transactions competing:                           
<a id="__codelineno-80-90" name="__codelineno-80-90" href="#__codelineno-80-90"></a>   Success rate: 1/N                                 
<a id="__codelineno-80-91" name="__codelineno-80-91" href="#__codelineno-80-91"></a>   Expected retries: N-1 per transaction             
<a id="__codelineno-80-92" name="__codelineno-80-92" href="#__codelineno-80-92"></a>   Total work: O(N)                                 
<a id="__codelineno-80-93" name="__codelineno-80-93" href="#__codelineno-80-93"></a>                                                      
<a id="__codelineno-80-94" name="__codelineno-80-94" href="#__codelineno-80-94"></a>  Example (N=100):                                    
<a id="__codelineno-80-95" name="__codelineno-80-95" href="#__codelineno-80-95"></a>   99% transactions fail first try                   
<a id="__codelineno-80-96" name="__codelineno-80-96" href="#__codelineno-80-96"></a>   Average 99 retries each                           
<a id="__codelineno-80-97" name="__codelineno-80-97" href="#__codelineno-80-97"></a>   System overloaded!                                
<a id="__codelineno-80-98" name="__codelineno-80-98" href="#__codelineno-80-98"></a>          
<a id="__codelineno-80-99" name="__codelineno-80-99" href="#__codelineno-80-99"></a>                                                         
<a id="__codelineno-80-100" name="__codelineno-80-100" href="#__codelineno-80-100"></a> 6.  VALIDATION OVERHEAD                               
<a id="__codelineno-80-101" name="__codelineno-80-101" href="#__codelineno-80-101"></a>          
<a id="__codelineno-80-102" name="__codelineno-80-102" href="#__codelineno-80-102"></a>   Version check at every commit                     
<a id="__codelineno-80-103" name="__codelineno-80-103" href="#__codelineno-80-103"></a>   Additional database round trip                    
<a id="__codelineno-80-104" name="__codelineno-80-104" href="#__codelineno-80-104"></a>   Conditional UPDATE complexity                     
<a id="__codelineno-80-105" name="__codelineno-80-105" href="#__codelineno-80-105"></a>   Index overhead for version columns                
<a id="__codelineno-80-106" name="__codelineno-80-106" href="#__codelineno-80-106"></a>                                                      
<a id="__codelineno-80-107" name="__codelineno-80-107" href="#__codelineno-80-107"></a>  Overhead per transaction:                           
<a id="__codelineno-80-108" name="__codelineno-80-108" href="#__codelineno-80-108"></a>   Read version: 1-5ms                               
<a id="__codelineno-80-109" name="__codelineno-80-109" href="#__codelineno-80-109"></a>   Validate + update: 2-10ms                         
<a id="__codelineno-80-110" name="__codelineno-80-110" href="#__codelineno-80-110"></a>   Total: 3-15ms added latency                       
<a id="__codelineno-80-111" name="__codelineno-80-111" href="#__codelineno-80-111"></a>          
<a id="__codelineno-80-112" name="__codelineno-80-112" href="#__codelineno-80-112"></a>                                                         
<a id="__codelineno-80-113" name="__codelineno-80-113" href="#__codelineno-80-113"></a> 7.  DIFFICULT USER EXPERIENCE                         
<a id="__codelineno-80-114" name="__codelineno-80-114" href="#__codelineno-80-114"></a>          
<a id="__codelineno-80-115" name="__codelineno-80-115" href="#__codelineno-80-115"></a>   Users see &quot;conflict&quot; errors                       
<a id="__codelineno-80-116" name="__codelineno-80-116" href="#__codelineno-80-116"></a>   Need to re-enter data                             
<a id="__codelineno-80-117" name="__codelineno-80-117" href="#__codelineno-80-117"></a>   Frustrating experience                            
<a id="__codelineno-80-118" name="__codelineno-80-118" href="#__codelineno-80-118"></a>   Requires good UX design                           
<a id="__codelineno-80-119" name="__codelineno-80-119" href="#__codelineno-80-119"></a>                                                      
<a id="__codelineno-80-120" name="__codelineno-80-120" href="#__codelineno-80-120"></a>  User sees:                                          
<a id="__codelineno-80-121" name="__codelineno-80-121" href="#__codelineno-80-121"></a>  &quot;Someone else modified this record.                 
<a id="__codelineno-80-122" name="__codelineno-80-122" href="#__codelineno-80-122"></a>  Please refresh and try again.&quot;                       
<a id="__codelineno-80-123" name="__codelineno-80-123" href="#__codelineno-80-123"></a>                                                      
<a id="__codelineno-80-124" name="__codelineno-80-124" href="#__codelineno-80-124"></a>  vs Pessimistic:                                     
<a id="__codelineno-80-125" name="__codelineno-80-125" href="#__codelineno-80-125"></a>  User just waits (transparent)                       
<a id="__codelineno-80-126" name="__codelineno-80-126" href="#__codelineno-80-126"></a>          
<a id="__codelineno-80-127" name="__codelineno-80-127" href="#__codelineno-80-127"></a>                                                         
<a id="__codelineno-80-128" name="__codelineno-80-128" href="#__codelineno-80-128"></a> 8.  CANNOT HANDLE EXTERNAL SIDE EFFECTS               
<a id="__codelineno-80-129" name="__codelineno-80-129" href="#__codelineno-80-129"></a>          
<a id="__codelineno-80-130" name="__codelineno-80-130" href="#__codelineno-80-130"></a>   Can&#39;t rollback API calls                          
<a id="__codelineno-80-131" name="__codelineno-80-131" href="#__codelineno-80-131"></a>   Can&#39;t undo sent emails                            
<a id="__codelineno-80-132" name="__codelineno-80-132" href="#__codelineno-80-132"></a>   Can&#39;t reverse payment authorizations              
<a id="__codelineno-80-133" name="__codelineno-80-133" href="#__codelineno-80-133"></a>   Can&#39;t undo file writes                            
<a id="__codelineno-80-134" name="__codelineno-80-134" href="#__codelineno-80-134"></a>                                                      
<a id="__codelineno-80-135" name="__codelineno-80-135" href="#__codelineno-80-135"></a>  Problem:                                            
<a id="__codelineno-80-136" name="__codelineno-80-136" href="#__codelineno-80-136"></a>  Transaction does:                                   
<a id="__codelineno-80-137" name="__codelineno-80-137" href="#__codelineno-80-137"></a>  1. Charge credit card (external API)                
<a id="__codelineno-80-138" name="__codelineno-80-138" href="#__codelineno-80-138"></a>  2. Update database                                  
<a id="__codelineno-80-139" name="__codelineno-80-139" href="#__codelineno-80-139"></a>  3. Validation fails!                                
<a id="__codelineno-80-140" name="__codelineno-80-140" href="#__codelineno-80-140"></a>  4. Rollback database                               
<a id="__codelineno-80-141" name="__codelineno-80-141" href="#__codelineno-80-141"></a>  5. Rollback credit card charge?                   
<a id="__codelineno-80-142" name="__codelineno-80-142" href="#__codelineno-80-142"></a>     (Already processed!)                             
<a id="__codelineno-80-143" name="__codelineno-80-143" href="#__codelineno-80-143"></a>                                                      
<a id="__codelineno-80-144" name="__codelineno-80-144" href="#__codelineno-80-144"></a>   Inconsistent state!                               
<a id="__codelineno-80-145" name="__codelineno-80-145" href="#__codelineno-80-145"></a>          
<a id="__codelineno-80-146" name="__codelineno-80-146" href="#__codelineno-80-146"></a>                                                         
<a id="__codelineno-80-147" name="__codelineno-80-147" href="#__codelineno-80-147"></a> 9.  COMPLEX MONITORING                                
<a id="__codelineno-80-148" name="__codelineno-80-148" href="#__codelineno-80-148"></a>          
<a id="__codelineno-80-149" name="__codelineno-80-149" href="#__codelineno-80-149"></a>   Need to track retry rates                         
<a id="__codelineno-80-150" name="__codelineno-80-150" href="#__codelineno-80-150"></a>   Monitor conflict rates                            
<a id="__codelineno-80-151" name="__codelineno-80-151" href="#__codelineno-80-151"></a>   Detect retry storms                               
<a id="__codelineno-80-152" name="__codelineno-80-152" href="#__codelineno-80-152"></a>   Alert on high failure rates                       
<a id="__codelineno-80-153" name="__codelineno-80-153" href="#__codelineno-80-153"></a>                                                      
<a id="__codelineno-80-154" name="__codelineno-80-154" href="#__codelineno-80-154"></a>  Metrics needed:                                     
<a id="__codelineno-80-155" name="__codelineno-80-155" href="#__codelineno-80-155"></a>   Conflicts per second                              
<a id="__codelineno-80-156" name="__codelineno-80-156" href="#__codelineno-80-156"></a>   Retry distribution                                
<a id="__codelineno-80-157" name="__codelineno-80-157" href="#__codelineno-80-157"></a>   Transaction success rate                          
<a id="__codelineno-80-158" name="__codelineno-80-158" href="#__codelineno-80-158"></a>   Starvation detection                              
<a id="__codelineno-80-159" name="__codelineno-80-159" href="#__codelineno-80-159"></a>          
<a id="__codelineno-80-160" name="__codelineno-80-160" href="#__codelineno-80-160"></a>                                                         
<a id="__codelineno-80-161" name="__codelineno-80-161" href="#__codelineno-80-161"></a> 10.  VERSION COLUMN MANAGEMENT                        
<a id="__codelineno-80-162" name="__codelineno-80-162" href="#__codelineno-80-162"></a>          
<a id="__codelineno-80-163" name="__codelineno-80-163" href="#__codelineno-80-163"></a>   Every table needs version column                  
<a id="__codelineno-80-164" name="__codelineno-80-164" href="#__codelineno-80-164"></a>   Schema changes required                           
<a id="__codelineno-80-165" name="__codelineno-80-165" href="#__codelineno-80-165"></a>   Must maintain version consistency                 
<a id="__codelineno-80-166" name="__codelineno-80-166" href="#__codelineno-80-166"></a>   Can overflow (need wraparound handling)           
<a id="__codelineno-80-167" name="__codelineno-80-167" href="#__codelineno-80-167"></a>                                                      
<a id="__codelineno-80-168" name="__codelineno-80-168" href="#__codelineno-80-168"></a>  Requirements:                                       
<a id="__codelineno-80-169" name="__codelineno-80-169" href="#__codelineno-80-169"></a>   Add version to all tables                         
<a id="__codelineno-80-170" name="__codelineno-80-170" href="#__codelineno-80-170"></a>   Increment on every update                         
<a id="__codelineno-80-171" name="__codelineno-80-171" href="#__codelineno-80-171"></a>   Include in all WHERE clauses                      
<a id="__codelineno-80-172" name="__codelineno-80-172" href="#__codelineno-80-172"></a>   Handle version overflow                           
<a id="__codelineno-80-173" name="__codelineno-80-173" href="#__codelineno-80-173"></a>          
<a id="__codelineno-80-174" name="__codelineno-80-174" href="#__codelineno-80-174"></a>                                                         
<a id="__codelineno-80-175" name="__codelineno-80-175" href="#__codelineno-80-175"></a>
</code></pre></div>
<hr />
<h5 id="443-side-by-side-summary">4.4.3 Side-by-Side Summary</h5>
<p><strong>Quick Reference Table:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>         PESSIMISTIC vs OPTIMISTIC - PROS &amp; CONS SUMMARY                  
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>                                                                          
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>  Criteria             Pessimistic         Optimistic                  
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>       
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>  Blocking              High              None                      
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>  Deadlocks             Possible          Impossible                
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>  Wasted Work           None              High (on conflicts)       
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>  Retry Needed          No                Yes                       
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>  Throughput (Low )   Lower             Higher                    
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>  Throughput (High)   Stable            Degrades                  
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>  Latency Variance      Low               High                      
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>  Code Complexity       Simple            Complex                   
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a>  Overhead              Lock mgmt         Minimal                   
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a>  Scalability           Limited           Excellent                 
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a>  Consistency           Strong            Strong (with validation)  
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a>  User Experience       Transparent       May see errors            
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a>  Monitoring            Straightforward   Complex                   
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a>  Distributed Systems   Difficult         Natural fit               
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a>                                                                          
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a>  Best For:                                                               
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a>   High contention                                                 
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>   Low contention                                                  
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a>   Read-heavy                                                      
<a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a>   Write-heavy                                                     
<a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a>   Critical data                                                   
<a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a>   Real-time                             (if low contention)       
<a id="__codelineno-81-29" name="__codelineno-81-29" href="#__codelineno-81-29"></a>                                                                          
<a id="__codelineno-81-30" name="__codelineno-81-30" href="#__codelineno-81-30"></a>
</code></pre></div>
<p><strong>When to Choose Each:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">choose_concurrency_control</span><span class="p">(</span><span class="n">workload</span><span class="p">):</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decision helper for choosing concurrency control&quot;&quot;&quot;</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>    <span class="c1"># Measure workload characteristics</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>    <span class="n">conflict_rate</span> <span class="o">=</span> <span class="n">measure_conflict_rate</span><span class="p">()</span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>    <span class="n">read_write_ratio</span> <span class="o">=</span> <span class="n">measure_read_write_ratio</span><span class="p">()</span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>    <span class="n">transaction_duration</span> <span class="o">=</span> <span class="n">measure_avg_transaction_duration</span><span class="p">()</span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>    <span class="n">is_distributed</span> <span class="o">=</span> <span class="n">check_if_distributed_system</span><span class="p">()</span>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>
<a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a>    <span class="c1"># Decision logic</span>
<a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a>    <span class="k">if</span> <span class="n">conflict_rate</span> <span class="o">&gt;</span> <span class="mf">0.20</span><span class="p">:</span>  <span class="c1"># &gt;20% conflicts</span>
<a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a>        <span class="k">return</span> <span class="s2">&quot;PESSIMISTIC&quot;</span>
<a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a>        <span class="c1"># Reason: Too many retries will waste resources</span>
<a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a>
<a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a>    <span class="k">if</span> <span class="n">transaction_duration</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># &gt;10 seconds</span>
<a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a>        <span class="k">return</span> <span class="s2">&quot;PESSIMISTIC&quot;</span>
<a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a>        <span class="c1"># Reason: Long transactions likely to conflict</span>
<a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a>
<a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a>    <span class="k">if</span> <span class="n">read_write_ratio</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># &lt;50% reads (write-heavy)</span>
<a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a>        <span class="k">return</span> <span class="s2">&quot;PESSIMISTIC&quot;</span>
<a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a>        <span class="c1"># Reason: Writes always conflict in optimistic</span>
<a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a>
<a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a>    <span class="k">if</span> <span class="n">is_distributed</span><span class="p">:</span>
<a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a>        <span class="k">return</span> <span class="s2">&quot;OPTIMISTIC&quot;</span>
<a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a>        <span class="c1"># Reason: Distributed locks are expensive</span>
<a id="__codelineno-82-26" name="__codelineno-82-26" href="#__codelineno-82-26"></a>
<a id="__codelineno-82-27" name="__codelineno-82-27" href="#__codelineno-82-27"></a>    <span class="k">if</span> <span class="n">read_write_ratio</span> <span class="o">&gt;</span> <span class="mf">0.90</span><span class="p">:</span>  <span class="c1"># &gt;90% reads</span>
<a id="__codelineno-82-28" name="__codelineno-82-28" href="#__codelineno-82-28"></a>        <span class="k">return</span> <span class="s2">&quot;OPTIMISTIC&quot;</span>
<a id="__codelineno-82-29" name="__codelineno-82-29" href="#__codelineno-82-29"></a>        <span class="c1"># Reason: Excellent for read-heavy workloads</span>
<a id="__codelineno-82-30" name="__codelineno-82-30" href="#__codelineno-82-30"></a>
<a id="__codelineno-82-31" name="__codelineno-82-31" href="#__codelineno-82-31"></a>    <span class="c1"># Default to pessimistic for safety</span>
<a id="__codelineno-82-32" name="__codelineno-82-32" href="#__codelineno-82-32"></a>    <span class="k">return</span> <span class="s2">&quot;PESSIMISTIC&quot;</span>
</code></pre></div>
<hr />
<h3 id="45-two-phase-locking-2pl-protocol">4.5 Two-Phase Locking (2PL) Protocol</h3>
<p><strong>Description:</strong></p>
<p><strong>Two-Phase Locking (2PL)</strong> is a fundamental concurrency control protocol used in pessimistic concurrency control to ensure serializability. It's called "two-phase" because lock acquisition and release happen in two distinct phases. 2PL is the <strong>most widely used</strong> locking protocol in traditional database systems and is crucial for maintaining data consistency in concurrent environments.</p>
<p><strong>Historical Context and Importance:</strong></p>
<p>Two-Phase Locking was first formalized by <strong>K.P. Eswaran, J.N. Gray, R.A. Lorie, and I.L. Traiger</strong> at IBM in their seminal 1976 paper "The Notions of Consistency and Predicate Locks in a Database System." This groundbreaking work laid the foundation for modern transaction processing systems and remains the cornerstone of concurrency control in relational databases today.</p>
<p>The protocol emerged from the need to solve a critical problem: <strong>how to allow multiple transactions to execute concurrently while guaranteeing that the results are equivalent to some serial execution order</strong>. Before 2PL, database systems either ran transactions serially (slow) or allowed uncontrolled concurrent access (incorrect results). 2PL provided the first practical solution that balanced correctness with performance.</p>
<p><strong>Why 2PL Matters:</strong></p>
<ol>
<li>
<p><strong>Industry Standard</strong>: Over 90% of production relational databases (MySQL, PostgreSQL, Oracle, SQL Server, DB2) use variants of 2PL as their default concurrency control mechanism. When you execute a transaction with <code>BEGIN...COMMIT</code>, you're likely using 2PL under the hood.</p>
</li>
<li>
<p><strong>Theoretical Foundation</strong>: 2PL is <strong>provably correct</strong> - it guarantees serializability through a simple, elegant protocol. This mathematical guarantee gives database developers confidence that their concurrent transactions will produce correct results.</p>
</li>
<li>
<p><strong>Practical Performance</strong>: While optimistic concurrency control can outperform 2PL in low-contention scenarios, 2PL provides <strong>predictable, stable performance</strong> across varying workloads, making it the safe default choice for general-purpose databases.</p>
</li>
<li>
<p><strong>Decades of Optimization</strong>: Modern databases have refined 2PL implementations with sophisticated lock managers, deadlock detection algorithms, lock escalation strategies, and multi-granularity locking. This accumulated engineering effort makes 2PL implementations extremely efficient.</p>
</li>
</ol>
<p><strong>Core Problem 2PL Solves:</strong></p>
<p>Consider this scenario without proper locking discipline:
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>T1: Read(A)  Process  Read(B)  Write(C)
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>T2: Write(A)  Read(B)  Write(C)
</code></pre></div></p>
<p>If locks can be acquired and released arbitrarily, we might see:
- T1 reads old value of A
- T2 updates A (T1 hasn't locked it yet)
- T1 reads B and computes C based on old A and current B
- Result: <strong>Non-serializable!</strong> (Mixed data from different time points)</p>
<p>2PL prevents this by enforcing a strict discipline: once you start releasing locks, you can never acquire new ones. This simple rule ensures that each transaction sees a <strong>consistent snapshot</strong> of the database and that concurrent execution is equivalent to some serial order.</p>
<p><strong>Real-World Impact:</strong></p>
<p>Every time you:
- Transfer money between bank accounts
- Book an airline seat
- Update your social media profile
- Place an e-commerce order
- Reserve a hotel room</p>
<p>...there's a high probability that 2PL is working behind the scenes to ensure your transaction doesn't interfere with others and that you see consistent data.</p>
<p>Understanding 2PL is essential for:
- <strong>Database Administrators</strong>: Tuning isolation levels and diagnosing deadlocks
- <strong>Backend Developers</strong>: Writing correct concurrent code and avoiding race conditions
- <strong>System Architects</strong>: Choosing appropriate concurrency control strategies
- <strong>Performance Engineers</strong>: Optimizing transaction throughput and latency</p>
<h4 id="451-what-is-two-phase-locking">4.5.1 What is Two-Phase Locking?</h4>
<p><strong>Definition:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>         TWO-PHASE LOCKING (2PL) DEFINITION              
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>                                                         
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>  Two-Phase Locking is a concurrency control protocol    
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>  that divides transaction execution into TWO phases:    
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>                                                         
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>          
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>   PHASE 1: GROWING PHASE (Expansion)                 
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>                   
<a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>    Transaction MAY acquire locks                    
<a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>    Transaction CANNOT release any lock              
<a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>    Locks accumulate (grow)                          
<a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a>    Continues until all needed locks held            
<a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>          
<a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a>                                                        
<a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>              LOCK POINT                                 
<a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>         (Maximum locks held)                            
<a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a>                                                        
<a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a>          
<a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>   PHASE 2: SHRINKING PHASE (Contraction)             
<a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a>                    
<a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a>    Transaction MAY release locks                    
<a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a>    Transaction CANNOT acquire new locks             
<a id="__codelineno-84-25" name="__codelineno-84-25" href="#__codelineno-84-25"></a>    Locks decrease (shrink)                          
<a id="__codelineno-84-26" name="__codelineno-84-26" href="#__codelineno-84-26"></a>    Continues until all locks released               
<a id="__codelineno-84-27" name="__codelineno-84-27" href="#__codelineno-84-27"></a>          
<a id="__codelineno-84-28" name="__codelineno-84-28" href="#__codelineno-84-28"></a>                                                         
<a id="__codelineno-84-29" name="__codelineno-84-29" href="#__codelineno-84-29"></a>  KEY RULE: Once you release ANY lock, you can          
<a id="__codelineno-84-30" name="__codelineno-84-30" href="#__codelineno-84-30"></a>            NEVER acquire another lock!                  
<a id="__codelineno-84-31" name="__codelineno-84-31" href="#__codelineno-84-31"></a>                                                         
<a id="__codelineno-84-32" name="__codelineno-84-32" href="#__codelineno-84-32"></a>
</code></pre></div>
<p><strong>Visual Timeline - 2PL Phases:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>       TWO-PHASE LOCKING - TIMELINE DIAGRAM              
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a>                                                         
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>  Number of                                              
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a>  Locks Held                                             
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>                                                        
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a>                         LOCK POINT                     
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a>                                                       
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>                                                      
<a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a>    5                                                 
<a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a>                                                      
<a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a>    4                                                 
<a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a>                                                      
<a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a>    3                                                 
<a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a>                                                      
<a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a>    2                                                 
<a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a>                                                      
<a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a>    1                                         
<a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a>                                                      
<a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a>    0                                
<a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a>          
<a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a>              BEGIN                            COMMIT    
<a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a>                                                         
<a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a>      GROWING PHASESHRINKING PHASE     
<a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a>                                                         
<a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a>      Actions in each phase:                             
<a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a>                                                         
<a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a>      GROWING:                 SHRINKING:                
<a id="__codelineno-85-30" name="__codelineno-85-30" href="#__codelineno-85-30"></a>       Lock(A)                 Unlock(C)               
<a id="__codelineno-85-31" name="__codelineno-85-31" href="#__codelineno-85-31"></a>       Lock(B)                 Unlock(D)               
<a id="__codelineno-85-32" name="__codelineno-85-32" href="#__codelineno-85-32"></a>       Lock(C)                 Unlock(B)               
<a id="__codelineno-85-33" name="__codelineno-85-33" href="#__codelineno-85-33"></a>       Lock(D)                 Unlock(A)               
<a id="__codelineno-85-34" name="__codelineno-85-34" href="#__codelineno-85-34"></a>       Lock(E)                 Unlock(E)               
<a id="__codelineno-85-35" name="__codelineno-85-35" href="#__codelineno-85-35"></a>       Can only ACQUIRE        Can only RELEASE        
<a id="__codelineno-85-36" name="__codelineno-85-36" href="#__codelineno-85-36"></a>                                                         
<a id="__codelineno-85-37" name="__codelineno-85-37" href="#__codelineno-85-37"></a>
</code></pre></div>
<p><strong>Detailed Example with Banking Transfer:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>        2PL EXAMPLE: BANK TRANSFER                       
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>                                                         
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a> Transaction: Transfer $100 from Account A to Account B 
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>                                                         
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a> Time  Action                    Phase      Locks Held   
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a> 
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a> t1    BEGIN TRANSACTION         -          []           
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>                                                         
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>                 
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a>            GROWING PHASE BEGINS                      
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a>                 
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>                                                         
<a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a> t2    SELECT balance FROM       GROWING    [A-shared]  
<a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a>       accounts WHERE id=A                               
<a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a>       FOR SHARE                                         
<a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a>        Acquire SHARED lock on A                        
<a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a>                                                         
<a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a> t3    SELECT balance FROM       GROWING    [A-shared,  
<a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a>       accounts WHERE id=B                   B-shared]   
<a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a>       FOR SHARE                                         
<a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a>        Acquire SHARED lock on B                        
<a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a>                                                         
<a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a> t4    Validate: balance_A &gt;= 100 GROWING   [A-shared,  
<a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a>                                             B-shared]   
<a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a>                                                         
<a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a> t5    UPDATE accounts SET       GROWING    [A-excl,    
<a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a>       balance = balance - 100               B-shared]   
<a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a>       WHERE id=A                                        
<a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a>        Upgrade to EXCLUSIVE lock on A                  
<a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a>                                                         
<a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a> t6    UPDATE accounts SET       GROWING    [A-excl,    
<a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a>       balance = balance + 100               B-excl]     
<a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a>       WHERE id=B                                        
<a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a>        Upgrade to EXCLUSIVE lock on B                  
<a id="__codelineno-86-37" name="__codelineno-86-37" href="#__codelineno-86-37"></a>                                                         
<a id="__codelineno-86-38" name="__codelineno-86-38" href="#__codelineno-86-38"></a>        LOCK POINT               
<a id="__codelineno-86-39" name="__codelineno-86-39" href="#__codelineno-86-39"></a>       (All locks acquired, maximum locks held)          
<a id="__codelineno-86-40" name="__codelineno-86-40" href="#__codelineno-86-40"></a>                                                         
<a id="__codelineno-86-41" name="__codelineno-86-41" href="#__codelineno-86-41"></a>                 
<a id="__codelineno-86-42" name="__codelineno-86-42" href="#__codelineno-86-42"></a>            SHRINKING PHASE BEGINS                    
<a id="__codelineno-86-43" name="__codelineno-86-43" href="#__codelineno-86-43"></a>                 
<a id="__codelineno-86-44" name="__codelineno-86-44" href="#__codelineno-86-44"></a>                                                         
<a id="__codelineno-86-45" name="__codelineno-86-45" href="#__codelineno-86-45"></a> t7    COMMIT                    SHRINKING  []           
<a id="__codelineno-86-46" name="__codelineno-86-46" href="#__codelineno-86-46"></a>        Release ALL locks                               
<a id="__codelineno-86-47" name="__codelineno-86-47" href="#__codelineno-86-47"></a>       (A-excl released)                                 
<a id="__codelineno-86-48" name="__codelineno-86-48" href="#__codelineno-86-48"></a>       (B-excl released)                                 
<a id="__codelineno-86-49" name="__codelineno-86-49" href="#__codelineno-86-49"></a>                                                         
<a id="__codelineno-86-50" name="__codelineno-86-50" href="#__codelineno-86-50"></a> t8    END TRANSACTION           -          []           
<a id="__codelineno-86-51" name="__codelineno-86-51" href="#__codelineno-86-51"></a>                                                         
<a id="__codelineno-86-52" name="__codelineno-86-52" href="#__codelineno-86-52"></a>  2PL Protocol followed correctly!                      
<a id="__codelineno-86-53" name="__codelineno-86-53" href="#__codelineno-86-53"></a>                                                         
<a id="__codelineno-86-54" name="__codelineno-86-54" href="#__codelineno-86-54"></a>
</code></pre></div>
<p><strong>What 2PL Guarantees:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>           2PL GUARANTEES                                
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>                                                         
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a> 1.  SERIALIZABILITY                                   
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>                
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>     All transactions following 2PL                   
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>     produce results equivalent to some               
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>     serial execution order                           
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>                                                      
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>     Concurrent execution = Serial order              
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>                
<a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>                                                         
<a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a> 2.  CONFLICT SERIALIZABILITY                          
<a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a>                
<a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a>     No dirty reads, no lost updates,                 
<a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a>     no inconsistent reads                            
<a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a>                                                      
<a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a>     Conflicts resolved by lock ordering              
<a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a>                
<a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a>                                                         
<a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a> 3.   CASCADING ABORTS POSSIBLE                        
<a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a>                
<a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a>     If T1 aborts, transactions that read             
<a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a>     T1&#39;s uncommitted data must also abort            
<a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a>                                                      
<a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a>     (Solved by Strict 2PL - see below)               
<a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a>                
<a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a>                                                         
<a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a>
</code></pre></div>
<p><strong>Violation Example (What NOT to do):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>        INVALID - 2PL VIOLATION                          
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>                                                         
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a> Time  Action                    Phase      Locks Held   
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a> 
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a> t1    BEGIN                     -          []           
<a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a> t2    Lock(A)                   GROWING    [A]          
<a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a> t3    Lock(B)                   GROWING    [A, B]       
<a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a> t4    READ A, READ B            GROWING    [A, B]       
<a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a> t5    Unlock(A)               SHRINKING  [B]          
<a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>       (Shrinking phase started!)                        
<a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a> t6    Lock(C)              SHRINKING  -            
<a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a>        VIOLATION! Cannot acquire lock                  
<a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>         after releasing any lock!                       
<a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a>                                                         
<a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a> This violates 2PL protocol!                             
<a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a> Serializability NOT guaranteed!                         
<a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>                                                         
<a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a>
</code></pre></div>
<hr />
<h4 id="452-where-is-2pl-used">4.5.2 Where is 2PL Used?</h4>
<p><strong>Description:</strong></p>
<p>Two-Phase Locking isn't just an academic concept - it's the <strong>workhorse protocol</strong> powering mission-critical systems worldwide, processing billions of transactions daily. From Wall Street trading systems executing millions of stock trades per second, to airline reservation systems booking flights for millions of passengers, to e-commerce platforms handling Black Friday shopping surges, 2PL is the invisible guardian ensuring data consistency.</p>
<p>The widespread adoption of 2PL across virtually all major database systems isn't coincidental - it reflects the protocol's proven track record of <strong>reliability, correctness, and performance</strong> in production environments. When companies like banks, hospitals, and government agencies choose database systems, they're implicitly choosing 2PL because it's been battle-tested for nearly five decades.</p>
<p><strong>Why 2PL Dominates Production Systems:</strong></p>
<ol>
<li>
<p><strong>Correctness Guarantee</strong>: Unlike application-level locking (prone to human error), 2PL is enforced automatically by the database engine. Developers can't accidentally break serializability.</p>
</li>
<li>
<p><strong>Transparent to Applications</strong>: Developers write <code>BEGIN...COMMIT</code> blocks, and 2PL handles all the complex lock acquisition/release logic automatically. No manual lock management needed.</p>
</li>
<li>
<p><strong>Vendor Support</strong>: All major database vendors provide enterprise support, monitoring tools, and optimization features specifically for 2PL-based systems.</p>
</li>
<li>
<p><strong>Ecosystem Maturity</strong>: Decades of tooling, debugging utilities, performance analyzers, and best practices documentation exist for 2PL.</p>
</li>
</ol>
<p><strong>Real-World Database Systems:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>         2PL USAGE IN DATABASE SYSTEMS                   
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>                                                         
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a> 1. TRADITIONAL RELATIONAL DATABASES                     
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>                
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>      MySQL/InnoDB (Strict 2PL)                      
<a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>      PostgreSQL (Strict 2PL)                        
<a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>      Oracle Database (Strict 2PL)                   
<a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>      SQL Server (Strict 2PL)                        
<a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>      DB2 (Strict 2PL)                               
<a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a>                
<a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a>                                                         
<a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a> 2. TRANSACTION PROCESSING SYSTEMS                       
<a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a>                
<a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a>      Banking systems (account transfers)             
<a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a>      E-commerce (order processing)                  
<a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a>      Airline reservation systems                    
<a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>      Stock trading platforms                        
<a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a>      Payment gateways                               
<a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a>                
<a id="__codelineno-89-22" name="__codelineno-89-22" href="#__codelineno-89-22"></a>                                                         
<a id="__codelineno-89-23" name="__codelineno-89-23" href="#__codelineno-89-23"></a> 3. EMBEDDED DATABASES                                   
<a id="__codelineno-89-24" name="__codelineno-89-24" href="#__codelineno-89-24"></a>                
<a id="__codelineno-89-25" name="__codelineno-89-25" href="#__codelineno-89-25"></a>      SQLite (2PL variant)                           
<a id="__codelineno-89-26" name="__codelineno-89-26" href="#__codelineno-89-26"></a>      Berkeley DB                                    
<a id="__codelineno-89-27" name="__codelineno-89-27" href="#__codelineno-89-27"></a>                
<a id="__codelineno-89-28" name="__codelineno-89-28" href="#__codelineno-89-28"></a>                                                         
<a id="__codelineno-89-29" name="__codelineno-89-29" href="#__codelineno-89-29"></a> 4. IN-MEMORY DATABASES                                  
<a id="__codelineno-89-30" name="__codelineno-89-30" href="#__codelineno-89-30"></a>                
<a id="__codelineno-89-31" name="__codelineno-89-31" href="#__codelineno-89-31"></a>      Redis (transaction blocks)                     
<a id="__codelineno-89-32" name="__codelineno-89-32" href="#__codelineno-89-32"></a>      Memcached (with extensions)                    
<a id="__codelineno-89-33" name="__codelineno-89-33" href="#__codelineno-89-33"></a>                
<a id="__codelineno-89-34" name="__codelineno-89-34" href="#__codelineno-89-34"></a>                                                         
<a id="__codelineno-89-35" name="__codelineno-89-35" href="#__codelineno-89-35"></a> 5. DISTRIBUTED DATABASES (with adaptations)             
<a id="__codelineno-89-36" name="__codelineno-89-36" href="#__codelineno-89-36"></a>                
<a id="__codelineno-89-37" name="__codelineno-89-37" href="#__codelineno-89-37"></a>      Google Spanner (2PL + timestamps)              
<a id="__codelineno-89-38" name="__codelineno-89-38" href="#__codelineno-89-38"></a>      CockroachDB (Serializable SI)                  
<a id="__codelineno-89-39" name="__codelineno-89-39" href="#__codelineno-89-39"></a>      YugabyteDB                                     
<a id="__codelineno-89-40" name="__codelineno-89-40" href="#__codelineno-89-40"></a>                
<a id="__codelineno-89-41" name="__codelineno-89-41" href="#__codelineno-89-41"></a>                                                         
<a id="__codelineno-89-42" name="__codelineno-89-42" href="#__codelineno-89-42"></a>
</code></pre></div>
<p><strong>Use Cases by Industry:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>         2PL USE CASES BY INDUSTRY                       
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>                                                         
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>  BANKING &amp; FINANCE                                    
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>     Money transfers between accounts                   
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>     Loan processing                                    
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>     Credit/debit card transactions                     
<a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>     ATM withdrawals                                    
<a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>     Need: Strong consistency, no lost updates          
<a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>                                                         
<a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>  E-COMMERCE                                           
<a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>     Inventory management (prevent overselling)         
<a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>     Order placement                                    
<a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>     Shopping cart checkout                             
<a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a>     Payment processing                                 
<a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a>     Need: Prevent race conditions on stock             
<a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a>                                                         
<a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a>   AIRLINE/HOTEL RESERVATIONS                          
<a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a>     Seat/room booking                                  
<a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a>     Cancellations and refunds                          
<a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a>     Overbooking management                             
<a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a>     Need: Prevent double-booking                       
<a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a>                                                         
<a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a>  HEALTHCARE                                           
<a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a>     Patient record updates                             
<a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a>     Prescription management                            
<a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a>     Appointment scheduling                             
<a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a>     Need: Data integrity, audit trails                 
<a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a>                                                         
<a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a>  ENTERPRISE APPLICATIONS                              
<a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a>     ERP systems (inventory, HR, finance)               
<a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a>     CRM systems (customer data)                        
<a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a>     Accounting software                                
<a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a>     Need: Consistent business logic                    
<a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a>                                                         
<a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a>
</code></pre></div>
<hr />
<h4 id="453-how-2pl-is-useful-to-pessimistic-concurrency-control">4.5.3 How 2PL is Useful to Pessimistic Concurrency Control</h4>
<p><strong>Description:</strong></p>
<p>Pessimistic concurrency control without 2PL is like having a lock on your front door but no rules about when to use it - theoretically secure, but practically chaotic. While pessimistic locking provides the <strong>mechanism</strong> (locks), Two-Phase Locking provides the <strong>discipline</strong> (protocol) that makes those locks actually work correctly.</p>
<p><strong>The Fundamental Problem:</strong></p>
<p>Imagine a scenario where transactions can lock and unlock resources arbitrarily:
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>T1: Lock(A)  Read(A)  Unlock(A)  Lock(B)  Read(B)  Write(C)
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>T2: Lock(B)  Read(B)  Unlock(B)  Lock(A)  Read(A)  Write(C)
</code></pre></div></p>
<p>Even though both transactions use locks, they can still produce <strong>non-serializable results</strong>:
- T1 releases A before locking B
- T2 can now modify A (after T1 read it but before T1 completes)
- T1's computation of C is based on stale data
- Result: <strong>Lost update or inconsistent state</strong></p>
<p>This is called an <strong>inconsistent analysis</strong> problem - the transaction analyzes data that changes mid-transaction, leading to incorrect results.</p>
<p><strong>2PL as the Solution:</strong></p>
<p>2PL transforms pessimistic locking from a set of independent lock operations into a <strong>coherent protocol</strong> that guarantees correctness. It's the difference between:
- <strong>Without 2PL</strong>: "I have locks, so I'm probably safe" (hope-based concurrency)
- <strong>With 2PL</strong>: "I follow the protocol, so I'm provably safe" (science-based concurrency)</p>
<p><strong>Historical Perspective:</strong></p>
<p>In the early days of databases (1960s-1970s), developers manually managed locks in application code. This led to:
- <strong>Frequent bugs</strong>: Developers forgot to acquire locks, released them too early, or acquired them in wrong order
- <strong>Non-portable code</strong>: Lock logic tied to specific applications, hard to reuse
- <strong>No guarantees</strong>: No way to prove transactions would produce correct results</p>
<p>The introduction of 2PL moved locking from an <strong>ad-hoc application concern</strong> to a <strong>systematic database feature</strong>. This was as revolutionary as moving from manual memory management to garbage collection - it eliminated a whole class of bugs.</p>
<p><strong>Real-World Impact:</strong></p>
<p>Consider a banking system processing account transfers:</p>
<p><strong>Without 2PL</strong> (ad-hoc locking):
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="c1"># Bug-prone manual locking</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer</span><span class="p">(</span><span class="n">from_acc</span><span class="p">,</span> <span class="n">to_acc</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>    <span class="n">lock</span><span class="p">(</span><span class="n">from_acc</span><span class="p">)</span>           <span class="c1"># Lock first account</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">from_acc</span><span class="p">)</span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>    <span class="n">unlock</span><span class="p">(</span><span class="n">from_acc</span><span class="p">)</span>         <span class="c1">#  Released too early!</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>
<a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>    <span class="n">lock</span><span class="p">(</span><span class="n">to_acc</span><span class="p">)</span>            <span class="c1"># Another transaction can modify from_acc now!</span>
<a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>    <span class="n">write</span><span class="p">(</span><span class="n">from_acc</span><span class="p">,</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span><span class="p">)</span>  <span class="c1"># May overdraw!</span>
<a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>    <span class="n">write</span><span class="p">(</span><span class="n">to_acc</span><span class="p">,</span> <span class="n">read</span><span class="p">(</span><span class="n">to_acc</span><span class="p">)</span> <span class="o">+</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>    <span class="n">unlock</span><span class="p">(</span><span class="n">to_acc</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>With 2PL</strong> (enforced by database):
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="c1"># Safe and correct</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer</span><span class="p">(</span><span class="n">from_acc</span><span class="p">,</span> <span class="n">to_acc</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>    <span class="n">BEGIN</span> <span class="n">TRANSACTION</span>  <span class="c1"># Database automatically manages locks per 2PL</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>    <span class="n">balance</span> <span class="o">=</span> <span class="n">SELECT</span> <span class="n">balance</span> <span class="n">FROM</span> <span class="n">accounts</span> <span class="n">WHERE</span> <span class="nb">id</span><span class="o">=</span><span class="n">from_acc</span> <span class="n">FOR</span> <span class="n">UPDATE</span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>    <span class="c1"># Lock held automatically by 2PL protocol</span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>    <span class="n">UPDATE</span> <span class="n">accounts</span> <span class="n">SET</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span> <span class="n">WHERE</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">from_acc</span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>    <span class="n">UPDATE</span> <span class="n">accounts</span> <span class="n">SET</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">amount</span> <span class="n">WHERE</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">to_acc</span>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>    <span class="n">COMMIT</span>  <span class="c1"># Locks released only now, following 2PL</span>
</code></pre></div></p>
<p>The second version is not only safer but <strong>simpler</strong> - developers don't think about lock management at all.</p>
<p><strong>Why This Matters for System Design:</strong></p>
<p>When designing distributed systems or microservices, understanding 2PL helps you:
1. <strong>Recognize when you need it</strong>: Multi-step operations on shared data
2. <strong>Know its limitations</strong>: Network partitions can break 2PL assumptions
3. <strong>Choose alternatives wisely</strong>: When to use optimistic control or distributed consensus (Paxos, Raft)
4. <strong>Appreciate database guarantees</strong>: Why ACID databases can make certain guarantees that NoSQL can't</p>
<p><strong>Key Benefits of 2PL for Pessimistic Control:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>    HOW 2PL HELPS PESSIMISTIC CONCURRENCY CONTROL        
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>                                                         
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a> 1.  GUARANTEES SERIALIZABILITY                        
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>                
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>     Problem without 2PL:                             
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>     Pessimistic locking alone doesn&#39;t                
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>     guarantee serializability                        
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>                                                      
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>     Solution with 2PL:                               
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a>     Two-phase discipline ensures results             
<a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>     are equivalent to serial execution               
<a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a>                                                      
<a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a>     Example:                                         
<a id="__codelineno-94-16" name="__codelineno-94-16" href="#__codelineno-94-16"></a>     Without 2PL: T1 and T2 might produce             
<a id="__codelineno-94-17" name="__codelineno-94-17" href="#__codelineno-94-17"></a>                  non-serializable result             
<a id="__codelineno-94-18" name="__codelineno-94-18" href="#__codelineno-94-18"></a>     With 2PL:    Results always match                
<a id="__codelineno-94-19" name="__codelineno-94-19" href="#__codelineno-94-19"></a>                  some serial order                   
<a id="__codelineno-94-20" name="__codelineno-94-20" href="#__codelineno-94-20"></a>                
<a id="__codelineno-94-21" name="__codelineno-94-21" href="#__codelineno-94-21"></a>                                                         
<a id="__codelineno-94-22" name="__codelineno-94-22" href="#__codelineno-94-22"></a> 2.  PREVENTS LOST UPDATES                             
<a id="__codelineno-94-23" name="__codelineno-94-23" href="#__codelineno-94-23"></a>                
<a id="__codelineno-94-24" name="__codelineno-94-24" href="#__codelineno-94-24"></a>     Scenario: Two transactions updating              
<a id="__codelineno-94-25" name="__codelineno-94-25" href="#__codelineno-94-25"></a>               same account balance                   
<a id="__codelineno-94-26" name="__codelineno-94-26" href="#__codelineno-94-26"></a>                                                      
<a id="__codelineno-94-27" name="__codelineno-94-27" href="#__codelineno-94-27"></a>     T1: balance = 1000  1500 (+500)                 
<a id="__codelineno-94-28" name="__codelineno-94-28" href="#__codelineno-94-28"></a>     T2: balance = 1000  1200 (+200)                 
<a id="__codelineno-94-29" name="__codelineno-94-29" href="#__codelineno-94-29"></a>                                                      
<a id="__codelineno-94-30" name="__codelineno-94-30" href="#__codelineno-94-30"></a>     WITHOUT 2PL (wrong):                             
<a id="__codelineno-94-31" name="__codelineno-94-31" href="#__codelineno-94-31"></a>      Both read 1000                                 
<a id="__codelineno-94-32" name="__codelineno-94-32" href="#__codelineno-94-32"></a>      T1 writes 1500                                 
<a id="__codelineno-94-33" name="__codelineno-94-33" href="#__codelineno-94-33"></a>      T2 writes 1200 (overwrites T1!)                
<a id="__codelineno-94-34" name="__codelineno-94-34" href="#__codelineno-94-34"></a>      Result: 1200  (lost $500!)                   
<a id="__codelineno-94-35" name="__codelineno-94-35" href="#__codelineno-94-35"></a>                                                      
<a id="__codelineno-94-36" name="__codelineno-94-36" href="#__codelineno-94-36"></a>     WITH 2PL (correct):                              
<a id="__codelineno-94-37" name="__codelineno-94-37" href="#__codelineno-94-37"></a>      T1 locks, reads 1000, writes 1500              
<a id="__codelineno-94-38" name="__codelineno-94-38" href="#__codelineno-94-38"></a>      T2 waits for T1&#39;s lock                          
<a id="__codelineno-94-39" name="__codelineno-94-39" href="#__codelineno-94-39"></a>      T1 commits, releases lock                      
<a id="__codelineno-94-40" name="__codelineno-94-40" href="#__codelineno-94-40"></a>      T2 locks, reads 1500, writes 1700              
<a id="__codelineno-94-41" name="__codelineno-94-41" href="#__codelineno-94-41"></a>      Result: 1700  (both applied!)                 
<a id="__codelineno-94-42" name="__codelineno-94-42" href="#__codelineno-94-42"></a>                
<a id="__codelineno-94-43" name="__codelineno-94-43" href="#__codelineno-94-43"></a>                                                         
<a id="__codelineno-94-44" name="__codelineno-94-44" href="#__codelineno-94-44"></a> 3.  PREVENTS NON-REPEATABLE READS                     
<a id="__codelineno-94-45" name="__codelineno-94-45" href="#__codelineno-94-45"></a>                
<a id="__codelineno-94-46" name="__codelineno-94-46" href="#__codelineno-94-46"></a>     Problem: Reading same data twice                 
<a id="__codelineno-94-47" name="__codelineno-94-47" href="#__codelineno-94-47"></a>              within transaction gives                
<a id="__codelineno-94-48" name="__codelineno-94-48" href="#__codelineno-94-48"></a>              different results                       
<a id="__codelineno-94-49" name="__codelineno-94-49" href="#__codelineno-94-49"></a>                                                      
<a id="__codelineno-94-50" name="__codelineno-94-50" href="#__codelineno-94-50"></a>     WITHOUT 2PL:                                     
<a id="__codelineno-94-51" name="__codelineno-94-51" href="#__codelineno-94-51"></a>     T1: Read A (100)                                 
<a id="__codelineno-94-52" name="__codelineno-94-52" href="#__codelineno-94-52"></a>     T2: Update A to 200, commit                      
<a id="__codelineno-94-53" name="__codelineno-94-53" href="#__codelineno-94-53"></a>     T1: Read A (200)  Different!                  
<a id="__codelineno-94-54" name="__codelineno-94-54" href="#__codelineno-94-54"></a>                                                      
<a id="__codelineno-94-55" name="__codelineno-94-55" href="#__codelineno-94-55"></a>     WITH 2PL:                                        
<a id="__codelineno-94-56" name="__codelineno-94-56" href="#__codelineno-94-56"></a>     T1: Lock + Read A (100)                          
<a id="__codelineno-94-57" name="__codelineno-94-57" href="#__codelineno-94-57"></a>     T2: Tries to update  WAITS                      
<a id="__codelineno-94-58" name="__codelineno-94-58" href="#__codelineno-94-58"></a>     T1: Read A (100)  Same!                        
<a id="__codelineno-94-59" name="__codelineno-94-59" href="#__codelineno-94-59"></a>     T1: Commit, release lock                         
<a id="__codelineno-94-60" name="__codelineno-94-60" href="#__codelineno-94-60"></a>     T2: Now can update                               
<a id="__codelineno-94-61" name="__codelineno-94-61" href="#__codelineno-94-61"></a>                
<a id="__codelineno-94-62" name="__codelineno-94-62" href="#__codelineno-94-62"></a>                                                         
<a id="__codelineno-94-63" name="__codelineno-94-63" href="#__codelineno-94-63"></a> 4.  PROVIDES ISOLATION                                
<a id="__codelineno-94-64" name="__codelineno-94-64" href="#__codelineno-94-64"></a>                
<a id="__codelineno-94-65" name="__codelineno-94-65" href="#__codelineno-94-65"></a>     2PL enforces transaction isolation:              
<a id="__codelineno-94-66" name="__codelineno-94-66" href="#__codelineno-94-66"></a>                                                      
<a id="__codelineno-94-67" name="__codelineno-94-67" href="#__codelineno-94-67"></a>      Transactions don&#39;t interfere                   
<a id="__codelineno-94-68" name="__codelineno-94-68" href="#__codelineno-94-68"></a>      Intermediate states not visible                
<a id="__codelineno-94-69" name="__codelineno-94-69" href="#__codelineno-94-69"></a>      Clean separation of work                       
<a id="__codelineno-94-70" name="__codelineno-94-70" href="#__codelineno-94-70"></a>                                                      
<a id="__codelineno-94-71" name="__codelineno-94-71" href="#__codelineno-94-71"></a>     Isolation Level Mapping:                         
<a id="__codelineno-94-72" name="__codelineno-94-72" href="#__codelineno-94-72"></a>     Strict 2PL  SERIALIZABLE                        
<a id="__codelineno-94-73" name="__codelineno-94-73" href="#__codelineno-94-73"></a>     Standard 2PL  REPEATABLE READ                   
<a id="__codelineno-94-74" name="__codelineno-94-74" href="#__codelineno-94-74"></a>                
<a id="__codelineno-94-75" name="__codelineno-94-75" href="#__codelineno-94-75"></a>                                                         
<a id="__codelineno-94-76" name="__codelineno-94-76" href="#__codelineno-94-76"></a> 5.  STRUCTURED LOCK MANAGEMENT                        
<a id="__codelineno-94-77" name="__codelineno-94-77" href="#__codelineno-94-77"></a>                
<a id="__codelineno-94-78" name="__codelineno-94-78" href="#__codelineno-94-78"></a>     2PL provides clear rules:                        
<a id="__codelineno-94-79" name="__codelineno-94-79" href="#__codelineno-94-79"></a>                                                      
<a id="__codelineno-94-80" name="__codelineno-94-80" href="#__codelineno-94-80"></a>      When to acquire locks (growing)                
<a id="__codelineno-94-81" name="__codelineno-94-81" href="#__codelineno-94-81"></a>      When to release locks (shrinking)              
<a id="__codelineno-94-82" name="__codelineno-94-82" href="#__codelineno-94-82"></a>      No arbitrary lock/unlock                       
<a id="__codelineno-94-83" name="__codelineno-94-83" href="#__codelineno-94-83"></a>                                                      
<a id="__codelineno-94-84" name="__codelineno-94-84" href="#__codelineno-94-84"></a>     Benefits:                                        
<a id="__codelineno-94-85" name="__codelineno-94-85" href="#__codelineno-94-85"></a>      Easier to reason about                         
<a id="__codelineno-94-86" name="__codelineno-94-86" href="#__codelineno-94-86"></a>      Predictable behavior                           
<a id="__codelineno-94-87" name="__codelineno-94-87" href="#__codelineno-94-87"></a>      Simpler implementation                         
<a id="__codelineno-94-88" name="__codelineno-94-88" href="#__codelineno-94-88"></a>                
<a id="__codelineno-94-89" name="__codelineno-94-89" href="#__codelineno-94-89"></a>                                                         
<a id="__codelineno-94-90" name="__codelineno-94-90" href="#__codelineno-94-90"></a> 6.  COMPATIBILITY WITH EXISTING SYSTEMS               
<a id="__codelineno-94-91" name="__codelineno-94-91" href="#__codelineno-94-91"></a>                
<a id="__codelineno-94-92" name="__codelineno-94-92" href="#__codelineno-94-92"></a>      Standard in SQL databases                      
<a id="__codelineno-94-93" name="__codelineno-94-93" href="#__codelineno-94-93"></a>      Well-understood by developers                  
<a id="__codelineno-94-94" name="__codelineno-94-94" href="#__codelineno-94-94"></a>      Extensive tooling support                      
<a id="__codelineno-94-95" name="__codelineno-94-95" href="#__codelineno-94-95"></a>      Battle-tested over decades                     
<a id="__codelineno-94-96" name="__codelineno-94-96" href="#__codelineno-94-96"></a>                
<a id="__codelineno-94-97" name="__codelineno-94-97" href="#__codelineno-94-97"></a>                                                         
<a id="__codelineno-94-98" name="__codelineno-94-98" href="#__codelineno-94-98"></a>
</code></pre></div>
<p><strong>Comparison: Pessimistic WITHOUT 2PL vs WITH 2PL:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a>    PESSIMISTIC LOCKING: WITHOUT vs WITH 2PL             
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>                                                         
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a> Scenario: Two transactions transferring money          
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>                                                         
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>     
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>  WITHOUT 2PL DISCIPLINE (ad-hoc locking)             
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>     
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>  T1:                      T2:                        
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>  Lock(A)                  Lock(B)                    
<a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a>  Read A                   Read B                     
<a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a>  Unlock(A)              Unlock(B)                
<a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a>  Lock(B)                  Lock(A)                    
<a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a>  Update B                 Update A                   
<a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a>  Unlock(B)                Unlock(A)                  
<a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a>  Commit                   Commit                     
<a id="__codelineno-95-18" name="__codelineno-95-18" href="#__codelineno-95-18"></a>                                                      
<a id="__codelineno-95-19" name="__codelineno-95-19" href="#__codelineno-95-19"></a>  Problem: NOT SERIALIZABLE!                          
<a id="__codelineno-95-20" name="__codelineno-95-20" href="#__codelineno-95-20"></a>   A unlocked before B locked                        
<a id="__codelineno-95-21" name="__codelineno-95-21" href="#__codelineno-95-21"></a>   Other transactions can interfere                  
<a id="__codelineno-95-22" name="__codelineno-95-22" href="#__codelineno-95-22"></a>   Intermediate inconsistent state visible           
<a id="__codelineno-95-23" name="__codelineno-95-23" href="#__codelineno-95-23"></a>     
<a id="__codelineno-95-24" name="__codelineno-95-24" href="#__codelineno-95-24"></a>                                                         
<a id="__codelineno-95-25" name="__codelineno-95-25" href="#__codelineno-95-25"></a>     
<a id="__codelineno-95-26" name="__codelineno-95-26" href="#__codelineno-95-26"></a>  WITH 2PL DISCIPLINE (strict protocol)               
<a id="__codelineno-95-27" name="__codelineno-95-27" href="#__codelineno-95-27"></a>     
<a id="__codelineno-95-28" name="__codelineno-95-28" href="#__codelineno-95-28"></a>  T1:                      T2:                        
<a id="__codelineno-95-29" name="__codelineno-95-29" href="#__codelineno-95-29"></a>   GROWING PHASE                              
<a id="__codelineno-95-30" name="__codelineno-95-30" href="#__codelineno-95-30"></a>  Lock(A)                  Lock(B)                    
<a id="__codelineno-95-31" name="__codelineno-95-31" href="#__codelineno-95-31"></a>  Read A                   Read B                     
<a id="__codelineno-95-32" name="__codelineno-95-32" href="#__codelineno-95-32"></a>  Lock(B)                  Lock(A) [waits for T1]     
<a id="__codelineno-95-33" name="__codelineno-95-33" href="#__codelineno-95-33"></a>  Update B                                            
<a id="__codelineno-95-34" name="__codelineno-95-34" href="#__codelineno-95-34"></a>   SHRINKING PHASE                              
<a id="__codelineno-95-35" name="__codelineno-95-35" href="#__codelineno-95-35"></a>  Commit                   [still waiting]            
<a id="__codelineno-95-36" name="__codelineno-95-36" href="#__codelineno-95-36"></a>  Unlock(A)                                           
<a id="__codelineno-95-37" name="__codelineno-95-37" href="#__codelineno-95-37"></a>  Unlock(B)                                           
<a id="__codelineno-95-38" name="__codelineno-95-38" href="#__codelineno-95-38"></a>                           GROWING PHASE      
<a id="__codelineno-95-39" name="__codelineno-95-39" href="#__codelineno-95-39"></a>                          [T1 released, T2 gets A]    
<a id="__codelineno-95-40" name="__codelineno-95-40" href="#__codelineno-95-40"></a>                          Read A                      
<a id="__codelineno-95-41" name="__codelineno-95-41" href="#__codelineno-95-41"></a>                          Update A                    
<a id="__codelineno-95-42" name="__codelineno-95-42" href="#__codelineno-95-42"></a>                           SHRINKING PHASE      
<a id="__codelineno-95-43" name="__codelineno-95-43" href="#__codelineno-95-43"></a>                          Commit                      
<a id="__codelineno-95-44" name="__codelineno-95-44" href="#__codelineno-95-44"></a>                          Unlock(A), Unlock(B)        
<a id="__codelineno-95-45" name="__codelineno-95-45" href="#__codelineno-95-45"></a>                                                      
<a id="__codelineno-95-46" name="__codelineno-95-46" href="#__codelineno-95-46"></a>   SERIALIZABLE! Equivalent to T1 then T2            
<a id="__codelineno-95-47" name="__codelineno-95-47" href="#__codelineno-95-47"></a>     
<a id="__codelineno-95-48" name="__codelineno-95-48" href="#__codelineno-95-48"></a>                                                         
<a id="__codelineno-95-49" name="__codelineno-95-49" href="#__codelineno-95-49"></a>
</code></pre></div>
<p><strong>Code Example - 2PL in Action:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="c1"># Pessimistic Concurrency Control WITH Two-Phase Locking</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">TwoPhaseLockingTransaction</span><span class="p">:</span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a><span class="sd">    Implements 2PL protocol for pessimistic concurrency control</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">):</span>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_connection</span>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;NOT_STARTED&quot;</span>  <span class="c1"># NOT_STARTED, GROWING, SHRINKING</span>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>
<a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-96-14" name="__codelineno-96-14" href="#__codelineno-96-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start transaction - enter growing phase&quot;&quot;&quot;</span>
<a id="__codelineno-96-15" name="__codelineno-96-15" href="#__codelineno-96-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">)</span>
<a id="__codelineno-96-16" name="__codelineno-96-16" href="#__codelineno-96-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;GROWING&quot;</span>
<a id="__codelineno-96-17" name="__codelineno-96-17" href="#__codelineno-96-17"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transaction started - GROWING PHASE&quot;</span><span class="p">)</span>
<a id="__codelineno-96-18" name="__codelineno-96-18" href="#__codelineno-96-18"></a>
<a id="__codelineno-96-19" name="__codelineno-96-19" href="#__codelineno-96-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">acquire_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">lock_type</span><span class="o">=</span><span class="s2">&quot;EXCLUSIVE&quot;</span><span class="p">):</span>
<a id="__codelineno-96-20" name="__codelineno-96-20" href="#__codelineno-96-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-96-21" name="__codelineno-96-21" href="#__codelineno-96-21"></a><span class="sd">        Acquire lock (only allowed in GROWING phase)</span>
<a id="__codelineno-96-22" name="__codelineno-96-22" href="#__codelineno-96-22"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-96-23" name="__codelineno-96-23" href="#__codelineno-96-23"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;SHRINKING&quot;</span><span class="p">:</span>
<a id="__codelineno-96-24" name="__codelineno-96-24" href="#__codelineno-96-24"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-96-25" name="__codelineno-96-25" href="#__codelineno-96-25"></a>                <span class="s2">&quot;2PL VIOLATION! Cannot acquire lock in SHRINKING phase&quot;</span>
<a id="__codelineno-96-26" name="__codelineno-96-26" href="#__codelineno-96-26"></a>            <span class="p">)</span>
<a id="__codelineno-96-27" name="__codelineno-96-27" href="#__codelineno-96-27"></a>
<a id="__codelineno-96-28" name="__codelineno-96-28" href="#__codelineno-96-28"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="s2">&quot;GROWING&quot;</span><span class="p">:</span>
<a id="__codelineno-96-29" name="__codelineno-96-29" href="#__codelineno-96-29"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Transaction not started&quot;</span><span class="p">)</span>
<a id="__codelineno-96-30" name="__codelineno-96-30" href="#__codelineno-96-30"></a>
<a id="__codelineno-96-31" name="__codelineno-96-31" href="#__codelineno-96-31"></a>        <span class="c1"># Acquire lock</span>
<a id="__codelineno-96-32" name="__codelineno-96-32" href="#__codelineno-96-32"></a>        <span class="k">if</span> <span class="n">lock_type</span> <span class="o">==</span> <span class="s2">&quot;SHARED&quot;</span><span class="p">:</span>
<a id="__codelineno-96-33" name="__codelineno-96-33" href="#__codelineno-96-33"></a>            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="s2"> FOR SHARE&quot;</span>
<a id="__codelineno-96-34" name="__codelineno-96-34" href="#__codelineno-96-34"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># EXCLUSIVE</span>
<a id="__codelineno-96-35" name="__codelineno-96-35" href="#__codelineno-96-35"></a>            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="s2"> FOR UPDATE&quot;</span>
<a id="__codelineno-96-36" name="__codelineno-96-36" href="#__codelineno-96-36"></a>
<a id="__codelineno-96-37" name="__codelineno-96-37" href="#__codelineno-96-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-96-38" name="__codelineno-96-38" href="#__codelineno-96-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
<a id="__codelineno-96-39" name="__codelineno-96-39" href="#__codelineno-96-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Acquired </span><span class="si">{</span><span class="n">lock_type</span><span class="si">}</span><span class="s2"> lock on </span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-40" name="__codelineno-96-40" href="#__codelineno-96-40"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Locks held: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-41" name="__codelineno-96-41" href="#__codelineno-96-41"></a>
<a id="__codelineno-96-42" name="__codelineno-96-42" href="#__codelineno-96-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">release_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">):</span>
<a id="__codelineno-96-43" name="__codelineno-96-43" href="#__codelineno-96-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-96-44" name="__codelineno-96-44" href="#__codelineno-96-44"></a><span class="sd">        Release lock - transitions to SHRINKING phase</span>
<a id="__codelineno-96-45" name="__codelineno-96-45" href="#__codelineno-96-45"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-96-46" name="__codelineno-96-46" href="#__codelineno-96-46"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;GROWING&quot;</span><span class="p">:</span>
<a id="__codelineno-96-47" name="__codelineno-96-47" href="#__codelineno-96-47"></a>            <span class="c1"># First lock release  transition to SHRINKING</span>
<a id="__codelineno-96-48" name="__codelineno-96-48" href="#__codelineno-96-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;SHRINKING&quot;</span>
<a id="__codelineno-96-49" name="__codelineno-96-49" href="#__codelineno-96-49"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Entered SHRINKING PHASE &quot;</span><span class="p">)</span>
<a id="__codelineno-96-50" name="__codelineno-96-50" href="#__codelineno-96-50"></a>
<a id="__codelineno-96-51" name="__codelineno-96-51" href="#__codelineno-96-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
<a id="__codelineno-96-52" name="__codelineno-96-52" href="#__codelineno-96-52"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Released lock on </span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-53" name="__codelineno-96-53" href="#__codelineno-96-53"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Locks held: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-54" name="__codelineno-96-54" href="#__codelineno-96-54"></a>
<a id="__codelineno-96-55" name="__codelineno-96-55" href="#__codelineno-96-55"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-96-56" name="__codelineno-96-56" href="#__codelineno-96-56"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-96-57" name="__codelineno-96-57" href="#__codelineno-96-57"></a><span class="sd">        Commit transaction - releases ALL locks</span>
<a id="__codelineno-96-58" name="__codelineno-96-58" href="#__codelineno-96-58"></a><span class="sd">        Automatically enters SHRINKING phase</span>
<a id="__codelineno-96-59" name="__codelineno-96-59" href="#__codelineno-96-59"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-96-60" name="__codelineno-96-60" href="#__codelineno-96-60"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;GROWING&quot;</span><span class="p">:</span>
<a id="__codelineno-96-61" name="__codelineno-96-61" href="#__codelineno-96-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;SHRINKING&quot;</span>
<a id="__codelineno-96-62" name="__codelineno-96-62" href="#__codelineno-96-62"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Entered SHRINKING PHASE (via commit) &quot;</span><span class="p">)</span>
<a id="__codelineno-96-63" name="__codelineno-96-63" href="#__codelineno-96-63"></a>
<a id="__codelineno-96-64" name="__codelineno-96-64" href="#__codelineno-96-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
<a id="__codelineno-96-65" name="__codelineno-96-65" href="#__codelineno-96-65"></a>
<a id="__codelineno-96-66" name="__codelineno-96-66" href="#__codelineno-96-66"></a>        <span class="c1"># Release all locks</span>
<a id="__codelineno-96-67" name="__codelineno-96-67" href="#__codelineno-96-67"></a>        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span><span class="p">):</span>
<a id="__codelineno-96-68" name="__codelineno-96-68" href="#__codelineno-96-68"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Released lock on </span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-69" name="__codelineno-96-69" href="#__codelineno-96-69"></a>
<a id="__codelineno-96-70" name="__codelineno-96-70" href="#__codelineno-96-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locks_held</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-96-71" name="__codelineno-96-71" href="#__codelineno-96-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;NOT_STARTED&quot;</span>
<a id="__codelineno-96-72" name="__codelineno-96-72" href="#__codelineno-96-72"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transaction committed - all locks released&quot;</span><span class="p">)</span>
<a id="__codelineno-96-73" name="__codelineno-96-73" href="#__codelineno-96-73"></a>
<a id="__codelineno-96-74" name="__codelineno-96-74" href="#__codelineno-96-74"></a>
<a id="__codelineno-96-75" name="__codelineno-96-75" href="#__codelineno-96-75"></a><span class="c1"># Example usage: Bank transfer with 2PL</span>
<a id="__codelineno-96-76" name="__codelineno-96-76" href="#__codelineno-96-76"></a>
<a id="__codelineno-96-77" name="__codelineno-96-77" href="#__codelineno-96-77"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_with_2pl</span><span class="p">(</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-96-78" name="__codelineno-96-78" href="#__codelineno-96-78"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-96-79" name="__codelineno-96-79" href="#__codelineno-96-79"></a><span class="sd">    Transfer money using Two-Phase Locking protocol</span>
<a id="__codelineno-96-80" name="__codelineno-96-80" href="#__codelineno-96-80"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-96-81" name="__codelineno-96-81" href="#__codelineno-96-81"></a>    <span class="n">txn</span> <span class="o">=</span> <span class="n">TwoPhaseLockingTransaction</span><span class="p">(</span><span class="n">get_db_connection</span><span class="p">())</span>
<a id="__codelineno-96-82" name="__codelineno-96-82" href="#__codelineno-96-82"></a>
<a id="__codelineno-96-83" name="__codelineno-96-83" href="#__codelineno-96-83"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-96-84" name="__codelineno-96-84" href="#__codelineno-96-84"></a>        <span class="c1"># BEGIN TRANSACTION</span>
<a id="__codelineno-96-85" name="__codelineno-96-85" href="#__codelineno-96-85"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-96-86" name="__codelineno-96-86" href="#__codelineno-96-86"></a>
<a id="__codelineno-96-87" name="__codelineno-96-87" href="#__codelineno-96-87"></a>        <span class="c1"># </span>
<a id="__codelineno-96-88" name="__codelineno-96-88" href="#__codelineno-96-88"></a>        <span class="c1">#         GROWING PHASE STARTS</span>
<a id="__codelineno-96-89" name="__codelineno-96-89" href="#__codelineno-96-89"></a>        <span class="c1"># </span>
<a id="__codelineno-96-90" name="__codelineno-96-90" href="#__codelineno-96-90"></a>
<a id="__codelineno-96-91" name="__codelineno-96-91" href="#__codelineno-96-91"></a>        <span class="c1"># Acquire locks in order (prevent deadlock)</span>
<a id="__codelineno-96-92" name="__codelineno-96-92" href="#__codelineno-96-92"></a>        <span class="n">accounts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-96-93" name="__codelineno-96-93" href="#__codelineno-96-93"></a>
<a id="__codelineno-96-94" name="__codelineno-96-94" href="#__codelineno-96-94"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Acquiring lock on </span><span class="si">{</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-95" name="__codelineno-96-95" href="#__codelineno-96-95"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;accounts WHERE id=&#39;</span><span class="si">{</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;EXCLUSIVE&quot;</span><span class="p">)</span>
<a id="__codelineno-96-96" name="__codelineno-96-96" href="#__codelineno-96-96"></a>
<a id="__codelineno-96-97" name="__codelineno-96-97" href="#__codelineno-96-97"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Acquiring lock on </span><span class="si">{</span><span class="n">accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-98" name="__codelineno-96-98" href="#__codelineno-96-98"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;accounts WHERE id=&#39;</span><span class="si">{</span><span class="n">accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;EXCLUSIVE&quot;</span><span class="p">)</span>
<a id="__codelineno-96-99" name="__codelineno-96-99" href="#__codelineno-96-99"></a>
<a id="__codelineno-96-100" name="__codelineno-96-100" href="#__codelineno-96-100"></a>        <span class="c1"># All locks acquired - at LOCK POINT</span>
<a id="__codelineno-96-101" name="__codelineno-96-101" href="#__codelineno-96-101"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> LOCK POINT &quot;</span><span class="p">)</span>
<a id="__codelineno-96-102" name="__codelineno-96-102" href="#__codelineno-96-102"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All needed locks acquired!&quot;</span><span class="p">)</span>
<a id="__codelineno-96-103" name="__codelineno-96-103" href="#__codelineno-96-103"></a>
<a id="__codelineno-96-104" name="__codelineno-96-104" href="#__codelineno-96-104"></a>        <span class="c1"># Read balances</span>
<a id="__codelineno-96-105" name="__codelineno-96-105" href="#__codelineno-96-105"></a>        <span class="n">balance_from</span> <span class="o">=</span> <span class="n">txn</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-96-106" name="__codelineno-96-106" href="#__codelineno-96-106"></a>            <span class="sa">f</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id=&#39;</span><span class="si">{</span><span class="n">from_account</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-96-107" name="__codelineno-96-107" href="#__codelineno-96-107"></a>        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-96-108" name="__codelineno-96-108" href="#__codelineno-96-108"></a>
<a id="__codelineno-96-109" name="__codelineno-96-109" href="#__codelineno-96-109"></a>        <span class="n">balance_to</span> <span class="o">=</span> <span class="n">txn</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-96-110" name="__codelineno-96-110" href="#__codelineno-96-110"></a>            <span class="sa">f</span><span class="s2">&quot;SELECT balance FROM accounts WHERE id=&#39;</span><span class="si">{</span><span class="n">to_account</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-96-111" name="__codelineno-96-111" href="#__codelineno-96-111"></a>        <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-96-112" name="__codelineno-96-112" href="#__codelineno-96-112"></a>
<a id="__codelineno-96-113" name="__codelineno-96-113" href="#__codelineno-96-113"></a>        <span class="c1"># Validate</span>
<a id="__codelineno-96-114" name="__codelineno-96-114" href="#__codelineno-96-114"></a>        <span class="k">if</span> <span class="n">balance_from</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-96-115" name="__codelineno-96-115" href="#__codelineno-96-115"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Insufficient funds&quot;</span><span class="p">)</span>
<a id="__codelineno-96-116" name="__codelineno-96-116" href="#__codelineno-96-116"></a>
<a id="__codelineno-96-117" name="__codelineno-96-117" href="#__codelineno-96-117"></a>        <span class="c1"># Perform transfer</span>
<a id="__codelineno-96-118" name="__codelineno-96-118" href="#__codelineno-96-118"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-96-119" name="__codelineno-96-119" href="#__codelineno-96-119"></a><span class="s2">            UPDATE accounts SET balance = balance - </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span>
<a id="__codelineno-96-120" name="__codelineno-96-120" href="#__codelineno-96-120"></a><span class="s2">            WHERE id = &#39;</span><span class="si">{</span><span class="n">from_account</span><span class="si">}</span><span class="s2">&#39;</span>
<a id="__codelineno-96-121" name="__codelineno-96-121" href="#__codelineno-96-121"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-96-122" name="__codelineno-96-122" href="#__codelineno-96-122"></a>
<a id="__codelineno-96-123" name="__codelineno-96-123" href="#__codelineno-96-123"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-96-124" name="__codelineno-96-124" href="#__codelineno-96-124"></a><span class="s2">            UPDATE accounts SET balance = balance + </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span>
<a id="__codelineno-96-125" name="__codelineno-96-125" href="#__codelineno-96-125"></a><span class="s2">            WHERE id = &#39;</span><span class="si">{</span><span class="n">to_account</span><span class="si">}</span><span class="s2">&#39;</span>
<a id="__codelineno-96-126" name="__codelineno-96-126" href="#__codelineno-96-126"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-96-127" name="__codelineno-96-127" href="#__codelineno-96-127"></a>
<a id="__codelineno-96-128" name="__codelineno-96-128" href="#__codelineno-96-128"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Transfer complete: </span><span class="si">{</span><span class="n">from_account</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">to_account</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-129" name="__codelineno-96-129" href="#__codelineno-96-129"></a>
<a id="__codelineno-96-130" name="__codelineno-96-130" href="#__codelineno-96-130"></a>        <span class="c1"># </span>
<a id="__codelineno-96-131" name="__codelineno-96-131" href="#__codelineno-96-131"></a>        <span class="c1">#        SHRINKING PHASE STARTS</span>
<a id="__codelineno-96-132" name="__codelineno-96-132" href="#__codelineno-96-132"></a>        <span class="c1"># </span>
<a id="__codelineno-96-133" name="__codelineno-96-133" href="#__codelineno-96-133"></a>
<a id="__codelineno-96-134" name="__codelineno-96-134" href="#__codelineno-96-134"></a>        <span class="c1"># Commit (releases all locks at once)</span>
<a id="__codelineno-96-135" name="__codelineno-96-135" href="#__codelineno-96-135"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Committing transaction...&quot;</span><span class="p">)</span>
<a id="__codelineno-96-136" name="__codelineno-96-136" href="#__codelineno-96-136"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-96-137" name="__codelineno-96-137" href="#__codelineno-96-137"></a>
<a id="__codelineno-96-138" name="__codelineno-96-138" href="#__codelineno-96-138"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Transfer successful!&quot;</span><span class="p">)</span>
<a id="__codelineno-96-139" name="__codelineno-96-139" href="#__codelineno-96-139"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-96-140" name="__codelineno-96-140" href="#__codelineno-96-140"></a>
<a id="__codelineno-96-141" name="__codelineno-96-141" href="#__codelineno-96-141"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-96-142" name="__codelineno-96-142" href="#__codelineno-96-142"></a>        <span class="c1"># Rollback releases all locks</span>
<a id="__codelineno-96-143" name="__codelineno-96-143" href="#__codelineno-96-143"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-96-144" name="__codelineno-96-144" href="#__codelineno-96-144"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">)</span>
<a id="__codelineno-96-145" name="__codelineno-96-145" href="#__codelineno-96-145"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">locks_held</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-96-146" name="__codelineno-96-146" href="#__codelineno-96-146"></a>        <span class="n">txn</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="s2">&quot;NOT_STARTED&quot;</span>
<a id="__codelineno-96-147" name="__codelineno-96-147" href="#__codelineno-96-147"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transaction rolled back - all locks released&quot;</span><span class="p">)</span>
<a id="__codelineno-96-148" name="__codelineno-96-148" href="#__codelineno-96-148"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-96-149" name="__codelineno-96-149" href="#__codelineno-96-149"></a>
<a id="__codelineno-96-150" name="__codelineno-96-150" href="#__codelineno-96-150"></a>
<a id="__codelineno-96-151" name="__codelineno-96-151" href="#__codelineno-96-151"></a><span class="c1"># Usage</span>
<a id="__codelineno-96-152" name="__codelineno-96-152" href="#__codelineno-96-152"></a><span class="n">transfer_with_2pl</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>Transaction started - GROWING PHASE
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a>1. Acquiring lock on A
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a> Acquired EXCLUSIVE lock on accounts WHERE id=&#39;A&#39;
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>  Locks held: {&#39;accounts WHERE id=&#39;A&#39;&#39;}
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a>
<a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a>2. Acquiring lock on B
<a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a> Acquired EXCLUSIVE lock on accounts WHERE id=&#39;B&#39;
<a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a>  Locks held: {&#39;accounts WHERE id=&#39;A&#39;&#39;, &#39;accounts WHERE id=&#39;B&#39;&#39;}
<a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a>
<a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a> LOCK POINT 
<a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a>All needed locks acquired!
<a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a>
<a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a>3. Transfer complete: A  B: $100
<a id="__codelineno-97-15" name="__codelineno-97-15" href="#__codelineno-97-15"></a>
<a id="__codelineno-97-16" name="__codelineno-97-16" href="#__codelineno-97-16"></a>4. Committing transaction...
<a id="__codelineno-97-17" name="__codelineno-97-17" href="#__codelineno-97-17"></a> Entered SHRINKING PHASE (via commit) 
<a id="__codelineno-97-18" name="__codelineno-97-18" href="#__codelineno-97-18"></a> Released lock on accounts WHERE id=&#39;A&#39;
<a id="__codelineno-97-19" name="__codelineno-97-19" href="#__codelineno-97-19"></a> Released lock on accounts WHERE id=&#39;B&#39;
<a id="__codelineno-97-20" name="__codelineno-97-20" href="#__codelineno-97-20"></a>Transaction committed - all locks released
<a id="__codelineno-97-21" name="__codelineno-97-21" href="#__codelineno-97-21"></a>
<a id="__codelineno-97-22" name="__codelineno-97-22" href="#__codelineno-97-22"></a> Transfer successful!
</code></pre></div></p>
<p><strong>Why 2PL Makes Pessimistic Control Effective:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a>    2PL: THE FOUNDATION OF PESSIMISTIC CONTROL           
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>                                                         
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a> Without 2PL:                                            
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a>            
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a>   Locks can be acquired/released anytime            
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a>   No guarantee of serializability                    
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>   Race conditions possible                           
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a>   Inconsistent intermediate states                   
<a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a>   Hard to reason about correctness                   
<a id="__codelineno-98-12" name="__codelineno-98-12" href="#__codelineno-98-12"></a>            
<a id="__codelineno-98-13" name="__codelineno-98-13" href="#__codelineno-98-13"></a>                                                         
<a id="__codelineno-98-14" name="__codelineno-98-14" href="#__codelineno-98-14"></a> With 2PL:                                               
<a id="__codelineno-98-15" name="__codelineno-98-15" href="#__codelineno-98-15"></a>            
<a id="__codelineno-98-16" name="__codelineno-98-16" href="#__codelineno-98-16"></a>   Structured lock acquisition/release               
<a id="__codelineno-98-17" name="__codelineno-98-17" href="#__codelineno-98-17"></a>   Guaranteed serializability                         
<a id="__codelineno-98-18" name="__codelineno-98-18" href="#__codelineno-98-18"></a>   No race conditions                                 
<a id="__codelineno-98-19" name="__codelineno-98-19" href="#__codelineno-98-19"></a>   Isolated transaction execution                     
<a id="__codelineno-98-20" name="__codelineno-98-20" href="#__codelineno-98-20"></a>   Clear correctness guarantee                        
<a id="__codelineno-98-21" name="__codelineno-98-21" href="#__codelineno-98-21"></a>            
<a id="__codelineno-98-22" name="__codelineno-98-22" href="#__codelineno-98-22"></a>                                                         
<a id="__codelineno-98-23" name="__codelineno-98-23" href="#__codelineno-98-23"></a> Conclusion:                                             
<a id="__codelineno-98-24" name="__codelineno-98-24" href="#__codelineno-98-24"></a> 2PL is the PROTOCOL that makes pessimistic              
<a id="__codelineno-98-25" name="__codelineno-98-25" href="#__codelineno-98-25"></a> concurrency control CORRECT and RELIABLE!               
<a id="__codelineno-98-26" name="__codelineno-98-26" href="#__codelineno-98-26"></a>                                                         
<a id="__codelineno-98-27" name="__codelineno-98-27" href="#__codelineno-98-27"></a>
</code></pre></div>
<hr />
<h4 id="454-different-phases-of-two-phase-locking-detailed">4.5.4 Different Phases of Two-Phase Locking (Detailed)</h4>
<p><strong>Description:</strong></p>
<p>While we've introduced the two phases earlier, let's dive deeper into the characteristics, rules, and behavior of each phase to fully understand how 2PL guarantees serializability.</p>
<p>The <strong>two phases</strong> are not arbitrary divisions - they represent a <strong>fundamental property</strong> of conflict-serializable schedules. The mathematical proof (by Eswaran et al., 1976) shows that if all transactions follow this two-phase discipline, the resulting schedule is guaranteed to be <strong>conflict-serializable</strong>, meaning it's equivalent to some serial execution order.</p>
<p><strong>The Lock Point Concept:</strong></p>
<p>The transition between growing and shrinking phases occurs at a critical moment called the <strong>lock point</strong> - the instant when a transaction holds the maximum number of locks it will ever hold. This lock point is crucial because:</p>
<ol>
<li>
<p><strong>Serialization Order</strong>: The relative order of transactions' lock points determines the equivalent serial schedule. If T1's lock point occurs before T2's lock point, then in the equivalent serial schedule, T1 executes completely before T2.</p>
</li>
<li>
<p><strong>Conflict Resolution</strong>: All conflicts between transactions are resolved by the time both reach their lock points. After that, they can safely release resources without interfering.</p>
</li>
<li>
<p><strong>Isolation Guarantee</strong>: At the lock point, the transaction has "captured" a consistent snapshot of all resources it needs, ensuring isolation from other transactions.</p>
</li>
</ol>
<p><strong>Why the Phase Separation is Mathematically Necessary:</strong></p>
<p>The two-phase constraint might seem arbitrary, but it's actually the <strong>minimal restriction</strong> needed to guarantee serializability:</p>
<ul>
<li><strong>Too lenient</strong> (allow lock acquisition after any release): Non-serializable schedules possible (inconsistent analysis)</li>
<li><strong>Too strict</strong> (hold all locks until commit): Correct but reduces concurrency unnecessarily (rigorous 2PL)</li>
<li><strong>Just right</strong> (two phases): Guaranteed serializability with maximum possible concurrency</li>
</ul>
<p>This is an example of what computer scientists call an <strong>elegant solution</strong> - the simplest possible rule that solves the problem completely.</p>
<p><strong>Phase Transition as a One-Way Door:</strong></p>
<p>The irreversibility of the phase transition (growing  shrinking, never reverse) is critical. Think of it like a ratchet mechanism:
- <strong>Growing Phase</strong>: Ratchet moves forward (accumulating locks)
- <strong>Lock Point</strong>: Ratchet reaches maximum position
- <strong>Shrinking Phase</strong>: Ratchet can only move backward (releasing locks)
- <strong>No return</strong>: Once you release one lock, the ratchet mechanism prevents acquiring new locks</p>
<p>This one-way property ensures that once a transaction "commits" to a particular view of the database (at lock point), it cannot change its mind and grab additional resources, which would break serializability.</p>
<p><strong>Real-World Analogy:</strong></p>
<p>Think of the two phases like preparing for a presentation:</p>
<p><strong>Growing Phase</strong> = Gathering materials:
- Collect all slides, data, charts
- Cannot present yet (not all resources ready)
- Keep accumulating until you have everything</p>
<p><strong>Lock Point</strong> = Materials complete:
- All resources gathered
- Ready to present
- Committed to this version</p>
<p><strong>Shrinking Phase</strong> = Giving presentation:
- Use the materials you gathered
- Return materials as you finish with them
- Cannot go back and grab new materials (presentation already started)
- Must work with what you collected in growing phase</p>
<p><strong>Phase 1: Growing Phase (Lock Acquisition Phase)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a>         PHASE 1: GROWING PHASE (EXPANSION)              
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>                                                         
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a> Duration: From BEGIN to LOCK POINT                      
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>                                                         
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a> RULES:                                                  
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>            
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a>   CAN acquire new locks                            
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>   CAN upgrade locks (shared  exclusive)           
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>   CANNOT release any lock                          
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>   CANNOT downgrade locks                           
<a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a>            
<a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a>                                                         
<a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a> CHARACTERISTICS:                                        
<a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a>  Transaction accumulates resources                     
<a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a>  Lock count increases monotonically                    
<a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a>  No lock is ever released                              
<a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>  Phase ends at &quot;lock point&quot;                            
<a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a>                                                         
<a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a> LOCK POINT:                                             
<a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a>  The moment when transaction holds                     
<a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a>   maximum number of locks                               
<a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a>  All required locks have been acquired                 
<a id="__codelineno-99-25" name="__codelineno-99-25" href="#__codelineno-99-25"></a>  Transaction ready to release locks                    
<a id="__codelineno-99-26" name="__codelineno-99-26" href="#__codelineno-99-26"></a>                                                         
<a id="__codelineno-99-27" name="__codelineno-99-27" href="#__codelineno-99-27"></a> ALLOWED OPERATIONS:                                     
<a id="__codelineno-99-28" name="__codelineno-99-28" href="#__codelineno-99-28"></a>            
<a id="__codelineno-99-29" name="__codelineno-99-29" href="#__codelineno-99-29"></a>  1. LOCK(X) - Acquire new lock on X                  
<a id="__codelineno-99-30" name="__codelineno-99-30" href="#__codelineno-99-30"></a>  2. UPGRADE(X) - Shared  Exclusive lock             
<a id="__codelineno-99-31" name="__codelineno-99-31" href="#__codelineno-99-31"></a>  3. READ(X) - Read locked resource                   
<a id="__codelineno-99-32" name="__codelineno-99-32" href="#__codelineno-99-32"></a>  4. WRITE(X) - Write locked resource                 
<a id="__codelineno-99-33" name="__codelineno-99-33" href="#__codelineno-99-33"></a>            
<a id="__codelineno-99-34" name="__codelineno-99-34" href="#__codelineno-99-34"></a>                                                         
<a id="__codelineno-99-35" name="__codelineno-99-35" href="#__codelineno-99-35"></a> Timeline Example:                                       
<a id="__codelineno-99-36" name="__codelineno-99-36" href="#__codelineno-99-36"></a>            
<a id="__codelineno-99-37" name="__codelineno-99-37" href="#__codelineno-99-37"></a>  t1: BEGIN                                           
<a id="__codelineno-99-38" name="__codelineno-99-38" href="#__codelineno-99-38"></a>  t2: LOCK(A)           [1 lock]                     
<a id="__codelineno-99-39" name="__codelineno-99-39" href="#__codelineno-99-39"></a>  t3: READ(A)            [1 lock]                     
<a id="__codelineno-99-40" name="__codelineno-99-40" href="#__codelineno-99-40"></a>  t4: LOCK(B)           [2 locks]                    
<a id="__codelineno-99-41" name="__codelineno-99-41" href="#__codelineno-99-41"></a>  t5: READ(B)            [2 locks]                    
<a id="__codelineno-99-42" name="__codelineno-99-42" href="#__codelineno-99-42"></a>  t6: LOCK(C)           [3 locks]                    
<a id="__codelineno-99-43" name="__codelineno-99-43" href="#__codelineno-99-43"></a>  t7: WRITE(C)           [3 locks]                    
<a id="__codelineno-99-44" name="__codelineno-99-44" href="#__codelineno-99-44"></a>   LOCK POINT                                   
<a id="__codelineno-99-45" name="__codelineno-99-45" href="#__codelineno-99-45"></a>  (All needed locks acquired)                         
<a id="__codelineno-99-46" name="__codelineno-99-46" href="#__codelineno-99-46"></a>            
<a id="__codelineno-99-47" name="__codelineno-99-47" href="#__codelineno-99-47"></a>                                                         
<a id="__codelineno-99-48" name="__codelineno-99-48" href="#__codelineno-99-48"></a>
</code></pre></div>
<p><strong>Phase 2: Shrinking Phase (Lock Release Phase)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>        PHASE 2: SHRINKING PHASE (CONTRACTION)           
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>                                                         
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a> Duration: From LOCK POINT to COMMIT/ABORT               
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>                                                         
<a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a> RULES:                                                  
<a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a>            
<a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a>   CAN release locks                                
<a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a>   CAN downgrade locks (exclusiveshared)           
<a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a>   CANNOT acquire new locks                         
<a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a>   CANNOT upgrade locks                             
<a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a>            
<a id="__codelineno-100-14" name="__codelineno-100-14" href="#__codelineno-100-14"></a>                                                         
<a id="__codelineno-100-15" name="__codelineno-100-15" href="#__codelineno-100-15"></a> CHARACTERISTICS:                                        
<a id="__codelineno-100-16" name="__codelineno-100-16" href="#__codelineno-100-16"></a>  Transaction releases resources                        
<a id="__codelineno-100-17" name="__codelineno-100-17" href="#__codelineno-100-17"></a>  Lock count decreases monotonically                    
<a id="__codelineno-100-18" name="__codelineno-100-18" href="#__codelineno-100-18"></a>  No new lock can be acquired                           
<a id="__codelineno-100-19" name="__codelineno-100-19" href="#__codelineno-100-19"></a>  Phase ends at COMMIT/ABORT                            
<a id="__codelineno-100-20" name="__codelineno-100-20" href="#__codelineno-100-20"></a>                                                         
<a id="__codelineno-100-21" name="__codelineno-100-21" href="#__codelineno-100-21"></a> TRIGGER:                                                
<a id="__codelineno-100-22" name="__codelineno-100-22" href="#__codelineno-100-22"></a>  First lock release triggers transition                
<a id="__codelineno-100-23" name="__codelineno-100-23" href="#__codelineno-100-23"></a>   from GROWING to SHRINKING                             
<a id="__codelineno-100-24" name="__codelineno-100-24" href="#__codelineno-100-24"></a>  Once in SHRINKING, cannot go back                     
<a id="__codelineno-100-25" name="__codelineno-100-25" href="#__codelineno-100-25"></a>  Irreversible phase transition                         
<a id="__codelineno-100-26" name="__codelineno-100-26" href="#__codelineno-100-26"></a>                                                         
<a id="__codelineno-100-27" name="__codelineno-100-27" href="#__codelineno-100-27"></a> ALLOWED OPERATIONS:                                     
<a id="__codelineno-100-28" name="__codelineno-100-28" href="#__codelineno-100-28"></a>            
<a id="__codelineno-100-29" name="__codelineno-100-29" href="#__codelineno-100-29"></a>  1. UNLOCK(X) - Release lock on X                    
<a id="__codelineno-100-30" name="__codelineno-100-30" href="#__codelineno-100-30"></a>  2. DOWNGRADE(X) - Exclusive  Shared                
<a id="__codelineno-100-31" name="__codelineno-100-31" href="#__codelineno-100-31"></a>  3. READ(X) - Read still-locked resource             
<a id="__codelineno-100-32" name="__codelineno-100-32" href="#__codelineno-100-32"></a>  4. WRITE(X) - Write still-locked resource           
<a id="__codelineno-100-33" name="__codelineno-100-33" href="#__codelineno-100-33"></a>  5. COMMIT - End transaction                         
<a id="__codelineno-100-34" name="__codelineno-100-34" href="#__codelineno-100-34"></a>  6. ABORT - Rollback transaction                     
<a id="__codelineno-100-35" name="__codelineno-100-35" href="#__codelineno-100-35"></a>            
<a id="__codelineno-100-36" name="__codelineno-100-36" href="#__codelineno-100-36"></a>                                                         
<a id="__codelineno-100-37" name="__codelineno-100-37" href="#__codelineno-100-37"></a> Timeline Example:                                       
<a id="__codelineno-100-38" name="__codelineno-100-38" href="#__codelineno-100-38"></a>            
<a id="__codelineno-100-39" name="__codelineno-100-39" href="#__codelineno-100-39"></a>   After LOCK POINT                             
<a id="__codelineno-100-40" name="__codelineno-100-40" href="#__codelineno-100-40"></a>  t8: UNLOCK(C)         [2 locks]                    
<a id="__codelineno-100-41" name="__codelineno-100-41" href="#__codelineno-100-41"></a>      (SHRINKING phase started!)                      
<a id="__codelineno-100-42" name="__codelineno-100-42" href="#__codelineno-100-42"></a>  t9: UNLOCK(B)         [1 lock]                     
<a id="__codelineno-100-43" name="__codelineno-100-43" href="#__codelineno-100-43"></a>  t10: UNLOCK(A)        [0 locks]                    
<a id="__codelineno-100-44" name="__codelineno-100-44" href="#__codelineno-100-44"></a>  t11: COMMIT                                          
<a id="__codelineno-100-45" name="__codelineno-100-45" href="#__codelineno-100-45"></a>            
<a id="__codelineno-100-46" name="__codelineno-100-46" href="#__codelineno-100-46"></a>                                                         
<a id="__codelineno-100-47" name="__codelineno-100-47" href="#__codelineno-100-47"></a>
</code></pre></div>
<p><strong>Complete Phase Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a>    COMPLETE TWO-PHASE LOCKING PHASE DIAGRAM             
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a>                                                         
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>  Locks                                                  
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>  Held                                                   
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a>                                                        
<a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a>                LOCK POINT                          
<a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a>                   (Max locks)                         
<a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>                                                       
<a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a> 5                                                     
<a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a>                                                     
<a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a> 4                                                   
<a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a>                                                     
<a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a> 3                                                   
<a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a>                                                     
<a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a> 2                                                   
<a id="__codelineno-101-18" name="__codelineno-101-18" href="#__codelineno-101-18"></a>                                                     
<a id="__codelineno-101-19" name="__codelineno-101-19" href="#__codelineno-101-19"></a> 1                                                   
<a id="__codelineno-101-20" name="__codelineno-101-20" href="#__codelineno-101-20"></a>                                                     
<a id="__codelineno-101-21" name="__codelineno-101-21" href="#__codelineno-101-21"></a> 0                                               
<a id="__codelineno-101-22" name="__codelineno-101-22" href="#__codelineno-101-22"></a>    Time            
<a id="__codelineno-101-23" name="__codelineno-101-23" href="#__codelineno-101-23"></a>     BEGIN                        COMMIT                
<a id="__codelineno-101-24" name="__codelineno-101-24" href="#__codelineno-101-24"></a>                                                        
<a id="__codelineno-101-25" name="__codelineno-101-25" href="#__codelineno-101-25"></a>                                                        
<a id="__codelineno-101-26" name="__codelineno-101-26" href="#__codelineno-101-26"></a>    GROWING  SHRINKING                        
<a id="__codelineno-101-27" name="__codelineno-101-27" href="#__codelineno-101-27"></a>      PHASE          PHASE                               
<a id="__codelineno-101-28" name="__codelineno-101-28" href="#__codelineno-101-28"></a>                                                         
<a id="__codelineno-101-29" name="__codelineno-101-29" href="#__codelineno-101-29"></a>   Transition rule:                                      
<a id="__codelineno-101-30" name="__codelineno-101-30" href="#__codelineno-101-30"></a>    Can move GROWING  SHRINKING (first unlock)         
<a id="__codelineno-101-31" name="__codelineno-101-31" href="#__codelineno-101-31"></a>    Cannot move SHRINKING  GROWING (irreversible!)     
<a id="__codelineno-101-32" name="__codelineno-101-32" href="#__codelineno-101-32"></a>                                                         
<a id="__codelineno-101-33" name="__codelineno-101-33" href="#__codelineno-101-33"></a>
</code></pre></div>
<p><strong>State Transition Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>         2PL STATE TRANSITION DIAGRAM                    
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>                                                         
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>                                                         
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>                                         
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>         NOT                                           
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>        STARTED                                        
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>                                         
<a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a>                                                        
<a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a>              BEGIN                                     
<a id="__codelineno-102-12" name="__codelineno-102-12" href="#__codelineno-102-12"></a>                                                        
<a id="__codelineno-102-13" name="__codelineno-102-13" href="#__codelineno-102-13"></a>                                                        
<a id="__codelineno-102-14" name="__codelineno-102-14" href="#__codelineno-102-14"></a>                                         
<a id="__codelineno-102-15" name="__codelineno-102-15" href="#__codelineno-102-15"></a>         GROWING                           
<a id="__codelineno-102-16" name="__codelineno-102-16" href="#__codelineno-102-16"></a>          PHASE                                       
<a id="__codelineno-102-17" name="__codelineno-102-17" href="#__codelineno-102-17"></a>                                        
<a id="__codelineno-102-18" name="__codelineno-102-18" href="#__codelineno-102-18"></a>                                                       
<a id="__codelineno-102-19" name="__codelineno-102-19" href="#__codelineno-102-19"></a>              Operations:        Can loop:             
<a id="__codelineno-102-20" name="__codelineno-102-20" href="#__codelineno-102-20"></a>               Lock(X)          More locks          
<a id="__codelineno-102-21" name="__codelineno-102-21" href="#__codelineno-102-21"></a>               Upgrade(X)       More upgrades       
<a id="__codelineno-102-22" name="__codelineno-102-22" href="#__codelineno-102-22"></a>               Read(X)          More reads          
<a id="__codelineno-102-23" name="__codelineno-102-23" href="#__codelineno-102-23"></a>               Write(X)                  
<a id="__codelineno-102-24" name="__codelineno-102-24" href="#__codelineno-102-24"></a>                                                        
<a id="__codelineno-102-25" name="__codelineno-102-25" href="#__codelineno-102-25"></a>              First UNLOCK(X)                           
<a id="__codelineno-102-26" name="__codelineno-102-26" href="#__codelineno-102-26"></a>              (irreversible!)                           
<a id="__codelineno-102-27" name="__codelineno-102-27" href="#__codelineno-102-27"></a>                                                        
<a id="__codelineno-102-28" name="__codelineno-102-28" href="#__codelineno-102-28"></a>                                         
<a id="__codelineno-102-29" name="__codelineno-102-29" href="#__codelineno-102-29"></a>        SHRINKING                          
<a id="__codelineno-102-30" name="__codelineno-102-30" href="#__codelineno-102-30"></a>          PHASE                                       
<a id="__codelineno-102-31" name="__codelineno-102-31" href="#__codelineno-102-31"></a>                                        
<a id="__codelineno-102-32" name="__codelineno-102-32" href="#__codelineno-102-32"></a>                                                       
<a id="__codelineno-102-33" name="__codelineno-102-33" href="#__codelineno-102-33"></a>              Operations:        Can loop:             
<a id="__codelineno-102-34" name="__codelineno-102-34" href="#__codelineno-102-34"></a>               Unlock(X)        More unlocks        
<a id="__codelineno-102-35" name="__codelineno-102-35" href="#__codelineno-102-35"></a>               Downgrade(X)     More downgrades     
<a id="__codelineno-102-36" name="__codelineno-102-36" href="#__codelineno-102-36"></a>               Read(X)                               
<a id="__codelineno-102-37" name="__codelineno-102-37" href="#__codelineno-102-37"></a>               Write(X)                  
<a id="__codelineno-102-38" name="__codelineno-102-38" href="#__codelineno-102-38"></a>                                                        
<a id="__codelineno-102-39" name="__codelineno-102-39" href="#__codelineno-102-39"></a>              COMMIT/ABORT                              
<a id="__codelineno-102-40" name="__codelineno-102-40" href="#__codelineno-102-40"></a>                                                        
<a id="__codelineno-102-41" name="__codelineno-102-41" href="#__codelineno-102-41"></a>                                                        
<a id="__codelineno-102-42" name="__codelineno-102-42" href="#__codelineno-102-42"></a>                                         
<a id="__codelineno-102-43" name="__codelineno-102-43" href="#__codelineno-102-43"></a>         ENDED                                         
<a id="__codelineno-102-44" name="__codelineno-102-44" href="#__codelineno-102-44"></a>        (All locks                                     
<a id="__codelineno-102-45" name="__codelineno-102-45" href="#__codelineno-102-45"></a>        released)                                      
<a id="__codelineno-102-46" name="__codelineno-102-46" href="#__codelineno-102-46"></a>                                         
<a id="__codelineno-102-47" name="__codelineno-102-47" href="#__codelineno-102-47"></a>                                                         
<a id="__codelineno-102-48" name="__codelineno-102-48" href="#__codelineno-102-48"></a>
</code></pre></div>
<p><strong>Why Two Phases are Necessary:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>      WHY TWO DISTINCT PHASES ARE NECESSARY              
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>                                                         
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a> What if we allowed mixed acquisition/release?           
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a>                                                         
<a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a>  VIOLATION EXAMPLE (Non-Serializable):                
<a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a>                                                         
<a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a> T1:                          T2:                        
<a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>             
<a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a> Lock(A)                                                 
<a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a> Read A (value=100)                                      
<a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a> Unlock(A)                                             
<a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a>                              Lock(A)                    
<a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a>                              Write A = 200              
<a id="__codelineno-103-16" name="__codelineno-103-16" href="#__codelineno-103-16"></a>                              Unlock(A)                  
<a id="__codelineno-103-17" name="__codelineno-103-17" href="#__codelineno-103-17"></a> Lock(A)  (re-acquire!)                                
<a id="__codelineno-103-18" name="__codelineno-103-18" href="#__codelineno-103-18"></a> Read A (value=200)  CHANGED!                           
<a id="__codelineno-103-19" name="__codelineno-103-19" href="#__codelineno-103-19"></a> Lock(B)                                                 
<a id="__codelineno-103-20" name="__codelineno-103-20" href="#__codelineno-103-20"></a> Write B = A + 50 (250)                                  
<a id="__codelineno-103-21" name="__codelineno-103-21" href="#__codelineno-103-21"></a> Unlock(A), Unlock(B)                                    
<a id="__codelineno-103-22" name="__codelineno-103-22" href="#__codelineno-103-22"></a> Commit                                                  
<a id="__codelineno-103-23" name="__codelineno-103-23" href="#__codelineno-103-23"></a>                                                         
<a id="__codelineno-103-24" name="__codelineno-103-24" href="#__codelineno-103-24"></a> Problem: T1 sees non-repeatable read!                   
<a id="__codelineno-103-25" name="__codelineno-103-25" href="#__codelineno-103-25"></a>         NOT SERIALIZABLE!                               
<a id="__codelineno-103-26" name="__codelineno-103-26" href="#__codelineno-103-26"></a>                                                         
<a id="__codelineno-103-27" name="__codelineno-103-27" href="#__codelineno-103-27"></a>  WITH 2PL (Serializable):                             
<a id="__codelineno-103-28" name="__codelineno-103-28" href="#__codelineno-103-28"></a>                                                         
<a id="__codelineno-103-29" name="__codelineno-103-29" href="#__codelineno-103-29"></a> T1:                          T2:                        
<a id="__codelineno-103-30" name="__codelineno-103-30" href="#__codelineno-103-30"></a>             
<a id="__codelineno-103-31" name="__codelineno-103-31" href="#__codelineno-103-31"></a> Lock(A)                                                 
<a id="__codelineno-103-32" name="__codelineno-103-32" href="#__codelineno-103-32"></a> Read A (value=100)                                      
<a id="__codelineno-103-33" name="__codelineno-103-33" href="#__codelineno-103-33"></a> Lock(B)                                                 
<a id="__codelineno-103-34" name="__codelineno-103-34" href="#__codelineno-103-34"></a> Write B = A + 50 (150)                                  
<a id="__codelineno-103-35" name="__codelineno-103-35" href="#__codelineno-103-35"></a>  LOCK POINT                                       
<a id="__codelineno-103-36" name="__codelineno-103-36" href="#__codelineno-103-36"></a> Commit (releases A, B)                                  
<a id="__codelineno-103-37" name="__codelineno-103-37" href="#__codelineno-103-37"></a>                              Lock(A)                    
<a id="__codelineno-103-38" name="__codelineno-103-38" href="#__codelineno-103-38"></a>                              Write A = 200              
<a id="__codelineno-103-39" name="__codelineno-103-39" href="#__codelineno-103-39"></a>                              Unlock(A)                  
<a id="__codelineno-103-40" name="__codelineno-103-40" href="#__codelineno-103-40"></a>                              Commit                     
<a id="__codelineno-103-41" name="__codelineno-103-41" href="#__codelineno-103-41"></a>                                                         
<a id="__codelineno-103-42" name="__codelineno-103-42" href="#__codelineno-103-42"></a> Result: SERIALIZABLE (T1 before T2)                     
<a id="__codelineno-103-43" name="__codelineno-103-43" href="#__codelineno-103-43"></a>                                                         
<a id="__codelineno-103-44" name="__codelineno-103-44" href="#__codelineno-103-44"></a>
</code></pre></div>
<hr />
<h4 id="455-different-types-of-two-phase-locking">4.5.5 Different Types of Two-Phase Locking</h4>
<p><strong>Description:</strong></p>
<p>While basic 2PL guarantees serializability, it has limitations (like cascading aborts). Several <strong>variants</strong> of 2PL have been developed to address different requirements. Each type offers different trade-offs between concurrency, safety, and implementation complexity.</p>
<p><strong>Evolution of 2PL Variants:</strong></p>
<p>The different types of 2PL didn't emerge randomly - they evolved from <strong>real-world production problems</strong> encountered when deploying basic 2PL in the 1970s and 1980s:</p>
<ol>
<li><strong>Basic 2PL (1976)</strong>: Original protocol, theoretically sound but had cascading abort problem</li>
<li>Problem discovered: One transaction abort could trigger dozens of aborts</li>
<li>
<p>Real incident: IBM System R experienced cascading aborts that rolled back hours of work</p>
</li>
<li>
<p><strong>Strict 2PL (late 1970s)</strong>: Developed to prevent cascading aborts</p>
</li>
<li>Motivation: Production systems needed predictable recovery</li>
<li>
<p>Became the de facto standard for commercial databases</p>
</li>
<li>
<p><strong>Rigorous 2PL (early 1980s)</strong>: Simplified implementation for embedded systems</p>
</li>
<li>Motivation: Reduce complexity in lock managers</li>
<li>
<p>Trade-off: Lower concurrency for simpler code</p>
</li>
<li>
<p><strong>Conservative 2PL (1980s)</strong>: Designed for real-time systems requiring deadlock prevention</p>
</li>
<li>Motivation: Medical devices, industrial control systems can't tolerate deadlocks</li>
<li>Trade-off: Requires knowing all resources upfront</li>
</ol>
<p><strong>Why Multiple Variants Exist:</strong></p>
<p>There's no "one size fits all" because different systems have different priorities:</p>
<p><strong>Banking Systems</strong> (Strict 2PL):
- Priority: No dirty reads (prevent reading uncommitted transfers)
- Tolerance: Can handle occasional deadlocks
- Choice: Strict 2PL - prevents cascading aborts, allows early shared lock release</p>
<p><strong>Real-Time Control Systems</strong> (Conservative 2PL):
- Priority: Guaranteed deadlock-free operation
- Tolerance: Can accept lower throughput
- Choice: Conservative 2PL - pre-declare all resources</p>
<p><strong>Critical Infrastructure</strong> (Rigorous 2PL):
- Priority: Maximum safety, simple recovery
- Tolerance: Lower concurrency acceptable
- Choice: Rigorous 2PL - hold all locks until commit</p>
<p><strong>Research Databases</strong> (Basic 2PL):
- Priority: Maximum concurrency for experiments
- Tolerance: Complex recovery acceptable
- Choice: Basic 2PL - release locks early</p>
<p><strong>The Cascading Abort Problem (Why Variants Matter):</strong></p>
<p>To understand why variants exist, consider this disaster scenario with basic 2PL:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a>T1: Processes customer order (100 steps)
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a>    Step 50: Updates inventory
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>    Step 51: Releases inventory lock (shrinking phase starts)
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>    Step 75: ERROR - payment processing fails
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a>    ABORT!
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>
<a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a>T2: Read inventory from T1 (uncommitted)
<a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a>    Made business decision based on this
<a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a>    Now must ABORT (cascading abort)
<a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a>
<a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a>T3: Read data from T2 (uncommitted)
<a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a>    Must ABORT (cascading)
<a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a>
<a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a>T4: Read data from T3...
<a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a>    Must ABORT (cascading)
<a id="__codelineno-104-16" name="__codelineno-104-16" href="#__codelineno-104-16"></a>
<a id="__codelineno-104-17" name="__codelineno-104-17" href="#__codelineno-104-17"></a>... potential for 100+ cascading aborts!
</code></pre></div>
<p>This actually happened in early database systems, sometimes causing hours of work to be lost. <strong>Strict 2PL</strong> was invented specifically to prevent this nightmare scenario.</p>
<p><strong>Choosing the Right Variant - Decision Framework:</strong></p>
<p>The choice isn't just technical - it's about understanding your system's <strong>operational requirements</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>Question 1: Can you tolerate cascading aborts?
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a> No   Not Basic 2PL
<a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a> Yes  Maybe Basic 2PL (rare in practice)
<a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>
<a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a>Question 2: Do you need deadlock prevention?
<a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a> Yes  Conservative 2PL
<a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a> No   Continue
<a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a>
<a id="__codelineno-105-9" name="__codelineno-105-9" href="#__codelineno-105-9"></a>Question 3: Is implementation simplicity critical?
<a id="__codelineno-105-10" name="__codelineno-105-10" href="#__codelineno-105-10"></a> Yes  Rigorous 2PL
<a id="__codelineno-105-11" name="__codelineno-105-11" href="#__codelineno-105-11"></a> No   Strict 2PL (most common choice)
</code></pre></div>
<p><strong>Industry Standard Choice:</strong></p>
<p><strong>Strict 2PL</strong> emerged as the industry standard (used by 90%+ of production databases) because it offers the <strong>best balance</strong>:
-  Prevents cascading aborts (unlike basic 2PL)
-  Allows reasonable concurrency (unlike rigorous 2PL)
-  Doesn't require pre-declaration (unlike conservative 2PL)
-  Well-understood and extensively tested</p>
<p>When in doubt, choose Strict 2PL - it's the "sensible default" that works well for most applications.</p>
<p><strong>Overview of 2PL Types:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a>         FOUR TYPES OF TWO-PHASE LOCKING                 
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a>
<a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a>                                                         
<a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a> 1. BASIC 2PL (Standard Two-Phase Locking)               
<a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a>     Locks released anytime in shrinking phase          
<a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a>     Serializability guaranteed                         
<a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a>     Cascading aborts possible                        
<a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a>                                                         
<a id="__codelineno-106-10" name="__codelineno-106-10" href="#__codelineno-106-10"></a> 2. STRICT 2PL (Most commonly used)                      
<a id="__codelineno-106-11" name="__codelineno-106-11" href="#__codelineno-106-11"></a>     Exclusive locks held until COMMIT/ABORT            
<a id="__codelineno-106-12" name="__codelineno-106-12" href="#__codelineno-106-12"></a>     Shared locks can be released early                 
<a id="__codelineno-106-13" name="__codelineno-106-13" href="#__codelineno-106-13"></a>     Prevents cascading aborts                         
<a id="__codelineno-106-14" name="__codelineno-106-14" href="#__codelineno-106-14"></a>                                                         
<a id="__codelineno-106-15" name="__codelineno-106-15" href="#__codelineno-106-15"></a> 3. RIGOROUS 2PL (Strongest isolation)                   
<a id="__codelineno-106-16" name="__codelineno-106-16" href="#__codelineno-106-16"></a>     ALL locks held until COMMIT/ABORT                  
<a id="__codelineno-106-17" name="__codelineno-106-17" href="#__codelineno-106-17"></a>     Both shared and exclusive                          
<a id="__codelineno-106-18" name="__codelineno-106-18" href="#__codelineno-106-18"></a>     Simplest to implement                              
<a id="__codelineno-106-19" name="__codelineno-106-19" href="#__codelineno-106-19"></a>                                                         
<a id="__codelineno-106-20" name="__codelineno-106-20" href="#__codelineno-106-20"></a> 4. CONSERVATIVE 2PL (Deadlock-free)                     
<a id="__codelineno-106-21" name="__codelineno-106-21" href="#__codelineno-106-21"></a>     ALL locks acquired before execution                
<a id="__codelineno-106-22" name="__codelineno-106-22" href="#__codelineno-106-22"></a>     No locks acquired during execution                 
<a id="__codelineno-106-23" name="__codelineno-106-23" href="#__codelineno-106-23"></a>     Deadlock prevention                               
<a id="__codelineno-106-24" name="__codelineno-106-24" href="#__codelineno-106-24"></a>                                                         
<a id="__codelineno-106-25" name="__codelineno-106-25" href="#__codelineno-106-25"></a>
</code></pre></div>
<hr />
<h5 id="type-1-basic-2pl-standard-two-phase-locking">Type 1: Basic 2PL (Standard Two-Phase Locking)</h5>
<p><strong>Description:</strong></p>
<p>The <strong>basic</strong> or <strong>standard</strong> 2PL is the original protocol we've discussed. Locks can be released anytime during the shrinking phase, but once any lock is released, no new locks can be acquired.</p>
<p><strong>Rules:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>             BASIC 2PL - RULES                           
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a>                                                         
<a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a> GROWING PHASE:                                          
<a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a>  Acquire locks as needed                               
<a id="__codelineno-107-7" name="__codelineno-107-7" href="#__codelineno-107-7"></a>  Upgrade locks (shared  exclusive)                    
<a id="__codelineno-107-8" name="__codelineno-107-8" href="#__codelineno-107-8"></a>  Cannot release any lock                               
<a id="__codelineno-107-9" name="__codelineno-107-9" href="#__codelineno-107-9"></a>                                                         
<a id="__codelineno-107-10" name="__codelineno-107-10" href="#__codelineno-107-10"></a> SHRINKING PHASE:                                        
<a id="__codelineno-107-11" name="__codelineno-107-11" href="#__codelineno-107-11"></a>  Release locks as soon as not needed                   
<a id="__codelineno-107-12" name="__codelineno-107-12" href="#__codelineno-107-12"></a>  Can release locks individually                        
<a id="__codelineno-107-13" name="__codelineno-107-13" href="#__codelineno-107-13"></a>  Cannot acquire new locks                              
<a id="__codelineno-107-14" name="__codelineno-107-14" href="#__codelineno-107-14"></a>                                                         
<a id="__codelineno-107-15" name="__codelineno-107-15" href="#__codelineno-107-15"></a> COMMIT/ABORT:                                           
<a id="__codelineno-107-16" name="__codelineno-107-16" href="#__codelineno-107-16"></a>  May happen during shrinking phase                     
<a id="__codelineno-107-17" name="__codelineno-107-17" href="#__codelineno-107-17"></a>  Some locks may already be released                    
<a id="__codelineno-107-18" name="__codelineno-107-18" href="#__codelineno-107-18"></a>                                                         
<a id="__codelineno-107-19" name="__codelineno-107-19" href="#__codelineno-107-19"></a>
</code></pre></div>
<p><strong>Timeline Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a>          BASIC 2PL - TIMELINE                           
<a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a>
<a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a>                                                         
<a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a>  Locks                                                  
<a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a>  Held                                                   
<a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a>                                                        
<a id="__codelineno-108-8" name="__codelineno-108-8" href="#__codelineno-108-8"></a>           LOCK POINT                                   
<a id="__codelineno-108-9" name="__codelineno-108-9" href="#__codelineno-108-9"></a>                                                       
<a id="__codelineno-108-10" name="__codelineno-108-10" href="#__codelineno-108-10"></a>                                                      
<a id="__codelineno-108-11" name="__codelineno-108-11" href="#__codelineno-108-11"></a> 3                                                    
<a id="__codelineno-108-12" name="__codelineno-108-12" href="#__codelineno-108-12"></a>                                                      
<a id="__codelineno-108-13" name="__codelineno-108-13" href="#__codelineno-108-13"></a> 2                                                    
<a id="__codelineno-108-14" name="__codelineno-108-14" href="#__codelineno-108-14"></a>                                                      
<a id="__codelineno-108-15" name="__codelineno-108-15" href="#__codelineno-108-15"></a> 1                                                    
<a id="__codelineno-108-16" name="__codelineno-108-16" href="#__codelineno-108-16"></a>                                                      
<a id="__codelineno-108-17" name="__codelineno-108-17" href="#__codelineno-108-17"></a> 0                                       
<a id="__codelineno-108-18" name="__codelineno-108-18" href="#__codelineno-108-18"></a>    Time           
<a id="__codelineno-108-19" name="__codelineno-108-19" href="#__codelineno-108-19"></a>     BEGIN                                           
<a id="__codelineno-108-20" name="__codelineno-108-20" href="#__codelineno-108-20"></a>                            Unlock COMMIT              
<a id="__codelineno-108-21" name="__codelineno-108-21" href="#__codelineno-108-21"></a>                            more                       
<a id="__codelineno-108-22" name="__codelineno-108-22" href="#__codelineno-108-22"></a>                      Unlock locks                      
<a id="__codelineno-108-23" name="__codelineno-108-23" href="#__codelineno-108-23"></a>                      first                             
<a id="__codelineno-108-24" name="__codelineno-108-24" href="#__codelineno-108-24"></a>                      lock                              
<a id="__codelineno-108-25" name="__codelineno-108-25" href="#__codelineno-108-25"></a>          Acquire                                        
<a id="__codelineno-108-26" name="__codelineno-108-26" href="#__codelineno-108-26"></a>          all locks                                      
<a id="__codelineno-108-27" name="__codelineno-108-27" href="#__codelineno-108-27"></a>                                                         
<a id="__codelineno-108-28" name="__codelineno-108-28" href="#__codelineno-108-28"></a>    GROWING  SHRINKING                     
<a id="__codelineno-108-29" name="__codelineno-108-29" href="#__codelineno-108-29"></a>                                                         
<a id="__codelineno-108-30" name="__codelineno-108-30" href="#__codelineno-108-30"></a>
</code></pre></div>
<p><strong>Cascading Abort Problem:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>
<a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a>       BASIC 2PL - CASCADING ABORT PROBLEM               
<a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a>
<a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a>                                                         
<a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a> T1:                          T2:                        
<a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a>             
<a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a> Lock(A)                                                 
<a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a> Write A = 100                                           
<a id="__codelineno-109-9" name="__codelineno-109-9" href="#__codelineno-109-9"></a> Unlock(A)                                              
<a id="__codelineno-109-10" name="__codelineno-109-10" href="#__codelineno-109-10"></a> (Shrinking started)                                     
<a id="__codelineno-109-11" name="__codelineno-109-11" href="#__codelineno-109-11"></a>                              Lock(A)                   
<a id="__codelineno-109-12" name="__codelineno-109-12" href="#__codelineno-109-12"></a>                              Read A = 100               
<a id="__codelineno-109-13" name="__codelineno-109-13" href="#__codelineno-109-13"></a>                              (uncommitted from T1!)     
<a id="__codelineno-109-14" name="__codelineno-109-14" href="#__codelineno-109-14"></a>                              Use value...               
<a id="__codelineno-109-15" name="__codelineno-109-15" href="#__codelineno-109-15"></a> [ERROR occurs]                                          
<a id="__codelineno-109-16" name="__codelineno-109-16" href="#__codelineno-109-16"></a> ABORT!                                                
<a id="__codelineno-109-17" name="__codelineno-109-17" href="#__codelineno-109-17"></a>                                                         
<a id="__codelineno-109-18" name="__codelineno-109-18" href="#__codelineno-109-18"></a>                              Now T2 must ABORT too!   
<a id="__codelineno-109-19" name="__codelineno-109-19" href="#__codelineno-109-19"></a>                              (Read dirty data from T1)  
<a id="__codelineno-109-20" name="__codelineno-109-20" href="#__codelineno-109-20"></a>                                                         
<a id="__codelineno-109-21" name="__codelineno-109-21" href="#__codelineno-109-21"></a> CASCADING ABORT:                                        
<a id="__codelineno-109-22" name="__codelineno-109-22" href="#__codelineno-109-22"></a>  T1 aborts  T2 must abort                             
<a id="__codelineno-109-23" name="__codelineno-109-23" href="#__codelineno-109-23"></a>  T2 abort  T3 must abort (if T3 read T2&#39;s data)       
<a id="__codelineno-109-24" name="__codelineno-109-24" href="#__codelineno-109-24"></a>  T3 abort  T4 must abort...                           
<a id="__codelineno-109-25" name="__codelineno-109-25" href="#__codelineno-109-25"></a>                                                         
<a id="__codelineno-109-26" name="__codelineno-109-26" href="#__codelineno-109-26"></a> Chain reaction of aborts!                             
<a id="__codelineno-109-27" name="__codelineno-109-27" href="#__codelineno-109-27"></a>                                                         
<a id="__codelineno-109-28" name="__codelineno-109-28" href="#__codelineno-109-28"></a>
</code></pre></div>
<p><strong>Pros and Cons:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a>          BASIC 2PL - ADVANTAGES &amp; DISADVANTAGES         
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a>                                                         
<a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a> ADVANTAGES:                                             
<a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a>  Guarantees serializability                           
<a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a>  Maximum concurrency (early lock release)             
<a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a>  Lower lock holding time                              
<a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a>  Better resource utilization                          
<a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a>                                                         
<a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a> DISADVANTAGES:                                          
<a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a>  Cascading aborts possible                            
<a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a>  Complex recovery needed                              
<a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a>  Dirty reads by other transactions                    
<a id="__codelineno-110-15" name="__codelineno-110-15" href="#__codelineno-110-15"></a>  Rarely used in practice                              
<a id="__codelineno-110-16" name="__codelineno-110-16" href="#__codelineno-110-16"></a>                                                         
<a id="__codelineno-110-17" name="__codelineno-110-17" href="#__codelineno-110-17"></a>
</code></pre></div>
<hr />
<h5 id="type-2-strict-2pl-most-common">Type 2: Strict 2PL (Most Common)</h5>
<p><strong>Description:</strong></p>
<p><strong>Strict 2PL</strong> is the most widely used variant in production database systems. It requires that all <strong>exclusive (write) locks</strong> be held until the transaction commits or aborts, while <strong>shared (read) locks</strong> can be released earlier during the shrinking phase.</p>
<p><strong>Rules:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>             STRICT 2PL - RULES                          
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>                                                         
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a> GROWING PHASE:                                          
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>  Acquire locks as needed                               
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a>  Upgrade locks (shared  exclusive)                    
<a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a>  Cannot release any lock                               
<a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a>                                                         
<a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a> SHRINKING PHASE:                                        
<a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a>  Can release SHARED locks early                        
<a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a>  EXCLUSIVE locks MUST be held until commit/abort       
<a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a>  Cannot acquire new locks                              
<a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a>                                                         
<a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a> COMMIT/ABORT:                                           
<a id="__codelineno-111-16" name="__codelineno-111-16" href="#__codelineno-111-16"></a>  ALL exclusive locks released atomically               
<a id="__codelineno-111-17" name="__codelineno-111-17" href="#__codelineno-111-17"></a>  Guarantees no dirty reads                             
<a id="__codelineno-111-18" name="__codelineno-111-18" href="#__codelineno-111-18"></a>                                                         
<a id="__codelineno-111-19" name="__codelineno-111-19" href="#__codelineno-111-19"></a> KEY RULE:                                               
<a id="__codelineno-111-20" name="__codelineno-111-20" href="#__codelineno-111-20"></a>            
<a id="__codelineno-111-21" name="__codelineno-111-21" href="#__codelineno-111-21"></a>  EXCLUSIVE LOCKS held until END                      
<a id="__codelineno-111-22" name="__codelineno-111-22" href="#__codelineno-111-22"></a>  SHARED LOCKS can be released early                  
<a id="__codelineno-111-23" name="__codelineno-111-23" href="#__codelineno-111-23"></a>            
<a id="__codelineno-111-24" name="__codelineno-111-24" href="#__codelineno-111-24"></a>                                                         
<a id="__codelineno-111-25" name="__codelineno-111-25" href="#__codelineno-111-25"></a>
</code></pre></div>
<p><strong>Timeline Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a>
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a>          STRICT 2PL - TIMELINE                          
<a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>
<a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a>                                                         
<a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a>  Locks                                                  
<a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>  Held                                                   
<a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a>                                                        
<a id="__codelineno-112-8" name="__codelineno-112-8" href="#__codelineno-112-8"></a>       LOCK                                             
<a id="__codelineno-112-9" name="__codelineno-112-9" href="#__codelineno-112-9"></a>      POINT                                             
<a id="__codelineno-112-10" name="__codelineno-112-10" href="#__codelineno-112-10"></a>                                 
<a id="__codelineno-112-11" name="__codelineno-112-11" href="#__codelineno-112-11"></a> 3                                                   
<a id="__codelineno-112-12" name="__codelineno-112-12" href="#__codelineno-112-12"></a>             Exclusive locks                        
<a id="__codelineno-112-13" name="__codelineno-112-13" href="#__codelineno-112-13"></a> 2                             held until commit     
<a id="__codelineno-112-14" name="__codelineno-112-14" href="#__codelineno-112-14"></a>                                                     
<a id="__codelineno-112-15" name="__codelineno-112-15" href="#__codelineno-112-15"></a> 1                                          
<a id="__codelineno-112-16" name="__codelineno-112-16" href="#__codelineno-112-16"></a>     Shared                                        
<a id="__codelineno-112-17" name="__codelineno-112-17" href="#__codelineno-112-17"></a> 0     locks                                         
<a id="__codelineno-112-18" name="__codelineno-112-18" href="#__codelineno-112-18"></a>    Time               
<a id="__codelineno-112-19" name="__codelineno-112-19" href="#__codelineno-112-19"></a>   BEGIN             Released  COMMIT                   
<a id="__codelineno-112-20" name="__codelineno-112-20" href="#__codelineno-112-20"></a>                      early                             
<a id="__codelineno-112-21" name="__codelineno-112-21" href="#__codelineno-112-21"></a>                                                        
<a id="__codelineno-112-22" name="__codelineno-112-22" href="#__codelineno-112-22"></a>                  (Shared                                
<a id="__codelineno-112-23" name="__codelineno-112-23" href="#__codelineno-112-23"></a>                   locks)                                
<a id="__codelineno-112-24" name="__codelineno-112-24" href="#__codelineno-112-24"></a>                                                         
<a id="__codelineno-112-25" name="__codelineno-112-25" href="#__codelineno-112-25"></a>    GROWING  SHRINKING                     
<a id="__codelineno-112-26" name="__codelineno-112-26" href="#__codelineno-112-26"></a>                                                         
<a id="__codelineno-112-27" name="__codelineno-112-27" href="#__codelineno-112-27"></a>   Legend:                                               
<a id="__codelineno-112-28" name="__codelineno-112-28" href="#__codelineno-112-28"></a>    Exclusive locks (held until commit)              
<a id="__codelineno-112-29" name="__codelineno-112-29" href="#__codelineno-112-29"></a>     Shared locks (can be released early)             
<a id="__codelineno-112-30" name="__codelineno-112-30" href="#__codelineno-112-30"></a>                                                         
<a id="__codelineno-112-31" name="__codelineno-112-31" href="#__codelineno-112-31"></a>
</code></pre></div>
<p><strong>No Cascading Aborts:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a>       STRICT 2PL - NO CASCADING ABORTS                  
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>                                                         
<a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a> T1:                          T2:                        
<a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>             
<a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a> Lock-X(A)                                               
<a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a> Write A = 100                                           
<a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a> (Still holds lock!)                                   
<a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a>                              Lock-X(A)                  
<a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a>                               WAITS for T1             
<a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a> Continue work...                                        
<a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a> [ERROR occurs]                                          
<a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a> ABORT!                                                
<a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a> Unlock(A)                                               
<a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a> (T1 aborted, A reverted)                                
<a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a>                                                         
<a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a>                              Lock-X(A)  (now acquired) 
<a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a>                              Read A = [original value]  
<a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a>                               No dirty read!           
<a id="__codelineno-113-21" name="__codelineno-113-21" href="#__codelineno-113-21"></a>                              Continue normally...       
<a id="__codelineno-113-22" name="__codelineno-113-22" href="#__codelineno-113-22"></a>                                                         
<a id="__codelineno-113-23" name="__codelineno-113-23" href="#__codelineno-113-23"></a> RESULT:                                                 
<a id="__codelineno-113-24" name="__codelineno-113-24" href="#__codelineno-113-24"></a>  T2 never saw uncommitted data                         
<a id="__codelineno-113-25" name="__codelineno-113-25" href="#__codelineno-113-25"></a>  No cascading abort needed!                            
<a id="__codelineno-113-26" name="__codelineno-113-26" href="#__codelineno-113-26"></a>  Clean isolation                                       
<a id="__codelineno-113-27" name="__codelineno-113-27" href="#__codelineno-113-27"></a>                                                         
<a id="__codelineno-113-28" name="__codelineno-113-28" href="#__codelineno-113-28"></a>
</code></pre></div>
<p><strong>Real-World Usage:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a>       STRICT 2PL - DATABASE USAGE                       
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>                                                         
<a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a> Used by:                                                
<a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a>  MySQL/InnoDB (REPEATABLE READ, SERIALIZABLE)          
<a id="__codelineno-114-7" name="__codelineno-114-7" href="#__codelineno-114-7"></a>  PostgreSQL (REPEATABLE READ, SERIALIZABLE)            
<a id="__codelineno-114-8" name="__codelineno-114-8" href="#__codelineno-114-8"></a>  Oracle Database (SERIALIZABLE isolation)              
<a id="__codelineno-114-9" name="__codelineno-114-9" href="#__codelineno-114-9"></a>  SQL Server (SERIALIZABLE isolation)                   
<a id="__codelineno-114-10" name="__codelineno-114-10" href="#__codelineno-114-10"></a>  DB2                                                   
<a id="__codelineno-114-11" name="__codelineno-114-11" href="#__codelineno-114-11"></a>                                                         
<a id="__codelineno-114-12" name="__codelineno-114-12" href="#__codelineno-114-12"></a> Why preferred:                                          
<a id="__codelineno-114-13" name="__codelineno-114-13" href="#__codelineno-114-13"></a>  Prevents dirty reads                                 
<a id="__codelineno-114-14" name="__codelineno-114-14" href="#__codelineno-114-14"></a>  Prevents cascading aborts                            
<a id="__codelineno-114-15" name="__codelineno-114-15" href="#__codelineno-114-15"></a>  Simpler recovery                                     
<a id="__codelineno-114-16" name="__codelineno-114-16" href="#__codelineno-114-16"></a>  Good concurrency (shared locks released early)       
<a id="__codelineno-114-17" name="__codelineno-114-17" href="#__codelineno-114-17"></a>                                                         
<a id="__codelineno-114-18" name="__codelineno-114-18" href="#__codelineno-114-18"></a>
</code></pre></div>
<p><strong>Pros and Cons:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a>         STRICT 2PL - ADVANTAGES &amp; DISADVANTAGES         
<a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a>
<a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a>                                                         
<a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a> ADVANTAGES:                                             
<a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a>  Guarantees serializability                           
<a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a>  Prevents cascading aborts                            
<a id="__codelineno-115-8" name="__codelineno-115-8" href="#__codelineno-115-8"></a>  No dirty reads                                       
<a id="__codelineno-115-9" name="__codelineno-115-9" href="#__codelineno-115-9"></a>  Simpler recovery mechanism                           
<a id="__codelineno-115-10" name="__codelineno-115-10" href="#__codelineno-115-10"></a>  Industry standard                                    
<a id="__codelineno-115-11" name="__codelineno-115-11" href="#__codelineno-115-11"></a>  Good balance: concurrency vs safety                  
<a id="__codelineno-115-12" name="__codelineno-115-12" href="#__codelineno-115-12"></a>                                                         
<a id="__codelineno-115-13" name="__codelineno-115-13" href="#__codelineno-115-13"></a> DISADVANTAGES:                                          
<a id="__codelineno-115-14" name="__codelineno-115-14" href="#__codelineno-115-14"></a>  Longer lock holding time (exclusive locks)           
<a id="__codelineno-115-15" name="__codelineno-115-15" href="#__codelineno-115-15"></a>  Lower concurrency than basic 2PL                     
<a id="__codelineno-115-16" name="__codelineno-115-16" href="#__codelineno-115-16"></a>  Deadlocks still possible                             
<a id="__codelineno-115-17" name="__codelineno-115-17" href="#__codelineno-115-17"></a>                                                         
<a id="__codelineno-115-18" name="__codelineno-115-18" href="#__codelineno-115-18"></a>
</code></pre></div>
<hr />
<h5 id="type-3-rigorous-2pl-strongest">Type 3: Rigorous 2PL (Strongest)</h5>
<p><strong>Description:</strong></p>
<p><strong>Rigorous 2PL</strong> is the strictest variant. It requires that <strong>ALL locks</strong> (both shared and exclusive) be held until the transaction commits or aborts. No locks are released during the shrinking phase until the very end.</p>
<p><strong>Rules:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a>
<a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a>           RIGOROUS 2PL - RULES                          
<a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a>
<a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a>                                                         
<a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a> GROWING PHASE:                                          
<a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a>  Acquire locks as needed                               
<a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a>  Upgrade locks (shared  exclusive)                    
<a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a>  Cannot release any lock                               
<a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a>                                                         
<a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a> &quot;SHRINKING&quot; PHASE (actually no shrinking!):             
<a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a>  Hold ALL locks                                        
<a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a>  No locks released                                     
<a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a>  Cannot acquire new locks                              
<a id="__codelineno-116-14" name="__codelineno-116-14" href="#__codelineno-116-14"></a>                                                         
<a id="__codelineno-116-15" name="__codelineno-116-15" href="#__codelineno-116-15"></a> COMMIT/ABORT:                                           
<a id="__codelineno-116-16" name="__codelineno-116-16" href="#__codelineno-116-16"></a>  ALL locks released atomically at once                 
<a id="__codelineno-116-17" name="__codelineno-116-17" href="#__codelineno-116-17"></a>  Guaranteed strictest isolation                        
<a id="__codelineno-116-18" name="__codelineno-116-18" href="#__codelineno-116-18"></a>                                                         
<a id="__codelineno-116-19" name="__codelineno-116-19" href="#__codelineno-116-19"></a> KEY RULE:                                               
<a id="__codelineno-116-20" name="__codelineno-116-20" href="#__codelineno-116-20"></a>            
<a id="__codelineno-116-21" name="__codelineno-116-21" href="#__codelineno-116-21"></a>  ALL LOCKS held until COMMIT/ABORT                   
<a id="__codelineno-116-22" name="__codelineno-116-22" href="#__codelineno-116-22"></a>  No early release whatsoever                         
<a id="__codelineno-116-23" name="__codelineno-116-23" href="#__codelineno-116-23"></a>            
<a id="__codelineno-116-24" name="__codelineno-116-24" href="#__codelineno-116-24"></a>                                                         
<a id="__codelineno-116-25" name="__codelineno-116-25" href="#__codelineno-116-25"></a>
</code></pre></div>
<p><strong>Timeline Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a>
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a>         RIGOROUS 2PL - TIMELINE                         
<a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a>
<a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a>                                                         
<a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a>  Locks                                                  
<a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a>  Held                                                   
<a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a>                                                        
<a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a>       LOCK                                             
<a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a>      POINT                                             
<a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a>                                
<a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a> 3                                                   
<a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a>                                                     
<a id="__codelineno-117-13" name="__codelineno-117-13" href="#__codelineno-117-13"></a> 2                             ALL locks held        
<a id="__codelineno-117-14" name="__codelineno-117-14" href="#__codelineno-117-14"></a>                               until commit!         
<a id="__codelineno-117-15" name="__codelineno-117-15" href="#__codelineno-117-15"></a> 1                                                   
<a id="__codelineno-117-16" name="__codelineno-117-16" href="#__codelineno-117-16"></a>                                                     
<a id="__codelineno-117-17" name="__codelineno-117-17" href="#__codelineno-117-17"></a> 0                                     
<a id="__codelineno-117-18" name="__codelineno-117-18" href="#__codelineno-117-18"></a>    Time              
<a id="__codelineno-117-19" name="__codelineno-117-19" href="#__codelineno-117-19"></a>   BEGIN                       COMMIT                   
<a id="__codelineno-117-20" name="__codelineno-117-20" href="#__codelineno-117-20"></a>                              (All locks                
<a id="__codelineno-117-21" name="__codelineno-117-21" href="#__codelineno-117-21"></a>          Lock point           released                  
<a id="__codelineno-117-22" name="__codelineno-117-22" href="#__codelineno-117-22"></a>         (max locks)           atomically)               
<a id="__codelineno-117-23" name="__codelineno-117-23" href="#__codelineno-117-23"></a>                                                         
<a id="__codelineno-117-24" name="__codelineno-117-24" href="#__codelineno-117-24"></a>    GROWING  HOLD ALL                       
<a id="__codelineno-117-25" name="__codelineno-117-25" href="#__codelineno-117-25"></a>                  (No shrinking!)                        
<a id="__codelineno-117-26" name="__codelineno-117-26" href="#__codelineno-117-26"></a>                                                         
<a id="__codelineno-117-27" name="__codelineno-117-27" href="#__codelineno-117-27"></a>   Note: Technically no &quot;shrinking&quot; phase                
<a id="__codelineno-117-28" name="__codelineno-117-28" href="#__codelineno-117-28"></a>         Locks held at plateau until end                 
<a id="__codelineno-117-29" name="__codelineno-117-29" href="#__codelineno-117-29"></a>                                                         
<a id="__codelineno-117-30" name="__codelineno-117-30" href="#__codelineno-117-30"></a>
</code></pre></div>
<p><strong>Characteristics:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>         RIGOROUS 2PL - CHARACTERISTICS                  
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a>                                                         
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a> ISOLATION LEVEL:                                        
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a>  Strongest possible isolation                          
<a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a>  Equivalent to pure serial execution                   
<a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a>  No interference whatsoever                            
<a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a>                                                         
<a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a> LOCK MANAGEMENT:                                        
<a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a>  Simplest to implement                                 
<a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a>  No need to track which locks to release               
<a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a>  Release all at commit/abort                           
<a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a>                                                         
<a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a> SERIALIZABILITY:                                        
<a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a>  Guarantees strict serializability                     
<a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a>  Commit order = serialization order                    
<a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a>  No dirty reads, no cascading aborts                   
<a id="__codelineno-118-19" name="__codelineno-118-19" href="#__codelineno-118-19"></a>                                                         
<a id="__codelineno-118-20" name="__codelineno-118-20" href="#__codelineno-118-20"></a> CONCURRENCY:                                            
<a id="__codelineno-118-21" name="__codelineno-118-21" href="#__codelineno-118-21"></a>  Lowest concurrency of all 2PL types                   
<a id="__codelineno-118-22" name="__codelineno-118-22" href="#__codelineno-118-22"></a>  Maximum blocking                                      
<a id="__codelineno-118-23" name="__codelineno-118-23" href="#__codelineno-118-23"></a>  Longest lock hold times                               
<a id="__codelineno-118-24" name="__codelineno-118-24" href="#__codelineno-118-24"></a>                                                         
<a id="__codelineno-118-25" name="__codelineno-118-25" href="#__codelineno-118-25"></a>
</code></pre></div>
<p><strong>Use Cases:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a>           RIGOROUS 2PL - USE CASES                      
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>
<a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a>                                                         
<a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a> Best for:                                               
<a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a>  Critical financial transactions                       
<a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a>  Audit trail requirements                              
<a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a>  Strict compliance (SOX, HIPAA)                        
<a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a>  Systems where correctness &gt; performance               
<a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a>  Low-contention workloads                              
<a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a>                                                         
<a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a> Examples:                                               
<a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a>  Banking: Wire transfers                               
<a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a>  Healthcare: Medical record updates                    
<a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a>  Legal: Contract modifications                         
<a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a>  Government: Classified data updates                   
<a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a>                                                         
<a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a>
</code></pre></div>
<p><strong>Pros and Cons:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a>       RIGOROUS 2PL - ADVANTAGES &amp; DISADVANTAGES         
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>                                                         
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a> ADVANTAGES:                                             
<a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a>  Strongest isolation guarantee                        
<a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a>  Simplest to implement                                
<a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a>  No cascading aborts                                  
<a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a>  No dirty reads                                       
<a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>  Strict serializability                               
<a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a>  Easy to reason about                                 
<a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a>                                                         
<a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a> DISADVANTAGES:                                          
<a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a>  Lowest concurrency                                   
<a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a>  Longest lock hold times                              
<a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a>  Highest blocking/waiting                             
<a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a>  Poor scalability                                     
<a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a>  Overkill for many applications                       
<a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a>                                                         
<a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a>
</code></pre></div>
<hr />
<h5 id="type-4-conservative-2pl-deadlock-free">Type 4: Conservative 2PL (Deadlock-Free)</h5>
<p><strong>Description:</strong></p>
<p><strong>Conservative 2PL</strong> (also called <strong>Static 2PL</strong>) requires that transactions declare and acquire <strong>ALL locks</strong> they need <strong>before</strong> starting execution. Once execution begins, no additional locks can be acquired. This completely prevents deadlocks but requires knowing all resources in advance.</p>
<p><strong>Rules:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>          CONSERVATIVE 2PL - RULES                       
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>
<a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>                                                         
<a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a> PRE-EXECUTION PHASE:                                    
<a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a>  Declare ALL resources needed                          
<a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a>  Acquire ALL locks at once (atomically)                
<a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>  If any lock unavailable  WAIT                        
<a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a>  Only proceed when ALL acquired                        
<a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a>                                                         
<a id="__codelineno-121-11" name="__codelineno-121-11" href="#__codelineno-121-11"></a> EXECUTION PHASE:                                        
<a id="__codelineno-121-12" name="__codelineno-121-12" href="#__codelineno-121-12"></a>  Execute transaction logic                             
<a id="__codelineno-121-13" name="__codelineno-121-13" href="#__codelineno-121-13"></a>  Use already-held locks                                
<a id="__codelineno-121-14" name="__codelineno-121-14" href="#__codelineno-121-14"></a>  NO new locks can be acquired                          
<a id="__codelineno-121-15" name="__codelineno-121-15" href="#__codelineno-121-15"></a>  Can release locks if done                             
<a id="__codelineno-121-16" name="__codelineno-121-16" href="#__codelineno-121-16"></a>                                                         
<a id="__codelineno-121-17" name="__codelineno-121-17" href="#__codelineno-121-17"></a> POST-EXECUTION:                                         
<a id="__codelineno-121-18" name="__codelineno-121-18" href="#__codelineno-121-18"></a>  Release all locks at commit/abort                     
<a id="__codelineno-121-19" name="__codelineno-121-19" href="#__codelineno-121-19"></a>                                                         
<a id="__codelineno-121-20" name="__codelineno-121-20" href="#__codelineno-121-20"></a> KEY RULE:                                               
<a id="__codelineno-121-21" name="__codelineno-121-21" href="#__codelineno-121-21"></a>            
<a id="__codelineno-121-22" name="__codelineno-121-22" href="#__codelineno-121-22"></a>  ALL LOCKS acquired BEFORE execution                 
<a id="__codelineno-121-23" name="__codelineno-121-23" href="#__codelineno-121-23"></a>  No locks acquired DURING execution                  
<a id="__codelineno-121-24" name="__codelineno-121-24" href="#__codelineno-121-24"></a>            
<a id="__codelineno-121-25" name="__codelineno-121-25" href="#__codelineno-121-25"></a>                                                         
<a id="__codelineno-121-26" name="__codelineno-121-26" href="#__codelineno-121-26"></a>
</code></pre></div>
<p><strong>Timeline Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a>
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a>        CONSERVATIVE 2PL - TIMELINE                      
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a>                                                         
<a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>  Locks                                                  
<a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a>  Held                                                   
<a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a>                                                        
<a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a>                                                        
<a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a> 3                        
<a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a>        All locks acquired upfront                   
<a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a> 2                                                     
<a id="__codelineno-122-12" name="__codelineno-122-12" href="#__codelineno-122-12"></a>         Execution happens here                        
<a id="__codelineno-122-13" name="__codelineno-122-13" href="#__codelineno-122-13"></a> 1       (no new locks needed)                         
<a id="__codelineno-122-14" name="__codelineno-122-14" href="#__codelineno-122-14"></a>                                                       
<a id="__codelineno-122-15" name="__codelineno-122-15" href="#__codelineno-122-15"></a> 0                                              
<a id="__codelineno-122-16" name="__codelineno-122-16" href="#__codelineno-122-16"></a>    Time         
<a id="__codelineno-122-17" name="__codelineno-122-17" href="#__codelineno-122-17"></a>     BEGIN                          COMMIT              
<a id="__codelineno-122-18" name="__codelineno-122-18" href="#__codelineno-122-18"></a>                                                        
<a id="__codelineno-122-19" name="__codelineno-122-19" href="#__codelineno-122-19"></a>        Acquire ALL                                      
<a id="__codelineno-122-20" name="__codelineno-122-20" href="#__codelineno-122-20"></a>        locks atomically                                 
<a id="__codelineno-122-21" name="__codelineno-122-21" href="#__codelineno-122-21"></a>        (may wait here)                                  
<a id="__codelineno-122-22" name="__codelineno-122-22" href="#__codelineno-122-22"></a>                                                         
<a id="__codelineno-122-23" name="__codelineno-122-23" href="#__codelineno-122-23"></a>   LOCK EXECUTE RELEASE             
<a id="__codelineno-122-24" name="__codelineno-122-24" href="#__codelineno-122-24"></a>     ALL                          ALL                    
<a id="__codelineno-122-25" name="__codelineno-122-25" href="#__codelineno-122-25"></a>                                                         
<a id="__codelineno-122-26" name="__codelineno-122-26" href="#__codelineno-122-26"></a>   Key difference: Lock acquisition is INSTANTANEOUS     
<a id="__codelineno-122-27" name="__codelineno-122-27" href="#__codelineno-122-27"></a>   (all at once) or transaction WAITS                    
<a id="__codelineno-122-28" name="__codelineno-122-28" href="#__codelineno-122-28"></a>                                                         
<a id="__codelineno-122-29" name="__codelineno-122-29" href="#__codelineno-122-29"></a>
</code></pre></div>
<p><strong>Why Deadlock-Free:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a>      CONSERVATIVE 2PL - DEADLOCK PREVENTION             
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a>                                                         
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a> Deadlock requires HOLD-AND-WAIT:                        
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>  T1 holds A, waits for B                               
<a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a>  T2 holds B, waits for A                               
<a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a>                                                         
<a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a> Conservative 2PL breaks this:                           
<a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a>                                                         
<a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a> T1: Request [A, B]                                      
<a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a>      Either gets BOTH or NEITHER                       
<a id="__codelineno-123-13" name="__codelineno-123-13" href="#__codelineno-123-13"></a>      No partial acquisition                            
<a id="__codelineno-123-14" name="__codelineno-123-14" href="#__codelineno-123-14"></a>                                                         
<a id="__codelineno-123-15" name="__codelineno-123-15" href="#__codelineno-123-15"></a> T2: Request [B, A]                                      
<a id="__codelineno-123-16" name="__codelineno-123-16" href="#__codelineno-123-16"></a>      Either gets BOTH or NEITHER                       
<a id="__codelineno-123-17" name="__codelineno-123-17" href="#__codelineno-123-17"></a>      One will wait, one will proceed                   
<a id="__codelineno-123-18" name="__codelineno-123-18" href="#__codelineno-123-18"></a>                                                         
<a id="__codelineno-123-19" name="__codelineno-123-19" href="#__codelineno-123-19"></a> Timeline:                                               
<a id="__codelineno-123-20" name="__codelineno-123-20" href="#__codelineno-123-20"></a>                     
<a id="__codelineno-123-21" name="__codelineno-123-21" href="#__codelineno-123-21"></a> T1: Request A, B                                        
<a id="__codelineno-123-22" name="__codelineno-123-22" href="#__codelineno-123-22"></a>      Gets both                                        
<a id="__codelineno-123-23" name="__codelineno-123-23" href="#__codelineno-123-23"></a>     Executes...                                         
<a id="__codelineno-123-24" name="__codelineno-123-24" href="#__codelineno-123-24"></a>                                                         
<a id="__codelineno-123-25" name="__codelineno-123-25" href="#__codelineno-123-25"></a> T2: Request B, A                                        
<a id="__codelineno-123-26" name="__codelineno-123-26" href="#__codelineno-123-26"></a>      WAITS (T1 holds them)                             
<a id="__codelineno-123-27" name="__codelineno-123-27" href="#__codelineno-123-27"></a>                                                         
<a id="__codelineno-123-28" name="__codelineno-123-28" href="#__codelineno-123-28"></a> T1: Completes, releases A, B                            
<a id="__codelineno-123-29" name="__codelineno-123-29" href="#__codelineno-123-29"></a>                                                         
<a id="__codelineno-123-30" name="__codelineno-123-30" href="#__codelineno-123-30"></a> T2:  Gets both                                        
<a id="__codelineno-123-31" name="__codelineno-123-31" href="#__codelineno-123-31"></a>     Executes...                                         
<a id="__codelineno-123-32" name="__codelineno-123-32" href="#__codelineno-123-32"></a>                                                         
<a id="__codelineno-123-33" name="__codelineno-123-33" href="#__codelineno-123-33"></a> NO DEADLOCK POSSIBLE!                                 
<a id="__codelineno-123-34" name="__codelineno-123-34" href="#__codelineno-123-34"></a> (Because no hold-and-wait)                              
<a id="__codelineno-123-35" name="__codelineno-123-35" href="#__codelineno-123-35"></a>                                                         
<a id="__codelineno-123-36" name="__codelineno-123-36" href="#__codelineno-123-36"></a>
</code></pre></div>
<p><strong>Implementation Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConservativeTwoPhaseLocking</span><span class="p">:</span>
<a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="sd">    Conservative 2PL: Acquire all locks before execution</span>
<a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a>
<a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">transfer_conservative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_acc</span><span class="p">,</span> <span class="n">to_acc</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a>        <span class="c1"># STEP 1: Declare all resources needed</span>
<a id="__codelineno-124-8" name="__codelineno-124-8" href="#__codelineno-124-8"></a>        <span class="n">required_locks</span> <span class="o">=</span> <span class="p">{</span><span class="n">from_acc</span><span class="p">,</span> <span class="n">to_acc</span><span class="p">}</span>
<a id="__codelineno-124-9" name="__codelineno-124-9" href="#__codelineno-124-9"></a>
<a id="__codelineno-124-10" name="__codelineno-124-10" href="#__codelineno-124-10"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Declaring needed resources: </span><span class="si">{</span><span class="n">required_locks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-124-11" name="__codelineno-124-11" href="#__codelineno-124-11"></a>
<a id="__codelineno-124-12" name="__codelineno-124-12" href="#__codelineno-124-12"></a>        <span class="c1"># STEP 2: Acquire ALL locks atomically</span>
<a id="__codelineno-124-13" name="__codelineno-124-13" href="#__codelineno-124-13"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to acquire ALL locks...&quot;</span><span class="p">)</span>
<a id="__codelineno-124-14" name="__codelineno-124-14" href="#__codelineno-124-14"></a>        <span class="n">acquired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquire_all_locks_atomic</span><span class="p">(</span><span class="n">required_locks</span><span class="p">)</span>
<a id="__codelineno-124-15" name="__codelineno-124-15" href="#__codelineno-124-15"></a>
<a id="__codelineno-124-16" name="__codelineno-124-16" href="#__codelineno-124-16"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">acquired</span><span class="p">:</span>
<a id="__codelineno-124-17" name="__codelineno-124-17" href="#__codelineno-124-17"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not acquire all locks, waiting...&quot;</span><span class="p">)</span>
<a id="__codelineno-124-18" name="__codelineno-124-18" href="#__codelineno-124-18"></a>            <span class="c1"># Wait and retry</span>
<a id="__codelineno-124-19" name="__codelineno-124-19" href="#__codelineno-124-19"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-124-20" name="__codelineno-124-20" href="#__codelineno-124-20"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_conservative</span><span class="p">(</span><span class="n">from_acc</span><span class="p">,</span> <span class="n">to_acc</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-124-21" name="__codelineno-124-21" href="#__codelineno-124-21"></a>
<a id="__codelineno-124-22" name="__codelineno-124-22" href="#__codelineno-124-22"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; All locks acquired! Starting execution...&quot;</span><span class="p">)</span>
<a id="__codelineno-124-23" name="__codelineno-124-23" href="#__codelineno-124-23"></a>
<a id="__codelineno-124-24" name="__codelineno-124-24" href="#__codelineno-124-24"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-124-25" name="__codelineno-124-25" href="#__codelineno-124-25"></a>            <span class="c1"># STEP 3: Execute (no new locks needed)</span>
<a id="__codelineno-124-26" name="__codelineno-124-26" href="#__codelineno-124-26"></a>            <span class="n">balance_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">from_acc</span><span class="p">)</span>
<a id="__codelineno-124-27" name="__codelineno-124-27" href="#__codelineno-124-27"></a>            <span class="n">balance_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">to_acc</span><span class="p">)</span>
<a id="__codelineno-124-28" name="__codelineno-124-28" href="#__codelineno-124-28"></a>
<a id="__codelineno-124-29" name="__codelineno-124-29" href="#__codelineno-124-29"></a>            <span class="k">if</span> <span class="n">balance_from</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-124-30" name="__codelineno-124-30" href="#__codelineno-124-30"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Insufficient funds&quot;</span><span class="p">)</span>
<a id="__codelineno-124-31" name="__codelineno-124-31" href="#__codelineno-124-31"></a>
<a id="__codelineno-124-32" name="__codelineno-124-32" href="#__codelineno-124-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">from_acc</span><span class="p">,</span> <span class="n">balance_from</span> <span class="o">-</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-124-33" name="__codelineno-124-33" href="#__codelineno-124-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_acc</span><span class="p">,</span> <span class="n">balance_to</span> <span class="o">+</span> <span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-124-34" name="__codelineno-124-34" href="#__codelineno-124-34"></a>
<a id="__codelineno-124-35" name="__codelineno-124-35" href="#__codelineno-124-35"></a>            <span class="c1"># STEP 4: Commit and release ALL locks</span>
<a id="__codelineno-124-36" name="__codelineno-124-36" href="#__codelineno-124-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-124-37" name="__codelineno-124-37" href="#__codelineno-124-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">release_all_locks</span><span class="p">(</span><span class="n">required_locks</span><span class="p">)</span>
<a id="__codelineno-124-38" name="__codelineno-124-38" href="#__codelineno-124-38"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Transaction complete, all locks released&quot;</span><span class="p">)</span>
<a id="__codelineno-124-39" name="__codelineno-124-39" href="#__codelineno-124-39"></a>
<a id="__codelineno-124-40" name="__codelineno-124-40" href="#__codelineno-124-40"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-124-41" name="__codelineno-124-41" href="#__codelineno-124-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-124-42" name="__codelineno-124-42" href="#__codelineno-124-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">release_all_locks</span><span class="p">(</span><span class="n">required_locks</span><span class="p">)</span>
<a id="__codelineno-124-43" name="__codelineno-124-43" href="#__codelineno-124-43"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Transaction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-124-44" name="__codelineno-124-44" href="#__codelineno-124-44"></a>
<a id="__codelineno-124-45" name="__codelineno-124-45" href="#__codelineno-124-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">acquire_all_locks_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locks</span><span class="p">):</span>
<a id="__codelineno-124-46" name="__codelineno-124-46" href="#__codelineno-124-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-124-47" name="__codelineno-124-47" href="#__codelineno-124-47"></a><span class="sd">        Try to acquire all locks atomically</span>
<a id="__codelineno-124-48" name="__codelineno-124-48" href="#__codelineno-124-48"></a><span class="sd">        Returns True if all acquired, False otherwise</span>
<a id="__codelineno-124-49" name="__codelineno-124-49" href="#__codelineno-124-49"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-124-50" name="__codelineno-124-50" href="#__codelineno-124-50"></a>        <span class="c1"># Sort locks to prevent deadlock (even though not needed)</span>
<a id="__codelineno-124-51" name="__codelineno-124-51" href="#__codelineno-124-51"></a>        <span class="n">sorted_locks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">locks</span><span class="p">)</span>
<a id="__codelineno-124-52" name="__codelineno-124-52" href="#__codelineno-124-52"></a>        <span class="n">acquired</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-124-53" name="__codelineno-124-53" href="#__codelineno-124-53"></a>
<a id="__codelineno-124-54" name="__codelineno-124-54" href="#__codelineno-124-54"></a>        <span class="k">for</span> <span class="n">lock</span> <span class="ow">in</span> <span class="n">sorted_locks</span><span class="p">:</span>
<a id="__codelineno-124-55" name="__codelineno-124-55" href="#__codelineno-124-55"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
<a id="__codelineno-124-56" name="__codelineno-124-56" href="#__codelineno-124-56"></a>                <span class="n">acquired</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
<a id="__codelineno-124-57" name="__codelineno-124-57" href="#__codelineno-124-57"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-124-58" name="__codelineno-124-58" href="#__codelineno-124-58"></a>                <span class="c1"># Failed to get one lock, release all acquired</span>
<a id="__codelineno-124-59" name="__codelineno-124-59" href="#__codelineno-124-59"></a>                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">acquired</span><span class="p">:</span>
<a id="__codelineno-124-60" name="__codelineno-124-60" href="#__codelineno-124-60"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<a id="__codelineno-124-61" name="__codelineno-124-61" href="#__codelineno-124-61"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-124-62" name="__codelineno-124-62" href="#__codelineno-124-62"></a>
<a id="__codelineno-124-63" name="__codelineno-124-63" href="#__codelineno-124-63"></a>        <span class="c1"># All acquired!</span>
<a id="__codelineno-124-64" name="__codelineno-124-64" href="#__codelineno-124-64"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p><strong>Use Cases:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>         CONSERVATIVE 2PL - USE CASES                    
<a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a>
<a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a>                                                         
<a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a> Best for:                                               
<a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a>  Transactions with known, fixed resource set           
<a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a>  Batch processing (resources known in advance)         
<a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a>  Systems where deadlocks are unacceptable              
<a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a>  Real-time systems (predictable behavior)              
<a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a>                                                         
<a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a> Examples:                                               
<a id="__codelineno-125-12" name="__codelineno-125-12" href="#__codelineno-125-12"></a>  Batch reports (read all accounts)                     
<a id="__codelineno-125-13" name="__codelineno-125-13" href="#__codelineno-125-13"></a>  End-of-day processing                                 
<a id="__codelineno-125-14" name="__codelineno-125-14" href="#__codelineno-125-14"></a>  Scheduled maintenance tasks                           
<a id="__codelineno-125-15" name="__codelineno-125-15" href="#__codelineno-125-15"></a>  Data migration jobs                                   
<a id="__codelineno-125-16" name="__codelineno-125-16" href="#__codelineno-125-16"></a>                                                         
<a id="__codelineno-125-17" name="__codelineno-125-17" href="#__codelineno-125-17"></a> NOT suitable for:                                       
<a id="__codelineno-125-18" name="__codelineno-125-18" href="#__codelineno-125-18"></a>  Interactive transactions (resource set unknown)       
<a id="__codelineno-125-19" name="__codelineno-125-19" href="#__codelineno-125-19"></a>  Dynamic queries (joins, filters)                      
<a id="__codelineno-125-20" name="__codelineno-125-20" href="#__codelineno-125-20"></a>  Exploratory data analysis                             
<a id="__codelineno-125-21" name="__codelineno-125-21" href="#__codelineno-125-21"></a>  User-driven workflows                                 
<a id="__codelineno-125-22" name="__codelineno-125-22" href="#__codelineno-125-22"></a>                                                         
<a id="__codelineno-125-23" name="__codelineno-125-23" href="#__codelineno-125-23"></a>
</code></pre></div>
<p><strong>Pros and Cons:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a>
<a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a>      CONSERVATIVE 2PL - ADVANTAGES &amp; DISADVANTAGES      
<a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a>
<a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a>                                                         
<a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a> ADVANTAGES:                                             
<a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a>  Deadlock-free (no hold-and-wait)                     
<a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a>  Predictable execution                                
<a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a>  No deadlock detection needed                         
<a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a>  Simpler deadlock handling                            
<a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a>  Good for batch processing                            
<a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a>                                                         
<a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a> DISADVANTAGES:                                          
<a id="__codelineno-126-13" name="__codelineno-126-13" href="#__codelineno-126-13"></a>  Requires knowing all resources upfront               
<a id="__codelineno-126-14" name="__codelineno-126-14" href="#__codelineno-126-14"></a>  Not suitable for interactive transactions            
<a id="__codelineno-126-15" name="__codelineno-126-15" href="#__codelineno-126-15"></a>  Lower concurrency (all-or-nothing locking)           
<a id="__codelineno-126-16" name="__codelineno-126-16" href="#__codelineno-126-16"></a>  May lock more than needed                            
<a id="__codelineno-126-17" name="__codelineno-126-17" href="#__codelineno-126-17"></a>  Long initial wait time                               
<a id="__codelineno-126-18" name="__codelineno-126-18" href="#__codelineno-126-18"></a>  Resource declaration overhead                        
<a id="__codelineno-126-19" name="__codelineno-126-19" href="#__codelineno-126-19"></a>                                                         
<a id="__codelineno-126-20" name="__codelineno-126-20" href="#__codelineno-126-20"></a>
</code></pre></div>
<hr />
<h5 id="comparison-of-all-2pl-types">Comparison of All 2PL Types</h5>
<p><strong>Side-by-Side Comparison:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a>
<a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a>              COMPARISON OF ALL 2PL TYPES                                     
<a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a>
<a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a>                                                                              
<a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a> Feature          Basic 2PLStrict 2PLRigorous 2PLConservative 2PL       
<a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a>      
<a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a> Serializability                                                
<a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a> Cascading Aborts                                               
<a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a> Dirty Reads                                                    
<a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a> Deadlock-Free                                                  
<a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a> Concurrency        High     Medium      Low         Medium             
<a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a> Lock Hold Time     Short    Medium      Long        Long               
<a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a> Implementation    Complex   Medium     Simple       Complex            
<a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a> Recovery          Complex   Simple     Simple       Simple             
<a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a> Real-World Use     Rare     Common      Rare        Rare               
<a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a>                                                                              
<a id="__codelineno-127-17" name="__codelineno-127-17" href="#__codelineno-127-17"></a> WHEN LOCKS RELEASED:                                                         
<a id="__codelineno-127-18" name="__codelineno-127-18" href="#__codelineno-127-18"></a>                        
<a id="__codelineno-127-19" name="__codelineno-127-19" href="#__codelineno-127-19"></a> Shared locks      During    During    At commit    At commit           
<a id="__codelineno-127-20" name="__codelineno-127-20" href="#__codelineno-127-20"></a> Exclusive locks   During  At commit   At commit    At commit           
<a id="__codelineno-127-21" name="__codelineno-127-21" href="#__codelineno-127-21"></a>                                                                              
<a id="__codelineno-127-22" name="__codelineno-127-22" href="#__codelineno-127-22"></a> IDEAL FOR:                                                                   
<a id="__codelineno-127-23" name="__codelineno-127-23" href="#__codelineno-127-23"></a>                        
<a id="__codelineno-127-24" name="__codelineno-127-24" href="#__codelineno-127-24"></a> Basic 2PL         Maximum concurrency (theoretical)                        
<a id="__codelineno-127-25" name="__codelineno-127-25" href="#__codelineno-127-25"></a> Strict 2PL        Production databases (best balance)                    
<a id="__codelineno-127-26" name="__codelineno-127-26" href="#__codelineno-127-26"></a> Rigorous 2PL      Critical transactions (safety first)                     
<a id="__codelineno-127-27" name="__codelineno-127-27" href="#__codelineno-127-27"></a> Conservative 2PL  Batch jobs with known resources                          
<a id="__codelineno-127-28" name="__codelineno-127-28" href="#__codelineno-127-28"></a>                                                                              
<a id="__codelineno-127-29" name="__codelineno-127-29" href="#__codelineno-127-29"></a>
</code></pre></div>
<p><strong>Visual Comparison - Lock Timelines:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a>
<a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a>       LOCK TIMELINES - ALL 2PL TYPES                    
<a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a>
<a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>                                                         
<a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a> BASIC 2PL:                                              
<a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a>                                                 
<a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a>                                                       
<a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a>                                                 
<a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a>   BEGIN        COMMIT                                  
<a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a>         Release                                         
<a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a>         locks early                                     
<a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a>                                                         
<a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a> STRICT 2PL:                                             
<a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a>     (Exclusive)                         
<a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a>              (Shared)                            
<a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a>   BEGIN     COMMIT                                     
<a id="__codelineno-128-17" name="__codelineno-128-17" href="#__codelineno-128-17"></a>         Release                                         
<a id="__codelineno-128-18" name="__codelineno-128-18" href="#__codelineno-128-18"></a>         shared early                                    
<a id="__codelineno-128-19" name="__codelineno-128-19" href="#__codelineno-128-19"></a>                                                         
<a id="__codelineno-128-20" name="__codelineno-128-20" href="#__codelineno-128-20"></a> RIGOROUS 2PL:                                           
<a id="__codelineno-128-21" name="__codelineno-128-21" href="#__codelineno-128-21"></a>                                         
<a id="__codelineno-128-22" name="__codelineno-128-22" href="#__codelineno-128-22"></a>                   (All locks)                         
<a id="__codelineno-128-23" name="__codelineno-128-23" href="#__codelineno-128-23"></a>   BEGIN        COMMIT                                   
<a id="__codelineno-128-24" name="__codelineno-128-24" href="#__codelineno-128-24"></a>                                                         
<a id="__codelineno-128-25" name="__codelineno-128-25" href="#__codelineno-128-25"></a> CONSERVATIVE 2PL:                                       
<a id="__codelineno-128-26" name="__codelineno-128-26" href="#__codelineno-128-26"></a>                                         
<a id="__codelineno-128-27" name="__codelineno-128-27" href="#__codelineno-128-27"></a>    All acquired                                       
<a id="__codelineno-128-28" name="__codelineno-128-28" href="#__codelineno-128-28"></a>    immediately                                        
<a id="__codelineno-128-29" name="__codelineno-128-29" href="#__codelineno-128-29"></a>   BEGIN        COMMIT                                   
<a id="__codelineno-128-30" name="__codelineno-128-30" href="#__codelineno-128-30"></a>                                                         
<a id="__codelineno-128-31" name="__codelineno-128-31" href="#__codelineno-128-31"></a>
</code></pre></div>
<p><strong>Decision Matrix:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a>
<a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a>         WHICH 2PL TYPE TO USE?                          
<a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a>
<a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>                                                         
<a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a> Use STRICT 2PL when:                                    
<a id="__codelineno-129-6" name="__codelineno-129-6" href="#__codelineno-129-6"></a>  Building a general-purpose database                 
<a id="__codelineno-129-7" name="__codelineno-129-7" href="#__codelineno-129-7"></a>  Need good balance of safety and performance           
<a id="__codelineno-129-8" name="__codelineno-129-8" href="#__codelineno-129-8"></a>  Industry-standard behavior expected                   
<a id="__codelineno-129-9" name="__codelineno-129-9" href="#__codelineno-129-9"></a>  Most common choice (90% of cases)                     
<a id="__codelineno-129-10" name="__codelineno-129-10" href="#__codelineno-129-10"></a>                                                         
<a id="__codelineno-129-11" name="__codelineno-129-11" href="#__codelineno-129-11"></a> Use RIGOROUS 2PL when:                                  
<a id="__codelineno-129-12" name="__codelineno-129-12" href="#__codelineno-129-12"></a>  Absolute correctness is paramount                     
<a id="__codelineno-129-13" name="__codelineno-129-13" href="#__codelineno-129-13"></a>  Financial/legal compliance required                   
<a id="__codelineno-129-14" name="__codelineno-129-14" href="#__codelineno-129-14"></a>  Low contention workload                               
<a id="__codelineno-129-15" name="__codelineno-129-15" href="#__codelineno-129-15"></a>  Simplicity more important than performance            
<a id="__codelineno-129-16" name="__codelineno-129-16" href="#__codelineno-129-16"></a>                                                         
<a id="__codelineno-129-17" name="__codelineno-129-17" href="#__codelineno-129-17"></a> Use CONSERVATIVE 2PL when:                              
<a id="__codelineno-129-18" name="__codelineno-129-18" href="#__codelineno-129-18"></a>  Batch processing with known resources                 
<a id="__codelineno-129-19" name="__codelineno-129-19" href="#__codelineno-129-19"></a>  Deadlocks absolutely cannot occur                     
<a id="__codelineno-129-20" name="__codelineno-129-20" href="#__codelineno-129-20"></a>  Can declare all locks upfront                         
<a id="__codelineno-129-21" name="__codelineno-129-21" href="#__codelineno-129-21"></a>  Predictable execution required                        
<a id="__codelineno-129-22" name="__codelineno-129-22" href="#__codelineno-129-22"></a>                                                         
<a id="__codelineno-129-23" name="__codelineno-129-23" href="#__codelineno-129-23"></a> Use BASIC 2PL when:                                     
<a id="__codelineno-129-24" name="__codelineno-129-24" href="#__codelineno-129-24"></a>  Rarely! (Theoretical interest only)                   
<a id="__codelineno-129-25" name="__codelineno-129-25" href="#__codelineno-129-25"></a>  Research/academic settings                            
<a id="__codelineno-129-26" name="__codelineno-129-26" href="#__codelineno-129-26"></a>  Special cases with custom recovery                    
<a id="__codelineno-129-27" name="__codelineno-129-27" href="#__codelineno-129-27"></a>                                                         
<a id="__codelineno-129-28" name="__codelineno-129-28" href="#__codelineno-129-28"></a>
</code></pre></div>
<hr />
<h3 id="5-deadlock-problem-in-concurrency-control">5. Deadlock Problem in Concurrency Control</h3>
<p><strong>Description:</strong></p>
<p>A <strong>deadlock</strong> is a situation where two or more transactions are permanently blocked because each is waiting for resources held by the other. This creates a circular dependency where no transaction can proceed. Understanding deadlocks and their solutions is critical for building robust concurrent systems.</p>
<h4 id="51-deadlock-in-pessimistic-concurrency-control">5.1 Deadlock in Pessimistic Concurrency Control</h4>
<p><strong>Description:</strong></p>
<p>In <strong>pessimistic concurrency control</strong>, deadlocks occur when transactions acquire locks in different orders, creating a <strong>circular wait</strong> condition. This is one of the most common and serious problems with lock-based concurrency control.</p>
<p><strong>The Deadlock Paradox:</strong></p>
<p>Deadlocks represent one of the most frustrating ironies in computer systems: we introduce locks to ensure safety, but locks themselves create a new problem - <strong>mutual starvation</strong>. Two transactions, each trying to do the right thing (acquiring locks before accessing data), end up permanently blocking each other. Neither can proceed, neither will release resources, and without external intervention, they would wait forever.</p>
<p><strong>Historical Context:</strong></p>
<p>Deadlocks aren't unique to databases - they were first studied in operating systems in the 1960s when multiple processes competed for resources like printers, tape drives, and memory. The famous "Dining Philosophers Problem" (proposed by Edsger Dijkstra in 1965) elegantly illustrates deadlock: five philosophers sit at a round table, each needs two forks to eat, but there are only five forks total. If each picks up the fork to their left simultaneously, they deadlock.</p>
<p>E.W. Dijkstra's work on deadlocks led to the formulation of the four <strong>Coffman Conditions</strong> (named after Edward G. Coffman Jr., 1971) - the necessary and sufficient conditions for deadlock. Understanding these conditions is crucial because <strong>preventing deadlock means breaking at least one condition</strong>.</p>
<p><strong>Why Deadlocks are Particularly Problematic in Databases:</strong></p>
<ol>
<li>
<p><strong>Dynamic Resource Requests</strong>: Unlike operating systems where processes declare resources upfront, database transactions dynamically request locks based on query execution paths, making deadlocks harder to predict.</p>
</li>
<li>
<p><strong>High Concurrency</strong>: Modern databases handle thousands of concurrent transactions. With N transactions, there are potentially N lock conflicts, making deadlocks statistically likely.</p>
</li>
<li>
<p><strong>User-Facing Impact</strong>: A deadlock that aborts a transaction means:</p>
</li>
<li>User sees an error message</li>
<li>Application must retry (added latency)</li>
<li>Potential data loss if retry fails</li>
<li>
<p>Poor user experience</p>
</li>
<li>
<p><strong>Complex Lock Dependencies</strong>: Transactions may lock hundreds of rows across multiple tables, creating complex dependency graphs where cycles (deadlocks) can hide.</p>
</li>
</ol>
<p><strong>Real-World Deadlock Statistics:</strong></p>
<p>Studies of production database systems reveal:
- <strong>Frequency</strong>: Systems with high concurrency experience 1-5% deadlock rate
- <strong>Cost</strong>: Each deadlock wastes 10-100ms of work (rollback + retry)
- <strong>Cascading Effects</strong>: Deadlocks can trigger lock queue pile-ups affecting unrelated transactions
- <strong>Financial Impact</strong>: In high-frequency trading, a single deadlock can mean missing a market opportunity worth thousands</p>
<p><strong>The Detection Challenge:</strong></p>
<p>Detecting deadlocks isn't trivial. Databases typically use one of two approaches:</p>
<ol>
<li><strong>Wait-For Graph</strong> (used by PostgreSQL, Oracle):</li>
<li>Maintain graph: T1  T2 means T1 waits for lock held by T2</li>
<li>Periodically scan for cycles (expensive: O(N) for N transactions)</li>
<li>Cycle = deadlock detected</li>
<li>
<p>Trade-off: Detection overhead vs. detection latency</p>
</li>
<li>
<p><strong>Timeout-Based</strong> (used by MySQL InnoDB):</p>
</li>
<li>If lock wait exceeds threshold (e.g., 50 seconds), assume deadlock</li>
<li>Simpler but can false-positive (slow transaction  deadlock)</li>
<li>Trade-off: Simplicity vs. accuracy</li>
</ol>
<p><strong>Victim Selection - Who Gets Aborted?</strong></p>
<p>When a deadlock is detected, one transaction must be chosen as the <strong>victim</strong> and aborted. Databases use sophisticated algorithms:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a>Victim Selection Criteria (weighted):
<a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a>1. Transaction age (prefer aborting younger transactions)
<a id="__codelineno-130-3" name="__codelineno-130-3" href="#__codelineno-130-3"></a>2. Number of locks held (prefer aborting those with fewer locks)
<a id="__codelineno-130-4" name="__codelineno-130-4" href="#__codelineno-130-4"></a>3. Amount of work done (prefer aborting those that did less)
<a id="__codelineno-130-5" name="__codelineno-130-5" href="#__codelineno-130-5"></a>4. Number of previous aborts (fairness - avoid starvation)
<a id="__codelineno-130-6" name="__codelineno-130-6" href="#__codelineno-130-6"></a>5. Transaction priority (user-specified, if available)
</code></pre></div>
<p>Poor victim selection can lead to <strong>cascading rollbacks</strong> where aborting one transaction forces others to abort.</p>
<p><strong>Real-World Impact Story:</strong></p>
<p>In 2018, a major e-commerce platform experienced a deadlock storm during Black Friday:
- High traffic triggered thousands of concurrent checkout transactions
- Each transaction locked: cart items, inventory, user profile, payment record
- Lock acquisition order varied based on cart contents (not sorted)
- Result: 30% of transactions deadlocked, had to retry
- Impact: $500K in lost sales (customers abandoned carts after errors)
- Fix: Implemented strict lock ordering by primary key</p>
<p>This illustrates why deadlock prevention isn't just academic - it has real business impact.</p>
<p><strong>What is Deadlock:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a>
<a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a>                 DEADLOCK DEFINITION                     
<a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a>
<a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a>                                                         
<a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a>  A deadlock occurs when:                                
<a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a>                                                         
<a id="__codelineno-131-7" name="__codelineno-131-7" href="#__codelineno-131-7"></a>          
<a id="__codelineno-131-8" name="__codelineno-131-8" href="#__codelineno-131-8"></a>   1. T1 holds Lock A, waits for Lock B               
<a id="__codelineno-131-9" name="__codelineno-131-9" href="#__codelineno-131-9"></a>   2. T2 holds Lock B, waits for Lock A               
<a id="__codelineno-131-10" name="__codelineno-131-10" href="#__codelineno-131-10"></a>                                                      
<a id="__codelineno-131-11" name="__codelineno-131-11" href="#__codelineno-131-11"></a>   Result: CIRCULAR WAIT                              
<a id="__codelineno-131-12" name="__codelineno-131-12" href="#__codelineno-131-12"></a>           Both transactions BLOCKED forever          
<a id="__codelineno-131-13" name="__codelineno-131-13" href="#__codelineno-131-13"></a>          
<a id="__codelineno-131-14" name="__codelineno-131-14" href="#__codelineno-131-14"></a>                                                         
<a id="__codelineno-131-15" name="__codelineno-131-15" href="#__codelineno-131-15"></a>  Without intervention, neither can proceed!             
<a id="__codelineno-131-16" name="__codelineno-131-16" href="#__codelineno-131-16"></a>                                                         
<a id="__codelineno-131-17" name="__codelineno-131-17" href="#__codelineno-131-17"></a>
</code></pre></div>
<p><strong>Deadlock Scenario - Visual Diagram:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a>
<a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a>          CLASSIC DEADLOCK SCENARIO                      
<a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a>
<a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a>                                                         
<a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a>  Time    T1                    T2                       
<a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a>         
<a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a>  t1      BEGIN                                          
<a id="__codelineno-132-8" name="__codelineno-132-8" href="#__codelineno-132-8"></a>  t2                            BEGIN                    
<a id="__codelineno-132-9" name="__codelineno-132-9" href="#__codelineno-132-9"></a>  t3      LOCK(A)                                       
<a id="__codelineno-132-10" name="__codelineno-132-10" href="#__codelineno-132-10"></a>          [A locked by T1]                             
<a id="__codelineno-132-11" name="__codelineno-132-11" href="#__codelineno-132-11"></a>  t4                            LOCK(B)                 
<a id="__codelineno-132-12" name="__codelineno-132-12" href="#__codelineno-132-12"></a>                                [B locked by T2]       
<a id="__codelineno-132-13" name="__codelineno-132-13" href="#__codelineno-132-13"></a>  t5      LOCK(B)  WAIT                                
<a id="__codelineno-132-14" name="__codelineno-132-14" href="#__codelineno-132-14"></a>          [T1 waiting for B...]                          
<a id="__codelineno-132-15" name="__codelineno-132-15" href="#__codelineno-132-15"></a>  t6                            LOCK(A)  WAIT          
<a id="__codelineno-132-16" name="__codelineno-132-16" href="#__codelineno-132-16"></a>                                [T2 waiting for A...]    
<a id="__codelineno-132-17" name="__codelineno-132-17" href="#__codelineno-132-17"></a>  t7      [STILL WAITING]                              
<a id="__codelineno-132-18" name="__codelineno-132-18" href="#__codelineno-132-18"></a>  t8                            [STILL WAITING]        
<a id="__codelineno-132-19" name="__codelineno-132-19" href="#__codelineno-132-19"></a>  t9       DEADLOCK DETECTED                         
<a id="__codelineno-132-20" name="__codelineno-132-20" href="#__codelineno-132-20"></a>                                                         
<a id="__codelineno-132-21" name="__codelineno-132-21" href="#__codelineno-132-21"></a>  Circular Dependency:                                   
<a id="__codelineno-132-22" name="__codelineno-132-22" href="#__codelineno-132-22"></a>                
<a id="__codelineno-132-23" name="__codelineno-132-23" href="#__codelineno-132-23"></a>    T1  waits for  B (held by T2)                   
<a id="__codelineno-132-24" name="__codelineno-132-24" href="#__codelineno-132-24"></a>                                                    
<a id="__codelineno-132-25" name="__codelineno-132-25" href="#__codelineno-132-25"></a>                                                    
<a id="__codelineno-132-26" name="__codelineno-132-26" href="#__codelineno-132-26"></a>      held by T1  A                     
<a id="__codelineno-132-27" name="__codelineno-132-27" href="#__codelineno-132-27"></a>                                                      
<a id="__codelineno-132-28" name="__codelineno-132-28" href="#__codelineno-132-28"></a>    CYCLE = DEADLOCK!                                 
<a id="__codelineno-132-29" name="__codelineno-132-29" href="#__codelineno-132-29"></a>                
<a id="__codelineno-132-30" name="__codelineno-132-30" href="#__codelineno-132-30"></a>                                                         
<a id="__codelineno-132-31" name="__codelineno-132-31" href="#__codelineno-132-31"></a>
</code></pre></div>
<p><strong>Resource Allocation Graph:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a>
<a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a>        DEADLOCK - RESOURCE ALLOCATION GRAPH             
<a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a>
<a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a>                                                         
<a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a>  Transactions: T1, T2                                   
<a id="__codelineno-133-6" name="__codelineno-133-6" href="#__codelineno-133-6"></a>  Resources: Row A, Row B                                
<a id="__codelineno-133-7" name="__codelineno-133-7" href="#__codelineno-133-7"></a>                                                         
<a id="__codelineno-133-8" name="__codelineno-133-8" href="#__codelineno-133-8"></a>                                                
<a id="__codelineno-133-9" name="__codelineno-133-9" href="#__codelineno-133-9"></a>              Row A                      
<a id="__codelineno-133-10" name="__codelineno-133-10" href="#__codelineno-133-10"></a>                                              
<a id="__codelineno-133-11" name="__codelineno-133-11" href="#__codelineno-133-11"></a>                                                       
<a id="__codelineno-133-12" name="__codelineno-133-12" href="#__codelineno-133-12"></a>         Request                 Holds                   
<a id="__codelineno-133-13" name="__codelineno-133-13" href="#__codelineno-133-13"></a>                                                       
<a id="__codelineno-133-14" name="__codelineno-133-14" href="#__codelineno-133-14"></a>                                      
<a id="__codelineno-133-15" name="__codelineno-133-15" href="#__codelineno-133-15"></a>           T1                  T2                   
<a id="__codelineno-133-16" name="__codelineno-133-16" href="#__codelineno-133-16"></a>                                      
<a id="__codelineno-133-17" name="__codelineno-133-17" href="#__codelineno-133-17"></a>                                                       
<a id="__codelineno-133-18" name="__codelineno-133-18" href="#__codelineno-133-18"></a>           Holds                Request                  
<a id="__codelineno-133-19" name="__codelineno-133-19" href="#__codelineno-133-19"></a>                                                       
<a id="__codelineno-133-20" name="__codelineno-133-20" href="#__codelineno-133-20"></a>                                                       
<a id="__codelineno-133-21" name="__codelineno-133-21" href="#__codelineno-133-21"></a>                                      
<a id="__codelineno-133-22" name="__codelineno-133-22" href="#__codelineno-133-22"></a>          Row B  Row B                 
<a id="__codelineno-133-23" name="__codelineno-133-23" href="#__codelineno-133-23"></a>                                      
<a id="__codelineno-133-24" name="__codelineno-133-24" href="#__codelineno-133-24"></a>                                                         
<a id="__codelineno-133-25" name="__codelineno-133-25" href="#__codelineno-133-25"></a>  Cycle detected: T1  A  T2  B  T1                  
<a id="__codelineno-133-26" name="__codelineno-133-26" href="#__codelineno-133-26"></a>                  (DEADLOCK!)                            
<a id="__codelineno-133-27" name="__codelineno-133-27" href="#__codelineno-133-27"></a>                                                         
<a id="__codelineno-133-28" name="__codelineno-133-28" href="#__codelineno-133-28"></a>
</code></pre></div>
<p><strong>Detailed Timeline Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a>Banking Transfer Deadlock:
<a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a>
<a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a>T1: Transfer $100 from Account A to Account B
<a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a>T2: Transfer $200 from Account B to Account A
<a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a>
<a id="__codelineno-134-6" name="__codelineno-134-6" href="#__codelineno-134-6"></a>Time  T1 Actions                 T2 Actions              State
<a id="__codelineno-134-7" name="__codelineno-134-7" href="#__codelineno-134-7"></a>
<a id="__codelineno-134-8" name="__codelineno-134-8" href="#__codelineno-134-8"></a>t1    BEGIN                                               -
<a id="__codelineno-134-9" name="__codelineno-134-9" href="#__codelineno-134-9"></a>t2                                BEGIN                   -
<a id="__codelineno-134-10" name="__codelineno-134-10" href="#__codelineno-134-10"></a>t3    SELECT ... FROM A                                   
<a id="__codelineno-134-11" name="__codelineno-134-11" href="#__codelineno-134-11"></a>      FOR UPDATE                                          
<a id="__codelineno-134-12" name="__codelineno-134-12" href="#__codelineno-134-12"></a>       LOCK(A) acquired                               A: locked by T1
<a id="__codelineno-134-13" name="__codelineno-134-13" href="#__codelineno-134-13"></a>t4                                SELECT ... FROM B       
<a id="__codelineno-134-14" name="__codelineno-134-14" href="#__codelineno-134-14"></a>                                  FOR UPDATE             
<a id="__codelineno-134-15" name="__codelineno-134-15" href="#__codelineno-134-15"></a>                                   LOCK(B) acquired   B: locked by T2
<a id="__codelineno-134-16" name="__codelineno-134-16" href="#__codelineno-134-16"></a>t5    SELECT ... FROM B                                   
<a id="__codelineno-134-17" name="__codelineno-134-17" href="#__codelineno-134-17"></a>      FOR UPDATE                                          
<a id="__codelineno-134-18" name="__codelineno-134-18" href="#__codelineno-134-18"></a>       Waits for T2 to release B                      T1: WAITING
<a id="__codelineno-134-19" name="__codelineno-134-19" href="#__codelineno-134-19"></a>t6                                SELECT ... FROM A       
<a id="__codelineno-134-20" name="__codelineno-134-20" href="#__codelineno-134-20"></a>                                  FOR UPDATE             
<a id="__codelineno-134-21" name="__codelineno-134-21" href="#__codelineno-134-21"></a>                                   Waits for T1 to       T2: WAITING
<a id="__codelineno-134-22" name="__codelineno-134-22" href="#__codelineno-134-22"></a>                                    release A           
<a id="__codelineno-134-23" name="__codelineno-134-23" href="#__codelineno-134-23"></a>t7    [Waiting for B...]          [Waiting for A...]     DEADLOCK! 
<a id="__codelineno-134-24" name="__codelineno-134-24" href="#__codelineno-134-24"></a>t8    Database detects cycle                             
<a id="__codelineno-134-25" name="__codelineno-134-25" href="#__codelineno-134-25"></a>t9    T1 ABORTED (victim)         [Released, continues]  T2 succeeds
<a id="__codelineno-134-26" name="__codelineno-134-26" href="#__codelineno-134-26"></a>t10   T1 receives error                                  T1 must retry
<a id="__codelineno-134-27" name="__codelineno-134-27" href="#__codelineno-134-27"></a>      &quot;Deadlock detected&quot;
</code></pre></div>
<p><strong>Four Conditions for Deadlock (Coffman Conditions):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a>
<a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a>         FOUR CONDITIONS FOR DEADLOCK                    
<a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a>
<a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a>                                                         
<a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a> ALL four must be present simultaneously:                
<a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a>                                                         
<a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a> 1. MUTUAL EXCLUSION                                     
<a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a>                
<a id="__codelineno-135-9" name="__codelineno-135-9" href="#__codelineno-135-9"></a>     Resource can be held by only ONE                 
<a id="__codelineno-135-10" name="__codelineno-135-10" href="#__codelineno-135-10"></a>     transaction at a time                            
<a id="__codelineno-135-11" name="__codelineno-135-11" href="#__codelineno-135-11"></a>     (Exclusive locks)                                
<a id="__codelineno-135-12" name="__codelineno-135-12" href="#__codelineno-135-12"></a>                
<a id="__codelineno-135-13" name="__codelineno-135-13" href="#__codelineno-135-13"></a>                                                         
<a id="__codelineno-135-14" name="__codelineno-135-14" href="#__codelineno-135-14"></a> 2. HOLD AND WAIT                                        
<a id="__codelineno-135-15" name="__codelineno-135-15" href="#__codelineno-135-15"></a>                
<a id="__codelineno-135-16" name="__codelineno-135-16" href="#__codelineno-135-16"></a>     Transaction holds resources while                
<a id="__codelineno-135-17" name="__codelineno-135-17" href="#__codelineno-135-17"></a>     waiting to acquire more                          
<a id="__codelineno-135-18" name="__codelineno-135-18" href="#__codelineno-135-18"></a>     (T1 holds A, waits for B)                        
<a id="__codelineno-135-19" name="__codelineno-135-19" href="#__codelineno-135-19"></a>                
<a id="__codelineno-135-20" name="__codelineno-135-20" href="#__codelineno-135-20"></a>                                                         
<a id="__codelineno-135-21" name="__codelineno-135-21" href="#__codelineno-135-21"></a> 3. NO PREEMPTION                                        
<a id="__codelineno-135-22" name="__codelineno-135-22" href="#__codelineno-135-22"></a>                
<a id="__codelineno-135-23" name="__codelineno-135-23" href="#__codelineno-135-23"></a>     Resources cannot be forcibly taken               
<a id="__codelineno-135-24" name="__codelineno-135-24" href="#__codelineno-135-24"></a>     from a transaction                               
<a id="__codelineno-135-25" name="__codelineno-135-25" href="#__codelineno-135-25"></a>     (Locks held until commit/rollback)               
<a id="__codelineno-135-26" name="__codelineno-135-26" href="#__codelineno-135-26"></a>                
<a id="__codelineno-135-27" name="__codelineno-135-27" href="#__codelineno-135-27"></a>                                                         
<a id="__codelineno-135-28" name="__codelineno-135-28" href="#__codelineno-135-28"></a> 4. CIRCULAR WAIT                                        
<a id="__codelineno-135-29" name="__codelineno-135-29" href="#__codelineno-135-29"></a>                
<a id="__codelineno-135-30" name="__codelineno-135-30" href="#__codelineno-135-30"></a>     Circular chain of transactions                   
<a id="__codelineno-135-31" name="__codelineno-135-31" href="#__codelineno-135-31"></a>     each waiting for resource held                   
<a id="__codelineno-135-32" name="__codelineno-135-32" href="#__codelineno-135-32"></a>     by the next                                      
<a id="__codelineno-135-33" name="__codelineno-135-33" href="#__codelineno-135-33"></a>     (T1AT2BT1)                                   
<a id="__codelineno-135-34" name="__codelineno-135-34" href="#__codelineno-135-34"></a>                
<a id="__codelineno-135-35" name="__codelineno-135-35" href="#__codelineno-135-35"></a>                                                         
<a id="__codelineno-135-36" name="__codelineno-135-36" href="#__codelineno-135-36"></a> Break ANY one condition  Prevent deadlock              
<a id="__codelineno-135-37" name="__codelineno-135-37" href="#__codelineno-135-37"></a>                                                         
<a id="__codelineno-135-38" name="__codelineno-135-38" href="#__codelineno-135-38"></a>
</code></pre></div>
<p><strong>Pseudo Code - Deadlock Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="c1"># Example: Classic Deadlock Scenario</span>
<a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a>
<a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">transaction_1</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer from Account A to Account B&quot;&quot;&quot;</span>
<a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a>
<a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1: Acquiring lock on Account A&quot;</span><span class="p">)</span>
<a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a>    <span class="c1"># Step 1: Lock Account A</span>
<a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a>    <span class="n">balance_a</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-136-10" name="__codelineno-136-10" href="#__codelineno-136-10"></a><span class="s2">        SELECT balance FROM accounts WHERE id = &#39;A&#39; FOR UPDATE</span>
<a id="__codelineno-136-11" name="__codelineno-136-11" href="#__codelineno-136-11"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-136-12" name="__codelineno-136-12" href="#__codelineno-136-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1:  Locked Account A&quot;</span><span class="p">)</span>
<a id="__codelineno-136-13" name="__codelineno-136-13" href="#__codelineno-136-13"></a>
<a id="__codelineno-136-14" name="__codelineno-136-14" href="#__codelineno-136-14"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate some processing</span>
<a id="__codelineno-136-15" name="__codelineno-136-15" href="#__codelineno-136-15"></a>
<a id="__codelineno-136-16" name="__codelineno-136-16" href="#__codelineno-136-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1: Acquiring lock on Account B&quot;</span><span class="p">)</span>
<a id="__codelineno-136-17" name="__codelineno-136-17" href="#__codelineno-136-17"></a>    <span class="c1"># Step 2: Try to lock Account B (T2 might have it!)</span>
<a id="__codelineno-136-18" name="__codelineno-136-18" href="#__codelineno-136-18"></a>    <span class="n">balance_b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-136-19" name="__codelineno-136-19" href="#__codelineno-136-19"></a><span class="s2">        SELECT balance FROM accounts WHERE id = &#39;B&#39; FOR UPDATE</span>
<a id="__codelineno-136-20" name="__codelineno-136-20" href="#__codelineno-136-20"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-136-21" name="__codelineno-136-21" href="#__codelineno-136-21"></a>    <span class="c1">#  DEADLOCK! If T2 holds B and waits for A</span>
<a id="__codelineno-136-22" name="__codelineno-136-22" href="#__codelineno-136-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1:  Locked Account B&quot;</span><span class="p">)</span>
<a id="__codelineno-136-23" name="__codelineno-136-23" href="#__codelineno-136-23"></a>
<a id="__codelineno-136-24" name="__codelineno-136-24" href="#__codelineno-136-24"></a>    <span class="c1"># Transfer</span>
<a id="__codelineno-136-25" name="__codelineno-136-25" href="#__codelineno-136-25"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = balance - 100 WHERE id = &#39;A&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-136-26" name="__codelineno-136-26" href="#__codelineno-136-26"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = balance + 100 WHERE id = &#39;B&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-136-27" name="__codelineno-136-27" href="#__codelineno-136-27"></a>
<a id="__codelineno-136-28" name="__codelineno-136-28" href="#__codelineno-136-28"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-136-29" name="__codelineno-136-29" href="#__codelineno-136-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T1: Committed&quot;</span><span class="p">)</span>
<a id="__codelineno-136-30" name="__codelineno-136-30" href="#__codelineno-136-30"></a>
<a id="__codelineno-136-31" name="__codelineno-136-31" href="#__codelineno-136-31"></a>
<a id="__codelineno-136-32" name="__codelineno-136-32" href="#__codelineno-136-32"></a><span class="k">def</span><span class="w"> </span><span class="nf">transaction_2</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<a id="__codelineno-136-33" name="__codelineno-136-33" href="#__codelineno-136-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer from Account B to Account A (opposite order!)&quot;&quot;&quot;</span>
<a id="__codelineno-136-34" name="__codelineno-136-34" href="#__codelineno-136-34"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-136-35" name="__codelineno-136-35" href="#__codelineno-136-35"></a>
<a id="__codelineno-136-36" name="__codelineno-136-36" href="#__codelineno-136-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2: Acquiring lock on Account B&quot;</span><span class="p">)</span>
<a id="__codelineno-136-37" name="__codelineno-136-37" href="#__codelineno-136-37"></a>    <span class="c1"># Step 1: Lock Account B</span>
<a id="__codelineno-136-38" name="__codelineno-136-38" href="#__codelineno-136-38"></a>    <span class="n">balance_b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-136-39" name="__codelineno-136-39" href="#__codelineno-136-39"></a><span class="s2">        SELECT balance FROM accounts WHERE id = &#39;B&#39; FOR UPDATE</span>
<a id="__codelineno-136-40" name="__codelineno-136-40" href="#__codelineno-136-40"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-136-41" name="__codelineno-136-41" href="#__codelineno-136-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2:  Locked Account B&quot;</span><span class="p">)</span>
<a id="__codelineno-136-42" name="__codelineno-136-42" href="#__codelineno-136-42"></a>
<a id="__codelineno-136-43" name="__codelineno-136-43" href="#__codelineno-136-43"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate some processing</span>
<a id="__codelineno-136-44" name="__codelineno-136-44" href="#__codelineno-136-44"></a>
<a id="__codelineno-136-45" name="__codelineno-136-45" href="#__codelineno-136-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2: Acquiring lock on Account A&quot;</span><span class="p">)</span>
<a id="__codelineno-136-46" name="__codelineno-136-46" href="#__codelineno-136-46"></a>    <span class="c1"># Step 2: Try to lock Account A (T1 might have it!)</span>
<a id="__codelineno-136-47" name="__codelineno-136-47" href="#__codelineno-136-47"></a>    <span class="n">balance_a</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-136-48" name="__codelineno-136-48" href="#__codelineno-136-48"></a><span class="s2">        SELECT balance FROM accounts WHERE id = &#39;A&#39; FOR UPDATE</span>
<a id="__codelineno-136-49" name="__codelineno-136-49" href="#__codelineno-136-49"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-136-50" name="__codelineno-136-50" href="#__codelineno-136-50"></a>    <span class="c1">#  DEADLOCK! If T1 holds A and waits for B</span>
<a id="__codelineno-136-51" name="__codelineno-136-51" href="#__codelineno-136-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2:  Locked Account A&quot;</span><span class="p">)</span>
<a id="__codelineno-136-52" name="__codelineno-136-52" href="#__codelineno-136-52"></a>
<a id="__codelineno-136-53" name="__codelineno-136-53" href="#__codelineno-136-53"></a>    <span class="c1"># Transfer</span>
<a id="__codelineno-136-54" name="__codelineno-136-54" href="#__codelineno-136-54"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = balance - 200 WHERE id = &#39;B&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-136-55" name="__codelineno-136-55" href="#__codelineno-136-55"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = balance + 200 WHERE id = &#39;A&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-136-56" name="__codelineno-136-56" href="#__codelineno-136-56"></a>
<a id="__codelineno-136-57" name="__codelineno-136-57" href="#__codelineno-136-57"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-136-58" name="__codelineno-136-58" href="#__codelineno-136-58"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T2: Committed&quot;</span><span class="p">)</span>
<a id="__codelineno-136-59" name="__codelineno-136-59" href="#__codelineno-136-59"></a>
<a id="__codelineno-136-60" name="__codelineno-136-60" href="#__codelineno-136-60"></a><span class="c1"># Running both concurrently  DEADLOCK!</span>
</code></pre></div>
<hr />
<p><strong>Deadlock Solutions for Pessimistic Control:</strong></p>
<p><strong>Solution 1: Lock Ordering (Prevention)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a>
<a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a>         SOLUTION 1: LOCK ORDERING (Prevention)          
<a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a>
<a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a>                                                         
<a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a> Strategy: Always acquire locks in the SAME ORDER        
<a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a>                                                         
<a id="__codelineno-137-7" name="__codelineno-137-7" href="#__codelineno-137-7"></a> Rule: Lock resources in ascending order (A before B)    
<a id="__codelineno-137-8" name="__codelineno-137-8" href="#__codelineno-137-8"></a>                                                         
<a id="__codelineno-137-9" name="__codelineno-137-9" href="#__codelineno-137-9"></a> Before (Deadlock):                                      
<a id="__codelineno-137-10" name="__codelineno-137-10" href="#__codelineno-137-10"></a>            
<a id="__codelineno-137-11" name="__codelineno-137-11" href="#__codelineno-137-11"></a>  T1: Lock A  Lock B                                 
<a id="__codelineno-137-12" name="__codelineno-137-12" href="#__codelineno-137-12"></a>  T2: Lock B  Lock A   (opposite order)            
<a id="__codelineno-137-13" name="__codelineno-137-13" href="#__codelineno-137-13"></a>  Result: DEADLOCK                                    
<a id="__codelineno-137-14" name="__codelineno-137-14" href="#__codelineno-137-14"></a>            
<a id="__codelineno-137-15" name="__codelineno-137-15" href="#__codelineno-137-15"></a>                                                         
<a id="__codelineno-137-16" name="__codelineno-137-16" href="#__codelineno-137-16"></a> After (No Deadlock):                                    
<a id="__codelineno-137-17" name="__codelineno-137-17" href="#__codelineno-137-17"></a>            
<a id="__codelineno-137-18" name="__codelineno-137-18" href="#__codelineno-137-18"></a>  T1: Lock A  Lock B                                 
<a id="__codelineno-137-19" name="__codelineno-137-19" href="#__codelineno-137-19"></a>  T2: Lock A  Lock B   (same order)                
<a id="__codelineno-137-20" name="__codelineno-137-20" href="#__codelineno-137-20"></a>  Result: T2 waits for T1, NO DEADLOCK               
<a id="__codelineno-137-21" name="__codelineno-137-21" href="#__codelineno-137-21"></a>            
<a id="__codelineno-137-22" name="__codelineno-137-22" href="#__codelineno-137-22"></a>                                                         
<a id="__codelineno-137-23" name="__codelineno-137-23" href="#__codelineno-137-23"></a> Timeline:                                               
<a id="__codelineno-137-24" name="__codelineno-137-24" href="#__codelineno-137-24"></a> t1: T1 locks A                                          
<a id="__codelineno-137-25" name="__codelineno-137-25" href="#__codelineno-137-25"></a> t2: T2 tries to lock A  WAITS (T1 holds it)           
<a id="__codelineno-137-26" name="__codelineno-137-26" href="#__codelineno-137-26"></a> t3: T1 locks B                                          
<a id="__codelineno-137-27" name="__codelineno-137-27" href="#__codelineno-137-27"></a> t4: T1 commits, releases A and B                        
<a id="__codelineno-137-28" name="__codelineno-137-28" href="#__codelineno-137-28"></a> t5: T2 acquires A (unblocked)                           
<a id="__codelineno-137-29" name="__codelineno-137-29" href="#__codelineno-137-29"></a> t6: T2 locks B                                          
<a id="__codelineno-137-30" name="__codelineno-137-30" href="#__codelineno-137-30"></a> t7: T2 commits                                          
<a id="__codelineno-137-31" name="__codelineno-137-31" href="#__codelineno-137-31"></a>                                                         
<a id="__codelineno-137-32" name="__codelineno-137-32" href="#__codelineno-137-32"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_with_lock_ordering</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prevent deadlock by locking accounts in consistent order&quot;&quot;&quot;</span>
<a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a>
<a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a>    <span class="c1"># ALWAYS lock in ascending order (breaks circular wait!)</span>
<a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a>    <span class="n">accounts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a>
<a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a>    <span class="c1"># Lock first account</span>
<a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a><span class="s2">        SELECT balance FROM accounts </span>
<a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a><span class="s2">        WHERE id = ? </span>
<a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a><span class="s2">        FOR UPDATE</span>
<a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-138-14" name="__codelineno-138-14" href="#__codelineno-138-14"></a>
<a id="__codelineno-138-15" name="__codelineno-138-15" href="#__codelineno-138-15"></a>    <span class="c1"># Lock second account</span>
<a id="__codelineno-138-16" name="__codelineno-138-16" href="#__codelineno-138-16"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-138-17" name="__codelineno-138-17" href="#__codelineno-138-17"></a><span class="s2">        SELECT balance FROM accounts </span>
<a id="__codelineno-138-18" name="__codelineno-138-18" href="#__codelineno-138-18"></a><span class="s2">        WHERE id = ? </span>
<a id="__codelineno-138-19" name="__codelineno-138-19" href="#__codelineno-138-19"></a><span class="s2">        FOR UPDATE</span>
<a id="__codelineno-138-20" name="__codelineno-138-20" href="#__codelineno-138-20"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">accounts</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-138-21" name="__codelineno-138-21" href="#__codelineno-138-21"></a>
<a id="__codelineno-138-22" name="__codelineno-138-22" href="#__codelineno-138-22"></a>    <span class="c1"># Now both accounts locked in consistent order</span>
<a id="__codelineno-138-23" name="__codelineno-138-23" href="#__codelineno-138-23"></a>    <span class="c1"># No deadlock possible!</span>
<a id="__codelineno-138-24" name="__codelineno-138-24" href="#__codelineno-138-24"></a>
<a id="__codelineno-138-25" name="__codelineno-138-25" href="#__codelineno-138-25"></a>    <span class="c1"># Perform transfer</span>
<a id="__codelineno-138-26" name="__codelineno-138-26" href="#__codelineno-138-26"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-138-27" name="__codelineno-138-27" href="#__codelineno-138-27"></a><span class="s2">        UPDATE accounts SET balance = balance - ?</span>
<a id="__codelineno-138-28" name="__codelineno-138-28" href="#__codelineno-138-28"></a><span class="s2">        WHERE id = ?</span>
<a id="__codelineno-138-29" name="__codelineno-138-29" href="#__codelineno-138-29"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-138-30" name="__codelineno-138-30" href="#__codelineno-138-30"></a>
<a id="__codelineno-138-31" name="__codelineno-138-31" href="#__codelineno-138-31"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-138-32" name="__codelineno-138-32" href="#__codelineno-138-32"></a><span class="s2">        UPDATE accounts SET balance = balance + ?</span>
<a id="__codelineno-138-33" name="__codelineno-138-33" href="#__codelineno-138-33"></a><span class="s2">        WHERE id = ?</span>
<a id="__codelineno-138-34" name="__codelineno-138-34" href="#__codelineno-138-34"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-138-35" name="__codelineno-138-35" href="#__codelineno-138-35"></a>
<a id="__codelineno-138-36" name="__codelineno-138-36" href="#__codelineno-138-36"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-138-37" name="__codelineno-138-37" href="#__codelineno-138-37"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<hr />
<p><strong>Solution 2: Deadlock Detection &amp; Recovery</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a>
<a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a>    SOLUTION 2: DEADLOCK DETECTION (Detection &amp; Abort)   
<a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a>
<a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a>                                                         
<a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a> Strategy: Let deadlocks happen, DETECT and RESOLVE      
<a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a>                                                         
<a id="__codelineno-139-7" name="__codelineno-139-7" href="#__codelineno-139-7"></a> How it works:                                           
<a id="__codelineno-139-8" name="__codelineno-139-8" href="#__codelineno-139-8"></a>            
<a id="__codelineno-139-9" name="__codelineno-139-9" href="#__codelineno-139-9"></a>  1. Database maintains wait-for graph                
<a id="__codelineno-139-10" name="__codelineno-139-10" href="#__codelineno-139-10"></a>  2. Periodically check for cycles                    
<a id="__codelineno-139-11" name="__codelineno-139-11" href="#__codelineno-139-11"></a>  3. If cycle detected  DEADLOCK                     
<a id="__codelineno-139-12" name="__codelineno-139-12" href="#__codelineno-139-12"></a>  4. Choose victim transaction                        
<a id="__codelineno-139-13" name="__codelineno-139-13" href="#__codelineno-139-13"></a>  5. Abort victim, release its locks                  
<a id="__codelineno-139-14" name="__codelineno-139-14" href="#__codelineno-139-14"></a>  6. Other transactions proceed                        
<a id="__codelineno-139-15" name="__codelineno-139-15" href="#__codelineno-139-15"></a>            
<a id="__codelineno-139-16" name="__codelineno-139-16" href="#__codelineno-139-16"></a>                                                         
<a id="__codelineno-139-17" name="__codelineno-139-17" href="#__codelineno-139-17"></a> Wait-For Graph:                                         
<a id="__codelineno-139-18" name="__codelineno-139-18" href="#__codelineno-139-18"></a>                                                         
<a id="__codelineno-139-19" name="__codelineno-139-19" href="#__codelineno-139-19"></a>   Before detection:                                     
<a id="__codelineno-139-20" name="__codelineno-139-20" href="#__codelineno-139-20"></a>    waits                                 
<a id="__codelineno-139-21" name="__codelineno-139-21" href="#__codelineno-139-21"></a>    T1   T2                                 
<a id="__codelineno-139-22" name="__codelineno-139-22" href="#__codelineno-139-22"></a>                                          
<a id="__codelineno-139-23" name="__codelineno-139-23" href="#__codelineno-139-23"></a>                                                       
<a id="__codelineno-139-24" name="__codelineno-139-24" href="#__codelineno-139-24"></a>                     waits                             
<a id="__codelineno-139-25" name="__codelineno-139-25" href="#__codelineno-139-25"></a>                                                       
<a id="__codelineno-139-26" name="__codelineno-139-26" href="#__codelineno-139-26"></a>                                                 
<a id="__codelineno-139-27" name="__codelineno-139-27" href="#__codelineno-139-27"></a>       T3                                  
<a id="__codelineno-139-28" name="__codelineno-139-28" href="#__codelineno-139-28"></a>        waits                                     
<a id="__codelineno-139-29" name="__codelineno-139-29" href="#__codelineno-139-29"></a>                                                         
<a id="__codelineno-139-30" name="__codelineno-139-30" href="#__codelineno-139-30"></a>   Cycle: T1  T2  T3  T1 (DEADLOCK!)                 
<a id="__codelineno-139-31" name="__codelineno-139-31" href="#__codelineno-139-31"></a>                                                         
<a id="__codelineno-139-32" name="__codelineno-139-32" href="#__codelineno-139-32"></a>   After detection:                                      
<a id="__codelineno-139-33" name="__codelineno-139-33" href="#__codelineno-139-33"></a>   - Abort T1 (victim chosen by cost)                    
<a id="__codelineno-139-34" name="__codelineno-139-34" href="#__codelineno-139-34"></a>   - T2 and T3 can proceed                               
<a id="__codelineno-139-35" name="__codelineno-139-35" href="#__codelineno-139-35"></a>                                                         
<a id="__codelineno-139-36" name="__codelineno-139-36" href="#__codelineno-139-36"></a> Victim Selection Criteria:                              
<a id="__codelineno-139-37" name="__codelineno-139-37" href="#__codelineno-139-37"></a>  Transaction with least work done                      
<a id="__codelineno-139-38" name="__codelineno-139-38" href="#__codelineno-139-38"></a>  Transaction with fewest locks held                    
<a id="__codelineno-139-39" name="__codelineno-139-39" href="#__codelineno-139-39"></a>  Transaction that has been aborted before (fairness)   
<a id="__codelineno-139-40" name="__codelineno-139-40" href="#__codelineno-139-40"></a>                                                         
<a id="__codelineno-139-41" name="__codelineno-139-41" href="#__codelineno-139-41"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="c1"># Database automatically detects and resolves deadlocks</span>
<a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a>
<a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_with_deadlock_retry</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle deadlock with automatic retry&quot;&quot;&quot;</span>
<a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a>
<a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a>
<a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a>            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a>
<a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a>            <span class="c1"># Lock accounts (may cause deadlock)</span>
<a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a><span class="s2">                SELECT balance FROM accounts </span>
<a id="__codelineno-140-15" name="__codelineno-140-15" href="#__codelineno-140-15"></a><span class="s2">                WHERE id = ? </span>
<a id="__codelineno-140-16" name="__codelineno-140-16" href="#__codelineno-140-16"></a><span class="s2">                FOR UPDATE</span>
<a id="__codelineno-140-17" name="__codelineno-140-17" href="#__codelineno-140-17"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-140-18" name="__codelineno-140-18" href="#__codelineno-140-18"></a>
<a id="__codelineno-140-19" name="__codelineno-140-19" href="#__codelineno-140-19"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-140-20" name="__codelineno-140-20" href="#__codelineno-140-20"></a><span class="s2">                SELECT balance FROM accounts </span>
<a id="__codelineno-140-21" name="__codelineno-140-21" href="#__codelineno-140-21"></a><span class="s2">                WHERE id = ? </span>
<a id="__codelineno-140-22" name="__codelineno-140-22" href="#__codelineno-140-22"></a><span class="s2">                FOR UPDATE</span>
<a id="__codelineno-140-23" name="__codelineno-140-23" href="#__codelineno-140-23"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-140-24" name="__codelineno-140-24" href="#__codelineno-140-24"></a>
<a id="__codelineno-140-25" name="__codelineno-140-25" href="#__codelineno-140-25"></a>            <span class="c1"># Perform transfer</span>
<a id="__codelineno-140-26" name="__codelineno-140-26" href="#__codelineno-140-26"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-140-27" name="__codelineno-140-27" href="#__codelineno-140-27"></a><span class="s2">                UPDATE accounts SET balance = balance - ?</span>
<a id="__codelineno-140-28" name="__codelineno-140-28" href="#__codelineno-140-28"></a><span class="s2">                WHERE id = ?</span>
<a id="__codelineno-140-29" name="__codelineno-140-29" href="#__codelineno-140-29"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-140-30" name="__codelineno-140-30" href="#__codelineno-140-30"></a>
<a id="__codelineno-140-31" name="__codelineno-140-31" href="#__codelineno-140-31"></a>            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-140-32" name="__codelineno-140-32" href="#__codelineno-140-32"></a><span class="s2">                UPDATE accounts SET balance = balance + ?</span>
<a id="__codelineno-140-33" name="__codelineno-140-33" href="#__codelineno-140-33"></a><span class="s2">                WHERE id = ?</span>
<a id="__codelineno-140-34" name="__codelineno-140-34" href="#__codelineno-140-34"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-140-35" name="__codelineno-140-35" href="#__codelineno-140-35"></a>
<a id="__codelineno-140-36" name="__codelineno-140-36" href="#__codelineno-140-36"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-140-37" name="__codelineno-140-37" href="#__codelineno-140-37"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-140-38" name="__codelineno-140-38" href="#__codelineno-140-38"></a>
<a id="__codelineno-140-39" name="__codelineno-140-39" href="#__codelineno-140-39"></a>        <span class="k">except</span> <span class="n">DeadlockDetectedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-140-40" name="__codelineno-140-40" href="#__codelineno-140-40"></a>            <span class="c1"># Database detected deadlock and aborted this transaction</span>
<a id="__codelineno-140-41" name="__codelineno-140-41" href="#__codelineno-140-41"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-140-42" name="__codelineno-140-42" href="#__codelineno-140-42"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deadlock detected on attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, retrying...&quot;</span><span class="p">)</span>
<a id="__codelineno-140-43" name="__codelineno-140-43" href="#__codelineno-140-43"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">))</span>  <span class="c1"># Exponential backoff</span>
<a id="__codelineno-140-44" name="__codelineno-140-44" href="#__codelineno-140-44"></a>            <span class="k">continue</span>
<a id="__codelineno-140-45" name="__codelineno-140-45" href="#__codelineno-140-45"></a>
<a id="__codelineno-140-46" name="__codelineno-140-46" href="#__codelineno-140-46"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-140-47" name="__codelineno-140-47" href="#__codelineno-140-47"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-140-48" name="__codelineno-140-48" href="#__codelineno-140-48"></a>            <span class="k">raise</span>
<a id="__codelineno-140-49" name="__codelineno-140-49" href="#__codelineno-140-49"></a>
<a id="__codelineno-140-50" name="__codelineno-140-50" href="#__codelineno-140-50"></a>    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Failed after retries</span>
</code></pre></div>
<hr />
<p><strong>Solution 3: Timeout (Avoidance)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a>
<a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a>       SOLUTION 3: TIMEOUT (Deadlock Avoidance)          
<a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a>
<a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a>                                                         
<a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a> Strategy: Set maximum wait time for locks               
<a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a>                                                         
<a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a> How it works:                                           
<a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a>            
<a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a>  1. Transaction requests lock                        
<a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a>  2. If not available, wait with timeout              
<a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a>  3. If timeout expires  ABORT                        
<a id="__codelineno-141-12" name="__codelineno-141-12" href="#__codelineno-141-12"></a>  4. Release all held locks                           
<a id="__codelineno-141-13" name="__codelineno-141-13" href="#__codelineno-141-13"></a>  5. Retry transaction                                
<a id="__codelineno-141-14" name="__codelineno-141-14" href="#__codelineno-141-14"></a>            
<a id="__codelineno-141-15" name="__codelineno-141-15" href="#__codelineno-141-15"></a>                                                         
<a id="__codelineno-141-16" name="__codelineno-141-16" href="#__codelineno-141-16"></a> Timeline:                                               
<a id="__codelineno-141-17" name="__codelineno-141-17" href="#__codelineno-141-17"></a> t1: T1 locks A                                          
<a id="__codelineno-141-18" name="__codelineno-141-18" href="#__codelineno-141-18"></a> t2: T2 locks B                                          
<a id="__codelineno-141-19" name="__codelineno-141-19" href="#__codelineno-141-19"></a> t3: T1 requests B  starts waiting (timeout=5s)         
<a id="__codelineno-141-20" name="__codelineno-141-20" href="#__codelineno-141-20"></a> t4: T2 requests A  starts waiting (timeout=5s)         
<a id="__codelineno-141-21" name="__codelineno-141-21" href="#__codelineno-141-21"></a> t8: T1 timeout!  ABORT, release A                      
<a id="__codelineno-141-22" name="__codelineno-141-22" href="#__codelineno-141-22"></a> t9: T2 acquires A, proceeds                             
<a id="__codelineno-141-23" name="__codelineno-141-23" href="#__codelineno-141-23"></a> t10: T1 retries (now can get both locks)                
<a id="__codelineno-141-24" name="__codelineno-141-24" href="#__codelineno-141-24"></a>                                                         
<a id="__codelineno-141-25" name="__codelineno-141-25" href="#__codelineno-141-25"></a> Pros:                                                   
<a id="__codelineno-141-26" name="__codelineno-141-26" href="#__codelineno-141-26"></a>  Simple to implement                                   
<a id="__codelineno-141-27" name="__codelineno-141-27" href="#__codelineno-141-27"></a>  Guarantees no infinite wait                           
<a id="__codelineno-141-28" name="__codelineno-141-28" href="#__codelineno-141-28"></a>                                                         
<a id="__codelineno-141-29" name="__codelineno-141-29" href="#__codelineno-141-29"></a> Cons:                                                   
<a id="__codelineno-141-30" name="__codelineno-141-30" href="#__codelineno-141-30"></a>  May abort transactions unnecessarily                  
<a id="__codelineno-141-31" name="__codelineno-141-31" href="#__codelineno-141-31"></a>  Difficult to set optimal timeout value                
<a id="__codelineno-141-32" name="__codelineno-141-32" href="#__codelineno-141-32"></a>                                                         
<a id="__codelineno-141-33" name="__codelineno-141-33" href="#__codelineno-141-33"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_with_timeout</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Use lock timeout to avoid indefinite deadlock&quot;&quot;&quot;</span>
<a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a>
<a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a>    <span class="c1"># Set lock timeout (database-specific)</span>
<a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET lock_timeout = &#39;5s&#39;&quot;</span><span class="p">)</span>  <span class="c1"># PostgreSQL</span>
<a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a>    <span class="c1"># or: SET innodb_lock_wait_timeout = 5;  -- MySQL</span>
<a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a>
<a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a>
<a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a>        <span class="c1"># Try to acquire locks with timeout</span>
<a id="__codelineno-142-12" name="__codelineno-142-12" href="#__codelineno-142-12"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-142-13" name="__codelineno-142-13" href="#__codelineno-142-13"></a><span class="s2">            SELECT balance FROM accounts </span>
<a id="__codelineno-142-14" name="__codelineno-142-14" href="#__codelineno-142-14"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-142-15" name="__codelineno-142-15" href="#__codelineno-142-15"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-142-16" name="__codelineno-142-16" href="#__codelineno-142-16"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-142-17" name="__codelineno-142-17" href="#__codelineno-142-17"></a>
<a id="__codelineno-142-18" name="__codelineno-142-18" href="#__codelineno-142-18"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-142-19" name="__codelineno-142-19" href="#__codelineno-142-19"></a><span class="s2">            SELECT balance FROM accounts </span>
<a id="__codelineno-142-20" name="__codelineno-142-20" href="#__codelineno-142-20"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-142-21" name="__codelineno-142-21" href="#__codelineno-142-21"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-142-22" name="__codelineno-142-22" href="#__codelineno-142-22"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-142-23" name="__codelineno-142-23" href="#__codelineno-142-23"></a>        <span class="c1"># If timeout  LockTimeoutError raised</span>
<a id="__codelineno-142-24" name="__codelineno-142-24" href="#__codelineno-142-24"></a>
<a id="__codelineno-142-25" name="__codelineno-142-25" href="#__codelineno-142-25"></a>        <span class="c1"># Perform transfer</span>
<a id="__codelineno-142-26" name="__codelineno-142-26" href="#__codelineno-142-26"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-142-27" name="__codelineno-142-27" href="#__codelineno-142-27"></a><span class="s2">            UPDATE accounts SET balance = balance - ?</span>
<a id="__codelineno-142-28" name="__codelineno-142-28" href="#__codelineno-142-28"></a><span class="s2">            WHERE id = ?</span>
<a id="__codelineno-142-29" name="__codelineno-142-29" href="#__codelineno-142-29"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-142-30" name="__codelineno-142-30" href="#__codelineno-142-30"></a>
<a id="__codelineno-142-31" name="__codelineno-142-31" href="#__codelineno-142-31"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-142-32" name="__codelineno-142-32" href="#__codelineno-142-32"></a><span class="s2">            UPDATE accounts SET balance = balance + ?</span>
<a id="__codelineno-142-33" name="__codelineno-142-33" href="#__codelineno-142-33"></a><span class="s2">            WHERE id = ?</span>
<a id="__codelineno-142-34" name="__codelineno-142-34" href="#__codelineno-142-34"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-142-35" name="__codelineno-142-35" href="#__codelineno-142-35"></a>
<a id="__codelineno-142-36" name="__codelineno-142-36" href="#__codelineno-142-36"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-142-37" name="__codelineno-142-37" href="#__codelineno-142-37"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-142-38" name="__codelineno-142-38" href="#__codelineno-142-38"></a>
<a id="__codelineno-142-39" name="__codelineno-142-39" href="#__codelineno-142-39"></a>    <span class="k">except</span> <span class="n">LockTimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-142-40" name="__codelineno-142-40" href="#__codelineno-142-40"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-142-41" name="__codelineno-142-41" href="#__codelineno-142-41"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lock timeout - possible deadlock, retrying...&quot;</span><span class="p">)</span>
<a id="__codelineno-142-42" name="__codelineno-142-42" href="#__codelineno-142-42"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<hr />
<p><strong>Solution 4: Two-Phase Locking with Pre-Declaration</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a>
<a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a>   SOLUTION 4: PRE-DECLARATION (Prevention)              
<a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a>
<a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a>                                                         
<a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a> Strategy: Declare and lock ALL resources upfront        
<a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a>                                                         
<a id="__codelineno-143-7" name="__codelineno-143-7" href="#__codelineno-143-7"></a> How it works:                                           
<a id="__codelineno-143-8" name="__codelineno-143-8" href="#__codelineno-143-8"></a>            
<a id="__codelineno-143-9" name="__codelineno-143-9" href="#__codelineno-143-9"></a>  1. List all needed resources before                 
<a id="__codelineno-143-10" name="__codelineno-143-10" href="#__codelineno-143-10"></a>     starting transaction                             
<a id="__codelineno-143-11" name="__codelineno-143-11" href="#__codelineno-143-11"></a>  2. Acquire ALL locks at once                        
<a id="__codelineno-143-12" name="__codelineno-143-12" href="#__codelineno-143-12"></a>  3. If any lock unavailable  wait                   
<a id="__codelineno-143-13" name="__codelineno-143-13" href="#__codelineno-143-13"></a>  4. Only proceed when ALL acquired                   
<a id="__codelineno-143-14" name="__codelineno-143-14" href="#__codelineno-143-14"></a>  5. No additional locks during txn                   
<a id="__codelineno-143-15" name="__codelineno-143-15" href="#__codelineno-143-15"></a>            
<a id="__codelineno-143-16" name="__codelineno-143-16" href="#__codelineno-143-16"></a>                                                         
<a id="__codelineno-143-17" name="__codelineno-143-17" href="#__codelineno-143-17"></a> Breaks: HOLD AND WAIT condition                         
<a id="__codelineno-143-18" name="__codelineno-143-18" href="#__codelineno-143-18"></a> (No holding while waiting for more)                     
<a id="__codelineno-143-19" name="__codelineno-143-19" href="#__codelineno-143-19"></a>                                                         
<a id="__codelineno-143-20" name="__codelineno-143-20" href="#__codelineno-143-20"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_with_predeclaration</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Acquire all locks upfront&quot;&quot;&quot;</span>
<a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a>    <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a>
<a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a>    <span class="c1"># Declare all accounts needed</span>
<a id="__codelineno-144-6" name="__codelineno-144-6" href="#__codelineno-144-6"></a>    <span class="n">accounts_needed</span> <span class="o">=</span> <span class="p">[</span><span class="n">from_account</span><span class="p">,</span> <span class="n">to_account</span><span class="p">]</span>
<a id="__codelineno-144-7" name="__codelineno-144-7" href="#__codelineno-144-7"></a>
<a id="__codelineno-144-8" name="__codelineno-144-8" href="#__codelineno-144-8"></a>    <span class="c1"># Lock ALL accounts at once (in order)</span>
<a id="__codelineno-144-9" name="__codelineno-144-9" href="#__codelineno-144-9"></a>    <span class="k">for</span> <span class="n">account_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">accounts_needed</span><span class="p">):</span>
<a id="__codelineno-144-10" name="__codelineno-144-10" href="#__codelineno-144-10"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-144-11" name="__codelineno-144-11" href="#__codelineno-144-11"></a><span class="s2">            SELECT balance FROM accounts </span>
<a id="__codelineno-144-12" name="__codelineno-144-12" href="#__codelineno-144-12"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-144-13" name="__codelineno-144-13" href="#__codelineno-144-13"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-144-14" name="__codelineno-144-14" href="#__codelineno-144-14"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span>
<a id="__codelineno-144-15" name="__codelineno-144-15" href="#__codelineno-144-15"></a>
<a id="__codelineno-144-16" name="__codelineno-144-16" href="#__codelineno-144-16"></a>    <span class="c1"># All locks acquired! No more locking needed</span>
<a id="__codelineno-144-17" name="__codelineno-144-17" href="#__codelineno-144-17"></a>    <span class="c1"># Cannot deadlock now</span>
<a id="__codelineno-144-18" name="__codelineno-144-18" href="#__codelineno-144-18"></a>
<a id="__codelineno-144-19" name="__codelineno-144-19" href="#__codelineno-144-19"></a>    <span class="c1"># Perform operations</span>
<a id="__codelineno-144-20" name="__codelineno-144-20" href="#__codelineno-144-20"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = balance - ? WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-144-21" name="__codelineno-144-21" href="#__codelineno-144-21"></a>               <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">from_account</span><span class="p">])</span>
<a id="__codelineno-144-22" name="__codelineno-144-22" href="#__codelineno-144-22"></a>    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE accounts SET balance = balance + ? WHERE id = ?&quot;</span><span class="p">,</span>
<a id="__codelineno-144-23" name="__codelineno-144-23" href="#__codelineno-144-23"></a>               <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">to_account</span><span class="p">])</span>
<a id="__codelineno-144-24" name="__codelineno-144-24" href="#__codelineno-144-24"></a>
<a id="__codelineno-144-25" name="__codelineno-144-25" href="#__codelineno-144-25"></a>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<hr />
<h4 id="52-deadlock-in-optimistic-concurrency-control">5.2 Deadlock in Optimistic Concurrency Control</h4>
<p><strong>Description:</strong></p>
<p><strong>Optimistic Concurrency Control does NOT have traditional deadlocks</strong> because it doesn't use locks! However, it can suffer from a related problem called <strong>livelock</strong> or <strong>starvation</strong>, where transactions repeatedly retry but never succeed.</p>
<p><strong>The False Sense of Security:</strong></p>
<p>When developers first learn about optimistic concurrency control, there's often a moment of relief: "No locks? That means no deadlocks! Problem solved!" Unfortunately, this celebration is premature. While optimistic control eliminates deadlocks (transactions blocking each other forever), it introduces a potentially worse problem: <strong>livelock</strong> (transactions actively retrying forever but never succeeding).</p>
<p><strong>Deadlock vs. Livelock - The Cruel Difference:</strong></p>
<p><strong>Deadlock</strong> (pessimistic):
- Transactions frozen, waiting
- No CPU consumed (just waiting)
- Easy to detect (wait-for graph)
- Database can intervene (abort victim)
- <strong>Visible</strong> problem (timeouts, monitoring alerts)</p>
<p><strong>Livelock</strong> (optimistic):
- Transactions actively retrying
- <strong>Massive CPU waste</strong> (work done, then discarded)
- Hard to detect (transactions appear "active")
- No automatic intervention (retry logic in application)
- <strong>Invisible</strong> problem (looks like high load, not failure)</p>
<p>The cruel irony: <strong>Livelock wastes more resources than deadlock</strong> because transactions keep doing work that gets thrown away, while deadlocked transactions at least have the decency to do nothing while blocked.</p>
<p><strong>Real-World Livelock Disaster:</strong></p>
<p>In 2015, a popular social media platform experienced a livelock storm:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a>Scenario: Trending post with millions of likes
<a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a>- 10,000 users click &quot;like&quot; simultaneously
<a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a>- All read current like_count (optimistic read)
<a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a>- All increment: like_count + 1
<a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a>- All try to commit with version check
<a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a>- First one succeeds, 9,999 fail
<a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a>- 9,999 retry immediately
<a id="__codelineno-145-8" name="__codelineno-145-8" href="#__codelineno-145-8"></a>- Pattern repeats...
<a id="__codelineno-145-9" name="__codelineno-145-9" href="#__codelineno-145-9"></a>
<a id="__codelineno-145-10" name="__codelineno-145-10" href="#__codelineno-145-10"></a>Result:
<a id="__codelineno-145-11" name="__codelineno-145-11" href="#__codelineno-145-11"></a>- 99.99% of work wasted
<a id="__codelineno-145-12" name="__codelineno-145-12" href="#__codelineno-145-12"></a>- Server CPU at 100% (doing useless retries)
<a id="__codelineno-145-13" name="__codelineno-145-13" href="#__codelineno-145-13"></a>- Like count increased by 1 (instead of 10,000)
<a id="__codelineno-145-14" name="__codelineno-145-14" href="#__codelineno-145-14"></a>- Users saw &quot;Error: Please try again&quot; messages
<a id="__codelineno-145-15" name="__codelineno-145-15" href="#__codelineno-145-15"></a>- 30 minutes to resolve (had to rate-limit API)
</code></pre></div>
<p>This is worse than deadlock because:
1. Servers appeared "healthy" (high CPU usage)
2. No automatic detection (monitoring showed "active transactions")
3. Massive resource waste (10,000x more work than needed)
4. User-facing failures (not transparent like deadlock abort)</p>
<p><strong>The Starvation Problem:</strong></p>
<p>Livelock often leads to <strong>starvation</strong> - some transactions never succeed:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a>Unfair scenario:
<a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a>- T1: Short transaction (10ms), high retry rate
<a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a>- T2: Long transaction (1000ms), low retry rate
<a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a>
<a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a>What happens:
<a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a>- T2 does 1000ms of work
<a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a>- T1 completes 100 times in same period (10ms  100)
<a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a>- Every time T2 tries to commit, T1 has changed the data
<a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a>- T2 never succeeds (starved)
</code></pre></div>
<p>This violates <strong>fairness</strong> - some transactions are systematically disadvantaged.</p>
<p><strong>Why This is Harder to Debug:</strong></p>
<p>Deadlocks have clear symptoms:
<div class="highlight"><pre><span></span><code><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a>Database log: &quot;Deadlock detected, transaction T1 aborted&quot;
<a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a>Application: Exception with clear error code
<a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a>Monitoring: Deadlock counter increments
</code></pre></div></p>
<p>Livelock symptoms are subtle:
<div class="highlight"><pre><span></span><code><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a>Database log: Nothing (just normal retries)
<a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a>Application: Slow response times, eventual timeouts
<a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a>Monitoring: High CPU, low throughput (confusing!)
</code></pre></div></p>
<p>Developers often misdiagnose livelock as:
- "We need more servers" (throwing hardware at algorithmic problem)
- "Database is slow" (it's not - application retry logic is the issue)
- "Network problems" (it's not - the conflict is local)</p>
<p><strong>The Mathematics of Livelock:</strong></p>
<p>With N concurrent transactions competing for same resource:
- <strong>Success probability per transaction</strong>: 1/N
- <strong>Expected retries</strong>: N-1
- <strong>Total work</strong>: O(N) (N transactions  N retries each)
- <strong>Useful work</strong>: O(N) (N transactions succeed eventually)
- <strong>Waste ratio</strong>: N/1 = N</p>
<p>With 100 concurrent transactions:
- 99% of work wasted
- 100x more CPU consumed than needed</p>
<p>This quadratic degradation is why optimistic control <strong>fails catastrophically</strong> under high contention.</p>
<p><strong>Livelock in Distributed Systems:</strong></p>
<p>The problem is even worse in distributed databases:
- Higher latency per retry (network round trips)
- More concurrent users (global scale)
- Harder to coordinate retries (no central scheduler)
- Exponentially more work wasted</p>
<p>This is why distributed databases like Google Spanner use <strong>hybrid approaches</strong>: optimistic for low-contention paths, pessimistic locks for hot spots.</p>
<p><strong>Why No Deadlocks in Optimistic Control:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a>
<a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a>     OPTIMISTIC CONTROL - NO DEADLOCKS                   
<a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a>
<a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a>                                                         
<a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a> No deadlocks because:                                   
<a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a>                                                         
<a id="__codelineno-149-7" name="__codelineno-149-7" href="#__codelineno-149-7"></a>  No locks acquired  No circular wait                  
<a id="__codelineno-149-8" name="__codelineno-149-8" href="#__codelineno-149-8"></a>  No holding resources  No hold-and-wait               
<a id="__codelineno-149-9" name="__codelineno-149-9" href="#__codelineno-149-9"></a>  Transactions don&#39;t block each other                   
<a id="__codelineno-149-10" name="__codelineno-149-10" href="#__codelineno-149-10"></a>                                                         
<a id="__codelineno-149-11" name="__codelineno-149-11" href="#__codelineno-149-11"></a> Instead, we have:                                       
<a id="__codelineno-149-12" name="__codelineno-149-12" href="#__codelineno-149-12"></a>  LIVELOCK (infinite retries)                          
<a id="__codelineno-149-13" name="__codelineno-149-13" href="#__codelineno-149-13"></a>  STARVATION (transaction never commits)               
<a id="__codelineno-149-14" name="__codelineno-149-14" href="#__codelineno-149-14"></a>                                                         
<a id="__codelineno-149-15" name="__codelineno-149-15" href="#__codelineno-149-15"></a>
</code></pre></div>
<p><strong>Livelock Problem in Optimistic Control:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a>
<a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a>              LIVELOCK SCENARIO                          
<a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a>
<a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a>                                                         
<a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a> Problem: Transactions keep retrying but never succeed   
<a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a>                                                         
<a id="__codelineno-150-7" name="__codelineno-150-7" href="#__codelineno-150-7"></a> Time  T1                         T2                     
<a id="__codelineno-150-8" name="__codelineno-150-8" href="#__codelineno-150-8"></a>         
<a id="__codelineno-150-9" name="__codelineno-150-9" href="#__codelineno-150-9"></a> t1    Read: balance=1000, v=1                           
<a id="__codelineno-150-10" name="__codelineno-150-10" href="#__codelineno-150-10"></a> t2                                Read: balance=1000,v=1
<a id="__codelineno-150-11" name="__codelineno-150-11" href="#__codelineno-150-11"></a> t3    Modify: balance=500                               
<a id="__codelineno-150-12" name="__codelineno-150-12" href="#__codelineno-150-12"></a> t4                                Modify: balance=700   
<a id="__codelineno-150-13" name="__codelineno-150-13" href="#__codelineno-150-13"></a> t5    Validate , Commit                                
<a id="__codelineno-150-14" name="__codelineno-150-14" href="#__codelineno-150-14"></a>       balance=500, v=2                                  
<a id="__codelineno-150-15" name="__codelineno-150-15" href="#__codelineno-150-15"></a> t6                                Validate  (v1)      
<a id="__codelineno-150-16" name="__codelineno-150-16" href="#__codelineno-150-16"></a> t7                                RETRY                 
<a id="__codelineno-150-17" name="__codelineno-150-17" href="#__codelineno-150-17"></a> t8                                Read: balance=500,v=2 
<a id="__codelineno-150-18" name="__codelineno-150-18" href="#__codelineno-150-18"></a> t9    Read: balance=500, v=2                            
<a id="__codelineno-150-19" name="__codelineno-150-19" href="#__codelineno-150-19"></a> t10   Modify: balance=300                               
<a id="__codelineno-150-20" name="__codelineno-150-20" href="#__codelineno-150-20"></a> t11                               Modify: balance=200   
<a id="__codelineno-150-21" name="__codelineno-150-21" href="#__codelineno-150-21"></a> t12   Validate , Commit                                
<a id="__codelineno-150-22" name="__codelineno-150-22" href="#__codelineno-150-22"></a>       balance=300, v=3                                  
<a id="__codelineno-150-23" name="__codelineno-150-23" href="#__codelineno-150-23"></a> t13                               Validate  (v2)      
<a id="__codelineno-150-24" name="__codelineno-150-24" href="#__codelineno-150-24"></a> t14                               RETRY AGAIN...        
<a id="__codelineno-150-25" name="__codelineno-150-25" href="#__codelineno-150-25"></a> t15   (Pattern repeats...)         LIVELOCK!         
<a id="__codelineno-150-26" name="__codelineno-150-26" href="#__codelineno-150-26"></a>                                                         
<a id="__codelineno-150-27" name="__codelineno-150-27" href="#__codelineno-150-27"></a> T2 never succeeds! (continuously retrying)              
<a id="__codelineno-150-28" name="__codelineno-150-28" href="#__codelineno-150-28"></a>                                                         
<a id="__codelineno-150-29" name="__codelineno-150-29" href="#__codelineno-150-29"></a>
</code></pre></div>
<p><strong>Visual Diagram - Livelock:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a>
<a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a>           LIVELOCK IN OPTIMISTIC CONTROL                
<a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a>
<a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a>                                                         
<a id="__codelineno-151-5" name="__codelineno-151-5" href="#__codelineno-151-5"></a>  Multiple transactions competing for same resource:     
<a id="__codelineno-151-6" name="__codelineno-151-6" href="#__codelineno-151-6"></a>                                                         
<a id="__codelineno-151-7" name="__codelineno-151-7" href="#__codelineno-151-7"></a>  T1: [Read][Modify][Commit][Read][Commit]
<a id="__codelineno-151-8" name="__codelineno-151-8" href="#__codelineno-151-8"></a>                                                         
<a id="__codelineno-151-9" name="__codelineno-151-9" href="#__codelineno-151-9"></a>  T2: [Read][Modify][Abort][Read][Abort]  
<a id="__codelineno-151-10" name="__codelineno-151-10" href="#__codelineno-151-10"></a>                                                     
<a id="__codelineno-151-11" name="__codelineno-151-11" href="#__codelineno-151-11"></a>                                                     
<a id="__codelineno-151-12" name="__codelineno-151-12" href="#__codelineno-151-12"></a>        RETRY         RETRY        
<a id="__codelineno-151-13" name="__codelineno-151-13" href="#__codelineno-151-13"></a>                                                         
<a id="__codelineno-151-14" name="__codelineno-151-14" href="#__codelineno-151-14"></a>  T3: [Read][Modify][Abort][Read][Abort]  
<a id="__codelineno-151-15" name="__codelineno-151-15" href="#__codelineno-151-15"></a>                                                       
<a id="__codelineno-151-16" name="__codelineno-151-16" href="#__codelineno-151-16"></a>                            RETRY        
<a id="__codelineno-151-17" name="__codelineno-151-17" href="#__codelineno-151-17"></a>                                                         
<a id="__codelineno-151-18" name="__codelineno-151-18" href="#__codelineno-151-18"></a>  Problem: T2 and T3 keep retrying but keep failing      
<a id="__codelineno-151-19" name="__codelineno-151-19" href="#__codelineno-151-19"></a>  (T1 keeps winning, others keep losing)                 
<a id="__codelineno-151-20" name="__codelineno-151-20" href="#__codelineno-151-20"></a>                                                         
<a id="__codelineno-151-21" name="__codelineno-151-21" href="#__codelineno-151-21"></a>
</code></pre></div>
<p><strong>Pseudo Code - Livelock Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="c1"># Livelock scenario in optimistic control</span>
<a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a>
<a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimistic_transaction_livelock</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-152-5" name="__codelineno-152-5" href="#__codelineno-152-5"></a><span class="sd">    This transaction might experience livelock</span>
<a id="__codelineno-152-6" name="__codelineno-152-6" href="#__codelineno-152-6"></a><span class="sd">    if many other transactions compete for same account</span>
<a id="__codelineno-152-7" name="__codelineno-152-7" href="#__codelineno-152-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-152-8" name="__codelineno-152-8" href="#__codelineno-152-8"></a>
<a id="__codelineno-152-9" name="__codelineno-152-9" href="#__codelineno-152-9"></a>    <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-152-10" name="__codelineno-152-10" href="#__codelineno-152-10"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Infinite retry!</span>
<a id="__codelineno-152-11" name="__codelineno-152-11" href="#__codelineno-152-11"></a>        <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-152-12" name="__codelineno-152-12" href="#__codelineno-152-12"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-152-13" name="__codelineno-152-13" href="#__codelineno-152-13"></a>
<a id="__codelineno-152-14" name="__codelineno-152-14" href="#__codelineno-152-14"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-152-15" name="__codelineno-152-15" href="#__codelineno-152-15"></a>
<a id="__codelineno-152-16" name="__codelineno-152-16" href="#__codelineno-152-16"></a>        <span class="c1"># Read version</span>
<a id="__codelineno-152-17" name="__codelineno-152-17" href="#__codelineno-152-17"></a>        <span class="n">balance</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-152-18" name="__codelineno-152-18" href="#__codelineno-152-18"></a><span class="s2">            SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-152-19" name="__codelineno-152-19" href="#__codelineno-152-19"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-152-20" name="__codelineno-152-20" href="#__codelineno-152-20"></a>
<a id="__codelineno-152-21" name="__codelineno-152-21" href="#__codelineno-152-21"></a>        <span class="c1"># Modify locally</span>
<a id="__codelineno-152-22" name="__codelineno-152-22" href="#__codelineno-152-22"></a>        <span class="n">new_balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">amount</span>
<a id="__codelineno-152-23" name="__codelineno-152-23" href="#__codelineno-152-23"></a>
<a id="__codelineno-152-24" name="__codelineno-152-24" href="#__codelineno-152-24"></a>        <span class="c1"># Try to commit with version check</span>
<a id="__codelineno-152-25" name="__codelineno-152-25" href="#__codelineno-152-25"></a>        <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-152-26" name="__codelineno-152-26" href="#__codelineno-152-26"></a><span class="s2">            UPDATE accounts </span>
<a id="__codelineno-152-27" name="__codelineno-152-27" href="#__codelineno-152-27"></a><span class="s2">            SET balance = ?, version = version + 1</span>
<a id="__codelineno-152-28" name="__codelineno-152-28" href="#__codelineno-152-28"></a><span class="s2">            WHERE id = ? AND version = ?</span>
<a id="__codelineno-152-29" name="__codelineno-152-29" href="#__codelineno-152-29"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">new_balance</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-152-30" name="__codelineno-152-30" href="#__codelineno-152-30"></a>
<a id="__codelineno-152-31" name="__codelineno-152-31" href="#__codelineno-152-31"></a>        <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-152-32" name="__codelineno-152-32" href="#__codelineno-152-32"></a>            <span class="c1"># Failed! Another transaction committed first</span>
<a id="__codelineno-152-33" name="__codelineno-152-33" href="#__codelineno-152-33"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-152-34" name="__codelineno-152-34" href="#__codelineno-152-34"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2"> failed, retrying...&quot;</span><span class="p">)</span>
<a id="__codelineno-152-35" name="__codelineno-152-35" href="#__codelineno-152-35"></a>            <span class="c1"># If many transactions competing  infinite retries!</span>
<a id="__codelineno-152-36" name="__codelineno-152-36" href="#__codelineno-152-36"></a>            <span class="k">continue</span>
<a id="__codelineno-152-37" name="__codelineno-152-37" href="#__codelineno-152-37"></a>
<a id="__codelineno-152-38" name="__codelineno-152-38" href="#__codelineno-152-38"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-152-39" name="__codelineno-152-39" href="#__codelineno-152-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success on attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-152-40" name="__codelineno-152-40" href="#__codelineno-152-40"></a>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<hr />
<p><strong>Livelock Solutions for Optimistic Control:</strong></p>
<p><strong>Solution 1: Exponential Backoff with Jitter</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a>
<a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a>   SOLUTION 1: EXPONENTIAL BACKOFF + JITTER              
<a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a>
<a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a>                                                         
<a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a> Strategy: Randomized delays between retries             
<a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a>                                                         
<a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a> How it works:                                           
<a id="__codelineno-153-8" name="__codelineno-153-8" href="#__codelineno-153-8"></a>            
<a id="__codelineno-153-9" name="__codelineno-153-9" href="#__codelineno-153-9"></a>  1. After conflict, wait before retry                
<a id="__codelineno-153-10" name="__codelineno-153-10" href="#__codelineno-153-10"></a>  2. Wait time increases exponentially                
<a id="__codelineno-153-11" name="__codelineno-153-11" href="#__codelineno-153-11"></a>  3. Add random jitter to avoid sync                  
<a id="__codelineno-153-12" name="__codelineno-153-12" href="#__codelineno-153-12"></a>  4. Max retry limit to prevent infinite              
<a id="__codelineno-153-13" name="__codelineno-153-13" href="#__codelineno-153-13"></a>            
<a id="__codelineno-153-14" name="__codelineno-153-14" href="#__codelineno-153-14"></a>                                                         
<a id="__codelineno-153-15" name="__codelineno-153-15" href="#__codelineno-153-15"></a> Retry delays:                                           
<a id="__codelineno-153-16" name="__codelineno-153-16" href="#__codelineno-153-16"></a> Attempt 1: 10ms  + random(0-5ms)                        
<a id="__codelineno-153-17" name="__codelineno-153-17" href="#__codelineno-153-17"></a> Attempt 2: 20ms  + random(0-10ms)                       
<a id="__codelineno-153-18" name="__codelineno-153-18" href="#__codelineno-153-18"></a> Attempt 3: 40ms  + random(0-20ms)                       
<a id="__codelineno-153-19" name="__codelineno-153-19" href="#__codelineno-153-19"></a> Attempt 4: 80ms  + random(0-40ms)                       
<a id="__codelineno-153-20" name="__codelineno-153-20" href="#__codelineno-153-20"></a> Attempt 5: 160ms + random(0-80ms)                       
<a id="__codelineno-153-21" name="__codelineno-153-21" href="#__codelineno-153-21"></a>                                                         
<a id="__codelineno-153-22" name="__codelineno-153-22" href="#__codelineno-153-22"></a> Jitter prevents synchronized retries                    
<a id="__codelineno-153-23" name="__codelineno-153-23" href="#__codelineno-153-23"></a> (transactions retry at different times)                 
<a id="__codelineno-153-24" name="__codelineno-153-24" href="#__codelineno-153-24"></a>                                                         
<a id="__codelineno-153-25" name="__codelineno-153-25" href="#__codelineno-153-25"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a>
<a id="__codelineno-154-4" name="__codelineno-154-4" href="#__codelineno-154-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimistic_with_exponential_backoff</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-154-5" name="__codelineno-154-5" href="#__codelineno-154-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prevent livelock with exponential backoff + jitter&quot;&quot;&quot;</span>
<a id="__codelineno-154-6" name="__codelineno-154-6" href="#__codelineno-154-6"></a>
<a id="__codelineno-154-7" name="__codelineno-154-7" href="#__codelineno-154-7"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-154-8" name="__codelineno-154-8" href="#__codelineno-154-8"></a>    <span class="n">base_delay_ms</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-154-9" name="__codelineno-154-9" href="#__codelineno-154-9"></a>
<a id="__codelineno-154-10" name="__codelineno-154-10" href="#__codelineno-154-10"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-154-11" name="__codelineno-154-11" href="#__codelineno-154-11"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-154-12" name="__codelineno-154-12" href="#__codelineno-154-12"></a>            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-154-13" name="__codelineno-154-13" href="#__codelineno-154-13"></a>
<a id="__codelineno-154-14" name="__codelineno-154-14" href="#__codelineno-154-14"></a>            <span class="c1"># Read with version</span>
<a id="__codelineno-154-15" name="__codelineno-154-15" href="#__codelineno-154-15"></a>            <span class="n">balance</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-154-16" name="__codelineno-154-16" href="#__codelineno-154-16"></a><span class="s2">                SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-154-17" name="__codelineno-154-17" href="#__codelineno-154-17"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-154-18" name="__codelineno-154-18" href="#__codelineno-154-18"></a>
<a id="__codelineno-154-19" name="__codelineno-154-19" href="#__codelineno-154-19"></a>            <span class="c1"># Validate business rules</span>
<a id="__codelineno-154-20" name="__codelineno-154-20" href="#__codelineno-154-20"></a>            <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-154-21" name="__codelineno-154-21" href="#__codelineno-154-21"></a>                <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-154-22" name="__codelineno-154-22" href="#__codelineno-154-22"></a>
<a id="__codelineno-154-23" name="__codelineno-154-23" href="#__codelineno-154-23"></a>            <span class="c1"># Try to update</span>
<a id="__codelineno-154-24" name="__codelineno-154-24" href="#__codelineno-154-24"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-154-25" name="__codelineno-154-25" href="#__codelineno-154-25"></a><span class="s2">                UPDATE accounts </span>
<a id="__codelineno-154-26" name="__codelineno-154-26" href="#__codelineno-154-26"></a><span class="s2">                SET balance = balance - ?, version = version + 1</span>
<a id="__codelineno-154-27" name="__codelineno-154-27" href="#__codelineno-154-27"></a><span class="s2">                WHERE id = ? AND version = ?</span>
<a id="__codelineno-154-28" name="__codelineno-154-28" href="#__codelineno-154-28"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-154-29" name="__codelineno-154-29" href="#__codelineno-154-29"></a>
<a id="__codelineno-154-30" name="__codelineno-154-30" href="#__codelineno-154-30"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-154-31" name="__codelineno-154-31" href="#__codelineno-154-31"></a>                <span class="c1"># Conflict detected</span>
<a id="__codelineno-154-32" name="__codelineno-154-32" href="#__codelineno-154-32"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-154-33" name="__codelineno-154-33" href="#__codelineno-154-33"></a>
<a id="__codelineno-154-34" name="__codelineno-154-34" href="#__codelineno-154-34"></a>                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-154-35" name="__codelineno-154-35" href="#__codelineno-154-35"></a>                    <span class="c1"># Exponential backoff with jitter</span>
<a id="__codelineno-154-36" name="__codelineno-154-36" href="#__codelineno-154-36"></a>                    <span class="n">delay_ms</span> <span class="o">=</span> <span class="n">base_delay_ms</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
<a id="__codelineno-154-37" name="__codelineno-154-37" href="#__codelineno-154-37"></a>                    <span class="n">jitter_ms</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">delay_ms</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-154-38" name="__codelineno-154-38" href="#__codelineno-154-38"></a>                    <span class="n">total_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">delay_ms</span> <span class="o">+</span> <span class="n">jitter_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
<a id="__codelineno-154-39" name="__codelineno-154-39" href="#__codelineno-154-39"></a>
<a id="__codelineno-154-40" name="__codelineno-154-40" href="#__codelineno-154-40"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conflict on attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-154-41" name="__codelineno-154-41" href="#__codelineno-154-41"></a>                          <span class="sa">f</span><span class="s2">&quot;waiting </span><span class="si">{</span><span class="n">total_delay</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s...&quot;</span><span class="p">)</span>
<a id="__codelineno-154-42" name="__codelineno-154-42" href="#__codelineno-154-42"></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">total_delay</span><span class="p">)</span>
<a id="__codelineno-154-43" name="__codelineno-154-43" href="#__codelineno-154-43"></a>                    <span class="k">continue</span>
<a id="__codelineno-154-44" name="__codelineno-154-44" href="#__codelineno-154-44"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-154-45" name="__codelineno-154-45" href="#__codelineno-154-45"></a>                    <span class="k">raise</span> <span class="n">MaxRetriesExceededError</span><span class="p">()</span>
<a id="__codelineno-154-46" name="__codelineno-154-46" href="#__codelineno-154-46"></a>
<a id="__codelineno-154-47" name="__codelineno-154-47" href="#__codelineno-154-47"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-154-48" name="__codelineno-154-48" href="#__codelineno-154-48"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-154-49" name="__codelineno-154-49" href="#__codelineno-154-49"></a>
<a id="__codelineno-154-50" name="__codelineno-154-50" href="#__codelineno-154-50"></a>        <span class="k">except</span> <span class="n">InsufficientFundsError</span><span class="p">:</span>
<a id="__codelineno-154-51" name="__codelineno-154-51" href="#__codelineno-154-51"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-154-52" name="__codelineno-154-52" href="#__codelineno-154-52"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-154-53" name="__codelineno-154-53" href="#__codelineno-154-53"></a>
<a id="__codelineno-154-54" name="__codelineno-154-54" href="#__codelineno-154-54"></a>    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<hr />
<p><strong>Solution 2: Priority-Based Retry</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a>
<a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a>      SOLUTION 2: PRIORITY-BASED RETRY                   
<a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a>
<a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a>                                                         
<a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a> Strategy: Assign priorities to transactions             
<a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a>                                                         
<a id="__codelineno-155-7" name="__codelineno-155-7" href="#__codelineno-155-7"></a> How it works:                                           
<a id="__codelineno-155-8" name="__codelineno-155-8" href="#__codelineno-155-8"></a>            
<a id="__codelineno-155-9" name="__codelineno-155-9" href="#__codelineno-155-9"></a>  1. Assign priority to each transaction              
<a id="__codelineno-155-10" name="__codelineno-155-10" href="#__codelineno-155-10"></a>  2. Higher priority = shorter wait                   
<a id="__codelineno-155-11" name="__codelineno-155-11" href="#__codelineno-155-11"></a>  3. Lower priority = longer wait                     
<a id="__codelineno-155-12" name="__codelineno-155-12" href="#__codelineno-155-12"></a>  4. Prevents starvation of low-priority              
<a id="__codelineno-155-13" name="__codelineno-155-13" href="#__codelineno-155-13"></a>     (priority increases with retries)                
<a id="__codelineno-155-14" name="__codelineno-155-14" href="#__codelineno-155-14"></a>            
<a id="__codelineno-155-15" name="__codelineno-155-15" href="#__codelineno-155-15"></a>                                                         
<a id="__codelineno-155-16" name="__codelineno-155-16" href="#__codelineno-155-16"></a> Priority calculation:                                   
<a id="__codelineno-155-17" name="__codelineno-155-17" href="#__codelineno-155-17"></a> priority = base_priority + (retry_count * 10)           
<a id="__codelineno-155-18" name="__codelineno-155-18" href="#__codelineno-155-18"></a>                                                         
<a id="__codelineno-155-19" name="__codelineno-155-19" href="#__codelineno-155-19"></a> Effect:                                                 
<a id="__codelineno-155-20" name="__codelineno-155-20" href="#__codelineno-155-20"></a>  New transactions: low priority, wait longer           
<a id="__codelineno-155-21" name="__codelineno-155-21" href="#__codelineno-155-21"></a>  Retried transactions: high priority, wait less        
<a id="__codelineno-155-22" name="__codelineno-155-22" href="#__codelineno-155-22"></a>  Eventually all succeed (no starvation)                
<a id="__codelineno-155-23" name="__codelineno-155-23" href="#__codelineno-155-23"></a>                                                         
<a id="__codelineno-155-24" name="__codelineno-155-24" href="#__codelineno-155-24"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimistic_with_priority</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">base_priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Use priority to prevent starvation&quot;&quot;&quot;</span>
<a id="__codelineno-156-3" name="__codelineno-156-3" href="#__codelineno-156-3"></a>
<a id="__codelineno-156-4" name="__codelineno-156-4" href="#__codelineno-156-4"></a>    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-156-5" name="__codelineno-156-5" href="#__codelineno-156-5"></a>    <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-156-6" name="__codelineno-156-6" href="#__codelineno-156-6"></a>
<a id="__codelineno-156-7" name="__codelineno-156-7" href="#__codelineno-156-7"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
<a id="__codelineno-156-8" name="__codelineno-156-8" href="#__codelineno-156-8"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-156-9" name="__codelineno-156-9" href="#__codelineno-156-9"></a>            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-156-10" name="__codelineno-156-10" href="#__codelineno-156-10"></a>
<a id="__codelineno-156-11" name="__codelineno-156-11" href="#__codelineno-156-11"></a>            <span class="c1"># Read data</span>
<a id="__codelineno-156-12" name="__codelineno-156-12" href="#__codelineno-156-12"></a>            <span class="n">balance</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-156-13" name="__codelineno-156-13" href="#__codelineno-156-13"></a><span class="s2">                SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-156-14" name="__codelineno-156-14" href="#__codelineno-156-14"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-156-15" name="__codelineno-156-15" href="#__codelineno-156-15"></a>
<a id="__codelineno-156-16" name="__codelineno-156-16" href="#__codelineno-156-16"></a>            <span class="c1"># Try to update</span>
<a id="__codelineno-156-17" name="__codelineno-156-17" href="#__codelineno-156-17"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-156-18" name="__codelineno-156-18" href="#__codelineno-156-18"></a><span class="s2">                UPDATE accounts </span>
<a id="__codelineno-156-19" name="__codelineno-156-19" href="#__codelineno-156-19"></a><span class="s2">                SET balance = balance - ?, version = version + 1</span>
<a id="__codelineno-156-20" name="__codelineno-156-20" href="#__codelineno-156-20"></a><span class="s2">                WHERE id = ? AND version = ?</span>
<a id="__codelineno-156-21" name="__codelineno-156-21" href="#__codelineno-156-21"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-156-22" name="__codelineno-156-22" href="#__codelineno-156-22"></a>
<a id="__codelineno-156-23" name="__codelineno-156-23" href="#__codelineno-156-23"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-156-24" name="__codelineno-156-24" href="#__codelineno-156-24"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-156-25" name="__codelineno-156-25" href="#__codelineno-156-25"></a>                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-156-26" name="__codelineno-156-26" href="#__codelineno-156-26"></a>
<a id="__codelineno-156-27" name="__codelineno-156-27" href="#__codelineno-156-27"></a>                <span class="c1"># Calculate priority (increases with retries)</span>
<a id="__codelineno-156-28" name="__codelineno-156-28" href="#__codelineno-156-28"></a>                <span class="n">priority</span> <span class="o">=</span> <span class="n">base_priority</span> <span class="o">+</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-156-29" name="__codelineno-156-29" href="#__codelineno-156-29"></a>
<a id="__codelineno-156-30" name="__codelineno-156-30" href="#__codelineno-156-30"></a>                <span class="c1"># Wait time inversely proportional to priority</span>
<a id="__codelineno-156-31" name="__codelineno-156-31" href="#__codelineno-156-31"></a>                <span class="n">max_wait</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># ms</span>
<a id="__codelineno-156-32" name="__codelineno-156-32" href="#__codelineno-156-32"></a>                <span class="n">wait_time</span> <span class="o">=</span> <span class="n">max_wait</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">priority</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-156-33" name="__codelineno-156-33" href="#__codelineno-156-33"></a>
<a id="__codelineno-156-34" name="__codelineno-156-34" href="#__codelineno-156-34"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retry </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">, priority=</span><span class="si">{</span><span class="n">priority</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-156-35" name="__codelineno-156-35" href="#__codelineno-156-35"></a>                      <span class="sa">f</span><span class="s2">&quot;wait=</span><span class="si">{</span><span class="n">wait_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
<a id="__codelineno-156-36" name="__codelineno-156-36" href="#__codelineno-156-36"></a>
<a id="__codelineno-156-37" name="__codelineno-156-37" href="#__codelineno-156-37"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
<a id="__codelineno-156-38" name="__codelineno-156-38" href="#__codelineno-156-38"></a>                <span class="k">continue</span>
<a id="__codelineno-156-39" name="__codelineno-156-39" href="#__codelineno-156-39"></a>
<a id="__codelineno-156-40" name="__codelineno-156-40" href="#__codelineno-156-40"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-156-41" name="__codelineno-156-41" href="#__codelineno-156-41"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-156-42" name="__codelineno-156-42" href="#__codelineno-156-42"></a>
<a id="__codelineno-156-43" name="__codelineno-156-43" href="#__codelineno-156-43"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-156-44" name="__codelineno-156-44" href="#__codelineno-156-44"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-156-45" name="__codelineno-156-45" href="#__codelineno-156-45"></a>            <span class="k">raise</span>
<a id="__codelineno-156-46" name="__codelineno-156-46" href="#__codelineno-156-46"></a>
<a id="__codelineno-156-47" name="__codelineno-156-47" href="#__codelineno-156-47"></a>    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<hr />
<p><strong>Solution 3: Maximum Retry Limit + Fallback</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a>
<a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a>   SOLUTION 3: MAX RETRIES + FALLBACK TO PESSIMISTIC     
<a id="__codelineno-157-3" name="__codelineno-157-3" href="#__codelineno-157-3"></a>
<a id="__codelineno-157-4" name="__codelineno-157-4" href="#__codelineno-157-4"></a>                                                         
<a id="__codelineno-157-5" name="__codelineno-157-5" href="#__codelineno-157-5"></a> Strategy: Switch to pessimistic after too many retries  
<a id="__codelineno-157-6" name="__codelineno-157-6" href="#__codelineno-157-6"></a>                                                         
<a id="__codelineno-157-7" name="__codelineno-157-7" href="#__codelineno-157-7"></a> How it works:                                           
<a id="__codelineno-157-8" name="__codelineno-157-8" href="#__codelineno-157-8"></a>            
<a id="__codelineno-157-9" name="__codelineno-157-9" href="#__codelineno-157-9"></a>  1. Try optimistic (fast, no locks)                  
<a id="__codelineno-157-10" name="__codelineno-157-10" href="#__codelineno-157-10"></a>  2. If conflicts detected repeatedly                 
<a id="__codelineno-157-11" name="__codelineno-157-11" href="#__codelineno-157-11"></a>  3. Switch to pessimistic (use locks)                
<a id="__codelineno-157-12" name="__codelineno-157-12" href="#__codelineno-157-12"></a>  4. Guaranteed to succeed                            
<a id="__codelineno-157-13" name="__codelineno-157-13" href="#__codelineno-157-13"></a>            
<a id="__codelineno-157-14" name="__codelineno-157-14" href="#__codelineno-157-14"></a>                                                         
<a id="__codelineno-157-15" name="__codelineno-157-15" href="#__codelineno-157-15"></a> Timeline:                                               
<a id="__codelineno-157-16" name="__codelineno-157-16" href="#__codelineno-157-16"></a> Attempt 1-3: Optimistic (failed)                        
<a id="__codelineno-157-17" name="__codelineno-157-17" href="#__codelineno-157-17"></a> Attempt 4-6: Optimistic (failed)                        
<a id="__codelineno-157-18" name="__codelineno-157-18" href="#__codelineno-157-18"></a> Attempt 7+:  Pessimistic (use locks)  Success!         
<a id="__codelineno-157-19" name="__codelineno-157-19" href="#__codelineno-157-19"></a>                                                         
<a id="__codelineno-157-20" name="__codelineno-157-20" href="#__codelineno-157-20"></a>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">adaptive_concurrency_control</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<a id="__codelineno-158-2" name="__codelineno-158-2" href="#__codelineno-158-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start optimistic, fallback to pessimistic if needed&quot;&quot;&quot;</span>
<a id="__codelineno-158-3" name="__codelineno-158-3" href="#__codelineno-158-3"></a>
<a id="__codelineno-158-4" name="__codelineno-158-4" href="#__codelineno-158-4"></a>    <span class="n">optimistic_retries</span> <span class="o">=</span> <span class="mi">5</span>
<a id="__codelineno-158-5" name="__codelineno-158-5" href="#__codelineno-158-5"></a>
<a id="__codelineno-158-6" name="__codelineno-158-6" href="#__codelineno-158-6"></a>    <span class="c1"># Phase 1: Try optimistic first</span>
<a id="__codelineno-158-7" name="__codelineno-158-7" href="#__codelineno-158-7"></a>    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">optimistic_retries</span><span class="p">):</span>
<a id="__codelineno-158-8" name="__codelineno-158-8" href="#__codelineno-158-8"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-158-9" name="__codelineno-158-9" href="#__codelineno-158-9"></a>            <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-158-10" name="__codelineno-158-10" href="#__codelineno-158-10"></a>
<a id="__codelineno-158-11" name="__codelineno-158-11" href="#__codelineno-158-11"></a>            <span class="c1"># Optimistic: no locks</span>
<a id="__codelineno-158-12" name="__codelineno-158-12" href="#__codelineno-158-12"></a>            <span class="n">balance</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-158-13" name="__codelineno-158-13" href="#__codelineno-158-13"></a><span class="s2">                SELECT balance, version FROM accounts WHERE id = ?</span>
<a id="__codelineno-158-14" name="__codelineno-158-14" href="#__codelineno-158-14"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<a id="__codelineno-158-15" name="__codelineno-158-15" href="#__codelineno-158-15"></a>
<a id="__codelineno-158-16" name="__codelineno-158-16" href="#__codelineno-158-16"></a>            <span class="c1"># Try to update with version check</span>
<a id="__codelineno-158-17" name="__codelineno-158-17" href="#__codelineno-158-17"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-158-18" name="__codelineno-158-18" href="#__codelineno-158-18"></a><span class="s2">                UPDATE accounts </span>
<a id="__codelineno-158-19" name="__codelineno-158-19" href="#__codelineno-158-19"></a><span class="s2">                SET balance = balance - ?, version = version + 1</span>
<a id="__codelineno-158-20" name="__codelineno-158-20" href="#__codelineno-158-20"></a><span class="s2">                WHERE id = ? AND version = ?</span>
<a id="__codelineno-158-21" name="__codelineno-158-21" href="#__codelineno-158-21"></a><span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">version</span><span class="p">])</span><span class="o">.</span><span class="n">rowcount</span>
<a id="__codelineno-158-22" name="__codelineno-158-22" href="#__codelineno-158-22"></a>
<a id="__codelineno-158-23" name="__codelineno-158-23" href="#__codelineno-158-23"></a>            <span class="k">if</span> <span class="n">updated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-158-24" name="__codelineno-158-24" href="#__codelineno-158-24"></a>                <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-158-25" name="__codelineno-158-25" href="#__codelineno-158-25"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">))</span>
<a id="__codelineno-158-26" name="__codelineno-158-26" href="#__codelineno-158-26"></a>                <span class="k">continue</span>
<a id="__codelineno-158-27" name="__codelineno-158-27" href="#__codelineno-158-27"></a>
<a id="__codelineno-158-28" name="__codelineno-158-28" href="#__codelineno-158-28"></a>            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-158-29" name="__codelineno-158-29" href="#__codelineno-158-29"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Success with optimistic control&quot;</span><span class="p">)</span>
<a id="__codelineno-158-30" name="__codelineno-158-30" href="#__codelineno-158-30"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-158-31" name="__codelineno-158-31" href="#__codelineno-158-31"></a>
<a id="__codelineno-158-32" name="__codelineno-158-32" href="#__codelineno-158-32"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-158-33" name="__codelineno-158-33" href="#__codelineno-158-33"></a>            <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-158-34" name="__codelineno-158-34" href="#__codelineno-158-34"></a>
<a id="__codelineno-158-35" name="__codelineno-158-35" href="#__codelineno-158-35"></a>    <span class="c1"># Phase 2: Fallback to pessimistic (guaranteed success)</span>
<a id="__codelineno-158-36" name="__codelineno-158-36" href="#__codelineno-158-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too many conflicts, switching to pessimistic control&quot;</span><span class="p">)</span>
<a id="__codelineno-158-37" name="__codelineno-158-37" href="#__codelineno-158-37"></a>
<a id="__codelineno-158-38" name="__codelineno-158-38" href="#__codelineno-158-38"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-158-39" name="__codelineno-158-39" href="#__codelineno-158-39"></a>        <span class="n">db</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<a id="__codelineno-158-40" name="__codelineno-158-40" href="#__codelineno-158-40"></a>
<a id="__codelineno-158-41" name="__codelineno-158-41" href="#__codelineno-158-41"></a>        <span class="c1"># Pessimistic: acquire lock</span>
<a id="__codelineno-158-42" name="__codelineno-158-42" href="#__codelineno-158-42"></a>        <span class="n">balance</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-158-43" name="__codelineno-158-43" href="#__codelineno-158-43"></a><span class="s2">            SELECT balance FROM accounts </span>
<a id="__codelineno-158-44" name="__codelineno-158-44" href="#__codelineno-158-44"></a><span class="s2">            WHERE id = ? </span>
<a id="__codelineno-158-45" name="__codelineno-158-45" href="#__codelineno-158-45"></a><span class="s2">            FOR UPDATE</span>
<a id="__codelineno-158-46" name="__codelineno-158-46" href="#__codelineno-158-46"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">account_id</span><span class="p">])</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-158-47" name="__codelineno-158-47" href="#__codelineno-158-47"></a>
<a id="__codelineno-158-48" name="__codelineno-158-48" href="#__codelineno-158-48"></a>        <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-158-49" name="__codelineno-158-49" href="#__codelineno-158-49"></a>            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">()</span>
<a id="__codelineno-158-50" name="__codelineno-158-50" href="#__codelineno-158-50"></a>
<a id="__codelineno-158-51" name="__codelineno-158-51" href="#__codelineno-158-51"></a>        <span class="c1"># Update (lock held, guaranteed to succeed)</span>
<a id="__codelineno-158-52" name="__codelineno-158-52" href="#__codelineno-158-52"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-158-53" name="__codelineno-158-53" href="#__codelineno-158-53"></a><span class="s2">            UPDATE accounts </span>
<a id="__codelineno-158-54" name="__codelineno-158-54" href="#__codelineno-158-54"></a><span class="s2">            SET balance = balance - ?</span>
<a id="__codelineno-158-55" name="__codelineno-158-55" href="#__codelineno-158-55"></a><span class="s2">            WHERE id = ?</span>
<a id="__codelineno-158-56" name="__codelineno-158-56" href="#__codelineno-158-56"></a><span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">amount</span><span class="p">,</span> <span class="n">account_id</span><span class="p">])</span>
<a id="__codelineno-158-57" name="__codelineno-158-57" href="#__codelineno-158-57"></a>
<a id="__codelineno-158-58" name="__codelineno-158-58" href="#__codelineno-158-58"></a>        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-158-59" name="__codelineno-158-59" href="#__codelineno-158-59"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Success with pessimistic control&quot;</span><span class="p">)</span>
<a id="__codelineno-158-60" name="__codelineno-158-60" href="#__codelineno-158-60"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-158-61" name="__codelineno-158-61" href="#__codelineno-158-61"></a>
<a id="__codelineno-158-62" name="__codelineno-158-62" href="#__codelineno-158-62"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-158-63" name="__codelineno-158-63" href="#__codelineno-158-63"></a>        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-158-64" name="__codelineno-158-64" href="#__codelineno-158-64"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<hr />
<p><strong>Comparison: Deadlock vs Livelock:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a>
<a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a>          DEADLOCK vs LIVELOCK COMPARISON                
<a id="__codelineno-159-3" name="__codelineno-159-3" href="#__codelineno-159-3"></a>
<a id="__codelineno-159-4" name="__codelineno-159-4" href="#__codelineno-159-4"></a>                                                         
<a id="__codelineno-159-5" name="__codelineno-159-5" href="#__codelineno-159-5"></a> DEADLOCK (Pessimistic):                                 
<a id="__codelineno-159-6" name="__codelineno-159-6" href="#__codelineno-159-6"></a>            
<a id="__codelineno-159-7" name="__codelineno-159-7" href="#__codelineno-159-7"></a>   Transactions BLOCKED forever                      
<a id="__codelineno-159-8" name="__codelineno-159-8" href="#__codelineno-159-8"></a>   Waiting for each other (circular)                 
<a id="__codelineno-159-9" name="__codelineno-159-9" href="#__codelineno-159-9"></a>   No progress at all                                
<a id="__codelineno-159-10" name="__codelineno-159-10" href="#__codelineno-159-10"></a>   Requires detection &amp; abort                        
<a id="__codelineno-159-11" name="__codelineno-159-11" href="#__codelineno-159-11"></a>   Example: T1 waits for T2&#39;s lock,                  
<a id="__codelineno-159-12" name="__codelineno-159-12" href="#__codelineno-159-12"></a>            T2 waits for T1&#39;s lock                    
<a id="__codelineno-159-13" name="__codelineno-159-13" href="#__codelineno-159-13"></a>            
<a id="__codelineno-159-14" name="__codelineno-159-14" href="#__codelineno-159-14"></a>                                                         
<a id="__codelineno-159-15" name="__codelineno-159-15" href="#__codelineno-159-15"></a> LIVELOCK (Optimistic):                                  
<a id="__codelineno-159-16" name="__codelineno-159-16" href="#__codelineno-159-16"></a>            
<a id="__codelineno-159-17" name="__codelineno-159-17" href="#__codelineno-159-17"></a>   Transactions keep RETRYING                        
<a id="__codelineno-159-18" name="__codelineno-159-18" href="#__codelineno-159-18"></a>   Active but making no progress                     
<a id="__codelineno-159-19" name="__codelineno-159-19" href="#__codelineno-159-19"></a>   Continuously aborting and restarting              
<a id="__codelineno-159-20" name="__codelineno-159-20" href="#__codelineno-159-20"></a>   Requires backoff &amp; retry limit                    
<a id="__codelineno-159-21" name="__codelineno-159-21" href="#__codelineno-159-21"></a>   Example: T1 commits, T2 retries,                  
<a id="__codelineno-159-22" name="__codelineno-159-22" href="#__codelineno-159-22"></a>            T1 commits again, T2 retries..            
<a id="__codelineno-159-23" name="__codelineno-159-23" href="#__codelineno-159-23"></a>            
<a id="__codelineno-159-24" name="__codelineno-159-24" href="#__codelineno-159-24"></a>                                                         
<a id="__codelineno-159-25" name="__codelineno-159-25" href="#__codelineno-159-25"></a> Visual:                                                 
<a id="__codelineno-159-26" name="__codelineno-159-26" href="#__codelineno-159-26"></a>                                                         
<a id="__codelineno-159-27" name="__codelineno-159-27" href="#__codelineno-159-27"></a> Deadlock:  T1 [BLOCKED]                          
<a id="__codelineno-159-28" name="__codelineno-159-28" href="#__codelineno-159-28"></a>            T2 [BLOCKED]                          
<a id="__codelineno-159-29" name="__codelineno-159-29" href="#__codelineno-159-29"></a>            (Both stopped)                               
<a id="__codelineno-159-30" name="__codelineno-159-30" href="#__codelineno-159-30"></a>                                                         
<a id="__codelineno-159-31" name="__codelineno-159-31" href="#__codelineno-159-31"></a> Livelock:  T1 [RETRY][RETRY][RETRY]         
<a id="__codelineno-159-32" name="__codelineno-159-32" href="#__codelineno-159-32"></a>            T2 [RETRY][RETRY][RETRY]         
<a id="__codelineno-159-33" name="__codelineno-159-33" href="#__codelineno-159-33"></a>            (Both active but failing)                    
<a id="__codelineno-159-34" name="__codelineno-159-34" href="#__codelineno-159-34"></a>                                                         
<a id="__codelineno-159-35" name="__codelineno-159-35" href="#__codelineno-159-35"></a>
</code></pre></div>
<hr />
<h3 id="6-distributed-transactions">6. Distributed Transactions</h3>
<p><strong>Description:</strong></p>
<p>A <strong>distributed transaction</strong> is a transaction that involves operations on data stored across <strong>multiple nodes, databases, or services</strong> in a distributed system. Unlike local transactions that execute entirely within a single database instance, distributed transactions must coordinate operations across network boundaries, dealing with partial failures, network delays, and the fundamental challenges of distributed computing.</p>
<p><strong>The Challenge of Distribution:</strong></p>
<p>When a transaction spans multiple systems, we face the <strong>distributed transaction problem</strong>: How do we ensure that either all participating systems commit the transaction or all abort it, even in the presence of network failures, node crashes, and communication delays?</p>
<p>This is fundamentally harder than local transactions because:
1. <strong>No shared memory</strong>: Nodes can't directly access each other's state
2. <strong>Network unreliability</strong>: Messages can be delayed, lost, or duplicated
3. <strong>Independent failures</strong>: One node can crash while others continue
4. <strong>No global clock</strong>: Hard to determine ordering of events
5. <strong>Partial visibility</strong>: No node has complete view of system state</p>
<p><strong>Historical Context:</strong></p>
<p>Distributed transactions became critical in the 1980s when organizations needed to coordinate operations across:
- Multiple mainframes in different data centers
- Distributed banking networks (ATM networks, wire transfers)
- Airline reservation systems across countries
- Supply chain systems spanning multiple companies</p>
<p>The pioneering work by <strong>Jim Gray</strong> (Turing Award winner, 1998) on transaction processing and the <strong>X/Open XA standard</strong> (1991) provided the foundation for modern distributed transaction protocols.</p>
<p><strong>Real-World Distributed Transaction Examples:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a>
<a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a>         DISTRIBUTED TRANSACTION EXAMPLES                
<a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a>
<a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a>                                                         
<a id="__codelineno-160-5" name="__codelineno-160-5" href="#__codelineno-160-5"></a> 1.  BANK WIRE TRANSFER                                
<a id="__codelineno-160-6" name="__codelineno-160-6" href="#__codelineno-160-6"></a>    Transaction involves:                                
<a id="__codelineno-160-7" name="__codelineno-160-7" href="#__codelineno-160-7"></a>     Bank A database (withdraw from account)            
<a id="__codelineno-160-8" name="__codelineno-160-8" href="#__codelineno-160-8"></a>     Bank B database (deposit to account)               
<a id="__codelineno-160-9" name="__codelineno-160-9" href="#__codelineno-160-9"></a>     Federal Reserve System (record transfer)           
<a id="__codelineno-160-10" name="__codelineno-160-10" href="#__codelineno-160-10"></a>     Audit log database (compliance)                    
<a id="__codelineno-160-11" name="__codelineno-160-11" href="#__codelineno-160-11"></a>                                                         
<a id="__codelineno-160-12" name="__codelineno-160-12" href="#__codelineno-160-12"></a>    Must be atomic: All succeed or all fail              
<a id="__codelineno-160-13" name="__codelineno-160-13" href="#__codelineno-160-13"></a>                                                         
<a id="__codelineno-160-14" name="__codelineno-160-14" href="#__codelineno-160-14"></a> 2.   FLIGHT BOOKING                                   
<a id="__codelineno-160-15" name="__codelineno-160-15" href="#__codelineno-160-15"></a>    Transaction involves:                                
<a id="__codelineno-160-16" name="__codelineno-160-16" href="#__codelineno-160-16"></a>     Airline database (reserve seat)                    
<a id="__codelineno-160-17" name="__codelineno-160-17" href="#__codelineno-160-17"></a>     Hotel database (reserve room)                      
<a id="__codelineno-160-18" name="__codelineno-160-18" href="#__codelineno-160-18"></a>     Car rental database (reserve vehicle)              
<a id="__codelineno-160-19" name="__codelineno-160-19" href="#__codelineno-160-19"></a>     Payment gateway (charge credit card)               
<a id="__codelineno-160-20" name="__codelineno-160-20" href="#__codelineno-160-20"></a>                                                         
<a id="__codelineno-160-21" name="__codelineno-160-21" href="#__codelineno-160-21"></a>    Must be atomic: Book all or cancel all               
<a id="__codelineno-160-22" name="__codelineno-160-22" href="#__codelineno-160-22"></a>                                                         
<a id="__codelineno-160-23" name="__codelineno-160-23" href="#__codelineno-160-23"></a> 3.  E-COMMERCE ORDER                                  
<a id="__codelineno-160-24" name="__codelineno-160-24" href="#__codelineno-160-24"></a>    Transaction involves:                                
<a id="__codelineno-160-25" name="__codelineno-160-25" href="#__codelineno-160-25"></a>     Inventory service (reserve items)                  
<a id="__codelineno-160-26" name="__codelineno-160-26" href="#__codelineno-160-26"></a>     Payment service (process payment)                  
<a id="__codelineno-160-27" name="__codelineno-160-27" href="#__codelineno-160-27"></a>     Shipping service (create shipment)                 
<a id="__codelineno-160-28" name="__codelineno-160-28" href="#__codelineno-160-28"></a>     Customer service (update order history)            
<a id="__codelineno-160-29" name="__codelineno-160-29" href="#__codelineno-160-29"></a>                                                         
<a id="__codelineno-160-30" name="__codelineno-160-30" href="#__codelineno-160-30"></a>    Must be atomic: Complete order or rollback           
<a id="__codelineno-160-31" name="__codelineno-160-31" href="#__codelineno-160-31"></a>                                                         
<a id="__codelineno-160-32" name="__codelineno-160-32" href="#__codelineno-160-32"></a> 4.  MICROSERVICES SAGA                                
<a id="__codelineno-160-33" name="__codelineno-160-33" href="#__codelineno-160-33"></a>    Transaction involves:                                
<a id="__codelineno-160-34" name="__codelineno-160-34" href="#__codelineno-160-34"></a>     User service (update profile)                      
<a id="__codelineno-160-35" name="__codelineno-160-35" href="#__codelineno-160-35"></a>     Notification service (send email)                  
<a id="__codelineno-160-36" name="__codelineno-160-36" href="#__codelineno-160-36"></a>     Analytics service (log event)                      
<a id="__codelineno-160-37" name="__codelineno-160-37" href="#__codelineno-160-37"></a>     Billing service (update credits)                   
<a id="__codelineno-160-38" name="__codelineno-160-38" href="#__codelineno-160-38"></a>                                                         
<a id="__codelineno-160-39" name="__codelineno-160-39" href="#__codelineno-160-39"></a>    Must be consistent across all services               
<a id="__codelineno-160-40" name="__codelineno-160-40" href="#__codelineno-160-40"></a>                                                         
<a id="__codelineno-160-41" name="__codelineno-160-41" href="#__codelineno-160-41"></a>
</code></pre></div>
<p><strong>Distributed Transaction Architecture:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a>
<a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a>      DISTRIBUTED TRANSACTION ARCHITECTURE               
<a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a>
<a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a>                                                         
<a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a>                                         
<a id="__codelineno-161-6" name="__codelineno-161-6" href="#__codelineno-161-6"></a>                   APPLICATION                         
<a id="__codelineno-161-7" name="__codelineno-161-7" href="#__codelineno-161-7"></a>                   (Initiator)                         
<a id="__codelineno-161-8" name="__codelineno-161-8" href="#__codelineno-161-8"></a>                                         
<a id="__codelineno-161-9" name="__codelineno-161-9" href="#__codelineno-161-9"></a>                                                        
<a id="__codelineno-161-10" name="__codelineno-161-10" href="#__codelineno-161-10"></a>                          BEGIN DISTRIBUTED TXN         
<a id="__codelineno-161-11" name="__codelineno-161-11" href="#__codelineno-161-11"></a>                                                        
<a id="__codelineno-161-12" name="__codelineno-161-12" href="#__codelineno-161-12"></a>                                  
<a id="__codelineno-161-13" name="__codelineno-161-13" href="#__codelineno-161-13"></a>               TRANSACTION                             
<a id="__codelineno-161-14" name="__codelineno-161-14" href="#__codelineno-161-14"></a>               COORDINATOR                             
<a id="__codelineno-161-15" name="__codelineno-161-15" href="#__codelineno-161-15"></a>               (Orchestrator)                          
<a id="__codelineno-161-16" name="__codelineno-161-16" href="#__codelineno-161-16"></a>                                  
<a id="__codelineno-161-17" name="__codelineno-161-17" href="#__codelineno-161-17"></a>                                                        
<a id="__codelineno-161-18" name="__codelineno-161-18" href="#__codelineno-161-18"></a>                   
<a id="__codelineno-161-19" name="__codelineno-161-19" href="#__codelineno-161-19"></a>                                                    
<a id="__codelineno-161-20" name="__codelineno-161-20" href="#__codelineno-161-20"></a>                                                    
<a id="__codelineno-161-21" name="__codelineno-161-21" href="#__codelineno-161-21"></a>               
<a id="__codelineno-161-22" name="__codelineno-161-22" href="#__codelineno-161-22"></a>     Node 1    Node 2    Node 3    Node 4      
<a id="__codelineno-161-23" name="__codelineno-161-23" href="#__codelineno-161-23"></a>    Database  Database  Database  Database     
<a id="__codelineno-161-24" name="__codelineno-161-24" href="#__codelineno-161-24"></a>                                               
<a id="__codelineno-161-25" name="__codelineno-161-25" href="#__codelineno-161-25"></a>     [Data]    [Data]    [Data]    [Data]      
<a id="__codelineno-161-26" name="__codelineno-161-26" href="#__codelineno-161-26"></a>               
<a id="__codelineno-161-27" name="__codelineno-161-27" href="#__codelineno-161-27"></a>                                                         
<a id="__codelineno-161-28" name="__codelineno-161-28" href="#__codelineno-161-28"></a>    Participants                                         
<a id="__codelineno-161-29" name="__codelineno-161-29" href="#__codelineno-161-29"></a>    (Execute local operations)                           
<a id="__codelineno-161-30" name="__codelineno-161-30" href="#__codelineno-161-30"></a>                                                         
<a id="__codelineno-161-31" name="__codelineno-161-31" href="#__codelineno-161-31"></a> Flow:                                                   
<a id="__codelineno-161-32" name="__codelineno-161-32" href="#__codelineno-161-32"></a> 1. Application sends transaction to coordinator         
<a id="__codelineno-161-33" name="__codelineno-161-33" href="#__codelineno-161-33"></a> 2. Coordinator distributes operations to participants   
<a id="__codelineno-161-34" name="__codelineno-161-34" href="#__codelineno-161-34"></a> 3. Each participant executes locally                    
<a id="__codelineno-161-35" name="__codelineno-161-35" href="#__codelineno-161-35"></a> 4. Coordinator ensures all commit or all abort          
<a id="__codelineno-161-36" name="__codelineno-161-36" href="#__codelineno-161-36"></a>                                                         
<a id="__codelineno-161-37" name="__codelineno-161-37" href="#__codelineno-161-37"></a>
</code></pre></div>
<p><strong>Key Components:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a>
<a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a>    DISTRIBUTED TRANSACTION COMPONENTS                   
<a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a>
<a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a>                                                         
<a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a> 1. COORDINATOR (Transaction Manager)                    
<a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a>                
<a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a>      Initiates distributed transaction              
<a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a>      Tracks all participants                        
<a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a>      Manages commit/abort protocol                  
<a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a>      Maintains transaction log                      
<a id="__codelineno-162-11" name="__codelineno-162-11" href="#__codelineno-162-11"></a>      Handles failure recovery                       
<a id="__codelineno-162-12" name="__codelineno-162-12" href="#__codelineno-162-12"></a>                
<a id="__codelineno-162-13" name="__codelineno-162-13" href="#__codelineno-162-13"></a>                                                         
<a id="__codelineno-162-14" name="__codelineno-162-14" href="#__codelineno-162-14"></a> 2. PARTICIPANTS (Resource Managers)                     
<a id="__codelineno-162-15" name="__codelineno-162-15" href="#__codelineno-162-15"></a>                
<a id="__codelineno-162-16" name="__codelineno-162-16" href="#__codelineno-162-16"></a>      Execute local transaction ops                  
<a id="__codelineno-162-17" name="__codelineno-162-17" href="#__codelineno-162-17"></a>      Prepare for commit (vote)                      
<a id="__codelineno-162-18" name="__codelineno-162-18" href="#__codelineno-162-18"></a>      Commit or abort on coordinator cmd             
<a id="__codelineno-162-19" name="__codelineno-162-19" href="#__codelineno-162-19"></a>      Maintain local transaction logs                
<a id="__codelineno-162-20" name="__codelineno-162-20" href="#__codelineno-162-20"></a>      Respond to coordinator queries                 
<a id="__codelineno-162-21" name="__codelineno-162-21" href="#__codelineno-162-21"></a>                
<a id="__codelineno-162-22" name="__codelineno-162-22" href="#__codelineno-162-22"></a>                                                         
<a id="__codelineno-162-23" name="__codelineno-162-23" href="#__codelineno-162-23"></a> 3. TRANSACTION LOG                                      
<a id="__codelineno-162-24" name="__codelineno-162-24" href="#__codelineno-162-24"></a>                
<a id="__codelineno-162-25" name="__codelineno-162-25" href="#__codelineno-162-25"></a>      Records transaction state                      
<a id="__codelineno-162-26" name="__codelineno-162-26" href="#__codelineno-162-26"></a>      Enables crash recovery                         
<a id="__codelineno-162-27" name="__codelineno-162-27" href="#__codelineno-162-27"></a>      Written before state changes                   
<a id="__codelineno-162-28" name="__codelineno-162-28" href="#__codelineno-162-28"></a>      Persisted to durable storage                   
<a id="__codelineno-162-29" name="__codelineno-162-29" href="#__codelineno-162-29"></a>                
<a id="__codelineno-162-30" name="__codelineno-162-30" href="#__codelineno-162-30"></a>                                                         
<a id="__codelineno-162-31" name="__codelineno-162-31" href="#__codelineno-162-31"></a>
</code></pre></div>
<p><strong>Distributed Transaction Lifecycle:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a>
<a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a>      DISTRIBUTED TRANSACTION LIFECYCLE                  
<a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a>
<a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a>                                                         
<a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a> Phase 1: INITIATION                                     
<a id="__codelineno-163-6" name="__codelineno-163-6" href="#__codelineno-163-6"></a>                                     
<a id="__codelineno-163-7" name="__codelineno-163-7" href="#__codelineno-163-7"></a>  Application starts transaction                        
<a id="__codelineno-163-8" name="__codelineno-163-8" href="#__codelineno-163-8"></a>  Coordinator assigns global transaction ID             
<a id="__codelineno-163-9" name="__codelineno-163-9" href="#__codelineno-163-9"></a>  Coordinator records transaction start                 
<a id="__codelineno-163-10" name="__codelineno-163-10" href="#__codelineno-163-10"></a>                                                         
<a id="__codelineno-163-11" name="__codelineno-163-11" href="#__codelineno-163-11"></a> Phase 2: EXECUTION                                      
<a id="__codelineno-163-12" name="__codelineno-163-12" href="#__codelineno-163-12"></a>                                     
<a id="__codelineno-163-13" name="__codelineno-163-13" href="#__codelineno-163-13"></a>  Application sends operations to coordinator           
<a id="__codelineno-163-14" name="__codelineno-163-14" href="#__codelineno-163-14"></a>  Coordinator forwards to appropriate participants      
<a id="__codelineno-163-15" name="__codelineno-163-15" href="#__codelineno-163-15"></a>  Each participant executes locally                     
<a id="__codelineno-163-16" name="__codelineno-163-16" href="#__codelineno-163-16"></a>  Participants hold locks on modified data              
<a id="__codelineno-163-17" name="__codelineno-163-17" href="#__codelineno-163-17"></a>                                                         
<a id="__codelineno-163-18" name="__codelineno-163-18" href="#__codelineno-163-18"></a> Phase 3: COORDINATION (Commit Protocol)                 
<a id="__codelineno-163-19" name="__codelineno-163-19" href="#__codelineno-163-19"></a>                                     
<a id="__codelineno-163-20" name="__codelineno-163-20" href="#__codelineno-163-20"></a>  Coordinator initiates commit protocol                 
<a id="__codelineno-163-21" name="__codelineno-163-21" href="#__codelineno-163-21"></a>  Participants vote (YES/NO to commit)                  
<a id="__codelineno-163-22" name="__codelineno-163-22" href="#__codelineno-163-22"></a>  Coordinator decides based on votes                    
<a id="__codelineno-163-23" name="__codelineno-163-23" href="#__codelineno-163-23"></a>  Decision propagated to all participants               
<a id="__codelineno-163-24" name="__codelineno-163-24" href="#__codelineno-163-24"></a>                                                         
<a id="__codelineno-163-25" name="__codelineno-163-25" href="#__codelineno-163-25"></a> Phase 4: COMPLETION                                     
<a id="__codelineno-163-26" name="__codelineno-163-26" href="#__codelineno-163-26"></a>                                     
<a id="__codelineno-163-27" name="__codelineno-163-27" href="#__codelineno-163-27"></a>  All participants commit or abort                      
<a id="__codelineno-163-28" name="__codelineno-163-28" href="#__codelineno-163-28"></a>  Locks released                                        
<a id="__codelineno-163-29" name="__codelineno-163-29" href="#__codelineno-163-29"></a>  Transaction marked complete                           
<a id="__codelineno-163-30" name="__codelineno-163-30" href="#__codelineno-163-30"></a>  Resources cleaned up                                  
<a id="__codelineno-163-31" name="__codelineno-163-31" href="#__codelineno-163-31"></a>                                                         
<a id="__codelineno-163-32" name="__codelineno-163-32" href="#__codelineno-163-32"></a>
</code></pre></div>
<p><strong>Challenges in Distributed Transactions:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a>
<a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a>    CHALLENGES IN DISTRIBUTED TRANSACTIONS               
<a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a>
<a id="__codelineno-164-4" name="__codelineno-164-4" href="#__codelineno-164-4"></a>                                                         
<a id="__codelineno-164-5" name="__codelineno-164-5" href="#__codelineno-164-5"></a> 1.  PARTIAL FAILURES                                  
<a id="__codelineno-164-6" name="__codelineno-164-6" href="#__codelineno-164-6"></a>     Some participants succeed, others fail             
<a id="__codelineno-164-7" name="__codelineno-164-7" href="#__codelineno-164-7"></a>     Network partition isolates nodes                   
<a id="__codelineno-164-8" name="__codelineno-164-8" href="#__codelineno-164-8"></a>     Must ensure atomicity across failures              
<a id="__codelineno-164-9" name="__codelineno-164-9" href="#__codelineno-164-9"></a>                                                         
<a id="__codelineno-164-10" name="__codelineno-164-10" href="#__codelineno-164-10"></a> 2.  NETWORK DELAYS &amp; TIMEOUTS                         
<a id="__codelineno-164-11" name="__codelineno-164-11" href="#__codelineno-164-11"></a>     Messages delayed unpredictably                     
<a id="__codelineno-164-12" name="__codelineno-164-12" href="#__codelineno-164-12"></a>     Hard to distinguish slow node from dead node       
<a id="__codelineno-164-13" name="__codelineno-164-13" href="#__codelineno-164-13"></a>     Timeout too short: false failures                  
<a id="__codelineno-164-14" name="__codelineno-164-14" href="#__codelineno-164-14"></a>     Timeout too long: poor performance                 
<a id="__codelineno-164-15" name="__codelineno-164-15" href="#__codelineno-164-15"></a>                                                         
<a id="__codelineno-164-16" name="__codelineno-164-16" href="#__codelineno-164-16"></a> 3.  COORDINATOR FAILURE                               
<a id="__codelineno-164-17" name="__codelineno-164-17" href="#__codelineno-164-17"></a>     Single point of failure                            
<a id="__codelineno-164-18" name="__codelineno-164-18" href="#__codelineno-164-18"></a>     If coordinator crashes, participants blocked       
<a id="__codelineno-164-19" name="__codelineno-164-19" href="#__codelineno-164-19"></a>     Recovery requires stable storage                   
<a id="__codelineno-164-20" name="__codelineno-164-20" href="#__codelineno-164-20"></a>                                                         
<a id="__codelineno-164-21" name="__codelineno-164-21" href="#__codelineno-164-21"></a> 4.  BLOCKING &amp; REDUCED AVAILABILITY                   
<a id="__codelineno-164-22" name="__codelineno-164-22" href="#__codelineno-164-22"></a>     Participants must wait for coordinator             
<a id="__codelineno-164-23" name="__codelineno-164-23" href="#__codelineno-164-23"></a>     Locks held during coordination (reduces throughput)
<a id="__codelineno-164-24" name="__codelineno-164-24" href="#__codelineno-164-24"></a>     System unavailable during coordinator recovery     
<a id="__codelineno-164-25" name="__codelineno-164-25" href="#__codelineno-164-25"></a>                                                         
<a id="__codelineno-164-26" name="__codelineno-164-26" href="#__codelineno-164-26"></a> 5.  CAP THEOREM CONSTRAINTS                           
<a id="__codelineno-164-27" name="__codelineno-164-27" href="#__codelineno-164-27"></a>     Cannot have Consistency + Availability + Partition 
<a id="__codelineno-164-28" name="__codelineno-164-28" href="#__codelineno-164-28"></a>     Distributed transactions sacrifice Availability    
<a id="__codelineno-164-29" name="__codelineno-164-29" href="#__codelineno-164-29"></a>     Network partition can block progress               
<a id="__codelineno-164-30" name="__codelineno-164-30" href="#__codelineno-164-30"></a>                                                         
<a id="__codelineno-164-31" name="__codelineno-164-31" href="#__codelineno-164-31"></a> 6.  PERFORMANCE OVERHEAD                              
<a id="__codelineno-164-32" name="__codelineno-164-32" href="#__codelineno-164-32"></a>     Multiple network round trips                       
<a id="__codelineno-164-33" name="__codelineno-164-33" href="#__codelineno-164-33"></a>     Synchronous coordination (latency)                 
<a id="__codelineno-164-34" name="__codelineno-164-34" href="#__codelineno-164-34"></a>     Logging overhead at each node                      
<a id="__codelineno-164-35" name="__codelineno-164-35" href="#__codelineno-164-35"></a>     10-100x slower than local transactions             
<a id="__codelineno-164-36" name="__codelineno-164-36" href="#__codelineno-164-36"></a>                                                         
<a id="__codelineno-164-37" name="__codelineno-164-37" href="#__codelineno-164-37"></a>
</code></pre></div>
<hr />
<h4 id="61-two-phase-commit-2pc-protocol">6.1 Two-Phase Commit (2PC) Protocol</h4>
<p><strong>Description:</strong></p>
<p><strong>Two-Phase Commit (2PC)</strong> is the most widely used protocol for coordinating distributed transactions. Developed in the 1970s and standardized in the X/Open XA specification, 2PC ensures that all participants in a distributed transaction either commit or abort together, maintaining atomicity across multiple nodes.</p>
<p>The protocol is called "two-phase" because it operates in two distinct phases: a <strong>voting phase</strong> (prepare) and a <strong>decision phase</strong> (commit/abort). This separation ensures that the coordinator can collect votes from all participants before making a final decision.</p>
<p><strong>Historical Significance:</strong></p>
<p>Jim Gray's work on transaction processing at IBM in the 1970s introduced 2PC as part of the System R project. His insight was that distributed consensus requires:
1. <strong>Unanimous agreement</strong>: All participants must agree to commit
2. <strong>Stable storage</strong>: Decisions must survive crashes
3. <strong>Blocking tolerance</strong>: System must handle failures gracefully</p>
<p>2PC became the foundation for:
- <strong>X/Open XA</strong> (1991): Industry standard for distributed transactions
- <strong>Java Transaction API (JTA)</strong>: Java's distributed transaction support
- <strong>WS-AtomicTransaction</strong>: Web services transaction protocol
- <strong>Database vendor implementations</strong>: Oracle, DB2, SQL Server, PostgreSQL</p>
<p><strong>The Two-Phase Commit Protocol:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a>
<a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a>         TWO-PHASE COMMIT (2PC) PROTOCOL                 
<a id="__codelineno-165-3" name="__codelineno-165-3" href="#__codelineno-165-3"></a>
<a id="__codelineno-165-4" name="__codelineno-165-4" href="#__codelineno-165-4"></a>                                                         
<a id="__codelineno-165-5" name="__codelineno-165-5" href="#__codelineno-165-5"></a> PHASE 1: VOTING (PREPARE PHASE)                         
<a id="__codelineno-165-6" name="__codelineno-165-6" href="#__codelineno-165-6"></a>                          
<a id="__codelineno-165-7" name="__codelineno-165-7" href="#__codelineno-165-7"></a>                                                         
<a id="__codelineno-165-8" name="__codelineno-165-8" href="#__codelineno-165-8"></a>   Coordinator                Participants               
<a id="__codelineno-165-9" name="__codelineno-165-9" href="#__codelineno-165-9"></a>                                                        
<a id="__codelineno-165-10" name="__codelineno-165-10" href="#__codelineno-165-10"></a>         1. PREPARE?                                    
<a id="__codelineno-165-11" name="__codelineno-165-11" href="#__codelineno-165-11"></a>                                     
<a id="__codelineno-165-12" name="__codelineno-165-12" href="#__codelineno-165-12"></a>                          Participant 1       
<a id="__codelineno-165-13" name="__codelineno-165-13" href="#__codelineno-165-13"></a>                                    Execute ops       
<a id="__codelineno-165-14" name="__codelineno-165-14" href="#__codelineno-165-14"></a>                                    Acquire locks     
<a id="__codelineno-165-15" name="__codelineno-165-15" href="#__codelineno-165-15"></a>                                    Write undo/redo   
<a id="__codelineno-165-16" name="__codelineno-165-16" href="#__codelineno-165-16"></a>                                    Vote YES/NO       
<a id="__codelineno-165-17" name="__codelineno-165-17" href="#__codelineno-165-17"></a>                                                       
<a id="__codelineno-165-18" name="__codelineno-165-18" href="#__codelineno-165-18"></a>                          Participant 2       
<a id="__codelineno-165-19" name="__codelineno-165-19" href="#__codelineno-165-19"></a>                                    Execute ops       
<a id="__codelineno-165-20" name="__codelineno-165-20" href="#__codelineno-165-20"></a>                                    Vote YES/NO       
<a id="__codelineno-165-21" name="__codelineno-165-21" href="#__codelineno-165-21"></a>                                                       
<a id="__codelineno-165-22" name="__codelineno-165-22" href="#__codelineno-165-22"></a>                          Participant 3       
<a id="__codelineno-165-23" name="__codelineno-165-23" href="#__codelineno-165-23"></a>                                     Execute ops       
<a id="__codelineno-165-24" name="__codelineno-165-24" href="#__codelineno-165-24"></a>                                     Vote YES/NO       
<a id="__codelineno-165-25" name="__codelineno-165-25" href="#__codelineno-165-25"></a>                                                        
<a id="__codelineno-165-26" name="__codelineno-165-26" href="#__codelineno-165-26"></a>         2. Collect votes                               
<a id="__codelineno-165-27" name="__codelineno-165-27" href="#__codelineno-165-27"></a>        YES (ready to commit)       
<a id="__codelineno-165-28" name="__codelineno-165-28" href="#__codelineno-165-28"></a>        YES (ready to commit)       
<a id="__codelineno-165-29" name="__codelineno-165-29" href="#__codelineno-165-29"></a>        NO  (cannot commit)         
<a id="__codelineno-165-30" name="__codelineno-165-30" href="#__codelineno-165-30"></a>                                                        
<a id="__codelineno-165-31" name="__codelineno-165-31" href="#__codelineno-165-31"></a>         3. Decision: ABORT (any NO  ABORT)            
<a id="__codelineno-165-32" name="__codelineno-165-32" href="#__codelineno-165-32"></a>                     COMMIT (all YES  COMMIT)          
<a id="__codelineno-165-33" name="__codelineno-165-33" href="#__codelineno-165-33"></a>                                                        
<a id="__codelineno-165-34" name="__codelineno-165-34" href="#__codelineno-165-34"></a>        
<a id="__codelineno-165-35" name="__codelineno-165-35" href="#__codelineno-165-35"></a>                                                         
<a id="__codelineno-165-36" name="__codelineno-165-36" href="#__codelineno-165-36"></a> PHASE 2: DECISION (COMMIT PHASE)                        
<a id="__codelineno-165-37" name="__codelineno-165-37" href="#__codelineno-165-37"></a>                          
<a id="__codelineno-165-38" name="__codelineno-165-38" href="#__codelineno-165-38"></a>                                                         
<a id="__codelineno-165-39" name="__codelineno-165-39" href="#__codelineno-165-39"></a>         4. Send decision                               
<a id="__codelineno-165-40" name="__codelineno-165-40" href="#__codelineno-165-40"></a>                                     
<a id="__codelineno-165-41" name="__codelineno-165-41" href="#__codelineno-165-41"></a>                          Participant 1       
<a id="__codelineno-165-42" name="__codelineno-165-42" href="#__codelineno-165-42"></a>          COMMIT/ABORT              Commit/Rollback   
<a id="__codelineno-165-43" name="__codelineno-165-43" href="#__codelineno-165-43"></a>                                    Release locks     
<a id="__codelineno-165-44" name="__codelineno-165-44" href="#__codelineno-165-44"></a>                                    Send ACK          
<a id="__codelineno-165-45" name="__codelineno-165-45" href="#__codelineno-165-45"></a>                                                       
<a id="__codelineno-165-46" name="__codelineno-165-46" href="#__codelineno-165-46"></a>                          Participant 2       
<a id="__codelineno-165-47" name="__codelineno-165-47" href="#__codelineno-165-47"></a>                                    Commit/Rollback   
<a id="__codelineno-165-48" name="__codelineno-165-48" href="#__codelineno-165-48"></a>                                    Send ACK          
<a id="__codelineno-165-49" name="__codelineno-165-49" href="#__codelineno-165-49"></a>                                                       
<a id="__codelineno-165-50" name="__codelineno-165-50" href="#__codelineno-165-50"></a>                          Participant 3       
<a id="__codelineno-165-51" name="__codelineno-165-51" href="#__codelineno-165-51"></a>                                     Commit/Rollback   
<a id="__codelineno-165-52" name="__codelineno-165-52" href="#__codelineno-165-52"></a>                                     Send ACK          
<a id="__codelineno-165-53" name="__codelineno-165-53" href="#__codelineno-165-53"></a>                                                        
<a id="__codelineno-165-54" name="__codelineno-165-54" href="#__codelineno-165-54"></a>         5. Collect ACKs                                
<a id="__codelineno-165-55" name="__codelineno-165-55" href="#__codelineno-165-55"></a>        ACK                         
<a id="__codelineno-165-56" name="__codelineno-165-56" href="#__codelineno-165-56"></a>        ACK                         
<a id="__codelineno-165-57" name="__codelineno-165-57" href="#__codelineno-165-57"></a>        ACK                         
<a id="__codelineno-165-58" name="__codelineno-165-58" href="#__codelineno-165-58"></a>                                                        
<a id="__codelineno-165-59" name="__codelineno-165-59" href="#__codelineno-165-59"></a>         6. Transaction complete                        
<a id="__codelineno-165-60" name="__codelineno-165-60" href="#__codelineno-165-60"></a>                                                        
<a id="__codelineno-165-61" name="__codelineno-165-61" href="#__codelineno-165-61"></a>                                                         
<a id="__codelineno-165-62" name="__codelineno-165-62" href="#__codelineno-165-62"></a>
</code></pre></div>
<p><strong>Detailed Timeline - Successful Commit:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a>
<a id="__codelineno-166-2" name="__codelineno-166-2" href="#__codelineno-166-2"></a>       2PC TIMELINE - SUCCESSFUL COMMIT                  
<a id="__codelineno-166-3" name="__codelineno-166-3" href="#__codelineno-166-3"></a>
<a id="__codelineno-166-4" name="__codelineno-166-4" href="#__codelineno-166-4"></a>                                                         
<a id="__codelineno-166-5" name="__codelineno-166-5" href="#__codelineno-166-5"></a> Time  Coordinator        Participant A    Participant B 
<a id="__codelineno-166-6" name="__codelineno-166-6" href="#__codelineno-166-6"></a>  
<a id="__codelineno-166-7" name="__codelineno-166-7" href="#__codelineno-166-7"></a>                                                         
<a id="__codelineno-166-8" name="__codelineno-166-8" href="#__codelineno-166-8"></a> t1    BEGIN                                             
<a id="__codelineno-166-9" name="__codelineno-166-9" href="#__codelineno-166-9"></a>       Generate TXN-ID                                   
<a id="__codelineno-166-10" name="__codelineno-166-10" href="#__codelineno-166-10"></a>                                                         
<a id="__codelineno-166-11" name="__codelineno-166-11" href="#__codelineno-166-11"></a> t2    Send operations                                   
<a id="__codelineno-166-12" name="__codelineno-166-12" href="#__codelineno-166-12"></a>         Execute ops      Execute ops    
<a id="__codelineno-166-13" name="__codelineno-166-13" href="#__codelineno-166-13"></a>                        Lock resources   Lock resources 
<a id="__codelineno-166-14" name="__codelineno-166-14" href="#__codelineno-166-14"></a>                                                        
<a id="__codelineno-166-15" name="__codelineno-166-15" href="#__codelineno-166-15"></a>  PHASE 1: VOTING    
<a id="__codelineno-166-16" name="__codelineno-166-16" href="#__codelineno-166-16"></a>                                                         
<a id="__codelineno-166-17" name="__codelineno-166-17" href="#__codelineno-166-17"></a> t3    PREPARE?                                          
<a id="__codelineno-166-18" name="__codelineno-166-18" href="#__codelineno-166-18"></a>         PREPARE?         PREPARE?       
<a id="__codelineno-166-19" name="__codelineno-166-19" href="#__codelineno-166-19"></a>                                                        
<a id="__codelineno-166-20" name="__codelineno-166-20" href="#__codelineno-166-20"></a> t4                      Write PREPARE    Write PREPARE  
<a id="__codelineno-166-21" name="__codelineno-166-21" href="#__codelineno-166-21"></a>                         log              log            
<a id="__codelineno-166-22" name="__codelineno-166-22" href="#__codelineno-166-22"></a>                                                         
<a id="__codelineno-166-23" name="__codelineno-166-23" href="#__codelineno-166-23"></a> t5                      Vote: YES        Vote: YES      
<a id="__codelineno-166-24" name="__codelineno-166-24" href="#__codelineno-166-24"></a>                                     
<a id="__codelineno-166-25" name="__codelineno-166-25" href="#__codelineno-166-25"></a>       Collect votes                                   
<a id="__codelineno-166-26" name="__codelineno-166-26" href="#__codelineno-166-26"></a>       All YES!                                        
<a id="__codelineno-166-27" name="__codelineno-166-27" href="#__codelineno-166-27"></a>                                                       
<a id="__codelineno-166-28" name="__codelineno-166-28" href="#__codelineno-166-28"></a> t6    Write COMMIT                                    
<a id="__codelineno-166-29" name="__codelineno-166-29" href="#__codelineno-166-29"></a>       decision to log                                 
<a id="__codelineno-166-30" name="__codelineno-166-30" href="#__codelineno-166-30"></a>       (durable)                                       
<a id="__codelineno-166-31" name="__codelineno-166-31" href="#__codelineno-166-31"></a>                                                       
<a id="__codelineno-166-32" name="__codelineno-166-32" href="#__codelineno-166-32"></a>  PHASE 2: DECISION    
<a id="__codelineno-166-33" name="__codelineno-166-33" href="#__codelineno-166-33"></a>                                                         
<a id="__codelineno-166-34" name="__codelineno-166-34" href="#__codelineno-166-34"></a> t7    COMMIT!                                         
<a id="__codelineno-166-35" name="__codelineno-166-35" href="#__codelineno-166-35"></a>         COMMIT!         COMMIT!         
<a id="__codelineno-166-36" name="__codelineno-166-36" href="#__codelineno-166-36"></a>                                                        
<a id="__codelineno-166-37" name="__codelineno-166-37" href="#__codelineno-166-37"></a> t8                      Write COMMIT    Write COMMIT    
<a id="__codelineno-166-38" name="__codelineno-166-38" href="#__codelineno-166-38"></a>                         to log          to log          
<a id="__codelineno-166-39" name="__codelineno-166-39" href="#__codelineno-166-39"></a>                                                         
<a id="__codelineno-166-40" name="__codelineno-166-40" href="#__codelineno-166-40"></a> t9                      Apply changes   Apply changes   
<a id="__codelineno-166-41" name="__codelineno-166-41" href="#__codelineno-166-41"></a>                         Release locks   Release locks   
<a id="__codelineno-166-42" name="__codelineno-166-42" href="#__codelineno-166-42"></a>                                                         
<a id="__codelineno-166-43" name="__codelineno-166-43" href="#__codelineno-166-43"></a> t10                     ACK             ACK             
<a id="__codelineno-166-44" name="__codelineno-166-44" href="#__codelineno-166-44"></a>                                     
<a id="__codelineno-166-45" name="__codelineno-166-45" href="#__codelineno-166-45"></a>       All ACKs received                               
<a id="__codelineno-166-46" name="__codelineno-166-46" href="#__codelineno-166-46"></a>                                                       
<a id="__codelineno-166-47" name="__codelineno-166-47" href="#__codelineno-166-47"></a> t11   Write END                                       
<a id="__codelineno-166-48" name="__codelineno-166-48" href="#__codelineno-166-48"></a>       Transaction done  Done            Done            
<a id="__codelineno-166-49" name="__codelineno-166-49" href="#__codelineno-166-49"></a>                                                         
<a id="__codelineno-166-50" name="__codelineno-166-50" href="#__codelineno-166-50"></a>  RESULT: All committed successfully                   
<a id="__codelineno-166-51" name="__codelineno-166-51" href="#__codelineno-166-51"></a>                                                         
<a id="__codelineno-166-52" name="__codelineno-166-52" href="#__codelineno-166-52"></a>
</code></pre></div>
<p><strong>Detailed Timeline - Abort Scenario:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a>
<a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a>       2PC TIMELINE - ABORT SCENARIO                     
<a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a>
<a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a>                                                         
<a id="__codelineno-167-5" name="__codelineno-167-5" href="#__codelineno-167-5"></a> Time  Coordinator        Participant A    Participant B 
<a id="__codelineno-167-6" name="__codelineno-167-6" href="#__codelineno-167-6"></a>  
<a id="__codelineno-167-7" name="__codelineno-167-7" href="#__codelineno-167-7"></a>                                                         
<a id="__codelineno-167-8" name="__codelineno-167-8" href="#__codelineno-167-8"></a> t1-   Same as commit scenario...                        
<a id="__codelineno-167-9" name="__codelineno-167-9" href="#__codelineno-167-9"></a> t2                                                      
<a id="__codelineno-167-10" name="__codelineno-167-10" href="#__codelineno-167-10"></a>                                                         
<a id="__codelineno-167-11" name="__codelineno-167-11" href="#__codelineno-167-11"></a>  PHASE 1: VOTING    
<a id="__codelineno-167-12" name="__codelineno-167-12" href="#__codelineno-167-12"></a>                                                         
<a id="__codelineno-167-13" name="__codelineno-167-13" href="#__codelineno-167-13"></a> t3    PREPARE?                                          
<a id="__codelineno-167-14" name="__codelineno-167-14" href="#__codelineno-167-14"></a>         PREPARE?         PREPARE?       
<a id="__codelineno-167-15" name="__codelineno-167-15" href="#__codelineno-167-15"></a>                                                        
<a id="__codelineno-167-16" name="__codelineno-167-16" href="#__codelineno-167-16"></a> t4                      Write PREPARE    [CONSTRAINT    
<a id="__codelineno-167-17" name="__codelineno-167-17" href="#__codelineno-167-17"></a>                         log              VIOLATION!]    
<a id="__codelineno-167-18" name="__codelineno-167-18" href="#__codelineno-167-18"></a>                                                         
<a id="__codelineno-167-19" name="__codelineno-167-19" href="#__codelineno-167-19"></a> t5                      Vote: YES        Vote: NO     
<a id="__codelineno-167-20" name="__codelineno-167-20" href="#__codelineno-167-20"></a>                                     
<a id="__codelineno-167-21" name="__codelineno-167-21" href="#__codelineno-167-21"></a>       Collect votes                    (Cannot commit) 
<a id="__codelineno-167-22" name="__codelineno-167-22" href="#__codelineno-167-22"></a>       Got NO!  ABORT                                 
<a id="__codelineno-167-23" name="__codelineno-167-23" href="#__codelineno-167-23"></a>                                                       
<a id="__codelineno-167-24" name="__codelineno-167-24" href="#__codelineno-167-24"></a> t6    Write ABORT                                     
<a id="__codelineno-167-25" name="__codelineno-167-25" href="#__codelineno-167-25"></a>       decision to log                                 
<a id="__codelineno-167-26" name="__codelineno-167-26" href="#__codelineno-167-26"></a>       (durable)                                       
<a id="__codelineno-167-27" name="__codelineno-167-27" href="#__codelineno-167-27"></a>                                                       
<a id="__codelineno-167-28" name="__codelineno-167-28" href="#__codelineno-167-28"></a>  PHASE 2: DECISION    
<a id="__codelineno-167-29" name="__codelineno-167-29" href="#__codelineno-167-29"></a>                                                         
<a id="__codelineno-167-30" name="__codelineno-167-30" href="#__codelineno-167-30"></a> t7    ABORT!                                          
<a id="__codelineno-167-31" name="__codelineno-167-31" href="#__codelineno-167-31"></a>         ABORT!          ABORT!          
<a id="__codelineno-167-32" name="__codelineno-167-32" href="#__codelineno-167-32"></a>                                                        
<a id="__codelineno-167-33" name="__codelineno-167-33" href="#__codelineno-167-33"></a> t8                      Write ABORT     Write ABORT     
<a id="__codelineno-167-34" name="__codelineno-167-34" href="#__codelineno-167-34"></a>                         to log          to log          
<a id="__codelineno-167-35" name="__codelineno-167-35" href="#__codelineno-167-35"></a>                                                         
<a id="__codelineno-167-36" name="__codelineno-167-36" href="#__codelineno-167-36"></a> t9                      Rollback        Rollback        
<a id="__codelineno-167-37" name="__codelineno-167-37" href="#__codelineno-167-37"></a>                         Release locks   Release locks   
<a id="__codelineno-167-38" name="__codelineno-167-38" href="#__codelineno-167-38"></a>                                                         
<a id="__codelineno-167-39" name="__codelineno-167-39" href="#__codelineno-167-39"></a> t10                     ACK             ACK             
<a id="__codelineno-167-40" name="__codelineno-167-40" href="#__codelineno-167-40"></a>                                     
<a id="__codelineno-167-41" name="__codelineno-167-41" href="#__codelineno-167-41"></a>       All ACKs received                               
<a id="__codelineno-167-42" name="__codelineno-167-42" href="#__codelineno-167-42"></a>                                                       
<a id="__codelineno-167-43" name="__codelineno-167-43" href="#__codelineno-167-43"></a> t11   Write END                                       
<a id="__codelineno-167-44" name="__codelineno-167-44" href="#__codelineno-167-44"></a>       Transaction done  Done            Done            
<a id="__codelineno-167-45" name="__codelineno-167-45" href="#__codelineno-167-45"></a>                                                         
<a id="__codelineno-167-46" name="__codelineno-167-46" href="#__codelineno-167-46"></a>  RESULT: All aborted                                  
<a id="__codelineno-167-47" name="__codelineno-167-47" href="#__codelineno-167-47"></a>                                                         
<a id="__codelineno-167-48" name="__codelineno-167-48" href="#__codelineno-167-48"></a>
</code></pre></div>
<p><strong>State Machine - Coordinator:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a>
<a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a>       2PC COORDINATOR STATE MACHINE                     
<a id="__codelineno-168-3" name="__codelineno-168-3" href="#__codelineno-168-3"></a>
<a id="__codelineno-168-4" name="__codelineno-168-4" href="#__codelineno-168-4"></a>                                                         
<a id="__codelineno-168-5" name="__codelineno-168-5" href="#__codelineno-168-5"></a>                                             
<a id="__codelineno-168-6" name="__codelineno-168-6" href="#__codelineno-168-6"></a>                    INIT                               
<a id="__codelineno-168-7" name="__codelineno-168-7" href="#__codelineno-168-7"></a>                                             
<a id="__codelineno-168-8" name="__codelineno-168-8" href="#__codelineno-168-8"></a>                                                        
<a id="__codelineno-168-9" name="__codelineno-168-9" href="#__codelineno-168-9"></a>                        Send PREPARE                    
<a id="__codelineno-168-10" name="__codelineno-168-10" href="#__codelineno-168-10"></a>                                                        
<a id="__codelineno-168-11" name="__codelineno-168-11" href="#__codelineno-168-11"></a>                                             
<a id="__codelineno-168-12" name="__codelineno-168-12" href="#__codelineno-168-12"></a>              WAIT                               
<a id="__codelineno-168-13" name="__codelineno-168-13" href="#__codelineno-168-13"></a>                   (for                               
<a id="__codelineno-168-14" name="__codelineno-168-14" href="#__codelineno-168-14"></a>                   votes)                             
<a id="__codelineno-168-15" name="__codelineno-168-15" href="#__codelineno-168-15"></a>                                            
<a id="__codelineno-168-16" name="__codelineno-168-16" href="#__codelineno-168-16"></a>    Timeout                                            
<a id="__codelineno-168-17" name="__codelineno-168-17" href="#__codelineno-168-17"></a>    (ABORT)            All votes received              
<a id="__codelineno-168-18" name="__codelineno-168-18" href="#__codelineno-168-18"></a>                                                       
<a id="__codelineno-168-19" name="__codelineno-168-19" href="#__codelineno-168-19"></a>                                            
<a id="__codelineno-168-20" name="__codelineno-168-20" href="#__codelineno-168-20"></a>                  DECIDE                              
<a id="__codelineno-168-21" name="__codelineno-168-21" href="#__codelineno-168-21"></a>                                            
<a id="__codelineno-168-22" name="__codelineno-168-22" href="#__codelineno-168-22"></a>                                                       
<a id="__codelineno-168-23" name="__codelineno-168-23" href="#__codelineno-168-23"></a>                                           
<a id="__codelineno-168-24" name="__codelineno-168-24" href="#__codelineno-168-24"></a>                                                      
<a id="__codelineno-168-25" name="__codelineno-168-25" href="#__codelineno-168-25"></a>                                                      
<a id="__codelineno-168-26" name="__codelineno-168-26" href="#__codelineno-168-26"></a>                                    
<a id="__codelineno-168-27" name="__codelineno-168-27" href="#__codelineno-168-27"></a>             ABORT    COMMIT                       
<a id="__codelineno-168-28" name="__codelineno-168-28" href="#__codelineno-168-28"></a>                                     
<a id="__codelineno-168-29" name="__codelineno-168-29" href="#__codelineno-168-29"></a>                                                       
<a id="__codelineno-168-30" name="__codelineno-168-30" href="#__codelineno-168-30"></a>                    Send      Send                     
<a id="__codelineno-168-31" name="__codelineno-168-31" href="#__codelineno-168-31"></a>                    ABORT     COMMIT                   
<a id="__codelineno-168-32" name="__codelineno-168-32" href="#__codelineno-168-32"></a>                                                       
<a id="__codelineno-168-33" name="__codelineno-168-33" href="#__codelineno-168-33"></a>                                                       
<a id="__codelineno-168-34" name="__codelineno-168-34" href="#__codelineno-168-34"></a>                                     
<a id="__codelineno-168-35" name="__codelineno-168-35" href="#__codelineno-168-35"></a>                WAIT FOR ACKS                          
<a id="__codelineno-168-36" name="__codelineno-168-36" href="#__codelineno-168-36"></a>                                     
<a id="__codelineno-168-37" name="__codelineno-168-37" href="#__codelineno-168-37"></a>                                                        
<a id="__codelineno-168-38" name="__codelineno-168-38" href="#__codelineno-168-38"></a>                        All ACKs received               
<a id="__codelineno-168-39" name="__codelineno-168-39" href="#__codelineno-168-39"></a>                                                        
<a id="__codelineno-168-40" name="__codelineno-168-40" href="#__codelineno-168-40"></a>                                             
<a id="__codelineno-168-41" name="__codelineno-168-41" href="#__codelineno-168-41"></a>                     END                               
<a id="__codelineno-168-42" name="__codelineno-168-42" href="#__codelineno-168-42"></a>                                             
<a id="__codelineno-168-43" name="__codelineno-168-43" href="#__codelineno-168-43"></a>                                                         
<a id="__codelineno-168-44" name="__codelineno-168-44" href="#__codelineno-168-44"></a>
</code></pre></div>
<p><strong>State Machine - Participant:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a>
<a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a>       2PC PARTICIPANT STATE MACHINE                     
<a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a>
<a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a>                                                         
<a id="__codelineno-169-5" name="__codelineno-169-5" href="#__codelineno-169-5"></a>                                             
<a id="__codelineno-169-6" name="__codelineno-169-6" href="#__codelineno-169-6"></a>                    INIT                               
<a id="__codelineno-169-7" name="__codelineno-169-7" href="#__codelineno-169-7"></a>                                             
<a id="__codelineno-169-8" name="__codelineno-169-8" href="#__codelineno-169-8"></a>                                                        
<a id="__codelineno-169-9" name="__codelineno-169-9" href="#__codelineno-169-9"></a>                        Receive PREPARE                 
<a id="__codelineno-169-10" name="__codelineno-169-10" href="#__codelineno-169-10"></a>                                                        
<a id="__codelineno-169-11" name="__codelineno-169-11" href="#__codelineno-169-11"></a>                                             
<a id="__codelineno-169-12" name="__codelineno-169-12" href="#__codelineno-169-12"></a>                   PREPARE                             
<a id="__codelineno-169-13" name="__codelineno-169-13" href="#__codelineno-169-13"></a>                   (execute                            
<a id="__codelineno-169-14" name="__codelineno-169-14" href="#__codelineno-169-14"></a>                    &amp; vote)                            
<a id="__codelineno-169-15" name="__codelineno-169-15" href="#__codelineno-169-15"></a>                                             
<a id="__codelineno-169-16" name="__codelineno-169-16" href="#__codelineno-169-16"></a>                                                        
<a id="__codelineno-169-17" name="__codelineno-169-17" href="#__codelineno-169-17"></a>                                              
<a id="__codelineno-169-18" name="__codelineno-169-18" href="#__codelineno-169-18"></a>                                                       
<a id="__codelineno-169-19" name="__codelineno-169-19" href="#__codelineno-169-19"></a>         Can                      Cannot               
<a id="__codelineno-169-20" name="__codelineno-169-20" href="#__codelineno-169-20"></a>         commit      commit                
<a id="__codelineno-169-21" name="__codelineno-169-21" href="#__codelineno-169-21"></a>          YES    NO                   
<a id="__codelineno-169-22" name="__codelineno-169-22" href="#__codelineno-169-22"></a>                                         
<a id="__codelineno-169-23" name="__codelineno-169-23" href="#__codelineno-169-23"></a>                                                     
<a id="__codelineno-169-24" name="__codelineno-169-24" href="#__codelineno-169-24"></a>                   Wait    Vote NO                   
<a id="__codelineno-169-25" name="__codelineno-169-25" href="#__codelineno-169-25"></a>                                     
<a id="__codelineno-169-26" name="__codelineno-169-26" href="#__codelineno-169-26"></a>                                            
<a id="__codelineno-169-27" name="__codelineno-169-27" href="#__codelineno-169-27"></a>              READY                                 
<a id="__codelineno-169-28" name="__codelineno-169-28" href="#__codelineno-169-28"></a>             (blocked                               
<a id="__codelineno-169-29" name="__codelineno-169-29" href="#__codelineno-169-29"></a>             waiting)                               
<a id="__codelineno-169-30" name="__codelineno-169-30" href="#__codelineno-169-30"></a>                                            
<a id="__codelineno-169-31" name="__codelineno-169-31" href="#__codelineno-169-31"></a>                                                     
<a id="__codelineno-169-32" name="__codelineno-169-32" href="#__codelineno-169-32"></a>                                           
<a id="__codelineno-169-33" name="__codelineno-169-33" href="#__codelineno-169-33"></a>                                                    
<a id="__codelineno-169-34" name="__codelineno-169-34" href="#__codelineno-169-34"></a>                                                    
<a id="__codelineno-169-35" name="__codelineno-169-35" href="#__codelineno-169-35"></a>                                 
<a id="__codelineno-169-36" name="__codelineno-169-36" href="#__codelineno-169-36"></a>          COMMIT   ABORT                  
<a id="__codelineno-169-37" name="__codelineno-169-37" href="#__codelineno-169-37"></a>                                   
<a id="__codelineno-169-38" name="__codelineno-169-38" href="#__codelineno-169-38"></a>                                                     
<a id="__codelineno-169-39" name="__codelineno-169-39" href="#__codelineno-169-39"></a>                Apply     Rollback         Rollback  
<a id="__codelineno-169-40" name="__codelineno-169-40" href="#__codelineno-169-40"></a>                changes   changes          changes   
<a id="__codelineno-169-41" name="__codelineno-169-41" href="#__codelineno-169-41"></a>                                                     
<a id="__codelineno-169-42" name="__codelineno-169-42" href="#__codelineno-169-42"></a>                                                     
<a id="__codelineno-169-43" name="__codelineno-169-43" href="#__codelineno-169-43"></a>                    
<a id="__codelineno-169-44" name="__codelineno-169-44" href="#__codelineno-169-44"></a>                      END                             
<a id="__codelineno-169-45" name="__codelineno-169-45" href="#__codelineno-169-45"></a>                    
<a id="__codelineno-169-46" name="__codelineno-169-46" href="#__codelineno-169-46"></a>                                                         
<a id="__codelineno-169-47" name="__codelineno-169-47" href="#__codelineno-169-47"></a>
</code></pre></div>
<hr />
<h4 id="62-how-two-phase-commit-works-step-by-step">6.2 How Two-Phase Commit Works (Step-by-Step)</h4>
<p><strong>Complete Example: Bank Transfer Across Two Banks</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a>
<a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a>    2PC EXAMPLE: TRANSFER $500 ACROSS TWO BANKS          
<a id="__codelineno-170-3" name="__codelineno-170-3" href="#__codelineno-170-3"></a>
<a id="__codelineno-170-4" name="__codelineno-170-4" href="#__codelineno-170-4"></a>                                                         
<a id="__codelineno-170-5" name="__codelineno-170-5" href="#__codelineno-170-5"></a> Transaction: Transfer $500 from Bank A to Bank B       
<a id="__codelineno-170-6" name="__codelineno-170-6" href="#__codelineno-170-6"></a>                                                         
<a id="__codelineno-170-7" name="__codelineno-170-7" href="#__codelineno-170-7"></a> Components:                                             
<a id="__codelineno-170-8" name="__codelineno-170-8" href="#__codelineno-170-8"></a>  Coordinator: Transaction Manager                      
<a id="__codelineno-170-9" name="__codelineno-170-9" href="#__codelineno-170-9"></a>  Participant 1: Bank A Database                        
<a id="__codelineno-170-10" name="__codelineno-170-10" href="#__codelineno-170-10"></a>  Participant 2: Bank B Database                        
<a id="__codelineno-170-11" name="__codelineno-170-11" href="#__codelineno-170-11"></a>                                                         
<a id="__codelineno-170-12" name="__codelineno-170-12" href="#__codelineno-170-12"></a>
</code></pre></div>
<p><strong>Phase 1: Prepare (Voting Phase)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a>Step 1: Coordinator sends PREPARE
<a id="__codelineno-171-2" name="__codelineno-171-2" href="#__codelineno-171-2"></a>
<a id="__codelineno-171-3" name="__codelineno-171-3" href="#__codelineno-171-3"></a>
<a id="__codelineno-171-4" name="__codelineno-171-4" href="#__codelineno-171-4"></a>Coordinator:
<a id="__codelineno-171-5" name="__codelineno-171-5" href="#__codelineno-171-5"></a>  Log: [TXN-123] BEGIN
<a id="__codelineno-171-6" name="__codelineno-171-6" href="#__codelineno-171-6"></a>  Action: Send PREPARE to all participants
<a id="__codelineno-171-7" name="__codelineno-171-7" href="#__codelineno-171-7"></a>
<a id="__codelineno-171-8" name="__codelineno-171-8" href="#__codelineno-171-8"></a>  Message to Bank A: &quot;PREPARE TXN-123: Deduct $500 from Account #1001&quot;
<a id="__codelineno-171-9" name="__codelineno-171-9" href="#__codelineno-171-9"></a>  Message to Bank B: &quot;PREPARE TXN-123: Add $500 to Account #2002&quot;
<a id="__codelineno-171-10" name="__codelineno-171-10" href="#__codelineno-171-10"></a>
<a id="__codelineno-171-11" name="__codelineno-171-11" href="#__codelineno-171-11"></a>
<a id="__codelineno-171-12" name="__codelineno-171-12" href="#__codelineno-171-12"></a>Step 2: Participants execute and vote
<a id="__codelineno-171-13" name="__codelineno-171-13" href="#__codelineno-171-13"></a>
<a id="__codelineno-171-14" name="__codelineno-171-14" href="#__codelineno-171-14"></a>
<a id="__codelineno-171-15" name="__codelineno-171-15" href="#__codelineno-171-15"></a>Participant: Bank A
<a id="__codelineno-171-16" name="__codelineno-171-16" href="#__codelineno-171-16"></a>  1. Execute: SELECT balance FROM accounts WHERE id=1001 FOR UPDATE
<a id="__codelineno-171-17" name="__codelineno-171-17" href="#__codelineno-171-17"></a>     Result: balance = $1000 (sufficient funds)
<a id="__codelineno-171-18" name="__codelineno-171-18" href="#__codelineno-171-18"></a>
<a id="__codelineno-171-19" name="__codelineno-171-19" href="#__codelineno-171-19"></a>  2. Execute: UPDATE accounts SET balance = 500 WHERE id=1001
<a id="__codelineno-171-20" name="__codelineno-171-20" href="#__codelineno-171-20"></a>     (Operation prepared, not committed yet)
<a id="__codelineno-171-21" name="__codelineno-171-21" href="#__codelineno-171-21"></a>
<a id="__codelineno-171-22" name="__codelineno-171-22" href="#__codelineno-171-22"></a>  3. Write to log: [TXN-123] PREPARE DEDUCT $500 FROM 1001
<a id="__codelineno-171-23" name="__codelineno-171-23" href="#__codelineno-171-23"></a>
<a id="__codelineno-171-24" name="__codelineno-171-24" href="#__codelineno-171-24"></a>  4. Lock: Account #1001 LOCKED
<a id="__codelineno-171-25" name="__codelineno-171-25" href="#__codelineno-171-25"></a>
<a id="__codelineno-171-26" name="__codelineno-171-26" href="#__codelineno-171-26"></a>  5. Vote: YES (ready to commit)
<a id="__codelineno-171-27" name="__codelineno-171-27" href="#__codelineno-171-27"></a>
<a id="__codelineno-171-28" name="__codelineno-171-28" href="#__codelineno-171-28"></a>  6. Send to coordinator: &quot;YES - Bank A ready&quot;
<a id="__codelineno-171-29" name="__codelineno-171-29" href="#__codelineno-171-29"></a>
<a id="__codelineno-171-30" name="__codelineno-171-30" href="#__codelineno-171-30"></a>
<a id="__codelineno-171-31" name="__codelineno-171-31" href="#__codelineno-171-31"></a>Participant: Bank B
<a id="__codelineno-171-32" name="__codelineno-171-32" href="#__codelineno-171-32"></a>  1. Execute: SELECT balance FROM accounts WHERE id=2002 FOR UPDATE
<a id="__codelineno-171-33" name="__codelineno-171-33" href="#__codelineno-171-33"></a>     Result: balance = $300
<a id="__codelineno-171-34" name="__codelineno-171-34" href="#__codelineno-171-34"></a>
<a id="__codelineno-171-35" name="__codelineno-171-35" href="#__codelineno-171-35"></a>  2. Execute: UPDATE accounts SET balance = 800 WHERE id=2002
<a id="__codelineno-171-36" name="__codelineno-171-36" href="#__codelineno-171-36"></a>     (Operation prepared, not committed yet)
<a id="__codelineno-171-37" name="__codelineno-171-37" href="#__codelineno-171-37"></a>
<a id="__codelineno-171-38" name="__codelineno-171-38" href="#__codelineno-171-38"></a>  3. Write to log: [TXN-123] PREPARE ADD $500 TO 2002
<a id="__codelineno-171-39" name="__codelineno-171-39" href="#__codelineno-171-39"></a>
<a id="__codelineno-171-40" name="__codelineno-171-40" href="#__codelineno-171-40"></a>  4. Lock: Account #2002 LOCKED
<a id="__codelineno-171-41" name="__codelineno-171-41" href="#__codelineno-171-41"></a>
<a id="__codelineno-171-42" name="__codelineno-171-42" href="#__codelineno-171-42"></a>  5. Vote: YES (ready to commit)
<a id="__codelineno-171-43" name="__codelineno-171-43" href="#__codelineno-171-43"></a>
<a id="__codelineno-171-44" name="__codelineno-171-44" href="#__codelineno-171-44"></a>  6. Send to coordinator: &quot;YES - Bank B ready&quot;
<a id="__codelineno-171-45" name="__codelineno-171-45" href="#__codelineno-171-45"></a>
<a id="__codelineno-171-46" name="__codelineno-171-46" href="#__codelineno-171-46"></a>
<a id="__codelineno-171-47" name="__codelineno-171-47" href="#__codelineno-171-47"></a>Step 3: Coordinator collects votes and decides
<a id="__codelineno-171-48" name="__codelineno-171-48" href="#__codelineno-171-48"></a>
<a id="__codelineno-171-49" name="__codelineno-171-49" href="#__codelineno-171-49"></a>
<a id="__codelineno-171-50" name="__codelineno-171-50" href="#__codelineno-171-50"></a>Coordinator:
<a id="__codelineno-171-51" name="__codelineno-171-51" href="#__codelineno-171-51"></a>  Received votes:
<a id="__codelineno-171-52" name="__codelineno-171-52" href="#__codelineno-171-52"></a>   Bank A: YES
<a id="__codelineno-171-53" name="__codelineno-171-53" href="#__codelineno-171-53"></a>   Bank B: YES
<a id="__codelineno-171-54" name="__codelineno-171-54" href="#__codelineno-171-54"></a>
<a id="__codelineno-171-55" name="__codelineno-171-55" href="#__codelineno-171-55"></a>  Decision: All voted YES  COMMIT
<a id="__codelineno-171-56" name="__codelineno-171-56" href="#__codelineno-171-56"></a>
<a id="__codelineno-171-57" name="__codelineno-171-57" href="#__codelineno-171-57"></a>  Log: [TXN-123] DECISION: COMMIT
<a id="__codelineno-171-58" name="__codelineno-171-58" href="#__codelineno-171-58"></a>  (Write to stable storage - critical!)
</code></pre></div>
<p><strong>Phase 2: Commit (Decision Phase)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a>Step 4: Coordinator sends decision
<a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a>
<a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a>
<a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a>Coordinator:
<a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a>  Action: Broadcast COMMIT to all participants
<a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a>
<a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a>  Message to Bank A: &quot;COMMIT TXN-123&quot;
<a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a>  Message to Bank B: &quot;COMMIT TXN-123&quot;
<a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a>
<a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a>
<a id="__codelineno-172-11" name="__codelineno-172-11" href="#__codelineno-172-11"></a>Step 5: Participants commit
<a id="__codelineno-172-12" name="__codelineno-172-12" href="#__codelineno-172-12"></a>
<a id="__codelineno-172-13" name="__codelineno-172-13" href="#__codelineno-172-13"></a>
<a id="__codelineno-172-14" name="__codelineno-172-14" href="#__codelineno-172-14"></a>Participant: Bank A
<a id="__codelineno-172-15" name="__codelineno-172-15" href="#__codelineno-172-15"></a>  1. Write to log: [TXN-123] COMMIT
<a id="__codelineno-172-16" name="__codelineno-172-16" href="#__codelineno-172-16"></a>
<a id="__codelineno-172-17" name="__codelineno-172-17" href="#__codelineno-172-17"></a>  2. Apply changes: Make balance = $500 permanent
<a id="__codelineno-172-18" name="__codelineno-172-18" href="#__codelineno-172-18"></a>
<a id="__codelineno-172-19" name="__codelineno-172-19" href="#__codelineno-172-19"></a>  3. Release lock: Account #1001 UNLOCKED
<a id="__codelineno-172-20" name="__codelineno-172-20" href="#__codelineno-172-20"></a>
<a id="__codelineno-172-21" name="__codelineno-172-21" href="#__codelineno-172-21"></a>  4. Send ACK to coordinator: &quot;ACK - Bank A committed&quot;
<a id="__codelineno-172-22" name="__codelineno-172-22" href="#__codelineno-172-22"></a>
<a id="__codelineno-172-23" name="__codelineno-172-23" href="#__codelineno-172-23"></a>
<a id="__codelineno-172-24" name="__codelineno-172-24" href="#__codelineno-172-24"></a>Participant: Bank B
<a id="__codelineno-172-25" name="__codelineno-172-25" href="#__codelineno-172-25"></a>  1. Write to log: [TXN-123] COMMIT
<a id="__codelineno-172-26" name="__codelineno-172-26" href="#__codelineno-172-26"></a>
<a id="__codelineno-172-27" name="__codelineno-172-27" href="#__codelineno-172-27"></a>  2. Apply changes: Make balance = $800 permanent
<a id="__codelineno-172-28" name="__codelineno-172-28" href="#__codelineno-172-28"></a>
<a id="__codelineno-172-29" name="__codelineno-172-29" href="#__codelineno-172-29"></a>  3. Release lock: Account #2002 UNLOCKED
<a id="__codelineno-172-30" name="__codelineno-172-30" href="#__codelineno-172-30"></a>
<a id="__codelineno-172-31" name="__codelineno-172-31" href="#__codelineno-172-31"></a>  4. Send ACK to coordinator: &quot;ACK - Bank B committed&quot;
<a id="__codelineno-172-32" name="__codelineno-172-32" href="#__codelineno-172-32"></a>
<a id="__codelineno-172-33" name="__codelineno-172-33" href="#__codelineno-172-33"></a>
<a id="__codelineno-172-34" name="__codelineno-172-34" href="#__codelineno-172-34"></a>Step 6: Coordinator finalizes
<a id="__codelineno-172-35" name="__codelineno-172-35" href="#__codelineno-172-35"></a>
<a id="__codelineno-172-36" name="__codelineno-172-36" href="#__codelineno-172-36"></a>
<a id="__codelineno-172-37" name="__codelineno-172-37" href="#__codelineno-172-37"></a>Coordinator:
<a id="__codelineno-172-38" name="__codelineno-172-38" href="#__codelineno-172-38"></a>  Received ACKs:
<a id="__codelineno-172-39" name="__codelineno-172-39" href="#__codelineno-172-39"></a>   Bank A: ACK
<a id="__codelineno-172-40" name="__codelineno-172-40" href="#__codelineno-172-40"></a>   Bank B: ACK
<a id="__codelineno-172-41" name="__codelineno-172-41" href="#__codelineno-172-41"></a>
<a id="__codelineno-172-42" name="__codelineno-172-42" href="#__codelineno-172-42"></a>  Log: [TXN-123] END
<a id="__codelineno-172-43" name="__codelineno-172-43" href="#__codelineno-172-43"></a>
<a id="__codelineno-172-44" name="__codelineno-172-44" href="#__codelineno-172-44"></a>  Transaction complete!
<a id="__codelineno-172-45" name="__codelineno-172-45" href="#__codelineno-172-45"></a>
<a id="__codelineno-172-46" name="__codelineno-172-46" href="#__codelineno-172-46"></a>
<a id="__codelineno-172-47" name="__codelineno-172-47" href="#__codelineno-172-47"></a>FINAL STATE:
<a id="__codelineno-172-48" name="__codelineno-172-48" href="#__codelineno-172-48"></a>
<a id="__codelineno-172-49" name="__codelineno-172-49" href="#__codelineno-172-49"></a>Bank A Account #1001: $1000  $500  (deducted $500) 
<a id="__codelineno-172-50" name="__codelineno-172-50" href="#__codelineno-172-50"></a>Bank B Account #2002: $300   $800  (added $500)    
<a id="__codelineno-172-51" name="__codelineno-172-51" href="#__codelineno-172-51"></a>Total: $1300  $1300 (conserved) 
</code></pre></div>
<hr />
<h4 id="63-advantages-of-two-phase-commit">6.3 Advantages of Two-Phase Commit</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a>
<a id="__codelineno-173-2" name="__codelineno-173-2" href="#__codelineno-173-2"></a>         2PC ADVANTAGES                                  
<a id="__codelineno-173-3" name="__codelineno-173-3" href="#__codelineno-173-3"></a>
<a id="__codelineno-173-4" name="__codelineno-173-4" href="#__codelineno-173-4"></a>                                                         
<a id="__codelineno-173-5" name="__codelineno-173-5" href="#__codelineno-173-5"></a> 1.  ATOMICITY GUARANTEE                               
<a id="__codelineno-173-6" name="__codelineno-173-6" href="#__codelineno-173-6"></a>                
<a id="__codelineno-173-7" name="__codelineno-173-7" href="#__codelineno-173-7"></a>      All-or-nothing across nodes                    
<a id="__codelineno-173-8" name="__codelineno-173-8" href="#__codelineno-173-8"></a>      No partial commits possible                    
<a id="__codelineno-173-9" name="__codelineno-173-9" href="#__codelineno-173-9"></a>      Strong consistency maintained                  
<a id="__codelineno-173-10" name="__codelineno-173-10" href="#__codelineno-173-10"></a>      ACID properties preserved                      
<a id="__codelineno-173-11" name="__codelineno-173-11" href="#__codelineno-173-11"></a>                
<a id="__codelineno-173-12" name="__codelineno-173-12" href="#__codelineno-173-12"></a>                                                         
<a id="__codelineno-173-13" name="__codelineno-173-13" href="#__codelineno-173-13"></a> 2.  SIMPLE AND WELL-UNDERSTOOD                        
<a id="__codelineno-173-14" name="__codelineno-173-14" href="#__codelineno-173-14"></a>                
<a id="__codelineno-173-15" name="__codelineno-173-15" href="#__codelineno-173-15"></a>      Clear protocol, easy to reason                 
<a id="__codelineno-173-16" name="__codelineno-173-16" href="#__codelineno-173-16"></a>      Standardized (X/Open XA)                       
<a id="__codelineno-173-17" name="__codelineno-173-17" href="#__codelineno-173-17"></a>      Extensive vendor support                       
<a id="__codelineno-173-18" name="__codelineno-173-18" href="#__codelineno-173-18"></a>      Decades of production use                      
<a id="__codelineno-173-19" name="__codelineno-173-19" href="#__codelineno-173-19"></a>                
<a id="__codelineno-173-20" name="__codelineno-173-20" href="#__codelineno-173-20"></a>                                                         
<a id="__codelineno-173-21" name="__codelineno-173-21" href="#__codelineno-173-21"></a> 3.  WIDELY IMPLEMENTED                                
<a id="__codelineno-173-22" name="__codelineno-173-22" href="#__codelineno-173-22"></a>                
<a id="__codelineno-173-23" name="__codelineno-173-23" href="#__codelineno-173-23"></a>      Built into most databases                      
<a id="__codelineno-173-24" name="__codelineno-173-24" href="#__codelineno-173-24"></a>      Java JTA/JTS support                           
<a id="__codelineno-173-25" name="__codelineno-173-25" href="#__codelineno-173-25"></a>      .NET System.Transactions                       
<a id="__codelineno-173-26" name="__codelineno-173-26" href="#__codelineno-173-26"></a>      Application server integration                 
<a id="__codelineno-173-27" name="__codelineno-173-27" href="#__codelineno-173-27"></a>                
<a id="__codelineno-173-28" name="__codelineno-173-28" href="#__codelineno-173-28"></a>                                                         
<a id="__codelineno-173-29" name="__codelineno-173-29" href="#__codelineno-173-29"></a> 4.  CRASH RECOVERY SUPPORT                            
<a id="__codelineno-173-30" name="__codelineno-173-30" href="#__codelineno-173-30"></a>                
<a id="__codelineno-173-31" name="__codelineno-173-31" href="#__codelineno-173-31"></a>      Coordinator failure recoverable                
<a id="__codelineno-173-32" name="__codelineno-173-32" href="#__codelineno-173-32"></a>      Participant failure recoverable                
<a id="__codelineno-173-33" name="__codelineno-173-33" href="#__codelineno-173-33"></a>      Durable logs enable recovery                   
<a id="__codelineno-173-34" name="__codelineno-173-34" href="#__codelineno-173-34"></a>      No data loss after commit                                  
<a id="__codelineno-173-35" name="__codelineno-173-35" href="#__codelineno-173-35"></a>                
<a id="__codelineno-173-36" name="__codelineno-173-36" href="#__codelineno-173-36"></a>                                                         
<a id="__codelineno-173-37" name="__codelineno-173-37" href="#__codelineno-173-37"></a> 5.  STRONG ISOLATION                                  
<a id="__codelineno-173-38" name="__codelineno-173-38" href="#__codelineno-173-38"></a>                
<a id="__codelineno-173-39" name="__codelineno-173-39" href="#__codelineno-173-39"></a>      Locks held until commit                        
<a id="__codelineno-173-40" name="__codelineno-173-40" href="#__codelineno-173-40"></a>      No dirty reads across nodes                    
<a id="__codelineno-173-41" name="__codelineno-173-41" href="#__codelineno-173-41"></a>      Serializable across participants               
<a id="__codelineno-173-42" name="__codelineno-173-42" href="#__codelineno-173-42"></a>                
<a id="__codelineno-173-43" name="__codelineno-173-43" href="#__codelineno-173-43"></a>                                                         
<a id="__codelineno-173-44" name="__codelineno-173-44" href="#__codelineno-173-44"></a>
</code></pre></div>
<hr />
<h4 id="64-disadvantages-of-two-phase-commit">6.4 Disadvantages of Two-Phase Commit</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a>
<a id="__codelineno-174-2" name="__codelineno-174-2" href="#__codelineno-174-2"></a>         2PC DISADVANTAGES                               
<a id="__codelineno-174-3" name="__codelineno-174-3" href="#__codelineno-174-3"></a>
<a id="__codelineno-174-4" name="__codelineno-174-4" href="#__codelineno-174-4"></a>                                                         
<a id="__codelineno-174-5" name="__codelineno-174-5" href="#__codelineno-174-5"></a> 1.  BLOCKING PROTOCOL                                 
<a id="__codelineno-174-6" name="__codelineno-174-6" href="#__codelineno-174-6"></a>                
<a id="__codelineno-174-7" name="__codelineno-174-7" href="#__codelineno-174-7"></a>      Participants block waiting for                 
<a id="__codelineno-174-8" name="__codelineno-174-8" href="#__codelineno-174-8"></a>       coordinator decision                           
<a id="__codelineno-174-9" name="__codelineno-174-9" href="#__codelineno-174-9"></a>      Locks held during coordination                 
<a id="__codelineno-174-10" name="__codelineno-174-10" href="#__codelineno-174-10"></a>      Reduced availability                           
<a id="__codelineno-174-11" name="__codelineno-174-11" href="#__codelineno-174-11"></a>      Poor performance under failures                
<a id="__codelineno-174-12" name="__codelineno-174-12" href="#__codelineno-174-12"></a>                
<a id="__codelineno-174-13" name="__codelineno-174-13" href="#__codelineno-174-13"></a>                                                         
<a id="__codelineno-174-14" name="__codelineno-174-14" href="#__codelineno-174-14"></a> 2.  SINGLE POINT OF FAILURE                           
<a id="__codelineno-174-15" name="__codelineno-174-15" href="#__codelineno-174-15"></a>                
<a id="__codelineno-174-16" name="__codelineno-174-16" href="#__codelineno-174-16"></a>      Coordinator crash blocks system                
<a id="__codelineno-174-17" name="__codelineno-174-17" href="#__codelineno-174-17"></a>      Participants stuck in READY state              
<a id="__codelineno-174-18" name="__codelineno-174-18" href="#__codelineno-174-18"></a>      Cannot commit or abort until                   
<a id="__codelineno-174-19" name="__codelineno-174-19" href="#__codelineno-174-19"></a>       coordinator recovers                           
<a id="__codelineno-174-20" name="__codelineno-174-20" href="#__codelineno-174-20"></a>                
<a id="__codelineno-174-21" name="__codelineno-174-21" href="#__codelineno-174-21"></a>                                                         
<a id="__codelineno-174-22" name="__codelineno-174-22" href="#__codelineno-174-22"></a> 3.  HIGH LATENCY                                      
<a id="__codelineno-174-23" name="__codelineno-174-23" href="#__codelineno-174-23"></a>                
<a id="__codelineno-174-24" name="__codelineno-174-24" href="#__codelineno-174-24"></a>      Multiple network round trips:                  
<a id="__codelineno-174-25" name="__codelineno-174-25" href="#__codelineno-174-25"></a>       - PREPARE messages                             
<a id="__codelineno-174-26" name="__codelineno-174-26" href="#__codelineno-174-26"></a>       - Vote responses                               
<a id="__codelineno-174-27" name="__codelineno-174-27" href="#__codelineno-174-27"></a>       - COMMIT/ABORT messages                        
<a id="__codelineno-174-28" name="__codelineno-174-28" href="#__codelineno-174-28"></a>       - ACK responses                                
<a id="__codelineno-174-29" name="__codelineno-174-29" href="#__codelineno-174-29"></a>      Synchronous (not async)                        
<a id="__codelineno-174-30" name="__codelineno-174-30" href="#__codelineno-174-30"></a>      10-100x slower than local                      
<a id="__codelineno-174-31" name="__codelineno-174-31" href="#__codelineno-174-31"></a>                
<a id="__codelineno-174-32" name="__codelineno-174-32" href="#__codelineno-174-32"></a>                                                         
<a id="__codelineno-174-33" name="__codelineno-174-33" href="#__codelineno-174-33"></a> 4.  REDUCED THROUGHPUT                                
<a id="__codelineno-174-34" name="__codelineno-174-34" href="#__codelineno-174-34"></a>                
<a id="__codelineno-174-35" name="__codelineno-174-35" href="#__codelineno-174-35"></a>      Locks held for entire protocol                 
<a id="__codelineno-174-36" name="__codelineno-174-36" href="#__codelineno-174-36"></a>      Limits concurrent transactions                 
<a id="__codelineno-174-37" name="__codelineno-174-37" href="#__codelineno-174-37"></a>      Coordinator becomes bottleneck                 
<a id="__codelineno-174-38" name="__codelineno-174-38" href="#__codelineno-174-38"></a>      Doesn&#39;t scale well                             
<a id="__codelineno-174-39" name="__codelineno-174-39" href="#__codelineno-174-39"></a>                
<a id="__codelineno-174-40" name="__codelineno-174-40" href="#__codelineno-174-40"></a>                                                         
<a id="__codelineno-174-41" name="__codelineno-174-41" href="#__codelineno-174-41"></a> 5.  CAP THEOREM TRADE-OFF                             
<a id="__codelineno-174-42" name="__codelineno-174-42" href="#__codelineno-174-42"></a>                
<a id="__codelineno-174-43" name="__codelineno-174-43" href="#__codelineno-174-43"></a>      Chooses Consistency over                       
<a id="__codelineno-174-44" name="__codelineno-174-44" href="#__codelineno-174-44"></a>       Availability                                   
<a id="__codelineno-174-45" name="__codelineno-174-45" href="#__codelineno-174-45"></a>      Network partition blocks progress              
<a id="__codelineno-174-46" name="__codelineno-174-46" href="#__codelineno-174-46"></a>      Cannot tolerate partition                      
<a id="__codelineno-174-47" name="__codelineno-174-47" href="#__codelineno-174-47"></a>                
<a id="__codelineno-174-48" name="__codelineno-174-48" href="#__codelineno-174-48"></a>                                                         
<a id="__codelineno-174-49" name="__codelineno-174-49" href="#__codelineno-174-49"></a> 6.  LOGGING OVERHEAD                                  
<a id="__codelineno-174-50" name="__codelineno-174-50" href="#__codelineno-174-50"></a>                
<a id="__codelineno-174-51" name="__codelineno-174-51" href="#__codelineno-174-51"></a>      Multiple durable writes required               
<a id="__codelineno-174-52" name="__codelineno-174-52" href="#__codelineno-174-52"></a>      Coordinator log + participant logs             
<a id="__codelineno-174-53" name="__codelineno-174-53" href="#__codelineno-174-53"></a>      Disk I/O latency                               
<a id="__codelineno-174-54" name="__codelineno-174-54" href="#__codelineno-174-54"></a>                
<a id="__codelineno-174-55" name="__codelineno-174-55" href="#__codelineno-174-55"></a>                                                         
<a id="__codelineno-174-56" name="__codelineno-174-56" href="#__codelineno-174-56"></a>
</code></pre></div>
<hr />
<h4 id="65-problems-in-two-phase-commit">6.5 Problems in Two-Phase Commit</h4>
<p><strong>Problem 1: Coordinator Failure (Blocking)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a>
<a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a>       PROBLEM 1: COORDINATOR FAILURE                    
<a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a>
<a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a>                                                         
<a id="__codelineno-175-5" name="__codelineno-175-5" href="#__codelineno-175-5"></a> Scenario: Coordinator crashes after receiving votes    
<a id="__codelineno-175-6" name="__codelineno-175-6" href="#__codelineno-175-6"></a>           but before sending decision                   
<a id="__codelineno-175-7" name="__codelineno-175-7" href="#__codelineno-175-7"></a>                                                         
<a id="__codelineno-175-8" name="__codelineno-175-8" href="#__codelineno-175-8"></a> Timeline:                                               
<a id="__codelineno-175-9" name="__codelineno-175-9" href="#__codelineno-175-9"></a>                                                 
<a id="__codelineno-175-10" name="__codelineno-175-10" href="#__codelineno-175-10"></a> t1    Coordinator sends PREPARE                         
<a id="__codelineno-175-11" name="__codelineno-175-11" href="#__codelineno-175-11"></a> t2    Participants vote YES                             
<a id="__codelineno-175-12" name="__codelineno-175-12" href="#__codelineno-175-12"></a> t3     COORDINATOR CRASHES                          
<a id="__codelineno-175-13" name="__codelineno-175-13" href="#__codelineno-175-13"></a>       (Decision not yet sent!)                          
<a id="__codelineno-175-14" name="__codelineno-175-14" href="#__codelineno-175-14"></a>                                                         
<a id="__codelineno-175-15" name="__codelineno-175-15" href="#__codelineno-175-15"></a> Result:                                                 
<a id="__codelineno-175-16" name="__codelineno-175-16" href="#__codelineno-175-16"></a>            
<a id="__codelineno-175-17" name="__codelineno-175-17" href="#__codelineno-175-17"></a>  Participants are BLOCKED in READY state             
<a id="__codelineno-175-18" name="__codelineno-175-18" href="#__codelineno-175-18"></a>   Cannot commit (no decision received)              
<a id="__codelineno-175-19" name="__codelineno-175-19" href="#__codelineno-175-19"></a>   Cannot abort (might be only failure)              
<a id="__codelineno-175-20" name="__codelineno-175-20" href="#__codelineno-175-20"></a>   Hold locks indefinitely                           
<a id="__codelineno-175-21" name="__codelineno-175-21" href="#__codelineno-175-21"></a>   System unavailable                                
<a id="__codelineno-175-22" name="__codelineno-175-22" href="#__codelineno-175-22"></a>            
<a id="__codelineno-175-23" name="__codelineno-175-23" href="#__codelineno-175-23"></a>                                                         
<a id="__codelineno-175-24" name="__codelineno-175-24" href="#__codelineno-175-24"></a> Why participants can&#39;t decide:                          
<a id="__codelineno-175-25" name="__codelineno-175-25" href="#__codelineno-175-25"></a>  If they commit and coordinator decided abort:         
<a id="__codelineno-175-26" name="__codelineno-175-26" href="#__codelineno-175-26"></a>    Inconsistency!                                    
<a id="__codelineno-175-27" name="__codelineno-175-27" href="#__codelineno-175-27"></a>  If they abort and coordinator decided commit:         
<a id="__codelineno-175-28" name="__codelineno-175-28" href="#__codelineno-175-28"></a>    Inconsistency!                                    
<a id="__codelineno-175-29" name="__codelineno-175-29" href="#__codelineno-175-29"></a>  Must wait for coordinator recovery                    
<a id="__codelineno-175-30" name="__codelineno-175-30" href="#__codelineno-175-30"></a>                                                         
<a id="__codelineno-175-31" name="__codelineno-175-31" href="#__codelineno-175-31"></a> Impact:                                                 
<a id="__codelineno-175-32" name="__codelineno-175-32" href="#__codelineno-175-32"></a>  Locks held  Other transactions blocked               
<a id="__codelineno-175-33" name="__codelineno-175-33" href="#__codelineno-175-33"></a>  Resources unavailable                                 
<a id="__codelineno-175-34" name="__codelineno-175-34" href="#__codelineno-175-34"></a>  Cascading delays                                      
<a id="__codelineno-175-35" name="__codelineno-175-35" href="#__codelineno-175-35"></a>                                                         
<a id="__codelineno-175-36" name="__codelineno-175-36" href="#__codelineno-175-36"></a>
</code></pre></div>
<p><strong>Problem 2: Participant Failure After Voting YES</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a>
<a id="__codelineno-176-2" name="__codelineno-176-2" href="#__codelineno-176-2"></a>    PROBLEM 2: PARTICIPANT FAILURE AFTER YES VOTE        
<a id="__codelineno-176-3" name="__codelineno-176-3" href="#__codelineno-176-3"></a>
<a id="__codelineno-176-4" name="__codelineno-176-4" href="#__codelineno-176-4"></a>                                                         
<a id="__codelineno-176-5" name="__codelineno-176-5" href="#__codelineno-176-5"></a> Scenario: Participant crashes after voting YES         
<a id="__codelineno-176-6" name="__codelineno-176-6" href="#__codelineno-176-6"></a>           but before receiving decision                 
<a id="__codelineno-176-7" name="__codelineno-176-7" href="#__codelineno-176-7"></a>                                                         
<a id="__codelineno-176-8" name="__codelineno-176-8" href="#__codelineno-176-8"></a> Timeline:                                               
<a id="__codelineno-176-9" name="__codelineno-176-9" href="#__codelineno-176-9"></a>                                                 
<a id="__codelineno-176-10" name="__codelineno-176-10" href="#__codelineno-176-10"></a> t1    Participant A votes YES                           
<a id="__codelineno-176-11" name="__codelineno-176-11" href="#__codelineno-176-11"></a> t2     PARTICIPANT A CRASHES                        
<a id="__codelineno-176-12" name="__codelineno-176-12" href="#__codelineno-176-12"></a> t3    Coordinator sends COMMIT                          
<a id="__codelineno-176-13" name="__codelineno-176-13" href="#__codelineno-176-13"></a> t4    Participant A recovers...                         
<a id="__codelineno-176-14" name="__codelineno-176-14" href="#__codelineno-176-14"></a>                                                         
<a id="__codelineno-176-15" name="__codelineno-176-15" href="#__codelineno-176-15"></a> Problem:                                                
<a id="__codelineno-176-16" name="__codelineno-176-16" href="#__codelineno-176-16"></a>            
<a id="__codelineno-176-17" name="__codelineno-176-17" href="#__codelineno-176-17"></a>  Participant A doesn&#39;t know outcome:                 
<a id="__codelineno-176-18" name="__codelineno-176-18" href="#__codelineno-176-18"></a>   Voted YES (logged)                                
<a id="__codelineno-176-19" name="__codelineno-176-19" href="#__codelineno-176-19"></a>   Never received decision                           
<a id="__codelineno-176-20" name="__codelineno-176-20" href="#__codelineno-176-20"></a>   Cannot commit or abort independently              
<a id="__codelineno-176-21" name="__codelineno-176-21" href="#__codelineno-176-21"></a>   Must contact coordinator                          
<a id="__codelineno-176-22" name="__codelineno-176-22" href="#__codelineno-176-22"></a>            
<a id="__codelineno-176-23" name="__codelineno-176-23" href="#__codelineno-176-23"></a>                                                         
<a id="__codelineno-176-24" name="__codelineno-176-24" href="#__codelineno-176-24"></a> Recovery:                                               
<a id="__codelineno-176-25" name="__codelineno-176-25" href="#__codelineno-176-25"></a>  Read log: &quot;Voted YES for TXN-123&quot;                     
<a id="__codelineno-176-26" name="__codelineno-176-26" href="#__codelineno-176-26"></a>  Contact coordinator: &quot;What happened to TXN-123?&quot;      
<a id="__codelineno-176-27" name="__codelineno-176-27" href="#__codelineno-176-27"></a>  Coordinator responds: &quot;COMMIT&quot; or &quot;ABORT&quot;             
<a id="__codelineno-176-28" name="__codelineno-176-28" href="#__codelineno-176-28"></a>  Apply decision                                        
<a id="__codelineno-176-29" name="__codelineno-176-29" href="#__codelineno-176-29"></a>                                                         
<a id="__codelineno-176-30" name="__codelineno-176-30" href="#__codelineno-176-30"></a> If coordinator also crashed:                            
<a id="__codelineno-176-31" name="__codelineno-176-31" href="#__codelineno-176-31"></a>  BLOCKED until coordinator recovers!                 
<a id="__codelineno-176-32" name="__codelineno-176-32" href="#__codelineno-176-32"></a>                                                         
<a id="__codelineno-176-33" name="__codelineno-176-33" href="#__codelineno-176-33"></a>
</code></pre></div>
<p><strong>Problem 3: Network Partition</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a>
<a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a>       PROBLEM 3: NETWORK PARTITION                      
<a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a>
<a id="__codelineno-177-4" name="__codelineno-177-4" href="#__codelineno-177-4"></a>                                                         
<a id="__codelineno-177-5" name="__codelineno-177-5" href="#__codelineno-177-5"></a> Scenario: Network partition splits coordinator and     
<a id="__codelineno-177-6" name="__codelineno-177-6" href="#__codelineno-177-6"></a>           participants                                  
<a id="__codelineno-177-7" name="__codelineno-177-7" href="#__codelineno-177-7"></a>                                                         
<a id="__codelineno-177-8" name="__codelineno-177-8" href="#__codelineno-177-8"></a>                                
<a id="__codelineno-177-9" name="__codelineno-177-9" href="#__codelineno-177-9"></a>     Coordinator          Network Partition            
<a id="__codelineno-177-10" name="__codelineno-177-10" href="#__codelineno-177-10"></a>                                
<a id="__codelineno-177-11" name="__codelineno-177-11" href="#__codelineno-177-11"></a>                                                        
<a id="__codelineno-177-12" name="__codelineno-177-12" href="#__codelineno-177-12"></a>           PREPARE? (sent)                              
<a id="__codelineno-177-13" name="__codelineno-177-13" href="#__codelineno-177-13"></a>           (message lost!)                              
<a id="__codelineno-177-14" name="__codelineno-177-14" href="#__codelineno-177-14"></a>                                                        
<a id="__codelineno-177-15" name="__codelineno-177-15" href="#__codelineno-177-15"></a>                                              
<a id="__codelineno-177-16" name="__codelineno-177-16" href="#__codelineno-177-16"></a>                                                         
<a id="__codelineno-177-17" name="__codelineno-177-17" href="#__codelineno-177-17"></a>                        
<a id="__codelineno-177-18" name="__codelineno-177-18" href="#__codelineno-177-18"></a>    Participant A        Participant B              
<a id="__codelineno-177-19" name="__codelineno-177-19" href="#__codelineno-177-19"></a>    (unreachable)        (unreachable)              
<a id="__codelineno-177-20" name="__codelineno-177-20" href="#__codelineno-177-20"></a>                        
<a id="__codelineno-177-21" name="__codelineno-177-21" href="#__codelineno-177-21"></a>                                                         
<a id="__codelineno-177-22" name="__codelineno-177-22" href="#__codelineno-177-22"></a> Impact:                                                 
<a id="__codelineno-177-23" name="__codelineno-177-23" href="#__codelineno-177-23"></a>            
<a id="__codelineno-177-24" name="__codelineno-177-24" href="#__codelineno-177-24"></a>   Coordinator times out waiting for votes           
<a id="__codelineno-177-25" name="__codelineno-177-25" href="#__codelineno-177-25"></a>   Decides to ABORT (safety)                         
<a id="__codelineno-177-26" name="__codelineno-177-26" href="#__codelineno-177-26"></a>   But cannot reach participants!                    
<a id="__codelineno-177-27" name="__codelineno-177-27" href="#__codelineno-177-27"></a>   Participants waiting indefinitely                 
<a id="__codelineno-177-28" name="__codelineno-177-28" href="#__codelineno-177-28"></a>   System split-brain risk                           
<a id="__codelineno-177-29" name="__codelineno-177-29" href="#__codelineno-177-29"></a>            
<a id="__codelineno-177-30" name="__codelineno-177-30" href="#__codelineno-177-30"></a>                                                         
<a id="__codelineno-177-31" name="__codelineno-177-31" href="#__codelineno-177-31"></a> When partition heals:                                   
<a id="__codelineno-177-32" name="__codelineno-177-32" href="#__codelineno-177-32"></a>  Messages finally delivered                            
<a id="__codelineno-177-33" name="__codelineno-177-33" href="#__codelineno-177-33"></a>  But significant delay occurred                        
<a id="__codelineno-177-34" name="__codelineno-177-34" href="#__codelineno-177-34"></a>  Locks held for extended period                        
<a id="__codelineno-177-35" name="__codelineno-177-35" href="#__codelineno-177-35"></a>                                                         
<a id="__codelineno-177-36" name="__codelineno-177-36" href="#__codelineno-177-36"></a>
</code></pre></div>
<p><strong>Problem 4: Heuristic Decisions (Manual Intervention)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a>
<a id="__codelineno-178-2" name="__codelineno-178-2" href="#__codelineno-178-2"></a>       PROBLEM 4: HEURISTIC DECISIONS                    
<a id="__codelineno-178-3" name="__codelineno-178-3" href="#__codelineno-178-3"></a>
<a id="__codelineno-178-4" name="__codelineno-178-4" href="#__codelineno-178-4"></a>                                                         
<a id="__codelineno-178-5" name="__codelineno-178-5" href="#__codelineno-178-5"></a> Scenario: Administrator manually commits/aborts        
<a id="__codelineno-178-6" name="__codelineno-178-6" href="#__codelineno-178-6"></a>           to unblock system                             
<a id="__codelineno-178-7" name="__codelineno-178-7" href="#__codelineno-178-7"></a>                                                         
<a id="__codelineno-178-8" name="__codelineno-178-8" href="#__codelineno-178-8"></a> Situation:                                              
<a id="__codelineno-178-9" name="__codelineno-178-9" href="#__codelineno-178-9"></a>  Coordinator crashed and not recovering                
<a id="__codelineno-178-10" name="__codelineno-178-10" href="#__codelineno-178-10"></a>  Participants blocked for hours                        
<a id="__codelineno-178-11" name="__codelineno-178-11" href="#__codelineno-178-11"></a>  Critical system unavailable                           
<a id="__codelineno-178-12" name="__codelineno-178-12" href="#__codelineno-178-12"></a>  DBA intervenes manually                               
<a id="__codelineno-178-13" name="__codelineno-178-13" href="#__codelineno-178-13"></a>                                                         
<a id="__codelineno-178-14" name="__codelineno-178-14" href="#__codelineno-178-14"></a> DBA Action:                                             
<a id="__codelineno-178-15" name="__codelineno-178-15" href="#__codelineno-178-15"></a>            
<a id="__codelineno-178-16" name="__codelineno-178-16" href="#__codelineno-178-16"></a>  Participant A: FORCE COMMIT                          
<a id="__codelineno-178-17" name="__codelineno-178-17" href="#__codelineno-178-17"></a>  Participant B: FORCE ABORT                           
<a id="__codelineno-178-18" name="__codelineno-178-18" href="#__codelineno-178-18"></a>  (Different decisions! )                            
<a id="__codelineno-178-19" name="__codelineno-178-19" href="#__codelineno-178-19"></a>            
<a id="__codelineno-178-20" name="__codelineno-178-20" href="#__codelineno-178-20"></a>                                                         
<a id="__codelineno-178-21" name="__codelineno-178-21" href="#__codelineno-178-21"></a> Result: INCONSISTENCY!                                  
<a id="__codelineno-178-22" name="__codelineno-178-22" href="#__codelineno-178-22"></a>            
<a id="__codelineno-178-23" name="__codelineno-178-23" href="#__codelineno-178-23"></a>   Database inconsistent across nodes                
<a id="__codelineno-178-24" name="__codelineno-178-24" href="#__codelineno-178-24"></a>   Data integrity violated                           
<a id="__codelineno-178-25" name="__codelineno-178-25" href="#__codelineno-178-25"></a>   Extremely difficult to fix                        
<a id="__codelineno-178-26" name="__codelineno-178-26" href="#__codelineno-178-26"></a>   May require manual reconciliation                 
<a id="__codelineno-178-27" name="__codelineno-178-27" href="#__codelineno-178-27"></a>            
<a id="__codelineno-178-28" name="__codelineno-178-28" href="#__codelineno-178-28"></a>                                                         
<a id="__codelineno-178-29" name="__codelineno-178-29" href="#__codelineno-178-29"></a> Heuristic outcomes:                                     
<a id="__codelineno-178-30" name="__codelineno-178-30" href="#__codelineno-178-30"></a>  Heuristic Commit: Force commit locally                
<a id="__codelineno-178-31" name="__codelineno-178-31" href="#__codelineno-178-31"></a>  Heuristic Abort: Force abort locally                  
<a id="__codelineno-178-32" name="__codelineno-178-32" href="#__codelineno-178-32"></a>  Heuristic Mixed: Some commit, some abort            
<a id="__codelineno-178-33" name="__codelineno-178-33" href="#__codelineno-178-33"></a>                                                         
<a id="__codelineno-178-34" name="__codelineno-178-34" href="#__codelineno-178-34"></a> This is why 2PC is called &quot;blocking&quot; protocol          
<a id="__codelineno-178-35" name="__codelineno-178-35" href="#__codelineno-178-35"></a>                                                         
<a id="__codelineno-178-36" name="__codelineno-178-36" href="#__codelineno-178-36"></a>
</code></pre></div>
<p><strong>Problem 5: Performance Degradation</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a>
<a id="__codelineno-179-2" name="__codelineno-179-2" href="#__codelineno-179-2"></a>       PROBLEM 5: PERFORMANCE ISSUES                     
<a id="__codelineno-179-3" name="__codelineno-179-3" href="#__codelineno-179-3"></a>
<a id="__codelineno-179-4" name="__codelineno-179-4" href="#__codelineno-179-4"></a>                                                         
<a id="__codelineno-179-5" name="__codelineno-179-5" href="#__codelineno-179-5"></a> Message Overhead:                                       
<a id="__codelineno-179-6" name="__codelineno-179-6" href="#__codelineno-179-6"></a>            
<a id="__codelineno-179-7" name="__codelineno-179-7" href="#__codelineno-179-7"></a>  For N participants:                                 
<a id="__codelineno-179-8" name="__codelineno-179-8" href="#__codelineno-179-8"></a>   PREPARE messages: N                               
<a id="__codelineno-179-9" name="__codelineno-179-9" href="#__codelineno-179-9"></a>   Vote responses: N                                 
<a id="__codelineno-179-10" name="__codelineno-179-10" href="#__codelineno-179-10"></a>   COMMIT/ABORT messages: N                          
<a id="__codelineno-179-11" name="__codelineno-179-11" href="#__codelineno-179-11"></a>   ACK responses: N                                  
<a id="__codelineno-179-12" name="__codelineno-179-12" href="#__codelineno-179-12"></a>  Total: 4N messages (synchronous)                    
<a id="__codelineno-179-13" name="__codelineno-179-13" href="#__codelineno-179-13"></a>            
<a id="__codelineno-179-14" name="__codelineno-179-14" href="#__codelineno-179-14"></a>                                                         
<a id="__codelineno-179-15" name="__codelineno-179-15" href="#__codelineno-179-15"></a> Latency Analysis:                                       
<a id="__codelineno-179-16" name="__codelineno-179-16" href="#__codelineno-179-16"></a>            
<a id="__codelineno-179-17" name="__codelineno-179-17" href="#__codelineno-179-17"></a>  Local transaction:  1-10 ms                         
<a id="__codelineno-179-18" name="__codelineno-179-18" href="#__codelineno-179-18"></a>                                                      
<a id="__codelineno-179-19" name="__codelineno-179-19" href="#__codelineno-179-19"></a>  2PC transaction:                                    
<a id="__codelineno-179-20" name="__codelineno-179-20" href="#__codelineno-179-20"></a>   Network RTT (4): 4  5ms = 20ms                  
<a id="__codelineno-179-21" name="__codelineno-179-21" href="#__codelineno-179-21"></a>   Logging (6):     6  2ms = 12ms                  
<a id="__codelineno-179-22" name="__codelineno-179-22" href="#__codelineno-179-22"></a>   Processing:              3ms                      
<a id="__codelineno-179-23" name="__codelineno-179-23" href="#__codelineno-179-23"></a>  Total:                   ~35ms                      
<a id="__codelineno-179-24" name="__codelineno-179-24" href="#__codelineno-179-24"></a>                                                      
<a id="__codelineno-179-25" name="__codelineno-179-25" href="#__codelineno-179-25"></a>   3-35x slower!                                   
<a id="__codelineno-179-26" name="__codelineno-179-26" href="#__codelineno-179-26"></a>            
<a id="__codelineno-179-27" name="__codelineno-179-27" href="#__codelineno-179-27"></a>                                                         
<a id="__codelineno-179-28" name="__codelineno-179-28" href="#__codelineno-179-28"></a> Throughput Impact:                                      
<a id="__codelineno-179-29" name="__codelineno-179-29" href="#__codelineno-179-29"></a>            
<a id="__codelineno-179-30" name="__codelineno-179-30" href="#__codelineno-179-30"></a>  Locks held for 35ms (vs 1ms local)                  
<a id="__codelineno-179-31" name="__codelineno-179-31" href="#__codelineno-179-31"></a>   35x longer lock duration                          
<a id="__codelineno-179-32" name="__codelineno-179-32" href="#__codelineno-179-32"></a>   97% reduction in concurrent capacity              
<a id="__codelineno-179-33" name="__codelineno-179-33" href="#__codelineno-179-33"></a>            
<a id="__codelineno-179-34" name="__codelineno-179-34" href="#__codelineno-179-34"></a>                                                         
<a id="__codelineno-179-35" name="__codelineno-179-35" href="#__codelineno-179-35"></a>
</code></pre></div>
<p><strong>Summary: When 2PC Fails</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a>
<a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a>         WHEN TWO-PHASE COMMIT FAILS                     
<a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a>
<a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a>                                                         
<a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a>  Coordinator crash  Blocking                         
<a id="__codelineno-180-6" name="__codelineno-180-6" href="#__codelineno-180-6"></a>  Participant crash after YES  Uncertainty            
<a id="__codelineno-180-7" name="__codelineno-180-7" href="#__codelineno-180-7"></a>  Network partition  Split-brain risk                 
<a id="__codelineno-180-8" name="__codelineno-180-8" href="#__codelineno-180-8"></a>  Multiple failures  Indefinite blocking              
<a id="__codelineno-180-9" name="__codelineno-180-9" href="#__codelineno-180-9"></a>  Heuristic decisions  Inconsistency                  
<a id="__codelineno-180-10" name="__codelineno-180-10" href="#__codelineno-180-10"></a>  High latency  Poor performance                      
<a id="__codelineno-180-11" name="__codelineno-180-11" href="#__codelineno-180-11"></a>  Many participants  Exponential failure probability  
<a id="__codelineno-180-12" name="__codelineno-180-12" href="#__codelineno-180-12"></a>                                                         
<a id="__codelineno-180-13" name="__codelineno-180-13" href="#__codelineno-180-13"></a> Key Limitation:                                         
<a id="__codelineno-180-14" name="__codelineno-180-14" href="#__codelineno-180-14"></a>            
<a id="__codelineno-180-15" name="__codelineno-180-15" href="#__codelineno-180-15"></a>  2PC is a BLOCKING protocol                          
<a id="__codelineno-180-16" name="__codelineno-180-16" href="#__codelineno-180-16"></a>                                                      
<a id="__codelineno-180-17" name="__codelineno-180-17" href="#__codelineno-180-17"></a>  Availability is sacrificed for                      
<a id="__codelineno-180-18" name="__codelineno-180-18" href="#__codelineno-180-18"></a>  Consistency (CAP theorem)                           
<a id="__codelineno-180-19" name="__codelineno-180-19" href="#__codelineno-180-19"></a>            
<a id="__codelineno-180-20" name="__codelineno-180-20" href="#__codelineno-180-20"></a>                                                         
<a id="__codelineno-180-21" name="__codelineno-180-21" href="#__codelineno-180-21"></a> Modern alternatives:                                    
<a id="__codelineno-180-22" name="__codelineno-180-22" href="#__codelineno-180-22"></a>  Three-Phase Commit (3PC) - Non-blocking               
<a id="__codelineno-180-23" name="__codelineno-180-23" href="#__codelineno-180-23"></a>  Paxos/Raft - Consensus protocols                      
<a id="__codelineno-180-24" name="__codelineno-180-24" href="#__codelineno-180-24"></a>  Saga pattern - Eventual consistency                   
<a id="__codelineno-180-25" name="__codelineno-180-25" href="#__codelineno-180-25"></a>  Event sourcing - Asynchronous                         
<a id="__codelineno-180-26" name="__codelineno-180-26" href="#__codelineno-180-26"></a>                                                         
<a id="__codelineno-180-27" name="__codelineno-180-27" href="#__codelineno-180-27"></a>
</code></pre></div>
<hr />
<h4 id="66-three-phase-commit-3pc-protocol">6.6 Three-Phase Commit (3PC) Protocol</h4>
<p><strong>Description:</strong></p>
<p><strong>Three-Phase Commit (3PC)</strong> is a non-blocking atomic commitment protocol designed to solve the blocking problem of Two-Phase Commit (2PC). Developed by <strong>Dale Skeen</strong> in his 1981 doctoral dissertation at UC Berkeley, 3PC introduces an additional phase between the voting and commit phases to prevent participants from blocking when the coordinator fails.</p>
<p><strong>The Core Innovation:</strong></p>
<p>While 2PC can block when the coordinator crashes after participants vote YES, 3PC adds a <strong>PreCommit</strong> phase that allows participants to distinguish between "transaction will definitely abort" and "transaction might commit." This enables participants to make progress even if the coordinator fails.</p>
<p><strong>Why 3PC Was Created:</strong></p>
<p>The fundamental problem with 2PC is that participants enter an <strong>uncertain state</strong> after voting YES:
- They don't know if coordinator received their vote
- They don't know if other participants voted YES
- They don't know the final decision
- They <strong>cannot abort</strong> (might be only failure)
- They <strong>cannot commit</strong> (others might have voted NO)
- Result: <strong>BLOCKED indefinitely</strong> </p>
<p>3PC solves this by ensuring participants always know whether the transaction <strong>can still abort</strong> or <strong>must eventually commit</strong>.</p>
<p><strong>Historical Context:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a>
<a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a>         EVOLUTION: 2PC  3PC                            
<a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a>
<a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a>                                                         
<a id="__codelineno-181-5" name="__codelineno-181-5" href="#__codelineno-181-5"></a> 1970s: Two-Phase Commit (Jim Gray, IBM)                
<a id="__codelineno-181-6" name="__codelineno-181-6" href="#__codelineno-181-6"></a>         Simple, widely adopted                         
<a id="__codelineno-181-7" name="__codelineno-181-7" href="#__codelineno-181-7"></a>         Problem: Blocking on coordinator failure       
<a id="__codelineno-181-8" name="__codelineno-181-8" href="#__codelineno-181-8"></a>                                                         
<a id="__codelineno-181-9" name="__codelineno-181-9" href="#__codelineno-181-9"></a> 1981: Three-Phase Commit (Dale Skeen, Berkeley)        
<a id="__codelineno-181-10" name="__codelineno-181-10" href="#__codelineno-181-10"></a>         Added PreCommit phase                          
<a id="__codelineno-181-11" name="__codelineno-181-11" href="#__codelineno-181-11"></a>         Non-blocking under single failures             
<a id="__codelineno-181-12" name="__codelineno-181-12" href="#__codelineno-181-12"></a>         Trade-off: More complex, more messages         
<a id="__codelineno-181-13" name="__codelineno-181-13" href="#__codelineno-181-13"></a>                                                         
<a id="__codelineno-181-14" name="__codelineno-181-14" href="#__codelineno-181-14"></a> Reality: 2PC still dominates                            
<a id="__codelineno-181-15" name="__codelineno-181-15" href="#__codelineno-181-15"></a>         3PC rarely used in practice                    
<a id="__codelineno-181-16" name="__codelineno-181-16" href="#__codelineno-181-16"></a>         Network partitions remain problematic          
<a id="__codelineno-181-17" name="__codelineno-181-17" href="#__codelineno-181-17"></a>         Modern systems use consensus protocols         
<a id="__codelineno-181-18" name="__codelineno-181-18" href="#__codelineno-181-18"></a>          (Paxos, Raft) instead                          
<a id="__codelineno-181-19" name="__codelineno-181-19" href="#__codelineno-181-19"></a>                                                         
<a id="__codelineno-181-20" name="__codelineno-181-20" href="#__codelineno-181-20"></a>
</code></pre></div>
<p><strong>The Three Phases:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a>
<a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a>         THREE-PHASE COMMIT PROTOCOL                     
<a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a>
<a id="__codelineno-182-4" name="__codelineno-182-4" href="#__codelineno-182-4"></a>                                                         
<a id="__codelineno-182-5" name="__codelineno-182-5" href="#__codelineno-182-5"></a> PHASE 1: CAN-COMMIT (Voting Phase)                      
<a id="__codelineno-182-6" name="__codelineno-182-6" href="#__codelineno-182-6"></a>                      
<a id="__codelineno-182-7" name="__codelineno-182-7" href="#__codelineno-182-7"></a>  Coordinator asks: &quot;Can you commit?&quot;                   
<a id="__codelineno-182-8" name="__codelineno-182-8" href="#__codelineno-182-8"></a>  Participants vote YES or NO                           
<a id="__codelineno-182-9" name="__codelineno-182-9" href="#__codelineno-182-9"></a>  If any NO  ABORT immediately                         
<a id="__codelineno-182-10" name="__codelineno-182-10" href="#__codelineno-182-10"></a>  If all YES  Proceed to Phase 2                       
<a id="__codelineno-182-11" name="__codelineno-182-11" href="#__codelineno-182-11"></a>                                                         
<a id="__codelineno-182-12" name="__codelineno-182-12" href="#__codelineno-182-12"></a> PHASE 2: PRE-COMMIT (Preparation Phase)  NEW!         
<a id="__codelineno-182-13" name="__codelineno-182-13" href="#__codelineno-182-13"></a>                  
<a id="__codelineno-182-14" name="__codelineno-182-14" href="#__codelineno-182-14"></a>  Coordinator sends: &quot;Prepare to commit&quot;                
<a id="__codelineno-182-15" name="__codelineno-182-15" href="#__codelineno-182-15"></a>  Participants acknowledge PreCommit                    
<a id="__codelineno-182-16" name="__codelineno-182-16" href="#__codelineno-182-16"></a>  Participants enter PRE-COMMITTED state                
<a id="__codelineno-182-17" name="__codelineno-182-17" href="#__codelineno-182-17"></a>  Now participants KNOW transaction will commit         
<a id="__codelineno-182-18" name="__codelineno-182-18" href="#__codelineno-182-18"></a>  This phase makes protocol non-blocking!               
<a id="__codelineno-182-19" name="__codelineno-182-19" href="#__codelineno-182-19"></a>                                                         
<a id="__codelineno-182-20" name="__codelineno-182-20" href="#__codelineno-182-20"></a> PHASE 3: DO-COMMIT (Commit Phase)                       
<a id="__codelineno-182-21" name="__codelineno-182-21" href="#__codelineno-182-21"></a>                       
<a id="__codelineno-182-22" name="__codelineno-182-22" href="#__codelineno-182-22"></a>  Coordinator sends: &quot;Do commit&quot;                        
<a id="__codelineno-182-23" name="__codelineno-182-23" href="#__codelineno-182-23"></a>  Participants commit transaction                       
<a id="__codelineno-182-24" name="__codelineno-182-24" href="#__codelineno-182-24"></a>  Release locks and send ACK                            
<a id="__codelineno-182-25" name="__codelineno-182-25" href="#__codelineno-182-25"></a>  Transaction complete                                  
<a id="__codelineno-182-26" name="__codelineno-182-26" href="#__codelineno-182-26"></a>                                                         
<a id="__codelineno-182-27" name="__codelineno-182-27" href="#__codelineno-182-27"></a>
</code></pre></div>
<p><strong>3PC Protocol Diagram (Success Scenario):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a>
<a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a>       3PC PROTOCOL - SUCCESSFUL COMMIT                  
<a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a>
<a id="__codelineno-183-4" name="__codelineno-183-4" href="#__codelineno-183-4"></a>                                                         
<a id="__codelineno-183-5" name="__codelineno-183-5" href="#__codelineno-183-5"></a>   Coordinator              Participant A  Participant B 
<a id="__codelineno-183-6" name="__codelineno-183-6" href="#__codelineno-183-6"></a>                                                        
<a id="__codelineno-183-7" name="__codelineno-183-7" href="#__codelineno-183-7"></a>  PHASE 1: CAN-COMMIT          
<a id="__codelineno-183-8" name="__codelineno-183-8" href="#__codelineno-183-8"></a>                                                        
<a id="__codelineno-183-9" name="__codelineno-183-9" href="#__codelineno-183-9"></a>         1. CAN-COMMIT?                                 
<a id="__codelineno-183-10" name="__codelineno-183-10" href="#__codelineno-183-10"></a>                                     
<a id="__codelineno-183-11" name="__codelineno-183-11" href="#__codelineno-183-11"></a>                          Can commit?         
<a id="__codelineno-183-12" name="__codelineno-183-12" href="#__codelineno-183-12"></a>                                   Check constraints   
<a id="__codelineno-183-13" name="__codelineno-183-13" href="#__codelineno-183-13"></a>                                   Vote: YES           
<a id="__codelineno-183-14" name="__codelineno-183-14" href="#__codelineno-183-14"></a>                                                       
<a id="__codelineno-183-15" name="__codelineno-183-15" href="#__codelineno-183-15"></a>                          Can commit?         
<a id="__codelineno-183-16" name="__codelineno-183-16" href="#__codelineno-183-16"></a>                                   Vote: YES           
<a id="__codelineno-183-17" name="__codelineno-183-17" href="#__codelineno-183-17"></a>                                                       
<a id="__codelineno-183-18" name="__codelineno-183-18" href="#__codelineno-183-18"></a>         2. Collect votes (all YES)                     
<a id="__codelineno-183-19" name="__codelineno-183-19" href="#__codelineno-183-19"></a>        YES                         
<a id="__codelineno-183-20" name="__codelineno-183-20" href="#__codelineno-183-20"></a>        YES                         
<a id="__codelineno-183-21" name="__codelineno-183-21" href="#__codelineno-183-21"></a>                                                        
<a id="__codelineno-183-22" name="__codelineno-183-22" href="#__codelineno-183-22"></a>         Decision: Proceed to PreCommit                 
<a id="__codelineno-183-23" name="__codelineno-183-23" href="#__codelineno-183-23"></a>                                                        
<a id="__codelineno-183-24" name="__codelineno-183-24" href="#__codelineno-183-24"></a>  PHASE 2: PRE-COMMIT         
<a id="__codelineno-183-25" name="__codelineno-183-25" href="#__codelineno-183-25"></a>                                                        
<a id="__codelineno-183-26" name="__codelineno-183-26" href="#__codelineno-183-26"></a>         3. PRE-COMMIT!                                 
<a id="__codelineno-183-27" name="__codelineno-183-27" href="#__codelineno-183-27"></a>                                     
<a id="__codelineno-183-28" name="__codelineno-183-28" href="#__codelineno-183-28"></a>                          Write PreCommit log 
<a id="__codelineno-183-29" name="__codelineno-183-29" href="#__codelineno-183-29"></a>                                   Enter PRE-COMMITTED 
<a id="__codelineno-183-30" name="__codelineno-183-30" href="#__codelineno-183-30"></a>                                   ACK                 
<a id="__codelineno-183-31" name="__codelineno-183-31" href="#__codelineno-183-31"></a>                                                       
<a id="__codelineno-183-32" name="__codelineno-183-32" href="#__codelineno-183-32"></a>                          Write PreCommit log 
<a id="__codelineno-183-33" name="__codelineno-183-33" href="#__codelineno-183-33"></a>                                   Enter PRE-COMMITTED 
<a id="__codelineno-183-34" name="__codelineno-183-34" href="#__codelineno-183-34"></a>                                   ACK                 
<a id="__codelineno-183-35" name="__codelineno-183-35" href="#__codelineno-183-35"></a>                                                       
<a id="__codelineno-183-36" name="__codelineno-183-36" href="#__codelineno-183-36"></a>         4. Collect ACKs (all received)                 
<a id="__codelineno-183-37" name="__codelineno-183-37" href="#__codelineno-183-37"></a>        ACK                         
<a id="__codelineno-183-38" name="__codelineno-183-38" href="#__codelineno-183-38"></a>        ACK                         
<a id="__codelineno-183-39" name="__codelineno-183-39" href="#__codelineno-183-39"></a>                                                        
<a id="__codelineno-183-40" name="__codelineno-183-40" href="#__codelineno-183-40"></a>         Write COMMIT to log                            
<a id="__codelineno-183-41" name="__codelineno-183-41" href="#__codelineno-183-41"></a>                                                        
<a id="__codelineno-183-42" name="__codelineno-183-42" href="#__codelineno-183-42"></a>  PHASE 3: DO-COMMIT         
<a id="__codelineno-183-43" name="__codelineno-183-43" href="#__codelineno-183-43"></a>                                                        
<a id="__codelineno-183-44" name="__codelineno-183-44" href="#__codelineno-183-44"></a>         5. DO-COMMIT!                                  
<a id="__codelineno-183-45" name="__codelineno-183-45" href="#__codelineno-183-45"></a>                                     
<a id="__codelineno-183-46" name="__codelineno-183-46" href="#__codelineno-183-46"></a>                          Commit transaction  
<a id="__codelineno-183-47" name="__codelineno-183-47" href="#__codelineno-183-47"></a>                                   Release locks       
<a id="__codelineno-183-48" name="__codelineno-183-48" href="#__codelineno-183-48"></a>                                   ACK                 
<a id="__codelineno-183-49" name="__codelineno-183-49" href="#__codelineno-183-49"></a>                                                       
<a id="__codelineno-183-50" name="__codelineno-183-50" href="#__codelineno-183-50"></a>                          Commit transaction  
<a id="__codelineno-183-51" name="__codelineno-183-51" href="#__codelineno-183-51"></a>                                   Release locks       
<a id="__codelineno-183-52" name="__codelineno-183-52" href="#__codelineno-183-52"></a>                                   ACK                 
<a id="__codelineno-183-53" name="__codelineno-183-53" href="#__codelineno-183-53"></a>                                                       
<a id="__codelineno-183-54" name="__codelineno-183-54" href="#__codelineno-183-54"></a>         6. Transaction complete                        
<a id="__codelineno-183-55" name="__codelineno-183-55" href="#__codelineno-183-55"></a>        ACK                         
<a id="__codelineno-183-56" name="__codelineno-183-56" href="#__codelineno-183-56"></a>        ACK                         
<a id="__codelineno-183-57" name="__codelineno-183-57" href="#__codelineno-183-57"></a>                                                        
<a id="__codelineno-183-58" name="__codelineno-183-58" href="#__codelineno-183-58"></a>         Done!                                          
<a id="__codelineno-183-59" name="__codelineno-183-59" href="#__codelineno-183-59"></a>                                                         
<a id="__codelineno-183-60" name="__codelineno-183-60" href="#__codelineno-183-60"></a>  RESULT: All committed successfully                   
<a id="__codelineno-183-61" name="__codelineno-183-61" href="#__codelineno-183-61"></a>                                                         
<a id="__codelineno-183-62" name="__codelineno-183-62" href="#__codelineno-183-62"></a>
</code></pre></div>
<p><strong>3PC Abort Scenario (Vote NO in Phase 1):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a>
<a id="__codelineno-184-2" name="__codelineno-184-2" href="#__codelineno-184-2"></a>       3PC PROTOCOL - ABORT SCENARIO                     
<a id="__codelineno-184-3" name="__codelineno-184-3" href="#__codelineno-184-3"></a>
<a id="__codelineno-184-4" name="__codelineno-184-4" href="#__codelineno-184-4"></a>                                                         
<a id="__codelineno-184-5" name="__codelineno-184-5" href="#__codelineno-184-5"></a>   Coordinator              Participant A  Participant B 
<a id="__codelineno-184-6" name="__codelineno-184-6" href="#__codelineno-184-6"></a>                                                        
<a id="__codelineno-184-7" name="__codelineno-184-7" href="#__codelineno-184-7"></a>  PHASE 1: CAN-COMMIT          
<a id="__codelineno-184-8" name="__codelineno-184-8" href="#__codelineno-184-8"></a>                                                        
<a id="__codelineno-184-9" name="__codelineno-184-9" href="#__codelineno-184-9"></a>         1. CAN-COMMIT?                                 
<a id="__codelineno-184-10" name="__codelineno-184-10" href="#__codelineno-184-10"></a>                                     
<a id="__codelineno-184-11" name="__codelineno-184-11" href="#__codelineno-184-11"></a>                          Can commit?         
<a id="__codelineno-184-12" name="__codelineno-184-12" href="#__codelineno-184-12"></a>                                   Vote: YES           
<a id="__codelineno-184-13" name="__codelineno-184-13" href="#__codelineno-184-13"></a>                                                       
<a id="__codelineno-184-14" name="__codelineno-184-14" href="#__codelineno-184-14"></a>                          Can commit?         
<a id="__codelineno-184-15" name="__codelineno-184-15" href="#__codelineno-184-15"></a>                                   [Constraint fails!] 
<a id="__codelineno-184-16" name="__codelineno-184-16" href="#__codelineno-184-16"></a>                                   Vote: NO          
<a id="__codelineno-184-17" name="__codelineno-184-17" href="#__codelineno-184-17"></a>                                                       
<a id="__codelineno-184-18" name="__codelineno-184-18" href="#__codelineno-184-18"></a>         2. Collect votes (got NO)                      
<a id="__codelineno-184-19" name="__codelineno-184-19" href="#__codelineno-184-19"></a>        YES                         
<a id="__codelineno-184-20" name="__codelineno-184-20" href="#__codelineno-184-20"></a>        NO                          
<a id="__codelineno-184-21" name="__codelineno-184-21" href="#__codelineno-184-21"></a>                                                        
<a id="__codelineno-184-22" name="__codelineno-184-22" href="#__codelineno-184-22"></a>         Decision: ABORT (immediate)                    
<a id="__codelineno-184-23" name="__codelineno-184-23" href="#__codelineno-184-23"></a>         Write ABORT to log                             
<a id="__codelineno-184-24" name="__codelineno-184-24" href="#__codelineno-184-24"></a>                                                        
<a id="__codelineno-184-25" name="__codelineno-184-25" href="#__codelineno-184-25"></a>  ABORT - Skip Phase 2 &amp; 3          
<a id="__codelineno-184-26" name="__codelineno-184-26" href="#__codelineno-184-26"></a>                                                        
<a id="__codelineno-184-27" name="__codelineno-184-27" href="#__codelineno-184-27"></a>         3. ABORT!                                      
<a id="__codelineno-184-28" name="__codelineno-184-28" href="#__codelineno-184-28"></a>                                     
<a id="__codelineno-184-29" name="__codelineno-184-29" href="#__codelineno-184-29"></a>                          Abort transaction   
<a id="__codelineno-184-30" name="__codelineno-184-30" href="#__codelineno-184-30"></a>                                   ACK                 
<a id="__codelineno-184-31" name="__codelineno-184-31" href="#__codelineno-184-31"></a>                                                       
<a id="__codelineno-184-32" name="__codelineno-184-32" href="#__codelineno-184-32"></a>                          Abort transaction   
<a id="__codelineno-184-33" name="__codelineno-184-33" href="#__codelineno-184-33"></a>                                   ACK                 
<a id="__codelineno-184-34" name="__codelineno-184-34" href="#__codelineno-184-34"></a>                                                       
<a id="__codelineno-184-35" name="__codelineno-184-35" href="#__codelineno-184-35"></a>         4. Transaction aborted                         
<a id="__codelineno-184-36" name="__codelineno-184-36" href="#__codelineno-184-36"></a>        ACK                         
<a id="__codelineno-184-37" name="__codelineno-184-37" href="#__codelineno-184-37"></a>        ACK                         
<a id="__codelineno-184-38" name="__codelineno-184-38" href="#__codelineno-184-38"></a>                                                        
<a id="__codelineno-184-39" name="__codelineno-184-39" href="#__codelineno-184-39"></a>         Done                                           
<a id="__codelineno-184-40" name="__codelineno-184-40" href="#__codelineno-184-40"></a>                                                         
<a id="__codelineno-184-41" name="__codelineno-184-41" href="#__codelineno-184-41"></a>  RESULT: All aborted (no Phase 2/3 needed)            
<a id="__codelineno-184-42" name="__codelineno-184-42" href="#__codelineno-184-42"></a>                                                         
<a id="__codelineno-184-43" name="__codelineno-184-43" href="#__codelineno-184-43"></a>
</code></pre></div>
<p><strong>Key Difference from 2PC - The PreCommit State:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a>
<a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a>    WHY PHASE 2 (PRE-COMMIT) MAKES 3PC NON-BLOCKING      
<a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a>
<a id="__codelineno-185-4" name="__codelineno-185-4" href="#__codelineno-185-4"></a>                                                         
<a id="__codelineno-185-5" name="__codelineno-185-5" href="#__codelineno-185-5"></a> In 2PC (BLOCKING):                                      
<a id="__codelineno-185-6" name="__codelineno-185-6" href="#__codelineno-185-6"></a>            
<a id="__codelineno-185-7" name="__codelineno-185-7" href="#__codelineno-185-7"></a>  After voting YES, participant is BLOCKED            
<a id="__codelineno-185-8" name="__codelineno-185-8" href="#__codelineno-185-8"></a>   Doesn&#39;t know if others voted YES                  
<a id="__codelineno-185-9" name="__codelineno-185-9" href="#__codelineno-185-9"></a>   Cannot abort (might be only failure)              
<a id="__codelineno-185-10" name="__codelineno-185-10" href="#__codelineno-185-10"></a>   Cannot commit (don&#39;t know decision)               
<a id="__codelineno-185-11" name="__codelineno-185-11" href="#__codelineno-185-11"></a>   STUCK waiting for coordinator!                  
<a id="__codelineno-185-12" name="__codelineno-185-12" href="#__codelineno-185-12"></a>            
<a id="__codelineno-185-13" name="__codelineno-185-13" href="#__codelineno-185-13"></a>                                                         
<a id="__codelineno-185-14" name="__codelineno-185-14" href="#__codelineno-185-14"></a> In 3PC (NON-BLOCKING):                                  
<a id="__codelineno-185-15" name="__codelineno-185-15" href="#__codelineno-185-15"></a>            
<a id="__codelineno-185-16" name="__codelineno-185-16" href="#__codelineno-185-16"></a>  After receiving PRE-COMMIT:                         
<a id="__codelineno-185-17" name="__codelineno-185-17" href="#__codelineno-185-17"></a>   Participant KNOWS all voted YES                   
<a id="__codelineno-185-18" name="__codelineno-185-18" href="#__codelineno-185-18"></a>   Coordinator decided to commit                     
<a id="__codelineno-185-19" name="__codelineno-185-19" href="#__codelineno-185-19"></a>   Transaction WILL eventually commit                
<a id="__codelineno-185-20" name="__codelineno-185-20" href="#__codelineno-185-20"></a>   If coordinator fails  COMMIT anyway!             
<a id="__codelineno-185-21" name="__codelineno-185-21" href="#__codelineno-185-21"></a>   Can make progress independently!                
<a id="__codelineno-185-22" name="__codelineno-185-22" href="#__codelineno-185-22"></a>            
<a id="__codelineno-185-23" name="__codelineno-185-23" href="#__codelineno-185-23"></a>                                                         
<a id="__codelineno-185-24" name="__codelineno-185-24" href="#__codelineno-185-24"></a> State Knowledge:                                        
<a id="__codelineno-185-25" name="__codelineno-185-25" href="#__codelineno-185-25"></a>  BEFORE PreCommit: Transaction can still abort         
<a id="__codelineno-185-26" name="__codelineno-185-26" href="#__codelineno-185-26"></a>    If timeout, abort safely                            
<a id="__codelineno-185-27" name="__codelineno-185-27" href="#__codelineno-185-27"></a>                                                         
<a id="__codelineno-185-28" name="__codelineno-185-28" href="#__codelineno-185-28"></a>  AFTER PreCommit: Transaction will commit              
<a id="__codelineno-185-29" name="__codelineno-185-29" href="#__codelineno-185-29"></a>    If timeout, commit safely                           
<a id="__codelineno-185-30" name="__codelineno-185-30" href="#__codelineno-185-30"></a>                                                         
<a id="__codelineno-185-31" name="__codelineno-185-31" href="#__codelineno-185-31"></a> This distinction enables non-blocking behavior!         
<a id="__codelineno-185-32" name="__codelineno-185-32" href="#__codelineno-185-32"></a>                                                         
<a id="__codelineno-185-33" name="__codelineno-185-33" href="#__codelineno-185-33"></a>
</code></pre></div>
<p><strong>3PC State Machine - Coordinator:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a>
<a id="__codelineno-186-2" name="__codelineno-186-2" href="#__codelineno-186-2"></a>       3PC COORDINATOR STATE MACHINE                     
<a id="__codelineno-186-3" name="__codelineno-186-3" href="#__codelineno-186-3"></a>
<a id="__codelineno-186-4" name="__codelineno-186-4" href="#__codelineno-186-4"></a>                                                         
<a id="__codelineno-186-5" name="__codelineno-186-5" href="#__codelineno-186-5"></a>                                             
<a id="__codelineno-186-6" name="__codelineno-186-6" href="#__codelineno-186-6"></a>                    INIT                               
<a id="__codelineno-186-7" name="__codelineno-186-7" href="#__codelineno-186-7"></a>                                             
<a id="__codelineno-186-8" name="__codelineno-186-8" href="#__codelineno-186-8"></a>                                                        
<a id="__codelineno-186-9" name="__codelineno-186-9" href="#__codelineno-186-9"></a>                        Send CAN-COMMIT                 
<a id="__codelineno-186-10" name="__codelineno-186-10" href="#__codelineno-186-10"></a>                                                        
<a id="__codelineno-186-11" name="__codelineno-186-11" href="#__codelineno-186-11"></a>                                             
<a id="__codelineno-186-12" name="__codelineno-186-12" href="#__codelineno-186-12"></a>              WAIT                               
<a id="__codelineno-186-13" name="__codelineno-186-13" href="#__codelineno-186-13"></a>                 (for votes                           
<a id="__codelineno-186-14" name="__codelineno-186-14" href="#__codelineno-186-14"></a>                                            
<a id="__codelineno-186-15" name="__codelineno-186-15" href="#__codelineno-186-15"></a>    Timeout                                            
<a id="__codelineno-186-16" name="__codelineno-186-16" href="#__codelineno-186-16"></a>    (ABORT)            All votes received              
<a id="__codelineno-186-17" name="__codelineno-186-17" href="#__codelineno-186-17"></a>                                                       
<a id="__codelineno-186-18" name="__codelineno-186-18" href="#__codelineno-186-18"></a>                                            
<a id="__codelineno-186-19" name="__codelineno-186-19" href="#__codelineno-186-19"></a>                   DECIDE                             
<a id="__codelineno-186-20" name="__codelineno-186-20" href="#__codelineno-186-20"></a>                                            
<a id="__codelineno-186-21" name="__codelineno-186-21" href="#__codelineno-186-21"></a>                                                       
<a id="__codelineno-186-22" name="__codelineno-186-22" href="#__codelineno-186-22"></a>                                           
<a id="__codelineno-186-23" name="__codelineno-186-23" href="#__codelineno-186-23"></a>                                                      
<a id="__codelineno-186-24" name="__codelineno-186-24" href="#__codelineno-186-24"></a>                                                      
<a id="__codelineno-186-25" name="__codelineno-186-25" href="#__codelineno-186-25"></a>                                             
<a id="__codelineno-186-26" name="__codelineno-186-26" href="#__codelineno-186-26"></a>             ABORT       All YES                    
<a id="__codelineno-186-27" name="__codelineno-186-27" href="#__codelineno-186-27"></a>                                              
<a id="__codelineno-186-28" name="__codelineno-186-28" href="#__codelineno-186-28"></a>                                            
<a id="__codelineno-186-29" name="__codelineno-186-29" href="#__codelineno-186-29"></a>                      PRE-COMMIT  NEW STATE         
<a id="__codelineno-186-30" name="__codelineno-186-30" href="#__codelineno-186-30"></a>                        (send)                        
<a id="__codelineno-186-31" name="__codelineno-186-31" href="#__codelineno-186-31"></a>                                            
<a id="__codelineno-186-32" name="__codelineno-186-32" href="#__codelineno-186-32"></a>                                                       
<a id="__codelineno-186-33" name="__codelineno-186-33" href="#__codelineno-186-33"></a>                            Wait for ACKs              
<a id="__codelineno-186-34" name="__codelineno-186-34" href="#__codelineno-186-34"></a>                                                       
<a id="__codelineno-186-35" name="__codelineno-186-35" href="#__codelineno-186-35"></a>                                            
<a id="__codelineno-186-36" name="__codelineno-186-36" href="#__codelineno-186-36"></a>                         WAIT                         
<a id="__codelineno-186-37" name="__codelineno-186-37" href="#__codelineno-186-37"></a>                      (for ACKs)                      
<a id="__codelineno-186-38" name="__codelineno-186-38" href="#__codelineno-186-38"></a>                                            
<a id="__codelineno-186-39" name="__codelineno-186-39" href="#__codelineno-186-39"></a>                                                       
<a id="__codelineno-186-40" name="__codelineno-186-40" href="#__codelineno-186-40"></a>                            All ACKs received          
<a id="__codelineno-186-41" name="__codelineno-186-41" href="#__codelineno-186-41"></a>                                                       
<a id="__codelineno-186-42" name="__codelineno-186-42" href="#__codelineno-186-42"></a>                                            
<a id="__codelineno-186-43" name="__codelineno-186-43" href="#__codelineno-186-43"></a>                      DO-COMMIT                       
<a id="__codelineno-186-44" name="__codelineno-186-44" href="#__codelineno-186-44"></a>                        (send)                        
<a id="__codelineno-186-45" name="__codelineno-186-45" href="#__codelineno-186-45"></a>                                            
<a id="__codelineno-186-46" name="__codelineno-186-46" href="#__codelineno-186-46"></a>                                                       
<a id="__codelineno-186-47" name="__codelineno-186-47" href="#__codelineno-186-47"></a>                                                       
<a id="__codelineno-186-48" name="__codelineno-186-48" href="#__codelineno-186-48"></a>                                     
<a id="__codelineno-186-49" name="__codelineno-186-49" href="#__codelineno-186-49"></a>                WAIT FOR ACKS                          
<a id="__codelineno-186-50" name="__codelineno-186-50" href="#__codelineno-186-50"></a>                                     
<a id="__codelineno-186-51" name="__codelineno-186-51" href="#__codelineno-186-51"></a>                                                        
<a id="__codelineno-186-52" name="__codelineno-186-52" href="#__codelineno-186-52"></a>                        All ACKs                        
<a id="__codelineno-186-53" name="__codelineno-186-53" href="#__codelineno-186-53"></a>                                                        
<a id="__codelineno-186-54" name="__codelineno-186-54" href="#__codelineno-186-54"></a>                                             
<a id="__codelineno-186-55" name="__codelineno-186-55" href="#__codelineno-186-55"></a>                     END                               
<a id="__codelineno-186-56" name="__codelineno-186-56" href="#__codelineno-186-56"></a>                                             
<a id="__codelineno-186-57" name="__codelineno-186-57" href="#__codelineno-186-57"></a>                                                         
<a id="__codelineno-186-58" name="__codelineno-186-58" href="#__codelineno-186-58"></a>
</code></pre></div>
<p><strong>3PC State Machine - Participant:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a>
<a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a>       3PC PARTICIPANT STATE MACHINE                     
<a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a>
<a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a>                                                         
<a id="__codelineno-187-5" name="__codelineno-187-5" href="#__codelineno-187-5"></a>                                             
<a id="__codelineno-187-6" name="__codelineno-187-6" href="#__codelineno-187-6"></a>                    INIT                               
<a id="__codelineno-187-7" name="__codelineno-187-7" href="#__codelineno-187-7"></a>                                             
<a id="__codelineno-187-8" name="__codelineno-187-8" href="#__codelineno-187-8"></a>                                                        
<a id="__codelineno-187-9" name="__codelineno-187-9" href="#__codelineno-187-9"></a>                        Receive CAN-COMMIT              
<a id="__codelineno-187-10" name="__codelineno-187-10" href="#__codelineno-187-10"></a>                                                        
<a id="__codelineno-187-11" name="__codelineno-187-11" href="#__codelineno-187-11"></a>                                             
<a id="__codelineno-187-12" name="__codelineno-187-12" href="#__codelineno-187-12"></a>                  CAN-COMMIT                           
<a id="__codelineno-187-13" name="__codelineno-187-13" href="#__codelineno-187-13"></a>                    (vote)                             
<a id="__codelineno-187-14" name="__codelineno-187-14" href="#__codelineno-187-14"></a>                                             
<a id="__codelineno-187-15" name="__codelineno-187-15" href="#__codelineno-187-15"></a>                                                        
<a id="__codelineno-187-16" name="__codelineno-187-16" href="#__codelineno-187-16"></a>                                              
<a id="__codelineno-187-17" name="__codelineno-187-17" href="#__codelineno-187-17"></a>                                                       
<a id="__codelineno-187-18" name="__codelineno-187-18" href="#__codelineno-187-18"></a>         Can                      Cannot               
<a id="__codelineno-187-19" name="__codelineno-187-19" href="#__codelineno-187-19"></a>         commit      commit                
<a id="__codelineno-187-20" name="__codelineno-187-20" href="#__codelineno-187-20"></a>          YES    NO                   
<a id="__codelineno-187-21" name="__codelineno-187-21" href="#__codelineno-187-21"></a>                                         
<a id="__codelineno-187-22" name="__codelineno-187-22" href="#__codelineno-187-22"></a>                                                     
<a id="__codelineno-187-23" name="__codelineno-187-23" href="#__codelineno-187-23"></a>                   Wait    Vote NO                   
<a id="__codelineno-187-24" name="__codelineno-187-24" href="#__codelineno-187-24"></a>                                     
<a id="__codelineno-187-25" name="__codelineno-187-25" href="#__codelineno-187-25"></a>                                            
<a id="__codelineno-187-26" name="__codelineno-187-26" href="#__codelineno-187-26"></a>               WAIT                                 
<a id="__codelineno-187-27" name="__codelineno-187-27" href="#__codelineno-187-27"></a>             (for msg                               
<a id="__codelineno-187-28" name="__codelineno-187-28" href="#__codelineno-187-28"></a>                                            
<a id="__codelineno-187-29" name="__codelineno-187-29" href="#__codelineno-187-29"></a>                                                     
<a id="__codelineno-187-30" name="__codelineno-187-30" href="#__codelineno-187-30"></a>                                           
<a id="__codelineno-187-31" name="__codelineno-187-31" href="#__codelineno-187-31"></a>                                                    
<a id="__codelineno-187-32" name="__codelineno-187-32" href="#__codelineno-187-32"></a>                                                    
<a id="__codelineno-187-33" name="__codelineno-187-33" href="#__codelineno-187-33"></a>                                 
<a id="__codelineno-187-34" name="__codelineno-187-34" href="#__codelineno-187-34"></a>            PRE-    ABORT                  
<a id="__codelineno-187-35" name="__codelineno-187-35" href="#__codelineno-187-35"></a>           COMMIT                         
<a id="__codelineno-187-36" name="__codelineno-187-36" href="#__codelineno-187-36"></a>           NEW!                                  
<a id="__codelineno-187-37" name="__codelineno-187-37" href="#__codelineno-187-37"></a>                                           
<a id="__codelineno-187-38" name="__codelineno-187-38" href="#__codelineno-187-38"></a>                                                    
<a id="__codelineno-187-39" name="__codelineno-187-39" href="#__codelineno-187-39"></a>               Wait for  Rollback                   
<a id="__codelineno-187-40" name="__codelineno-187-40" href="#__codelineno-187-40"></a>              DO-COMMIT                             
<a id="__codelineno-187-41" name="__codelineno-187-41" href="#__codelineno-187-41"></a>                                                    
<a id="__codelineno-187-42" name="__codelineno-187-42" href="#__codelineno-187-42"></a>                                           
<a id="__codelineno-187-43" name="__codelineno-187-43" href="#__codelineno-187-43"></a>           Timeout                                 
<a id="__codelineno-187-44" name="__codelineno-187-44" href="#__codelineno-187-44"></a>                                           
<a id="__codelineno-187-45" name="__codelineno-187-45" href="#__codelineno-187-45"></a>                                                    
<a id="__codelineno-187-46" name="__codelineno-187-46" href="#__codelineno-187-46"></a>                                                    
<a id="__codelineno-187-47" name="__codelineno-187-47" href="#__codelineno-187-47"></a>                                           
<a id="__codelineno-187-48" name="__codelineno-187-48" href="#__codelineno-187-48"></a>          COMMIT          Can commit            
<a id="__codelineno-187-49" name="__codelineno-187-49" href="#__codelineno-187-49"></a>           (forced)          on timeout!            
<a id="__codelineno-187-50" name="__codelineno-187-50" href="#__codelineno-187-50"></a>                                            
<a id="__codelineno-187-51" name="__codelineno-187-51" href="#__codelineno-187-51"></a>                                                     
<a id="__codelineno-187-52" name="__codelineno-187-52" href="#__codelineno-187-52"></a>                                                     
<a id="__codelineno-187-53" name="__codelineno-187-53" href="#__codelineno-187-53"></a>                    
<a id="__codelineno-187-54" name="__codelineno-187-54" href="#__codelineno-187-54"></a>                      END                             
<a id="__codelineno-187-55" name="__codelineno-187-55" href="#__codelineno-187-55"></a>                    
<a id="__codelineno-187-56" name="__codelineno-187-56" href="#__codelineno-187-56"></a>                                                         
<a id="__codelineno-187-57" name="__codelineno-187-57" href="#__codelineno-187-57"></a> Key: After PRE-COMMIT, if timeout  COMMIT              
<a id="__codelineno-187-58" name="__codelineno-187-58" href="#__codelineno-187-58"></a>      (Non-blocking!)                                    
<a id="__codelineno-187-59" name="__codelineno-187-59" href="#__codelineno-187-59"></a>                                                         
<a id="__codelineno-187-60" name="__codelineno-187-60" href="#__codelineno-187-60"></a>
</code></pre></div>
<hr />
<h4 id="67-how-three-phase-commit-handles-coordinator-failure">6.7 How Three-Phase Commit Handles Coordinator Failure</h4>
<p><strong>The Non-Blocking Property:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a>
<a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a>    3PC: HANDLING COORDINATOR FAILURE (NON-BLOCKING)     
<a id="__codelineno-188-3" name="__codelineno-188-3" href="#__codelineno-188-3"></a>
<a id="__codelineno-188-4" name="__codelineno-188-4" href="#__codelineno-188-4"></a>                                                         
<a id="__codelineno-188-5" name="__codelineno-188-5" href="#__codelineno-188-5"></a> Scenario 1: Coordinator fails BEFORE PreCommit         
<a id="__codelineno-188-6" name="__codelineno-188-6" href="#__codelineno-188-6"></a>          
<a id="__codelineno-188-7" name="__codelineno-188-7" href="#__codelineno-188-7"></a>                                                         
<a id="__codelineno-188-8" name="__codelineno-188-8" href="#__codelineno-188-8"></a> Timeline:                                               
<a id="__codelineno-188-9" name="__codelineno-188-9" href="#__codelineno-188-9"></a> t1    Coordinator sends CAN-COMMIT?                     
<a id="__codelineno-188-10" name="__codelineno-188-10" href="#__codelineno-188-10"></a> t2    Participants vote YES                             
<a id="__codelineno-188-11" name="__codelineno-188-11" href="#__codelineno-188-11"></a> t3     COORDINATOR CRASHES                          
<a id="__codelineno-188-12" name="__codelineno-188-12" href="#__codelineno-188-12"></a>       (Before sending PRE-COMMIT)                       
<a id="__codelineno-188-13" name="__codelineno-188-13" href="#__codelineno-188-13"></a>                                                         
<a id="__codelineno-188-14" name="__codelineno-188-14" href="#__codelineno-188-14"></a> Participant Recovery:                                   
<a id="__codelineno-188-15" name="__codelineno-188-15" href="#__codelineno-188-15"></a>            
<a id="__codelineno-188-16" name="__codelineno-188-16" href="#__codelineno-188-16"></a>   Voted YES, waiting for message                    
<a id="__codelineno-188-17" name="__codelineno-188-17" href="#__codelineno-188-17"></a>   Timeout expires                                   
<a id="__codelineno-188-18" name="__codelineno-188-18" href="#__codelineno-188-18"></a>   Check state: Not yet PRE-COMMITTED                
<a id="__codelineno-188-19" name="__codelineno-188-19" href="#__codelineno-188-19"></a>   Decision: ABORT (safe!)                           
<a id="__codelineno-188-20" name="__codelineno-188-20" href="#__codelineno-188-20"></a>   Reasoning: Transaction not committed              
<a id="__codelineno-188-21" name="__codelineno-188-21" href="#__codelineno-188-21"></a>    yet, so aborting is safe                          
<a id="__codelineno-188-22" name="__codelineno-188-22" href="#__codelineno-188-22"></a>            
<a id="__codelineno-188-23" name="__codelineno-188-23" href="#__codelineno-188-23"></a>                                                         
<a id="__codelineno-188-24" name="__codelineno-188-24" href="#__codelineno-188-24"></a>  Result: Participants abort independently             
<a id="__codelineno-188-25" name="__codelineno-188-25" href="#__codelineno-188-25"></a>    No blocking! System makes progress.                  
<a id="__codelineno-188-26" name="__codelineno-188-26" href="#__codelineno-188-26"></a>                                                         
<a id="__codelineno-188-27" name="__codelineno-188-27" href="#__codelineno-188-27"></a>          
<a id="__codelineno-188-28" name="__codelineno-188-28" href="#__codelineno-188-28"></a>                                                         
<a id="__codelineno-188-29" name="__codelineno-188-29" href="#__codelineno-188-29"></a> Scenario 2: Coordinator fails AFTER PreCommit          
<a id="__codelineno-188-30" name="__codelineno-188-30" href="#__codelineno-188-30"></a>             
<a id="__codelineno-188-31" name="__codelineno-188-31" href="#__codelineno-188-31"></a>                                                         
<a id="__codelineno-188-32" name="__codelineno-188-32" href="#__codelineno-188-32"></a> Timeline:                                               
<a id="__codelineno-188-33" name="__codelineno-188-33" href="#__codelineno-188-33"></a> t1    Coordinator sends CAN-COMMIT?                     
<a id="__codelineno-188-34" name="__codelineno-188-34" href="#__codelineno-188-34"></a> t2    Participants vote YES                             
<a id="__codelineno-188-35" name="__codelineno-188-35" href="#__codelineno-188-35"></a> t3    Coordinator sends PRE-COMMIT                      
<a id="__codelineno-188-36" name="__codelineno-188-36" href="#__codelineno-188-36"></a> t4    Participants acknowledge PRE-COMMIT               
<a id="__codelineno-188-37" name="__codelineno-188-37" href="#__codelineno-188-37"></a> t5     COORDINATOR CRASHES                          
<a id="__codelineno-188-38" name="__codelineno-188-38" href="#__codelineno-188-38"></a>       (Before sending DO-COMMIT)                        
<a id="__codelineno-188-39" name="__codelineno-188-39" href="#__codelineno-188-39"></a>                                                         
<a id="__codelineno-188-40" name="__codelineno-188-40" href="#__codelineno-188-40"></a> Participant Recovery:                                   
<a id="__codelineno-188-41" name="__codelineno-188-41" href="#__codelineno-188-41"></a>            
<a id="__codelineno-188-42" name="__codelineno-188-42" href="#__codelineno-188-42"></a>   Entered PRE-COMMITTED state                       
<a id="__codelineno-188-43" name="__codelineno-188-43" href="#__codelineno-188-43"></a>   Timeout expires (no DO-COMMIT)                    
<a id="__codelineno-188-44" name="__codelineno-188-44" href="#__codelineno-188-44"></a>   Check state: Already PRE-COMMITTED                
<a id="__codelineno-188-45" name="__codelineno-188-45" href="#__codelineno-188-45"></a>   Decision: COMMIT (safe!)                          
<a id="__codelineno-188-46" name="__codelineno-188-46" href="#__codelineno-188-46"></a>   Reasoning: Coordinator decided to                 
<a id="__codelineno-188-47" name="__codelineno-188-47" href="#__codelineno-188-47"></a>    commit, all participants agreed                   
<a id="__codelineno-188-48" name="__codelineno-188-48" href="#__codelineno-188-48"></a>            
<a id="__codelineno-188-49" name="__codelineno-188-49" href="#__codelineno-188-49"></a>                                                         
<a id="__codelineno-188-50" name="__codelineno-188-50" href="#__codelineno-188-50"></a>  Result: Participants commit independently            
<a id="__codelineno-188-51" name="__codelineno-188-51" href="#__codelineno-188-51"></a>    No blocking! Transaction completes.                  
<a id="__codelineno-188-52" name="__codelineno-188-52" href="#__codelineno-188-52"></a>                                                         
<a id="__codelineno-188-53" name="__codelineno-188-53" href="#__codelineno-188-53"></a>
</code></pre></div>
<p><strong>Termination Protocol (Participant Self-Recovery):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a>
<a id="__codelineno-189-2" name="__codelineno-189-2" href="#__codelineno-189-2"></a>    3PC TERMINATION PROTOCOL (PARTICIPANT RECOVERY)      
<a id="__codelineno-189-3" name="__codelineno-189-3" href="#__codelineno-189-3"></a>
<a id="__codelineno-189-4" name="__codelineno-189-4" href="#__codelineno-189-4"></a>                                                         
<a id="__codelineno-189-5" name="__codelineno-189-5" href="#__codelineno-189-5"></a> When coordinator fails, participant runs:               
<a id="__codelineno-189-6" name="__codelineno-189-6" href="#__codelineno-189-6"></a>                                                         
<a id="__codelineno-189-7" name="__codelineno-189-7" href="#__codelineno-189-7"></a>                 
<a id="__codelineno-189-8" name="__codelineno-189-8" href="#__codelineno-189-8"></a>   TERMINATION PROTOCOL                               
<a id="__codelineno-189-9" name="__codelineno-189-9" href="#__codelineno-189-9"></a>                 
<a id="__codelineno-189-10" name="__codelineno-189-10" href="#__codelineno-189-10"></a>                                                      
<a id="__codelineno-189-11" name="__codelineno-189-11" href="#__codelineno-189-11"></a>  1. Detect timeout (coordinator                      
<a id="__codelineno-189-12" name="__codelineno-189-12" href="#__codelineno-189-12"></a>     not responding)                                  
<a id="__codelineno-189-13" name="__codelineno-189-13" href="#__codelineno-189-13"></a>                                                      
<a id="__codelineno-189-14" name="__codelineno-189-14" href="#__codelineno-189-14"></a>  2. Contact other participants                       
<a id="__codelineno-189-15" name="__codelineno-189-15" href="#__codelineno-189-15"></a>     (find alive participants)                        
<a id="__codelineno-189-16" name="__codelineno-189-16" href="#__codelineno-189-16"></a>                                                      
<a id="__codelineno-189-17" name="__codelineno-189-17" href="#__codelineno-189-17"></a>  3. Gather states from all alive                     
<a id="__codelineno-189-18" name="__codelineno-189-18" href="#__codelineno-189-18"></a>     participants                                     
<a id="__codelineno-189-19" name="__codelineno-189-19" href="#__codelineno-189-19"></a>                                                      
<a id="__codelineno-189-20" name="__codelineno-189-20" href="#__codelineno-189-20"></a>  4. Apply decision rules:                            
<a id="__codelineno-189-21" name="__codelineno-189-21" href="#__codelineno-189-21"></a>                                                      
<a id="__codelineno-189-22" name="__codelineno-189-22" href="#__codelineno-189-22"></a>     IF any participant in ABORT:                     
<a id="__codelineno-189-23" name="__codelineno-189-23" href="#__codelineno-189-23"></a>         ALL ABORT                                   
<a id="__codelineno-189-24" name="__codelineno-189-24" href="#__codelineno-189-24"></a>                                                      
<a id="__codelineno-189-25" name="__codelineno-189-25" href="#__codelineno-189-25"></a>     ELSE IF any in PRE-COMMITTED:                    
<a id="__codelineno-189-26" name="__codelineno-189-26" href="#__codelineno-189-26"></a>         ALL COMMIT                                  
<a id="__codelineno-189-27" name="__codelineno-189-27" href="#__codelineno-189-27"></a>                                                      
<a id="__codelineno-189-28" name="__codelineno-189-28" href="#__codelineno-189-28"></a>     ELSE IF any in COMMITTED:                        
<a id="__codelineno-189-29" name="__codelineno-189-29" href="#__codelineno-189-29"></a>         ALL COMMIT                                  
<a id="__codelineno-189-30" name="__codelineno-189-30" href="#__codelineno-189-30"></a>                                                      
<a id="__codelineno-189-31" name="__codelineno-189-31" href="#__codelineno-189-31"></a>     ELSE (all in WAIT):                              
<a id="__codelineno-189-32" name="__codelineno-189-32" href="#__codelineno-189-32"></a>         ALL ABORT                                   
<a id="__codelineno-189-33" name="__codelineno-189-33" href="#__codelineno-189-33"></a>                                                      
<a id="__codelineno-189-34" name="__codelineno-189-34" href="#__codelineno-189-34"></a>  5. Execute decision                                 
<a id="__codelineno-189-35" name="__codelineno-189-35" href="#__codelineno-189-35"></a>                                                      
<a id="__codelineno-189-36" name="__codelineno-189-36" href="#__codelineno-189-36"></a>  6. Inform other participants                        
<a id="__codelineno-189-37" name="__codelineno-189-37" href="#__codelineno-189-37"></a>                                                      
<a id="__codelineno-189-38" name="__codelineno-189-38" href="#__codelineno-189-38"></a>                 
<a id="__codelineno-189-39" name="__codelineno-189-39" href="#__codelineno-189-39"></a>                                                         
<a id="__codelineno-189-40" name="__codelineno-189-40" href="#__codelineno-189-40"></a> Key Insight:                                            
<a id="__codelineno-189-41" name="__codelineno-189-41" href="#__codelineno-189-41"></a> The state information is sufficient to make             
<a id="__codelineno-189-42" name="__codelineno-189-42" href="#__codelineno-189-42"></a> a safe decision without coordinator!                    
<a id="__codelineno-189-43" name="__codelineno-189-43" href="#__codelineno-189-43"></a>                                                         
<a id="__codelineno-189-44" name="__codelineno-189-44" href="#__codelineno-189-44"></a>
</code></pre></div>
<p><strong>Comparison: 2PC vs 3PC Coordinator Failure:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a>
<a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a>    COORDINATOR FAILURE: 2PC vs 3PC                      
<a id="__codelineno-190-3" name="__codelineno-190-3" href="#__codelineno-190-3"></a>
<a id="__codelineno-190-4" name="__codelineno-190-4" href="#__codelineno-190-4"></a>                                                         
<a id="__codelineno-190-5" name="__codelineno-190-5" href="#__codelineno-190-5"></a> 2PC (BLOCKING):                                         
<a id="__codelineno-190-6" name="__codelineno-190-6" href="#__codelineno-190-6"></a>            
<a id="__codelineno-190-7" name="__codelineno-190-7" href="#__codelineno-190-7"></a>  Coordinator crashes after PREPARE                   
<a id="__codelineno-190-8" name="__codelineno-190-8" href="#__codelineno-190-8"></a>                                                      
<a id="__codelineno-190-9" name="__codelineno-190-9" href="#__codelineno-190-9"></a>  Participant state: READY                            
<a id="__codelineno-190-10" name="__codelineno-190-10" href="#__codelineno-190-10"></a>   Voted YES                                         
<a id="__codelineno-190-11" name="__codelineno-190-11" href="#__codelineno-190-11"></a>   Waiting for decision                              
<a id="__codelineno-190-12" name="__codelineno-190-12" href="#__codelineno-190-12"></a>                                                      
<a id="__codelineno-190-13" name="__codelineno-190-13" href="#__codelineno-190-13"></a>  Problem:                                            
<a id="__codelineno-190-14" name="__codelineno-190-14" href="#__codelineno-190-14"></a>   Cannot abort (others might commit)                
<a id="__codelineno-190-15" name="__codelineno-190-15" href="#__codelineno-190-15"></a>   Cannot commit (decision unknown)                  
<a id="__codelineno-190-16" name="__codelineno-190-16" href="#__codelineno-190-16"></a>   BLOCKED indefinitely                            
<a id="__codelineno-190-17" name="__codelineno-190-17" href="#__codelineno-190-17"></a>                                                      
<a id="__codelineno-190-18" name="__codelineno-190-18" href="#__codelineno-190-18"></a>  Impact:                                             
<a id="__codelineno-190-19" name="__codelineno-190-19" href="#__codelineno-190-19"></a>   Locks held until coordinator recovers             
<a id="__codelineno-190-20" name="__codelineno-190-20" href="#__codelineno-190-20"></a>   System unavailable                                
<a id="__codelineno-190-21" name="__codelineno-190-21" href="#__codelineno-190-21"></a>   Cascading failures                                
<a id="__codelineno-190-22" name="__codelineno-190-22" href="#__codelineno-190-22"></a>            
<a id="__codelineno-190-23" name="__codelineno-190-23" href="#__codelineno-190-23"></a>                                                         
<a id="__codelineno-190-24" name="__codelineno-190-24" href="#__codelineno-190-24"></a> 3PC (NON-BLOCKING):                                     
<a id="__codelineno-190-25" name="__codelineno-190-25" href="#__codelineno-190-25"></a>            
<a id="__codelineno-190-26" name="__codelineno-190-26" href="#__codelineno-190-26"></a>  Coordinator crashes after PRE-COMMIT                
<a id="__codelineno-190-27" name="__codelineno-190-27" href="#__codelineno-190-27"></a>                                                      
<a id="__codelineno-190-28" name="__codelineno-190-28" href="#__codelineno-190-28"></a>  Participant state: PRE-COMMITTED                    
<a id="__codelineno-190-29" name="__codelineno-190-29" href="#__codelineno-190-29"></a>   Voted YES                                         
<a id="__codelineno-190-30" name="__codelineno-190-30" href="#__codelineno-190-30"></a>   Received PRE-COMMIT                               
<a id="__codelineno-190-31" name="__codelineno-190-31" href="#__codelineno-190-31"></a>                                                      
<a id="__codelineno-190-32" name="__codelineno-190-32" href="#__codelineno-190-32"></a>  Solution:                                           
<a id="__codelineno-190-33" name="__codelineno-190-33" href="#__codelineno-190-33"></a>   KNOWS all voted YES                               
<a id="__codelineno-190-34" name="__codelineno-190-34" href="#__codelineno-190-34"></a>   KNOWS transaction will commit                     
<a id="__codelineno-190-35" name="__codelineno-190-35" href="#__codelineno-190-35"></a>   Can COMMIT independently                        
<a id="__codelineno-190-36" name="__codelineno-190-36" href="#__codelineno-190-36"></a>                                                      
<a id="__codelineno-190-37" name="__codelineno-190-37" href="#__codelineno-190-37"></a>  Impact:                                             
<a id="__codelineno-190-38" name="__codelineno-190-38" href="#__codelineno-190-38"></a>   Locks released after timeout                      
<a id="__codelineno-190-39" name="__codelineno-190-39" href="#__codelineno-190-39"></a>   System remains available                          
<a id="__codelineno-190-40" name="__codelineno-190-40" href="#__codelineno-190-40"></a>   Transaction completes                             
<a id="__codelineno-190-41" name="__codelineno-190-41" href="#__codelineno-190-41"></a>            
<a id="__codelineno-190-42" name="__codelineno-190-42" href="#__codelineno-190-42"></a>                                                         
<a id="__codelineno-190-43" name="__codelineno-190-43" href="#__codelineno-190-43"></a>
</code></pre></div>
<hr />
<h4 id="68-advantages-of-three-phase-commit">6.8 Advantages of Three-Phase Commit</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a>
<a id="__codelineno-191-2" name="__codelineno-191-2" href="#__codelineno-191-2"></a>         3PC ADVANTAGES                                  
<a id="__codelineno-191-3" name="__codelineno-191-3" href="#__codelineno-191-3"></a>
<a id="__codelineno-191-4" name="__codelineno-191-4" href="#__codelineno-191-4"></a>                                                         
<a id="__codelineno-191-5" name="__codelineno-191-5" href="#__codelineno-191-5"></a> 1.  NON-BLOCKING UNDER SINGLE FAILURES                
<a id="__codelineno-191-6" name="__codelineno-191-6" href="#__codelineno-191-6"></a>                
<a id="__codelineno-191-7" name="__codelineno-191-7" href="#__codelineno-191-7"></a>      Coordinator failure recoverable                
<a id="__codelineno-191-8" name="__codelineno-191-8" href="#__codelineno-191-8"></a>      Participants can make progress                 
<a id="__codelineno-191-9" name="__codelineno-191-9" href="#__codelineno-191-9"></a>      No indefinite waiting                          
<a id="__codelineno-191-10" name="__codelineno-191-10" href="#__codelineno-191-10"></a>      System remains available                       
<a id="__codelineno-191-11" name="__codelineno-191-11" href="#__codelineno-191-11"></a>                
<a id="__codelineno-191-12" name="__codelineno-191-12" href="#__codelineno-191-12"></a>                                                         
<a id="__codelineno-191-13" name="__codelineno-191-13" href="#__codelineno-191-13"></a> 2.  IMPROVED AVAILABILITY                             
<a id="__codelineno-191-14" name="__codelineno-191-14" href="#__codelineno-191-14"></a>                
<a id="__codelineno-191-15" name="__codelineno-191-15" href="#__codelineno-191-15"></a>      Better fault tolerance                         
<a id="__codelineno-191-16" name="__codelineno-191-16" href="#__codelineno-191-16"></a>      Shorter lock holding periods                   
<a id="__codelineno-191-17" name="__codelineno-191-17" href="#__codelineno-191-17"></a>      Reduced blocking time                          
<a id="__codelineno-191-18" name="__codelineno-191-18" href="#__codelineno-191-18"></a>      Graceful degradation                           
<a id="__codelineno-191-19" name="__codelineno-191-19" href="#__codelineno-191-19"></a>                
<a id="__codelineno-191-20" name="__codelineno-191-20" href="#__codelineno-191-20"></a>                                                         
<a id="__codelineno-191-21" name="__codelineno-191-21" href="#__codelineno-191-21"></a> 3.  ATOMICITY STILL GUARANTEED                        
<a id="__codelineno-191-22" name="__codelineno-191-22" href="#__codelineno-191-22"></a>                
<a id="__codelineno-191-23" name="__codelineno-191-23" href="#__codelineno-191-23"></a>      All-or-nothing across nodes                    
<a id="__codelineno-191-24" name="__codelineno-191-24" href="#__codelineno-191-24"></a>      Consistency maintained                         
<a id="__codelineno-191-25" name="__codelineno-191-25" href="#__codelineno-191-25"></a>      ACID properties preserved                      
<a id="__codelineno-191-26" name="__codelineno-191-26" href="#__codelineno-191-26"></a>      No partial commits                             
<a id="__codelineno-191-27" name="__codelineno-191-27" href="#__codelineno-191-27"></a>                
<a id="__codelineno-191-28" name="__codelineno-191-28" href="#__codelineno-191-28"></a>                                                         
<a id="__codelineno-191-29" name="__codelineno-191-29" href="#__codelineno-191-29"></a> 4.  TERMINATION PROTOCOL                              
<a id="__codelineno-191-30" name="__codelineno-191-30" href="#__codelineno-191-30"></a>                
<a id="__codelineno-191-31" name="__codelineno-191-31" href="#__codelineno-191-31"></a>      Participants can elect new leader              
<a id="__codelineno-191-32" name="__codelineno-191-32" href="#__codelineno-191-32"></a>      Cooperative decision making                    
<a id="__codelineno-191-33" name="__codelineno-191-33" href="#__codelineno-191-33"></a>      Distributed recovery                           
<a id="__codelineno-191-34" name="__codelineno-191-34" href="#__codelineno-191-34"></a>      No single point of failure                     
<a id="__codelineno-191-35" name="__codelineno-191-35" href="#__codelineno-191-35"></a>                
<a id="__codelineno-191-36" name="__codelineno-191-36" href="#__codelineno-191-36"></a>                                                         
<a id="__codelineno-191-37" name="__codelineno-191-37" href="#__codelineno-191-37"></a> 5.  CLEAR STATE BOUNDARIES                            
<a id="__codelineno-191-38" name="__codelineno-191-38" href="#__codelineno-191-38"></a>                
<a id="__codelineno-191-39" name="__codelineno-191-39" href="#__codelineno-191-39"></a>      &quot;Can abort&quot; vs &quot;Will commit&quot; clear             
<a id="__codelineno-191-40" name="__codelineno-191-40" href="#__codelineno-191-40"></a>      Unambiguous recovery decisions                 
<a id="__codelineno-191-41" name="__codelineno-191-41" href="#__codelineno-191-41"></a>      Easier to reason about                         
<a id="__codelineno-191-42" name="__codelineno-191-42" href="#__codelineno-191-42"></a>      Formal correctness proofs exist                
<a id="__codelineno-191-43" name="__codelineno-191-43" href="#__codelineno-191-43"></a>                
<a id="__codelineno-191-44" name="__codelineno-191-44" href="#__codelineno-191-44"></a>                                                         
<a id="__codelineno-191-45" name="__codelineno-191-45" href="#__codelineno-191-45"></a> 6.  BETTER THAN 2PC FOR LONG TRANSACTIONS             
<a id="__codelineno-191-46" name="__codelineno-191-46" href="#__codelineno-191-46"></a>                
<a id="__codelineno-191-47" name="__codelineno-191-47" href="#__codelineno-191-47"></a>      Reduces risk of indefinite block               
<a id="__codelineno-191-48" name="__codelineno-191-48" href="#__codelineno-191-48"></a>      Better for high-latency networks               
<a id="__codelineno-191-49" name="__codelineno-191-49" href="#__codelineno-191-49"></a>      Suitable for geo-distributed                   
<a id="__codelineno-191-50" name="__codelineno-191-50" href="#__codelineno-191-50"></a>                
<a id="__codelineno-191-51" name="__codelineno-191-51" href="#__codelineno-191-51"></a>                                                         
<a id="__codelineno-191-52" name="__codelineno-191-52" href="#__codelineno-191-52"></a>
</code></pre></div>
<hr />
<h4 id="69-disadvantages-of-three-phase-commit">6.9 Disadvantages of Three-Phase Commit</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-192-1" name="__codelineno-192-1" href="#__codelineno-192-1"></a>
<a id="__codelineno-192-2" name="__codelineno-192-2" href="#__codelineno-192-2"></a>         3PC DISADVANTAGES                               
<a id="__codelineno-192-3" name="__codelineno-192-3" href="#__codelineno-192-3"></a>
<a id="__codelineno-192-4" name="__codelineno-192-4" href="#__codelineno-192-4"></a>                                                         
<a id="__codelineno-192-5" name="__codelineno-192-5" href="#__codelineno-192-5"></a> 1.  MORE COMPLEX THAN 2PC                             
<a id="__codelineno-192-6" name="__codelineno-192-6" href="#__codelineno-192-6"></a>                
<a id="__codelineno-192-7" name="__codelineno-192-7" href="#__codelineno-192-7"></a>      Additional phase adds complexity               
<a id="__codelineno-192-8" name="__codelineno-192-8" href="#__codelineno-192-8"></a>      More states to manage                          
<a id="__codelineno-192-9" name="__codelineno-192-9" href="#__codelineno-192-9"></a>      Termination protocol needed                    
<a id="__codelineno-192-10" name="__codelineno-192-10" href="#__codelineno-192-10"></a>      Harder to implement correctly                  
<a id="__codelineno-192-11" name="__codelineno-192-11" href="#__codelineno-192-11"></a>                
<a id="__codelineno-192-12" name="__codelineno-192-12" href="#__codelineno-192-12"></a>                                                         
<a id="__codelineno-192-13" name="__codelineno-192-13" href="#__codelineno-192-13"></a> 2.  HIGHER LATENCY                                    
<a id="__codelineno-192-14" name="__codelineno-192-14" href="#__codelineno-192-14"></a>                
<a id="__codelineno-192-15" name="__codelineno-192-15" href="#__codelineno-192-15"></a>     Message counts:                                  
<a id="__codelineno-192-16" name="__codelineno-192-16" href="#__codelineno-192-16"></a>      2PC: 4N messages (4 rounds)                    
<a id="__codelineno-192-17" name="__codelineno-192-17" href="#__codelineno-192-17"></a>      3PC: 6N messages (6 rounds)                  
<a id="__codelineno-192-18" name="__codelineno-192-18" href="#__codelineno-192-18"></a>                                                      
<a id="__codelineno-192-19" name="__codelineno-192-19" href="#__codelineno-192-19"></a>     Latency analysis (N=3 participants):             
<a id="__codelineno-192-20" name="__codelineno-192-20" href="#__codelineno-192-20"></a>      2PC: ~35ms                                     
<a id="__codelineno-192-21" name="__codelineno-192-21" href="#__codelineno-192-21"></a>      3PC: ~50ms (43% slower)                        
<a id="__codelineno-192-22" name="__codelineno-192-22" href="#__codelineno-192-22"></a>                
<a id="__codelineno-192-23" name="__codelineno-192-23" href="#__codelineno-192-23"></a>                                                         
<a id="__codelineno-192-24" name="__codelineno-192-24" href="#__codelineno-192-24"></a> 3.  VULNERABLE TO NETWORK PARTITIONS                  
<a id="__codelineno-192-25" name="__codelineno-192-25" href="#__codelineno-192-25"></a>                
<a id="__codelineno-192-26" name="__codelineno-192-26" href="#__codelineno-192-26"></a>      Assumes reliable failure detection             
<a id="__codelineno-192-27" name="__codelineno-192-27" href="#__codelineno-192-27"></a>      Network partition can cause split-             
<a id="__codelineno-192-28" name="__codelineno-192-28" href="#__codelineno-192-28"></a>       brain scenarios                                
<a id="__codelineno-192-29" name="__codelineno-192-29" href="#__codelineno-192-29"></a>      Can violate consistency!                     
<a id="__codelineno-192-30" name="__codelineno-192-30" href="#__codelineno-192-30"></a>      NOT partition-tolerant (CAP)                   
<a id="__codelineno-192-31" name="__codelineno-192-31" href="#__codelineno-192-31"></a>                
<a id="__codelineno-192-32" name="__codelineno-192-32" href="#__codelineno-192-32"></a>                                                         
<a id="__codelineno-192-33" name="__codelineno-192-33" href="#__codelineno-192-33"></a> 4.  RARELY IMPLEMENTED IN PRACTICE                    
<a id="__codelineno-192-34" name="__codelineno-192-34" href="#__codelineno-192-34"></a>                
<a id="__codelineno-192-35" name="__codelineno-192-35" href="#__codelineno-192-35"></a>      Few database vendors support                   
<a id="__codelineno-192-36" name="__codelineno-192-36" href="#__codelineno-192-36"></a>      Limited tooling/frameworks                     
<a id="__codelineno-192-37" name="__codelineno-192-37" href="#__codelineno-192-37"></a>      Lack of production experience                  
<a id="__codelineno-192-38" name="__codelineno-192-38" href="#__codelineno-192-38"></a>      No standard like XA for 2PC                    
<a id="__codelineno-192-39" name="__codelineno-192-39" href="#__codelineno-192-39"></a>                
<a id="__codelineno-192-40" name="__codelineno-192-40" href="#__codelineno-192-40"></a>                                                         
<a id="__codelineno-192-41" name="__codelineno-192-41" href="#__codelineno-192-41"></a> 5.  INCREASED FAILURE PROBABILITY                     
<a id="__codelineno-192-42" name="__codelineno-192-42" href="#__codelineno-192-42"></a>                
<a id="__codelineno-192-43" name="__codelineno-192-43" href="#__codelineno-192-43"></a>      More phases = more failure points              
<a id="__codelineno-192-44" name="__codelineno-192-44" href="#__codelineno-192-44"></a>      More network messages can fail                 
<a id="__codelineno-192-45" name="__codelineno-192-45" href="#__codelineno-192-45"></a>      Coordinator must survive 3 phases              
<a id="__codelineno-192-46" name="__codelineno-192-46" href="#__codelineno-192-46"></a>      Higher overall failure rate                    
<a id="__codelineno-192-47" name="__codelineno-192-47" href="#__codelineno-192-47"></a>                
<a id="__codelineno-192-48" name="__codelineno-192-48" href="#__codelineno-192-48"></a>                                                         
<a id="__codelineno-192-49" name="__codelineno-192-49" href="#__codelineno-192-49"></a> 6.  MORE LOGGING OVERHEAD                             
<a id="__codelineno-192-50" name="__codelineno-192-50" href="#__codelineno-192-50"></a>                
<a id="__codelineno-192-51" name="__codelineno-192-51" href="#__codelineno-192-51"></a>      Extra phase = extra log writes                 
<a id="__codelineno-192-52" name="__codelineno-192-52" href="#__codelineno-192-52"></a>      PRE-COMMIT must be logged                      
<a id="__codelineno-192-53" name="__codelineno-192-53" href="#__codelineno-192-53"></a>      More disk I/O                                  
<a id="__codelineno-192-54" name="__codelineno-192-54" href="#__codelineno-192-54"></a>      Increased storage requirements                 
<a id="__codelineno-192-55" name="__codelineno-192-55" href="#__codelineno-192-55"></a>                
<a id="__codelineno-192-56" name="__codelineno-192-56" href="#__codelineno-192-56"></a>                                                         
<a id="__codelineno-192-57" name="__codelineno-192-57" href="#__codelineno-192-57"></a> 7.  STILL SYNCHRONOUS                                 
<a id="__codelineno-192-58" name="__codelineno-192-58" href="#__codelineno-192-58"></a>                
<a id="__codelineno-192-59" name="__codelineno-192-59" href="#__codelineno-192-59"></a>      Blocking during normal operation               
<a id="__codelineno-192-60" name="__codelineno-192-60" href="#__codelineno-192-60"></a>      Locks held for 3 phases                        
<a id="__codelineno-192-61" name="__codelineno-192-61" href="#__codelineno-192-61"></a>      Cannot scale to large systems                  
<a id="__codelineno-192-62" name="__codelineno-192-62" href="#__codelineno-192-62"></a>      Poor for high throughput                       
<a id="__codelineno-192-63" name="__codelineno-192-63" href="#__codelineno-192-63"></a>                
<a id="__codelineno-192-64" name="__codelineno-192-64" href="#__codelineno-192-64"></a>                                                         
<a id="__codelineno-192-65" name="__codelineno-192-65" href="#__codelineno-192-65"></a>
</code></pre></div>
<hr />
<h4 id="610-problems-in-three-phase-commit">6.10 Problems in Three-Phase Commit</h4>
<p><strong>Problem 1: Network Partition (Split-Brain)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-193-1" name="__codelineno-193-1" href="#__codelineno-193-1"></a>
<a id="__codelineno-193-2" name="__codelineno-193-2" href="#__codelineno-193-2"></a>       PROBLEM 1: NETWORK PARTITION (CRITICAL!)          
<a id="__codelineno-193-3" name="__codelineno-193-3" href="#__codelineno-193-3"></a>
<a id="__codelineno-193-4" name="__codelineno-193-4" href="#__codelineno-193-4"></a>                                                         
<a id="__codelineno-193-5" name="__codelineno-193-5" href="#__codelineno-193-5"></a> Scenario: Network partition during Phase 2             
<a id="__codelineno-193-6" name="__codelineno-193-6" href="#__codelineno-193-6"></a>                                                         
<a id="__codelineno-193-7" name="__codelineno-193-7" href="#__codelineno-193-7"></a> Timeline:                                               
<a id="__codelineno-193-8" name="__codelineno-193-8" href="#__codelineno-193-8"></a>                                                 
<a id="__codelineno-193-9" name="__codelineno-193-9" href="#__codelineno-193-9"></a> t1    Coordinator sends PRE-COMMIT                      
<a id="__codelineno-193-10" name="__codelineno-193-10" href="#__codelineno-193-10"></a> t2    Partition A receives PRE-COMMIT                   
<a id="__codelineno-193-11" name="__codelineno-193-11" href="#__codelineno-193-11"></a> t3     NETWORK PARTITION                            
<a id="__codelineno-193-12" name="__codelineno-193-12" href="#__codelineno-193-12"></a>       (Splits coordinator + A from B + C)               
<a id="__codelineno-193-13" name="__codelineno-193-13" href="#__codelineno-193-13"></a>                                                         
<a id="__codelineno-193-14" name="__codelineno-193-14" href="#__codelineno-193-14"></a> Network topology:                                       
<a id="__codelineno-193-15" name="__codelineno-193-15" href="#__codelineno-193-15"></a>            
<a id="__codelineno-193-16" name="__codelineno-193-16" href="#__codelineno-193-16"></a>   Partition 1           Partition 2             
<a id="__codelineno-193-17" name="__codelineno-193-17" href="#__codelineno-193-17"></a>                                                      
<a id="__codelineno-193-18" name="__codelineno-193-18" href="#__codelineno-193-18"></a>   Coordinator           Participant C           
<a id="__codelineno-193-19" name="__codelineno-193-19" href="#__codelineno-193-19"></a>   Participant A         Participant D           
<a id="__codelineno-193-20" name="__codelineno-193-20" href="#__codelineno-193-20"></a>   Participant B                                 
<a id="__codelineno-193-21" name="__codelineno-193-21" href="#__codelineno-193-21"></a>                                                      
<a id="__codelineno-193-22" name="__codelineno-193-22" href="#__codelineno-193-22"></a>   Received              Did NOT                 
<a id="__codelineno-193-23" name="__codelineno-193-23" href="#__codelineno-193-23"></a>   PRE-COMMIT            receive                 
<a id="__codelineno-193-24" name="__codelineno-193-24" href="#__codelineno-193-24"></a>                                                      
<a id="__codelineno-193-25" name="__codelineno-193-25" href="#__codelineno-193-25"></a>            
<a id="__codelineno-193-26" name="__codelineno-193-26" href="#__codelineno-193-26"></a>                                                         
<a id="__codelineno-193-27" name="__codelineno-193-27" href="#__codelineno-193-27"></a> Partition 1 (Coordinator + A + B):                      
<a id="__codelineno-193-28" name="__codelineno-193-28" href="#__codelineno-193-28"></a>            
<a id="__codelineno-193-29" name="__codelineno-193-29" href="#__codelineno-193-29"></a>   Received PRE-COMMIT                               
<a id="__codelineno-193-30" name="__codelineno-193-30" href="#__codelineno-193-30"></a>   State: PRE-COMMITTED                              
<a id="__codelineno-193-31" name="__codelineno-193-31" href="#__codelineno-193-31"></a>   Timeout waiting for C, D                          
<a id="__codelineno-193-32" name="__codelineno-193-32" href="#__codelineno-193-32"></a>   Termination protocol runs                         
<a id="__codelineno-193-33" name="__codelineno-193-33" href="#__codelineno-193-33"></a>   Decision: All in PRE-COMMIT  COMMIT              
<a id="__codelineno-193-34" name="__codelineno-193-34" href="#__codelineno-193-34"></a>    COMMITS transaction                            
<a id="__codelineno-193-35" name="__codelineno-193-35" href="#__codelineno-193-35"></a>            
<a id="__codelineno-193-36" name="__codelineno-193-36" href="#__codelineno-193-36"></a>                                                         
<a id="__codelineno-193-37" name="__codelineno-193-37" href="#__codelineno-193-37"></a> Partition 2 (C + D):                                    
<a id="__codelineno-193-38" name="__codelineno-193-38" href="#__codelineno-193-38"></a>            
<a id="__codelineno-193-39" name="__codelineno-193-39" href="#__codelineno-193-39"></a>   Did NOT receive PRE-COMMIT                        
<a id="__codelineno-193-40" name="__codelineno-193-40" href="#__codelineno-193-40"></a>   State: WAIT (after voting YES)                    
<a id="__codelineno-193-41" name="__codelineno-193-41" href="#__codelineno-193-41"></a>   Timeout waiting for coordinator                   
<a id="__codelineno-193-42" name="__codelineno-193-42" href="#__codelineno-193-42"></a>   Termination protocol runs                         
<a id="__codelineno-193-43" name="__codelineno-193-43" href="#__codelineno-193-43"></a>   Decision: All in WAIT  ABORT                     
<a id="__codelineno-193-44" name="__codelineno-193-44" href="#__codelineno-193-44"></a>    ABORTS transaction                             
<a id="__codelineno-193-45" name="__codelineno-193-45" href="#__codelineno-193-45"></a>            
<a id="__codelineno-193-46" name="__codelineno-193-46" href="#__codelineno-193-46"></a>                                                         
<a id="__codelineno-193-47" name="__codelineno-193-47" href="#__codelineno-193-47"></a> Result: INCONSISTENCY!                                
<a id="__codelineno-193-48" name="__codelineno-193-48" href="#__codelineno-193-48"></a>            
<a id="__codelineno-193-49" name="__codelineno-193-49" href="#__codelineno-193-49"></a>  Partition 1: COMMITTED                              
<a id="__codelineno-193-50" name="__codelineno-193-50" href="#__codelineno-193-50"></a>  Partition 2: ABORTED                                
<a id="__codelineno-193-51" name="__codelineno-193-51" href="#__codelineno-193-51"></a>                                                      
<a id="__codelineno-193-52" name="__codelineno-193-52" href="#__codelineno-193-52"></a>   Split-brain scenario!                             
<a id="__codelineno-193-53" name="__codelineno-193-53" href="#__codelineno-193-53"></a>   Data inconsistency across nodes!                  
<a id="__codelineno-193-54" name="__codelineno-193-54" href="#__codelineno-193-54"></a>   Atomicity violated!                             
<a id="__codelineno-193-55" name="__codelineno-193-55" href="#__codelineno-193-55"></a>            
<a id="__codelineno-193-56" name="__codelineno-193-56" href="#__codelineno-193-56"></a>                                                         
<a id="__codelineno-193-57" name="__codelineno-193-57" href="#__codelineno-193-57"></a> Why this happens:                                       
<a id="__codelineno-193-58" name="__codelineno-193-58" href="#__codelineno-193-58"></a>  3PC assumes synchronous network                       
<a id="__codelineno-193-59" name="__codelineno-193-59" href="#__codelineno-193-59"></a>  Assumes failures detectable (FLP impossibility)       
<a id="__codelineno-193-60" name="__codelineno-193-60" href="#__codelineno-193-60"></a>  Cannot distinguish slow vs dead vs partitioned        
<a id="__codelineno-193-61" name="__codelineno-193-61" href="#__codelineno-193-61"></a>  Timeout-based recovery makes guesses                  
<a id="__codelineno-193-62" name="__codelineno-193-62" href="#__codelineno-193-62"></a>                                                         
<a id="__codelineno-193-63" name="__codelineno-193-63" href="#__codelineno-193-63"></a> This is why 3PC is rarely used in practice!          
<a id="__codelineno-193-64" name="__codelineno-193-64" href="#__codelineno-193-64"></a>                                                         
<a id="__codelineno-193-65" name="__codelineno-193-65" href="#__codelineno-193-65"></a>
</code></pre></div>
<p><strong>Problem 2: Increased Message Complexity</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-194-1" name="__codelineno-194-1" href="#__codelineno-194-1"></a>
<a id="__codelineno-194-2" name="__codelineno-194-2" href="#__codelineno-194-2"></a>       PROBLEM 2: MESSAGE OVERHEAD                       
<a id="__codelineno-194-3" name="__codelineno-194-3" href="#__codelineno-194-3"></a>
<a id="__codelineno-194-4" name="__codelineno-194-4" href="#__codelineno-194-4"></a>                                                         
<a id="__codelineno-194-5" name="__codelineno-194-5" href="#__codelineno-194-5"></a> Message Count Comparison:                               
<a id="__codelineno-194-6" name="__codelineno-194-6" href="#__codelineno-194-6"></a>                                                         
<a id="__codelineno-194-7" name="__codelineno-194-7" href="#__codelineno-194-7"></a> For N participants:                                     
<a id="__codelineno-194-8" name="__codelineno-194-8" href="#__codelineno-194-8"></a>            
<a id="__codelineno-194-9" name="__codelineno-194-9" href="#__codelineno-194-9"></a>  2PC:                                                
<a id="__codelineno-194-10" name="__codelineno-194-10" href="#__codelineno-194-10"></a>   Round 1: PREPARE (N messages)                     
<a id="__codelineno-194-11" name="__codelineno-194-11" href="#__codelineno-194-11"></a>   Round 2: Votes (N responses)                      
<a id="__codelineno-194-12" name="__codelineno-194-12" href="#__codelineno-194-12"></a>   Round 3: COMMIT/ABORT (N messages)                
<a id="__codelineno-194-13" name="__codelineno-194-13" href="#__codelineno-194-13"></a>   Round 4: ACKs (N responses)                       
<a id="__codelineno-194-14" name="__codelineno-194-14" href="#__codelineno-194-14"></a>  Total: 4N messages                                  
<a id="__codelineno-194-15" name="__codelineno-194-15" href="#__codelineno-194-15"></a>            
<a id="__codelineno-194-16" name="__codelineno-194-16" href="#__codelineno-194-16"></a>                                                         
<a id="__codelineno-194-17" name="__codelineno-194-17" href="#__codelineno-194-17"></a>            
<a id="__codelineno-194-18" name="__codelineno-194-18" href="#__codelineno-194-18"></a>  3PC:                                                
<a id="__codelineno-194-19" name="__codelineno-194-19" href="#__codelineno-194-19"></a>   Round 1: CAN-COMMIT (N messages)                  
<a id="__codelineno-194-20" name="__codelineno-194-20" href="#__codelineno-194-20"></a>   Round 2: Votes (N responses)                      
<a id="__codelineno-194-21" name="__codelineno-194-21" href="#__codelineno-194-21"></a>   Round 3: PRE-COMMIT (N messages)                  
<a id="__codelineno-194-22" name="__codelineno-194-22" href="#__codelineno-194-22"></a>   Round 4: ACKs (N responses)                       
<a id="__codelineno-194-23" name="__codelineno-194-23" href="#__codelineno-194-23"></a>   Round 5: DO-COMMIT (N messages)                   
<a id="__codelineno-194-24" name="__codelineno-194-24" href="#__codelineno-194-24"></a>   Round 6: ACKs (N responses)                       
<a id="__codelineno-194-25" name="__codelineno-194-25" href="#__codelineno-194-25"></a>  Total: 6N messages (50% more!)                      
<a id="__codelineno-194-26" name="__codelineno-194-26" href="#__codelineno-194-26"></a>            
<a id="__codelineno-194-27" name="__codelineno-194-27" href="#__codelineno-194-27"></a>                                                         
<a id="__codelineno-194-28" name="__codelineno-194-28" href="#__codelineno-194-28"></a> Example (10 participants):                              
<a id="__codelineno-194-29" name="__codelineno-194-29" href="#__codelineno-194-29"></a>  2PC: 40 messages                                      
<a id="__codelineno-194-30" name="__codelineno-194-30" href="#__codelineno-194-30"></a>  3PC: 60 messages                                      
<a id="__codelineno-194-31" name="__codelineno-194-31" href="#__codelineno-194-31"></a>  Difference: 20 extra messages (50% overhead)          
<a id="__codelineno-194-32" name="__codelineno-194-32" href="#__codelineno-194-32"></a>                                                         
<a id="__codelineno-194-33" name="__codelineno-194-33" href="#__codelineno-194-33"></a> Latency Impact (assuming 5ms RTT):                      
<a id="__codelineno-194-34" name="__codelineno-194-34" href="#__codelineno-194-34"></a>  2PC: 4 rounds  5ms = 20ms network time               
<a id="__codelineno-194-35" name="__codelineno-194-35" href="#__codelineno-194-35"></a>  3PC: 6 rounds  5ms = 30ms network time               
<a id="__codelineno-194-36" name="__codelineno-194-36" href="#__codelineno-194-36"></a>  Overhead: +50%                                        
<a id="__codelineno-194-37" name="__codelineno-194-37" href="#__codelineno-194-37"></a>                                                         
<a id="__codelineno-194-38" name="__codelineno-194-38" href="#__codelineno-194-38"></a>
</code></pre></div>
<p><strong>Problem 3: Complexity and Bug-Prone Implementation</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-195-1" name="__codelineno-195-1" href="#__codelineno-195-1"></a>
<a id="__codelineno-195-2" name="__codelineno-195-2" href="#__codelineno-195-2"></a>       PROBLEM 3: IMPLEMENTATION COMPLEXITY              
<a id="__codelineno-195-3" name="__codelineno-195-3" href="#__codelineno-195-3"></a>
<a id="__codelineno-195-4" name="__codelineno-195-4" href="#__codelineno-195-4"></a>                                                         
<a id="__codelineno-195-5" name="__codelineno-195-5" href="#__codelineno-195-5"></a> State Space Explosion:                                  
<a id="__codelineno-195-6" name="__codelineno-195-6" href="#__codelineno-195-6"></a>            
<a id="__codelineno-195-7" name="__codelineno-195-7" href="#__codelineno-195-7"></a>  Coordinator states:                                 
<a id="__codelineno-195-8" name="__codelineno-195-8" href="#__codelineno-195-8"></a>   INIT                                              
<a id="__codelineno-195-9" name="__codelineno-195-9" href="#__codelineno-195-9"></a>   WAIT (for votes)                                  
<a id="__codelineno-195-10" name="__codelineno-195-10" href="#__codelineno-195-10"></a>   PRE-COMMIT                                        
<a id="__codelineno-195-11" name="__codelineno-195-11" href="#__codelineno-195-11"></a>   WAIT (for pre-commit ACKs)                        
<a id="__codelineno-195-12" name="__codelineno-195-12" href="#__codelineno-195-12"></a>   DO-COMMIT                                         
<a id="__codelineno-195-13" name="__codelineno-195-13" href="#__codelineno-195-13"></a>   WAIT (for commit ACKs)                            
<a id="__codelineno-195-14" name="__codelineno-195-14" href="#__codelineno-195-14"></a>   ABORT                                             
<a id="__codelineno-195-15" name="__codelineno-195-15" href="#__codelineno-195-15"></a>   END                                               
<a id="__codelineno-195-16" name="__codelineno-195-16" href="#__codelineno-195-16"></a>  Total: 8 states (vs 5 in 2PC)                       
<a id="__codelineno-195-17" name="__codelineno-195-17" href="#__codelineno-195-17"></a>            
<a id="__codelineno-195-18" name="__codelineno-195-18" href="#__codelineno-195-18"></a>                                                         
<a id="__codelineno-195-19" name="__codelineno-195-19" href="#__codelineno-195-19"></a> Edge Cases to Handle:                                   
<a id="__codelineno-195-20" name="__codelineno-195-20" href="#__codelineno-195-20"></a>            
<a id="__codelineno-195-21" name="__codelineno-195-21" href="#__codelineno-195-21"></a>   Timeout in each phase                             
<a id="__codelineno-195-22" name="__codelineno-195-22" href="#__codelineno-195-22"></a>   Partial message delivery                           
<a id="__codelineno-195-23" name="__codelineno-195-23" href="#__codelineno-195-23"></a>   Coordinator failure in each state                  
<a id="__codelineno-195-24" name="__codelineno-195-24" href="#__codelineno-195-24"></a>   Participant failure in each state                  
<a id="__codelineno-195-25" name="__codelineno-195-25" href="#__codelineno-195-25"></a>   Message reordering                                 
<a id="__codelineno-195-26" name="__codelineno-195-26" href="#__codelineno-195-26"></a>   Network partition in each phase                    
<a id="__codelineno-195-27" name="__codelineno-195-27" href="#__codelineno-195-27"></a>   Multiple simultaneous failures                     
<a id="__codelineno-195-28" name="__codelineno-195-28" href="#__codelineno-195-28"></a>   Recovery and state reconstruction                  
<a id="__codelineno-195-29" name="__codelineno-195-29" href="#__codelineno-195-29"></a>   Termination protocol                               
<a id="__codelineno-195-30" name="__codelineno-195-30" href="#__codelineno-195-30"></a>   Election of new coordinator                        
<a id="__codelineno-195-31" name="__codelineno-195-31" href="#__codelineno-195-31"></a>            
<a id="__codelineno-195-32" name="__codelineno-195-32" href="#__codelineno-195-32"></a>                                                         
<a id="__codelineno-195-33" name="__codelineno-195-33" href="#__codelineno-195-33"></a> Result:                                                 
<a id="__codelineno-195-34" name="__codelineno-195-34" href="#__codelineno-195-34"></a>  Hard to implement correctly                           
<a id="__codelineno-195-35" name="__codelineno-195-35" href="#__codelineno-195-35"></a>  Subtle bugs in corner cases                           
<a id="__codelineno-195-36" name="__codelineno-195-36" href="#__codelineno-195-36"></a>  Difficult to test all scenarios                       
<a id="__codelineno-195-37" name="__codelineno-195-37" href="#__codelineno-195-37"></a>  Maintenance burden                                    
<a id="__codelineno-195-38" name="__codelineno-195-38" href="#__codelineno-195-38"></a>                                                         
<a id="__codelineno-195-39" name="__codelineno-195-39" href="#__codelineno-195-39"></a>
</code></pre></div>
<p><strong>Problem 4: Performance Under Normal Operation</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-196-1" name="__codelineno-196-1" href="#__codelineno-196-1"></a>
<a id="__codelineno-196-2" name="__codelineno-196-2" href="#__codelineno-196-2"></a>       PROBLEM 4: PERFORMANCE DEGRADATION                
<a id="__codelineno-196-3" name="__codelineno-196-3" href="#__codelineno-196-3"></a>
<a id="__codelineno-196-4" name="__codelineno-196-4" href="#__codelineno-196-4"></a>                                                         
<a id="__codelineno-196-5" name="__codelineno-196-5" href="#__codelineno-196-5"></a> Throughput Comparison (100 transactions/sec):           
<a id="__codelineno-196-6" name="__codelineno-196-6" href="#__codelineno-196-6"></a>                                                         
<a id="__codelineno-196-7" name="__codelineno-196-7" href="#__codelineno-196-7"></a> Local Transaction:                                      
<a id="__codelineno-196-8" name="__codelineno-196-8" href="#__codelineno-196-8"></a>  Latency: 2ms                                          
<a id="__codelineno-196-9" name="__codelineno-196-9" href="#__codelineno-196-9"></a>  Throughput: 500 TPS (max)                             
<a id="__codelineno-196-10" name="__codelineno-196-10" href="#__codelineno-196-10"></a>                                                         
<a id="__codelineno-196-11" name="__codelineno-196-11" href="#__codelineno-196-11"></a> 2PC:                                                    
<a id="__codelineno-196-12" name="__codelineno-196-12" href="#__codelineno-196-12"></a>  Latency: 35ms (network + logging)                     
<a id="__codelineno-196-13" name="__codelineno-196-13" href="#__codelineno-196-13"></a>  Throughput: ~28 TPS (93% reduction)                   
<a id="__codelineno-196-14" name="__codelineno-196-14" href="#__codelineno-196-14"></a>                                                         
<a id="__codelineno-196-15" name="__codelineno-196-15" href="#__codelineno-196-15"></a> 3PC:                                                    
<a id="__codelineno-196-16" name="__codelineno-196-16" href="#__codelineno-196-16"></a>  Latency: 50ms (more phases)                           
<a id="__codelineno-196-17" name="__codelineno-196-17" href="#__codelineno-196-17"></a>  Throughput: ~20 TPS (96% reduction)                   
<a id="__codelineno-196-18" name="__codelineno-196-18" href="#__codelineno-196-18"></a>                                                         
<a id="__codelineno-196-19" name="__codelineno-196-19" href="#__codelineno-196-19"></a> Lock Holding Time:                                      
<a id="__codelineno-196-20" name="__codelineno-196-20" href="#__codelineno-196-20"></a>            
<a id="__codelineno-196-21" name="__codelineno-196-21" href="#__codelineno-196-21"></a>  2PC: Locks held for 2 phases (~35ms)                
<a id="__codelineno-196-22" name="__codelineno-196-22" href="#__codelineno-196-22"></a>  3PC: Locks held for 3 phases (~50ms)                
<a id="__codelineno-196-23" name="__codelineno-196-23" href="#__codelineno-196-23"></a>                                                      
<a id="__codelineno-196-24" name="__codelineno-196-24" href="#__codelineno-196-24"></a>   43% longer lock duration                          
<a id="__codelineno-196-25" name="__codelineno-196-25" href="#__codelineno-196-25"></a>   Reduced concurrency                               
<a id="__codelineno-196-26" name="__codelineno-196-26" href="#__codelineno-196-26"></a>   More lock contention                              
<a id="__codelineno-196-27" name="__codelineno-196-27" href="#__codelineno-196-27"></a>   Lower overall throughput                          
<a id="__codelineno-196-28" name="__codelineno-196-28" href="#__codelineno-196-28"></a>            
<a id="__codelineno-196-29" name="__codelineno-196-29" href="#__codelineno-196-29"></a>                                                         
<a id="__codelineno-196-30" name="__codelineno-196-30" href="#__codelineno-196-30"></a> Scalability:                                            
<a id="__codelineno-196-31" name="__codelineno-196-31" href="#__codelineno-196-31"></a>            
<a id="__codelineno-196-32" name="__codelineno-196-32" href="#__codelineno-196-32"></a>  As N (participants) increases:                      
<a id="__codelineno-196-33" name="__codelineno-196-33" href="#__codelineno-196-33"></a>   Latency increases linearly                        
<a id="__codelineno-196-34" name="__codelineno-196-34" href="#__codelineno-196-34"></a>   Failure probability increases                     
<a id="__codelineno-196-35" name="__codelineno-196-35" href="#__codelineno-196-35"></a>   Coordinator bottleneck worsens                    
<a id="__codelineno-196-36" name="__codelineno-196-36" href="#__codelineno-196-36"></a>   3PC worse than 2PC at every N                     
<a id="__codelineno-196-37" name="__codelineno-196-37" href="#__codelineno-196-37"></a>            
<a id="__codelineno-196-38" name="__codelineno-196-38" href="#__codelineno-196-38"></a>                                                         
<a id="__codelineno-196-39" name="__codelineno-196-39" href="#__codelineno-196-39"></a>
</code></pre></div>
<p><strong>Problem 5: False Assumptions (FLP Impossibility)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-197-1" name="__codelineno-197-1" href="#__codelineno-197-1"></a>
<a id="__codelineno-197-2" name="__codelineno-197-2" href="#__codelineno-197-2"></a>       PROBLEM 5: FLP IMPOSSIBILITY                      
<a id="__codelineno-197-3" name="__codelineno-197-3" href="#__codelineno-197-3"></a>
<a id="__codelineno-197-4" name="__codelineno-197-4" href="#__codelineno-197-4"></a>                                                         
<a id="__codelineno-197-5" name="__codelineno-197-5" href="#__codelineno-197-5"></a> FLP Theorem (Fischer, Lynch, Paterson, 1985):           
<a id="__codelineno-197-6" name="__codelineno-197-6" href="#__codelineno-197-6"></a>            
<a id="__codelineno-197-7" name="__codelineno-197-7" href="#__codelineno-197-7"></a>  &quot;It is impossible to achieve consensus              
<a id="__codelineno-197-8" name="__codelineno-197-8" href="#__codelineno-197-8"></a>   in an asynchronous distributed system              
<a id="__codelineno-197-9" name="__codelineno-197-9" href="#__codelineno-197-9"></a>   with even a single faulty process.&quot;                
<a id="__codelineno-197-10" name="__codelineno-197-10" href="#__codelineno-197-10"></a>            
<a id="__codelineno-197-11" name="__codelineno-197-11" href="#__codelineno-197-11"></a>                                                         
<a id="__codelineno-197-12" name="__codelineno-197-12" href="#__codelineno-197-12"></a> What this means for 3PC:                                
<a id="__codelineno-197-13" name="__codelineno-197-13" href="#__codelineno-197-13"></a>                                                         
<a id="__codelineno-197-14" name="__codelineno-197-14" href="#__codelineno-197-14"></a> 3PC assumes:                                            
<a id="__codelineno-197-15" name="__codelineno-197-15" href="#__codelineno-197-15"></a>            
<a id="__codelineno-197-16" name="__codelineno-197-16" href="#__codelineno-197-16"></a>   Synchronous network (bounded delays)              
<a id="__codelineno-197-17" name="__codelineno-197-17" href="#__codelineno-197-17"></a>   Perfect failure detection                          
<a id="__codelineno-197-18" name="__codelineno-197-18" href="#__codelineno-197-18"></a>   Can distinguish crashed vs slow                    
<a id="__codelineno-197-19" name="__codelineno-197-19" href="#__codelineno-197-19"></a>            
<a id="__codelineno-197-20" name="__codelineno-197-20" href="#__codelineno-197-20"></a>                                                         
<a id="__codelineno-197-21" name="__codelineno-197-21" href="#__codelineno-197-21"></a> Reality:                                                
<a id="__codelineno-197-22" name="__codelineno-197-22" href="#__codelineno-197-22"></a>            
<a id="__codelineno-197-23" name="__codelineno-197-23" href="#__codelineno-197-23"></a>   Asynchronous network (unbounded delays)           
<a id="__codelineno-197-24" name="__codelineno-197-24" href="#__codelineno-197-24"></a>   Imperfect failure detection                        
<a id="__codelineno-197-25" name="__codelineno-197-25" href="#__codelineno-197-25"></a>   Cannot distinguish crashed vs slow                 
<a id="__codelineno-197-26" name="__codelineno-197-26" href="#__codelineno-197-26"></a>            
<a id="__codelineno-197-27" name="__codelineno-197-27" href="#__codelineno-197-27"></a>                                                         
<a id="__codelineno-197-28" name="__codelineno-197-28" href="#__codelineno-197-28"></a> Consequence:                                            
<a id="__codelineno-197-29" name="__codelineno-197-29" href="#__codelineno-197-29"></a>  3PC cannot guarantee both safety and liveness         
<a id="__codelineno-197-30" name="__codelineno-197-30" href="#__codelineno-197-30"></a>   in all scenarios                                      
<a id="__codelineno-197-31" name="__codelineno-197-31" href="#__codelineno-197-31"></a>  Network partition can violate atomicity               
<a id="__codelineno-197-32" name="__codelineno-197-32" href="#__codelineno-197-32"></a>  Timeout-based approach fundamentally flawed           
<a id="__codelineno-197-33" name="__codelineno-197-33" href="#__codelineno-197-33"></a>                                                         
<a id="__codelineno-197-34" name="__codelineno-197-34" href="#__codelineno-197-34"></a> This is why modern systems use:                         
<a id="__codelineno-197-35" name="__codelineno-197-35" href="#__codelineno-197-35"></a>  Paxos/Raft (consensus with majority quorum)           
<a id="__codelineno-197-36" name="__codelineno-197-36" href="#__codelineno-197-36"></a>  Eventual consistency (sacrifice strong consistency)   
<a id="__codelineno-197-37" name="__codelineno-197-37" href="#__codelineno-197-37"></a>  Application-level compensation (Sagas)                
<a id="__codelineno-197-38" name="__codelineno-197-38" href="#__codelineno-197-38"></a>                                                         
<a id="__codelineno-197-39" name="__codelineno-197-39" href="#__codelineno-197-39"></a>
</code></pre></div>
<p><strong>Summary: Why 3PC Is Rarely Used</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-198-1" name="__codelineno-198-1" href="#__codelineno-198-1"></a>
<a id="__codelineno-198-2" name="__codelineno-198-2" href="#__codelineno-198-2"></a>         WHY 3PC FAILED IN PRACTICE                      
<a id="__codelineno-198-3" name="__codelineno-198-3" href="#__codelineno-198-3"></a>
<a id="__codelineno-198-4" name="__codelineno-198-4" href="#__codelineno-198-4"></a>                                                         
<a id="__codelineno-198-5" name="__codelineno-198-5" href="#__codelineno-198-5"></a> Theoretical Advantages:                                 
<a id="__codelineno-198-6" name="__codelineno-198-6" href="#__codelineno-198-6"></a>  Non-blocking under single coordinator failure        
<a id="__codelineno-198-7" name="__codelineno-198-7" href="#__codelineno-198-7"></a>  Improved availability vs 2PC                         
<a id="__codelineno-198-8" name="__codelineno-198-8" href="#__codelineno-198-8"></a>                                                         
<a id="__codelineno-198-9" name="__codelineno-198-9" href="#__codelineno-198-9"></a> Practical Problems:                                     
<a id="__codelineno-198-10" name="__codelineno-198-10" href="#__codelineno-198-10"></a>  Vulnerable to network partitions (split-brain)       
<a id="__codelineno-198-11" name="__codelineno-198-11" href="#__codelineno-198-11"></a>  50% more messages than 2PC                           
<a id="__codelineno-198-12" name="__codelineno-198-12" href="#__codelineno-198-12"></a>  43% higher latency                                   
<a id="__codelineno-198-13" name="__codelineno-198-13" href="#__codelineno-198-13"></a>  More complex implementation                          
<a id="__codelineno-198-14" name="__codelineno-198-14" href="#__codelineno-198-14"></a>  Violates FLP impossibility assumptions               
<a id="__codelineno-198-15" name="__codelineno-198-15" href="#__codelineno-198-15"></a>  No vendor support or standards                       
<a id="__codelineno-198-16" name="__codelineno-198-16" href="#__codelineno-198-16"></a>                                                         
<a id="__codelineno-198-17" name="__codelineno-198-17" href="#__codelineno-198-17"></a> Industry Decision:                                      
<a id="__codelineno-198-18" name="__codelineno-198-18" href="#__codelineno-198-18"></a>            
<a id="__codelineno-198-19" name="__codelineno-198-19" href="#__codelineno-198-19"></a>  &quot;3PC solves the blocking problem of 2PC             
<a id="__codelineno-198-20" name="__codelineno-198-20" href="#__codelineno-198-20"></a>   but creates worse problems with network            
<a id="__codelineno-198-21" name="__codelineno-198-21" href="#__codelineno-198-21"></a>   partitions. Better to accept 2PC&#39;s                 
<a id="__codelineno-198-22" name="__codelineno-198-22" href="#__codelineno-198-22"></a>   blocking or use modern consensus                   
<a id="__codelineno-198-23" name="__codelineno-198-23" href="#__codelineno-198-23"></a>   protocols (Paxos/Raft).&quot;                           
<a id="__codelineno-198-24" name="__codelineno-198-24" href="#__codelineno-198-24"></a>            
<a id="__codelineno-198-25" name="__codelineno-198-25" href="#__codelineno-198-25"></a>                                                         
<a id="__codelineno-198-26" name="__codelineno-198-26" href="#__codelineno-198-26"></a> Modern Alternatives (used instead of 3PC):              
<a id="__codelineno-198-27" name="__codelineno-198-27" href="#__codelineno-198-27"></a>  Paxos/Multi-Paxos: Majority quorum consensus          
<a id="__codelineno-198-28" name="__codelineno-198-28" href="#__codelineno-198-28"></a>  Raft: Understandable consensus protocol               
<a id="__codelineno-198-29" name="__codelineno-198-29" href="#__codelineno-198-29"></a>  Saga Pattern: Compensating transactions               
<a id="__codelineno-198-30" name="__codelineno-198-30" href="#__codelineno-198-30"></a>  Event Sourcing: Eventual consistency                  
<a id="__codelineno-198-31" name="__codelineno-198-31" href="#__codelineno-198-31"></a>  CRDTs: Conflict-free replicated data types            
<a id="__codelineno-198-32" name="__codelineno-198-32" href="#__codelineno-198-32"></a>                                                         
<a id="__codelineno-198-33" name="__codelineno-198-33" href="#__codelineno-198-33"></a> Bottom Line:                                            
<a id="__codelineno-198-34" name="__codelineno-198-34" href="#__codelineno-198-34"></a> 3PC is academically interesting but practically         
<a id="__codelineno-198-35" name="__codelineno-198-35" href="#__codelineno-198-35"></a> superseded by better approaches.                        
<a id="__codelineno-198-36" name="__codelineno-198-36" href="#__codelineno-198-36"></a>                                                         
<a id="__codelineno-198-37" name="__codelineno-198-37" href="#__codelineno-198-37"></a>
</code></pre></div>
<hr />
<h3 id="7-saga-pattern">7. Saga Pattern</h3>
<p><strong>Description:</strong></p>
<p>The <strong>Saga pattern</strong> is a design pattern for managing distributed transactions by breaking them into a sequence of <strong>local transactions</strong>, where each local transaction updates data in a single service and publishes an event or message to trigger the next step. Unlike 2PC and 3PC which provide <strong>atomic commits</strong>, Sagas provide <strong>eventual consistency</strong> through <strong>compensating transactions</strong>.</p>
<p><strong>The Fundamental Shift:</strong></p>
<p>Sagas represent a paradigm shift from traditional ACID transactions:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-199-1" name="__codelineno-199-1" href="#__codelineno-199-1"></a>
<a id="__codelineno-199-2" name="__codelineno-199-2" href="#__codelineno-199-2"></a>         PARADIGM SHIFT: ACID  SAGA                     
<a id="__codelineno-199-3" name="__codelineno-199-3" href="#__codelineno-199-3"></a>
<a id="__codelineno-199-4" name="__codelineno-199-4" href="#__codelineno-199-4"></a>                                                         
<a id="__codelineno-199-5" name="__codelineno-199-5" href="#__codelineno-199-5"></a> Traditional ACID (2PC/3PC):                             
<a id="__codelineno-199-6" name="__codelineno-199-6" href="#__codelineno-199-6"></a>            
<a id="__codelineno-199-7" name="__codelineno-199-7" href="#__codelineno-199-7"></a>   All-or-nothing atomic commit                      
<a id="__codelineno-199-8" name="__codelineno-199-8" href="#__codelineno-199-8"></a>   Strong consistency guaranteed                     
<a id="__codelineno-199-9" name="__codelineno-199-9" href="#__codelineno-199-9"></a>   Locks held across services                        
<a id="__codelineno-199-10" name="__codelineno-199-10" href="#__codelineno-199-10"></a>   Blocking coordination                             
<a id="__codelineno-199-11" name="__codelineno-199-11" href="#__codelineno-199-11"></a>   Poor scalability                                  
<a id="__codelineno-199-12" name="__codelineno-199-12" href="#__codelineno-199-12"></a>            
<a id="__codelineno-199-13" name="__codelineno-199-13" href="#__codelineno-199-13"></a>                                                         
<a id="__codelineno-199-14" name="__codelineno-199-14" href="#__codelineno-199-14"></a> Saga Pattern:                                           
<a id="__codelineno-199-15" name="__codelineno-199-15" href="#__codelineno-199-15"></a>            
<a id="__codelineno-199-16" name="__codelineno-199-16" href="#__codelineno-199-16"></a>   Sequence of local transactions                    
<a id="__codelineno-199-17" name="__codelineno-199-17" href="#__codelineno-199-17"></a>   Eventual consistency                              
<a id="__codelineno-199-18" name="__codelineno-199-18" href="#__codelineno-199-18"></a>   No distributed locks                              
<a id="__codelineno-199-19" name="__codelineno-199-19" href="#__codelineno-199-19"></a>   Asynchronous coordination                         
<a id="__codelineno-199-20" name="__codelineno-199-20" href="#__codelineno-199-20"></a>   High scalability                                  
<a id="__codelineno-199-21" name="__codelineno-199-21" href="#__codelineno-199-21"></a>   Compensating transactions on failure              
<a id="__codelineno-199-22" name="__codelineno-199-22" href="#__codelineno-199-22"></a>            
<a id="__codelineno-199-23" name="__codelineno-199-23" href="#__codelineno-199-23"></a>                                                         
<a id="__codelineno-199-24" name="__codelineno-199-24" href="#__codelineno-199-24"></a>
</code></pre></div>
<p><strong>Historical Context:</strong></p>
<p>The Saga pattern was introduced by <strong>Hector Garcia-Molina and Kenneth Salem</strong> in their 1987 paper "Sagas" at Princeton University. They recognized that long-lived transactions (LLTs) in distributed systems cause:
- Excessive lock holding
- Reduced concurrency
- Increased failure probability
- Poor system availability</p>
<p>Their solution: Break long transactions into smaller, independent steps that can be <strong>compensated</strong> if something fails later.</p>
<p><strong>Modern Revival:</strong></p>
<p>While originally designed for database transactions, Sagas experienced a <strong>renaissance with microservices architecture</strong> (2010s):
- <strong>Chris Richardson</strong> popularized Sagas for microservices (2015+)
- Netflix, Uber, Amazon adopted for distributed workflows
- Essential pattern for event-driven architectures
- Core to Domain-Driven Design (DDD) bounded contexts</p>
<p><strong>What is a Saga?</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-200-1" name="__codelineno-200-1" href="#__codelineno-200-1"></a>
<a id="__codelineno-200-2" name="__codelineno-200-2" href="#__codelineno-200-2"></a>         SAGA COMPONENTS                                 
<a id="__codelineno-200-3" name="__codelineno-200-3" href="#__codelineno-200-3"></a>
<a id="__codelineno-200-4" name="__codelineno-200-4" href="#__codelineno-200-4"></a>                                                         
<a id="__codelineno-200-5" name="__codelineno-200-5" href="#__codelineno-200-5"></a> A Saga consists of:                                     
<a id="__codelineno-200-6" name="__codelineno-200-6" href="#__codelineno-200-6"></a>                                                         
<a id="__codelineno-200-7" name="__codelineno-200-7" href="#__codelineno-200-7"></a> 1. SEQUENCE OF TRANSACTIONS (T1, T2, ..., Tn)           
<a id="__codelineno-200-8" name="__codelineno-200-8" href="#__codelineno-200-8"></a>                
<a id="__codelineno-200-9" name="__codelineno-200-9" href="#__codelineno-200-9"></a>     Each Ti is a local transaction in                
<a id="__codelineno-200-10" name="__codelineno-200-10" href="#__codelineno-200-10"></a>     a single service/database                        
<a id="__codelineno-200-11" name="__codelineno-200-11" href="#__codelineno-200-11"></a>     Commits immediately (no 2PC)                     
<a id="__codelineno-200-12" name="__codelineno-200-12" href="#__codelineno-200-12"></a>                
<a id="__codelineno-200-13" name="__codelineno-200-13" href="#__codelineno-200-13"></a>                                                         
<a id="__codelineno-200-14" name="__codelineno-200-14" href="#__codelineno-200-14"></a> 2. COMPENSATING TRANSACTIONS (C1, C2, ..., Cn-1)        
<a id="__codelineno-200-15" name="__codelineno-200-15" href="#__codelineno-200-15"></a>                
<a id="__codelineno-200-16" name="__codelineno-200-16" href="#__codelineno-200-16"></a>     Each Ci &quot;undoes&quot; the effect of Ti                
<a id="__codelineno-200-17" name="__codelineno-200-17" href="#__codelineno-200-17"></a>     Semantically reverses the operation              
<a id="__codelineno-200-18" name="__codelineno-200-18" href="#__codelineno-200-18"></a>     Must be idempotent                               
<a id="__codelineno-200-19" name="__codelineno-200-19" href="#__codelineno-200-19"></a>                
<a id="__codelineno-200-20" name="__codelineno-200-20" href="#__codelineno-200-20"></a>                                                         
<a id="__codelineno-200-21" name="__codelineno-200-21" href="#__codelineno-200-21"></a> 3. SAGA EXECUTION COORDINATOR                           
<a id="__codelineno-200-22" name="__codelineno-200-22" href="#__codelineno-200-22"></a>                
<a id="__codelineno-200-23" name="__codelineno-200-23" href="#__codelineno-200-23"></a>     Orchestrates transaction sequence                
<a id="__codelineno-200-24" name="__codelineno-200-24" href="#__codelineno-200-24"></a>     Triggers compensations on failure                
<a id="__codelineno-200-25" name="__codelineno-200-25" href="#__codelineno-200-25"></a>     Maintains saga state                             
<a id="__codelineno-200-26" name="__codelineno-200-26" href="#__codelineno-200-26"></a>                
<a id="__codelineno-200-27" name="__codelineno-200-27" href="#__codelineno-200-27"></a>                                                         
<a id="__codelineno-200-28" name="__codelineno-200-28" href="#__codelineno-200-28"></a> Guarantee:                                              
<a id="__codelineno-200-29" name="__codelineno-200-29" href="#__codelineno-200-29"></a>            
<a id="__codelineno-200-30" name="__codelineno-200-30" href="#__codelineno-200-30"></a>  Either:                                             
<a id="__codelineno-200-31" name="__codelineno-200-31" href="#__codelineno-200-31"></a>   T1, T2, T3, ..., Tn (all succeed)               
<a id="__codelineno-200-32" name="__codelineno-200-32" href="#__codelineno-200-32"></a>  OR                                                  
<a id="__codelineno-200-33" name="__codelineno-200-33" href="#__codelineno-200-33"></a>   T1, T2, ..., Ti, Ci, Ci-1, ..., C1                
<a id="__codelineno-200-34" name="__codelineno-200-34" href="#__codelineno-200-34"></a>    (partial execution + compensation)              
<a id="__codelineno-200-35" name="__codelineno-200-35" href="#__codelineno-200-35"></a>            
<a id="__codelineno-200-36" name="__codelineno-200-36" href="#__codelineno-200-36"></a>                                                         
<a id="__codelineno-200-37" name="__codelineno-200-37" href="#__codelineno-200-37"></a>
</code></pre></div>
<hr />
<h4 id="71-types-of-saga-implementation">7.1 Types of Saga Implementation</h4>
<p><strong>1. Choreography-Based Saga (Event-Driven)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-201-1" name="__codelineno-201-1" href="#__codelineno-201-1"></a>
<a id="__codelineno-201-2" name="__codelineno-201-2" href="#__codelineno-201-2"></a>         CHOREOGRAPHY-BASED SAGA                         
<a id="__codelineno-201-3" name="__codelineno-201-3" href="#__codelineno-201-3"></a>
<a id="__codelineno-201-4" name="__codelineno-201-4" href="#__codelineno-201-4"></a>                                                         
<a id="__codelineno-201-5" name="__codelineno-201-5" href="#__codelineno-201-5"></a> No central coordinator - services react to events       
<a id="__codelineno-201-6" name="__codelineno-201-6" href="#__codelineno-201-6"></a>                                                         
<a id="__codelineno-201-7" name="__codelineno-201-7" href="#__codelineno-201-7"></a>     Service A        Service B        Service C         
<a id="__codelineno-201-8" name="__codelineno-201-8" href="#__codelineno-201-8"></a>                                                      
<a id="__codelineno-201-9" name="__codelineno-201-9" href="#__codelineno-201-9"></a>         1. Execute T1                                
<a id="__codelineno-201-10" name="__codelineno-201-10" href="#__codelineno-201-10"></a>                                              
<a id="__codelineno-201-11" name="__codelineno-201-11" href="#__codelineno-201-11"></a>                                                     
<a id="__codelineno-201-12" name="__codelineno-201-12" href="#__codelineno-201-12"></a>                                              
<a id="__codelineno-201-13" name="__codelineno-201-13" href="#__codelineno-201-13"></a>                                                      
<a id="__codelineno-201-14" name="__codelineno-201-14" href="#__codelineno-201-14"></a>         2. Publish                                   
<a id="__codelineno-201-15" name="__codelineno-201-15" href="#__codelineno-201-15"></a>            Event E1                                  
<a id="__codelineno-201-16" name="__codelineno-201-16" href="#__codelineno-201-16"></a>                      
<a id="__codelineno-201-17" name="__codelineno-201-17" href="#__codelineno-201-17"></a>                                                      
<a id="__codelineno-201-18" name="__codelineno-201-18" href="#__codelineno-201-18"></a>                         3. Listen E1                 
<a id="__codelineno-201-19" name="__codelineno-201-19" href="#__codelineno-201-19"></a>                            Execute T2                
<a id="__codelineno-201-20" name="__codelineno-201-20" href="#__codelineno-201-20"></a>                                              
<a id="__codelineno-201-21" name="__codelineno-201-21" href="#__codelineno-201-21"></a>                                                     
<a id="__codelineno-201-22" name="__codelineno-201-22" href="#__codelineno-201-22"></a>                                              
<a id="__codelineno-201-23" name="__codelineno-201-23" href="#__codelineno-201-23"></a>                                                      
<a id="__codelineno-201-24" name="__codelineno-201-24" href="#__codelineno-201-24"></a>                         4. Publish                   
<a id="__codelineno-201-25" name="__codelineno-201-25" href="#__codelineno-201-25"></a>                            Event E2                  
<a id="__codelineno-201-26" name="__codelineno-201-26" href="#__codelineno-201-26"></a>                            
<a id="__codelineno-201-27" name="__codelineno-201-27" href="#__codelineno-201-27"></a>                                                     
<a id="__codelineno-201-28" name="__codelineno-201-28" href="#__codelineno-201-28"></a>                                         5. Listen E2 
<a id="__codelineno-201-29" name="__codelineno-201-29" href="#__codelineno-201-29"></a>                                            Execute T3
<a id="__codelineno-201-30" name="__codelineno-201-30" href="#__codelineno-201-30"></a>                                            
<a id="__codelineno-201-31" name="__codelineno-201-31" href="#__codelineno-201-31"></a>                                                     
<a id="__codelineno-201-32" name="__codelineno-201-32" href="#__codelineno-201-32"></a>                                            
<a id="__codelineno-201-33" name="__codelineno-201-33" href="#__codelineno-201-33"></a>                                                      
<a id="__codelineno-201-34" name="__codelineno-201-34" href="#__codelineno-201-34"></a>                                         6. Publish   
<a id="__codelineno-201-35" name="__codelineno-201-35" href="#__codelineno-201-35"></a>                                            Success   
<a id="__codelineno-201-36" name="__codelineno-201-36" href="#__codelineno-201-36"></a>                      
<a id="__codelineno-201-37" name="__codelineno-201-37" href="#__codelineno-201-37"></a>                                                      
<a id="__codelineno-201-38" name="__codelineno-201-38" href="#__codelineno-201-38"></a>                                                      
<a id="__codelineno-201-39" name="__codelineno-201-39" href="#__codelineno-201-39"></a>       Done             Done             Done            
<a id="__codelineno-201-40" name="__codelineno-201-40" href="#__codelineno-201-40"></a>                                                         
<a id="__codelineno-201-41" name="__codelineno-201-41" href="#__codelineno-201-41"></a> Characteristics:                                        
<a id="__codelineno-201-42" name="__codelineno-201-42" href="#__codelineno-201-42"></a>  Decentralized control                                 
<a id="__codelineno-201-43" name="__codelineno-201-43" href="#__codelineno-201-43"></a>  Services listen to events and react                   
<a id="__codelineno-201-44" name="__codelineno-201-44" href="#__codelineno-201-44"></a>  No single point of failure                            
<a id="__codelineno-201-45" name="__codelineno-201-45" href="#__codelineno-201-45"></a>  Loose coupling                                        
<a id="__codelineno-201-46" name="__codelineno-201-46" href="#__codelineno-201-46"></a>  Complex to understand and debug                       
<a id="__codelineno-201-47" name="__codelineno-201-47" href="#__codelineno-201-47"></a>                                                         
<a id="__codelineno-201-48" name="__codelineno-201-48" href="#__codelineno-201-48"></a>
</code></pre></div>
<p><strong>2. Orchestration-Based Saga (Centralized)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-202-1" name="__codelineno-202-1" href="#__codelineno-202-1"></a>
<a id="__codelineno-202-2" name="__codelineno-202-2" href="#__codelineno-202-2"></a>         ORCHESTRATION-BASED SAGA                        
<a id="__codelineno-202-3" name="__codelineno-202-3" href="#__codelineno-202-3"></a>
<a id="__codelineno-202-4" name="__codelineno-202-4" href="#__codelineno-202-4"></a>                                                         
<a id="__codelineno-202-5" name="__codelineno-202-5" href="#__codelineno-202-5"></a> Central coordinator directs all steps                   
<a id="__codelineno-202-6" name="__codelineno-202-6" href="#__codelineno-202-6"></a>                                                         
<a id="__codelineno-202-7" name="__codelineno-202-7" href="#__codelineno-202-7"></a>                                         
<a id="__codelineno-202-8" name="__codelineno-202-8" href="#__codelineno-202-8"></a>                     SAGA                              
<a id="__codelineno-202-9" name="__codelineno-202-9" href="#__codelineno-202-9"></a>                   ORCHESTRATOR                        
<a id="__codelineno-202-10" name="__codelineno-202-10" href="#__codelineno-202-10"></a>                                         
<a id="__codelineno-202-11" name="__codelineno-202-11" href="#__codelineno-202-11"></a>                                                        
<a id="__codelineno-202-12" name="__codelineno-202-12" href="#__codelineno-202-12"></a>                       
<a id="__codelineno-202-13" name="__codelineno-202-13" href="#__codelineno-202-13"></a>                                                     
<a id="__codelineno-202-14" name="__codelineno-202-14" href="#__codelineno-202-14"></a>                                                     
<a id="__codelineno-202-15" name="__codelineno-202-15" href="#__codelineno-202-15"></a>                         
<a id="__codelineno-202-16" name="__codelineno-202-16" href="#__codelineno-202-16"></a>    Service       Service       Service          
<a id="__codelineno-202-17" name="__codelineno-202-17" href="#__codelineno-202-17"></a>       A             B             C             
<a id="__codelineno-202-18" name="__codelineno-202-18" href="#__codelineno-202-18"></a>                         
<a id="__codelineno-202-19" name="__codelineno-202-19" href="#__codelineno-202-19"></a>                                                         
<a id="__codelineno-202-20" name="__codelineno-202-20" href="#__codelineno-202-20"></a> Flow:                                                   
<a id="__codelineno-202-21" name="__codelineno-202-21" href="#__codelineno-202-21"></a> 1. Orchestrator  Service A: Execute T1                
<a id="__codelineno-202-22" name="__codelineno-202-22" href="#__codelineno-202-22"></a> 2. Service A  Orchestrator: T1 Success                
<a id="__codelineno-202-23" name="__codelineno-202-23" href="#__codelineno-202-23"></a> 3. Orchestrator  Service B: Execute T2                
<a id="__codelineno-202-24" name="__codelineno-202-24" href="#__codelineno-202-24"></a> 4. Service B  Orchestrator: T2 Success                
<a id="__codelineno-202-25" name="__codelineno-202-25" href="#__codelineno-202-25"></a> 5. Orchestrator  Service C: Execute T3                
<a id="__codelineno-202-26" name="__codelineno-202-26" href="#__codelineno-202-26"></a> 6. Service C  Orchestrator: T3 Success                
<a id="__codelineno-202-27" name="__codelineno-202-27" href="#__codelineno-202-27"></a> 7. Saga Complete                                        
<a id="__codelineno-202-28" name="__codelineno-202-28" href="#__codelineno-202-28"></a>                                                         
<a id="__codelineno-202-29" name="__codelineno-202-29" href="#__codelineno-202-29"></a> Characteristics:                                        
<a id="__codelineno-202-30" name="__codelineno-202-30" href="#__codelineno-202-30"></a>  Centralized control                                   
<a id="__codelineno-202-31" name="__codelineno-202-31" href="#__codelineno-202-31"></a>  Orchestrator explicitly invokes services              
<a id="__codelineno-202-32" name="__codelineno-202-32" href="#__codelineno-202-32"></a>  Single point of control (easier to understand)        
<a id="__codelineno-202-33" name="__codelineno-202-33" href="#__codelineno-202-33"></a>  Tighter coupling                                      
<a id="__codelineno-202-34" name="__codelineno-202-34" href="#__codelineno-202-34"></a>  Orchestrator is single point of failure               
<a id="__codelineno-202-35" name="__codelineno-202-35" href="#__codelineno-202-35"></a>  Easier to implement complex logic                     
<a id="__codelineno-202-36" name="__codelineno-202-36" href="#__codelineno-202-36"></a>                                                         
<a id="__codelineno-202-37" name="__codelineno-202-37" href="#__codelineno-202-37"></a>
</code></pre></div>
<p><strong>Comparison: Choreography vs Orchestration</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-203-1" name="__codelineno-203-1" href="#__codelineno-203-1"></a>
<a id="__codelineno-203-2" name="__codelineno-203-2" href="#__codelineno-203-2"></a>    CHOREOGRAPHY vs ORCHESTRATION                        
<a id="__codelineno-203-3" name="__codelineno-203-3" href="#__codelineno-203-3"></a>
<a id="__codelineno-203-4" name="__codelineno-203-4" href="#__codelineno-203-4"></a>                                                         
<a id="__codelineno-203-5" name="__codelineno-203-5" href="#__codelineno-203-5"></a> Aspect           Choreography     Orchestration      
<a id="__codelineno-203-6" name="__codelineno-203-6" href="#__codelineno-203-6"></a>  
<a id="__codelineno-203-7" name="__codelineno-203-7" href="#__codelineno-203-7"></a> Control          Decentralized    Centralized        
<a id="__codelineno-203-8" name="__codelineno-203-8" href="#__codelineno-203-8"></a> Coupling         Loose            Tighter            
<a id="__codelineno-203-9" name="__codelineno-203-9" href="#__codelineno-203-9"></a> Complexity       Higher           Lower              
<a id="__codelineno-203-10" name="__codelineno-203-10" href="#__codelineno-203-10"></a> Debugging        Difficult        Easier             
<a id="__codelineno-203-11" name="__codelineno-203-11" href="#__codelineno-203-11"></a> Single Point     None             Orchestrator       
<a id="__codelineno-203-12" name="__codelineno-203-12" href="#__codelineno-203-12"></a> of Failure                                           
<a id="__codelineno-203-13" name="__codelineno-203-13" href="#__codelineno-203-13"></a> Scalability      Better           Orchestrator       
<a id="__codelineno-203-14" name="__codelineno-203-14" href="#__codelineno-203-14"></a>                                   bottleneck         
<a id="__codelineno-203-15" name="__codelineno-203-15" href="#__codelineno-203-15"></a> Transaction      Emergent         Explicit           
<a id="__codelineno-203-16" name="__codelineno-203-16" href="#__codelineno-203-16"></a> Flow                                                 
<a id="__codelineno-203-17" name="__codelineno-203-17" href="#__codelineno-203-17"></a> Best For         Simple flows     Complex business   
<a id="__codelineno-203-18" name="__codelineno-203-18" href="#__codelineno-203-18"></a>                  Event-driven     logic              
<a id="__codelineno-203-19" name="__codelineno-203-19" href="#__codelineno-203-19"></a>                                                      
<a id="__codelineno-203-20" name="__codelineno-203-20" href="#__codelineno-203-20"></a>
</code></pre></div>
<hr />
<h4 id="72-saga-pattern-example-e-commerce-order">7.2 Saga Pattern Example: E-Commerce Order</h4>
<p><strong>Scenario:</strong> Process an order involving payment, inventory, and shipping</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-204-1" name="__codelineno-204-1" href="#__codelineno-204-1"></a>
<a id="__codelineno-204-2" name="__codelineno-204-2" href="#__codelineno-204-2"></a>         SAGA EXAMPLE: E-COMMERCE ORDER                  
<a id="__codelineno-204-3" name="__codelineno-204-3" href="#__codelineno-204-3"></a>
<a id="__codelineno-204-4" name="__codelineno-204-4" href="#__codelineno-204-4"></a>                                                         
<a id="__codelineno-204-5" name="__codelineno-204-5" href="#__codelineno-204-5"></a> Steps (Forward Transactions):                           
<a id="__codelineno-204-6" name="__codelineno-204-6" href="#__codelineno-204-6"></a> 1. T1: Order Service - Create order                     
<a id="__codelineno-204-7" name="__codelineno-204-7" href="#__codelineno-204-7"></a> 2. T2: Payment Service - Charge customer                
<a id="__codelineno-204-8" name="__codelineno-204-8" href="#__codelineno-204-8"></a> 3. T3: Inventory Service - Reserve items                
<a id="__codelineno-204-9" name="__codelineno-204-9" href="#__codelineno-204-9"></a> 4. T4: Shipping Service - Create shipment               
<a id="__codelineno-204-10" name="__codelineno-204-10" href="#__codelineno-204-10"></a>                                                         
<a id="__codelineno-204-11" name="__codelineno-204-11" href="#__codelineno-204-11"></a> Compensations (Reverse Transactions):                   
<a id="__codelineno-204-12" name="__codelineno-204-12" href="#__codelineno-204-12"></a> 1. C1: Order Service - Cancel order                     
<a id="__codelineno-204-13" name="__codelineno-204-13" href="#__codelineno-204-13"></a> 2. C2: Payment Service - Refund customer                
<a id="__codelineno-204-14" name="__codelineno-204-14" href="#__codelineno-204-14"></a> 3. C3: Inventory Service - Release items                
<a id="__codelineno-204-15" name="__codelineno-204-15" href="#__codelineno-204-15"></a> 4. C4: Shipping Service - Cancel shipment               
<a id="__codelineno-204-16" name="__codelineno-204-16" href="#__codelineno-204-16"></a>                                                         
<a id="__codelineno-204-17" name="__codelineno-204-17" href="#__codelineno-204-17"></a>
</code></pre></div>
<p><strong>Success Scenario (All Steps Succeed):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-205-1" name="__codelineno-205-1" href="#__codelineno-205-1"></a>
<a id="__codelineno-205-2" name="__codelineno-205-2" href="#__codelineno-205-2"></a>         SAGA SUCCESS FLOW                               
<a id="__codelineno-205-3" name="__codelineno-205-3" href="#__codelineno-205-3"></a>
<a id="__codelineno-205-4" name="__codelineno-205-4" href="#__codelineno-205-4"></a>                                                         
<a id="__codelineno-205-5" name="__codelineno-205-5" href="#__codelineno-205-5"></a> Time  Order      Payment     Inventory    Shipping      
<a id="__codelineno-205-6" name="__codelineno-205-6" href="#__codelineno-205-6"></a>   
<a id="__codelineno-205-7" name="__codelineno-205-7" href="#__codelineno-205-7"></a>                                                         
<a id="__codelineno-205-8" name="__codelineno-205-8" href="#__codelineno-205-8"></a> t1    T1: Create                                        
<a id="__codelineno-205-9" name="__codelineno-205-9" href="#__codelineno-205-9"></a>       Order #123                                        
<a id="__codelineno-205-10" name="__codelineno-205-10" href="#__codelineno-205-10"></a>       Status: PENDING                                   
<a id="__codelineno-205-11" name="__codelineno-205-11" href="#__codelineno-205-11"></a>        Success                                         
<a id="__codelineno-205-12" name="__codelineno-205-12" href="#__codelineno-205-12"></a>                                                        
<a id="__codelineno-205-13" name="__codelineno-205-13" href="#__codelineno-205-13"></a> t2              T2: Charge                             
<a id="__codelineno-205-14" name="__codelineno-205-14" href="#__codelineno-205-14"></a>                 $100                                   
<a id="__codelineno-205-15" name="__codelineno-205-15" href="#__codelineno-205-15"></a>                 Card: ****1234                         
<a id="__codelineno-205-16" name="__codelineno-205-16" href="#__codelineno-205-16"></a>                  Success                              
<a id="__codelineno-205-17" name="__codelineno-205-17" href="#__codelineno-205-17"></a>                                                       
<a id="__codelineno-205-18" name="__codelineno-205-18" href="#__codelineno-205-18"></a> t3                        T3: Reserve                 
<a id="__codelineno-205-19" name="__codelineno-205-19" href="#__codelineno-205-19"></a>                           Items: [A, B]               
<a id="__codelineno-205-20" name="__codelineno-205-20" href="#__codelineno-205-20"></a>                           Stock: 108                 
<a id="__codelineno-205-21" name="__codelineno-205-21" href="#__codelineno-205-21"></a>                            Success                   
<a id="__codelineno-205-22" name="__codelineno-205-22" href="#__codelineno-205-22"></a>                                                      
<a id="__codelineno-205-23" name="__codelineno-205-23" href="#__codelineno-205-23"></a> t4                                  T4: Create       
<a id="__codelineno-205-24" name="__codelineno-205-24" href="#__codelineno-205-24"></a>                                     Shipment #456    
<a id="__codelineno-205-25" name="__codelineno-205-25" href="#__codelineno-205-25"></a>                                     Address: 123 St  
<a id="__codelineno-205-26" name="__codelineno-205-26" href="#__codelineno-205-26"></a>                                      Success        
<a id="__codelineno-205-27" name="__codelineno-205-27" href="#__codelineno-205-27"></a>                                                     
<a id="__codelineno-205-28" name="__codelineno-205-28" href="#__codelineno-205-28"></a> t5    Update                                          
<a id="__codelineno-205-29" name="__codelineno-205-29" href="#__codelineno-205-29"></a>       Order #123                                      
<a id="__codelineno-205-30" name="__codelineno-205-30" href="#__codelineno-205-30"></a>       Status: CONFIRMED                               
<a id="__codelineno-205-31" name="__codelineno-205-31" href="#__codelineno-205-31"></a>                                                     
<a id="__codelineno-205-32" name="__codelineno-205-32" href="#__codelineno-205-32"></a>                                                         
<a id="__codelineno-205-33" name="__codelineno-205-33" href="#__codelineno-205-33"></a>  RESULT: Order processed successfully                 
<a id="__codelineno-205-34" name="__codelineno-205-34" href="#__codelineno-205-34"></a>                                                         
<a id="__codelineno-205-35" name="__codelineno-205-35" href="#__codelineno-205-35"></a>
</code></pre></div>
<p><strong>Failure Scenario (Payment Fails - Compensation Triggered):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-206-1" name="__codelineno-206-1" href="#__codelineno-206-1"></a>
<a id="__codelineno-206-2" name="__codelineno-206-2" href="#__codelineno-206-2"></a>         SAGA FAILURE &amp; COMPENSATION FLOW                
<a id="__codelineno-206-3" name="__codelineno-206-3" href="#__codelineno-206-3"></a>
<a id="__codelineno-206-4" name="__codelineno-206-4" href="#__codelineno-206-4"></a>                                                         
<a id="__codelineno-206-5" name="__codelineno-206-5" href="#__codelineno-206-5"></a> Time  Order      Payment     Inventory    Shipping      
<a id="__codelineno-206-6" name="__codelineno-206-6" href="#__codelineno-206-6"></a>   
<a id="__codelineno-206-7" name="__codelineno-206-7" href="#__codelineno-206-7"></a>                                                         
<a id="__codelineno-206-8" name="__codelineno-206-8" href="#__codelineno-206-8"></a>  FORWARD EXECUTION           
<a id="__codelineno-206-9" name="__codelineno-206-9" href="#__codelineno-206-9"></a>                                                         
<a id="__codelineno-206-10" name="__codelineno-206-10" href="#__codelineno-206-10"></a> t1    T1: Create                                        
<a id="__codelineno-206-11" name="__codelineno-206-11" href="#__codelineno-206-11"></a>       Order #123                                        
<a id="__codelineno-206-12" name="__codelineno-206-12" href="#__codelineno-206-12"></a>       Status: PENDING                                   
<a id="__codelineno-206-13" name="__codelineno-206-13" href="#__codelineno-206-13"></a>        Success                                         
<a id="__codelineno-206-14" name="__codelineno-206-14" href="#__codelineno-206-14"></a>                                                        
<a id="__codelineno-206-15" name="__codelineno-206-15" href="#__codelineno-206-15"></a> t2              T2: Charge                             
<a id="__codelineno-206-16" name="__codelineno-206-16" href="#__codelineno-206-16"></a>                 $100                                   
<a id="__codelineno-206-17" name="__codelineno-206-17" href="#__codelineno-206-17"></a>                 Card: ****1234                         
<a id="__codelineno-206-18" name="__codelineno-206-18" href="#__codelineno-206-18"></a>                  FAILED!                             
<a id="__codelineno-206-19" name="__codelineno-206-19" href="#__codelineno-206-19"></a>                 (Insufficient funds)                   
<a id="__codelineno-206-20" name="__codelineno-206-20" href="#__codelineno-206-20"></a>                                                        
<a id="__codelineno-206-21" name="__codelineno-206-21" href="#__codelineno-206-21"></a>  COMPENSATION (ROLLBACK)           
<a id="__codelineno-206-22" name="__codelineno-206-22" href="#__codelineno-206-22"></a>                                                        
<a id="__codelineno-206-23" name="__codelineno-206-23" href="#__codelineno-206-23"></a> t3              Trigger                                
<a id="__codelineno-206-24" name="__codelineno-206-24" href="#__codelineno-206-24"></a>       Compensation                           
<a id="__codelineno-206-25" name="__codelineno-206-25" href="#__codelineno-206-25"></a>                                                        
<a id="__codelineno-206-26" name="__codelineno-206-26" href="#__codelineno-206-26"></a> t4    C1: Cancel                                        
<a id="__codelineno-206-27" name="__codelineno-206-27" href="#__codelineno-206-27"></a>       Order #123                                        
<a id="__codelineno-206-28" name="__codelineno-206-28" href="#__codelineno-206-28"></a>       Status: CANCELLED                                 
<a id="__codelineno-206-29" name="__codelineno-206-29" href="#__codelineno-206-29"></a>       Reason: Payment failed                            
<a id="__codelineno-206-30" name="__codelineno-206-30" href="#__codelineno-206-30"></a>        Compensated                                     
<a id="__codelineno-206-31" name="__codelineno-206-31" href="#__codelineno-206-31"></a>                                                        
<a id="__codelineno-206-32" name="__codelineno-206-32" href="#__codelineno-206-32"></a> t5    Notify                                            
<a id="__codelineno-206-33" name="__codelineno-206-33" href="#__codelineno-206-33"></a>       Customer                                          
<a id="__codelineno-206-34" name="__codelineno-206-34" href="#__codelineno-206-34"></a>        Done                                            
<a id="__codelineno-206-35" name="__codelineno-206-35" href="#__codelineno-206-35"></a>                                                         
<a id="__codelineno-206-36" name="__codelineno-206-36" href="#__codelineno-206-36"></a>  RESULT: Order cancelled (compensated)                
<a id="__codelineno-206-37" name="__codelineno-206-37" href="#__codelineno-206-37"></a>                                                         
<a id="__codelineno-206-38" name="__codelineno-206-38" href="#__codelineno-206-38"></a>
</code></pre></div>
<p><strong>Complex Failure Scenario (Inventory Fails After Payment):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-207-1" name="__codelineno-207-1" href="#__codelineno-207-1"></a>
<a id="__codelineno-207-2" name="__codelineno-207-2" href="#__codelineno-207-2"></a>         SAGA COMPLEX COMPENSATION                       
<a id="__codelineno-207-3" name="__codelineno-207-3" href="#__codelineno-207-3"></a>
<a id="__codelineno-207-4" name="__codelineno-207-4" href="#__codelineno-207-4"></a>                                                         
<a id="__codelineno-207-5" name="__codelineno-207-5" href="#__codelineno-207-5"></a> Time  Order      Payment     Inventory    Shipping      
<a id="__codelineno-207-6" name="__codelineno-207-6" href="#__codelineno-207-6"></a>   
<a id="__codelineno-207-7" name="__codelineno-207-7" href="#__codelineno-207-7"></a>                                                         
<a id="__codelineno-207-8" name="__codelineno-207-8" href="#__codelineno-207-8"></a>  FORWARD EXECUTION           
<a id="__codelineno-207-9" name="__codelineno-207-9" href="#__codelineno-207-9"></a>                                                         
<a id="__codelineno-207-10" name="__codelineno-207-10" href="#__codelineno-207-10"></a> t1    T1: Create                                        
<a id="__codelineno-207-11" name="__codelineno-207-11" href="#__codelineno-207-11"></a>       Order #123                                        
<a id="__codelineno-207-12" name="__codelineno-207-12" href="#__codelineno-207-12"></a>        Success                                         
<a id="__codelineno-207-13" name="__codelineno-207-13" href="#__codelineno-207-13"></a>                                                        
<a id="__codelineno-207-14" name="__codelineno-207-14" href="#__codelineno-207-14"></a> t2              T2: Charge                             
<a id="__codelineno-207-15" name="__codelineno-207-15" href="#__codelineno-207-15"></a>                 $100                                   
<a id="__codelineno-207-16" name="__codelineno-207-16" href="#__codelineno-207-16"></a>                  Success                              
<a id="__codelineno-207-17" name="__codelineno-207-17" href="#__codelineno-207-17"></a>                 (Money deducted!)                      
<a id="__codelineno-207-18" name="__codelineno-207-18" href="#__codelineno-207-18"></a>                                                       
<a id="__codelineno-207-19" name="__codelineno-207-19" href="#__codelineno-207-19"></a> t3                        T3: Reserve                 
<a id="__codelineno-207-20" name="__codelineno-207-20" href="#__codelineno-207-20"></a>                           Items: [A, B]               
<a id="__codelineno-207-21" name="__codelineno-207-21" href="#__codelineno-207-21"></a>                            FAILED!                  
<a id="__codelineno-207-22" name="__codelineno-207-22" href="#__codelineno-207-22"></a>                           (Out of stock)              
<a id="__codelineno-207-23" name="__codelineno-207-23" href="#__codelineno-207-23"></a>                                                       
<a id="__codelineno-207-24" name="__codelineno-207-24" href="#__codelineno-207-24"></a>  COMPENSATION (ROLLBACK)           
<a id="__codelineno-207-25" name="__codelineno-207-25" href="#__codelineno-207-25"></a>                                                       
<a id="__codelineno-207-26" name="__codelineno-207-26" href="#__codelineno-207-26"></a> t4                        Trigger                     
<a id="__codelineno-207-27" name="__codelineno-207-27" href="#__codelineno-207-27"></a>                 Compensation                
<a id="__codelineno-207-28" name="__codelineno-207-28" href="#__codelineno-207-28"></a>                                                       
<a id="__codelineno-207-29" name="__codelineno-207-29" href="#__codelineno-207-29"></a> t5              C2: Refund                             
<a id="__codelineno-207-30" name="__codelineno-207-30" href="#__codelineno-207-30"></a>                 $100                                   
<a id="__codelineno-207-31" name="__codelineno-207-31" href="#__codelineno-207-31"></a>                 Card: ****1234                         
<a id="__codelineno-207-32" name="__codelineno-207-32" href="#__codelineno-207-32"></a>                  Refunded                             
<a id="__codelineno-207-33" name="__codelineno-207-33" href="#__codelineno-207-33"></a>                 (Money returned)                       
<a id="__codelineno-207-34" name="__codelineno-207-34" href="#__codelineno-207-34"></a>                                                       
<a id="__codelineno-207-35" name="__codelineno-207-35" href="#__codelineno-207-35"></a> t6              Trigger                                
<a id="__codelineno-207-36" name="__codelineno-207-36" href="#__codelineno-207-36"></a>       Compensation                           
<a id="__codelineno-207-37" name="__codelineno-207-37" href="#__codelineno-207-37"></a>                                                        
<a id="__codelineno-207-38" name="__codelineno-207-38" href="#__codelineno-207-38"></a> t7    C1: Cancel                                        
<a id="__codelineno-207-39" name="__codelineno-207-39" href="#__codelineno-207-39"></a>       Order #123                                        
<a id="__codelineno-207-40" name="__codelineno-207-40" href="#__codelineno-207-40"></a>       Status: CANCELLED                                 
<a id="__codelineno-207-41" name="__codelineno-207-41" href="#__codelineno-207-41"></a>       Reason: Out of stock                              
<a id="__codelineno-207-42" name="__codelineno-207-42" href="#__codelineno-207-42"></a>        Compensated                                     
<a id="__codelineno-207-43" name="__codelineno-207-43" href="#__codelineno-207-43"></a>                                                        
<a id="__codelineno-207-44" name="__codelineno-207-44" href="#__codelineno-207-44"></a> t8    Notify                                            
<a id="__codelineno-207-45" name="__codelineno-207-45" href="#__codelineno-207-45"></a>       Customer                                          
<a id="__codelineno-207-46" name="__codelineno-207-46" href="#__codelineno-207-46"></a>        Done                                            
<a id="__codelineno-207-47" name="__codelineno-207-47" href="#__codelineno-207-47"></a>                                                         
<a id="__codelineno-207-48" name="__codelineno-207-48" href="#__codelineno-207-48"></a>  RESULT: Order cancelled, payment refunded            
<a id="__codelineno-207-49" name="__codelineno-207-49" href="#__codelineno-207-49"></a>    System returned to consistent state                  
<a id="__codelineno-207-50" name="__codelineno-207-50" href="#__codelineno-207-50"></a>                                                         
<a id="__codelineno-207-51" name="__codelineno-207-51" href="#__codelineno-207-51"></a>
</code></pre></div>
<p><strong>Saga State Machine:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-208-1" name="__codelineno-208-1" href="#__codelineno-208-1"></a>
<a id="__codelineno-208-2" name="__codelineno-208-2" href="#__codelineno-208-2"></a>         SAGA STATE MACHINE                              
<a id="__codelineno-208-3" name="__codelineno-208-3" href="#__codelineno-208-3"></a>
<a id="__codelineno-208-4" name="__codelineno-208-4" href="#__codelineno-208-4"></a>                                                         
<a id="__codelineno-208-5" name="__codelineno-208-5" href="#__codelineno-208-5"></a>                                             
<a id="__codelineno-208-6" name="__codelineno-208-6" href="#__codelineno-208-6"></a>                    START                              
<a id="__codelineno-208-7" name="__codelineno-208-7" href="#__codelineno-208-7"></a>                                             
<a id="__codelineno-208-8" name="__codelineno-208-8" href="#__codelineno-208-8"></a>                                                        
<a id="__codelineno-208-9" name="__codelineno-208-9" href="#__codelineno-208-9"></a>                        Execute T1                      
<a id="__codelineno-208-10" name="__codelineno-208-10" href="#__codelineno-208-10"></a>                                                        
<a id="__codelineno-208-11" name="__codelineno-208-11" href="#__codelineno-208-11"></a>                                             
<a id="__codelineno-208-12" name="__codelineno-208-12" href="#__codelineno-208-12"></a>                T1                                
<a id="__codelineno-208-13" name="__codelineno-208-13" href="#__codelineno-208-13"></a>                 EXECUTING                            
<a id="__codelineno-208-14" name="__codelineno-208-14" href="#__codelineno-208-14"></a>                                            
<a id="__codelineno-208-15" name="__codelineno-208-15" href="#__codelineno-208-15"></a>                                                       
<a id="__codelineno-208-16" name="__codelineno-208-16" href="#__codelineno-208-16"></a>                                            
<a id="__codelineno-208-17" name="__codelineno-208-17" href="#__codelineno-208-17"></a>     T1 Fail                T1 Success                
<a id="__codelineno-208-18" name="__codelineno-208-18" href="#__codelineno-208-18"></a>                                                      
<a id="__codelineno-208-19" name="__codelineno-208-19" href="#__codelineno-208-19"></a>                                      
<a id="__codelineno-208-20" name="__codelineno-208-20" href="#__codelineno-208-20"></a>             FAIL      T2                     
<a id="__codelineno-208-21" name="__codelineno-208-21" href="#__codelineno-208-21"></a>                   EXECUTING     T2 Fail        
<a id="__codelineno-208-22" name="__codelineno-208-22" href="#__codelineno-208-22"></a>                                           
<a id="__codelineno-208-23" name="__codelineno-208-23" href="#__codelineno-208-23"></a>                                                      
<a id="__codelineno-208-24" name="__codelineno-208-24" href="#__codelineno-208-24"></a>                              T2                      
<a id="__codelineno-208-25" name="__codelineno-208-25" href="#__codelineno-208-25"></a>                              Success                 
<a id="__codelineno-208-26" name="__codelineno-208-26" href="#__codelineno-208-26"></a>                                                      
<a id="__codelineno-208-27" name="__codelineno-208-27" href="#__codelineno-208-27"></a>                                           
<a id="__codelineno-208-28" name="__codelineno-208-28" href="#__codelineno-208-28"></a>                           T3                     
<a id="__codelineno-208-29" name="__codelineno-208-29" href="#__codelineno-208-29"></a>                        EXECUTING                     
<a id="__codelineno-208-30" name="__codelineno-208-30" href="#__codelineno-208-30"></a>                                            
<a id="__codelineno-208-31" name="__codelineno-208-31" href="#__codelineno-208-31"></a>                                                       
<a id="__codelineno-208-32" name="__codelineno-208-32" href="#__codelineno-208-32"></a>                                            
<a id="__codelineno-208-33" name="__codelineno-208-33" href="#__codelineno-208-33"></a>                                   T3 Success         
<a id="__codelineno-208-34" name="__codelineno-208-34" href="#__codelineno-208-34"></a>                                                      
<a id="__codelineno-208-35" name="__codelineno-208-35" href="#__codelineno-208-35"></a>                                     
<a id="__codelineno-208-36" name="__codelineno-208-36" href="#__codelineno-208-36"></a>                      C2      SUCCESS              
<a id="__codelineno-208-37" name="__codelineno-208-37" href="#__codelineno-208-37"></a>                      EXEC               
<a id="__codelineno-208-38" name="__codelineno-208-38" href="#__codelineno-208-38"></a>                                                  
<a id="__codelineno-208-39" name="__codelineno-208-39" href="#__codelineno-208-39"></a>                                                       
<a id="__codelineno-208-40" name="__codelineno-208-40" href="#__codelineno-208-40"></a>                                                       
<a id="__codelineno-208-41" name="__codelineno-208-41" href="#__codelineno-208-41"></a>                                                  
<a id="__codelineno-208-42" name="__codelineno-208-42" href="#__codelineno-208-42"></a>                      C1                              
<a id="__codelineno-208-43" name="__codelineno-208-43" href="#__codelineno-208-43"></a>                      EXEC                            
<a id="__codelineno-208-44" name="__codelineno-208-44" href="#__codelineno-208-44"></a>                                                  
<a id="__codelineno-208-45" name="__codelineno-208-45" href="#__codelineno-208-45"></a>                                                       
<a id="__codelineno-208-46" name="__codelineno-208-46" href="#__codelineno-208-46"></a>                                                       
<a id="__codelineno-208-47" name="__codelineno-208-47" href="#__codelineno-208-47"></a>                                         
<a id="__codelineno-208-48" name="__codelineno-208-48" href="#__codelineno-208-48"></a>               COMPENSATED                             
<a id="__codelineno-208-49" name="__codelineno-208-49" href="#__codelineno-208-49"></a>                (Failed)                               
<a id="__codelineno-208-50" name="__codelineno-208-50" href="#__codelineno-208-50"></a>                                         
<a id="__codelineno-208-51" name="__codelineno-208-51" href="#__codelineno-208-51"></a>                                                         
<a id="__codelineno-208-52" name="__codelineno-208-52" href="#__codelineno-208-52"></a>
</code></pre></div>
<hr />
<h4 id="73-advantages-of-saga-pattern">7.3 Advantages of Saga Pattern</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-209-1" name="__codelineno-209-1" href="#__codelineno-209-1"></a>
<a id="__codelineno-209-2" name="__codelineno-209-2" href="#__codelineno-209-2"></a>         SAGA PATTERN ADVANTAGES                         
<a id="__codelineno-209-3" name="__codelineno-209-3" href="#__codelineno-209-3"></a>
<a id="__codelineno-209-4" name="__codelineno-209-4" href="#__codelineno-209-4"></a>                                                         
<a id="__codelineno-209-5" name="__codelineno-209-5" href="#__codelineno-209-5"></a> 1.  HIGH SCALABILITY                                  
<a id="__codelineno-209-6" name="__codelineno-209-6" href="#__codelineno-209-6"></a>                
<a id="__codelineno-209-7" name="__codelineno-209-7" href="#__codelineno-209-7"></a>      No distributed locks                           
<a id="__codelineno-209-8" name="__codelineno-209-8" href="#__codelineno-209-8"></a>      No blocking coordination                       
<a id="__codelineno-209-9" name="__codelineno-209-9" href="#__codelineno-209-9"></a>      Services execute independently                 
<a id="__codelineno-209-10" name="__codelineno-209-10" href="#__codelineno-209-10"></a>      Horizontal scaling possible                    
<a id="__codelineno-209-11" name="__codelineno-209-11" href="#__codelineno-209-11"></a>      Handles millions of transactions               
<a id="__codelineno-209-12" name="__codelineno-209-12" href="#__codelineno-209-12"></a>                
<a id="__codelineno-209-13" name="__codelineno-209-13" href="#__codelineno-209-13"></a>                                                         
<a id="__codelineno-209-14" name="__codelineno-209-14" href="#__codelineno-209-14"></a> 2.  HIGH AVAILABILITY                                 
<a id="__codelineno-209-15" name="__codelineno-209-15" href="#__codelineno-209-15"></a>                
<a id="__codelineno-209-16" name="__codelineno-209-16" href="#__codelineno-209-16"></a>      No synchronous blocking                        
<a id="__codelineno-209-17" name="__codelineno-209-17" href="#__codelineno-209-17"></a>      Service failures isolated                      
<a id="__codelineno-209-18" name="__codelineno-209-18" href="#__codelineno-209-18"></a>      Graceful degradation                           
<a id="__codelineno-209-19" name="__codelineno-209-19" href="#__codelineno-209-19"></a>      Asynchronous processing                        
<a id="__codelineno-209-20" name="__codelineno-209-20" href="#__codelineno-209-20"></a>      Better fault tolerance                         
<a id="__codelineno-209-21" name="__codelineno-209-21" href="#__codelineno-209-21"></a>                
<a id="__codelineno-209-22" name="__codelineno-209-22" href="#__codelineno-209-22"></a>                                                         
<a id="__codelineno-209-23" name="__codelineno-209-23" href="#__codelineno-209-23"></a> 3.  LOOSE COUPLING (Choreography)                     
<a id="__codelineno-209-24" name="__codelineno-209-24" href="#__codelineno-209-24"></a>                
<a id="__codelineno-209-25" name="__codelineno-209-25" href="#__codelineno-209-25"></a>      Services don&#39;t know about saga                 
<a id="__codelineno-209-26" name="__codelineno-209-26" href="#__codelineno-209-26"></a>      Event-driven communication                     
<a id="__codelineno-209-27" name="__codelineno-209-27" href="#__codelineno-209-27"></a>      Easy to add new services                       
<a id="__codelineno-209-28" name="__codelineno-209-28" href="#__codelineno-209-28"></a>      Independent deployment                         
<a id="__codelineno-209-29" name="__codelineno-209-29" href="#__codelineno-209-29"></a>      Microservices-friendly                         
<a id="__codelineno-209-30" name="__codelineno-209-30" href="#__codelineno-209-30"></a>                
<a id="__codelineno-209-31" name="__codelineno-209-31" href="#__codelineno-209-31"></a>                                                         
<a id="__codelineno-209-32" name="__codelineno-209-32" href="#__codelineno-209-32"></a> 4.  NO DISTRIBUTED TRANSACTIONS                       
<a id="__codelineno-209-33" name="__codelineno-209-33" href="#__codelineno-209-33"></a>                
<a id="__codelineno-209-34" name="__codelineno-209-34" href="#__codelineno-209-34"></a>      Local transactions only                        
<a id="__codelineno-209-35" name="__codelineno-209-35" href="#__codelineno-209-35"></a>      Each service owns its data                     
<a id="__codelineno-209-36" name="__codelineno-209-36" href="#__codelineno-209-36"></a>      No 2PC overhead                                
<a id="__codelineno-209-37" name="__codelineno-209-37" href="#__codelineno-209-37"></a>      Better performance                             
<a id="__codelineno-209-38" name="__codelineno-209-38" href="#__codelineno-209-38"></a>      Simpler database design                        
<a id="__codelineno-209-39" name="__codelineno-209-39" href="#__codelineno-209-39"></a>                
<a id="__codelineno-209-40" name="__codelineno-209-40" href="#__codelineno-209-40"></a>                                                         
<a id="__codelineno-209-41" name="__codelineno-209-41" href="#__codelineno-209-41"></a> 5.  BUSINESS-ALIGNED                                  
<a id="__codelineno-209-42" name="__codelineno-209-42" href="#__codelineno-209-42"></a>                
<a id="__codelineno-209-43" name="__codelineno-209-43" href="#__codelineno-209-43"></a>      Mirrors business processes                     
<a id="__codelineno-209-44" name="__codelineno-209-44" href="#__codelineno-209-44"></a>      Clear compensation semantics                   
<a id="__codelineno-209-45" name="__codelineno-209-45" href="#__codelineno-209-45"></a>      Matches domain workflows                       
<a id="__codelineno-209-46" name="__codelineno-209-46" href="#__codelineno-209-46"></a>      Natural for long-running processes             
<a id="__codelineno-209-47" name="__codelineno-209-47" href="#__codelineno-209-47"></a>      Explicit business logic                        
<a id="__codelineno-209-48" name="__codelineno-209-48" href="#__codelineno-209-48"></a>                
<a id="__codelineno-209-49" name="__codelineno-209-49" href="#__codelineno-209-49"></a>                                                         
<a id="__codelineno-209-50" name="__codelineno-209-50" href="#__codelineno-209-50"></a> 6.  HANDLES LONG-LIVED TRANSACTIONS                   
<a id="__codelineno-209-51" name="__codelineno-209-51" href="#__codelineno-209-51"></a>                
<a id="__codelineno-209-52" name="__codelineno-209-52" href="#__codelineno-209-52"></a>      Can span hours/days                            
<a id="__codelineno-209-53" name="__codelineno-209-53" href="#__codelineno-209-53"></a>      No lock timeout issues                         
<a id="__codelineno-209-54" name="__codelineno-209-54" href="#__codelineno-209-54"></a>      Resources released immediately                 
<a id="__codelineno-209-55" name="__codelineno-209-55" href="#__codelineno-209-55"></a>      Good for batch processing                      
<a id="__codelineno-209-56" name="__codelineno-209-56" href="#__codelineno-209-56"></a>                
<a id="__codelineno-209-57" name="__codelineno-209-57" href="#__codelineno-209-57"></a>                                                         
<a id="__codelineno-209-58" name="__codelineno-209-58" href="#__codelineno-209-58"></a> 7.  CLOUD-NATIVE &amp; MICROSERVICES                      
<a id="__codelineno-209-59" name="__codelineno-209-59" href="#__codelineno-209-59"></a>                
<a id="__codelineno-209-60" name="__codelineno-209-60" href="#__codelineno-209-60"></a>      Perfect for distributed systems                
<a id="__codelineno-209-61" name="__codelineno-209-61" href="#__codelineno-209-61"></a>      Works with event buses (Kafka)                 
<a id="__codelineno-209-62" name="__codelineno-209-62" href="#__codelineno-209-62"></a>      Service mesh compatible                        
<a id="__codelineno-209-63" name="__codelineno-209-63" href="#__codelineno-209-63"></a>      Serverless-friendly                            
<a id="__codelineno-209-64" name="__codelineno-209-64" href="#__codelineno-209-64"></a>                
<a id="__codelineno-209-65" name="__codelineno-209-65" href="#__codelineno-209-65"></a>                                                         
<a id="__codelineno-209-66" name="__codelineno-209-66" href="#__codelineno-209-66"></a>
</code></pre></div>
<hr />
<h4 id="74-disadvantages-of-saga-pattern">7.4 Disadvantages of Saga Pattern</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-210-1" name="__codelineno-210-1" href="#__codelineno-210-1"></a>
<a id="__codelineno-210-2" name="__codelineno-210-2" href="#__codelineno-210-2"></a>         SAGA PATTERN DISADVANTAGES                      
<a id="__codelineno-210-3" name="__codelineno-210-3" href="#__codelineno-210-3"></a>
<a id="__codelineno-210-4" name="__codelineno-210-4" href="#__codelineno-210-4"></a>                                                         
<a id="__codelineno-210-5" name="__codelineno-210-5" href="#__codelineno-210-5"></a> 1.  NO ISOLATION (ACID Violation)                     
<a id="__codelineno-210-6" name="__codelineno-210-6" href="#__codelineno-210-6"></a>                
<a id="__codelineno-210-7" name="__codelineno-210-7" href="#__codelineno-210-7"></a>      Intermediate states visible                    
<a id="__codelineno-210-8" name="__codelineno-210-8" href="#__codelineno-210-8"></a>      Dirty reads possible                           
<a id="__codelineno-210-9" name="__codelineno-210-9" href="#__codelineno-210-9"></a>      Concurrent sagas can interfere                 
<a id="__codelineno-210-10" name="__codelineno-210-10" href="#__codelineno-210-10"></a>      Lost updates possible                          
<a id="__codelineno-210-11" name="__codelineno-210-11" href="#__codelineno-210-11"></a>      Requires semantic locks                        
<a id="__codelineno-210-12" name="__codelineno-210-12" href="#__codelineno-210-12"></a>                
<a id="__codelineno-210-13" name="__codelineno-210-13" href="#__codelineno-210-13"></a>                                                         
<a id="__codelineno-210-14" name="__codelineno-210-14" href="#__codelineno-210-14"></a> 2.  EVENTUAL CONSISTENCY ONLY                         
<a id="__codelineno-210-15" name="__codelineno-210-15" href="#__codelineno-210-15"></a>                
<a id="__codelineno-210-16" name="__codelineno-210-16" href="#__codelineno-210-16"></a>      Not immediately consistent                     
<a id="__codelineno-210-17" name="__codelineno-210-17" href="#__codelineno-210-17"></a>      Temporary inconsistencies                      
<a id="__codelineno-210-18" name="__codelineno-210-18" href="#__codelineno-210-18"></a>      Application must handle                        
<a id="__codelineno-210-19" name="__codelineno-210-19" href="#__codelineno-210-19"></a>      Not suitable for all use cases                 
<a id="__codelineno-210-20" name="__codelineno-210-20" href="#__codelineno-210-20"></a>      Complex to reason about                        
<a id="__codelineno-210-21" name="__codelineno-210-21" href="#__codelineno-210-21"></a>                
<a id="__codelineno-210-22" name="__codelineno-210-22" href="#__codelineno-210-22"></a>                                                         
<a id="__codelineno-210-23" name="__codelineno-210-23" href="#__codelineno-210-23"></a> 3.  COMPLEX COMPENSATION LOGIC                        
<a id="__codelineno-210-24" name="__codelineno-210-24" href="#__codelineno-210-24"></a>                
<a id="__codelineno-210-25" name="__codelineno-210-25" href="#__codelineno-210-25"></a>      Must write compensating txns                   
<a id="__codelineno-210-26" name="__codelineno-210-26" href="#__codelineno-210-26"></a>      Not all operations reversible                  
<a id="__codelineno-210-27" name="__codelineno-210-27" href="#__codelineno-210-27"></a>      Semantic complexity                            
<a id="__codelineno-210-28" name="__codelineno-210-28" href="#__codelineno-210-28"></a>      Idempotency required                           
<a id="__codelineno-210-29" name="__codelineno-210-29" href="#__codelineno-210-29"></a>      Testing difficult                              
<a id="__codelineno-210-30" name="__codelineno-210-30" href="#__codelineno-210-30"></a>                
<a id="__codelineno-210-31" name="__codelineno-210-31" href="#__codelineno-210-31"></a>                                                         
<a id="__codelineno-210-32" name="__codelineno-210-32" href="#__codelineno-210-32"></a> 4.  DIFFICULT TO DEBUG                                
<a id="__codelineno-210-33" name="__codelineno-210-33" href="#__codelineno-210-33"></a>                
<a id="__codelineno-210-34" name="__codelineno-210-34" href="#__codelineno-210-34"></a>      Distributed tracing needed                     
<a id="__codelineno-210-35" name="__codelineno-210-35" href="#__codelineno-210-35"></a>      Asynchronous flows hard to track               
<a id="__codelineno-210-36" name="__codelineno-210-36" href="#__codelineno-210-36"></a>      Event ordering issues                          
<a id="__codelineno-210-37" name="__codelineno-210-37" href="#__codelineno-210-37"></a>      Multiple failure modes                         
<a id="__codelineno-210-38" name="__codelineno-210-38" href="#__codelineno-210-38"></a>      Correlation IDs essential                      
<a id="__codelineno-210-39" name="__codelineno-210-39" href="#__codelineno-210-39"></a>                
<a id="__codelineno-210-40" name="__codelineno-210-40" href="#__codelineno-210-40"></a>                                                         
<a id="__codelineno-210-41" name="__codelineno-210-41" href="#__codelineno-210-41"></a> 5.  CYCLIC DEPENDENCIES RISK (Choreography)           
<a id="__codelineno-210-42" name="__codelineno-210-42" href="#__codelineno-210-42"></a>                
<a id="__codelineno-210-43" name="__codelineno-210-43" href="#__codelineno-210-43"></a>      Services tightly coupled via events            
<a id="__codelineno-210-44" name="__codelineno-210-44" href="#__codelineno-210-44"></a>      Circular event chains possible                 
<a id="__codelineno-210-45" name="__codelineno-210-45" href="#__codelineno-210-45"></a>      Hard to understand flow                        
<a id="__codelineno-210-46" name="__codelineno-210-46" href="#__codelineno-210-46"></a>      Refactoring difficult                          
<a id="__codelineno-210-47" name="__codelineno-210-47" href="#__codelineno-210-47"></a>                
<a id="__codelineno-210-48" name="__codelineno-210-48" href="#__codelineno-210-48"></a>                                                         
<a id="__codelineno-210-49" name="__codelineno-210-49" href="#__codelineno-210-49"></a> 6.  REQUIRES INFRASTRUCTURE                           
<a id="__codelineno-210-50" name="__codelineno-210-50" href="#__codelineno-210-50"></a>                
<a id="__codelineno-210-51" name="__codelineno-210-51" href="#__codelineno-210-51"></a>      Message broker needed (Kafka, etc.)            
<a id="__codelineno-210-52" name="__codelineno-210-52" href="#__codelineno-210-52"></a>      Saga orchestrator framework                    
<a id="__codelineno-210-53" name="__codelineno-210-53" href="#__codelineno-210-53"></a>      Distributed tracing tools                      
<a id="__codelineno-210-54" name="__codelineno-210-54" href="#__codelineno-210-54"></a>      Event store/log                                
<a id="__codelineno-210-55" name="__codelineno-210-55" href="#__codelineno-210-55"></a>      Monitoring and observability                   
<a id="__codelineno-210-56" name="__codelineno-210-56" href="#__codelineno-210-56"></a>                
<a id="__codelineno-210-57" name="__codelineno-210-57" href="#__codelineno-210-57"></a>                                                         
<a id="__codelineno-210-58" name="__codelineno-210-58" href="#__codelineno-210-58"></a> 7.  INCREASED LATENCY                                 
<a id="__codelineno-210-59" name="__codelineno-210-59" href="#__codelineno-210-59"></a>                
<a id="__codelineno-210-60" name="__codelineno-210-60" href="#__codelineno-210-60"></a>      Multiple async steps                           
<a id="__codelineno-210-61" name="__codelineno-210-61" href="#__codelineno-210-61"></a>      Message queue delays                           
<a id="__codelineno-210-62" name="__codelineno-210-62" href="#__codelineno-210-62"></a>      Network hops                                   
<a id="__codelineno-210-63" name="__codelineno-210-63" href="#__codelineno-210-63"></a>      Can take seconds/minutes                       
<a id="__codelineno-210-64" name="__codelineno-210-64" href="#__codelineno-210-64"></a>                
<a id="__codelineno-210-65" name="__codelineno-210-65" href="#__codelineno-210-65"></a>                                                         
<a id="__codelineno-210-66" name="__codelineno-210-66" href="#__codelineno-210-66"></a>
</code></pre></div>
<hr />
<h4 id="75-problems-in-saga-pattern">7.5 Problems in Saga Pattern</h4>
<p><strong>Problem 1: Lack of Isolation (Anomalies)</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-211-1" name="__codelineno-211-1" href="#__codelineno-211-1"></a>
<a id="__codelineno-211-2" name="__codelineno-211-2" href="#__codelineno-211-2"></a>       PROBLEM 1: ISOLATION ANOMALIES                    
<a id="__codelineno-211-3" name="__codelineno-211-3" href="#__codelineno-211-3"></a>
<a id="__codelineno-211-4" name="__codelineno-211-4" href="#__codelineno-211-4"></a>                                                         
<a id="__codelineno-211-5" name="__codelineno-211-5" href="#__codelineno-211-5"></a> Scenario: Two concurrent sagas modifying same data     
<a id="__codelineno-211-6" name="__codelineno-211-6" href="#__codelineno-211-6"></a>                                                         
<a id="__codelineno-211-7" name="__codelineno-211-7" href="#__codelineno-211-7"></a> Anomaly 1: DIRTY READ (Reading uncommitted changes)    
<a id="__codelineno-211-8" name="__codelineno-211-8" href="#__codelineno-211-8"></a>     
<a id="__codelineno-211-9" name="__codelineno-211-9" href="#__codelineno-211-9"></a>                                                         
<a id="__codelineno-211-10" name="__codelineno-211-10" href="#__codelineno-211-10"></a> Time  Saga 1 (Order A)         Saga 2 (Order B)        
<a id="__codelineno-211-11" name="__codelineno-211-11" href="#__codelineno-211-11"></a>     
<a id="__codelineno-211-12" name="__codelineno-211-12" href="#__codelineno-211-12"></a>                                                         
<a id="__codelineno-211-13" name="__codelineno-211-13" href="#__codelineno-211-13"></a> t1    T1: Reserve 5 items                               
<a id="__codelineno-211-14" name="__codelineno-211-14" href="#__codelineno-211-14"></a>       Inventory: 10  5                                 
<a id="__codelineno-211-15" name="__codelineno-211-15" href="#__codelineno-211-15"></a>        Committed!                                      
<a id="__codelineno-211-16" name="__codelineno-211-16" href="#__codelineno-211-16"></a>       (Visible to others)                               
<a id="__codelineno-211-17" name="__codelineno-211-17" href="#__codelineno-211-17"></a>                                                        
<a id="__codelineno-211-18" name="__codelineno-211-18" href="#__codelineno-211-18"></a> t2                            T1: Check inventory      
<a id="__codelineno-211-19" name="__codelineno-211-19" href="#__codelineno-211-19"></a>                               See: 5 items available   
<a id="__codelineno-211-20" name="__codelineno-211-20" href="#__codelineno-211-20"></a>                               Reserve 5 items          
<a id="__codelineno-211-21" name="__codelineno-211-21" href="#__codelineno-211-21"></a>                               Inventory: 5  0         
<a id="__codelineno-211-22" name="__codelineno-211-22" href="#__codelineno-211-22"></a>                                Committed!             
<a id="__codelineno-211-23" name="__codelineno-211-23" href="#__codelineno-211-23"></a>                                                       
<a id="__codelineno-211-24" name="__codelineno-211-24" href="#__codelineno-211-24"></a> t3    T2: Payment FAILS!                             
<a id="__codelineno-211-25" name="__codelineno-211-25" href="#__codelineno-211-25"></a>       (Card declined)                                  
<a id="__codelineno-211-26" name="__codelineno-211-26" href="#__codelineno-211-26"></a>                                                       
<a id="__codelineno-211-27" name="__codelineno-211-27" href="#__codelineno-211-27"></a> t4    C1: Release 5 items                              
<a id="__codelineno-211-28" name="__codelineno-211-28" href="#__codelineno-211-28"></a>       Inventory: 0  5                                 
<a id="__codelineno-211-29" name="__codelineno-211-29" href="#__codelineno-211-29"></a>        Compensated                                    
<a id="__codelineno-211-30" name="__codelineno-211-30" href="#__codelineno-211-30"></a>                                                       
<a id="__codelineno-211-31" name="__codelineno-211-31" href="#__codelineno-211-31"></a> t5                            T2: Ship items           
<a id="__codelineno-211-32" name="__codelineno-211-32" href="#__codelineno-211-32"></a>                               But only 5 in inventory! 
<a id="__codelineno-211-33" name="__codelineno-211-33" href="#__codelineno-211-33"></a>                                INCONSISTENCY!        
<a id="__codelineno-211-34" name="__codelineno-211-34" href="#__codelineno-211-34"></a>                                                         
<a id="__codelineno-211-35" name="__codelineno-211-35" href="#__codelineno-211-35"></a> Problem:                                                
<a id="__codelineno-211-36" name="__codelineno-211-36" href="#__codelineno-211-36"></a>  Saga 2 read Saga 1&#39;s uncommitted state                
<a id="__codelineno-211-37" name="__codelineno-211-37" href="#__codelineno-211-37"></a>  Saga 1 later compensated (rolled back)                
<a id="__codelineno-211-38" name="__codelineno-211-38" href="#__codelineno-211-38"></a>  Saga 2 made decisions based on wrong state            
<a id="__codelineno-211-39" name="__codelineno-211-39" href="#__codelineno-211-39"></a>  Result: Oversold inventory!                         
<a id="__codelineno-211-40" name="__codelineno-211-40" href="#__codelineno-211-40"></a>                                                         
<a id="__codelineno-211-41" name="__codelineno-211-41" href="#__codelineno-211-41"></a>
</code></pre></div>
<p><strong>Anomaly 2: Lost Updates</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-212-1" name="__codelineno-212-1" href="#__codelineno-212-1"></a>
<a id="__codelineno-212-2" name="__codelineno-212-2" href="#__codelineno-212-2"></a>       ANOMALY 2: LOST UPDATE                            
<a id="__codelineno-212-3" name="__codelineno-212-3" href="#__codelineno-212-3"></a>
<a id="__codelineno-212-4" name="__codelineno-212-4" href="#__codelineno-212-4"></a>                                                         
<a id="__codelineno-212-5" name="__codelineno-212-5" href="#__codelineno-212-5"></a> Time  Saga 1                   Saga 2                   
<a id="__codelineno-212-6" name="__codelineno-212-6" href="#__codelineno-212-6"></a>     
<a id="__codelineno-212-7" name="__codelineno-212-7" href="#__codelineno-212-7"></a>                                                         
<a id="__codelineno-212-8" name="__codelineno-212-8" href="#__codelineno-212-8"></a> t1    Read Balance: $1000                               
<a id="__codelineno-212-9" name="__codelineno-212-9" href="#__codelineno-212-9"></a>                                                        
<a id="__codelineno-212-10" name="__codelineno-212-10" href="#__codelineno-212-10"></a> t2                            Read Balance: $1000      
<a id="__codelineno-212-11" name="__codelineno-212-11" href="#__codelineno-212-11"></a>                                                       
<a id="__codelineno-212-12" name="__codelineno-212-12" href="#__codelineno-212-12"></a> t3    Deduct $200                                      
<a id="__codelineno-212-13" name="__codelineno-212-13" href="#__codelineno-212-13"></a>       Balance: $1000  $800                            
<a id="__codelineno-212-14" name="__codelineno-212-14" href="#__codelineno-212-14"></a>       Commit                                          
<a id="__codelineno-212-15" name="__codelineno-212-15" href="#__codelineno-212-15"></a>                                                       
<a id="__codelineno-212-16" name="__codelineno-212-16" href="#__codelineno-212-16"></a> t4                            Deduct $300              
<a id="__codelineno-212-17" name="__codelineno-212-17" href="#__codelineno-212-17"></a>                               Balance: $1000  $700    
<a id="__codelineno-212-18" name="__codelineno-212-18" href="#__codelineno-212-18"></a>                               Commit                  
<a id="__codelineno-212-19" name="__codelineno-212-19" href="#__codelineno-212-19"></a>                               (Overwrites Saga 1!)     
<a id="__codelineno-212-20" name="__codelineno-212-20" href="#__codelineno-212-20"></a>                                                       
<a id="__codelineno-212-21" name="__codelineno-212-21" href="#__codelineno-212-21"></a> t5    Final Balance: $700 (should be $500!)             
<a id="__codelineno-212-22" name="__codelineno-212-22" href="#__codelineno-212-22"></a>       Lost Update!                                     
<a id="__codelineno-212-23" name="__codelineno-212-23" href="#__codelineno-212-23"></a>                                                         
<a id="__codelineno-212-24" name="__codelineno-212-24" href="#__codelineno-212-24"></a> Problem:                                                
<a id="__codelineno-212-25" name="__codelineno-212-25" href="#__codelineno-212-25"></a>  No isolation between sagas                            
<a id="__codelineno-212-26" name="__codelineno-212-26" href="#__codelineno-212-26"></a>  Saga 2 overwrote Saga 1&#39;s changes                     
<a id="__codelineno-212-27" name="__codelineno-212-27" href="#__codelineno-212-27"></a>  $200 deduction lost                                   
<a id="__codelineno-212-28" name="__codelineno-212-28" href="#__codelineno-212-28"></a>                                                         
<a id="__codelineno-212-29" name="__codelineno-212-29" href="#__codelineno-212-29"></a>
</code></pre></div>
<p><strong>Problem 2: Compensation Failures</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-213-1" name="__codelineno-213-1" href="#__codelineno-213-1"></a>
<a id="__codelineno-213-2" name="__codelineno-213-2" href="#__codelineno-213-2"></a>       PROBLEM 2: COMPENSATION FAILURES                  
<a id="__codelineno-213-3" name="__codelineno-213-3" href="#__codelineno-213-3"></a>
<a id="__codelineno-213-4" name="__codelineno-213-4" href="#__codelineno-213-4"></a>                                                         
<a id="__codelineno-213-5" name="__codelineno-213-5" href="#__codelineno-213-5"></a> Scenario: Compensation transaction fails                
<a id="__codelineno-213-6" name="__codelineno-213-6" href="#__codelineno-213-6"></a>                                                         
<a id="__codelineno-213-7" name="__codelineno-213-7" href="#__codelineno-213-7"></a> Time  Order      Payment     Inventory    Shipping      
<a id="__codelineno-213-8" name="__codelineno-213-8" href="#__codelineno-213-8"></a>     
<a id="__codelineno-213-9" name="__codelineno-213-9" href="#__codelineno-213-9"></a>                                                         
<a id="__codelineno-213-10" name="__codelineno-213-10" href="#__codelineno-213-10"></a> t1    T1: Create                                        
<a id="__codelineno-213-11" name="__codelineno-213-11" href="#__codelineno-213-11"></a>                                                        
<a id="__codelineno-213-12" name="__codelineno-213-12" href="#__codelineno-213-12"></a>                                                        
<a id="__codelineno-213-13" name="__codelineno-213-13" href="#__codelineno-213-13"></a> t2              T2: Charge                             
<a id="__codelineno-213-14" name="__codelineno-213-14" href="#__codelineno-213-14"></a>                 $100                                  
<a id="__codelineno-213-15" name="__codelineno-213-15" href="#__codelineno-213-15"></a>                 (Money taken!)                         
<a id="__codelineno-213-16" name="__codelineno-213-16" href="#__codelineno-213-16"></a>                                                       
<a id="__codelineno-213-17" name="__codelineno-213-17" href="#__codelineno-213-17"></a> t3                        T3: Reserve                 
<a id="__codelineno-213-18" name="__codelineno-213-18" href="#__codelineno-213-18"></a>                            FAILED!                  
<a id="__codelineno-213-19" name="__codelineno-213-19" href="#__codelineno-213-19"></a>                                                       
<a id="__codelineno-213-20" name="__codelineno-213-20" href="#__codelineno-213-20"></a> t4              C2: Refund                             
<a id="__codelineno-213-21" name="__codelineno-213-21" href="#__codelineno-213-21"></a>                 $100                                   
<a id="__codelineno-213-22" name="__codelineno-213-22" href="#__codelineno-213-22"></a>                  REFUND FAILED!                      
<a id="__codelineno-213-23" name="__codelineno-213-23" href="#__codelineno-213-23"></a>                 (Network timeout)                      
<a id="__codelineno-213-24" name="__codelineno-213-24" href="#__codelineno-213-24"></a>                  STUCK!                              
<a id="__codelineno-213-25" name="__codelineno-213-25" href="#__codelineno-213-25"></a>                                                        
<a id="__codelineno-213-26" name="__codelineno-213-26" href="#__codelineno-213-26"></a> Problem:                                                
<a id="__codelineno-213-27" name="__codelineno-213-27" href="#__codelineno-213-27"></a>            
<a id="__codelineno-213-28" name="__codelineno-213-28" href="#__codelineno-213-28"></a>   Customer charged but no order                     
<a id="__codelineno-213-29" name="__codelineno-213-29" href="#__codelineno-213-29"></a>   Refund failed                                     
<a id="__codelineno-213-30" name="__codelineno-213-30" href="#__codelineno-213-30"></a>   Inconsistent state!                               
<a id="__codelineno-213-31" name="__codelineno-213-31" href="#__codelineno-213-31"></a>   Money lost for customer                           
<a id="__codelineno-213-32" name="__codelineno-213-32" href="#__codelineno-213-32"></a>   Manual intervention needed                        
<a id="__codelineno-213-33" name="__codelineno-213-33" href="#__codelineno-213-33"></a>            
<a id="__codelineno-213-34" name="__codelineno-213-34" href="#__codelineno-213-34"></a>                                                         
<a id="__codelineno-213-35" name="__codelineno-213-35" href="#__codelineno-213-35"></a> Solutions:                                              
<a id="__codelineno-213-36" name="__codelineno-213-36" href="#__codelineno-213-36"></a>  Retry with exponential backoff                        
<a id="__codelineno-213-37" name="__codelineno-213-37" href="#__codelineno-213-37"></a>  Dead letter queue for failures                        
<a id="__codelineno-213-38" name="__codelineno-213-38" href="#__codelineno-213-38"></a>  Manual reconciliation process                         
<a id="__codelineno-213-39" name="__codelineno-213-39" href="#__codelineno-213-39"></a>  Idempotent compensations                              
<a id="__codelineno-213-40" name="__codelineno-213-40" href="#__codelineno-213-40"></a>  Alert operators                                       
<a id="__codelineno-213-41" name="__codelineno-213-41" href="#__codelineno-213-41"></a>                                                         
<a id="__codelineno-213-42" name="__codelineno-213-42" href="#__codelineno-213-42"></a>
</code></pre></div>
<p><strong>Problem 3: Non-Compensatable Operations</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-214-1" name="__codelineno-214-1" href="#__codelineno-214-1"></a>
<a id="__codelineno-214-2" name="__codelineno-214-2" href="#__codelineno-214-2"></a>       PROBLEM 3: NON-COMPENSATABLE OPERATIONS           
<a id="__codelineno-214-3" name="__codelineno-214-3" href="#__codelineno-214-3"></a>
<a id="__codelineno-214-4" name="__codelineno-214-4" href="#__codelineno-214-4"></a>                                                         
<a id="__codelineno-214-5" name="__codelineno-214-5" href="#__codelineno-214-5"></a> Some operations cannot be &quot;undone&quot;:                     
<a id="__codelineno-214-6" name="__codelineno-214-6" href="#__codelineno-214-6"></a>                                                         
<a id="__codelineno-214-7" name="__codelineno-214-7" href="#__codelineno-214-7"></a> 1.  EMAIL SENT                                        
<a id="__codelineno-214-8" name="__codelineno-214-8" href="#__codelineno-214-8"></a>                
<a id="__codelineno-214-9" name="__codelineno-214-9" href="#__codelineno-214-9"></a>     Operation: Send confirmation email               
<a id="__codelineno-214-10" name="__codelineno-214-10" href="#__codelineno-214-10"></a>     Compensation: ???                                
<a id="__codelineno-214-11" name="__codelineno-214-11" href="#__codelineno-214-11"></a>      Cannot &quot;unsend&quot; email                          
<a id="__codelineno-214-12" name="__codelineno-214-12" href="#__codelineno-214-12"></a>      Can send apology email (not same)              
<a id="__codelineno-214-13" name="__codelineno-214-13" href="#__codelineno-214-13"></a>      Customer already saw confirmation              
<a id="__codelineno-214-14" name="__codelineno-214-14" href="#__codelineno-214-14"></a>                
<a id="__codelineno-214-15" name="__codelineno-214-15" href="#__codelineno-214-15"></a>                                                         
<a id="__codelineno-214-16" name="__codelineno-214-16" href="#__codelineno-214-16"></a> 2.  THIRD-PARTY API CALL                              
<a id="__codelineno-214-17" name="__codelineno-214-17" href="#__codelineno-214-17"></a>                
<a id="__codelineno-214-18" name="__codelineno-214-18" href="#__codelineno-214-18"></a>     Operation: Book hotel via API                    
<a id="__codelineno-214-19" name="__codelineno-214-19" href="#__codelineno-214-19"></a>     Compensation: Cancel booking                     
<a id="__codelineno-214-20" name="__codelineno-214-20" href="#__codelineno-214-20"></a>      API might not support cancellation             
<a id="__codelineno-214-21" name="__codelineno-214-21" href="#__codelineno-214-21"></a>      Cancellation fee charged                       
<a id="__codelineno-214-22" name="__codelineno-214-22" href="#__codelineno-214-22"></a>      Not truly reversible                           
<a id="__codelineno-214-23" name="__codelineno-214-23" href="#__codelineno-214-23"></a>                
<a id="__codelineno-214-24" name="__codelineno-214-24" href="#__codelineno-214-24"></a>                                                         
<a id="__codelineno-214-25" name="__codelineno-214-25" href="#__codelineno-214-25"></a> 3.  PHYSICAL WORLD ACTIONS                            
<a id="__codelineno-214-26" name="__codelineno-214-26" href="#__codelineno-214-26"></a>                
<a id="__codelineno-214-27" name="__codelineno-214-27" href="#__codelineno-214-27"></a>     Operation: Print shipping label                  
<a id="__codelineno-214-28" name="__codelineno-214-28" href="#__codelineno-214-28"></a>     Operation: Dispatch drone delivery               
<a id="__codelineno-214-29" name="__codelineno-214-29" href="#__codelineno-214-29"></a>     Operation: Cut fabric to size                    
<a id="__codelineno-214-30" name="__codelineno-214-30" href="#__codelineno-214-30"></a>     Compensation: Impossible!                        
<a id="__codelineno-214-31" name="__codelineno-214-31" href="#__codelineno-214-31"></a>                
<a id="__codelineno-214-32" name="__codelineno-214-32" href="#__codelineno-214-32"></a>                                                         
<a id="__codelineno-214-33" name="__codelineno-214-33" href="#__codelineno-214-33"></a> 4.  IRREVERSIBLE STATE CHANGES                        
<a id="__codelineno-214-34" name="__codelineno-214-34" href="#__codelineno-214-34"></a>                
<a id="__codelineno-214-35" name="__codelineno-214-35" href="#__codelineno-214-35"></a>     Operation: Increment sequence number             
<a id="__codelineno-214-36" name="__codelineno-214-36" href="#__codelineno-214-36"></a>     Operation: Delete old data                       
<a id="__codelineno-214-37" name="__codelineno-214-37" href="#__codelineno-214-37"></a>     Compensation: Not meaningful                     
<a id="__codelineno-214-38" name="__codelineno-214-38" href="#__codelineno-214-38"></a>                
<a id="__codelineno-214-39" name="__codelineno-214-39" href="#__codelineno-214-39"></a>                                                         
<a id="__codelineno-214-40" name="__codelineno-214-40" href="#__codelineno-214-40"></a> Solution Patterns:                                      
<a id="__codelineno-214-41" name="__codelineno-214-41" href="#__codelineno-214-41"></a>  PIVOT TRANSACTION: Point of no return                 
<a id="__codelineno-214-42" name="__codelineno-214-42" href="#__codelineno-214-42"></a>   (Make non-compensatable ops last)                     
<a id="__codelineno-214-43" name="__codelineno-214-43" href="#__codelineno-214-43"></a>  SEMANTIC COMPENSATION: Apologize/explain              
<a id="__codelineno-214-44" name="__codelineno-214-44" href="#__codelineno-214-44"></a>   (Send &quot;sorry&quot; email)                                  
<a id="__codelineno-214-45" name="__codelineno-214-45" href="#__codelineno-214-45"></a>  RETRY UNTIL SUCCESS: Avoid compensation               
<a id="__codelineno-214-46" name="__codelineno-214-46" href="#__codelineno-214-46"></a>   (Retry forward transaction)                           
<a id="__codelineno-214-47" name="__codelineno-214-47" href="#__codelineno-214-47"></a>                                                         
<a id="__codelineno-214-48" name="__codelineno-214-48" href="#__codelineno-214-48"></a>
</code></pre></div>
<p><strong>Problem 4: Ordering and Idempotency Issues</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-215-1" name="__codelineno-215-1" href="#__codelineno-215-1"></a>
<a id="__codelineno-215-2" name="__codelineno-215-2" href="#__codelineno-215-2"></a>       PROBLEM 4: MESSAGE ORDERING &amp; IDEMPOTENCY         
<a id="__codelineno-215-3" name="__codelineno-215-3" href="#__codelineno-215-3"></a>
<a id="__codelineno-215-4" name="__codelineno-215-4" href="#__codelineno-215-4"></a>                                                         
<a id="__codelineno-215-5" name="__codelineno-215-5" href="#__codelineno-215-5"></a> Issue 1: OUT-OF-ORDER MESSAGE DELIVERY                  
<a id="__codelineno-215-6" name="__codelineno-215-6" href="#__codelineno-215-6"></a>             
<a id="__codelineno-215-7" name="__codelineno-215-7" href="#__codelineno-215-7"></a>                                                         
<a id="__codelineno-215-8" name="__codelineno-215-8" href="#__codelineno-215-8"></a> Sent Order:     [T1]  [T2]  [T3]                      
<a id="__codelineno-215-9" name="__codelineno-215-9" href="#__codelineno-215-9"></a> Received Order: [T1]  [T3]  [T2]                    
<a id="__codelineno-215-10" name="__codelineno-215-10" href="#__codelineno-215-10"></a>                                                         
<a id="__codelineno-215-11" name="__codelineno-215-11" href="#__codelineno-215-11"></a> Example:                                                
<a id="__codelineno-215-12" name="__codelineno-215-12" href="#__codelineno-215-12"></a>  T1: Create order                                      
<a id="__codelineno-215-13" name="__codelineno-215-13" href="#__codelineno-215-13"></a>  T2: Update address                                    
<a id="__codelineno-215-14" name="__codelineno-215-14" href="#__codelineno-215-14"></a>  T3: Confirm order                                     
<a id="__codelineno-215-15" name="__codelineno-215-15" href="#__codelineno-215-15"></a>                                                         
<a id="__codelineno-215-16" name="__codelineno-215-16" href="#__codelineno-215-16"></a> If T3 arrives before T2:                                
<a id="__codelineno-215-17" name="__codelineno-215-17" href="#__codelineno-215-17"></a>  Order confirmed with old address!                     
<a id="__codelineno-215-18" name="__codelineno-215-18" href="#__codelineno-215-18"></a>  Update arrives too late                               
<a id="__codelineno-215-19" name="__codelineno-215-19" href="#__codelineno-215-19"></a>                                                         
<a id="__codelineno-215-20" name="__codelineno-215-20" href="#__codelineno-215-20"></a>              
<a id="__codelineno-215-21" name="__codelineno-215-21" href="#__codelineno-215-21"></a>                                                         
<a id="__codelineno-215-22" name="__codelineno-215-22" href="#__codelineno-215-22"></a> Issue 2: DUPLICATE MESSAGE DELIVERY                     
<a id="__codelineno-215-23" name="__codelineno-215-23" href="#__codelineno-215-23"></a>             
<a id="__codelineno-215-24" name="__codelineno-215-24" href="#__codelineno-215-24"></a>                                                         
<a id="__codelineno-215-25" name="__codelineno-215-25" href="#__codelineno-215-25"></a> Network retry can cause duplicates:                     
<a id="__codelineno-215-26" name="__codelineno-215-26" href="#__codelineno-215-26"></a>                                                         
<a id="__codelineno-215-27" name="__codelineno-215-27" href="#__codelineno-215-27"></a> T1: Charge $100                                         
<a id="__codelineno-215-28" name="__codelineno-215-28" href="#__codelineno-215-28"></a> T1: Charge $100 (duplicate!)                            
<a id="__codelineno-215-29" name="__codelineno-215-29" href="#__codelineno-215-29"></a> Result: Charged $200 instead of $100                  
<a id="__codelineno-215-30" name="__codelineno-215-30" href="#__codelineno-215-30"></a>                                                         
<a id="__codelineno-215-31" name="__codelineno-215-31" href="#__codelineno-215-31"></a> Solution: IDEMPOTENCY                                   
<a id="__codelineno-215-32" name="__codelineno-215-32" href="#__codelineno-215-32"></a>            
<a id="__codelineno-215-33" name="__codelineno-215-33" href="#__codelineno-215-33"></a>  def charge_payment(request_id, amount):             
<a id="__codelineno-215-34" name="__codelineno-215-34" href="#__codelineno-215-34"></a>      if already_processed(request_id):               
<a id="__codelineno-215-35" name="__codelineno-215-35" href="#__codelineno-215-35"></a>          return cached_result                        
<a id="__codelineno-215-36" name="__codelineno-215-36" href="#__codelineno-215-36"></a>      result = do_charge(amount)                      
<a id="__codelineno-215-37" name="__codelineno-215-37" href="#__codelineno-215-37"></a>      cache_result(request_id, result)                
<a id="__codelineno-215-38" name="__codelineno-215-38" href="#__codelineno-215-38"></a>      return result                                   
<a id="__codelineno-215-39" name="__codelineno-215-39" href="#__codelineno-215-39"></a>            
<a id="__codelineno-215-40" name="__codelineno-215-40" href="#__codelineno-215-40"></a>                                                         
<a id="__codelineno-215-41" name="__codelineno-215-41" href="#__codelineno-215-41"></a> Idempotency Requirements:                               
<a id="__codelineno-215-42" name="__codelineno-215-42" href="#__codelineno-215-42"></a>  Unique request IDs (correlation IDs)                  
<a id="__codelineno-215-43" name="__codelineno-215-43" href="#__codelineno-215-43"></a>  Deduplication logic                                   
<a id="__codelineno-215-44" name="__codelineno-215-44" href="#__codelineno-215-44"></a>  Idempotent operations                                 
<a id="__codelineno-215-45" name="__codelineno-215-45" href="#__codelineno-215-45"></a>  Result caching                                        
<a id="__codelineno-215-46" name="__codelineno-215-46" href="#__codelineno-215-46"></a>                                                         
<a id="__codelineno-215-47" name="__codelineno-215-47" href="#__codelineno-215-47"></a>
</code></pre></div>
<p><strong>Problem 5: Complexity in Choreography</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-216-1" name="__codelineno-216-1" href="#__codelineno-216-1"></a>
<a id="__codelineno-216-2" name="__codelineno-216-2" href="#__codelineno-216-2"></a>       PROBLEM 5: CHOREOGRAPHY COMPLEXITY                
<a id="__codelineno-216-3" name="__codelineno-216-3" href="#__codelineno-216-3"></a>
<a id="__codelineno-216-4" name="__codelineno-216-4" href="#__codelineno-216-4"></a>                                                         
<a id="__codelineno-216-5" name="__codelineno-216-5" href="#__codelineno-216-5"></a> Issue: Emergent workflow from distributed events        
<a id="__codelineno-216-6" name="__codelineno-216-6" href="#__codelineno-216-6"></a>                                                         
<a id="__codelineno-216-7" name="__codelineno-216-7" href="#__codelineno-216-7"></a> Simple Flow (3 services):                               
<a id="__codelineno-216-8" name="__codelineno-216-8" href="#__codelineno-216-8"></a>            
<a id="__codelineno-216-9" name="__codelineno-216-9" href="#__codelineno-216-9"></a>  Order  Payment  Shipping                          
<a id="__codelineno-216-10" name="__codelineno-216-10" href="#__codelineno-216-10"></a>  (3 steps, easy to understand)                       
<a id="__codelineno-216-11" name="__codelineno-216-11" href="#__codelineno-216-11"></a>            
<a id="__codelineno-216-12" name="__codelineno-216-12" href="#__codelineno-216-12"></a>                                                         
<a id="__codelineno-216-13" name="__codelineno-216-13" href="#__codelineno-216-13"></a> Complex Flow (10 services):                             
<a id="__codelineno-216-14" name="__codelineno-216-14" href="#__codelineno-216-14"></a>            
<a id="__codelineno-216-15" name="__codelineno-216-15" href="#__codelineno-216-15"></a>       Order                                          
<a id="__codelineno-216-16" name="__codelineno-216-16" href="#__codelineno-216-16"></a>      /  |  \                                         
<a id="__codelineno-216-17" name="__codelineno-216-17" href="#__codelineno-216-17"></a>    Pay Inv. Fraud                                    
<a id="__codelineno-216-18" name="__codelineno-216-18" href="#__codelineno-216-18"></a>     |   |    |                                       
<a id="__codelineno-216-19" name="__codelineno-216-19" href="#__codelineno-216-19"></a>    Tax Ship Notify                                   
<a id="__codelineno-216-20" name="__codelineno-216-20" href="#__codelineno-216-20"></a>     \   |   /                                        
<a id="__codelineno-216-21" name="__codelineno-216-21" href="#__codelineno-216-21"></a>     Analytics                                        
<a id="__codelineno-216-22" name="__codelineno-216-22" href="#__codelineno-216-22"></a>        |                                             
<a id="__codelineno-216-23" name="__codelineno-216-23" href="#__codelineno-216-23"></a>     Billing                                          
<a id="__codelineno-216-24" name="__codelineno-216-24" href="#__codelineno-216-24"></a>                                                      
<a id="__codelineno-216-25" name="__codelineno-216-25" href="#__codelineno-216-25"></a>   10+ event types                                   
<a id="__codelineno-216-26" name="__codelineno-216-26" href="#__codelineno-216-26"></a>   Dozens of event handlers                          
<a id="__codelineno-216-27" name="__codelineno-216-27" href="#__codelineno-216-27"></a>   No single view of workflow                        
<a id="__codelineno-216-28" name="__codelineno-216-28" href="#__codelineno-216-28"></a>   Distributed state machine                         
<a id="__codelineno-216-29" name="__codelineno-216-29" href="#__codelineno-216-29"></a>            
<a id="__codelineno-216-30" name="__codelineno-216-30" href="#__codelineno-216-30"></a>                                                         
<a id="__codelineno-216-31" name="__codelineno-216-31" href="#__codelineno-216-31"></a> Problems:                                               
<a id="__codelineno-216-32" name="__codelineno-216-32" href="#__codelineno-216-32"></a>  No central place to see workflow                     
<a id="__codelineno-216-33" name="__codelineno-216-33" href="#__codelineno-216-33"></a>  Cyclic dependencies between services                 
<a id="__codelineno-216-34" name="__codelineno-216-34" href="#__codelineno-216-34"></a>  Difficult to change flow                             
<a id="__codelineno-216-35" name="__codelineno-216-35" href="#__codelineno-216-35"></a>  Hard to debug failures                               
<a id="__codelineno-216-36" name="__codelineno-216-36" href="#__codelineno-216-36"></a>  Testing requires all services                        
<a id="__codelineno-216-37" name="__codelineno-216-37" href="#__codelineno-216-37"></a>  Tight coupling via events                            
<a id="__codelineno-216-38" name="__codelineno-216-38" href="#__codelineno-216-38"></a>                                                         
<a id="__codelineno-216-39" name="__codelineno-216-39" href="#__codelineno-216-39"></a> When to use Orchestration instead:                      
<a id="__codelineno-216-40" name="__codelineno-216-40" href="#__codelineno-216-40"></a>  Complex business logic                                
<a id="__codelineno-216-41" name="__codelineno-216-41" href="#__codelineno-216-41"></a>  Many conditional branches                             
<a id="__codelineno-216-42" name="__codelineno-216-42" href="#__codelineno-216-42"></a>  Need clear workflow visibility                        
<a id="__codelineno-216-43" name="__codelineno-216-43" href="#__codelineno-216-43"></a>  Frequent changes to flow                              
<a id="__codelineno-216-44" name="__codelineno-216-44" href="#__codelineno-216-44"></a>                                                         
<a id="__codelineno-216-45" name="__codelineno-216-45" href="#__codelineno-216-45"></a>
</code></pre></div>
<p><strong>Summary: Saga Pattern Trade-offs</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-217-1" name="__codelineno-217-1" href="#__codelineno-217-1"></a>
<a id="__codelineno-217-2" name="__codelineno-217-2" href="#__codelineno-217-2"></a>         SAGA PATTERN: WHEN TO USE                       
<a id="__codelineno-217-3" name="__codelineno-217-3" href="#__codelineno-217-3"></a>
<a id="__codelineno-217-4" name="__codelineno-217-4" href="#__codelineno-217-4"></a>                                                         
<a id="__codelineno-217-5" name="__codelineno-217-5" href="#__codelineno-217-5"></a>  USE SAGA WHEN:                                       
<a id="__codelineno-217-6" name="__codelineno-217-6" href="#__codelineno-217-6"></a>            
<a id="__codelineno-217-7" name="__codelineno-217-7" href="#__codelineno-217-7"></a>   Building microservices                            
<a id="__codelineno-217-8" name="__codelineno-217-8" href="#__codelineno-217-8"></a>   Need high scalability                             
<a id="__codelineno-217-9" name="__codelineno-217-9" href="#__codelineno-217-9"></a>   Long-running processes                            
<a id="__codelineno-217-10" name="__codelineno-217-10" href="#__codelineno-217-10"></a>   Eventual consistency acceptable                   
<a id="__codelineno-217-11" name="__codelineno-217-11" href="#__codelineno-217-11"></a>   Services independently deployable                 
<a id="__codelineno-217-12" name="__codelineno-217-12" href="#__codelineno-217-12"></a>   Can write compensating transactions               
<a id="__codelineno-217-13" name="__codelineno-217-13" href="#__codelineno-217-13"></a>   Cloud-native architecture                         
<a id="__codelineno-217-14" name="__codelineno-217-14" href="#__codelineno-217-14"></a>            
<a id="__codelineno-217-15" name="__codelineno-217-15" href="#__codelineno-217-15"></a>                                                         
<a id="__codelineno-217-16" name="__codelineno-217-16" href="#__codelineno-217-16"></a>  DON&#39;T USE SAGA WHEN:                                 
<a id="__codelineno-217-17" name="__codelineno-217-17" href="#__codelineno-217-17"></a>            
<a id="__codelineno-217-18" name="__codelineno-217-18" href="#__codelineno-217-18"></a>   Need strong consistency (ACID)                    
<a id="__codelineno-217-19" name="__codelineno-217-19" href="#__codelineno-217-19"></a>   Isolation critical (finance)                      
<a id="__codelineno-217-20" name="__codelineno-217-20" href="#__codelineno-217-20"></a>   Operations not compensatable                      
<a id="__codelineno-217-21" name="__codelineno-217-21" href="#__codelineno-217-21"></a>   Simple monolith sufficient                        
<a id="__codelineno-217-22" name="__codelineno-217-22" href="#__codelineno-217-22"></a>   Low transaction volume                            
<a id="__codelineno-217-23" name="__codelineno-217-23" href="#__codelineno-217-23"></a>   Real-time consistency required                    
<a id="__codelineno-217-24" name="__codelineno-217-24" href="#__codelineno-217-24"></a>            
<a id="__codelineno-217-25" name="__codelineno-217-25" href="#__codelineno-217-25"></a>                                                         
<a id="__codelineno-217-26" name="__codelineno-217-26" href="#__codelineno-217-26"></a> Better Alternatives:                                    
<a id="__codelineno-217-27" name="__codelineno-217-27" href="#__codelineno-217-27"></a>  Monolith with ACID: Simple, proven                    
<a id="__codelineno-217-28" name="__codelineno-217-28" href="#__codelineno-217-28"></a>  2PC: When strong consistency needed                   
<a id="__codelineno-217-29" name="__codelineno-217-29" href="#__codelineno-217-29"></a>  Event Sourcing: Full audit trail                      
<a id="__codelineno-217-30" name="__codelineno-217-30" href="#__codelineno-217-30"></a>  CQRS: Read/write separation                           
<a id="__codelineno-217-31" name="__codelineno-217-31" href="#__codelineno-217-31"></a>                                                         
<a id="__codelineno-217-32" name="__codelineno-217-32" href="#__codelineno-217-32"></a>
</code></pre></div>
<hr />












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2025 <a href="https://github.com/abhishekghoshh"  target="_blank" rel="noopener">Abhishek Ghosh</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/abhishekghoshh" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/abhishek_ghoshh" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/abhishek-ghosh-220679132/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>